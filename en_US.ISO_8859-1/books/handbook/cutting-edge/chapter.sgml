<!--
     The FreeBSD Documentation Project

     $FreeBSD: doc/en_US.ISO_8859-1/books/handbook/cutting-edge/chapter.sgml,v 1.35 2000/01/26 03:09:16 jdp Exp $
-->

<chapter id="cutting-edge">
  <title>The Cutting Edge: FreeBSD-current and FreeBSD-stable</title>
  
  <para>FreeBSD is under constant development between releases.  For people
    who want to be on the cutting edge, there are several easy mechanisms for
    keeping your system in sync with the latest developments.  Be warned: the
    cutting edge is not for everyone! This chapter will help you decide if you
    want to track the development system, or stick with one of the released
    versions.</para>
  
  <sect1 id="current">
    <title>Staying Current with FreeBSD</title>
    
    <para><emphasis>Contributed by &a.jkh;.</emphasis></para>
    
    <sect2>
      <title>What is FreeBSD-current?</title>
      
      <para>FreeBSD-current is, quite literally, nothing more than a daily
	snapshot of the working sources for FreeBSD.  These include work in
	progress, experimental changes and transitional mechanisms that may or
	may not be present in the next official release of the software.
	While many of us compile almost daily from FreeBSD-current sources,
	there are periods of time when the sources are literally
	un-compilable.  These problems are generally resolved as expeditiously
	as possible, but whether or not FreeBSD-current sources bring disaster
	or greatly desired functionality can literally be a matter of which
	part of any given 24 hour period you grabbed them in!</para>
    </sect2>
    
    <sect2>
      <title>Who needs FreeBSD-current?</title>
      
      <para>FreeBSD-current is made generally available for 3 primary interest
	groups:</para>
	  
      <orderedlist>
	<listitem>
	  <para>Members of the FreeBSD group who are actively working on some
	    part of the source tree and for whom keeping &ldquo;current&rdquo;
	    is an absolute requirement.</para>
	</listitem>

	<listitem>
	  <para>Members of the FreeBSD group who are active testers, willing
	    to spend time working through problems in order to ensure that
	    FreeBSD-current remains as sane as possible. These are also people
	    who wish to make topical suggestions on changes and the general
	    direction of FreeBSD.</para>
	</listitem>

	<listitem>
	  <para>Peripheral members of the FreeBSD (or some other) group who
	    merely wish to keep an eye on things and use the current sources
	    for reference purposes (e.g. for <emphasis>reading</emphasis>, not
	    running).  These people also make the occasional comment or
	    contribute code.</para>
	</listitem>
      </orderedlist>
    </sect2>
    
    <sect2>
      <title>What is FreeBSD-current <emphasis>not</emphasis>?</title>
      
      <orderedlist>
	<listitem>
	  <para>A fast-track to getting pre-release bits because you heard
	    there is some cool new feature in there and you want to be the
	    first on your block to have it.</para>
	</listitem>

	<listitem>
	  <para>A quick way of getting bug fixes.</para>
	</listitem>

	<listitem>
	  <para>In any way &ldquo;officially supported&rdquo; by us.  We do
	    our best to help people genuinely in one of the 3
	    &ldquo;legitimate&rdquo; FreeBSD-current categories, but we simply
	    <emphasis>do not have the time</emphasis> to provide tech support
	    for it. This is not because we are mean and nasty people who do
	    not like helping people out (we would not even be doing FreeBSD if
	    we were), it is literally because we cannot answer 400 messages a
	    day <emphasis>and</emphasis> actually work on FreeBSD! I am sure
	    that, if given the choice between having us answer lots of
	    questions or continuing to improve FreeBSD, most of you would vote
	    for us improving it.</para>
	</listitem>
      </orderedlist>
    </sect2>
    
    <sect2>
      <title>Using FreeBSD-current</title>
      
      <orderedlist>
	<listitem>
	  <para>Join the &a.current; and the &a.cvsall; .  This is not just a
	    good idea, it is <emphasis>essential</emphasis>.  If you are not
	    on the <emphasis>FreeBSD-current</emphasis> mailing list, you will
	    not see the comments that people are making about the current
	    state of the system and thus will probably end up stumbling over a
	    lot of problems that others have already found and solved.  Even
	    more importantly, you will miss out on important bulletins which
	    may be critical to your system's continued health.</para>

	  <para>The &a.cvsall; mailing list will allow you to see the commit
	    log entry for each change as it is made along with any pertinent
	    information on possible side-effects.</para>

	  <para>To join these lists, send mail to
	      &a.majordomo; and specify:

	    <programlisting>
subscribe freebsd-current
subscribe cvs-all</programlisting>

	    in the body of your message.  Optionally, you can also say
	    <literal>help</literal> and Majordomo will send you full help on
	    how to subscribe and unsubscribe to the various other mailing
	    lists we support.</para>
	</listitem>

	<listitem>
	  <para>Grab the sources from <hostid
	      role="fqdn">ftp.FreeBSD.org</hostid>.  You can do this in three
	    ways:</para>
	  
	  <orderedlist>
	    <listitem>
	      <para>Use the <application><link
		    linkend="ctm">CTM</link></application> facility.  Unless
		you  have a good TCP/IP connection at a flat rate, this is
		the way to do it.</para>
	    </listitem>
	    
	    <listitem>
	      <para>Use the <link linkend="cvsup">cvsup</link> program with
		<ulink
		  url="ftp://ftp.FreeBSD.org/pub/FreeBSD/FreeBSD-current/src/share/examples/cvsup/standard-supfile">this
		  supfile</ulink>.  This is the second most recommended
		method, since it allows  you to grab the entire collection
		once and then only what has changed from then on.  Many people
		run cvsup from cron and keep their sources up-to-date
		automatically.  For a fairly easy interface to this, simply
		type:</para>
    
	      <blockquote><screen>&prompt.root; <userinput>pkg_add -f \
ftp://ftp.FreeBSD.org/pub/FreeBSD/development/CVSup/cvsupit.tgz</userinput></screen></blockquote>
	    </listitem>
	    
	    <listitem>
	      <para>Use <command>ftp</command>.  The source tree for
		FreeBSD-current is always &ldquo;exported&rdquo; on: <ulink
		  url="ftp://ftp.FreeBSD.org/pub/FreeBSD/FreeBSD-current/">ftp://ftp.FreeBSD.org/pub/FreeBSD/FreeBSD-current/</ulink>.
		We also use <command>wu-ftpd</command> which allows
		compressed/tar'd grabbing of whole trees.  e.g. you
		see:</para>
	      
	      <screen>usr.bin/lex</screen>
	      
	      <para>You can do:
					
		<screen><prompt>ftp&gt;</prompt> <userinput>cd usr.bin</userinput>
<prompt>ftp&gt;</prompt> <userinput>get lex.tar</userinput></screen>
		
		and it will get the whole directory for you as a
		tar file.</para>
	    </listitem>
	  </orderedlist>
	</listitem>

	<listitem>
	  <para>Essentially, if you need rapid on-demand access to the source
	    and communications bandwidth is not a consideration, use
	    <command>cvsup</command> or <command>ftp</command>.  Otherwise,
	    use <application>CTM</application>.</para>

	  <para>If you are grabbing the sources to run, and not just look at,
	    then grab <emphasis>all</emphasis> of current, not just selected
	    portions.  The reason for this is that various parts of the source
	    depend on updates elsewhere, and trying to compile just a subset
	    is almost guaranteed to get you into trouble.</para>

	  <para>Before compiling current, read the Makefile in
	    <filename>/usr/src</filename> carefully.  You should at least run
	    a <link linkend="makeworld">make world</link> the first time
	    through as part of the upgrading process.  Reading the &a.current;
	    will keep you up-to-date on other bootstrapping procedures that
	    sometimes become necessary as we move towards the next
	    release.</para>
	</listitem>
	      
	<listitem>
	  <para>Be active! If you are running FreeBSD-current, we want to
	    know what you have to say about it, especially if you have
	    suggestions for enhancements or bug fixes. Suggestions with
	    accompanying code are received most enthusiastically!</para>
	</listitem>
      </orderedlist>
    </sect2>
  </sect1>
  
  <sect1 id="stable">
    <title>Staying Stable with FreeBSD</title>
    
    <para><emphasis>Contributed by &a.jkh;.</emphasis></para>
    
    <sect2>
      <title>What is FreeBSD-stable?</title>
      
      <para>FreeBSD-stable is our development branch for a more low-key and
	conservative set of changes intended for our next mainstream release.
	Changes of an experimental or untested nature do not go into this
	branch (see <link linkend="current">FreeBSD-current</link>).</para>
    </sect2>
    
    <sect2>
      <title>Who needs FreeBSD-stable?</title>
      
      <para>If you are a commercial user or someone who puts maximum stability
	of their FreeBSD system before all other concerns, you should consider
	tracking <emphasis>stable</emphasis>.  This is especially true if you
	have installed the most recent release (<ulink
	  url="ftp://ftp.FreeBSD.org/pub/FreeBSD/&rel.current;-RELEASE/">&rel.current;-RELEASE</ulink>
	at the time of this writing) since the <emphasis>stable</emphasis>
	branch is effectively a bug-fix stream relative to the previous
	release.</para>
      
      <warning>
	<para>The <emphasis>stable</emphasis> tree endeavors, above all, to be
	  fully compilable and stable at all times, but we do occasionally
	  make mistakes (these are still active sources with
	  quickly-transmitted updates, after all).  We also do our best to
	  thoroughly test fixes in <emphasis>current</emphasis> before
	  bringing them into <emphasis>stable</emphasis>, but sometimes our
	  tests fail to catch every case.  If something breaks for you in
	  <emphasis>stable</emphasis>, please let us know
	  <emphasis>immediately!</emphasis> (see next section).</para>
      </warning>
    </sect2>
    
    <sect2>
      <title>Using FreeBSD-stable</title>
      
      <orderedlist>

	<listitem>
	  <para>Join the &a.stable;.  This will keep you informed of
	    build-dependencies that may appear in <emphasis>stable</emphasis>
	    or any other issues requiring special attention.  Developers will
	    also make announcements in this mailing list when they are
	    contemplating some controversial fix or update, giving the users a
	    chance to respond if they have any issues to raise concerning the
	    proposed change.</para>
	  
	  <para>The &a.cvsall; mailing list will allow you to see the commit
	    log entry for each change as it is made along with any pertinent
	    information on possible side-effects.</para>

	  <para>To join these lists, send mail to &a.majordomo; and specify:

	    <programlisting>
subscribe freebsd-stable
subscribe cvs-all</programlisting>

	    in the body of your message.  Optionally, you can also say
	    <literal>help</literal> and Majordomo will send you full help on
	    how to subscribe and unsubscribe to the various other mailing
	    lists we support.</para>
	</listitem>

	<listitem>
	  <para>If you are installing a new system and want it to be as stable
	    as possible, you can simply grab the latest dated branch snapshot
	    from <ulink
	      url="ftp://releng3.FreeBSD.org/pub/FreeBSD/">ftp://releng3.FreeBSD.org/pub/FreeBSD/</ulink>
	    and install it like any other release.</para>

	  <para>If you are already running a previous release of FreeBSD and wish
	    to upgrade via sources then you can easily do so from <hostid
	      role="fqdn">ftp.FreeBSD.org</hostid>.  This can be done in one
	    of three ways:</para>
		  
	  <orderedlist>
	    <listitem>
	      <para>Use the <application><link
		    linkend="ctm">CTM</link></application> facility.  Unless
		you have a good TCP/IP connection at a flat rate, this is
		the way to do it.</para>
	    </listitem>
	    
	    <listitem>
	      <para>Use the <link linkend="cvsup">cvsup</link> program with
		<ulink
		  url="ftp://ftp.FreeBSD.org/pub/FreeBSD/FreeBSD-current/src/share/examples/cvsup/stable-supfile">this
		  supfile</ulink>.  This is the second most recommended
		method, since it allows  you to grab the entire collection
		once and then only what has changed from then on.  Many people
		run cvsup from cron to keep their sources up-to-date
		automatically.  For a fairly easy interface to this, simply
		type;</para>
	      
	      <blockquote><screen>&prompt.root; <userinput>pkg_add -f \
ftp://ftp.FreeBSD.org/pub/FreeBSD/development/CVSup/cvsupit.tgz</userinput></screen></blockquote>
	    </listitem>
		    
	    <listitem>
	      <para>Use <command>ftp</command>.  The source tree for
		FreeBSD-stable is always &ldquo;exported&rdquo; on: <ulink
		  url="ftp://ftp.FreeBSD.org/pub/FreeBSD/FreeBSD-stable/">ftp://ftp.FreeBSD.org/pub/FreeBSD/FreeBSD-stable/</ulink></para>
		      
	      <para>We also use <command>wu-ftpd</command> which allows
		compressed/tar'd grabbing of whole trees.  e.g. you
		see:</para>

	      <screen>usr.bin/lex</screen>
	      
	      <para>You can do:
		
		<screen><prompt>ftp&gt;</prompt> <userinput>cd usr.bin</userinput>
<prompt>ftp&gt;</prompt> <userinput>get lex.tar</userinput></screen>
			
		and it will get the whole directory for you as a
		tar file.</para>
	    </listitem>
	  </orderedlist>
	</listitem>

	<listitem>
	  <para>Essentially, if you need rapid on-demand access to the source
	    and communications bandwidth is not a consideration, use
	    <command>cvsup</command> or <command>ftp</command>.  Otherwise,
	    use <application>CTM</application>.</para>
	</listitem>

	<listitem>
	  <para>Before compiling stable, read the Makefile in
	    <filename>/usr/src</filename> carefully.  You should at least run
	    a <link linkend="makeworld">make world</link> the first time
	    through as part of the upgrading process.  Reading the &a.stable;
	    will keep you up-to-date on other bootstrapping procedures that
	    sometimes become necessary as we move towards the next
	    release.</para>
	</listitem>
      </orderedlist>
    </sect2>
  </sect1>
  
  <sect1 id="synching">
    <title>Synchronizing Source Trees over the Internet</title>
    
    <para><emphasis>Contributed by &a.jkh;.</emphasis></para>

    <para>There are various ways of using an Internet (or email) connection to
      stay up-to-date with any given area of the FreeBSD project sources, or
      all areas, depending on what interests you.  The primary services we
      offer are <link linkend="anoncvs">Anonymous CVS</link>, <link
	linkend="cvsup">CVSup</link>, and <link
	linkend="ctm">CTM</link>.</para>

    <para><application>Anonymous CVS</application> and
      <application>CVSup</application> use the <emphasis>pull</emphasis> model
      of updating sources.  In the case of <application>CVSup</application>
      the user (or a cron script) invokes the <command>cvsup</command>
      program, and it interacts with a <command>cvsupd</command> server
      somewhere to bring your files up to date.  The updates you receive are
      up-to-the-minute and you get them when, and only when, you want them.
      You can easily restrict your updates to the specific files or
      directories that are of interest to you.  Updates are generated on the
      fly by the server, according to what you have and what you want to have.
      <application>Anonymous CVS</application> is quite a bit more simplistic
      than CVSup in that it's just an extension to
      <application>CVS</application> which allows it to pull changes directly
      from a remote CVS repository.  <application>CVSup</application> can do
      this far more efficiently, but <application>Anonymous CVS</application>
      is easier to use.</para>

    <para><application>CTM</application>, on the other hand, does not
      interactively compare the sources you have with those on the master
      archive or otherwise pull them across..  Instead, a script which
      identifies changes in files since its previous run is executed several
      times a day on the master CTM machine, any detected changes being
      compressed, stamped with a sequence-number and encoded for transmission
      over email (in printable ASCII only).  Once received, these &ldquo;CTM
      deltas&rdquo; can then be handed to the &man.ctm.rmail.1; utility which
      will automatically decode,
      verify and apply the changes to the user's copy of the sources.  This
      process is far more efficient than <application>CVSup</application>, and
      places less strain on our server resources since it is a
      <emphasis>push</emphasis> rather than a <emphasis>pull</emphasis>
      model.</para>

    <para>There are other trade-offs, of course.  If you inadvertently wipe
      out portions of your archive, <application>CVSup</application> will
      detect and rebuild the damaged portions for you.
      <application>CTM</application> won't do this, and if you wipe some
      portion of your source tree out (and don't have it backed up) then you
      will have to start from scratch (from the most recent CVS &ldquo;base
      delta&rdquo;) and rebuild it all with CTM or, with anoncvs, simply
      delete the bad bits and resync.</para>

    <para>For more information on <application>Anonymous CVS</application>,
      <application>CTM</application>, and <application>CVSup</application>,
      please see one of the following sections:</para>

    <sect2 id="anoncvs">
      <title>Anonymous CVS</title>
      
      <para><emphasis>Contributed by &a.jkh;</emphasis></para>
      
      <sect3>
	<title><anchor id="anoncvs-intro">Introduction</title>

	<para>Anonymous CVS (or, as it is otherwise known,
	  <emphasis>anoncvs</emphasis>) is a feature provided by the CVS
	  utilities bundled with FreeBSD for synchronizing with a remote CVS
	  repository.  Among other things, it allows users of FreeBSD to
	  perform, with no special privileges, read-only CVS operations
	  against one of the FreeBSD project's official anoncvs servers.  To
	  use it, one simply sets the <envar>CVSROOT</envar> environment
	  variable to point at the appropriate anoncvs server,
	  provides the well-known password <quote>anoncvs</quote>
	  with the <command>cvs login</command> command, and then uses
	  the &man.cvs.1; command to access it like any local
	  repository.</para>

	<para>While it can also be said that the <link
	    linkend="cvsup">CVSup</link> and <emphasis>anoncvs</emphasis>
	  services both perform essentially the same function, there are
	  various trade-offs which can influence the user's choice of
	  synchronization methods.  In a nutshell,
	  <application>CVSup</application> is much more efficient in its usage
	  of network resources and is by far the most technically
	  sophisticated of the two, but at a price.  To use
	  <application>CVSup</application>, a special client must first be
	  installed and configured before any bits can be grabbed, and then
	  only in the fairly large chunks which
	  <application>CVSup</application> calls
	  <emphasis>collections</emphasis>.</para>

	<para><application>Anoncvs</application>, by contrast, can be used to
	  examine anything from an individual file to a specific program (like
	  <command>ls</command> or <command>grep</command>) by referencing the
	  CVS module name.  Of course, <application>anoncvs</application> is
	  also only good for read-only operations on the CVS repository, so if
	  it's your intention to support local development in one repository
	  shared with the FreeBSD project bits then
	  <application>CVSup</application> is really your only option.</para>
      </sect3>
      
      <sect3>
	<title><anchor id="anoncvs-usage">Using Anonymous CVS</title>

	<para>Configuring &man.cvs.1; to use an Anonymous CVS repository is a
	  simple matter of setting the <envar>CVSROOT</envar> environment
	  variable to point to one of the FreeBSD project's
	  <emphasis>anoncvs</emphasis> servers.  At the time of this writing,
	  the following servers are available:</para>

	<itemizedlist>
	  <listitem>
	    <para><emphasis>USA</emphasis>:
	      :pserver:anoncvs@anoncvs.freebsd.org:/home/ncvs
	      (Use <command>cvs login</command> and enter the password
	      <quote>anoncvs</quote> when prompted.)</para>
	  </listitem>
	</itemizedlist>

	<para>Since CVS allows one to &ldquo;check out&rdquo; virtually any
	  version of the FreeBSD sources that ever existed (or, in some cases,
	  will exist <!-- smiley -->:), you need to be familiar with the
	  revision (<option>-r</option>) flag to &man.cvs.1; and what some of
	  the permissible values for it in the FreeBSD Project repository
	  are.</para>

	<para>There are two kinds of tags, revision tags and branch tags.  A
	  revision tag refers to a specific revision.  Its meaning stays the
	  same from day to day.  A branch tag, on the other hand, refers to
	  the latest revision on a given line of development, at any given
	  time.  Because a branch tag does not refer to a specific revision,
	  it may mean something different tomorrow than it means today.</para>

	<para>Here are the branch tags that users might be interested
	  in:</para>

	<variablelist>
	  <varlistentry>
	    <term>HEAD</term>
	    
	    <listitem>
	      <para>Symbolic name for the main line, or FreeBSD-current. Also
		the default when no revision is specified.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term>RELENG_3</term>
	    
	    <listitem>
	      <para>The line of development for FreeBSD-3.x, also known as
		FreeBSD-stable.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term>RELENG_2_2</term>
	    
	    <listitem>
	      <para>The line of development for FreeBSD-2.2.x, also known as
		2.2-stable.  This branch is mostly obsolete. Not valid for
	 	the ports collection.</para>
	    </listitem>
	  </varlistentry>
	</variablelist>

	<para>Here are the revision tags that users might be interested
	  in:</para>

	<variablelist>
	  <varlistentry>
	    <term>RELENG_3_4_0_RELEASE</term>

	    <listitem>
	      <para>FreeBSD-3.4.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>RELENG_3_3_0_RELEASE</term>

	    <listitem>
	      <para>FreeBSD-3.3.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>

            <term>RELENG_3_2_0_RELEASE</term>
                  
            <listitem>
              <para>FreeBSD-3.2.  Not valid for the ports collection.</para>
            </listitem>
          </varlistentry>
        
          <varlistentry>

	    <term>RELENG_3_1_0_RELEASE</term>
	    
	    <listitem>
	      <para>FreeBSD-3.1.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>RELENG_3_0_0_RELEASE</term>
	    
	    <listitem>
	      <para>FreeBSD-3.0.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>RELENG_2_2_8_RELEASE</term>
	    
	    <listitem>
	      <para>FreeBSD-2.2.8.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>RELENG_2_2_7_RELEASE</term>
	    
	    <listitem>
	      <para>FreeBSD-2.2.7.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>RELENG_2_2_6_RELEASE</term>
	    
	    <listitem>
	      <para>FreeBSD-2.2.6.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term>RELENG_2_2_5_RELEASE</term>
	    
	    <listitem>
	      <para>FreeBSD-2.2.5.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term>RELENG_2_2_2_RELEASE</term>
	    
	    <listitem>
	      <para>FreeBSD-2.2.2.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term>RELENG_2_2_1_RELEASE</term>
	    
	    <listitem>
	      <para>FreeBSD-2.2.1.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term>RELENG_2_2_0_RELEASE</term>
	    
	    <listitem>
	      <para>FreeBSD-2.2.0.  Not valid for the ports collection.</para>
	    </listitem>
	  </varlistentry>
	</variablelist>

	<para>When you specify a branch tag, you normally receive the latest
	  versions of the files on that line of development.  If you wish to
	  receive some past version, you can do so by specifying a date with
	  the <option>-D date</option> flag.  See the &man.cvs.1; man page
	  for more details.</para>
      </sect3>
      
      <sect3>
	<title>Examples</title>

	<para>While it really is recommended that you read the manual page for
	    &man.cvs.1; thoroughly before doing anything, here are some
	  quick examples which essentially show how to use Anonymous
	  CVS:</para>

	<example>
	  <title>Checking out something from -current (&man.ls.1;) and
	    deleting it again:</title>

	  <screen>
&prompt.user; <userinput>setenv CVSROOT :pserver:anoncvs@anoncvs.freebsd.org:/home/ncvs</userinput>
&prompt.user; <userinput>cvs login</userinput>
<emphasis>At the prompt, enter the password</emphasis> <quote>anoncvs</quote>.
&prompt.user; <userinput>cvs co ls</userinput>
&prompt.user; <userinput>cvs release -d ls</userinput>
&prompt.user; <userinput>cvs logout</userinput>
	  </screen>
	</example>

	<example>
	  <title>Checking out the version of ls(1) in the 2.2-stable
	    branch:</title>
	    
	  <screen>
&prompt.user; <userinput>setenv CVSROOT :pserver:anoncvs@anoncvs.freebsd.org:/home/ncvs</userinput>
&prompt.user; <userinput>cvs login</userinput>
<emphasis>At the prompt, enter the password</emphasis> <quote>anoncvs</quote>.
&prompt.user; <userinput>cvs co -rRELENG_2_2 ls</userinput>
&prompt.user; <userinput>cvs release -d ls</userinput>
&prompt.user; <userinput>cvs logout</userinput>
	  </screen>
	</example>

	<example>
	  <title>Creating a list of changes (as unidiffs) to &man.ls.1;</title>

	  <screen>
&prompt.user; <userinput>setenv CVSROOT :pserver:anoncvs@anoncvs.freebsd.org:/home/ncvs</userinput>
&prompt.user; <userinput>cvs login</userinput>
<emphasis>At the prompt, enter the password</emphasis> <quote>anoncvs</quote>.
&prompt.user; <userinput>cvs rdiff -u -rRELENG_2_2_2_RELEASE -rRELENG_2_2_6_RELEASE ls</userinput>
&prompt.user; <userinput>cvs logout</userinput>
	  </screen>
	</example>

	<example>
	  <title>Finding out what other module names can be used:</title>
	  
	  <screen>
&prompt.user; <userinput>setenv CVSROOT :pserver:anoncvs@anoncvs.freebsd.org:/home/ncvs</userinput>
&prompt.user; <userinput>cvs login</userinput>
<emphasis>At the prompt, enter the password</emphasis> <quote>anoncvs</quote>.
&prompt.user; <userinput>cvs co modules</userinput>
&prompt.user; <userinput>more modules/modules</userinput>
&prompt.user; <userinput>cvs release -d modules</userinput>
&prompt.user; <userinput>cvs logout</userinput>
	  </screen>
	</example>
      </sect3>
      
      <sect3>
	<title>Other Resources</title>

	<para>The following additional resources may be helpful in learning
	  CVS:</para>

	<itemizedlist>
	  <listitem>
	    <para><ulink
		url="http://www.csc.calpoly.edu/~dbutler/tutorials/winter96/cvs/">CVS Tutorial</ulink> from Cal Poly.</para>
	  </listitem>
	  
	  <listitem>
	    <para><ulink url="http://www.cyclic.com/">Cyclic Software</ulink>,
	      commercial maintainers of CVS.</para>
	  </listitem>
	  
	  <listitem>
	    <para><ulink
		url="http://www.FreeBSD.org/cgi/cvsweb.cgi">CVSWeb</ulink> is
	      the FreeBSD Project web interface for CVS.</para>
	  </listitem>
	</itemizedlist>
      </sect3>
    </sect2>
    
    <sect2 id="ctm">
      <title><application>CTM</application></title>
      
      <para><emphasis>Contributed by &a.phk;.  Updated
	  19-October-1997.</emphasis></para>
      
      <para><application>CTM</application> is a method for keeping a remote
	directory tree in sync with a central one.  It has been developed for
	usage with FreeBSD's source trees, though other people may find it
	useful for other purposes as time goes by.  Little, if any,
	documentation currently exists at this time on the process of creating
	deltas, so talk to &a.phk; for more information should you wish to use
	<application>CTM</application> for other things.</para>
	  
      <sect3>
	<title>Why should I use <application>CTM</application>?</title>

	<para><application>CTM</application> will give you a local copy of the
	  FreeBSD source trees.  There are a number of &ldquo;flavors&rdquo;
	  of the tree available.  Whether you wish to track the entire cvs
	  tree or just one of the branches, <application>CTM</application> can
	  provide you the information.  If you are an active developer on
	  FreeBSD, but have lousy or non-existent TCP/IP connectivity, or
	  simply wish to have the changes automatically sent to you,
	  <application>CTM</application> was made for you.  You will need to
	  obtain up to three deltas per day for the most  active branches.
	  However, you should consider having them sent by automatic email.
	  The sizes of the updates are always kept as small as possible.  This
	  is typically less than 5K, with an occasional (one in ten) being
	  10-50K and every now and then a biggie of 100K+ or more coming
	  around.</para>
	    
	<para>You will also need to make yourself aware of the various caveats
	  related to working directly from the development sources rather than
	  a pre-packaged release.  This is particularly true if you choose the
	  &ldquo;current&rdquo; sources.  It is recommended that you read
	  <link linkend="current">Staying current with FreeBSD</link>.</para>
      </sect3>
      
      <sect3>
	<title>What do I need to use <application>CTM</application>?</title>

	<para>You will need two things: The <application>CTM</application>
	  program and the initial deltas to feed it (to get up to
	  &ldquo;current&rdquo; levels).</para>
	    
	<para>The <application>CTM</application> program has been part of
	  FreeBSD ever since version 2.0 was released, and lives in
	  <filename>/usr/src/usr.sbin/CTM</filename> if you have a copy of the
	  source online.</para>
	    
	<para>If you are running a pre-2.0 version of FreeBSD, you can fetch
	  the current <application>CTM</application> sources directly
	  from:</para>
	    
	<para><ulink
	    url="ftp://ftp.FreeBSD.org/pub/FreeBSD/FreeBSD-current/src/usr.sbin/ctm/">ftp://ftp.FreeBSD.org/pub/FreeBSD/FreeBSD-current/src/usr.sbin/ctm/</ulink></para>
	    
	<para>The &ldquo;deltas&rdquo; you feed <application>CTM</application>
	  can be had two ways, FTP or e-mail.  If you have general FTP access
	  to the Internet then the following FTP sites support access to
	  <application>CTM</application>:</para>
	    
	<para><ulink
	    url="ftp://ftp.FreeBSD.org/pub/FreeBSD/CTM/">ftp://ftp.FreeBSD.org/pub/FreeBSD/CTM/</ulink></para>
	    
	<para>or see section <link linkend="mirrors-ctm">mirrors</link>.</para>

	<para>FTP the relevant directory and fetch the
	  <filename>README</filename> file, starting from there.</para>
	    
	<para>If you may wish to get your deltas via email:</para>
	    
	<para>Send email to &a.majordomo; to subscribe to one of the
	  <application>CTM</application> distribution lists.
	  &ldquo;ctm-cvs-cur&rdquo; supports the entire cvs tree.
	  &ldquo;ctm-src-cur&rdquo; supports the head of the development
	  branch.  &ldquo;ctm-src-2_2&rdquo; supports the 2.2 release branch,
	  etc.  (If you do not know how to subscribe yourself using majordomo,
	  send a message first containing the word <literal>help</literal>
	  &mdash; it will send you back usage instructions.)</para>
	    
	<para>When you begin receiving your <application>CTM</application>
	  updates in the mail, you may use the <command>ctm_rmail</command>
	  program to unpack and apply them.  You can actually use the
	  <command>ctm_rmail</command> program directly from a entry in
	  <filename>/etc/aliases</filename> if you want to have the process
	  run in a fully automated fashion.  Check the
	  <command>ctm_rmail</command> man page for more details.</para>

	<note>
	  <para>No matter what method you use to get the
	    <application>CTM</application> deltas, you should subscribe to the
	    <email>ctm-announce@FreeBSD.org</email> mailing list.  In the
	    future, this will be the only place where announcements concerning
	    the operations of the <application>CTM</application> system will
	    be posted.  Send an email to &a.majordomo; with a single line of
	    <literal>subscribe ctm-announce</literal> to get added to the
	    list.</para>
	</note>
      </sect3>
      
      <sect3>
	<title>Starting off with <application>CTM</application> for the first
	  time</title>
	    
	<para>Before you can start using <application>CTM</application>
	  deltas, you will need to get to a starting point for the deltas
	  produced subsequently to it.</para>
	    
	<para>First you should determine what you already have.  Everyone can
	  start from an &ldquo;empty&rdquo; directory.  You must use an
	  initial &ldquo;Empty&rdquo delta to start off your
	  <application>CTM</application> supported tree.  At some point it is
	  intended that one of these &ldquo;started&rdquo; deltas be
	  distributed on the CD for your convenience.  This does not currently
	  happen however.</para>

	<para>However, since the trees are many tens of megabytes, you should
	  prefer to start from something already at hand.  If you have a
	  RELEASE CD, you can copy or extract an initial source from it.  This
	  will save a significant transfer of data.</para>
	    
	<para>You can recognize these &ldquo;starter&rdquo; deltas by the
	  <literal>X</literal> appended to the number
	  (<filename>src-cur.3210XEmpty.gz</filename> for instance).  The
	  designation following the <filename>X</filename> corresponds to the
	  origin of your initial &ldquo;seed&rdquo;.
	  <filename>Empty</filename> is an empty directory.  As a rule a base
	  transition from <filename>Empty</filename> is produced every 100
	  deltas.  By the way, they are large! 25 to 30 Megabytes of
	  <command>gzip</command>'ed data is common for the
	  <filename>XEmpty</filename> deltas.</para>
	    
	<para>Once you've picked a base delta to start from, you will also
	  need all deltas with higher numbers following it.</para>
      </sect3>
      
      <sect3>
	<title>Using <application>CTM</application> in your daily life</title>

	<para>To apply the deltas, simply say:</para>

	<screen>&prompt.root; <userinput>cd /where/ever/you/want/the/stuff</userinput>
&prompt.root; <userinput>ctm -v -v /where/you/store/your/deltas/src-xxx.*</userinput></screen>
	      
	<para><application>CTM</application> understands deltas which have
	  been put through <command>gzip</command>, so you do not need to
	  gunzip them first, this saves disk space.</para>
	    
	<para>Unless it feels very secure about the entire process,
	  <application>CTM</application> will not touch your tree.  To verify
	  a delta you can also use the <option>-c</option> flag and
	  <application>CTM</application> will not actually touch your tree; it
	  will merely verify the integrity of the delta and see if it would
	  apply cleanly to your current tree.</para>
	    
	<para>There are other options to <application>CTM</application> as
	  well, see the manual pages or look in the sources for more
	  information.</para>
	    
	<para>I would also be very happy if somebody could help with the
	  &ldquo;user interface&rdquo; portions, as I have realized that I
	  cannot make up my mind on what options should do what, how and
	  when...</para>
	    
	<para>That's really all there is to it.  Every time you get a new
	  delta, just run it through <application>CTM</application> to keep
	  your sources up to date.</para>
	    
	<para>Do not remove the deltas if they are hard to download again. You
	  just might want to keep them around in case something bad happens.
	  Even if you only have floppy disks, consider using
	  <command>fdwrite</command> to make a copy.</para>
      </sect3>
      
      <sect3>
	<title>Keeping your local changes</title>

	<para>As a developer one would like to experiment with and change
	  files in the source tree.  <application>CTM</application> supports
	  local modifications in a limited way: before checking for the
	  presence of a file <filename>foo</filename>, it first looks for
	  <filename>foo.ctm</filename>.  If this file exists, CTM will operate
	  on it instead of <filename>foo</filename>.</para>
	    
	<para>This behaviour gives us a simple way to maintain local changes:
	  simply copy the files you plan to modify to the corresponding file
	  names with a <filename>.ctm</filename> suffix.  Then you can freely
	  hack  the code, while CTM keeps the <filename>.ctm</filename> file
	  up-to-date.</para>
      </sect3>
      
      <sect3>
	<title>Other interesting <application>CTM</application> options</title>

	<sect4>
	  <title>Finding out exactly what would be touched by an
	    update</title>
	      
	  <para>You can determine the list of changes that
	    <application>CTM</application> will make on your source repository
	    using the <option>-l</option> option to
	    <application>CTM</application>.</para>
	      
	  <para>This is useful if you would like to keep logs of the changes,
	    pre- or post- process the modified files in any manner, or just
	    are feeling a tad paranoid <!-- smiley -->:-).</para>
	</sect4>

	<sect4>
	  <title>Making backups before updating</title>
	  
	  <para>Sometimes you may want to backup all the files that would be
	    changed by a <application>CTM</application> update.</para>
	      
	  <para>Specifying the <option>-B backup-file</option> option causes
	    <application>CTM</application> to backup all files that would be
	    touched by a given <application>CTM</application> delta to
	    <filename>backup-file</filename>.</para>
	</sect4>

	<sect4>
	  <title>Restricting the files touched by an update</title>
	  
	  <para>Sometimes you would be interested in restricting the scope of
	    a given <application>CTM</application> update, or may be
	    interested in extracting just a few files from a sequence of
	    deltas.</para>
	      
	  <para>You can control the list of files that
	    <application>CTM</application> would operate on by specifying
	    filtering regular expressions using the <option>-e</option> and
	    <option>-x</option> options.</para>
	      
	  <para>For example, to extract an up-to-date copy of
	    <filename>lib/libc/Makefile</filename> from your collection of
	    saved CTM deltas, run the commands:</para>
		
	  <screen>&prompt.root; <userinput>cd /where/ever/you/want/to/extract/it/</userinput>
&prompt.root; <userinput>ctm -e '^lib/libc/Makefile' ~ctm/src-xxx.*</userinput></screen>
		
	  <para>For every file specified in a <application>CTM</application>
	    delta, the <option>-e</option> and <option>-x</option> options are
	    applied in the order given on the command line.  The file is
	    processed by <application>CTM</application> only if it is marked
	    as eligible after all the <option>-e</option> and
	    <option>-x</option> options are applied to it.</para>
	</sect4>
      </sect3>
      
      <sect3>
	<title>Future plans for <application>CTM</application></title>

	<para>Tons of them:</para>

	<itemizedlist>
	  <listitem>
	    <para>Use some kind of authentication into the CTM system, so as
	      to allow detection of spoofed CTM updates.</para>
	  </listitem>
	  
	  <listitem>
	    <para>Clean up the options to <application>CTM</application>, they
	      became confusing and counter intuitive.</para>
	  </listitem>
	</itemizedlist>

	<para>The bad news is that I am very busy, so any help in doing this
	  will be most welcome.  And do not forget to tell me what you want
	  also...</para>
      </sect3>
      
      <sect3>
	<title>Miscellaneous stuff</title>

	<para>All the &ldquo;DES infected&rdquo; (e.g. export controlled)
	  source is not included.  You will get the
	  &ldquo;international&rdquo; version only. If sufficient interest
	  appears, we will set up a <literal>sec-cur</literal> sequence too.
	  There is a sequence of deltas for the <literal>ports</literal>
	  collection too, but interest has not been all that high yet. Tell me
	  if you want an email list for that too and we will consider setting
	  it up.</para>
      </sect3>
      
      <sect3>
	<title>Thanks!</title>

	<variablelist>
	  <varlistentry>
	    <term>&a.bde;</term>

	    <listitem>
	      <para>for his pointed pen and invaluable comments.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term>&a.sos;</term>
	    
	    <listitem>
	      <para>for patience.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term>Stephen McKay</term>
	    
	    <listitem>
	      <para>wrote <command>ctm_[rs]mail</command>, much
		appreciated.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term>&a.jkh;</term>
	    
	    <listitem>
	      <para>for being so stubborn that I had to make it better.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term>All the users</term>
	    
	    <listitem>
	      <para>I hope you like it...</para>
	    </listitem>
	  </varlistentry>
	</variablelist>
      </sect3>
    </sect2>
    
    <sect2 id="cvsup">
      <title><application>CVSup</application></title>
      
      <para><emphasis>Contributed by &a.jdp;</emphasis>.</para>
      
      <sect3 id="cvsup-intro">
	<title>Introduction</title>

	<para><application>CVSup</application> is a software package for
	  distributing and updating source trees from a master CVS repository
	  on a remote server host.  The FreeBSD sources are maintained in a
	  CVS repository on a central development machine in California.  With
	  <application>CVSup</application>, FreeBSD users can easily keep
	  their own source trees up to date.</para>
	    
	<para><application>CVSup</application> uses the so-called
	  <emphasis>pull</emphasis> model of updating.  Under the pull model,
	  each client asks the server for updates, if and when they are
	  wanted.  The server waits passively for update requests from its
	  clients.  Thus all updates are instigated by the client.  The server
	  never sends unsolicited updates.  Users must either run the
	  <application>CVSup</application> client manually to get an update,
	  or they must set up a <command>cron</command> job to run it
	  automatically on a regular basis.</para>
	    
	<para>The term <application>CVSup</application>, capitalized just so,
	  refers to the entire software package.  Its main components are the
	  client <command>cvsup</command> which runs on each user's machine,
	  and the server <command>cvsupd</command> which runs at each of the
	  FreeBSD mirror sites.</para>
	    
	<para>As you read the FreeBSD documentation and mailing lists, you may
	  see references to <application>sup</application>.
	  <application>Sup</application> was the predecessor of
	  <application>CVSup</application>, and it served a similar purpose.
	  <application>CVSup</application> is in used in much the same way as
	  sup and, in fact, uses configuration files which are
	  backward-compatible with <command>sup</command>'s.
	  <application>Sup</application> is no longer used in the FreeBSD
	  project, because <application>CVSup</application> is both faster and
	  more flexible.</para>
      </sect3>
      
      <sect3 id="cvsup-install">
	<title>Installation</title>

	<para>The easiest way to install <application>CVSup</application> if
	  you are running FreeBSD 2.2 or later is to use either <ulink
	    url="ftp://ftp.FreeBSD.org/pub/FreeBSD/ports/ports-current/net/cvsup.tar">the
	    port</ulink> from the FreeBSD <link linkend="ports">ports
	    collection</link> or the corresponding <ulink
	    url="ftp://ftp.FreeBSD.org/pub/FreeBSD/packages-current/net/cvsup-16.0.tgz">binary
	    package</ulink>, depending on whether you prefer to roll your own
	  or not.  If you do not know anything about cvsup at all and want a
	  single package which will install it, set up the configuration file
	  and start the transfer via a pointy-clicky type of interface, then
	  get the <ulink
	  url="ftp://ftp.FreeBSD.org/pub/FreeBSD/development/CVSup/cvsupit.tgz">
	  cvsupit</ulink> package.  Just hand it to pkg_add(1) and it will
	  lead you through the configuration process in a menu-oriented fashion.
	  </para>
	    
	<para>If you are running FreeBSD-2.1.6 or 2.1.7, you unfortunately
	  cannot use the binary package versions due to the fact that they
	  require a version of the C library that does not yet exist in
	  FreeBSD-2.1.{6,7}.  You can easily use <ulink
	    url="ftp://ftp.FreeBSD.org/pub/FreeBSD/ports/ports-current/net/cvsup.tar">the
	    port</ulink>, however, just as with FreeBSD 2.2.  Simply unpack
	  the tar file, cd to the cvsup subdirectory and type <command>make
	    install</command>.</para>
	    
	<para>Because <application>CVSup</application> is written in <ulink
	    url="http://www.research.digital.com/SRC/modula-3/html/home.html">Modula-3</ulink>,
	  both the package and the port require that the Modula-3 runtime
	  libraries be installed.  These are available as the <ulink
	    url="ftp://ftp.FreeBSD.org/pub/FreeBSD/ports/ports-current/lang/modula-3-lib.tar">lang/modula-3-lib</ulink> port and the <ulink url="ftp://ftp.FreeBSD.org/pub/FreeBSD/packages-current/lang/modula-3-lib-3.6.tgz">lang/modula-3-lib-3.6</ulink> package.
	  If you follow the same directions as for <command>cvsup</command>,
	  these libraries will be compiled and/or installed automatically when
	  you install the <application>CVSup</application> port or
	  package.</para>
	    
	<para>The Modula-3 libraries are rather large, and fetching and
	  compiling them is not an instantaneous process.  For that reason, a
	  third option is provided.  You can get <emphasis>statically
	    linked</emphasis> FreeBSD executables for
	  <application>CVSup</application> from the USA distribution
	  site:</para>
	    
	<itemizedlist>
	  <listitem>
	    <para><ulink
		url="ftp://ftp.FreeBSD.org/pub/FreeBSD/development/CVSup/cvsup-bin-16.0.tar.gz">ftp://ftp.FreeBSD.org/pub/FreeBSD/development/CVSup/cvsup-bin-16.0.tar.gz</ulink> (client including GUI).</para>
	  </listitem>
	  
	  <listitem>
	    <para><ulink
		url="ftp://ftp.FreeBSD.org/pub/FreeBSD/development/CVSup/cvsup.nogui-bin-16.0.tar.gz">ftp://ftp.FreeBSD.org/pub/FreeBSD/development/CVSup/cvsup.nogui-bin-16.0.tar.gz</ulink> (client without GUI).</para>
	  </listitem>
	  
	  <listitem>
	    <para><ulink
		url="ftp://ftp.FreeBSD.org/pub/FreeBSD/development/CVSup/cvsupd-bin-16.0.tar.gz">ftp://ftp.FreeBSD.org/pub/FreeBSD/development/CVSup/cvsupd-bin-16.0.tar.gz</ulink> (server).</para>
	  </listitem>
	</itemizedlist>

	<para>as well as from the many FreeBSD <link linkend="mirrors-ftp">FTP
	    mirror sites</link> around the world.</para>

	<para>Most users will need only the client.  These executables are
	  entirely self-contained, and they will run on any version of FreeBSD
	  from FreeBSD-2.1.0 to FreeBSD-current.</para>
	    
	<para>In summary, your options for installing CVSup are:</para>

	<itemizedlist>
	  <listitem>
	    <para>FreeBSD-2.2 or later:		static binary, port, or
	      package</para>
	  </listitem>
	  
	  <listitem>
	    <para>FreeBSD-2.1.6, 2.1.7:		static binary or port</para>
	  </listitem>
	  
	  <listitem>
	    <para>FreeBSD-2.1.5 or earlier:	static binary</para>
	  </listitem>
	</itemizedlist>
      </sect3>
      
      <sect3 id="cvsup-config">
	<title>CVSup Configuration</title>

	<para><application>CVSup</application>'s operation is controlled by a
	  configuration file called the <filename>supfile</filename>.
	  Beginning with FreeBSD-2.2, there are some sample
	  <filename>supfiles</filename> in the directory <ulink
	    url="file:/usr/share/examples/cvsup/">/usr/share/examples/cvsup/</ulink>.
	  These examples are also available from <ulink
	    url="ftp://ftp.FreeBSD.org/pub/FreeBSD/FreeBSD-current/src/share/examples/cvsup/">ftp://ftp.FreeBSD.org/pub/FreeBSD/FreeBSD-current/src/share/examples/cvsup/</ulink> if you are on a pre-2.2 system.</para>

	<para>The information in a <filename>supfile</filename> answers the
	  following questions for cvsup:</para>
		    
	<itemizedlist>
	  <listitem>
	    <para><link linkend="cvsup-config-files">Which files do you want
		to receive?</link></para>
	  </listitem>
	  
	  <listitem>
	    <para><link linkend="cvsup-config-vers">Which versions of them do
		you want?</link></para>
	  </listitem>
	  
	  <listitem>
	    <para><link linkend="cvsup-config-where">Where do you want to get
		them from?</link></para>
	  </listitem>
	  
	  <listitem>
	    <para><link linkend="cvsup-config-dest">Where do you want to put
		them on your own machine?</link></para>
	  </listitem>
	  
	  <listitem>
	    <para><link linkend="cvsup-config-status">Where do you want to put
		your status files?</link></para>
	  </listitem>
	</itemizedlist>

	<para>In the following sections, we will construct a typical
	  <filename>supfile</filename> by answering each of these questions in
	  turn.  First, we describe the overall structure of a
	  <filename>supfile</filename>.</para>
	    
	<para>A <filename>supfile</filename> is a text file.  Comments begin
	  with <literal>#</literal> and extend to the end of the line.  Lines
	  that are blank and lines that contain only comments are
	  ignored.</para>
	    
	<para>Each remaining line describes a set of files that the user
	  wishes to receive.  The line begins with the name of a
	  &ldquo;collection&rdquo;, a logical grouping of files defined by the
	  server. The name of the collection tells the server which files you
	  want.  After the collection name come zero or more fields, separated
	  by white space.  These fields answer the questions listed above.
	  There are two types of fields: flag fields and value fields.  A flag
	  field consists of a keyword standing alone, e.g.,
	  <literal>delete</literal> or <literal>compress</literal>.  A value
	  field also begins with a keyword, but the keyword is followed
	  without intervening white space by <literal>=</literal> and a second
	  word.  For example, <literal>release=cvs</literal> is a value
	  field.</para>
	    
	<para>A <filename>supfile</filename> typically specifies more than one
	  collection to receive.  One way to structure a
	  <filename>supfile</filename> is to specify all of the relevant
	  fields explicitly for each collection.  However, that tends to make
	  the <filename>supfile</filename> lines quite long, and it is
	  inconvenient because most fields are the same for all of the
	  collections in a <filename>supfile</filename>.
	  <application>CVSup</application> provides a defaulting mechanism to
	  avoid these problems.  Lines beginning with the special
	  pseudo-collection name <literal>*default</literal> can be used to
	  set flags and values which will be used as defaults for the
	  subsequent collections in the <filename>supfile</filename>.  A
	  default value can be overridden for an individual collection, by
	  specifying a different value with the collection itself. Defaults
	  can also be changed or augmented in mid-supfile by additional
	  <literal>*default</literal> lines.</para>
	    
	<para>With this background, we will now proceed to construct a
	  <filename>supfile</filename> for receiving and updating the main
	  source tree of <link
	    linkend="current">FreeBSD-current</link>.</para>

	<itemizedlist>
	  <listitem>
	    <para>Which files do you want to receive?<anchor
		id="cvsup-config-files"></para>
		  
	    <para>The files available via <application>CVSup</application> are
	      organized into named groups called &ldquo;collections&rdquo;.
	      The collections that are available are described <link
		linkend="cvsup-collec">here</link>.  In this example, we wish
	      to receive the entire main source tree for the FreeBSD system.
	      There is a single large collection <literal>src-all</literal>
	      which will give us all of that, except the export-controlled
	      cryptography support.  Let us assume for this example that we
	      are in the USA or Canada.  Then we can get the cryptography code
	      with one additional collection, <literal>cvs-crypto</literal>.
	      As a first step toward constructing our
	      <filename>supfile</filename>, we simply list these collections,
	      one per line:</para>
		  
	    <programlisting>
src-all
cvs-crypto</programlisting>
	  </listitem>
		
	  <listitem>
	    <para>Which version(s) of them do you want?<anchor
		id="cvsup-config-vers"></para>
		  
	    <para>With <application>CVSup</application>, you can receive
	      virtually any version of the sources that ever existed.  That is
	      possible because the cvsupd server works directly from the CVS
	      repository, which contains all of the versions.  You specify
	      which one of them you want using the <literal>tag=</literal> and
	      <option>date=</option> value fields.</para>

	    <warning>
	      <para>Be very careful to specify any <literal>tag=</literal>
		fields correctly.  Some tags are valid only for certain
		collections of files.  If you specify an incorrect or
		misspelled tag, CVSup will delete files which you probably do
		not want deleted.  In particular, use <emphasis>only
		</emphasis> <literal>tag=.</literal> for the
		<literal>ports-*</literal> collections.</para>
	    </warning>
		
	    <para>The <literal>tag=</literal> field names a symbolic tag in
	      the repository.  There are two kinds of tags, revision tags and
	      branch tags.  A revision tag refers to a specific revision.  Its
	      meaning stays the same from day to day.  A branch tag, on the
	      other hand, refers to the latest revision on a given line of
	      development, at any given time.  Because a branch tag does not
	      refer to a specific revision, it may mean something different
	      tomorrow than it means today.</para>

	    <para>Here are the branch tags that users might be interested
	      in:</para>
	    
	    <variablelist>
	      <varlistentry>
		<term>tag=.</term>

		<listitem>
		  <para>The main line of development, also known as
		    FreeBSD-current.</para>

		  <note>
		    <para>The <literal>.</literal> is not punctuation; it is
		      the name of the tag.  Valid for all collections.</para>
		  </note>
		</listitem>
	      </varlistentry>
	      
	      <varlistentry>
		<term>RELENG_3</term>

		<listitem>
		  <para>The line of development for FreeBSD-3.x, also known as
		    FreeBSD-stable.  Not valid for the ports
		    collection.</para>
		</listitem>
	      </varlistentry>
	      
	      <varlistentry>
		<term>RELENG_2_2</term>
		
		<listitem>
		  <para>The line of development for FreeBSD-2.2.x, also known
		    as 2.2-stable.  Not valid for the ports collection.</para>
		</listitem>
	      </varlistentry>
	    </variablelist>
	    
	    <para>Here are the revision tags that users might be interested
	      in:</para>
		  
	    <variablelist>
	      <varlistentry>
		<term>RELENG_3_4_0_RELEASE</term>

		<listitem>
		  <para>FreeBSD-3.4.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>

	      <varlistentry>

		<term>tag=RELENG_3_3_0_RELEASE</term>

		<listitem>
		  <para>FreeBSD-3.3.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>

	      <varlistentry>

              <term>tag=RELENG_3_2_0_RELEASE</term>
                      
                <listitem>
                  <para>FreeBSD-3.2.  Not valid for the ports-*
                  collections.</para>
                </listitem>
              </varlistentry>
        
              <varlistentry>
		<term>tag=RELENG_3_1_0_RELEASE</term>
		
		<listitem>
		  <para>FreeBSD-3.1.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>
	      
	      <varlistentry>
		<term>tag=RELENG_3_0_0_RELEASE</term>
		
		<listitem>
		  <para>FreeBSD-3.0.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>
	      
	      <varlistentry>
		<term>tag=RELENG_2_2_8_RELEASE</term>
		
		<listitem>
		  <para>FreeBSD-2.2.8.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>
	      
	      <varlistentry>
		<term>tag=RELENG_2_2_7_RELEASE</term>
		
		<listitem>
		  <para>FreeBSD-2.2.7.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>
	      
	      <varlistentry>
		<term>tag=RELENG_2_2_6_RELEASE</term>

		<listitem>
		  <para>FreeBSD-2.2.6.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>
	      
	      <varlistentry>
		<term>tag=RELENG_2_2_5_RELEASE</term>
			
		<listitem>
		  <para>FreeBSD-2.2.5.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>
	      
	      <varlistentry>
		<term>tag=RELENG_2_2_2_RELEASE</term>
		
		<listitem>
		  <para>FreeBSD-2.2.2.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>
	      
	      <varlistentry>
		<term>tag=RELENG_2_2_1_RELEASE</term>
		
		<listitem>
		  <para>FreeBSD-2.2.1.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>
	      
	      <varlistentry>
		<term>tag=RELENG_2_2_0_RELEASE</term>
		
		<listitem>
		  <para>FreeBSD-2.2.0.  Not valid for the ports-*
		    collections.</para>
		</listitem>
	      </varlistentry>
	    </variablelist>
	    
	    <warning>
	      <para>Be very careful to type the tag name exactly as shown.
		<application>CVSup</application> cannot distinguish between
		valid and invalid tags.  If you misspell the tag,
		<application>CVSup</application> will behave as though you had
		specified a valid tag which happens to refer to no files at
		all.  It will delete your existing sources in that
		case.</para>
	    </warning>
	    
	    <para>When you specify a branch tag, you normally receive the
	      latest versions of the files on that line of development.  If
	      you wish to receive some past version, you can do so by
	      specifying a date with the <option>date=</option> value field.
	      The &man.cvsup.1; manual page explains how to do
	      that.</para>

	    <para>For our example, we wish to receive FreeBSD-current. We add
	      this line at the beginning of our
	      <filename>supfile</filename>:</para>
		  
	    <programlisting>
*default tag=.</programlisting>

	    <para>There is an important special case that comes into play if
	      you specify neither a <literal>tag=</literal> field nor a
	      <literal>date=</literal> field.  In that case, you receive the
	      actual RCS files directly from the server's CVS repository,
	      rather than receiving a particular version.  Developers
	      generally prefer this mode of operation.  By maintaining a copy
	      of the repository itself on their systems, they gain the ability
	      to browse the revision histories and examine past versions of
	      files.  This gain is achieved at a large cost in terms of disk
	      space, however.</para>
	  </listitem>
	  
	  <listitem>
	    <para>Where do you want to get them from?<anchor
		id="cvsup-config-where"></para>
		  
	    <para>We use the <literal>host=</literal> field to tell
	      <command>cvsup</command> where to obtain its updates.  Any of
	      the <link linkend="mirrors-cvsup">CVSup mirror sites</link> will
	      do, though you should try to select one that is close to you in
	      cyberspace.  In this example we will use a fictional FreeBSD
	      distribution site, <hostid
		role="fqdn">cvsup666.FreeBSD.org</hostid>:</para>
		  
	    <programlisting>
*default host=cvsup666.FreeBSD.org</programlisting>

	    <para>You will need to change the host to one that actually exists
	      before running CVSup.  On any particular run of
	      <command>cvsup</command>, you can override the host  setting on
	      the command line, with <option>-h
		<replaceable>hostname</replaceable></option>.</para>
	  </listitem>
	  
	  <listitem>
	    <para>Where do you want to put them on your own machine?<anchor
		id="cvsup-config-dest"></para>
		  
	    <para>The <literal>prefix=</literal> field tells
	      <command>cvsup</command> where to put the files it receives.  In
	      this example, we will put the source files directly into our
	      main source tree, <filename>/usr/src</filename>.  The
	      <filename>src</filename> directory is already implicit in the
	      collections we have chosen to receive, so this is the correct
	      specification:</para>
		  
	    <programlisting>
*default prefix=/usr</programlisting>
	  </listitem>
		
	  <listitem>
	    <para>Where should <command>cvsup</command> maintain its status
	      files?<anchor id="cvsup-config-status"></para>
		  
	    <para>The cvsup client maintains certain status files in what is
	      called the &ldquo;base&rdquo; directory.  These files help
	      <application>CVSup</application> to work more efficiently, by
	      keeping track of which updates you have already received.  We
	      will use the standard base directory,
	      <filename>/usr/local/etc/cvsup</filename>:</para>
		  
	    <programlisting>
*default base=/usr/local/etc/cvsup</programlisting>

	    <para>This setting is used by default if it is not specified in
	      the <filename>supfile</filename>, so we actually do not need the
	      above line.</para>

	    <para>If your base directory does not already exist, now would be
	      a good time to create it.  The <command>cvsup</command> client
	      will refuse to run if the base directory does not exist.</para>
	  </listitem>
		
	  <listitem>
	    <para>Miscellaneous <filename>supfile</filename> settings:</para>
	    
	    <para>There is one more line of boiler plate that normally needs
	      to be present in the <filename>supfile</filename>:</para>
		  
	    <programlisting>
*default release=cvs delete use-rel-suffix compress</programlisting>

	    <para><literal>release=cvs</literal> indicates that the server
	      should get its information out of the main FreeBSD CVS
	      repository.  This is virtually always the case, but there are
	      other possibilities which are beyond the scope of this
	      discussion.</para>

	    <para><literal>delete</literal> gives
	      <application>CVSup</application> permission to delete files.
	      You should always specify this, so that
	      <application>CVSup</application> can keep your source tree fully
	      up to date.  <application>CVSup</application> is careful to
	      delete only those files for which it is responsible.  Any extra
	      files you happen to have will be left strictly alone.</para>

	    <para><literal>use-rel-suffix</literal> is ... arcane.  If you
	      really want to know about it, see the &man.cvsup.1; manual page.
	      Otherwise, just specify it and do not worry about it.</para>

	    <para><literal>compress</literal> enables the use of gzip-style
	      compression on the communication channel.  If your network link
	      is T1 speed or faster, you probably should not use compression.
	      Otherwise, it helps substantially.</para>
	  </listitem>
	  
	  <listitem>
	    <para>Putting it all together:</para>
	    
	    <para>Here is the entire <filename>supfile</filename> for our
	      example:</para>
		  
	    <programlisting>
*default tag=.
*default host=cvsup666.FreeBSD.org
*default prefix=/usr
*default base=/usr/local/etc/cvsup
*default release=cvs delete use-rel-suffix compress

src-all
cvs-crypto</programlisting>
	  </listitem>
	</itemizedlist>
      </sect3>
      
      <sect3>
	<title>Running <application>CVSup</application></title>

	<para>You are now ready to try an update.  The command line for doing
	  this is quite simple:</para>
	    
	<screen>&prompt.root; <userinput>cvsup <replaceable>supfile</replaceable></userinput></screen>
	    
	<para>where <filename><replaceable>supfile</replaceable></filename> is
	  of course the name of the supfile you have just created.  Assuming
	  you are running under X11, <command>cvsup</command> will display a
	  GUI window with some buttons to do the usual things.  Press the
	  &ldquo;go&rdquo; button, and watch it run.</para>
	    
	<para>Since you are updating your actual <filename>/usr/src</filename>
	  tree in this example, you will need to run the program as
	  <username>root</username> so that <command>cvsup</command> has the
	  permissions it needs to update your files.  Having just created your
	  configuration file, and having never used this program before, that
	  might understandably make you nervous. There is an easy way to do a
	  trial run without touching your precious files.  Just create an
	  empty directory somewhere convenient, and name it as an extra
	  argument on the command line:</para>

	<screen>&prompt.root; <userinput>mkdir /var/tmp/dest</userinput>
&prompt.root; <userinput>cvsup supfile /var/tmp/dest</userinput></screen>
	    
	<para>The directory you specify will be used as the destination
	  directory for all file updates.  <application>CVSup</application>
	  will examine your usual files in <filename>/usr/src</filename>, but
	  it will not modify or delete any of them.  Any file updates will
	  instead land in <filename>/var/tmp/dest/usr/src</filename>.
	  <application>CVSup</application> will also leave its base directory
	  status files untouched when run this way.  The new versions of those
	  files will be written into the specified directory.  As long as you
	  have read access to <filename>/usr/src</filename>, you do not even
	  need to be root to perform this kind of trial run.</para>
	    
	<para>If you are not running X11 or if you just do not like GUIs, you
	  should add a couple of options to the command line when you run
	  cvsup:</para>
	    
	<screen>&prompt.root; <userinput>cvsup -g -L 2 supfile</userinput></screen>
	    
	<para>The <option>-g</option> tells cvsup not to use its GUI.  This is
	  automatic if you are not running X11, but otherwise you have to
	  specify it.</para>
	    
	<para>The <option>-L 2</option> tells cvsup to print out the details
	  of all the file updates it is doing.  There are three levels of
	  verbosity, from <option>-L 0</option> to <option>-L 2</option>.  The
	  default is 0, which means total silence except for error
	  messages.</para>
	    
	<para>There are plenty of other options available.  For a brief list
	  of them, type <command>cvsup -H</command>.  For more detailed
	  descriptions, see the manual page.</para>

	<para>Once you are satisfied with the way updates are working, you can
	  arrange for regular runs of cvsup using &man.cron.8;.
	  Obviously, you should not let cvsup use its GUI when running it from
	  cron.</para>
      </sect3>
      
      <sect3 id="cvsup-collec">
	<title><application>CVSup</application> File Collections</title>
	    
	<para>The file collections available via
	  <application>CVSup</application> are organized hierarchically.
	  There are a few large collections, and they are divided into smaller
	  sub-collections.  Receiving a large collection is equivalent to
	  receiving each of its sub-collections.  The hierarchical
	  relationships among collections are reflected by the use of
	  indentation in the list below.</para>
	    
	<para>The most commonly used collections are
	  <literal>src-all</literal>, <literal>cvs-crypto</literal>, and
	  <literal>ports-all</literal>.  The other collections are used only
	  by small groups of people for specialized purposes, and some mirror
	  sites may not carry all of them.</para>

	<variablelist>
	  <varlistentry>
	    <term><literal>cvs-all release=cvs</literal></term>

	    <listitem>
	      <para>The main FreeBSD CVS repository, excluding the
		export-restricted cryptography code.</para>
		    
	      <variablelist>
		<varlistentry>
		  <term><literal>distrib release=cvs</literal></term>
		  
		  <listitem>
		    <para>Files related to the distribution and mirroring of
		      FreeBSD.</para>
		  </listitem>
		</varlistentry>
		
		<varlistentry>
		  <term><literal>doc-all release=cvs</literal></term>
		  
		  <listitem>
		    <para>Sources for the FreeBSD handbook and other
		      documentation.</para>
		  </listitem>
		</varlistentry>
		
		<varlistentry>
		  <term><literal>ports-all release=cvs</literal></term>
			  
		  <listitem>
		    <para>The FreeBSD ports collection.</para>
		    
		    <variablelist>
		      <varlistentry>
			<term><literal>ports-archivers
			    release=cvs</literal></term>

			<listitem>
			  <para>Archiving tools.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-astro
			    release=cvs</literal></term>
				  
			<listitem>
			  <para>Astronomical ports.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-audio
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Sound support.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-base release=cvs</literal></term>
			
			<listitem>
			  <para>Miscellaneous files at the top of
			    /usr/ports.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-benchmarks
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Benchmarks.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-biology
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Biology.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-cad release=cvs</literal></term>
			
			<listitem>
			  <para>Computer aided design tools.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-chinese
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Chinese language support.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-comms
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Communication software.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-converters
			    release=cvs</literal></term>
			
			<listitem>
			  <para>character code converters.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-databases
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Databases.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal></literal>ports-deskutils
			  release=cvs</term>
			
			<listitem>
			  <para>Things that used to be on the desktop before
			    computers were invented.</para>
			  </listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-devel
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Development utilities.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-editors
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Editors.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-emulators
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Emulators for other operating systems.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-ftp
			    release=cvs</literal></term>
			
			<listitem>
			  <para>FTP client and server utilities.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-games
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Games.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-german
			    release=cvs</literal></term>
			
			<listitem>
			  <para>German language support.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-graphics
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Graphics utilities.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-japanese
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Japanese language support.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-korean
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Korean language support.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-lang release=cvs</literal></term>
			
			<listitem>
			  <para>Programming languages.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-mail release=cvs</literal></term>
			
			<listitem>
			  <para>Mail software.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-math release=cvs</literal></term>
			
			<listitem>
			  <para>Numerical computation software.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-mbone
			    release=cvs</literal></term>
			
			<listitem>
			  <para>MBone applications.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-misc release=cvs</literal></term>
			
			<listitem>
			  <para>Miscellaneous utilities.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-net release=cvs</literal></term>
			
			<listitem>
			  <para>Networking software.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-news release=cvs</literal></term>
				  
			<listitem>
			  <para>USENET news software.</para>
			</listitem>
		      </varlistentry>

                      <varlistentry>
                        <term><literal>ports-palm
                          release=cvs</literal></term>
                              
                        <listitem>
                          <para>Software support for 3Com Palm(tm) series.</para>
                        </listitem>
                      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-plan9
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Various programs from Plan9.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-print
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Printing software.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-russian
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Russian language support.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-security
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Security utilities.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-shells
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Command line shells.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-sysutils
			    release=cvs</literal></term>

			<listitem>
			  <para>System utilities.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-textproc
			    release=cvs</literal></term>
			
			<listitem>
			  <para>text processing utilities (does not include
			    desktop publishing).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-vietnamese
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Vietnamese language support.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-www release=cvs</literal></term>
				  
			<listitem>
			  <para>Software related to the World Wide Web.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-x11 release=cvs</literal></term>
				  
			<listitem>
			  <para>Ports to support the X window system.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-x11-clocks
			    release=cvs</literal></term>
			
			<listitem>
			  <para>X11 clocks.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-x11-fm
			    release=cvs</literal></term>
			
			<listitem>
			  <para>X11 file managers.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-x11-fonts
			    release=cvs</literal></term>
			
			<listitem>
			  <para>X11 fonts and font utilities.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-x11-toolkits
			    release=cvs</literal></term>
			
			<listitem>
			  <para>X11 toolkits.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>ports-x11-wm</literal></term>
			
			<listitem>
			  <para>X11 window managers.</para>
			</listitem>
		      </varlistentry>
		    </variablelist>
		  </listitem>
		</varlistentry>
		
		<varlistentry>
		  <term><literal>src-all release=cvs</literal></term>
		  
		  <listitem>
		    <para>The main FreeBSD sources, excluding the
		      export-restricted cryptography code.</para>
			    
		    <variablelist>
		      <varlistentry>
			<term><literal>src-base release=cvs</literal></term>
			
			<listitem>
			  <para>Miscellaneous files at the top of
			    <filename>/usr/src</filename>.</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-bin release=cvs</literal></term>
				  
			<listitem>
			  <para>User utilities that may be needed in
			    single-user mode
			    (<filename>/usr/src/bin</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-contrib
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Utilities and libraries from outside the
			    FreeBSD project, used relatively unmodified
			    (<filename>/usr/src/contrib</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-etc release=cvs</literal></term>
				  
			<listitem>
			  <para>System configuration files
			    (<filename>/usr/src/etc</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-games release=cvs</literal></term>
			
			<listitem>
			  <para>Games
			    (<filename>/usr/src/games</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-gnu release=cvs</literal></term>
			
			<listitem>
			  <para>Utilities covered by the GNU Public License
			    (<filename>/usr/src/gnu</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-include
			    release=cvs</literal></term>
				  
			<listitem>
			  <para>Header files
			    (<filename>/usr/src/include</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-kerberosIV
			    release=cvs</literal></term>
				  
			<listitem>
			  <para>KerberosIV security package
			    (<filename>/usr/src/kerberosIV</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-lib release=cvs</literal></term>
				  
			<listitem>
			  <para>Libraries
			    (<filename>/usr/src/lib</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-libexec
			    release=cvs</literal></term>
			
			<listitem>
			  <para>System programs normally executed by other
			    programs
			    (<filename>/usr/src/libexec</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-release
			    release=cvs</literal></term>
			
			<listitem>
			  <para>Files required to produce a FreeBSD release
			    (<filename>/usr/src/release</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-sbin release=cvs</literal></term>
			
			<listitem>
			  <para>System utilities for single-user mode
			    (<filename>/usr/src/sbin</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-share release=cvs</literal></term>
			
			<listitem>
			  <para>Files that can be shared across multiple
			    systems
			    (<filename>/usr/src/share</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-sys release=cvs</literal></term>
				  
			<listitem>
			  <para>The kernel
			    (<filename>/usr/src/sys</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-tools release=cvs</literal></term>
				  
			<listitem>
			  <para>Various tools for the maintenance of FreeBSD
			    (<filename>/usr/src/tools</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-usrbin release=cvs</literal></term>
			
			<listitem>
			  <para>User utilities
			    (<filename>/usr/src/usr.bin</filename>).</para>
			</listitem>
		      </varlistentry>
		      
		      <varlistentry>
			<term><literal>src-usrsbin
			    release=cvs</literal></term>
			
			<listitem>
			  <para>System utilities
			    (<filename>/usr/src/usr.sbin</filename>).</para>
			</listitem>
		      </varlistentry>
		    </variablelist>
		  </listitem>
		</varlistentry>
		
		<varlistentry>
		  <term><literal>www release=cvs</literal></term>
			  
		  <listitem>
		    <para>The sources for the World Wide Web data.</para>
		  </listitem>
		</varlistentry>
	      </variablelist>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term><literal>cvs-crypto release=cvs</literal></term>
	    
	    <listitem>
	      <para>The export-restricted cryptography code.</para>
	      
	      <variablelist>
		<varlistentry>
		  <term><literal>src-crypto release=cvs</literal></term>

		  <listitem>
		    <para>Export-restricted utilities and libraries from
		      outside the FreeBSD project, used relatively unmodified
		      (<filename>/usr/src/crypto</filename>).</para>
		  </listitem>
		</varlistentry>
		
		<varlistentry>
		  <term><literal>src-eBones release=cvs</literal></term>
			  
		  <listitem>
		    <para>Kerberos and DES
		      (<filename>/usr/src/eBones</filename>).</para>
		  </listitem>
		</varlistentry>
		
		<varlistentry>
		  <term><literal>src-secure release=cvs</literal></term>
			  
		  <listitem>
		    <para>DES (<filename>/usr/src/secure</filename>).</para>
		  </listitem>
		</varlistentry>
	      </variablelist>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term><literal>distrib release=self</literal></term>
		  
	    <listitem>
	      <para>The CVSup server's own configuration files.  Used by CVSup
		mirror sites.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term><literal>gnats release=current</literal></term>
		  
	    <listitem>
	      <para>The GNATS bug-tracking database.</para>
	    </listitem>
	  </varlistentry>
		
	  <varlistentry>
	    <term><literal>mail-archive release=current</literal></term>
		  
	    <listitem>
	      <para>FreeBSD mailing list archive.</para>
	    </listitem>
	  </varlistentry>
	  
	  <varlistentry>
	    <term><literal>www release=current</literal></term>
		  
	    <listitem>
	      <para>The installed World Wide Web data.  Used by WWW mirror
		sites.</para>
	    </listitem>
	  </varlistentry>
	</variablelist>
      </sect3>
      
      <sect3>
	<title>For more information</title>

	<para>For the CVSup FAQ and other information about CVSup, see <ulink
	    url="http://www.polstra.com/projects/freeware/CVSup/">The CVSup
	    Home Page</ulink>.</para>

	<para>Most FreeBSD-related discussion of
	  <application>CVSup</application> takes place on the &a.hackers;.
	  New versions of the software are announced there, as well as on the
	  &a.announce;.</para>
	    
	<para>Questions and bug reports should be addressed to the author of
	  the program at <email>cvsup-bugs@polstra.com</email>.</para>
      </sect3>
    </sect2>
  </sect1>
  
  <sect1 id="makeworld">
    <title>Using <command>make world</command> to rebuild your system</title>

    <para><emphasis>Contributed by &a.nik;.</emphasis></para>

    <para>Once you have synchronised your local source tree against a
      particular version of FreeBSD (<literal>stable</literal>,
      <literal>current</literal> and so on) you must then use the source tree
      to rebuild the system.</para>

    <warning>
      <title>Take a backup</title>
      
      <para>I cannot stress highly enough how important it is to take a backup
	of your system <emphasis>before</emphasis> you do this.  While
	remaking the world is (as long as you follow these instructions) an
	easy task to do, there will inevitably be times when you make
	mistakes, or when mistakes made by others in the source tree render
	your system unbootable.</para>
    
      <para>Make sure you have taken a backup.  And have a fixit floppy to
	hand.  I have never needed to use them, and, touch wood, I never will,
	but it is always better to be safe than sorry.</para>
    </warning>

    <warning>
      <title>Subscribe to the right mailing list</title>
      
      <para>The -stable and -current FreeBSD code branches are, by their
	nature,  <emphasis>in development</emphasis>.  People that contribute
	to FreeBSD are human, and mistakes occasionally happen.</para>

      <para>Sometimes these mistakes can be quite harmless, just causing your
	system to print a new diagnostic warning.  Or the change may be
	catastrophic, and render your system unbootable or destroy your
	filesystems (or worse).</para>

      <para>If problems like these occur, a <quote>heads up</quote> is posted
	to  the appropriate mailing list, explaining the nature of the problem
	and which systems it affects.  And an <quote>all clear</quote>
	announcement is posted when the problem has been solved.</para>

      <para>If you try and track -stable or -current and do not read
	<email>FreeBSD-stable@FreeBSD.ORG</email> or
	<email>FreeBSD-current@FreeBSD.ORG</email> then you are asking for
	trouble.</para>
    </warning>

  <sect2>
      <title>Check <filename>/etc/make.conf</filename></title>
      
      <para>Examine the file <filename>/etc/make.conf</filename>.  This
	contains some default defines for <command/make/, which will be used
	when you rebuild the source.  They are also used every time you use
	<command/make/, so it is a good idea to make sure they are set to
	something sensible for your system.</para>
    
      <para>Everything is, by default, commented out.  Uncomment those entries
	that look useful.  For a typical user (not a developer), you will
	probably want to uncomment the CFLAGS and NOPROFILE
	definitions.</para>

      <note>
	<title/Version 2.1.7 and below/

	<para>If your machine has a floating point unit (386DX, 486DX, Pentium
	  and up class machines) then you can also uncomment the HAVE_FPU
	  line.</para>

	<para>This definition was removed for version 2.2.2 and up of
	  FreeBSD.</para>
      </note>
      
      <para>Examine the other definitions (COPTFLAGS, NOPORTDOCS and so on)
	and decide if they are relevant to you.</para>
    </sect2>
    
  <sect2>
      <title>Update <filename>/etc/group</filename></title>
      
      <para>The <filename>/etc</filename> directory contains a large part of
	your system's configuration information, as well as scripts that are
	run at system startup.  Some of these scripts change from version to
	version of FreeBSD.</para>

      <para>Some of the configuration files are also used in the day to day
	running of the system.  In particular,
	<filename>/etc/group</filename>.</para>

      <para>There have been occasions when the installation part of
	<quote>make world</quote> has expected certain usernames or groups to
	exist.  When performing an upgrade it is likely that these groups did
	not exist. This caused problems when upgrading.</para>

      <para>The most recent example of this is when the <quote/ppp/ group
	(later renamed <quote/network/) was added.  Users had the installation
	process fail for them when parts of the <filename>ppp</filename>
	subsystem were installed using a non-existent (for them) group
	name.</para>

      <para>The solution is to examine <filename>/usr/src/etc/group</filename>
	and compare its list of groups with your own.  If they are any groups
	in the new file that are not in your file then copy them over.
	Similarly, you should rename any groups in
	<filename>/etc/group</filename> which have the same GID but a
	different name to those in
	<filename>/usr/src/etc/group</filename>.</para>

      <tip>
	<para>If you are feeling particularly paranoid, you can check your
	  system to see which files are owned by the group you are renaming or
	  deleting.</para>

	<screen>&prompt.root; <userinput>find / -group <replaceable>GID</replaceable> -print</userinput></screen>

	<para>will show all files owned by group <replaceable>GID</replaceable>
	  (which can be either a group name or a numeric group ID).</para>
      </tip>
    </sect2>
    
    <sect2>
      <title/Drop to single user mode/
      
      <para>You may want to compile the system in single user mode.  Apart
	from the obvious benefit of making things go slightly faster,
	reinstalling the system will touch a lot of important system files,
	all the standard system binaries, libraries, include files and so on.
	Changing these on a  running system (particularly if you have active
	users on their at the time) is asking for trouble.</para>

      <para>That said, if you are confident, you can omit this step.</para>
      
      <note>
	<title>Version 2.2.5 and above</title>

	<para>As described in more detail below, versions 2.2.5 and above of
	  FreeBSD have separated the building process from the installing
	  process.  You can therefore <emphasis>build</emphasis> the new
	  system in multi user mode, and then drop to single user mode to do
	  the installation.</para>
      </note>
      
      <para>As the superuser, you can execute

	<screen>&prompt.root; <userinput/shutdown now/</screen>

	from a running system, which will drop it to single user mode.</para>
      
      <para>Alternatively, reboot the system, and at the boot prompt, enter
	the <option>-s</option> flag.  The system will then boot single user.
	At the shell prompt you should then run:</para>

      <screen>&prompt.root; <userinput>fsck -p</userinput>
&prompt.root; <userinput>mount -u /</userinput>
&prompt.root; <userinput>mount -a -t ufs</userinput>
&prompt.root; <userinput>swapon -a</userinput></screen>

      <para>This checks the filesystems, remounts <filename>/</filename>
	read/write, mounts all the other UFS filesystems referenced in
	<filename>/etc/fstab</filename> and then turns swapping on.</para>
    </sect2>
    
    <sect2>
      <title>Remove <filename>/usr/obj</filename></title>
      
      <para>As parts of the system are rebuilt they are placed in directories
	which (by default) go under <filename>/usr/obj</filename>.  The
	directories shadow those under <filename>/usr/src</filename>.</para>
      
      <para>You can speed up the <quote>make world</quote> process, and
	possibly  save yourself some dependency headaches by removing this
	directory as well.</para>

      <para>Some files below <filename>/usr/obj</filename> will have the
	immutable flag set (see <command>chflags(1)</command> for more
	information) which must be removed first.</para>

      <screen>&prompt.root; <userinput>cd /usr/obj</userinput>
&prompt.root; <userinput>chflags -R noschg *</userinput>
&prompt.root; <userinput>rm -rf *</userinput></screen>
    </sect2>

    <sect2>
      <title/Recompile the source and install the new system/
      
      <sect3>
	<title>All versions</title>

	<para>You must be in the <filename>/usr/src</filename> directory, so

	  <screen>&prompt.root; <userinput>cd /usr/src</userinput></screen>
	  
	  (unless, of course, your source code is elsewhere, in which case
	  change to that directory instead).</para>
      
	<para>To rebuild the world you use the &man.make.1; command.  This
	  command reads instructions from the <filename>Makefile</filename>
	  which describes how the programs that comprise FreeBSD should be
	  rebuilt, the order they should be built in, and so on.</para>

	<para>The general format of the command line you will type is as
	  follows;</para>

	<screen>&prompt.root; <userinput>make <option>-<replaceable/x/</option> <option>-D<replaceable>VARIABLE</replaceable></option> <replaceable>target</replaceable></userinput></screen>

	<para>In this example, <option>-<replaceable>x</replaceable></option>
	  is an option that you would pass to &man.make.1;.  See the manual
	  page for an example of the options you can pass.</para>

	<para><option>-D<replaceable>VARIABLE</replaceable></option> passes a
	  variable to the <filename>Makefile</filename>.  The behaviour of the
	  <filename>Makefile</filename> is controlled by these variables.
	  These are the same variables as are set in
	  <filename>/etc/make.conf</filename>, and this provides another way
	  of setting them.</para>

	<screen>&prompt.root; <userinput>make -DNOPROFILE=true <replaceable>target</replaceable></userinput></screen>
      
	<para>is another way of specifying that profiled libaries should not be
	  built, and corresponds with the

	  <programlisting>NOPROFILE=    true
#    Avoid compiling profiled libraries</programlisting>

	  lines in <filename>/etc/make.conf</filename>.</para>

	<para><replaceable>target</replaceable> tells &man.make.1; what you
	  want to do.  Each <filename>Makefile</filename> defines a number of
	  different <quote>targets</quote>, and your choice of target
	  determines what happens.</para>

	<para>Some targets are listed in the <filename>Makefile</filename>,
	  but are not meant for you to run.  Instead, they are used by the
	  build process to break out the steps necessary to rebuild the system
	  into a number of sub-steps.</para>

	<para>Most of the time you won't need to pass any parameters to
	    &man.make.1;, and so your command like will look like this.</para>

	<screen>&prompt.root; <userinput>make <replaceable>target</replaceable></userinput></screen>
      </sect3>

      <sect3>
	<title>Saving the output</title>

	<para>It's a good idea to save the output you get from running
	    &man.make.1; to another file.  If something goes wrong you will
	  have a copy of the error message, and a complete list of where the
	  process had got to.  While this might not help you in diagnosing
	  what has gone wrong, it can help others if you post your problem to
	  one of the FreeBSD mailing lists.</para>

	<para>The easiest way to do this is to use the &man.script.1; command,
	  with a parameter that specifies the name of the file to save all
	  output to.  You would do this immediately before remaking the world,
	  and then type <userinput>exit</userinput> when the process has
	  finished.</para>

	<screen>&prompt.root; <userinput>script /var/tmp/mw.out</userinput>
Script started, output file is /var/tmp/mw.out	 
&prompt.root; <userinput>make world</userinput>
<emphasis>&hellip; compile, compile, compile &hellip;</emphasis>	  
&prompt.root; <userinput>exit</userinput>
Script done, &hellip;</screen>

	<para>If you do this, <emphasis>do not</emphasis> save the output in
	  <filename>/tmp</filename>.  This directory may be cleared next time
	  you reboot.  A better place to store it is in
	  <filename>/var/tmp</filename> (as in the previous example) or in
	  <username>root</username>'s home directory.</para>
      </sect3>
      
      <sect3>
	<title>Version 2.2.2 and below</title>

	<para><filename>/usr/src/Makefile</filename> contains the
	  <maketarget>world</maketarget> target, which will rebuild the entire
	  system and then install it.</para>

	<para>Use it like this.</para>
      
	<screen>&prompt.root; <userinput>make world</userinput></screen>
      </sect3>
      
      <sect3>
	<title>Version 2.2.5 and above</title>

	<para>Beginning with version 2.2.5 of FreeBSD (actually, it was first
	  created on the -current branch, and then retrofitted to -stable
	  midway between 2.2.2 and 2.2.5) the <maketarget>world</maketarget>
	  target has been split in two.  <maketarget>buildworld</maketarget>
	  and <maketarget>installworld</maketarget>.</para>

	<para>As the names imply, <maketarget>buildworld</maketarget> builds a
	  complete new tree under <filename>/usr/obj</filename>, and
	  <maketarget>installworld</maketarget> installs this tree on the
	  current machine.</para>

	<para>This is very useful for 2 reasons.  First, it allows you to do
	  the build safe in the knowledge that no components of your running
	  system will be affected.  The build is <quote>self hosted</quote>.
	  Because of this, you can safely run
	  <maketarget>buildworld</maketarget> on a machine running in
	  multi-user mode with  no fear of ill-effects.  I still recommend you
	  run the <maketarget>installworld</maketarget> part in single user
	  mode though.</para>

	<para>Secondly, it allows you to use NFS mounts to upgrade multiple
	  machines on your network.  If you have three machines, A, B and C
	  that you want to upgrade, run <command>make buildworld</command> and
	  <command>make installworld</command> on A.  B and C should then NFS
	  mount <filename>/usr/src</filename> and
	  <filename>/usr/obj</filename> from A, and you can then run
	  <command>make installworld</command> to install the results of the
	  build on B and C.</para>

	<para>The <maketarget>world</maketarget> target still exists, and you
	  can use it exactly as shown for version 2.2.2.  <command>make
	    world</command> runs <command>make buildworld</command> followed
	  by <command>make installworld</command>.</para>

	<note>
	  <para>If you do the <command>make buildworld</command> and
	    <command>make installworld</command> commands separately, you must
	    pass the same parameters to &man.make.1; each time.</para>

	  <para>If you run

	    <screen>&prompt.root; <userinput>make -DNOPROFILE=true buildworld</userinput></screen>

	    you must install the results with

	    <screen>&prompt.root; <userinput>make -DNOPROFILE=true installworld</userinput></screen>

	    otherwise it would try and install profiled libraries that had not
	    been built during the <command>make buildworld</command>
	    phase.</para>
	</note>
      </sect3>
      
      <sect3>
	<title>-current and above</title>

	<para>If you are tracking -current you can also pass the
	  <option>-j</option> option to <command>make</command>.  This lets
	  <command>make</command> spawn several simultaneous processes.</para>

	<para>This is most useful on true multi-CPU machines.  However, since
	  much of the compiling process is IO bound rather than CPU bound it is
	  also useful on single CPU machines.</para>

	<para>On a typical single-CPU machine you would run:</para>
	  
	  <screen>&prompt.root; <userinput>make -j4 <replaceable>target</replaceable></userinput></screen>

	<para>&man.make.1; will then have up to 4 processes running at any one
	  time. Empirical evidence posted to the mailing lists shows this
	  generally gives the best performance benefit.</para>

	<para>If you have a multi-CPU machine and you are using an SMP
	  configured kernel try values between 6 and 10 and see how they speed
	  things up.</para>

	<para>Be aware that (at the time of writing) this is still
	  experimental, and commits to the source tree may occasionally break
	  this feature. If  the world fails to compile using this parameter
	  try again without it before you report any problems.</para>
      </sect3>
      
      <sect3>
	<title>Timings</title>

	<para>Assuming everything goes well you have anywhere between an hour
	  and a half and a day or so to wait.</para>

	<para>As a general rule of thumb, a 200MHz P6 with more than 32MB of
	  RAM  and reasonable SCSI disks will complete <command>make
	    world</command> in about an hour and a half.  A 32MB P133 will
	  take 5 or 6 hours.  Revise these figures down if your machines are
	  slower&hellip;</para>
      </sect3>
    </sect2>
    
    <sect2>
      <title>Update <filename>/etc</filename></title>
      
      <para>Remaking the world will not update certain directories (in
	particular, <filename>/etc</filename>, <filename>/var</filename> and
	<filename>/usr</filename>) with new or changed configuration files.
	This is something you have to do by hand, eyeball, and judicious use
	of &man.diff.1;.</para>
    
      <para>You cannot just copy over the files from
	<filename>/usr/src/etc</filename> to <filename>/etc</filename> and
	have it work.  Some of these files must be <quote>installed</quote>
	first.  This is because the <filename>/usr/src/etc</filename>
	directory <emphasis>is not</emphasis> a copy of what your
	<filename>/etc</filename> directory should look like.  In addition,
	there  are files that should be in <filename>/etc</filename> that are
	not in <filename>/usr/src/etc</filename>.</para>
    
      <para>The simplest way to do this is to install the files into a new
	directory, and then work through them looking for differences.</para>
    
      <warning>
	<title>Backup your existing <filename>/etc</filename></title>

	<para>Although, in theory, nothing is going to touch this directory
	  automatically, it is always better to be sure.  So copy your
	  existing <filename>/etc</filename> directory somewhere safe.
	  Something like:</para>

	<screen>&prompt.root; <userinput>cp -Rp /etc /etc.old</userinput></screen>

	<para><option>-R</option> does a recursive copy, <option>-p</option>
	  preserves times, ownerships on files and suchlike.</para>
      </warning>
      
      <para>You need to build a dummy set of directories to install the new
	<filename>/etc</filename> and other files into.  I generally choose to
	put this dummy directory in <filename>/var/tmp/root</filename>, and
	there are a number of subdirectories required under this as
	well.</para>

      <screen>&prompt.root; <userinput>mkdir /var/tmp/root</userinput>
&prompt.root; <userinput>cd /usr/src/etc</userinput>
&prompt.root; <userinput>make DESTDIR=/var/tmp/root distrib-dirs distribution</userinput></screen>

      <para>This will build the necessary directory structure and install the
	files.  A lot of the subdirectories that have been created under
	<filename>/var/tmp/root</filename> are empty and should be deleted.
	The simplest way to do this is to:</para>
      
      <screen>&prompt.root; <userinput>cd /var/tmp/root</userinput>
&prompt.root; <userinput>find -d .  -type d | /usr/bin/perl -lne \
    'opendir(D,$_);@f=readdir(D);rmdir if $#f == 1;closedir(D);'</userinput></screen>
      
      <para>This does a depth first search, examines each directory, and if
	the number of files in that directory is 2 (<quote/1/ is not a typo in
	the script) i.e., <quote/<filename/.// and <quote/<filename/..// then
	it removes the directory.</para>
    
      <para><filename>/var/tmp/root</filename> now contains all the files that
	should be placed in appropriate locations below
	<filename>/</filename>.  You now have to go through each of these
	files, determining how they differ with your existing files.</para>
    
      <para>Note that some of the files that will have been installed in
	<filename>/var/tmp/root</filename> have a leading <quote/./.  At the
	time of writing the only files like this are shell startup files in
	<filename>/var/tmp/root/</filename> and
	<filename>/var/tmp/root/root/</filename>, although there may be others
	(depending on when you are reading this.  Make sure you use
	<command/ls -a/ to catch them.</para>
    
      <para>The simplest way to do this is to use &man.diff.1; to compare the
	two files.</para>
    
      <screen>&prompt.root; <userinput>diff /etc/shells /var/tmp/root/etc/shells</userinput></screen>
      
      <para>This will show you the differences between your
	<filename>/etc/shells</filename> file and the new
	<filename>/etc/shells</filename> file.  Use these to decide whether to
	merge in changes that you have made or whether to copy over your old
	file.</para>
    
      <tip>
	<title>Name the new root directory
	  (<filename>/var/tmp/root</filename>)with a timestamp, so you can
	  easily compare differences between versions</title>

	<para>Frequently remaking the world means that you have to update
	<filename>/etc</filename> frequently as well, which can be a bit of
	  a chore.</para>

	<para>You can speed this process up by keeping a copy of the last set
	  of changed files that you merged into <filename>/etc</filename>.
	  The  following procedure gives one idea of how to do this.</para>

	<procedure>
	  <step>
	    <para>Make the world as normal.  When you want to update
	      <filename>/etc</filename> and the other directories, give the
	      target directory a name based on the current date.  If you were
	      doing this on the 14th of February 1998 you could do the
	      following.</para>
	  
	    <screen>&prompt.root; <userinput>mkdir /var/tmp/root-19980214</userinput>
&prompt.root; <userinput>cd /usr/src/etc</userinput>
&prompt.root; <userinput>make DESTDIR=/var/tmp/root-19980214 \
    distrib-dirs distribution</userinput></screen>
	  </step>
	  
	  <step>
	    <para>Merge in the changes from this directory as outlined
	      above.</para>
	    
	    <para><emphasis>Do not</emphasis> remove the
	      <filename>/var/tmp/root-19980214</filename> directory when you
	      have finished.</para>
	  </step>
	  
	  <step>
	    <para>When you have downloaded the latest version of the source
	      and remade it, follow step 1.  This will give you a new
	      directory, which might be called
	      <filename>/var/tmp/root-19980221</filename> (if you wait a week
	      between doing updates).</para>
	  </step>
	  
	  <step>
	    <para>You can now see the differences that have been made in the
	      intervening week using &man.diff.1; to create a recursive diff
	      between the two directories.</para>
	      
	    <screen>&prompt.root; <userinput>cd /var/tmp</userinput>
&prompt.root; <userinput>diff -r root-19980214 root-19980221</userinput></screen>
	  
	    <para>Typically, this will be a much smaller set of differences
	      than those between
	      <filename>/var/tmp/root-19980221/etc</filename> and
	      <filename>/etc</filename>.  Because the set of differences is
	      smaller, it is easier to migrate those changes across into your
	      <filename>/etc</filename> directory.</para>
	  </step>
	  
	  <step>
	    <para>You can now remove the older of the two
	      <filename>/var/tmp/root-*</filename> directories.</para>
	      
	    <screen>&prompt.root; <userinput>rm -rf /var/tmp/root-19980214</userinput></screen>
	  </step>
	  
	  <step>
	    <para>Repeat this process every time you need to merge in changes
	      to  <filename>/etc</filename>.</para>
	  </step>
	</procedure>

	<para>You can use &man.date.1; to automate the  generation of the
	  directory names.</para>
	  
	<screen>&prompt.root; <userinput>mkdir /var/tmp/root-`date "+%Y%m%d"`</userinput></screen>
      </tip>
    </sect2>
  
    <sect2>
      <title>Update <filename>/dev</filename></title>
      
      <note>
	<title>DEVFS</title>

	<para>If you are using DEVFS then this is probably unnecessary.</para>
      </note>
      
      <para>For safety's sake, this is a multistep process.</para>

      <procedure>
	<step>
	  <para>Copy <filename>/var/tmp/root/dev/MAKEDEV</filename> to
	    <filename>/dev</filename>.</para>

	  <screen>&prompt.root; <userinput>cp /var/tmp/root/dev/MAKEDEV /dev</userinput></screen>
	</step>

	<step>
	  <para>Now, take a snapshot of your current
	    <filename>/dev</filename>.  This  snapshot needs to contain the
	    permissions, ownerships, major and minor numbers of each filename,
	    but it should not contain the timestamps.  The easiest way to do
	    this is to use &man.awk.1; to strip out some of the
	    information.</para>

	  <screen>&prompt.root; <userinput>cd /dev</userinput>
&prompt.root; <userinput>ls -l | awk '{print $1, $2, $3, $4, $5, $6, $NF}' > /var/tmp/dev.out</userinput></screen>
	</step>

	<step>
	  <para>Remake all the devices.</para>
	    
	    <screen>&prompt.root; <userinput/sh MAKEDEV all/</screen>
	</step>

	<step>
	  <para>Write another snapshot of the directory, this time to
	    <filename>/var/tmp/dev2.out</filename>.  Now look through these
	    two files for any devices that you missed creating.  There should
	    not be any, but it is better to be safe than sorry.</para>

	  <screen>&prompt.root; <userinput>diff /var/tmp/dev.out /var/tmp/dev2.out</userinput></screen>

	  <para>You are most likely to notice disk slice discrepancies which
	    will involve commands such as
	  
	    <screen>&prompt.root; <userinput>sh MAKEDEV sd0s1</userinput></screen>

	    to recreate the slice entries.  Your precise circumstances may
	    vary.</para>
	</step>
      </procedure>
    </sect2>
    
    <sect2>
      <title>Update <filename>/stand</filename></title>
      
      <note>
	<para>This step is included only for completeness, it can safely be
	  omitted.</para>
      </note>
      
      <para>For completenesses sake you may want to update the files in
	<filename>/stand</filename> as well.  These files consist of hard
	links to the <filename>/stand/sysinstall</filename> binary.  This
	binary should  be statically linked, so that it can work when no other
	filesystems (and  in particular <filename>/usr</filename>) have been
	mounted.</para>

      <screen>&prompt.root; <userinput>cd /usr/src/release/sysinstall</userinput>
&prompt.root; <userinput>make all install</userinput></screen>

      <note>
	<title>Source older than 2 April 1998</title>

	<para>If your source code is older than 2nd April 1998, or the
	  <filename>Makefile</filename> version is not 1.68 or higher (for
	  FreeBSD current and 3.x systems) or 1.48.2.21 or higher (for 2.2.x
	  systems) you will need to add the
	  <userinput>NOSHARED=yes</userinput> option, like so;</para>

	<screen>&prompt.root; <userinput>make NOSHARED=yes all install</userinput></screen>
      </note>
    </sect2>
    
    <sect2>
      <title>Compile and install a new kernel</title>

      <para>To take full advantage of your new system you should recompile the
	kernel.  This is practically a necessity, as certain memory structures
	may have changed, and programs like &man.ps.1; and &man.top.1; will
	fail to work until the kernel and source code versions are the
	same.</para>

      <para>Follow the handbook instructions for compiling a new kernel.  If
	you have previously built a custom kernel then carefully examine the
	<filename>LINT</filename> config file to see if there are any new
	options which you should take advantage of.</para>

      <para>A previous version of this document suggested rebooting before
	rebuilding the kernel.  This is wrong because:</para>

      <itemizedlist>
	<listitem>
	  <para>Commands like &man.ps.1;, &man.ifconfig.8;, and &man.sysctl.8; 
	    may fail.  This could leave your machine unable to connect to the
	    network.</para>
	</listitem>
      
	<listitem>
	  <para>Basic utilities like &man.mount.8; could fail,
	    making it impossible to mount <filename>/</filename>,
	    <filename>/usr</filename> and so on.  This is unlikely if you are
	    tracking a -stable candidate, but more likely if you are tracking
	    -current during a large merge.</para>
	</listitem>

	<listitem>
	  <para>Loadable kernel modules (LKMs on pre-3.x systems, KLDs on 3.x
	    systems and above) built as part of the <quote>world</quote> may
	    crash an older kernel.</para>
	</listitem>
      </itemizedlist>

      <para>For these reasons, it is always best to rebuild and install a
	new kernel before rebooting.</para>

      <para>You should build your new kernel after you have completed
	<userinput>make world</userinput> (or <userinput>make
	  installworld</userinput>).  If you do not want to do this (perhaps
	you want to confirm that the kernel builds before updating your
	system) you may have problems.  These may be because your
	  &man.config.8; command is out of date with respect to your kernel
	sources.</para>

      <para>In this case you could build your kernel with the new version of &man.config.8;</para>
      
      <screen>&prompt.root; <userinput>/usr/obj/usr/src/usr.sbin/config/config <replaceable>KERNELNAME</replaceable></userinput></screen>

      <para>This may not work in all cases.  It is recommended that you
	complete <userinput>make world</userinput> (or <userinput>make
	  installworld</userinput>) before compiling a new kernel.</para>
    </sect2>
    
    <sect2>
      <title/Rebooting/
      
      <para>You are now done.  After you have verified that everything appears
	to be in the right place you can reboot the system.  A simple
	&man.fastboot.8; should do it.</para>

      <screen>&prompt.root; <userinput>fastboot</userinput></screen>
    </sect2>

    <sect2>
      <title>Finished</title>
      
      <para>You should now have successfully upgraded your FreeBSD system.
	Congratulations.</para>
      
      <para>You may notice small problems due to things that you have missed.
	For example, I once deleted <filename>/etc/magic</filename> as part of
	the upgrade and merge to <filename>/etc</filename>, and the
	<command>file</command> command stopped working.  A moment's thought
	meant that

	<screen>&prompt.root; <userinput>cd /usr/src/usr.bin/file</userinput>
&prompt.root; <userinput/make all install/</screen>

	was sufficient to fix that one.</para>
    </sect2>    
    
    <sect2>
      <title/Questions?/

      <qandaset>
	<qandaentry>
	  <question>
	    <para>Do I need to re-make the world for every change?</para>
	  </question>

	  <answer>
            <para>There is no easy answer to this one, as it depends on the
	      nature of the change.  For example, I have just run CVSup, and
	      it has shown the following files as being updated since I last
	      ran it;</para>
      
	    <screen><filename>src/games/cribbage/instr.c</filename>
<filename>src/games/sail/pl_main.c</filename>
<filename>src/release/sysinstall/config.c</filename>
<filename>src/release/sysinstall/media.c</filename>
<filename>src/share/mk/bsd.port.mk</filename></screen>

	    <para>There is nothing in there that I would re-make the world
	      for.  I would go to the appropriate sub-directories and
	      <command>make all install</command>, and that's about it.  But
	      if something major changed, for example
	      <filename>src/lib/libc/stdlib</filename> then I would either
	      re-make the world, or at least those parts of it that are
	      statically linked (as well as anything else I might have added
	      that is statically linked).</para>
      
	    <para>At the end of the day, it is your call.  You might be happy
	      re-making the world every fortnight say, and let changes
	      accumulate over that fortnight.  Or you might want to re-make
	      just those things that have changed, and are confident you can
	      spot all the dependencies.</para>
      
	    <para>And, of course, this all depends on how often you want to
	      upgrade, and whether you are tracking -stable or
	      -current.</para>
	  </answer>
	</qandaentry>

	<qandaentry>
	  <question>
	    <para>My compile failed with lots of signal 12 (or other signal
	      number) errors.  What has happened?</para>
	  </question>

	  <answer>
	    <para>This is normally indicative of hardware problems.
	      (Re)making the world is an effective way to stress test your
	      hardware, and will frequently throw up memory problems.  These
	      normally manifest themselves as the compiler mysteriously dying
	      on receipt of strange signals.</para>
      
	    <para>A sure indicator of this is if you can restart the make and
	      it dies at a different point in the process.</para>
      
	    <para>In this instance there is little you can do except start
	      swapping around the components in your machine to determine
	      which one is failing.</para>
	  </answer>
	</qandaentry>

	<qandaentry>
	  <question>
	    <para>Can I remove <filename>/usr/obj</filename> when I have
	      finished?</para>
	  </question>
	  
	  <answer>
	    <para>That depends on how you want to make the world on future
	      occasions.</para>
      
	    <para><filename>/usr/obj</filename> contains all the object files
	      that were produced during the compilation phase.  Normally, one
	      of the first steps in the <quote/make world/ process is to
	      remove this directory and start afresh.  In this case, keeping
	      <filename>/usr/obj</filename> around after you have finished
	      makes little sense, and will free up a large chunk of disk space
	      (currently about 150MB).</para>
      
	    <para>However, if you know what you are doing you can have
	      <quote/make world/ skip this step.  This will make subsequent
	      builds run much faster, since most of sources will not need to
	      be recompiled.  The flip side of this is that subtle dependency
	      problems can creep in, causing your build to fail in odd ways.
	      This frequently generates noise on the FreeBSD mailing lists,
	      when one person complains that their build has failed, not
	      realising that it is because they have tried to cut
	      corners.</para>
      
	    <para>If you want to live dangerously then make the world, passing
	      the <makevar>NOCLEAN</makevar> definition to make, like
	      this:</para>

	    <screen>&prompt.root; <userinput>make -DNOCLEAN world</userinput></screen>
	  </answer>
	</qandaentry>

	<qandaentry>
	  <question>
	    <para>Can interrupted builds be resumed?</para>
	  </question>

	  <answer>
	    <para>This depends on how far through the process you got before
	      you found a problem.</para>

	    <para><emphasis>In general</emphasis> (and this is not a hard and
	      fast rule) the <quote>make world</quote> process builds new
	      copies of essential tools (such as &man.gcc.1;, and
	      &man.make.1;>) and the system libraries.  These tools and
	      libraries are then installed.  The new tools and libraries are
	      then used to rebuild themselves, and are installed again. The
	      entire system (now including regular user programs, such as
		&man.ls.1; or &man.grep.1;) is then rebuilt with the new
	      system files.</para>

	    <para>If you are at the last state, and you know it (because you
	      have looked through the output that you were storing) then you
	      can (fairly safely) do</para>

	    <screen><emphasis>&hellip; fix the problem &hellip;</emphasis>
&prompt.root; <userinput>cd /usr/src</userinput>
&prompt.root; <userinput>make -DNOCLEAN all</userinput></screen>

	    <para>This will not undo the work of the previous
	      <quote>make world</quote>.</para>

	    <para>If you see the message

	      <screen>--------------------------------------------------------------
Building everything..
--------------------------------------------------------------</screen>

	      in the <quote>make world</quote> output then it is
	      probably fairly safe to do so.</para>
	    
	    <para>If you do not see that message, or you are not sure, then it
	      is always better to be safe than sorry, and restart the build
	      from scratch.</para>
	  </answer>
	</qandaentry>

	<qandaentry>
	  <question>
	    <para>Can I use one machine as a <emphasis/master/ to upgrade lots
	      of machines (NFS)?</para>
	  </question>

	  <answer>
	    <para>People often ask on the FreeBSD mailing lists whether they
	      can do all the compiling on one machine, and then use the
	      results of that compile to <command>make install</command> on to
	      other machines around the network.</para>
      
	    <para>This is not something I have done, so the suggestions below
	      are either from other people, or deduced from the
	      Makefiles.</para>
	    
	    <para>The precise approach to take depends on your version of
	      FreeBSD</para>
	    
	    <para>You must still upgrade <filename>/etc</filename> and
	      <filename>/dev</filename> on the target machines after doing
	      this.</para>
	    
	    <para>For 2.1.7 and below, Antonio Bemfica
	      suggested the following approach:</para>

	    <screen>Date: Thu, 20 Feb 1997 14:05:01 -0400 (AST)
From: Antonio Bemfica &lt;bemfica@militzer.me.tuns.ca&gt;
To: freebsd-questions@freebsd.org
Message-ID: &lt;Pine.BSI.3.94.970220135725.245C-100000@militzer.me.tuns.ca&gt;

Josef Karthauser asked:

&gt; Has anybody got a good method for upgrading machines on a network

First make world, etc.  on your main machine
Second, mount / and /usr from the remote machine:

main_machine% mount remote_machine:/   /mnt
main_machine% mount remote_machine:/usr /mnt/usr

Third, do a 'make install' with /mnt as the destination:

main_machine% make install DESTDIR=/mnt

Repeat for every other remote machine on your network.   It works fine
for me.
     
Antonio</screen>

	    <para>This mechanism will only work (to the best of my knowledge)
	      if you can write to <filename>/usr/src</filename> on the NFS
	      server, as  the <maketarget>install</maketarget> target in 2.1.7
	      and below needed to do this.</para>
	    
	    <para>Midway between 2.1.7 and 2.2.0 the <quote>reinstall</quote>
	      target was committed.  You can use the approach exactly as
	      outlined above for 2.1.7, but use <quote>reinstall</quote>
	      instead of <quote>install</quote>.</para>

	    <para>This approach <emphasis>does not</emphasis> require write
	      access to the <filename>/usr/src</filename> directory on the NFS
	      server.</para>

	    <para>There was a bug introduced in this target between versions
	      1.68 and 1.107 of the Makefile, which meant that write access to
	      the NFS server <emphasis>was</emphasis> required.  This bug was
	      fixed before version 2.2.0 of FreeBSD was released, but may be an
	      issue of you have an old server still running -stable from this
	      era.</para>

	    <para>For version 2.2.5 and above, you can use the
	      <quote>buildworld</quote> and <quote>installworld</quote>
	      targets.  Use them to build a source tree on one machine, and
	      then NFS mount <filename>/usr/src</filename> and
	      <filename>/usr/obj</filename> on the remote machine and install
	      it there.</para>
	  </answer>
	</qandaentry>

	<qandaentry>
	  <question>
	    <para>How can I speed up making the world?</para>

	    <itemizedlist>
	      <listitem>
		<para>Run in single user mode.</para>
	      </listitem>
	      
	      <listitem>
		<para>Put the <filename>/usr/src</filename> and
		  <filename>/usr/obj</filename> directories on separate
		  filesystems held on separate disks.  If possible, put these
		  disks on separate disk controllers.</para>
	      </listitem>
	      
	      <listitem>
		<para>Better still, put these filesystems across separate
		  disks using the <quote>ccd</quote> (concatenated disk
		  driver) device.</para>
	      </listitem>
	      
	      <listitem>
		<para>Turn off profiling (set <quote>NOPROFILE=true</quote> in
		  <filename>/etc/make.conf</filename>).  You almost certainly
		  do not need it.</para>
	      </listitem>
	      
	      <listitem>
		<para>Also in <filename>/etc/make.conf</filename>, set
		  <quote>CFLAGS</quote> to something like <quote>-O
		    -pipe</quote>. The optimisation <quote>-O2</quote> is much
		  slower, and the optimisation difference between
		  <quote>-O</quote> and <quote>-O2</quote> is normally
		  negligible.  <quote>-pipe</quote> lets the compiler use
		  pipes rather than temporary files for communication, which
		  saves disk access (at the expense of memory).</para>
	      </listitem>
	      
	      <listitem>
		<para>Pass the <option>-j&lt;n&gt;</option> option to make (if
		  you are running a sufficiently recent version of FreeBSD) to
		  run multiple processes in parallel.  This helps regardless
		  of whether you have a single or a multi processor
		  machine.</para>
	      </listitem>
	      
	      <listitem><para>The filesystem holding
		  <filename>/usr/src</filename> can be mounted (or remounted)
		  with the <quote>noatime</quote> option.  This stops the time
		  files in the filesystem were last accessed from being
		  written to the disk.  You probably do not need this
		  information anyway.

		  <note>
		    <para><quote>noatime</quote> is in version 2.2.0 and
		      above.</para>
		  </note>
		  
		  <screen>&prompt.root; <userinput>mount -u -o noatime /usr/src</userinput></screen>
		  
		  <warning>
		    <para>The example assumes <filename>/usr/src</filename> is
		      on its own filesystem.  If it is not (if it is a part of
		      <filename>/usr</filename> for example) then you will
		      need to use  that filesystem mount point, and not
		      <filename>/usr/src</filename>.</para>
		  </warning>
		</para>
	      </listitem>
	      
	      <listitem>
		<para>The filesystem holding <filename>/usr/obj</filename> can
		  be mounted (or remounted) with the <quote>async</quote>
		  option.  This causes disk writes to happen asynchronously.
		  In other words, the write completes immediately, and the
		  data is written to the disk a few seconds later.  This
		  allows writes to be clustered together, and can be a
		  dramatic performance boost.</para>

		<warning>
		  <para>Keep in mind that this option makes your filesystem
		    more fragile.  With this option there is an increased
		    chance that, should power fail, the filesystem will be in
		    an unrecoverable state when the machine restarts.</para>
	   
		  <para>If <filename>/usr/obj</filename> is the only thing on
		    this filesystem then it is not a problem.  If you have
		    other, valuable data on the same filesystem then ensure
		    your backups are fresh before you enable this
		    option.</para>
		</warning>
		
		<screen>&prompt.root; <userinput>mount -u -o async /usr/obj</userinput></screen>
		
		<warning>
		  <para>As above, if <filename>/usr/obj</filename> is not on
		    its own filesystem, replace it in the example with the
		    name of the appropriate mount point.</para>
		</warning>
	      </listitem>
	    </itemizedlist>
	  </question>
	</qandaentry>
      </qandaset>
    </sect2>

    <sect2>
      <title>Contributors</title>
      
      <para>The following people have contributed to this document in some
	form or another.  Either by directly suggesting alterations and
	improvements, pointing out errors, or by their messages to the FreeBSD
	mailing lists, from which I have shamelessly cribbed information.  My
	thanks to them.</para>

      <itemizedlist>
	<listitem>
	  <para>Antonio Bemfica,
	    <email>bemfica@militzer.me.tuns.ca</email></para>
	</listitem>

	<listitem>
	  <para>Sue Blake, <email>sue@welearn.com.au</email></para>
	</listitem>

	<listitem>
	  <para>Brian Haskin, <email>haskin@ptway.com</email></para>
	</listitem>

	<listitem>
	  <para>Kees Jan Koster, <email>kjk1@ukc.ac.uk</email></para>
	</listitem>

	<listitem>
	  <para>A Joseph Kosy, <email>koshy@india.hp.com</email></para>
	</listitem>

	<listitem>
	  <para>Greg Lehey, <email>grog@lemis.com</email></para>
	</listitem>

	<listitem>
	  <para>Wes Peters, <email>softweyr@xmission.com</email></para>
	</listitem>

	<listitem>
	  <para>Joseph Stein, <email>joes@wstein.com</email></para>
	</listitem>

	<listitem>
	  <para>Studded, <email>studded@dal.net</email></para>
	</listitem>

	<listitem>
	  <para>Axel Thimm,
	    <email>Axel.Thimm@physik.fu-berlin.de</email></para>
	</listitem>

	<listitem>
	  <para>Matthew Thyer,
	    <email>Matthew.Thyer@dsto.defence.gov.au</email></para>
	</listitem>
      </itemizedlist>
    </sect2>
  </sect1>
</chapter>

<!-- 
     Local Variables:
     mode: sgml
     sgml-declaration: "../chapter.decl"
     sgml-indent-data: t
     sgml-omittag: nil
     sgml-always-quote-attributes: t
     sgml-parent-document: ("../book.sgml" "part" "chapter")
     End:
-->

