---
title: Глава 24. Электронная почта
part: Часть IV. Сетевые коммуникации
prev: books/handbook/ppp-and-slip
next: books/handbook/network-servers
showBookMenu: true
weight: 29
path: "/books/handbook/mail/"
---

[[mail]]
= Электронная почта
:doctype: book
:toc: macro
:toclevels: 1
:icons: font
:sectnums:
:sectnumlevels: 6
:sectnumoffset: 24
:partnums:
:source-highlighter: rouge
:experimental:
:images-path: books/handbook/mail/

ifdef::env-beastie[]
ifdef::backend-html5[]
:imagesdir: ../../../../images/{images-path}
endif::[]
ifndef::book[]
include::shared/authors.adoc[]
include::shared/mirrors.adoc[]
include::shared/releases.adoc[]
include::shared/attributes/attributes-{{% lang %}}.adoc[]
include::shared/{{% lang %}}/teams.adoc[]
include::shared/{{% lang %}}/mailing-lists.adoc[]
include::shared/{{% lang %}}/urls.adoc[]
toc::[]
endif::[]
ifdef::backend-pdf,backend-epub3[]
include::../../../../../shared/asciidoctor.adoc[]
endif::[]
endif::[]

ifndef::env-beastie[]
toc::[]
include::../../../../../shared/asciidoctor.adoc[]
endif::[]

[[mail-synopsis]]
== Краткий обзор

"Электронная почта" называемая также email, является на сегодняшний день одним из самых популярных средств связи. Эта глава описывает основы работы с почтовым сервером в FreeBSD, а также введение в процесс отправки и получения почты в FreeBSD; однако, это не полноценный справочник и фактически в главу не вошло много важной информации. Более подробно эта тема рассмотрена во множестве прекрасных книг, список которых приведен в crossref:bibliography[bibliography,Библиография].

После прочтения этой главы вы узнаете:

* Какие программные компоненты задействованы в отправке и получении электронной почты.
* Какие основные файлы настройки sendmail имеются в FreeBSD.
* Разницу между удаленными и локальными почтовыми ящиками.
* Как запретить спамерам использовать ваш почтовый сервер для пересылки почты.
* Как установить и настроить альтернативный агент передачи почты (Mail Transfer Agent, MTA), заменив им sendmail.
* Как разрешить наиболее часто встречающиеся проблемы с почтовым сервером.
* Как настроить систему только для отправки почты.
* Как использовать почту с коммутируемым подключением к сети.
* Как настроить SMTP аутентификацию для дополнительной защиты.
* Как установить и настроить почтовый агент пользователя (Mail User Agent, MUA), например mutt, для отправки и получения почты.
* Как загрузить почту с удаленного POP или IMAP сервера.
* Как автоматически применять фильтры и правила к входящей почте.

Перед прочтением этой главы вам потребуется:

* Правильно настроить сетевое подключение (crossref:advanced-networking[advanced-networking, Сложные вопросы работы в сети]).
* Правильно настроить DNS для почтового сервера (crossref:network-servers[network-servers, Сетевые серверы]).
* Знать как устанавливать дополнительное программное обеспечение сторонних разработчиков (crossref:ports[ports, Установка приложений. порты и пакеты]).

[[mail-using]]
== Использование электронной почты

В работе почтовой системы задействованы пять основных частей: <<mail-mua,пользовательский почтовый клиент>> (Mail User Agent, MUA), <<mail-mta,почтовый сервис (даемон)>> (Mail Transfer Agent, MTA), <<mail-dns,сервер DNS>>, <<mail-receive,удаленный или локальный почтовый ящик>>, и конечно сам <<mail-host,почтовый сервер>>.

[[mail-mua]]
=== Пользовательский почтовый клиент

Обычно, это программа типа mutt, alpine, elm, mail, а также программы с графическим интерфейсом, такие, как balsa или xfmail, или интегрированные приложения (например, какой-либо WWW браузер типа Netscape). Все эти программы общаются с локальным <<mail-host,почтовым сервером>>, вызывая какой-либо даемон, или напрямую по протоколу TCP.

[[mail-mta]]
=== Почтовый даемон

FreeBSD по умолчанию поставляется с sendmail, но помимо того поддерживает множество других даемонов почтового сервера, вот лишь некоторые из них:

* exim;
* postfix;
* qmail.

Почтовый даемон выполняет только две функции: он отвечает за прием входящей почты и отправку исходящей. Он _не_ отвечает за выдачу почты по протоколам POP или IMAP, и не обеспечивает подключения к локальным почтовым ящикам [.filename]#mbox# или Maildir. Для этих целей вам может потребоваться дополнительный <<mail-receive,даемон>>.

[WARNING]
====

Старые версии sendmail содержат некоторые серьезные ошибки безопасности, которые могут привести к получению атакующим локального и/или удаленного доступа к вашему компьютеру. Убедитесь, что вы работаете с современной версией, свободной от таких ошибок. Или установите альтернативный MTA из crossref:ports[ports,Коллекции Портов FreeBSD].
====

[[mail-dns]]
=== Email и DNS

Служба имен доменов (Domain Name System, DNS) и соответствующий ей даемон `named` играют важную роль в доставке почты. Для доставки почты с вашего сайта другому, даемон почтового сервера обратится к DNS для определения удаленного хоста, отвечающего за доставку почты по назначению. Тот же процесс происходит при доставке почты с удаленного хоста на ваш почтовый сервер.

DNS отвечает за сопоставления имен хостов IP адресам, как и за хранение информации, предназначенной для доставки почты, известной как MX записи. Запись MX (Mail eXchanger) определяет хост или хосты, которые будут получать почту для определенного домена. Если для вашего имени хоста или домена нет записи MX, почта будет доставлена непосредственно на ваш хост, IP адрес которого определен в записи A.

Вы можете просмотреть MX записи для любого домена с помощью команды man:host[1], как показано в примере ниже:

[source,shell]
....
% host -t mx FreeBSD.org
FreeBSD.org mail is handled (pri=10) by mx1.FreeBSD.org
....

[[mail-receive]]
=== Получение почты

Получение почты для вашего домена выполняет почтовый сервер. Он сохраняет отправленную в ваш домен почту в формате либо [.filename]#mbox# (это метод по умолчанию), либо Maildir, в зависимости от настроек. После сохранения почты ее можно либо прочитать локально, используя такие приложения как man:mail[1], mutt, или удаленно, по таким протоколам как POP или IMAP. Это означает, что для локального чтения почты вам не потребуется устанавливать сервер POP или IMAP.

[[pop-and-imap]]
==== Доступ к удаленным почтовым ящикам по протоколам POP и IMAP

Для удаленного доступа к почтовым ящикам вам потребуется доступ к POP или IMAP серверу.  Хотя удаленный доступ обеспечивают оба протокола POP и IMAP, последний предоставляет множество дополнительных возможностей, вот некоторые из них:

* IMAP может как хранить сообщения на удаленном сервере, так и забирать их.
* IMAP поддерживает одновременные обновления.
* IMAP может быть очень полезен для низкоскоростных соединений, поскольку позволяет пользователям получить структуру сообщений без их загрузки; он также может использоваться для выполнения таких задач как поиск на сервере, для минимизации объема передаваемых между клиентом и сервером данных.

Для установки POP или IMAP сервера необходимо выполнить следующие действия:

[.procedure]
====
. Выберите IMAP или POP сервер, который подходит вам наилучшим образом. Следующие POP и IMAP серверы хорошо известны и могут быть приведены в качестве примера:

** qpopper;
** teapop;
** imap-uw;
** courier-imap;
** dovecot;

. Установите POP или IMAP даемон, выбранный из Коллекции Портов.
. Если потребуется, настройте [.filename]#/etc/inetd.conf# для запуска POP или IMAP сервера.
====

[WARNING]
====

Необходимо отметить, что и POP и IMAP серверы передают информацию, включая имя пользователя и пароль, в незашифрованном виде. Это означает, что если вы хотите защитить передачу информации по этим протоколам, потребуется использовать туннелирование сессий через man:ssh[1] или при помощи SSL. Туннелирование соединений описано в crossref:security[security-ssh-tunneling,Туннелирование SSH], а SSL - в crossref:security[openssl,OpenSSL].
====

[[local]]
==== Доступ к локальным почтовым ящикам

Доступ к почтовым ящикам может быть осуществлен непосредственно путем использования MUA на сервере, где эти ящики расположены. Это можно сделать используя приложения вроде mutt или man:mail[1].

[[mail-host]]
=== Почтовый хост

Почтовый хост это сервер, который отвечает за отправку и получение почты для вашего компьютера, и возможно, для всей вашей сети.

[[sendmail]]
== Настройка sendmail

В FreeBSD по умолчанию программой передачи почты (Mail Transfer Agent, MTA) является man:sendmail[8]. Работа sendmail заключается в приеме почты от почтовых программ пользователей (Mail User Agents, MUA) и отправке ее на соответствующий адрес, в соответствии с имеющимися настройками. sendmail может также принимать входящие соединения по сети и доставлять почту в локальные почтовые ящики или перенаправлять их другой программе.

sendmail использует следующие файлы настройки:

[.informaltable]
[cols="1,1", frame="none", options="header"]
|===
| Имя файла
| Назначение

|[.filename]#/etc/mail/access#
|Файл базы данных доступа sendmail

|[.filename]#/etc/mail/aliases#
|Синонимы почтовых ящиков

|[.filename]#/etc/mail/local-host-names#
|Список хостов, для которых sendmail принимает почту

|[.filename]#/etc/mail/mailer.conf#
|Настройки почтовой программы

|[.filename]#/etc/mail/mailertable#
|Таблица доставки почтовой программы

|[.filename]#/etc/mail/sendmail.cf#
|Основной файл настройки sendmail

|[.filename]#/etc/mail/virtusertable#
|Таблицы виртуальных пользователей и доменов
|===

=== [.filename]#/etc/mail/access#

База данных доступа определяет список хостов или IP адресов, имеющих доступ к локальному почтовому серверу, а также тип предоставляемого доступа. Хосты могут быть перечислены как `OK`, `REJECT`, `RELAY` или просто переданы процедуре обработки ошибок sendmail с заданным сообщением об ошибке. Хостам, перечисленным с параметром по умолчанию `OK`, разрешено отправлять почты на этот хост, если адрес назначения почты принадлежит локальной машине. Все почтовые соединения от хостов, перечисленных с параметром `REJECT`, отбрасываются. Для хостов, перечисленных с параметром `RELAY`, разрешена передача через этот сервер почты с любым адресом назначения.

.Настройка базы данных доступа sendmail
[example]
====
[.programlisting]
....
cyberspammer.com		550 We do not accept mail from spammers
FREE.STEALTH.MAILER@		550 We do not accept mail from spammers
another.source.of.spam          REJECT
okay.cyberspammer.com           OK
128.32                          RELAY
....

====

В этом примере приведены пять записей. К отправителям, чей адрес соответствует записи в левой части таблицы, применяется правило записанное в правой части таблицы. В первых двух примерах код ошибки будет передан процедуре обработке ошибок sendmail. В этом случае на удаленном хосте будет получено соответствующее сообщение. В следующем примере почта отбрасывается почта от определенного хоста, `another.source.of.spam`. В четвертом примере разрешается прием почты от хоста `okay.cyberspammer.com`, имя которого более точно совпадает с этой записью, чем с `cyberspammer.com` в примере выше. При более точном совпадении правила перезаписываются. В последнем примере разрешается пересылка почты от хостов с IP адресами, начинающимися с `128.32`. Эти хосты смогут отправлять почту через этот почтовый сервер для других почтовых серверов.

После изменения этого файла для обновления базы данных вам потребуется запустить `make` в каталоге [.filename]#/etc/mail/#.

=== [.filename]#/etc/mail/aliases#

База данных синонимов содержит список виртуальных почтовых ящиков, принадлежащих другим пользователям, файлам, программам, или другим синонимам. Вот несколько примеров, которые могут быть использованы для [.filename]#/etc/mail/aliases#:

.Mail Aliases
[example]
====
[.programlisting]
....
root: localuser
ftp-bugs: joe,eric,paul
bit.bucket:  /dev/null
procmail: "|/usr/local/bin/procmail"
....

====

Формат файла прост; имя почтового ящика слева от двоеточия сопоставляется назначению(ям) справа. В первом примере производится сопоставление почтового ящика `root` почтовому ящику `localuser`, для которого затем опять будет произведен поиск в базе данных синонимов. Если совпадений не обнаружится, сообщение будет доставлено локальному пользователю `localuser`. В следующем примере приведен список рассылки. Почта на адрес `ftp-bugs` рассылается на три локальных почтовых ящика: `joe`, `eric` и `paul`. Обратите внимание, что удалённый почтовый ящик может быть задан в виде mailto:user@example.com[user@example.com]. В следующем примере показана запись почты в файл, в данном случае [.filename]#/dev/null#. И в последнем примере показано отправление почты программе, в данном случае почтовое сообщение переправляется через канал UNIX(R) на стандартный вход [.filename]#/usr/local/bin/procmail#.

После обновления этого файла вам потребуется запустить `make` в каталоге [.filename]#/etc/mail/# для обновления базы данных.

=== [.filename]#/etc/mail/local-host-names#

В этом файле находится список имен хостов, принимаемых программой man:sendmail[8] в качестве локальных. Поместите в этот файл любые домены или хосты, для которых sendmail должен принимать почту. Например, если этот почтовый сервер должен принимать почту для домена `example.com` и хоста `mail.example.com`, его файл [.filename]#local-host-names# может выглядеть примерно так:

[.programlisting]
....
example.com
mail.example.com
....

После обновления этого файла необходимо перезапустить man:sendmail[8], чтобы он смог перечитать изменения.

=== [.filename]#/etc/mail/sendmail.cf#

Основной файл настройки sendmail, [.filename]#sendmail.cf# управляет общим поведением sendmail, включая все, от перезаписи почтовых адресов до отправки удаленным серверам сообщений об отказе от пересылки почты. Конечно, файл настройки с таким многообразием возможностей очень сложен и подробное его описание выходит за рамки данного раздела. К счастью, для стандартных почтовых серверов изменять этот файл придется не часто.

Основной файл настройки sendmail может быть собран из макроса man:m4[1], определяющего возможности и поведение sendmail. Подробнее этот процесс описан в файле [.filename]#/usr/src/contrib/sendmail/cf/README#.

Для применения изменений после правки файла необходимо перезапустить sendmail.

=== [.filename]#/etc/mail/virtusertable#

Файл [.filename]#virtusertable# сопоставляет виртуальные почтовые домены и почтовые ящики реальным почтовым ящикам. Эти почтовые ящики могут быть локальными, удаленными, синонимами, определенными в [.filename]#/etc/mail/aliases#, или файлами.

.Пример таблицы виртуального домена
[example]
====
[.programlisting]
....
root@example.com                root
postmaster@example.com          postmaster@noc.example.net
@example.com                    joe
....

====

В примере выше мы видим сопоставление адресов для домена `example.com`. Почта обрабатывается по первому совпадению с записью в этом файле. Первая запись сопоставляет адрес mailto:root@example.com[root@example.com] локальному почтовому ящику `root`. Вторая запись сопоставляет mailto:postmaster@example.com[postmaster@example.com] локальному почтовому ящику `postmaster` на хосте `noc.example.net`. Наконец, до этого момента адрес в домене `example.com` не совпал ни с одним из предыдущих, будет применено последнее сопоставление, в которому соответствует всякое другое почтовое сообщение, отправленное на любой адрес в `example.com`. Это сообщение будет доставлено в локальный почтовый ящик `joe`.

[[mail-changingmta]]
== Установка другой почтовой программы

Как уже упоминалось, FreeBSD поставляется с MTA (Mail Transfer Agent) sendmail. Следовательно, по умолчанию именно эта программа отвечает за вашу исходящую и входящую почту.

Однако, по различным причинам некоторые системные администраторы заменяют системный MTA. Эти причины варьируются от простого желания попробовать другой MTA до потребности в определенных возможностях пакета, основанного на другой почтовой программе. К счастью, вне зависимости от причины, в FreeBSD такая замена выполняется просто.

=== Установка нового MTA

Вам предоставлен широкий выбор MTA. Начните с поиска в crossref:ports[ports,Коллекции Портов FreeBSD], где их немало. Конечно, вы можете использовать любой MTA по желанию, взятый откуда угодно, если только сможете запустить его под FreeBSD.

Начните с установки нового MTA. После установки у вас будет возможность решить, действительно ли он подходит вашем нуждам, а также настроить новое программное обеспечение перед тем, как заменить им sendmail. При установке новой программы убедитесь, что она не пытается перезаписать системные файлы, такие как [.filename]#/usr/bin/sendmail#. Иначе ваша новая почтовая программа фактически начнет работать до того, как вы ее настроите.

Обратитесь к документации на выбранный MTA за информацией по его настройке.

[[mail-disable-sendmail]]
=== Отключение sendmail

[WARNING]
====

Если вы отключите сервис исходящей почты sendmail, необходимо заменить его альтернативной системой доставки почты. Если вы не сделаете этого, системные программы, такие как man:periodic[8], не смогут отправлять сообщения по электронной почте как обычно. Многие программы в вашей системе могут требовать наличия функционирующей sendmail-совместимой системы. Если приложения будут продолжать использовать программу sendmail для отправки почты после того, как вы её отключили, почта может попасть в неактивную очередь sendmail и никогда не будет доставлена.
====

Для полного отключения sendmail, включая сервис исходящей почты, используйте

[.programlisting]
....
sendmail_enable="NO"
sendmail_submit_enable="NO"
sendmail_outbound_enable="NO"
sendmail_msp_queue_enable="NO"
....

в [.filename]#/etc/rc.conf#.

Если вы хотите отключить только сервис входящей почты sendmail, установите

[.programlisting]
....
sendmail_enable="NO"
....

в [.filename]#/etc/rc.conf#. Дополнительная информация о параметрах запуска sendmail доступна на странице справочника man:rc.sendmail[8].

=== Запуск нового MTA при загрузке

Новый МТА можно запускать автоматически при загрузке системы добавив соответствующую строку в [.filename]#/etc/rc.conf#. Ниже приведен пример для postfix:

[source,shell]
....
# echo 'postfix_enable=<<YES>>' >> /etc/rc.conf
....

С этого момента МТА будет запускаться автоматически во время загрузки системы.

=== Замещение sendmail как почтовой программы по умолчанию

Программа sendmail настолько распространена в качестве стандартной программы для систем UNIX(R), что многие программы считают, что она уже установлена и настроена. По этой причине многие альтернативные MTA предоставляют собственные совместимые реализации интерфейса командной строки sendmail; это облегчает их использование в качестве "прозрачной" замены sendmail.

Поэтому если вы используете альтернативную почтовую программу, потребуется убедиться, что когда программное обеспечение пытается выполнить стандартные исполняемые файлы sendmail, такие как [.filename]#/usr/bin/sendmail#, на самом деле выполняются программы вновь установленной почтовой системы. К счастью, FreeBSD предоставляет систему, называемую man:mailwrapper[8], которая выполняет эту работу за вас.

Когда установлен sendmail, файл [.filename]#/etc/mail/mailer.conf# выглядит примерно так:

[.programlisting]
....
sendmail	/usr/libexec/sendmail/sendmail
send-mail	/usr/libexec/sendmail/sendmail
mailq		/usr/libexec/sendmail/sendmail
newaliases	/usr/libexec/sendmail/sendmail
hoststat	/usr/libexec/sendmail/sendmail
purgestat	/usr/libexec/sendmail/sendmail
....

Это означает, что когда выполняется какая-то из этих стандартных программ (например сам [.filename]#sendmail#), система на самом деле вызывает копию mailwrapper, называемую [.filename]#sendmail#, которая обращается к [.filename]#mailer.conf# и выполняет вместо этого [.filename]#/usr/libexec/sendmail/sendmail#. Такая схема делает простой замену программ, которые на самом деле выполняются, когда вызываются стандартные функции [.filename]#sendmail#.

Поэтому если вы хотите выполнять [.filename]#/usr/local/supermailer/bin/sendmail-compat# вместо sendmail, отредактируйте [.filename]#/etc/mail/mailer.conf# так:

[.programlisting]
....
sendmail	/usr/local/supermailer/bin/sendmail-compat
send-mail	/usr/local/supermailer/bin/sendmail-compat
mailq		/usr/local/supermailer/bin/mailq-compat
newaliases	/usr/local/supermailer/bin/newaliases-compat
hoststat	/usr/local/supermailer/bin/hoststat-compat
purgestat	/usr/local/supermailer/bin/purgestat-compat
....

=== Запуск новой почтовой программы

Как только вы все настроили, потребуется или уничтожить процесс sendmail, который уже не нужен и запустить новую почтовую программу, или просто перегрузить систему. Перезагрузка также даст вам возможность проверить, правильно ли настроена система для автоматического запуска MTA при загрузке.

[[mail-trouble]]
== Поиск и устранение неисправностей

=== Почему я должен использовать FQDN для хостов вне моей подсети?

Вы, видимо, обнаружили, что хост, к которому вы обратились, оказался на самом деле в другом домене; например, если вы находитесь в домене `foo.bar.edu` и хотите обратиться к хосту `mumble` в домене `bar.edu`, то должны указать его полное доменное имя, `mumble.bar.edu`, а не просто `mumble`.

Традиционно, программа разрешения имен BSD BIND позволяла это делать. Однако, текущая версия BIND, поставляемая с FreeBSD, больше не добавляет имена доменов, отличающихся от того, в котором вы находитесь, для не полностью указанных имен хостов. То есть, имя `mumble` будет опознан как `mumble.foo.bar.edu` или будет искаться в корневом домене.

Это отличается от предыдущего поведения, при котором поиск продолжался в доменах `mumble.bar.edu` и `mumble.edu`. Если вам интересны причины объявления такого поведения плохой практикой и даже ошибкой в безопасности, обратитесь к RFC 1535.

Хорошим решением будет поместить строку

[.programlisting]
....
search foo.bar.edu bar.edu
....

вместо ранее используемой:

[.programlisting]
....
domain foo.bar.edu
....

в файл [.filename]#/etc/resolv.conf#. Однако удостоверьтесь, что порядок поиска не нарушает "границ полномочий между локальным и внешним администрированием", в терминологии RFC 1535.

=== sendmail выдает ошибку mail loops back to myself

В FAQ по sendmail дан следующий ответ:

[.programlisting]
....
Я получаю такие сообщения об ошибке:

553 MX list for domain.net points back to relay.domain.net
554 <user@domain.net>... Local configuration error

Как можно решить эту проблему?

Согласно записям MX, почта для домена domain.net перенаправляется на хост
relay.domain.net, однако последний не распознается как
domain.net.  Добавьте domain.net в файл
/etc/mail/local-host-names
[известный как /etc/sendmail.cw до версии 8.10]
(если вы используете
FETURE(use_cw_file)) или добавьте Cw domain.net в файл
/etc/mail/sendmail.cf.
....

FAQ по sendmail можно найти на http://www.sendmail.org/faq/[http://www.sendmail.org/faq/] и рекомендуется прочесть его при желании произвести некоторые "усовершенствования" настроек почтовой системы.

=== Как организовать работу почтового сервера при коммутируемом соединении с Интернет?

Вы хотите подключить к интернет компьютер с FreeBSD, работающий в локальной сети. Компьютер с FreeBSD будет почтовым шлюзом для локальной сети. PPP соединение не выделенное.

Существует как минимум два пути, чтобы сделать это. Один способ это использование UUCP.

Другой способ это использование постоянно работающего интернет сервера для обеспечения вторичного MX сервиса вашего домена. Например, домен вашей компании `example.com`, и провайдер интернет настроил `example.net` для обеспечения вторичного MX сервиса:

[.programlisting]
....
example.com.          MX        10      example.com.
                      MX        20      example.net.
....

Только один хост должен быть указан в качестве последнего получателя (добавьте запись `Cw example.com` в файл [.filename]#/etc/mail/sendmail.cf# на машине `example.com`).

Когда программа `sendmail` (со стороны отправителя) "захочет" доставить почту, она попытается соединиться с вашим хостом (`example.com`) через модемное подключение. Скорее всего, ей это не удастся (вы, вероятнее всего, не будете подключены к интернет). Программа sendmail автоматически перейдет ко вторичному MX серверу, т.е. вашему провайдеру (`example.net`). Вторичный MX сервер будет периодически пытаться соединиться с вашим хостом и доставить почту на основной сервер MX (`example.com`).

Вы можете воспользоваться следующим сценарием, чтобы забирать почту каждый раз, когда вы входите в систему:

[.programlisting]
....
#!/bin/sh
# Put me in /usr/local/bin/pppmyisp
( sleep 60 ; /usr/sbin/sendmail -q ) &
/usr/sbin/ppp -direct pppmyisp
....

Если же вы хотите написать отдельный пользовательский скрипт, лучше воспользоваться командой `sendmail -qRexample.com` вместо вышеприведенного сценария, так как в этом случае вся почта в очереди для хоста `example.com` будет обработана немедленно.

Рассмотрим эту ситуацию подробнее:

Вот пример сообщения из link:{freebsd-isp-url}[freebsd-isp].

[.programlisting]
....
> Мы предоставляем вторичный MX для наших клиентов.  Вы соединяетесь
> с нашим сервером несколько раз в день, чтобы забрать почту для вашего
> первичного (главного) MX (мы не соединяемся с ним каждый раз, когда
> приходит новая почта для его доменов).  Далее, sendmail отправляет
> почту, находящуюся в очереди каждые 30 минут, и клиент должен быть
> подключен к Интернет в течении 30 минут, чтобы удостовериться, что
> вся почта ушла на основной MX-сервер.
>
> Может быть, есть какая-либо команда, которая заставит sendmail
> немедленно отправить все почту, находящуюся в очереди?  Естественно,
> пользователи не обладают какими-либо повышенными привилегиями на
> нашем сервере.

В разделе privacy flags файла
sendmail.cf, определяется опция
Opgoaway,restrictqrun

Уберите restrictqrun, чтобы разрешить рядовым
пользователям инициировать работу с очередью.  Вам также может понадобиться
изменить порядок MX-серверов.  Так, если вы предоставляете первый (основной)
MX-сервер для ваши пользователей, мы указываем:

# If we are the best MX for a host, try directly instead of generating
# local config error.
OwTrue

Таким образом, удаленный хост будет доставлять почту непосредственно к вам,
не пытаясь установить соединение с клиентом.  Затем уже вы, в свою очередь,
отсылаете ее клиенту.  Удостоверьтесь, что в DNS есть записи про
customer.com и hostname.customer.com.  Просто
добавьте запись A в DNS для customer.com.
....

=== Почему я продолжаю получать ошибки Relaying Denied при отправки почты через другие хосты?

В установке FreeBSD по умолчанию, sendmail настроен для отправки почты только от хоста, на котором он работает. Например, если доступен POP сервер, пользователи смогут проверять почту из школы, с работы или других удаленных точек, но не смогут отправлять письма. Обычно, через некоторое время после попытки будет отправлено письмо от MAILER-DAEMON с сообщением об ошибке `5.7 Relaying Denied`.

Есть несколько путей разрешения этой ситуации. Самый прямой путь это использование адреса вашего провайдера в файле relay-domains, расположенном в [.filename]#/etc/mail/relay-domains#. Быстрый способ сделать это:

[source,shell]
....
# echo "your.isp.example.com" > /etc/mail/relay-domains
....

После создания или редактирования этого файла вы должны перезапустить sendmail. Это отлично работает, если вы администратор сервера и не хотите отправлять почту локально, или хотите воспользоваться почтовым клиентом/системой на другом компьютере или даже через другого провайдера. Это также очень полезно, если у вас настроены одна или две почтовые записи. Если необходимо добавить несколько адресов, вы можете просто открыть этот файл в текстовом редакторе и добавить домены, по одному на строку:

[.programlisting]
....
your.isp.example.com
other.isp.example.net
users-isp.example.org
www.example.org
....

Теперь будет отправляться любая почта, посылаемая через вашу систему любым хостом из этого списка (предоставляемого пользователем, имеющим учетную запись в вашей системе). Это отличный способ разрешить пользователям отправлять почту через вашу систему удаленно, одновременно он блокирует отправку спама.

[[mail-advanced]]
== Расширенное руководство

В следующем разделе рассматриваются более сложные темы, такие как настройка почты и включение почтовой системы для всего домена.

[[mail-config]]
=== Базовая конфигурация

Изначально, вы можете отправлять почту "во внешний мир" если правильно составлен файл [.filename]#/etc/resolv.conf# или запущен свой сервер имен. Если вы хотите, чтобы почта, предназначенная для хоста в вашем домене, доставлялась MTA (например, sendmail) на вашем хосте FreeBSD, есть два пути:

* Запустите свой собственный сервер DNS, тем самым организовав собственный домен, например, `FreeBSD.org`
* Получайте почту для вашего хоста непосредственно. Это работает при доставке почты непосредственно на DNS имя вашей машины. Например, `example.FreeBSD.org`.

Независимо от выбранного из предложенных выше вариантов, для доставки почты непосредственно на ваш хост у него должен быть постоянный IP адрес (а не динамический, как у большинства PPP соединений). Если вы находитесь за брандмауэром, то последний должен пропускать SMTP-пакеты. Если вы хотите, чтобы почта приходила непосредственно на ваш хост, необходимо убедиться в одном из двух:

* Убедитесь, что запись (с наименьшим номером) MX в DNS соответствует IP адресу вашего хоста.
* Убедитесь, что в DNS для вашего хоста вообще отсутствует MX-запись.

Выполнение любого из перечисленных условий обеспечит доставку почты для вашего хоста.

Попробуйте это:

[source,shell]
....
# hostname
example.FreeBSD.org
# host example.FreeBSD.org
example.FreeBSD.org has address 204.216.27.XX
....

Если вы это видите, то можно без проблем посылать почту на fmailto:yourlogin@example.FreeBSD.org[yourlogin@example.FreeBSD.org] (предполагается, что sendmail на `example.FreeBSD.org` работает правильно).

Однако, если вы видите это:

[source,shell]
....
# host example.FreeBSD.org
example.FreeBSD.org has address 204.216.27.XX
example.FreeBSD.org mail is handled (pri=10) by hub.FreeBSD.org
....

то вся почта, посланная на `example.FreeBSD.org` будет собираться на `hub` (для того же пользователя), вместо того, чтобы быть отосланной непосредственно на ваш хост.

Эта информация обрабатывается вашим DNS сервером. Соответствующая запись DNS, указывающая, через какой хост будет проходить ваша почта, называется MX (__M__ail e__X__changer). Если для хоста отсутствует такая запись, почта будет приходить прямо на этот хост.

Допустим, что запись MX для хоста `freefall.FreeBSD.org` в какой-то момент выглядела так:

[.programlisting]
....
freefall		MX	30	mail.crl.net
freefall		MX	40	agora.rdrop.com
freefall		MX	10	freefall.FreeBSD.org
freefall		MX	20	who.cdrom.com
....

Вы видите, что для хоста `freefall` существуют несколько MX-записей. Запись с наименьшим номером соответствует хосту, получающему почту непосредственно, если он доступен; если он недоступен по каким-то причинам, другие сервера (иногда называемые ("резервными MX") временно получают почту, и хранят ее пока не станут доступны хосты с меньшими номерами, в конечном итоге отправляя почту на эти хосты.

Чтобы альтернативные MX-хосты использовались наиболее эффективно, они должны быть независимо подключены к Интернет. Ваш провайдер (или дружественный сайт) скорее всего без проблем сможет оказать подобные услуги.

[[mail-domain]]
=== Почта для вашего домена

Для настройки "почтового хоста" (почтовый сервер) вам потребуется, чтобы почта, направляемая различным рабочим станциям, пересылалась этому хосту. Обычно вам необходима доставка всей почты для любого хоста вашего домена (в данном случае `*.FreeBSD.org`) на почтовый сервер, чтобы пользователи могли получать свою почту на с этого сервера.

Чтобы облегчить себе (и другим) жизнь, создайте на обеих машинах учетные записи с одинаковыми именами пользователей, например, с помощью команды man:adduser[8].

Сервер, который вы будете использовать в качестве почтового, должен быть объявлен таковым для каждой машины в домене. Вот фрагмент примерной конфигурации:

[.programlisting]
....
example.FreeBSD.org	A	204.216.27.XX		; Рабочая станция
			MX	10 hub.FreeBSD.org	; Почтовый шлюз
....

Таким образом, вся корреспонденция, адресованная рабочей станции, будет обрабатываться вашим почтовым сервером, независимо от того, что указано в A-записи.

Все это можно реализовать только в том случае, если вы используете сервер DNS. Если вы по каким-либо причинам не имеете возможности установить свой собственный сервер имен, необходимо договориться с провайдером или теми, кто поддерживает ваш DNS.

Если вы хотите поддерживать несколько виртуальных почтовых серверов, может пригодиться следующая информация. Допустим, что ваш клиент зарезервировал домен, например, `customer1.org`, и вам требуется, чтобы почта, предназначенная для `customer1.org` приходила на ваш хост, например, `mail.myhost.com`. В таком случае, DNS должен выглядеть так:

[.programlisting]
....
customer1.org		MX	10	mail.myhost.com
....

Заметьте, что если вам требуется только получать почту для домена, соответствующая A-запись _не_ нужна.

[NOTE]
====
Помните, что если вы попытаетесь каким-либо образом обратиться к хосту `customer1.org`, у вас вряд ли что-либо получится, если нет A-записи для этого хоста.
====

Последнее, что вы должны сделать - это сказать программе sendmail, для каких доменов и/или хостов она должна принимать почту. Это можно сделать несколькими способами:

* Добавьте названия этих хостов в файл [.filename]#/etc/mail/local-host-names#, если вы используете `FEATURE(use_cw_file)`. Если у вас sendmail версии ниже 8.10, необходимо отредактировать файл [.filename]#/etc/sendmail.cw#.
* Добавьте строку `Cwyour.host.com` в файл [.filename]#/etc/sendmail.cf# или [.filename]#/etc/mail/sendmail.cf# (если у вас sendmail версии 8.10 или более поздней).

[[outgoing-only]]
== Настройка почты только для отправки

Существует множество случаев, когда может потребоваться только отправка почты через почтовый сервер. Вот отдельные примеры:

* У вас настольный компьютер, но вы хотите использовать такие программы как man:send-pr[1]. Для пересылки почты вам потребуется использовать почтовый сервер провайдера.
* Ваш компьютер является сервером, где почта не хранится локально, необходима только переправка всей почты через внешний почтовый сервер.

Практически любой MTA способен работать и в этих условиях. К сожалению, может быть очень сложно правильно настроить полноценный MTA для работы только с исходящей почтой. Такие программы, как sendmail и postfix слишком избыточны для этих целей.

К тому же, если вы используете обычные средства доступа в интернет, условий для запуска "почтового сервера" может быть недостаточно.

Простейшим способом удовлетворить имеющиеся потребности может быть установка порта package:mail/ssmtp[]. Выполните под `root` следующие команды:

[source,shell]
....
# cd /usr/ports/mail/ssmtp
# make install replace clean
....

После установки потребуется настроить package:mail/ssmtp[] с помощью файла из четырех строк, расположенного в [.filename]#/usr/local/etc/ssmtp/ssmtp.conf#:

[.programlisting]
....
root=yourrealemail@example.com
mailhub=mail.example.com
rewriteDomain=example.com
hostname=_HOSTNAME_
....

Убедитесь, что используете существующий почтовый адрес для `root`. Введите сервер вашего провайдера для пересылки исходящей почты вместо `mail.example.com` (некоторые провайдеры называют его "сервером исходящей почты" или "SMTP сервером").

Убедитесь, что вы выключили sendmail, включая сервис исходящей почты. За подробностями обращайтесь к <<mail-disable-sendmail>>.

У пакета package:mail/ssmtp[] имеются и другие параметры. Обратитесь к файлу с примером настройки в [.filename]#/usr/local/etc/ssmtp# или к странице справочника ssmtp за примерами и дополнительной информацией.

Установка ssmtp таким способом позволит правильно работать любым программам на вашем компьютере, которым требуется отправка почты, но не нарушит политику вашего провайдера и не позволит вашему компьютеру быть использованным спамерами.

[[SMTP-dialup]]
== Использование почты с коммутируемым соединением

Если у вас есть статический IP, настройки по умолчанию менять не потребуется. Установите имя хоста в соответствии с присвоенным именем интернет и sendmail будет делать свою работу.

Если у вас динамический IP адрес и используется коммутируемое PPP соединение с интернет, у вас возможно уже есть почтовый ящик на сервере провайдера. Предположим, что домен провайдера называется `example.net`, и что ваше имя пользователя `user`, ваш компьютер называется `bsd.home`, и провайдер сообщил вам, что возможно использование `relay.example.net` в качестве сервера для пересылки почты.

Для получения почты из почтового ящика необходима установка соответствующей программы. Хорошим выбором является утилита fetchmail, она поддерживает множество различных протоколов. Эта программа доступна в виде пакета или из Коллекции Портов (package:mail/fetchmail[]). Обычно провайдер предоставляет доступ по протоколу POP. Если вы работаете с пользовательским PPP, то можете автоматически забирать почту после установления соединения с интернет с помощью следующей записи в [.filename]#/etc/ppp/ppp.linkup#:

[.programlisting]
....
MYADDR:
!bg su user -c fetchmail
....

Если вы используете sendmail (как показано ниже) для доставки почты к не-локальным учетным записям, вам возможно потребуется обработка почтовой очереди sendmail сразу после установки соединения с интернет. Для выполнения этой работы поместите в [.filename]#/etc/ppp/ppp.linkup# следующую команду сразу после `fetchmail`:

[.programlisting]
....
  !bg su user -c "sendmail -q"
....

Предполагается, что учетная запись для `user` существует на `bsd.home`. В домашнем каталоге `user` на `bsd.home`, создайте файл [.filename]#.fetchmailrc#:

[.programlisting]
....
poll example.net protocol pop3 fetchall pass MySecret
....

Этот файл не должен быть доступен на чтение никому, кроме `user`, поскольку в нем находится пароль `MySecret`.

Для отправки почты с правильным заголовком `from:`, вам потребуется сообщить sendmail использовать mailto:user@example.net[user@example.net] вместо mailto:user@bsd.home[user@bsd.home]. Вы можете также указать sendmail отправлять почту через `relay.example.net`, для более быстрой пересылки почты.

Должен подойти следующий файл [.filename]#.mc#:

[.programlisting]
....
VERSIONID(`bsd.home.mc version 1.0')
OSTYPE(bsd4.4)dnl
FEATURE(nouucp)dnl
MAILER(local)dnl
MAILER(smtp)dnl
Cwlocalhost
Cwbsd.home
MASQUERADE_AS(`example.net')dnl
FEATURE(allmasquerade)dnl
FEATURE(masquerade_envelope)dnl
FEATURE(nocanonify)dnl
FEATURE(nodns)dnl
define(`SMART_HOST', `relay.example.net')
Dmbsd.home
define(`confDOMAIN_NAME',`bsd.home')dnl
define(`confDELIVERY_MODE',`deferred')dnl
....

Обратитесь к предыдущему разделу за информацией о том, как преобразовать этот файл [.filename]#.mc# в файл [.filename]#sendmail.cf#. Не забудьте также перезапустить sendmail после обновления [.filename]#sendmail.cf#.

[[SMTP-Auth]]
== SMTP аутентификация

Наличие SMTP аутентификации на почтовом сервере дает множество преимуществ. SMTP аутентификация может добавить дополнительный уровень безопасности к sendmail, и позволяет мобильным пользователям, подключающимся к разным хостам, возможность использовать тот же почтовый сервер без необходимости перенастройки почтового клиента при каждом подключении.

[.procedure]
====

. Установите package:security/cyrus-sasl2[] из портов. Вы можете найти этот порт в package:security/cyrus-sasl2[]. В пакете package:security/cyrus-sasl2[] есть множество параметров компиляции. Для используемого здесь метода SMTP аутентификации убедитесь, что параметр `LOGIN` не отключен.
. После установки package:security/cyrus-sasl2[], отредактируйте [.filename]#/usr/local/lib/sasl2/Sendmail.conf# (или создайте его если он не существует) и добавьте следующую строку:
+
[.programlisting]
....
pwcheck_method: saslauthd
....
+
. Затем установите package:security/cyrus-sasl2-saslauthd[] и добавьте в [.filename]#/etc/rc.conf# следующую строку:
+
[.programlisting]
....
saslauthd_enable="YES"
....
+ 
а затем запустите saslauthd:
+
[source,shell]
....
# service saslauthd start
....
+ 
Этот даемон является посредником для аутентификации sendmail через базу данных [.filename]#passwd# FreeBSD. Это позволяет избежать проблем, связанных с созданием нового набора имен пользователей и паролей для каждого пользователя, которому необходима SMTP аутентификация, пароль для входа в систему и для отправки почты будет одним и тем же.
. Теперь отредактируйте [.filename]#/etc/make.conf# и добавьте следующие строки:
+
[.programlisting]
....
SENDMAIL_CFLAGS=-I/usr/local/include/sasl -DSASL
SENDMAIL_LDFLAGS=-L/usr/local/lib
SENDMAIL_LDADD=-lsasl2
....
+ 
Эти параметры необходимы sendmail для подключения package:cyrus-sasl2[] во время компиляции. Убедитесь, что package:cyrus-sasl2[] был установлен до перекомпиляции sendmail.
. Перекомпилируйте sendmail, выполнив следующие команды:
+
[source,shell]
....
# cd /usr/src/lib/libsmutil
# make cleandir && make obj && make
# cd /usr/src/lib/libsm
# make cleandir && make obj && make
# cd /usr/src/usr.sbin/sendmail
# make cleandir && make obj && make && make install
....
+ 
Компиляция sendmail должна пройти без проблем, если [.filename]#/usr/src# не был сильно изменен и доступны необходимые разделяемые библиотеки.
. После компилирования и переустановки sendmail, отредактируйте файл [.filename]#/etc/mail/freebsd.mc# (или тот файл, который используется в качестве [.filename]#.mc#; многие администраторы используют в качестве имени этого файла вывод man:hostname[1] для обеспечения уникальности). Добавьте к нему следующие строки:
+
[.programlisting]
....
dnl set SASL options
TRUST_AUTH_MECH(`GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN')dnl
define(`confAUTH_MECHANISMS', `GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN')dnl
....
+ 
Эти параметры настраивают различные методы, доступные sendmail для аутентификации пользователей. Если вы хотите использовать вместо pwcheck другой метод, обратитесь к прилагаемой документации.
. Наконец, запустите man:make[1] в каталоге [.filename]#/etc/mail#. Из файла [.filename]#.mc# будет создан файл [.filename]#.cf#, называющийся [.filename]#freebsd.cf# (или с тем именем, которое было использовано для файла [.filename]#.mc#). Затем используйте команду `make install restart`, которая скопирует файл в [.filename]#sendmail.cf#, и правильно перезапустит sendmail. Дополнительная информация об этом процессе находится в [.filename]#/etc/mail/Makefile#.
====

Если все шаги пройдены успешно, введите информацию для аутентификации в настройки почтового клиента и отправьте тестовое сообщение. Для определения причин возможных ошибок установите параметр sendmail `LogLevel` в 13 и просмотрите [.filename]#/var/log/maillog#.

За дальнейшей информацией обратитесь к странице sendmail, посвященной http://www.sendmail.org/~ca/email/auth.html[ SMTP аутентификации].

[[mail-agents]]
== Почтовые программы пользователей

Почтовая программа пользователя (Mail User Agent, MUA) это приложение, используемое для отправки и получения почты. Кроме того, поскольку почта "эволюционирует" и становится более сложной, MUA совершенствуют свои функции по обработке почты, становятся более удобны в использовании. FreeBSD поддерживает множество различных пользовательских почтовых программ, каждая из которых может быть легко установлена из crossref:ports[ports,Коллекции Портов FreeBSD]. Пользователи могут выбирать между графическими почтовыми клиентами, такими как evolution или balsa, консольными клиентами, такими как mutt, alpine или `mail`, или Web-интерфейсами, используемыми в некоторых больших организациях.

[[mail-command]]
=== mail

В FreeBSD в качестве MUA по умолчанию используется man:mail[1]. Это консольный MUA, предоставляющий все основные функции, необходимые для отправки и получения текстовых сообщений, хотя его возможности по работе с вложениями ограничены и он может работать только с локальными почтовыми ящиками.

Хотя `mail` не поддерживает работу с серверами POP или IMAP, эти почтовые ящики могут быть загружены в локальный файл [.filename]#mbox# с помощью fetchmail, который будет обсуждаться далее в этой главе (<<mail-fetchmail>>).

Для отправки и получения почты выполните `mail`:

[source,shell]
....
% mail
....

Содержимое почтового ящика в каталоге [.filename]#/var/mail# будет автоматически прочитано утилитой `mail`. Если почтовый ящик пуст, утилита завершит работу с сообщением о том, что почта не была обнаружена. После чтения почтового ящика запустится интерфейс программы и будет отображен список сообщений. Сообщения нумеруются автоматически и будут выглядеть как в этом примере:

[source,shell]
....
Mail version 8.1 6/6/93.  Type ? for help.
"/var/mail/marcs": 3 messages 3 new
>N  1 root@localhost        Mon Mar  8 14:05  14/510   "test"
 N  2 root@localhost        Mon Mar  8 14:05  14/509   "user account"
 N  3 root@localhost        Mon Mar  8 14:05  14/509   "sample"
....

Теперь сообщения могут быть прочитаны с помощью команды kbd:[t], завершаемой номером сообщения, которое должно быть отображено. В этом примере мы прочтем первое сообщение:

[source,shell]
....
& t 1
Message 1:
From root@localhost  Mon Mar  8 14:05:52 2004
X-Original-To: marcs@localhost
Delivered-To: marcs@localhost
To: marcs@localhost
Subject: test
Date: Mon,  8 Mar 2004 14:05:52 +0200 (SAST)
From: root@localhost (Charlie Root)

This is a test message, please reply if you receive it.
....

Как видно в примере выше, клавиша kbd:[t] выводит сообщение со всеми заголовками. Для повторного вывода списка сообщений необходимо использовать клавишу kbd:[h].

Если требуется ответить на сообщение, используйте для ответа `mail`, нажав клавишу kbd:[R] или kbd:[r]. Клавиша kbd:[R] используется в `mail` для ответа только отправителю, а kbd:[r] для ответа и отправителю, и другим получателям сообщения. Вы можете также завершить эти команды номером письма, на которое хотите составить ответ. После этого необходимо ввести ответ, конец сообщения должен быть завершен символом kbd:[.] на новой строке. Пример можно увидеть ниже:

[source,shell]
....
& R 1
To: root@localhost
Subject: Re: test

Thank you, I did get your email.
.
EOT
....

Для отправки нового сообщения используйте клавишу kbd:[m] и введите адрес получателя. Несколько получателей могут быть указаны через запятую. Введите тему сообщения и его содержимое. Конец сообщения отмечается помещением символа kbd:[.] на новой строке.

[source,shell]
....
& mail root@localhost
Subject: I mastered mail

Now I can send and receive email using mail ... :)
.
EOT
....

В утилите `mail` для вызова справки в любой момент может быть использована команда kbd:[?], для получения помощи по `mail` необходимо также обратиться к странице справочника man:mail[1].

[NOTE]
====
Как упоминалось выше, команда man:mail[1] не была первоначально предназначена для работы с вложениями, и поэтому их поддержка довольно слабая. Современные MUA, такие как mutt, работают с вложениями гораздо более уверенно. Но если вы все же предпочитаете использовать `mail`, установите порт package:converters/mpack[].
====

[[mutt-command]]
=== mutt

mutt это небольшая но очень мощная почтовая программа с отличными возможностями, в числе которых:

* Возможность сортировки сообщений по дискуссиям;
* Поддержка PGP для подписи и шифрования сообщений;
* Поддержка MIME;
* Поддержка Maildir;
* Широкие возможности настройки.

Все эти возможности делают mutt одним из самых лучших почтовых клиентов. Обратитесь к http://www.mutt.org[http://www.mutt.org] за дополнительной информацией по mutt.

Стабильная версия mutt может быть установлена из порта package:mail/mutt[]. После установки порта, mutt может быть запущен следующей командой:

[source,shell]
....
% mutt
....

mutt автоматически прочтет содержимое пользовательского почтового ящика в каталоге [.filename]#/var/mail# и отобразит почту, если она имеется в наличии. Если почты в ящике пользователя нет, mutt будет ожидать команд от пользователя. В примере ниже показан mutt со списком сообщений:

image::mutt1.png[]

Для чтения почты выберите сообщение с помощью клавиш навигации и нажмите kbd:[Enter]. Пример mutt, отображающего сообщение, показан ниже:

image::mutt2.png[]

Как и команда man:mail[1], mutt позволяет пользователям отвечать как только отправителю, так и всем получателям. Для ответа только отправителю почты, используйте клавишу kbd:[r]. Для группового ответа и отправителю сообщения и всем получателям используйте клавишу kbd:[g].

[NOTE]
====
mutt использует man:vi[1] в качестве редактора для создания писем и ответа на них. Редактор можно заменить путем создания или редактирования собственного [.filename]#.muttrc# в своем домашнем каталоге и установки переменной `editor`, или установкой переменной окружения `EDITOR`. Обратитесь к http://www.mutt.org/[http://www.mutt.org/] за более подробной информацией о настройке mutt.
====

Для создания нового почтового сообщения нажмите kbd:[m]. После введения темы mutt запустит man:vi[1] для создания письма. Как только письмо будет завершено, сохраните его и закройте `vi`, mutt продолжит работу, отобразив окно с сообщением, которое должно быть отправлено. Для отправки сообщения нажмите kbd:[y]. Пример окна с сообщением показан ниже:

image::mutt3.png[]

mutt также содержит исчерпывающий справочник, к которому можно обратиться из большинства меню, нажав клавишу kbd:[?]. Верхняя строка также показывает клавиатурные сокращения, которые могут быть использованы.

[[alpine-command]]
=== alpine

alpine предназначен для начинающих пользователей, но включает некоторые дополнительные возможности.

[WARNING]
====

В программе alpine ранее были обнаружены некоторые уязвимости, позволяющие удаленному взломщику выполнять произвольный код с правами пользователя локальной системы путем отправки специально подготовленного письма. Все эти _известные_ проблемы были исправлены, но код alpine написан в очень небезопасном стиле и офицеры безопасности FreeBSD считают, что возможно наличие других не обнаруженных уязвимостей. Имейте это ввиду при установке alpine.
====

Текущая версия alpine может быть установлена из порта package:mail/alpine[]. Как только порт установлен, alpine можно запустить командой:

[source,shell]
....
% alpine
....

При первом запуске alpine отображает страницу приветствия с кратким введением, а также просьбу команды разработчиков alpine отправить анонимное почтовое сообщение, позволяющее им определить количество пользователей, работающих с их почтовым клиентом. Для отправки анонимного сообщения нажмите kbd:[Enter], или kbd:[E] для выхода из приветствия без отправки анонимного сообщения. Пример приветствия показан ниже:

image::pine1.png[]

Затем отображается главное меню, перемещение по которому осуществляется с помощью клавиш навигации. В главном меню находятся ссылки для составления новых писем, просмотра почтовых каталогов, и даже управления адресной книгой. Ниже главного меню показаны клавиатурные сокращения, выполняющие соответствующие задачи.

По умолчанию alpine открывает каталог [.filename]#inbox#. Для просмотра списка сообщений нажмите kbd:[I], или выберите [.guimenuitem]#MESSAGE INDEX#, как показано ниже:

image::pine2.png[]

В списке показаны сообщения в текущем каталоге, они могут быть просмотрены с помощью клавиш навигации. Подсвеченные сообщения можно прочесть нажав kbd:[Enter].

image::pine3.png[]

На снимке экрана ниже показан пример письма, отображаемого alpine. Внизу экрана даны клавиатурные сокращения. Например, kbd:[r] используется для указания MUA ответить на отображаемое в данный момент сообщение.

image::pine4.png[]

Ответ на письмо в alpine осуществляется с помощью редактора pico, который устанавливается по умолчанию вместе с alpine. pico упрощает навигацию в сообщении гораздо проще для новых пользователей, чем man:vi[1] или man:mail[1]. Как только ответ будет готов, сообщение можно отправить нажав kbd:[Ctrl+X]. alpine запросит подтверждение.

image::pine5.png[]

Программа alpine может быть настроена через пункт [.guimenuitem]#SETUP# главного меню. Обратитесь к странице http://www.washington.edu/alpine/[http://www.washington.edu/alpine/] за дальнейшей информацией.

[[mail-fetchmail]]
== Использование fetchmail

fetchmail это полноценный IMAP и POP клиент, позволяющий пользователям автоматически загружать почту с удаленных серверов IMAP и POP в локальные почтовые ящики; так доступ к почтовым ящикам упрощается. fetchmail может быть установлен из порта package:mail/fetchmail[] и предоставляет различные возможности, в том числе:

* Поддержка протоколов POP3, APOP, KPOP, IMAP, ETRN и ODMR.
* Возможность пересылки почты через SMTP, что позволяет использовать функции фильтрации, перенаправления и синонимов.
* Может быт запущен в режиме даемона для периодической проверки поступающих сообщений.
* Может забирать почту с нескольких почтовых ящиков и рассылать ее различным локальным пользователям в зависимости от настроек.

Описание всех возможностей fetchmail выходит за пределы этой главы, за дополнительной информацией обратитесь к документации по fetchmail. Утилита fetchmail требует наличия файла настройки [.filename]#.fetchmailrc#. Этот файл включает информацию о сервере, а также информацию для аутентификации. Поскольку этот файл содержит важную информацию, правильно будет сделать его доступным для чтения только владельцем с помощью следующей команды:

[source,shell]
....
% chmod 600 .fetchmailrc
....

В следующем примере файл [.filename]#.fetchmailrc# предназначен для загрузки одного почтового ящика по протоколу POP. Этот файл указывает fetchmail соединиться с `example.com` с именем пользователя `joesoap` и паролем `XXX`. В примере подразумевается, что пользователь `joesoap` существует также и в локальной системе.

[.programlisting]
....
poll example.com protocol pop3 username "joesoap" password "XXX"
....

В следующем примере производится подключение к нескольким POP и IMAP серверам, при необходимости почта перенаправляется другим локальным пользователям:

[.programlisting]
....
poll example.com proto pop3:
user "joesoap", with password "XXX", is "jsoap" here;
user "andrea", with password "XXXX";
poll example2.net proto imap:
user "john", with password "XXXXX", is "myth" here;
....

Утилита fetchmail может работать в режиме даемона с флагом `-d`, заданным с интервалом (в секундах), через который fetchmail должен опрашивать серверы, перечисленные в [.filename]#.fetchmailrc#. В следующем примере fetchmail будет забирать почту каждые 600 секунд:

[source,shell]
....
% fetchmail -d 600
....

Дополнительную информацию о fetchmail можно найти на сайте http://fetchmail.berlios.de/[http://fetchmail.berlios.de/].

[[mail-procmail]]
== Использование procmail

Утилита procmail это невероятно мощное приложение, используемое для фильтрации входящей почты. Она позволяет пользователям определять "правила", которые могут быть сопоставлены входящим письмам для выполнения определенных действий или для перенаправления почты в альтернативные почтовые ящики и/или на почтовые адреса. procmail может быть установлен с помощью порта package:mail/procmail[]. После установки он может быть непосредственно интегрирован в большинство MTA; сверьтесь с документацией на ваш MTA. Другой способ интеграции procmail - добавление в файл [.filename]#.forward#, находящийся в домашнем каталоге пользователя, следующей строки:

[.programlisting]
....
"|exec /usr/local/bin/procmail || exit 75"
....

В этом разделе будут показаны основы настройки правил procmail, а также краткое описание их действия. Эти и другие правила должны быть помещены в файл [.filename]#.procmailrc#, который должен находиться в домашнем каталоге пользователя.

Большую часть этих правил также можно найти на странице справочника man:procmailex[5].

Перенаправление всей почты от mailto:user@example.com[user@example.com] на внешний адрес mailto:goodmail@example2.com[goodmail@example2.com]:

[.programlisting]
....
:0
* ^From.*user@example.com
! goodmail@example2.com
....

Перенаправление всей почты объемом меньше 1000 байт на внешний адрес mailto:goodmail@example2.com[goodmail@example2.com]:

[.programlisting]
....
:0
* < 1000
! goodmail@example2.com
....

Перенаправление всей почты, отправляемой на mailto:alternate@example.com[alternate@example.com], в почтовый ящик [.filename]#alternate#:

[.programlisting]
....
:0
* ^TOalternate@example.com
alternate
....

Перенаправление всей почты с "Spam" в [.filename]#/dev/null#:

[.programlisting]
....
:0
^Subject:.*Spam
/dev/null
....

Полезный пример, обрабатывающий входящую почту со списков рассылки `FreeBSD.org` и помещающий каждый список в отдельный почтовый ящик.

[.programlisting]
....
:0
* ^Sender:.owner-freebsd-\/[^@]+@FreeBSD.ORG
{
	LISTNAME=${MATCH}
	:0
	* LISTNAME??^\/[^@]+
	FreeBSD-${MATCH}
}
....
