<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE book PUBLIC "-//FreeBSD//DTD DocBook XML V5.0-Based Extension//EN" "http://www.FreeBSD.org/XML/share/xml/freebsd50.dtd" [
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
--><!ENTITY % chapters SYSTEM "chapters.ent">
<!--
     Creates entities for each chapter in the FreeBSD Handbook. Each entity
     is named chap.foo, where foo is the value of the id attribute on that
     chapter, and corresponds to the name of the directory in which that
     chapter's .xml file is stored.

     Chapters should be listed in the order in which they are referenced.

     $FreeBSD$
--><!ENTITY chap.preface SYSTEM "preface/preface.xml">
<!ENTITY % pgpkeys SYSTEM "../../../share/pgpkeys/pgpkeys.ent">
<!-- $FreeBSD$ --><!-- PGP keyblocks --><!ENTITY pgpkey.0mp SYSTEM "0mp.key">
<!ENTITY pgpkey.aaron SYSTEM "aaron.key">
<!ENTITY pgpkey.ache SYSTEM "ache.key">
<!ENTITY pgpkey.achim SYSTEM "achim.key">
<!ENTITY pgpkey.acm SYSTEM "acm.key">
<!ENTITY pgpkey.adamw SYSTEM "adamw.key">
<!ENTITY pgpkey.adrian SYSTEM "adrian.key">
<!ENTITY pgpkey.adridg SYSTEM "adridg.key">
<!ENTITY pgpkey.ae SYSTEM "ae.key">
<!ENTITY pgpkey.ahze SYSTEM "ahze.key">
<!ENTITY pgpkey.ak SYSTEM "ak.key">
<!ENTITY pgpkey.alc SYSTEM "alc.key">
<!ENTITY pgpkey.ale SYSTEM "ale.key">
<!ENTITY pgpkey.alepulver SYSTEM "alepulver.key">
<!ENTITY pgpkey.alex SYSTEM "alex.key">
<!ENTITY pgpkey.alexbl SYSTEM "alexbl.key">
<!ENTITY pgpkey.alexey SYSTEM "alexey.key">
<!ENTITY pgpkey.allanjude SYSTEM "allanjude.key">
<!ENTITY pgpkey.alonso SYSTEM "alonso.key">
<!ENTITY pgpkey.amdmi3 SYSTEM "amdmi3.key">
<!ENTITY pgpkey.anchie SYSTEM "anchie.key">
<!ENTITY pgpkey.anders SYSTEM "anders.key">
<!ENTITY pgpkey.andreas SYSTEM "andreas.key">
<!ENTITY pgpkey.andrew SYSTEM "andrew.key">
<!ENTITY pgpkey.anholt SYSTEM "anholt.key">
<!ENTITY pgpkey.anish SYSTEM "anish.key">
<!ENTITY pgpkey.anray SYSTEM "anray.key">
<!ENTITY pgpkey.antoine SYSTEM "antoine.key">
<!ENTITY pgpkey.araujo SYSTEM "araujo.key">
<!ENTITY pgpkey.arichardson SYSTEM "arichardson.key">
<!ENTITY pgpkey.ariff SYSTEM "ariff.key">
<!ENTITY pgpkey.arrowd SYSTEM "arrowd.key">
<!ENTITY pgpkey.art SYSTEM "art.key">
<!ENTITY pgpkey.arun SYSTEM "arun.key">
<!ENTITY pgpkey.arundel SYSTEM "arundel.key">
<!ENTITY pgpkey.arved SYSTEM "arved.key">
<!ENTITY pgpkey.arybchik SYSTEM "arybchik.key">
<!ENTITY pgpkey.asami SYSTEM "asami.key">
<!ENTITY pgpkey.ashish SYSTEM "ashish.key">
<!ENTITY pgpkey.asomers SYSTEM "asomers.key">
<!ENTITY pgpkey.avatar SYSTEM "avatar.key">
<!ENTITY pgpkey.avg SYSTEM "avg.key">
<!ENTITY pgpkey.avilla SYSTEM "avilla.key">
<!ENTITY pgpkey.avl SYSTEM "avl.key">
<!ENTITY pgpkey.avos SYSTEM "avos.key">
<!ENTITY pgpkey.badger SYSTEM "badger.key">
<!ENTITY pgpkey.bakul SYSTEM "bakul.key">
<!ENTITY pgpkey.bapt SYSTEM "bapt.key">
<!ENTITY pgpkey.bar SYSTEM "bar.key">
<!ENTITY pgpkey.barner SYSTEM "barner.key">
<!ENTITY pgpkey.bcr SYSTEM "bcr.key">
<!ENTITY pgpkey.bcran SYSTEM "bcran.key">
<!ENTITY pgpkey.bdragon SYSTEM "bdragon.key">
<!ENTITY pgpkey.bdrewery SYSTEM "bdrewery.key">
<!ENTITY pgpkey.beat SYSTEM "beat.key">
<!ENTITY pgpkey.beech SYSTEM "beech.key">
<!ENTITY pgpkey.ben SYSTEM "ben.key">
<!ENTITY pgpkey.benjsc SYSTEM "benjsc.key">
<!ENTITY pgpkey.benno SYSTEM "benno.key">
<!ENTITY pgpkey.bf SYSTEM "bf.key">
<!ENTITY pgpkey.bhaga SYSTEM "bhaga.key">
<!ENTITY pgpkey.bhd SYSTEM "bhd.key">
<!ENTITY pgpkey.bhughes SYSTEM "bhughes.key">
<!ENTITY pgpkey.billf SYSTEM "billf.key">
<!ENTITY pgpkey.bjk SYSTEM "bjk.key">
<!ENTITY pgpkey.bk SYSTEM "bk.key">
<!ENTITY pgpkey.blackend SYSTEM "blackend.key">
<!ENTITY pgpkey.bland SYSTEM "bland.key">
<!ENTITY pgpkey.bmah SYSTEM "bmah.key">
<!ENTITY pgpkey.bms SYSTEM "bms.key">
<!ENTITY pgpkey.bofh SYSTEM "bofh.key">
<!ENTITY pgpkey.br SYSTEM "br.key">
<!ENTITY pgpkey.brd SYSTEM "brd.key">
<!ENTITY pgpkey.brian SYSTEM "brian.key">
<!ENTITY pgpkey.brix SYSTEM "brix.key">
<!ENTITY pgpkey.brnrd SYSTEM "brnrd.key">
<!ENTITY pgpkey.brooks SYSTEM "brooks.key">
<!ENTITY pgpkey.brueffer SYSTEM "brueffer.key">
<!ENTITY pgpkey.bruno SYSTEM "bruno.key">
<!ENTITY pgpkey.bryanv SYSTEM "bryanv.key">
<!ENTITY pgpkey.bsam SYSTEM "bsam.key">
<!ENTITY pgpkey.bschmidt SYSTEM "bschmidt.key">
<!ENTITY pgpkey.bsd SYSTEM "bsd.key">
<!ENTITY pgpkey.bushman SYSTEM "bushman.key">
<!ENTITY pgpkey.bvs SYSTEM "bvs.key">
<!ENTITY pgpkey.bwidawsk SYSTEM "bwidawsk.key">
<!ENTITY pgpkey.bz SYSTEM "bz.key">
<!ENTITY pgpkey.carl SYSTEM "carl.key">
<!ENTITY pgpkey.carlavilla SYSTEM "carlavilla.key">
<!ENTITY pgpkey.cel SYSTEM "cel.key">
<!ENTITY pgpkey.ceri SYSTEM "ceri.key">
<!ENTITY pgpkey.cherry SYSTEM "cherry.key">
<!ENTITY pgpkey.chinsan SYSTEM "chinsan.key">
<!ENTITY pgpkey.chs SYSTEM "chs.key">
<!ENTITY pgpkey.chuck SYSTEM "chuck.key">
<!ENTITY pgpkey.cjc SYSTEM "cjc.key">
<!ENTITY pgpkey.cjh SYSTEM "cjh.key">
<!ENTITY pgpkey.clement SYSTEM "clement.key">
<!ENTITY pgpkey.clive SYSTEM "clive.key">
<!ENTITY pgpkey.clsung SYSTEM "clsung.key">
<!ENTITY pgpkey.cmt SYSTEM "cmt.key">
<!ENTITY pgpkey.cokane SYSTEM "cokane.key">
<!ENTITY pgpkey.core-secretary SYSTEM "core-secretary.key">
<!ENTITY pgpkey.cperciva SYSTEM "cperciva.key">
<!ENTITY pgpkey.cpm SYSTEM "cpm.key">
<!ENTITY pgpkey.crees SYSTEM "crees.key">
<!ENTITY pgpkey.cs SYSTEM "cs.key">
<!ENTITY pgpkey.cshumway SYSTEM "cshumway.key">
<!ENTITY pgpkey.csjp SYSTEM "csjp.key">
<!ENTITY pgpkey.culot SYSTEM "culot.key">
<!ENTITY pgpkey.cy SYSTEM "cy.key">
<!ENTITY pgpkey.dab SYSTEM "dab.key">
<!ENTITY pgpkey.daichi SYSTEM "daichi.key">
<!ENTITY pgpkey.damien SYSTEM "damien.key">
<!ENTITY pgpkey.danfe SYSTEM "danfe.key">
<!ENTITY pgpkey.danger SYSTEM "danger.key">
<!ENTITY pgpkey.danilo SYSTEM "danilo.key">
<!ENTITY pgpkey.dannyboy SYSTEM "dannyboy.key">
<!ENTITY pgpkey.das SYSTEM "das.key">
<!ENTITY pgpkey.davidch SYSTEM "davidch.key">
<!ENTITY pgpkey.davide SYSTEM "davide.key">
<!ENTITY pgpkey.davidxu SYSTEM "davidxu.key">
<!ENTITY pgpkey.db SYSTEM "db.key">
<!ENTITY pgpkey.dbaio SYSTEM "dbaio.key">
<!ENTITY pgpkey.dbn SYSTEM "dbn.key">
<!ENTITY pgpkey.dch SYSTEM "dch.key">
<!ENTITY pgpkey.dchagin SYSTEM "dchagin.key">
<!ENTITY pgpkey.dcs SYSTEM "dcs.key">
<!ENTITY pgpkey.dd SYSTEM "dd.key">
<!ENTITY pgpkey.deb SYSTEM "deb.key">
<!ENTITY pgpkey.decke SYSTEM "decke.key">
<!ENTITY pgpkey.def SYSTEM "def.key">
<!ENTITY pgpkey.deischen SYSTEM "deischen.key">
<!ENTITY pgpkey.delphij SYSTEM "delphij.key">
<!ENTITY pgpkey.demon SYSTEM "demon.key">
<!ENTITY pgpkey.den SYSTEM "den.key">
<!ENTITY pgpkey.des SYSTEM "des.key">
<!ENTITY pgpkey.dfr SYSTEM "dfr.key">
<!ENTITY pgpkey.dhartmei SYSTEM "dhartmei.key">
<!ENTITY pgpkey.dhn SYSTEM "dhn.key">
<!ENTITY pgpkey.dhw SYSTEM "dhw.key">
<!ENTITY pgpkey.dim SYSTEM "dim.key">
<!ENTITY pgpkey.dinoex SYSTEM "dinoex.key">
<!ENTITY pgpkey.dmgk SYSTEM "dmgk.key">
<!ENTITY pgpkey.doceng-secretary SYSTEM "doceng-secretary.key">
<!ENTITY pgpkey.dougm SYSTEM "dougm.key">
<!ENTITY pgpkey.dru SYSTEM "dru.key">
<!ENTITY pgpkey.dryice SYSTEM "dryice.key">
<!ENTITY pgpkey.dteske SYSTEM "dteske.key">
<!ENTITY pgpkey.dumbbell SYSTEM "dumbbell.key">
<!ENTITY pgpkey.dutchdaemon SYSTEM "dutchdaemon.key">
<!ENTITY pgpkey.dvl SYSTEM "dvl.key">
<!ENTITY pgpkey.dwmalone SYSTEM "dwmalone.key">
<!ENTITY pgpkey.eadler SYSTEM "eadler.key">
<!ENTITY pgpkey.ebrandi SYSTEM "ebrandi.key">
<!ENTITY pgpkey.ed SYSTEM "ed.key">
<!ENTITY pgpkey.edavis SYSTEM "edavis.key">
<!ENTITY pgpkey.edwin SYSTEM "edwin.key">
<!ENTITY pgpkey.egypcio SYSTEM "egypcio.key">
<!ENTITY pgpkey.ehaupt SYSTEM "ehaupt.key">
<!ENTITY pgpkey.emaste SYSTEM "emaste.key">
<!ENTITY pgpkey.emax SYSTEM "emax.key">
<!ENTITY pgpkey.ericbsd SYSTEM "ericbsd.key">
<!ENTITY pgpkey.erj SYSTEM "erj.key">
<!ENTITY pgpkey.erwin SYSTEM "erwin.key">
<!ENTITY pgpkey.eugen SYSTEM "eugen.key">
<!ENTITY pgpkey.fabient SYSTEM "fabient.key">
<!ENTITY pgpkey.fanf SYSTEM "fanf.key">
<!ENTITY pgpkey.farrokhi SYSTEM "farrokhi.key">
<!ENTITY pgpkey.feld SYSTEM "feld.key">
<!ENTITY pgpkey.fernape SYSTEM "fernape.key">
<!ENTITY pgpkey.fjoe SYSTEM "fjoe.key">
<!ENTITY pgpkey.flo SYSTEM "flo.key">
<!ENTITY pgpkey.fluffy SYSTEM "fluffy.key">
<!ENTITY pgpkey.flz SYSTEM "flz.key">
<!ENTITY pgpkey.fox SYSTEM "fox.key">
<!ENTITY pgpkey.foxfair SYSTEM "foxfair.key">
<!ENTITY pgpkey.fsu SYSTEM "fsu.key">
<!ENTITY pgpkey.gabor SYSTEM "gabor.key">
<!ENTITY pgpkey.gad SYSTEM "gad.key">
<!ENTITY pgpkey.gahr SYSTEM "gahr.key">
<!ENTITY pgpkey.ganbold SYSTEM "ganbold.key">
<!ENTITY pgpkey.garga SYSTEM "garga.key">
<!ENTITY pgpkey.garys SYSTEM "garys.key">
<!ENTITY pgpkey.gavin SYSTEM "gavin.key">
<!ENTITY pgpkey.gblach SYSTEM "gblach.key">
<!ENTITY pgpkey.gerald SYSTEM "gerald.key">
<!ENTITY pgpkey.ghelmer SYSTEM "ghelmer.key">
<!ENTITY pgpkey.gibbs SYSTEM "gibbs.key">
<!ENTITY pgpkey.girgen SYSTEM "girgen.key">
<!ENTITY pgpkey.gjb SYSTEM "gjb.key">
<!ENTITY pgpkey.glarkin SYSTEM "glarkin.key">
<!ENTITY pgpkey.gleb SYSTEM "gleb.key">
<!ENTITY pgpkey.glebius SYSTEM "glebius.key">
<!ENTITY pgpkey.glewis SYSTEM "glewis.key">
<!ENTITY pgpkey.gnn SYSTEM "gnn.key">
<!ENTITY pgpkey.gonzo SYSTEM "gonzo.key">
<!ENTITY pgpkey.gordon SYSTEM "gordon.key">
<!ENTITY pgpkey.green SYSTEM "green.key">
<!ENTITY pgpkey.grehan SYSTEM "grehan.key">
<!ENTITY pgpkey.grembo SYSTEM "grembo.key">
<!ENTITY pgpkey.grog SYSTEM "grog.key">
<!ENTITY pgpkey.gshapiro SYSTEM "gshapiro.key">
<!ENTITY pgpkey.gsutter SYSTEM "gsutter.key">
<!ENTITY pgpkey.guido SYSTEM "guido.key">
<!ENTITY pgpkey.harti SYSTEM "harti.key">
<!ENTITY pgpkey.hiren SYSTEM "hiren.key">
<!ENTITY pgpkey.hmp SYSTEM "hmp.key">
<!ENTITY pgpkey.hq SYSTEM "hq.key">
<!ENTITY pgpkey.hrs SYSTEM "hrs.key">
<!ENTITY pgpkey.ijliao SYSTEM "ijliao.key">
<!ENTITY pgpkey.imp SYSTEM "imp.key">
<!ENTITY pgpkey.issyl0 SYSTEM "issyl0.key">
<!ENTITY pgpkey.itetcu SYSTEM "itetcu.key">
<!ENTITY pgpkey.ivadasz SYSTEM "ivadasz.key">
<!ENTITY pgpkey.ivoras SYSTEM "ivoras.key">
<!ENTITY pgpkey.jacula SYSTEM "jacula.key">
<!ENTITY pgpkey.jadawin SYSTEM "jadawin.key">
<!ENTITY pgpkey.jah SYSTEM "jah.key">
<!ENTITY pgpkey.jamie SYSTEM "jamie.key">
<!ENTITY pgpkey.jase SYSTEM "jase.key">
<!ENTITY pgpkey.jbeich SYSTEM "jbeich.key">
<!ENTITY pgpkey.jcamou SYSTEM "jcamou.key">
<!ENTITY pgpkey.jceel SYSTEM "jceel.key">
<!ENTITY pgpkey.jch SYSTEM "jch.key">
<!ENTITY pgpkey.jchandra SYSTEM "jchandra.key">
<!ENTITY pgpkey.jdp SYSTEM "jdp.key">
<!ENTITY pgpkey.jeb SYSTEM "jeb.key">
<!ENTITY pgpkey.jedgar SYSTEM "jedgar.key">
<!ENTITY pgpkey.jesper SYSTEM "jesper.key">
<!ENTITY pgpkey.jgh SYSTEM "jgh.key">
<!ENTITY pgpkey.jh SYSTEM "jh.key">
<!ENTITY pgpkey.jhale SYSTEM "jhale.key">
<!ENTITY pgpkey.jhay SYSTEM "jhay.key">
<!ENTITY pgpkey.jhb SYSTEM "jhb.key">
<!ENTITY pgpkey.jhibbits SYSTEM "jhibbits.key">
<!ENTITY pgpkey.jhixson SYSTEM "jhixson.key">
<!ENTITY pgpkey.jilles SYSTEM "jilles.key">
<!ENTITY pgpkey.jim SYSTEM "jim.key">
<!ENTITY pgpkey.jinmei SYSTEM "jinmei.key">
<!ENTITY pgpkey.jkh SYSTEM "jkh.key">
<!ENTITY pgpkey.jkim SYSTEM "jkim.key">
<!ENTITY pgpkey.jkois SYSTEM "jkois.key">
<!ENTITY pgpkey.jkoshy SYSTEM "jkoshy.key">
<!ENTITY pgpkey.jlaffaye SYSTEM "jlaffaye.key">
<!ENTITY pgpkey.jlh SYSTEM "jlh.key">
<!ENTITY pgpkey.jmb SYSTEM "jmb.key">
<!ENTITY pgpkey.jmcneill SYSTEM "jmcneill.key">
<!ENTITY pgpkey.jmd SYSTEM "jmd.key">
<!ENTITY pgpkey.jmelo SYSTEM "jmelo.key">
<!ENTITY pgpkey.jmg SYSTEM "jmg.key">
<!ENTITY pgpkey.jmmv SYSTEM "jmmv.key">
<!ENTITY pgpkey.joe SYSTEM "joe.key">
<!ENTITY pgpkey.joerg SYSTEM "joerg.key">
<!ENTITY pgpkey.johalun SYSTEM "johalun.key">
<!ENTITY pgpkey.johans SYSTEM "johans.key">
<!ENTITY pgpkey.jon SYSTEM "jon.key">
<!ENTITY pgpkey.jonathan SYSTEM "jonathan.key">
<!ENTITY pgpkey.joneum SYSTEM "joneum.key">
<!ENTITY pgpkey.josef SYSTEM "josef.key">
<!ENTITY pgpkey.jpaetzel SYSTEM "jpaetzel.key">
<!ENTITY pgpkey.jrm SYSTEM "jrm.key">
<!ENTITY pgpkey.jsa SYSTEM "jsa.key">
<!ENTITY pgpkey.jsm SYSTEM "jsm.key">
<!ENTITY pgpkey.jtl SYSTEM "jtl.key">
<!ENTITY pgpkey.junovitch SYSTEM "junovitch.key">
<!ENTITY pgpkey.jwb SYSTEM "jwb.key">
<!ENTITY pgpkey.jylefort SYSTEM "jylefort.key">
<!ENTITY pgpkey.kadesai SYSTEM "kadesai.key">
<!ENTITY pgpkey.kai SYSTEM "kai.key">
<!ENTITY pgpkey.kaiw SYSTEM "kaiw.key">
<!ENTITY pgpkey.kaktus SYSTEM "kaktus.key">
<!ENTITY pgpkey.kami SYSTEM "kami.key">
<!ENTITY pgpkey.kan SYSTEM "kan.key">
<!ENTITY pgpkey.karels SYSTEM "karels.key">
<!ENTITY pgpkey.kato SYSTEM "kato.key">
<!ENTITY pgpkey.kbowling SYSTEM "kbowling.key">
<!ENTITY pgpkey.ken SYSTEM "ken.key">
<!ENTITY pgpkey.kensmith SYSTEM "kensmith.key">
<!ENTITY pgpkey.keramida SYSTEM "keramida.key">
<!ENTITY pgpkey.kevans SYSTEM "kevans.key">
<!ENTITY pgpkey.kevlo SYSTEM "kevlo.key">
<!ENTITY pgpkey.keymaster SYSTEM "keymaster.key">
<!ENTITY pgpkey.kib SYSTEM "kib.key">
<!ENTITY pgpkey.kibab SYSTEM "kibab.key">
<!ENTITY pgpkey.kmoore SYSTEM "kmoore.key">
<!ENTITY pgpkey.knu SYSTEM "knu.key">
<!ENTITY pgpkey.koitsu SYSTEM "koitsu.key">
<!ENTITY pgpkey.kp SYSTEM "kp.key">
<!ENTITY pgpkey.krion SYSTEM "krion.key">
<!ENTITY pgpkey.kris SYSTEM "kris.key">
<!ENTITY pgpkey.kuriyama SYSTEM "kuriyama.key">
<!ENTITY pgpkey.kwm SYSTEM "kwm.key">
<!ENTITY pgpkey.landonf SYSTEM "landonf.key">
<!ENTITY pgpkey.laszlof SYSTEM "laszlof.key">
<!ENTITY pgpkey.lawrance SYSTEM "lawrance.key">
<!ENTITY pgpkey.lbr SYSTEM "lbr.key">
<!ENTITY pgpkey.le SYSTEM "le.key">
<!ENTITY pgpkey.leeym SYSTEM "leeym.key">
<!ENTITY pgpkey.leitao SYSTEM "leitao.key">
<!ENTITY pgpkey.ler SYSTEM "ler.key">
<!ENTITY pgpkey.leres SYSTEM "leres.key">
<!ENTITY pgpkey.lesi SYSTEM "lesi.key">
<!ENTITY pgpkey.lev SYSTEM "lev.key">
<!ENTITY pgpkey.lidl SYSTEM "lidl.key">
<!ENTITY pgpkey.lifanov SYSTEM "lifanov.key">
<!ENTITY pgpkey.linimon SYSTEM "linimon.key">
<!ENTITY pgpkey.lioux SYSTEM "lioux.key">
<!ENTITY pgpkey.lippe SYSTEM "lippe.key">
<!ENTITY pgpkey.lme SYSTEM "lme.key">
<!ENTITY pgpkey.loader SYSTEM "loader.key">
<!ENTITY pgpkey.lofi SYSTEM "lofi.key">
<!ENTITY pgpkey.loos SYSTEM "loos.key">
<!ENTITY pgpkey.lstewart SYSTEM "lstewart.key">
<!ENTITY pgpkey.lth SYSTEM "lth.key">
<!ENTITY pgpkey.lulf SYSTEM "lulf.key">
<!ENTITY pgpkey.luoqi SYSTEM "luoqi.key">
<!ENTITY pgpkey.luporl SYSTEM "luporl.key">
<!ENTITY pgpkey.lwhsu SYSTEM "lwhsu.key">
<!ENTITY pgpkey.lx SYSTEM "lx.key">
<!ENTITY pgpkey.madpilot SYSTEM "madpilot.key">
<!ENTITY pgpkey.maho SYSTEM "maho.key">
<!ENTITY pgpkey.mahrens SYSTEM "mahrens.key">
<!ENTITY pgpkey.makc SYSTEM "makc.key">
<!ENTITY pgpkey.mandree SYSTEM "mandree.key">
<!ENTITY pgpkey.manolis SYSTEM "manolis.key">
<!ENTITY pgpkey.manu SYSTEM "manu.key">
<!ENTITY pgpkey.marcel SYSTEM "marcel.key">
<!ENTITY pgpkey.marck SYSTEM "marck.key">
<!ENTITY pgpkey.marcus SYSTEM "marcus.key">
<!ENTITY pgpkey.marino SYSTEM "marino.key">
<!ENTITY pgpkey.marius SYSTEM "marius.key">
<!ENTITY pgpkey.markj SYSTEM "markj.key">
<!ENTITY pgpkey.markm SYSTEM "markm.key">
<!ENTITY pgpkey.markp SYSTEM "markp.key">
<!ENTITY pgpkey.marks SYSTEM "marks.key">
<!ENTITY pgpkey.markus SYSTEM "markus.key">
<!ENTITY pgpkey.martymac SYSTEM "martymac.key">
<!ENTITY pgpkey.mat SYSTEM "mat.key">
<!ENTITY pgpkey.matteo SYSTEM "matteo.key">
<!ENTITY pgpkey.matthew SYSTEM "matthew.key">
<!ENTITY pgpkey.matusita SYSTEM "matusita.key">
<!ENTITY pgpkey.mav SYSTEM "mav.key">
<!ENTITY pgpkey.max SYSTEM "max.key">
<!ENTITY pgpkey.maxim SYSTEM "maxim.key">
<!ENTITY pgpkey.mbr SYSTEM "mbr.key">
<!ENTITY pgpkey.mckay SYSTEM "mckay.key">
<!ENTITY pgpkey.mckusick SYSTEM "mckusick.key">
<!ENTITY pgpkey.mdf SYSTEM "mdf.key">
<!ENTITY pgpkey.melifaro SYSTEM "melifaro.key">
<!ENTITY pgpkey.meta SYSTEM "meta.key">
<!ENTITY pgpkey.metal SYSTEM "metal.key">
<!ENTITY pgpkey.mfechner SYSTEM "mfechner.key">
<!ENTITY pgpkey.mheinen SYSTEM "mheinen.key">
<!ENTITY pgpkey.mhorne SYSTEM "mhorne.key">
<!ENTITY pgpkey.mi SYSTEM "mi.key">
<!ENTITY pgpkey.mich SYSTEM "mich.key">
<!ENTITY pgpkey.mikeh SYSTEM "mikeh.key">
<!ENTITY pgpkey.milki SYSTEM "milki.key">
<!ENTITY pgpkey.misha SYSTEM "misha.key">
<!ENTITY pgpkey.miwi SYSTEM "miwi.key">
<!ENTITY pgpkey.mizhka SYSTEM "mizhka.key">
<!ENTITY pgpkey.mjg SYSTEM "mjg.key">
<!ENTITY pgpkey.mjoras SYSTEM "mjoras.key">
<!ENTITY pgpkey.mlaier SYSTEM "mlaier.key">
<!ENTITY pgpkey.mm SYSTEM "mm.key">
<!ENTITY pgpkey.mmel SYSTEM "mmel.key">
<!ENTITY pgpkey.mmokhi SYSTEM "mmokhi.key">
<!ENTITY pgpkey.mmoll SYSTEM "mmoll.key">
<!ENTITY pgpkey.mnag SYSTEM "mnag.key">
<!ENTITY pgpkey.mp SYSTEM "mp.key">
<!ENTITY pgpkey.mr SYSTEM "mr.key">
<!ENTITY pgpkey.mtm SYSTEM "mtm.key">
<!ENTITY pgpkey.murray SYSTEM "murray.key">
<!ENTITY pgpkey.mux SYSTEM "mux.key">
<!ENTITY pgpkey.mva SYSTEM "mva.key">
<!ENTITY pgpkey.mw SYSTEM "mw.key">
<!ENTITY pgpkey.mwlucas SYSTEM "mwlucas.key">
<!ENTITY pgpkey.naddy SYSTEM "naddy.key">
<!ENTITY pgpkey.nate SYSTEM "nate.key">
<!ENTITY pgpkey.nectar SYSTEM "nectar.key">
<!ENTITY pgpkey.neel SYSTEM "neel.key">
<!ENTITY pgpkey.nemoliu SYSTEM "nemoliu.key">
<!ENTITY pgpkey.nemysis SYSTEM "nemysis.key">
<!ENTITY pgpkey.netchild SYSTEM "netchild.key">
<!ENTITY pgpkey.ngie SYSTEM "ngie.key">
<!ENTITY pgpkey.niels SYSTEM "niels.key">
<!ENTITY pgpkey.nik SYSTEM "nik.key">
<!ENTITY pgpkey.niklas SYSTEM "niklas.key">
<!ENTITY pgpkey.nivit SYSTEM "nivit.key">
<!ENTITY pgpkey.njl SYSTEM "njl.key">
<!ENTITY pgpkey.nork SYSTEM "nork.key">
<!ENTITY pgpkey.novel SYSTEM "novel.key">
<!ENTITY pgpkey.nox SYSTEM "nox.key">
<!ENTITY pgpkey.np SYSTEM "np.key">
<!ENTITY pgpkey.nsouch SYSTEM "nsouch.key">
<!ENTITY pgpkey.nwhitehorn SYSTEM "nwhitehorn.key">
<!ENTITY pgpkey.nyan SYSTEM "nyan.key">
<!ENTITY pgpkey.obraun SYSTEM "obraun.key">
<!ENTITY pgpkey.obrien SYSTEM "obrien.key">
<!ENTITY pgpkey.ohauer SYSTEM "ohauer.key">
<!ENTITY pgpkey.oleg SYSTEM "oleg.key">
<!ENTITY pgpkey.olgeni SYSTEM "olgeni.key">
<!ENTITY pgpkey.oliver SYSTEM "oliver.key">
<!ENTITY pgpkey.olivier SYSTEM "olivier.key">
<!ENTITY pgpkey.olivierd SYSTEM "olivierd.key">
<!ENTITY pgpkey.oshogbo SYSTEM "oshogbo.key">
<!ENTITY pgpkey.patrick SYSTEM "patrick.key">
<!ENTITY pgpkey.paul SYSTEM "paul.key">
<!ENTITY pgpkey.pav SYSTEM "pav.key">
<!ENTITY pgpkey.pclin SYSTEM "pclin.key">
<!ENTITY pgpkey.peadar SYSTEM "peadar.key">
<!ENTITY pgpkey.perky SYSTEM "perky.key">
<!ENTITY pgpkey.petef SYSTEM "petef.key">
<!ENTITY pgpkey.peter SYSTEM "peter.key">
<!ENTITY pgpkey.peterj SYSTEM "peterj.key">
<!ENTITY pgpkey.pfg SYSTEM "pfg.key">
<!ENTITY pgpkey.pgj SYSTEM "pgj.key">
<!ENTITY pgpkey.pgollucci SYSTEM "pgollucci.key">
<!ENTITY pgpkey.phantom SYSTEM "phantom.key">
<!ENTITY pgpkey.phil SYSTEM "phil.key">
<!ENTITY pgpkey.philip SYSTEM "philip.key">
<!ENTITY pgpkey.phk SYSTEM "phk.key">
<!ENTITY pgpkey.pho SYSTEM "pho.key">
<!ENTITY pgpkey.pi SYSTEM "pi.key">
<!ENTITY pgpkey.pirzyk SYSTEM "pirzyk.key">
<!ENTITY pgpkey.pizzamig SYSTEM "pizzamig.key">
<!ENTITY pgpkey.pjd SYSTEM "pjd.key">
<!ENTITY pgpkey.pkelsey SYSTEM "pkelsey.key">
<!ENTITY pgpkey.pkubaj SYSTEM "pkubaj.key">
<!ENTITY pgpkey.plosher SYSTEM "plosher.key">
<!ENTITY pgpkey.pluknet SYSTEM "pluknet.key">
<!ENTITY pgpkey.portmgr-secretary SYSTEM "portmgr-secretary.key">
<!ENTITY pgpkey.pstef SYSTEM "pstef.key">
<!ENTITY pgpkey.qingli SYSTEM "qingli.key">
<!ENTITY pgpkey.rafan SYSTEM "rafan.key">
<!ENTITY pgpkey.rakuco SYSTEM "rakuco.key">
<!ENTITY pgpkey.ram SYSTEM "ram.key">
<!ENTITY pgpkey.ray SYSTEM "ray.key">
<!ENTITY pgpkey.rcyu SYSTEM "rcyu.key">
<!ENTITY pgpkey.rdivacky SYSTEM "rdivacky.key">
<!ENTITY pgpkey.rea SYSTEM "rea.key">
<!ENTITY pgpkey.rees SYSTEM "rees.key">
<!ENTITY pgpkey.remko SYSTEM "remko.key">
<!ENTITY pgpkey.rene SYSTEM "rene.key">
<!ENTITY pgpkey.rezny SYSTEM "rezny.key">
<!ENTITY pgpkey.rgrimes SYSTEM "rgrimes.key">
<!ENTITY pgpkey.rich SYSTEM "rich.key">
<!ENTITY pgpkey.riggs SYSTEM "riggs.key">
<!ENTITY pgpkey.rigoletto SYSTEM "rigoletto.key">
<!ENTITY pgpkey.rik SYSTEM "rik.key">
<!ENTITY pgpkey.rink SYSTEM "rink.key">
<!ENTITY pgpkey.rlibby SYSTEM "rlibby.key">
<!ENTITY pgpkey.rm SYSTEM "rm.key">
<!ENTITY pgpkey.rmacklem SYSTEM "rmacklem.key">
<!ENTITY pgpkey.rmh SYSTEM "rmh.key">
<!ENTITY pgpkey.rnoland SYSTEM "rnoland.key">
<!ENTITY pgpkey.roam SYSTEM "roam.key">
<!ENTITY pgpkey.robak SYSTEM "robak.key">
<!ENTITY pgpkey.roberto SYSTEM "roberto.key">
<!ENTITY pgpkey.rodrigc SYSTEM "rodrigc.key">
<!ENTITY pgpkey.rodrigo SYSTEM "rodrigo.key">
<!ENTITY pgpkey.romain SYSTEM "romain.key">
<!ENTITY pgpkey.royger SYSTEM "royger.key">
<!ENTITY pgpkey.rpaulo SYSTEM "rpaulo.key">
<!ENTITY pgpkey.rpokala SYSTEM "rpokala.key">
<!ENTITY pgpkey.rrs SYSTEM "rrs.key">
<!ENTITY pgpkey.rstone SYSTEM "rstone.key">
<!ENTITY pgpkey.ru SYSTEM "ru.key">
<!ENTITY pgpkey.rushani SYSTEM "rushani.key">
<!ENTITY pgpkey.ryusuke SYSTEM "ryusuke.key">
<!ENTITY pgpkey.sahil SYSTEM "sahil.key">
<!ENTITY pgpkey.sam SYSTEM "sam.key">
<!ENTITY pgpkey.samm SYSTEM "samm.key">
<!ENTITY pgpkey.sanpei SYSTEM "sanpei.key">
<!ENTITY pgpkey.sat SYSTEM "sat.key">
<!ENTITY pgpkey.sbruno SYSTEM "sbruno.key">
<!ENTITY pgpkey.sbz SYSTEM "sbz.key">
<!ENTITY pgpkey.scheidell SYSTEM "scheidell.key">
<!ENTITY pgpkey.schweikh SYSTEM "schweikh.key">
<!ENTITY pgpkey.scop SYSTEM "scop.key">
<!ENTITY pgpkey.scottl SYSTEM "scottl.key">
<!ENTITY pgpkey.scottph SYSTEM "scottph.key">
<!ENTITY pgpkey.se SYSTEM "se.key">
<!ENTITY pgpkey.seanc SYSTEM "seanc.key">
<!ENTITY pgpkey.secteam-secretary SYSTEM "secteam-secretary.key">
<!ENTITY pgpkey.security-officer SYSTEM "security-officer.key">
<!ENTITY pgpkey.sef SYSTEM "sef.key">
<!ENTITY pgpkey.sem SYSTEM "sem.key">
<!ENTITY pgpkey.sephe SYSTEM "sephe.key">
<!ENTITY pgpkey.sepotvin SYSTEM "sepotvin.key">
<!ENTITY pgpkey.sergei SYSTEM "sergei.key">
<!ENTITY pgpkey.sevan SYSTEM "sevan.key">
<!ENTITY pgpkey.sg SYSTEM "sg.key">
<!ENTITY pgpkey.sgalabov SYSTEM "sgalabov.key">
<!ENTITY pgpkey.shaun SYSTEM "shaun.key">
<!ENTITY pgpkey.sheldonh SYSTEM "sheldonh.key">
<!ENTITY pgpkey.shurd SYSTEM "shurd.key">
<!ENTITY pgpkey.simon SYSTEM "simon.key">
<!ENTITY pgpkey.sjg SYSTEM "sjg.key">
<!ENTITY pgpkey.skra SYSTEM "skra.key">
<!ENTITY pgpkey.skreuzer SYSTEM "skreuzer.key">
<!ENTITY pgpkey.slavash SYSTEM "slavash.key">
<!ENTITY pgpkey.slm SYSTEM "slm.key">
<!ENTITY pgpkey.snb SYSTEM "snb.key">
<!ENTITY pgpkey.sobomax SYSTEM "sobomax.key">
<!ENTITY pgpkey.sson SYSTEM "sson.key">
<!ENTITY pgpkey.ssouhlal SYSTEM "ssouhlal.key">
<!ENTITY pgpkey.stas SYSTEM "stas.key">
<!ENTITY pgpkey.stefan SYSTEM "stefan.key">
<!ENTITY pgpkey.stefanf SYSTEM "stefanf.key">
<!ENTITY pgpkey.stephane SYSTEM "stephane.key">
<!ENTITY pgpkey.stephen SYSTEM "stephen.key">
<!ENTITY pgpkey.stevek SYSTEM "stevek.key">
<!ENTITY pgpkey.sunpoet SYSTEM "sunpoet.key">
<!ENTITY pgpkey.swills SYSTEM "swills.key">
<!ENTITY pgpkey.sylvio SYSTEM "sylvio.key">
<!ENTITY pgpkey.syrinx SYSTEM "syrinx.key">
<!ENTITY pgpkey.syuu SYSTEM "syuu.key">
<!ENTITY pgpkey.tabthorpe SYSTEM "tabthorpe.key">
<!ENTITY pgpkey.taras SYSTEM "taras.key">
<!ENTITY pgpkey.tcberner SYSTEM "tcberner.key">
<!ENTITY pgpkey.tdb SYSTEM "tdb.key">
<!ENTITY pgpkey.theraven SYSTEM "theraven.key">
<!ENTITY pgpkey.thierry SYSTEM "thierry.key">
<!ENTITY pgpkey.thj SYSTEM "thj.key">
<!ENTITY pgpkey.thomas SYSTEM "thomas.key">
<!ENTITY pgpkey.thompsa SYSTEM "thompsa.key">
<!ENTITY pgpkey.tijl SYSTEM "tijl.key">
<!ENTITY pgpkey.timur SYSTEM "timur.key">
<!ENTITY pgpkey.tj SYSTEM "tj.key">
<!ENTITY pgpkey.tmclaugh SYSTEM "tmclaugh.key">
<!ENTITY pgpkey.tmm SYSTEM "tmm.key">
<!ENTITY pgpkey.tmseck SYSTEM "tmseck.key">
<!ENTITY pgpkey.tmunro SYSTEM "tmunro.key">
<!ENTITY pgpkey.tobez SYSTEM "tobez.key">
<!ENTITY pgpkey.tobik SYSTEM "tobik.key">
<!ENTITY pgpkey.tota SYSTEM "tota.key">
<!ENTITY pgpkey.trasz SYSTEM "trasz.key">
<!ENTITY pgpkey.trevor SYSTEM "trevor.key">
<!ENTITY pgpkey.trhodes SYSTEM "trhodes.key">
<!ENTITY pgpkey.trociny SYSTEM "trociny.key">
<!ENTITY pgpkey.truckman SYSTEM "truckman.key">
<!ENTITY pgpkey.tsoome SYSTEM "tsoome.key">
<!ENTITY pgpkey.tuexen SYSTEM "tuexen.key">
<!ENTITY pgpkey.twinterg SYSTEM "twinterg.key">
<!ENTITY pgpkey.tz SYSTEM "tz.key">
<!ENTITY pgpkey.ue SYSTEM "ue.key">
<!ENTITY pgpkey.ultima SYSTEM "ultima.key">
<!ENTITY pgpkey.ume SYSTEM "ume.key">
<!ENTITY pgpkey.ups SYSTEM "ups.key">
<!ENTITY pgpkey.uqs SYSTEM "uqs.key">
<!ENTITY pgpkey.vangyzen SYSTEM "vangyzen.key">
<!ENTITY pgpkey.vanilla SYSTEM "vanilla.key">
<!ENTITY pgpkey.vd SYSTEM "vd.key">
<!ENTITY pgpkey.versus SYSTEM "versus.key">
<!ENTITY pgpkey.vg SYSTEM "vg.key">
<!ENTITY pgpkey.viny SYSTEM "viny.key">
<!ENTITY pgpkey.vkashyap SYSTEM "vkashyap.key">
<!ENTITY pgpkey.vmaffione SYSTEM "vmaffione.key">
<!ENTITY pgpkey.vs SYSTEM "vs.key">
<!ENTITY pgpkey.vsevolod SYSTEM "vsevolod.key">
<!ENTITY pgpkey.wblock SYSTEM "wblock.key">
<!ENTITY pgpkey.wen SYSTEM "wen.key">
<!ENTITY pgpkey.weongyo SYSTEM "weongyo.key">
<!ENTITY pgpkey.wes SYSTEM "wes.key">
<!ENTITY pgpkey.wg SYSTEM "wg.key">
<!ENTITY pgpkey.whu SYSTEM "whu.key">
<!ENTITY pgpkey.wilko SYSTEM "wilko.key">
<!ENTITY pgpkey.will SYSTEM "will.key">
<!ENTITY pgpkey.wkoszek SYSTEM "wkoszek.key">
<!ENTITY pgpkey.wma SYSTEM "wma.key">
<!ENTITY pgpkey.wollman SYSTEM "wollman.key">
<!ENTITY pgpkey.woodsb02 SYSTEM "woodsb02.key">
<!ENTITY pgpkey.wosch SYSTEM "wosch.key">
<!ENTITY pgpkey.wulf SYSTEM "wulf.key">
<!ENTITY pgpkey.wxs SYSTEM "wxs.key">
<!ENTITY pgpkey.xmj SYSTEM "xmj.key">
<!ENTITY pgpkey.xride SYSTEM "xride.key">
<!ENTITY pgpkey.ygy SYSTEM "ygy.key">
<!ENTITY pgpkey.yoichi SYSTEM "yoichi.key">
<!ENTITY pgpkey.yongari SYSTEM "yongari.key">
<!ENTITY pgpkey.yuri SYSTEM "yuri.key">
<!ENTITY pgpkey.yuripv SYSTEM "yuripv.key">
<!ENTITY pgpkey.yzlin SYSTEM "yzlin.key">
<!ENTITY pgpkey.zack SYSTEM "zack.key">
<!ENTITY pgpkey.zbb SYSTEM "zbb.key">
<!ENTITY pgpkey.zeising SYSTEM "zeising.key">
<!ENTITY pgpkey.zi SYSTEM "zi.key">
<!ENTITY pgpkey.zml SYSTEM "zml.key">
<!ENTITY pgpkey.zont SYSTEM "zont.key">
<!ENTITY section.pgpkeys-core SYSTEM "pgpkeys-core.xml">
<!ENTITY section.pgpkeys-developers SYSTEM "pgpkeys-developers.xml">
<!ENTITY section.pgpkeys-officers SYSTEM "pgpkeys-officers.xml">
<!ENTITY section.pgpkeys-other SYSTEM "pgpkeys-other.xml">
<!-- Part One --><!ENTITY chap.introduction SYSTEM "introduction/chapter.xml">
<!ENTITY chap.bsdinstall SYSTEM "bsdinstall/chapter.xml">
<!ENTITY chap.basics SYSTEM "basics/chapter.xml">
<!ENTITY chap.ports SYSTEM "ports/chapter.xml">
<!ENTITY chap.x11 SYSTEM "x11/chapter.xml">
<!-- Part Two --><!ENTITY chap.desktop SYSTEM "desktop/chapter.xml">
<!ENTITY chap.multimedia SYSTEM "multimedia/chapter.xml">
<!ENTITY chap.kernelconfig SYSTEM "kernelconfig/chapter.xml">
<!ENTITY chap.printing SYSTEM "printing/chapter.xml">
<!ENTITY chap.linuxemu SYSTEM "linuxemu/chapter.xml">
<!-- Part Three --><!ENTITY chap.config SYSTEM "config/chapter.xml">
<!ENTITY chap.boot SYSTEM "boot/chapter.xml">
<!ENTITY chap.security SYSTEM "security/chapter.xml">
<!ENTITY chap.jails SYSTEM "jails/chapter.xml">
<!ENTITY chap.mac SYSTEM "mac/chapter.xml">
<!ENTITY chap.audit SYSTEM "audit/chapter.xml">
<!ENTITY chap.disks SYSTEM "disks/chapter.xml">
<!ENTITY chap.geom SYSTEM "geom/chapter.xml">
<!ENTITY chap.zfs SYSTEM "zfs/chapter.xml">
<!ENTITY chap.filesystems SYSTEM "filesystems/chapter.xml">
<!ENTITY chap.virtualization SYSTEM "virtualization/chapter.xml">
<!ENTITY chap.l10n SYSTEM "l10n/chapter.xml">
<!ENTITY chap.cutting-edge SYSTEM "cutting-edge/chapter.xml">
<!ENTITY chap.dtrace SYSTEM "dtrace/chapter.xml">
<!ENTITY chap.usb-device-mode SYSTEM "usb-device-mode/chapter.xml">
<!-- Part Four --><!ENTITY chap.serialcomms SYSTEM "serialcomms/chapter.xml">
<!ENTITY chap.ppp-and-slip SYSTEM "ppp-and-slip/chapter.xml">
<!ENTITY chap.mail SYSTEM "mail/chapter.xml">
<!ENTITY chap.network-servers SYSTEM "network-servers/chapter.xml">
<!ENTITY chap.firewalls SYSTEM "firewalls/chapter.xml">
<!ENTITY chap.advanced-networking SYSTEM "advanced-networking/chapter.xml">
<!-- Part Five (appendices) --><!ENTITY chap.mirrors SYSTEM "mirrors/chapter.xml">
<!ENTITY chap.mirrors.lastmod.inc SYSTEM "mirrors.lastmod.inc">
<!ENTITY chap.mirrors.ftp.index.inc SYSTEM "mirrors.xml.ftp.index.inc">
<!ENTITY chap.mirrors.ftp.inc SYSTEM "mirrors.xml.ftp.inc">
<!ENTITY chap.bibliography SYSTEM "bibliography/chapter.xml">
<!ENTITY chap.eresources SYSTEM "eresources/chapter.xml">
<!ENTITY chap.eresources.www.index.inc SYSTEM "eresources.xml.www.index.inc">
<!ENTITY chap.eresources.www.inc SYSTEM "eresources.xml.www.inc">
<!ENTITY chap.pgpkeys SYSTEM "pgpkeys/chapter.xml">
<!ENTITY chap.freebsd-glossary SYSTEM "../../share/xml/glossary.ent">
<!ENTITY chap.index "<index xmlns='http://docbook.org/ns/docbook'/>">
<!ENTITY chap.colophon SYSTEM "colophon.xml">
<!ENTITY % txtfiles SYSTEM "txtfiles.ent">
<!--
     Creates entities for each .txt screenshot that is included in the
     Handbook.

     Each entity is named txt.dir.foo, where dir is the directory in
     which it is stored, and foo is its filename, without the '.txt'
     extension.

     Entities should be listed in alphabetical order.

     $FreeBSD$
-->]>
<book xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:its="http://www.w3.org/2005/11/its" version="5.0" xml:lang="zh_TW">

  <info>
    <its:rules xmlns:db="http://docbook.org/ns/docbook" version="1.0">

      <its:translateRule translate="no" selector="//db:programlisting[@role='pgpfingerprint']"/>

      <its:translateRule translate="no" selector="//db:programlisting[@role='pgpkey']"/>

      <its:translateRule translate="no" selector="//db:sect2[starts-with(@xml:id,'pgpkey-')]"/>
    </its:rules>

    <title>FreeBSD 使用手冊</title>

    <author><orgname>FreeBSD 文件計劃</orgname></author>

    <pubdate its:translate="no">$FreeBSD$</pubdate>

    <releaseinfo its:translate="no">$FreeBSD$</releaseinfo>

    <copyright xml:lang="en">
      <year>1995</year>
      <year>1996</year>
      <year>1997</year>
      <year>1998</year>
      <year>1999</year>
      <year>2000</year>
      <year>2001</year>
      <year>2002</year>
      <year>2003</year>
      <year>2004</year>
      <year>2005</year>
      <year>2006</year>
      <year>2007</year>
      <year>2008</year>
      <year>2009</year>
      <year>2010</year>
      <year>2011</year>
      <year>2012</year>
      <year>2013</year>
      <year>2014</year>
      <year>2015</year>
      <year>2016</year>
      <year>2017</year>
      <year>2018</year>
      <year>2019</year>
      <holder>The FreeBSD Documentation Project</holder>
    </copyright>

    
<legalnotice xml:id="legalnotice">
  <title>版權</title>

  <para xml:lang="en">Redistribution and use in source (XML DocBook) and 'compiled'
    forms (XML, HTML, PDF, PostScript, RTF and so forth) with or without
    modification, are permitted provided that the following conditions are
    met:</para>

  <orderedlist>
    <listitem>
      <para xml:lang="en">Redistributions of source code (XML DocBook) must retain the
        above copyright notice, this list of conditions and the following
        disclaimer as the first lines of this file unmodified.</para>
    </listitem>

    <listitem>
      <para xml:lang="en">Redistributions in compiled form (transformed to other DTDs,
        converted to PDF, PostScript, RTF and other formats) must
        reproduce the above copyright notice, this list of conditions and
        the following disclaimer in the documentation and/or other
        materials provided with the distribution.</para>
    </listitem>
  </orderedlist>

  <important>
    <para xml:lang="en">THIS DOCUMENTATION IS PROVIDED BY THE FREEBSD DOCUMENTATION
      PROJECT "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING,
      BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
      FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL
      THE FREEBSD DOCUMENTATION PROJECT BE LIABLE FOR ANY DIRECT, INDIRECT,
      INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
      BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS
      OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
      ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
      TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
      USE OF THIS DOCUMENTATION, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
      DAMAGE.</para>
  </important>
</legalnotice>


    <legalnotice xml:id="trademarks" role="trademarks">
      <para>FreeBSD 是 FreeBSD 基金會的註冊商標。</para>
      <para>3Com 和 HomeConnect 是 3Com Corporation 的註冊商標。</para>
      <para>3ware 是 3ware Inc 的註冊商標。</para>
      <para>ARM 是 ARM Limited. 的註冊商標。</para>
      <para>Adaptec 是 Adaptec, Inc. 的註冊商標。</para>
      <para>Adobe, Acrobat, Acrobat Reader, Flash 以及 PostScript 是 Adobe Systems Incorporated 在美國和/或其他國家的商標或註冊商標。</para>
      <para>Apple, AirPort, FireWire, iMac, iPhone, iPad, Mac, Macintosh, Mac OS, Quicktime 以及 TrueType 是 Apple Inc. 在美國以及其他國家的註冊商標。</para>
      <para>Android 是 Google Inc 的商標。</para>
      <para>Heidelberg, Helvetica, Palatino 以及 Times Roman 是 Heidelberger Druckmaschinen AG 在美國以及其他國家的商標或註冊商標。</para>
      <para>IBM, AIX, OS/2, PowerPC, PS/2, S/390 以及 ThinkPad 是 International Business Machines Corporation 在美國和其他國家的商標。</para>
      <para>IEEE, POSIX 以及 802 是 Institute of Electrical and Electronics Engineers, Inc. 在美國的註冊商標。</para>
      <para>Intel, Celeron, Centrino, Core, EtherExpress, i386, i486, Itanium, Pentium 以及 Xeon 是 Intel Corporation 及其分支機構在美國和其他國家的商標或註冊商標。</para>
      <para>Intuit 和 Quicken 是 Intuit Inc., 或其子公司在美國和其他國家的商標或註冊商標。</para>
      <para>Linux 是 Linus Torvalds 的註冊商標。</para>
      <para>LSI Logic, AcceleRAID, eXtremeRAID, MegaRAID 以及 Mylex 是 LSI Logic Corp 的商標或註冊商標。</para>
      <para>Microsoft, IntelliMouse, MS-DOS, Outlook, Windows, Windows Media 以及 Windows NT 是 Microsoft Corporation 在美國和/或其他國家的商標或註冊商標。</para>
      <para>Motif, OSF/1 以及 UNIX 是 The Open Group 在美國和其他國家的註冊商標； IT DialTone 和 The Open Group 是其商標。</para>
      <para>Oracle 是 Oracle Corporation 的註冊商標。</para>
      <para>RealNetworks, RealPlayer, 和 RealAudio 是 RealNetworks, Inc. 的註冊商標。</para>
      <para>Red Hat, RPM, 是 Red Hat, Inc. 在美國和其他國家的註冊商標。</para>
      <para>Sun, Sun Microsystems, Java, Java Virtual Machine, JDK, JRE, JSP, JVM, Netra, OpenJDK, Solaris, StarOffice, SunOS 以及 VirtualBox 是 Sun Microsystems, Inc. 在美國和其他國家的商標或註冊商標。</para>
      <para>MATLAB 是 The MathWorks, Inc. 的註冊商標。</para>
      <para>SpeedTouch 是 Thomson 的商標。</para>
      <para>VMware 是 VMware, Inc. 的商標。</para>
      <para>Mathematica 是 Wolfram Research, Inc 的註冊商標。</para>
      <para>XFree86 是 The XFree86 Project, Inc 的商標。</para>
      <para>Ogg Vorbis 以及 Xiph.Org 是 Xiph.Org 的商標。</para>
      <para>許多製造商和經銷商使用一些稱為商標的圖案或文字設計來區別自己的產品。 本文件中出現的眾多商標，以及 FreeBSD Project 本身廣所人知的商標，後面將以 <quote>™</quote> 或 <quote>®</quote> 符號來標示。</para>
    </legalnotice>

    <abstract>
      <para>歡迎使用 FreeBSD！ 本使用手冊涵蓋範圍包括了 <emphasis>FreeBSD 12.0-RELEASE</emphasis> 與 <emphasis>FreeBSD 11.3-RELEASE</emphasis> 的安裝與平日操作的說明。 這份使用手冊是很多人的集體創作，而且仍然『持續不斷』的進行中，因此部份章節可能尚未仍未完成，如果您有興趣協助本計畫的話，請寄電子郵件至 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-doc">FreeBSD 文件專案郵遞論壇</link>。</para>

      <para>在 <link xlink:href="https://www.FreeBSD.org/">FreeBSD 網站</link> 可以找到本手冊的最新版本，舊版文件可從 <uri xlink:href="https://docs.FreeBSD.org/doc/">https://docs.FreeBSD.org/doc/</uri> 取得。本文件也提供各種格式與不同壓縮方式的版本可自 <link xlink:href="https://download.freebsd.org/ftp/doc/">FreeBSD FTP 伺服器</link> 或是其中一個 <link linkend="mirrors-ftp">鏡像網站</link> 下載。 列印出來的實體書面資料可在 <link xlink:href="https://www.freebsdmall.com/">FreeBSD 商城</link> 購買。 此外，您可在 <link xlink:href="@@URL_RELPREFIX@@/search/index.html">搜尋頁面</link> 中搜尋本文件或其他文件的資料。</para>
    </abstract>
  </info>

  
<!--
     $FreeBSD$
-->
<preface version="5.0" xml:id="book-preface">
  <title>序</title>

  <bridgehead xml:id="preface-audience" renderas="sect1">給讀者的話</bridgehead>

  <para>若您是第一次接觸 FreeBSD 的新手，可以在本書第一部分找到 FreeBSD 的安裝程序，同時會逐步介紹 <trademark class="registered">UNIX</trademark> 的基礎概念與一些常用、共通的東西。而閱讀這部分並不難，只需要您有探索的精神和接受新概念。</para>

  <para>讀完這些之後，手冊中的第二部分花很長篇幅介紹的各種廣泛主題，相當值得系統管理者去注意。 在閱讀這些章節的內容時所需要的背景知識，都註釋在該章的大綱裡面，若不熟的話，可在閱讀前先預習一番。</para>

  <para>延伸閱讀方面，可參閱 <xref linkend="bibliography"/>。</para>

  <bridgehead xml:id="preface-changes-from3" renderas="sect1">自第三版後的主要修訂</bridgehead>

  <para>您目前看到的這本手冊代表著上百位貢獻者歷時 10 年所累積的心血之作。以下為自 2014 年發佈的兩冊第三版後所做的主要修訂：</para>

  <itemizedlist>
    <listitem>
      <para><xref linkend="dtrace"/> 增加說明有關強大的 DTrace 效能分析工具的資訊。</para>
    </listitem>

    <listitem>
      <para><xref linkend="filesystems"/> 增加有關 FreeBSD 非原生檔案系統的資訊，如：來自 <trademark>Sun</trademark> 的 ZSF。</para>
    </listitem>

    <listitem>
      <para><xref linkend="audit"/> 增加的內容涵蓋 FreeBSD 的新稽查功能及其使用說明。</para>
    </listitem>

    <listitem>
      <para><xref linkend="virtualization"/> 增加有關在虛擬化軟體安裝 FreeBSD  的資訊。</para>
    </listitem>

    <listitem>
      <para><xref linkend="bsdinstall"/> 增加的內容涵蓋使用新安裝工具 <application>bsdinstall</application> 來安裝 FreeBSD。</para>
    </listitem>
  </itemizedlist>

  <bridgehead xml:id="preface-changes-from2" renderas="sect1">自第二版後的主要修訂 (2004)</bridgehead>

  <para>您目前看到的這本手冊第三版是 FreeBSD 文件計劃的成員歷時兩年完成的心血之作。因文件內容成長到一定大小，印刷版需要分成兩冊發佈。新版的主要修訂部分如下：</para>

  <itemizedlist>
    <listitem>
      <para><xref linkend="config-tuning"/> 已針對新內容作更新，如：ACPI 電源管理、<command>cron</command> 以及其他更多的核心調校選項說明內容。</para>
    </listitem>

    <listitem>
      <para><xref linkend="security"/> 增加了虛擬私人網路 (VPN)、檔案系統的存取控制 (ACL)，以及安全報告。</para>
    </listitem>

    <listitem>
      <para><xref linkend="mac"/> 是此版本新增的章節。該章介紹：什麼是 MAC 機制？以及如何運用它來使您的 FreeBSD 系統更安全。</para>
    </listitem>

    <listitem>
      <para><xref linkend="disks"/> 新增了像是：USB 隨身碟、檔案系統快照 (Snapshot)、檔案系統配額 (Quota) 、檔案與網路為基礎的檔案系統、以及如何對硬碟分割區作加密等詳解。</para>
    </listitem>

    <listitem>
      <para><xref linkend="ppp-and-slip"/> 增加了疑難排解的章節。</para>
    </listitem>

    <listitem>
      <para><xref linkend="mail"/> 新增有關如何使用其它的傳輸代理程式、SMTP 認證、UUCP、<application>fetchmail</application>、<application>procmail</application> 的運用以及其它進階主題。</para>
    </listitem>

    <listitem>
      <para><xref linkend="network-servers"/> 是該版中全新的一章。這一章介紹了如何架設 <application>Apache HTTP 伺服器</application>、<application>ftpd</application> 以及用於支援 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 客戶端的 <application>Samba</application>。其中有些段落來自原先的 <xref linkend="advanced-networking"/> 。</para>
    </listitem>

    <listitem>
      <para><xref linkend="advanced-networking"/> 新增有關在 FreeBSD 中使用<trademark class="registered">藍牙</trademark>裝置、設定無線網路以及使用非同步傳輸模式 (Asynchronous Transfer Mode, ATM)  網路的介紹。</para>
    </listitem>

    <listitem>
      <para>增加詞彙表，用以說明全書中出現的術語。</para>
    </listitem>

    <listitem>
      <para>重新美編書中所列的圖表。</para>
    </listitem>
  </itemizedlist>

  <bridgehead xml:id="preface-changes" renderas="sect1">自第一版後的主要修訂 (2001)</bridgehead>

    <para>本手冊的第二版是 FreeBSD 文件計劃的成員歷時兩年完成的心血之作。第二版包的主要變動如下：</para>

<!-- Talk a little about justification and other stylesheet changes? -->

    <itemizedlist>
      <listitem>
	<para>增加完整的目錄索引。</para>
      </listitem>

      <listitem>
	<para>所有的 ASCII 圖表均改成圖檔格式的圖表。</para>
      </listitem>

      <listitem>
	<para>每個章節均加入概述，以便快速的瀏覽該章節內容摘要、讀者所欲了解的部分。</para>
      </listitem>

      <listitem>
	<para>內容架構重新組織成三大部分：<quote>入門</quote>、<quote>系統管理</quote> 以及 <quote>附錄</quote>。</para>
      </listitem>

      <listitem>
	<para><xref linkend="basics"/> 新增了程序、Daemon 以及信號 (Signal) 的介紹。</para>
      </listitem>

      <listitem>
	<para><xref linkend="ports"/> 新增了介紹如何管理 Binary 套件的資訊。</para>
      </listitem>

      <listitem>
	<para><xref linkend="x11"/> 經過全面改寫，著重於在 <trademark>XFree86</trademark> 4.X 上的現代桌面技術，如： <application>KDE</application> 和 <application>GNOME</application>。</para>
      </listitem>

      <listitem>
	<para><xref linkend="boot"/> 更新相關內容。</para>
      </listitem>

      <listitem>
	<para><xref linkend="disks"/> 分別以兩個章節 <quote>磁碟</quote> 與 <quote>備份</quote> 來撰寫。我們認為這樣子會比單一章節來得容易瞭解。還有關於 RAID (包含硬體、軟體 RAID) 的段落也新增上去了。</para>
      </listitem>

      <listitem>
	<para><xref linkend="serialcomms"/> 架構重新改寫，並更新至 FreeBSD 4.X/5.X 的內容。</para>
      </listitem>

      <listitem>
	<para><xref linkend="ppp-and-slip"/> 有相當程度的更新。</para>
      </listitem>

      <listitem>
	<para><xref linkend="advanced-networking"/> 加入許多新內容。</para>
      </listitem>

      <listitem>
	<para><xref linkend="mail"/> 大量新增了設定 <application>sendmail</application> 的介紹。</para>
      </listitem>

      <listitem>
	<para><xref linkend="linuxemu"/> 增加許多有關安裝 <application><trademark class="registered">Oracle</trademark></application> 以及 <application><trademark class="registered">SAP</trademark> <trademark class="registered">R/3</trademark></application> 的介紹。</para>
      </listitem>

      <listitem>
	<para>此外，第二版還新加章節，以介紹下列新主題：</para>

	<itemizedlist>
	  <listitem>
	    <para><xref linkend="config-tuning"/>。</para>
	  </listitem>

	  <listitem>
	    <para><xref linkend="multimedia"/>。</para>
	  </listitem>
	</itemizedlist>
      </listitem>
    </itemizedlist>

    <bridgehead xml:id="preface-overview" renderas="sect1">本書架構</bridgehead>

  <para>本書主要分為五大部分，第一部份<emphasis>入門</emphasis>：介紹 FreeBSD 的安裝、基本操作。 讀者可根據自己的程度，循序或者跳過一些熟悉的主題來閱讀； 第二部分<emphasis>一般作業</emphasis>：介紹 FreeBSD 常用功能，這部分可以不按順序來讀。 每章前面都會有概述，概述會描述本章節涵蓋的內容和讀者應該已知的， 這主要是讓讀者可以挑喜歡的章節閱讀； 第三部分<emphasis>系統管理</emphasis>：介紹 FreeBSD 老手所感興趣的各種主題部分； 第四部分<emphasis>網路通訊</emphasis>：則包括網路和各式伺服器主題；而第五部分則為附錄包含各種有關 FreeBSD 的資源。</para>

  <variablelist>

<!-- Part I - Introduction -->

    <varlistentry>
      <term><emphasis><xref linkend="introduction"/></emphasis></term>

      <listitem>
	<para>向新手介紹 FreeBSD。該篇說明了 FreeBSD 計劃的歷史、目標和開發模式。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="bsdinstall"/></emphasis></term>

      <listitem>
	<para>帶領使用者走一次使用 <application>bsdinstall</application> 在 FreeBSD 9.<replaceable>x</replaceable> 及之後版本的完整安裝流程。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="basics"/></emphasis></term>

      <listitem>
	<para>涵蓋 FreeBSD 作業系統的基礎指令及功能。若您熟悉 <trademark class="registered">Linux</trademark> 或其他類 UNIX® 系統，您則可跳過此章。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="ports"/></emphasis></term>

      <listitem>
	<para>涵蓋如何使用 FreeBSD 獨創的 <quote>Port 套件集</quote> 與標準 Binary 套件安裝第三方軟體。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="x11"/></emphasis></term>

      <listitem>
	<para>介紹 X Windows 系統概要及在 FreeBSD 上使用 X11，同時也會介紹常用的桌面環境如 <application>KDE</application> 與 <application>GNOME</application>。</para>
      </listitem>
    </varlistentry>

<!-- Part II Common Tasks -->

    <varlistentry>
      <term><emphasis><xref linkend="desktop"/></emphasis></term>

      <listitem>
	<para>列出一些常用的桌面應用程式，例如：網頁瀏覽器、辦工工具並介紹如何安裝這些應用程式到 FreeBSD。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="multimedia"/></emphasis></term>
      <listitem>
	<para>示範如何在您的系統設定音效及影像播放支援，同時會介紹幾個代表性的音訊及視訊應用程式。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="kernelconfig"/></emphasis></term>

      <listitem>
	<para>說明為何需要設定新的核心並會提供設定、編譯與安裝的詳細操作說明。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="printing"/></emphasis></term>

      <listitem>
	<para>介紹如何在 FreeBSD 管理印表機，包含橫幅頁面、列印帳務以及初始設定等資訊。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="linuxemu"/></emphasis></term>

      <listitem>
	<para>介紹 FreeBSD 的 <trademark class="registered">Linux</trademark> 相容性功能，同時提供許多熱門的 <trademark class="registered">Linux</trademark> 應用程式詳細的安裝操作說明，例如 <application><trademark class="registered">Oracle</trademark></application> 及 <application><trademark class="registered">Mathematica</trademark></application>。</para>
      </listitem>
    </varlistentry>

<!-- Part III - System Administration -->

    <varlistentry>
      <term><emphasis><xref linkend="config-tuning"/></emphasis></term>

      <listitem>
	<para>介紹可供系統管理者用來調校 FreeBSD 系統的可用參數來最佳化效率，同時也介紹 FreeBSD 用到的各種設定檔以及到何處尋找這些設定檔。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="boot"/></emphasis></term>

      <listitem>
	<para>介紹 FreeBSD 開機流程並說明如何使用設定選項控制開機流程。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="security"/></emphasis></term>

      <listitem>
	<para>介紹許多可讓您的  FreeBSD 系統更安全的各種工具，包含 Kerberos, IPsec 及 OpenSSH。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="jails"/></emphasis></term>

      <listitem>
	<para>介紹 Jail Framework，以及 Jail 改進那些 FreeBSD 傳統 chroot 不足的地方。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="mac"/></emphasis></term>

      <listitem>
	<para>說明什麼是強制存取控制 (Mandatory Access Control, MAC) 及這個機制如何用來確保 FreeBSD 系統的安全。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="audit"/></emphasis></term>

      <listitem>
	<para>介紹什麼事 FreeBSD 事件稽查，如何安裝與設定，以及如何檢查與監控稽查線索。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="disks"/></emphasis></term>

      <listitem>
	<para>介紹如何在 FreeBSD 管理儲存媒體及檔案系統，這包含了實體磁碟、RAID 陣列、光碟與磁帶媒體、記憶體為基礎的磁碟以及網路檔案系統。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="geom"/></emphasis></term>

      <listitem>
	<para>介紹在 FreeBSD 中的 GEOM Framework 是什麼，以及如何設定各種支援的 RAID 階層。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="filesystems"/></emphasis></term>

      <listitem>
	<para>查看 FreeBSD 還支援那些非原生檔案系統，如 <trademark>Sun</trademark> 的 Z 檔案系統。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="virtualization"/></emphasis></term>

      <listitem>
	<para>介紹虛擬化系統提供了那些功能，以及如何在 FreeBSD 上使用。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="l10n"/></emphasis></term>

      <listitem>
	<para>介紹如何在 FreeBSD 使用非英文的語言，這涵蓋了系統及應用層的在地化。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="updating-upgrading"/></emphasis></term>

      <listitem>
	<para>說明 FreeBSD-STABLE、FreeBSD-CURRENT 以及 FreeBSD 發佈版之間的差異，並介紹那些使用者適何追蹤開發系統以及程序的概述，這涵蓋了使用者更新系統到最新安全性發佈版本的方法。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="dtrace"/></emphasis></term>

      <listitem>
	<para>介紹如何在 FreeBSD 設定及使用 <trademark>Sun</trademark> 的 DTrace 工具，動態追蹤可以透過執行真實時間系統分析來協助定位效能問題。</para>
      </listitem>
    </varlistentry>

<!-- Part IV - Network Communications -->

    <varlistentry>
      <term><emphasis><xref linkend="serialcomms"/></emphasis></term>

      <listitem>
	<para>介紹如何使用撥入及撥出連線到您的 FreeBSD 系統的終端機與數據機。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="ppp-and-slip"/></emphasis></term>

      <listitem>
	<para>介紹如何在 FreeBSD 使用 PPP 來連線遠端的系統。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="mail"/></emphasis></term>

      <listitem>
	<para>說明組成電子郵件伺服器的各種元件，並深入說明如何設定最熱門的郵件伺服器軟體：<application>sendmail</application>。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="network-servers"/></emphasis></term>

      <listitem>
	<para>提供詳細的操作說明與範例設定檔，讓您可安裝您的 FreeBSD 機器為網路檔案伺服器、網域名稱伺服器、網路資訊系統伺服器或時間同步伺服器。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="firewalls"/></emphasis></term>

      <listitem>
	<para>說明軟體為基礎的防火牆背後的理念，並提供可用於 FreeBSD 中不同的防火牆設定的詳細資訊。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="advanced-networking"/></emphasis></term>

      <listitem>
	<para>介紹許多網路主題，包含在您的區域網路 (LAN) 分享網際網路連線給其他電腦、進階路由主題、無線網路、<trademark class="registered">Bluetooth</trademark>、ATM、IPv6 以及更多相關主題。</para>
      </listitem>
    </varlistentry>

<!-- Part V - Appendices -->

    <varlistentry>
      <term><emphasis><xref linkend="mirrors"/></emphasis></term>

      <listitem>
	<para>列出取得 FreeBSD CDROM 或 DVD 媒體的各種來源，以及在網際網路上的各種網站，讓您可以下載並安裝 FreeBSD。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="bibliography"/></emphasis></term>

      <listitem>
	<para>本書觸及許多不同主題，可能會讓您想更深入的了解，參考書目列出了在文中引用的許多優秀書籍。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="eresources"/></emphasis></term>

      <listitem>
	<para>介紹了可讓 FreeBSD 使用者提出問題以及參與有關 FreeBSD 技術會談的許多論壇。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><emphasis><xref linkend="pgpkeys"/></emphasis></term>

      <listitem>
	<para>列出了數個 FreeBSD 開發人員的 PGP 指紋。</para>
      </listitem>
    </varlistentry>
  </variablelist>

  <bridgehead xml:id="preface-conv" renderas="sect1">本書的編排體裁</bridgehead>

    <para>為了提供有一致性且易於閱讀的內容，以下是一些本書所遵循的編排體裁。</para>

    <bridgehead xml:id="preface-conv-typographic" renderas="sect2">文字編排體裁</bridgehead>

  <variablelist>
    <varlistentry>
      <term><emphasis>斜體字</emphasis></term>

      <listitem>
	<para><emphasis>斜體字</emphasis>用於：檔名、目錄、網址 (URL)、 強調語氣、以及第一次提及的技術詞彙。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><literal>等寬字</literal></term>

      <listitem>
	<para><literal>等寬字</literal>用於： 錯誤訊息、指令、環境變數、Port 名稱、主機名稱、帳號、群組、裝置名稱、變數、程式碼等。</para>
      </listitem>
    </varlistentry>

    <varlistentry>
      <term><application>粗體字</application></term>

      <listitem>
	<para>以<keycap>粗體字</keycap>表示：應用程式、指令、按鍵。</para>
      </listitem>
    </varlistentry>
  </variablelist>

<!-- Var list -->
  <bridgehead xml:id="preface-conv-commands" renderas="sect2">使用者輸入</bridgehead>

  <para>鍵盤輸入以<keycap>粗體字</keycap>表示，以便與一般文字做區隔。 組合鍵是指同時按下一些按鍵，我們以 `<literal>+</literal>' 來表示連接，像是：</para>

  <para xml:lang="en">
    <keycombo action="simul">
      <keycap>Ctrl</keycap>
      <keycap>Alt</keycap>
      <keycap>Del</keycap></keycombo></para>

  <para>是說，一起按 <keycap>Ctrl</keycap>、 <keycap>Alt</keycap> 以及 <keycap>Del</keycap> 鍵。</para>

  <para>若要逐一按鍵，那麼會以逗號 (,) 來表示，像是：</para>

  <para xml:lang="en">
    <keycombo action="simul">
      <keycap>Ctrl</keycap>
      <keycap>X</keycap>
    </keycombo>,
    <keycombo action="simul">
      <keycap>Ctrl</keycap>
      <keycap>S</keycap></keycombo></para>

  <para>是說：先同時按下 <keycap>Ctrl</keycap> 與 <keycap>X</keycap> 鍵， 然後放開後再同時按 <keycap>Ctrl</keycap> 與 <keycap>S</keycap> 鍵。</para>

<!-- How to type in key stokes, etc.. -->
  <bridgehead xml:id="preface-conv-examples" renderas="sect2">範例</bridgehead>

  <para>範例以  <filename>C:\&gt;</filename> 為開頭代表 <trademark class="registered">MS-DOS</trademark> 的指令。 若沒有特殊情況的話，這些指令應該是在 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 環境的 <quote>指令提示字元 (Command Prompt)</quote> 視窗內執行。</para>

  <screen xml:lang="en"><prompt>E:\&gt;</prompt> <userinput>tools\fdimage floppies\kern.flp A:</userinput></screen>

  <para>範例以 <prompt>#</prompt> 為開頭代表在 FreeBSD 中以超級使用者權限來執行的指令。 你可以先以 <systemitem class="username">root</systemitem> 登入系統並下指令，或是以你自己的帳號登入再使用 <citerefentry><refentrytitle>su</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來取得超級使用者權限。</para>

  <screen xml:lang="en"><prompt>#</prompt> <userinput>dd if=kern.flp of=/dev/fd0</userinput></screen>

  <para>範例以 <prompt>%</prompt> 為開頭代表在 FreeBSD 中以一般使用者帳號執行的指令。 除非有提到其他用法，否則都是預設為 C-shell 語法，用來設定環境變數以及下其他指令的意思。</para>

  <screen xml:lang="en"><prompt>%</prompt> <userinput>top</userinput></screen>

  <bridgehead xml:id="preface-acknowledgements" renderas="sect1">銘謝</bridgehead>

  <para>您所看到的這本書是經過數百個分散在世界各地的人所努力而來的結果。 無論他們只是糾正一些錯誤或提交完整的章節，所有的點滴貢獻都是非常寶貴有用的。</para>

  <para>也有一些公司透過提供資金讓作者專注於撰稿、提供出版資金等模式來支持文件的寫作。 其中，BSDi (之後併入 <link xlink:href="http://www.windriver.com">Wind River Systems</link>) 資助 FreeBSD 文件計劃成員來專職改善這本書直到 2000 年 3 月第一版的出版。(ISBN 1-57176-241-8) Wind River Systems 同時資助其他作者來對輸出架構做很多改進，以及給文章增加一些附加章節。這項工作結束於 2001 年 11 月第二版。(ISBN 1-57176-303-1) 在 2003-2004 兩年中，<link xlink:href="http://www.freebsdmall.com">FreeBSD Mall, Inc</link> 把報酬支付給改進這本手冊以使第三版印刷版本能夠出版的志工。</para>

</preface>


  <part xml:id="getting-started">
    <title>入門</title>

    <partintro>
      <para>這部份是提供給初次使用 FreeBSD 的使用者和系統管理者。 這些章節包括：</para>

      <itemizedlist>
	<listitem>
	  <para>介紹 FreeBSD 給您。</para>
	</listitem>

	<listitem>
	  <para>在安裝過程給您指引。</para>
	</listitem>

	<listitem>
	  <para>教您 <trademark class="registered">UNIX</trademark> 的基礎及原理。</para>
	</listitem>

	<listitem>
	  <para>展示給您看如何安裝豐富的 FreeBSD 的應用軟體。</para>
	</listitem>

	<listitem>
	  <para>向您介紹 X，<trademark class="registered">UNIX</trademark> 的視窗系統以及詳細的桌面環境設定，讓您更有生產力。</para>
	</listitem>
      </itemizedlist>

      <para>我們試著儘可能的讓這段文字的參考連結數目降到最低，讓您在讀使用手冊的這部份時可以不太需要常常前後翻頁。</para>
    </partintro>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="introduction">

  <info>
    <title>簡介</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Jim</firstname>
	  <surname>Mock</surname>
	</personname>
	<contrib>Restructured, reorganized, and parts rewritten
	  by </contrib>
      </author>
    </authorgroup>
  </info>

  <sect1 xml:id="introduction-synopsis">
    <title>概述</title>

    <para>非常感謝您對 FreeBSD 感興趣！以下章節涵蓋 FreeBSD 計劃的各方面：比如它的歷史、目標、開發模式等等。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>FreeBSD 與其他作業系統之間的關係。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 計劃的歷史。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 計劃的目標。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 開源開發模式的基礎概念。</para>
      </listitem>

      <listitem>
	<para>當然囉，還有 <quote>FreeBSD</quote> 這名字的由來。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="nutshell">
    <title>歡迎使用 FreeBSD！</title>

    <indexterm xml:lang="en"><primary>4.4BSD-Lite</primary></indexterm>

    <para>FreeBSD 是一套開源、符合標準的類 Unix 的作業系統，適用於 x86 (32 與 64 位元), <trademark class="registered">ARM</trademark>, AArch64, <trademark class="registered">RISC-V</trademark>, <trademark class="registered">MIPS</trademark>, <trademark class="registered">POWER</trademark>, <trademark class="registered">PowerPC</trademark> 以及 Sun <trademark class="registered">UltraSPARC</trademark> 的電腦。它提供了現代作業系統所應具備的所有功能，例如：先佔式多工、記憶體保護、虛擬記憶體、多使用者架構、對稱多工處理 (SMP)、各種針對不同語言和框架的開源開發工具以及以 X Window 系統、KDE 及 GNOME 為主的桌面功能，而它有以下優勢：</para>

    <itemizedlist>
      <listitem>
	<para><emphasis>自由的開放原始碼授權</emphasis>，授予您自由修改和擴充其原始碼並將其合併到開放原始碼專案或封閉的產品中的權力，不會對 Copyleft 授權施加典型的限制，也避免了授權不相容的潛在問題。</para>
      </listitem>

      <listitem>
	<para><emphasis>強大的 TCP/IP 網路</emphasis> <indexterm> <primary>TCP/IP
	      networking</primary></indexterm> - FreeBSD 以工業標準實作通訊協定並不斷改善效能與擴展性，這使得 FreeBSD 非常適合應用在伺服器、路由器/防火牆的角色 - 這也是許多公司和供應商使用它的原因。</para>
      </listitem>

      <listitem>
	<para><emphasis>完全整合 OpenZFS</emphasis>，包含 root-on-ZFS、ZFS 開機環境、故障管理、委託管理、對 Jail 的支援、FreeBSD 專屬的文件以及系統安裝程式的支援。</para>
      </listitem>

      <listitem>
	<para><emphasis>鉅細靡遺的安全性功能</emphasis>，從強制存取控制 (Mandatory Access Control, MAC) 框架到 Capsicum 功能以及沙盒機制。</para>
      </listitem>

      <listitem>
	<para><emphasis>超過 3 萬個預編的套件</emphasis>供所有支援的架構以及可簡單編譯依您的需求所客製的 Port 套件集。</para>
      </listitem>

      <listitem>
	<para><emphasis>說明文件</emphasis> - 除了操作手冊及由許多作者著作從系統管理到核心內部主題的書籍外，也有不僅只針對 Userspace Daemon、工具及設定檔，同樣也有針對核心驅動程式 APIs (第 9 節) 及各別驅動程式 (第 4 節) 的操作說明頁 ( <citerefentry><refentrytitle>man</refentrytitle><manvolnum>1</manvolnum></citerefentry> page)。</para>
      </listitem>

      <listitem>
	<para><emphasis>簡單且具一致性的檔案庫架構與編譯系統</emphasis> - FreeBSD 對所有的元件、核心與 Userspace 使用單一的檔案庫，加上統一、易於客製的編譯系統以及嚴謹的開發流程，讓 FreeBSD 的編譯基礎架構更容易與您產品的整合。</para>
      </listitem>

      <listitem>
	<para><emphasis>忠於 Unix 哲學</emphasis>，偏好可組合而非具寫死的 <quote>多合一</quote> 單一 Daemon。</para>
      </listitem>

      <listitem>
	<para><indexterm> <primary>binary compatibility</primary>
	    <secondary>Linux</secondary></indexterm> <emphasis>Linux 執行檔 (Binary) 相容性</emphasis>，無需虛擬化即可執行許多 Linux 執行檔。</para>
      </listitem>
    </itemizedlist>

    <para>FreeBSD 系統是基於美國加州大學柏克萊分校的電腦系統研究組 (Computer Systems Research Group 也就是 CSRG) 所發行的 4.4BSD-Lite<indexterm>
	<primary>4.4BSD-Lite</primary>
      </indexterm>，繼承了 BSD 系統開發的優良傳統。 除了由 CSRG 所提供的高品質的成果外，FreeBSD 計劃也投入了上千人時在擴充及微調，來讓系統在真實情境下能達到最大的效能與可靠性。 FreeBSD 提供了其他開源與商業產品的效能及穩定性，並結合其他產品所沒有的尖端功能。</para>

    <sect2 xml:id="os-overview">
      <title>FreeBSD 能做什麼？</title>

      <para>FreeBSD 能應用的情境完全限制在你的想像力上。 從軟體開發到工廠自動化，庫存管控到遠程衛星天線的方位角校正；若您的需求可以用商用的 <trademark class="registered">UNIX</trademark> 產品來達成，那麼極有可能使用 FreeBSD 也能辦到！ FreeBSD 也受益於來自於全球各研究中心及大學所開發的數千個高品質的軟體 ，這些通常只需要花費很少的費用或根本就是免費的。</para>

      <para>由於每個人都可以取得 FreeBSD 的原始程式碼， 這個系統可以被量身訂做成能執行任何原本完全無法想像的功能或計劃， 而對於從各廠商取得的作業系統通常沒有辦法這樣地被修改。 以下提供一些人們使用 FreeBSD 的例子：</para>

      <itemizedlist>
	<listitem>
	  <para><emphasis>網際網路服務：</emphasis> FreeBSD 內建強勁的網路功能使它成為網路服務 (如下例) 的理想平台：</para>

	  <itemizedlist>
	    <listitem>
	      <para>網頁伺服器</para>
	    </listitem>

	    <listitem>
	      <para>IPv4 及 IPv6 路由</para>
	    </listitem>

	    <listitem>
	      <para>防火牆<indexterm>
		  <primary>firewall</primary>
		</indexterm>以及 NAT<indexterm>
		  <primary>NAT</primary>
		</indexterm> (<quote>IP 偽裝</quote>) 通訊閘</para>
	    </listitem>

	    <listitem>
	      <para>檔案傳輸協定伺服器<indexterm>
		  <primary>FTP servers</primary>
		</indexterm></para>
	    </listitem>

	    <listitem>
	      <para><indexterm>
		  <primary>electronic mail</primary>
		  <see>email</see>
		</indexterm> <indexterm>
		  <primary>email</primary>
		</indexterm> 電子郵件伺服器</para>
	    </listitem>

	    <listitem>
	      <para>還有更多...</para>
	    </listitem>
	  </itemizedlist>
	</listitem>

	<listitem>
	  <para><emphasis>教育：</emphasis>您是電腦科學相關領域的學生嗎？再也沒有比使用 FreeBSD 能學到更多作業系統、計算機結構、及網路的方法了。其中許多免費提供的 CAD，數學和圖形設計套件對於那些需要在電腦完成 <emphasis>其他</emphasis> 工作的人也非常有用！</para>
	</listitem>

	<listitem>
	  <para><emphasis>研究：</emphasis>有了完整的原始程式碼，FreeBSD 是研究作業系統及電腦科學的極佳環境。 具有免費且自由取得特性的 FreeBSD 也使得一個分置兩地的合作計劃，不必擔心版權及系統開放性的問題， 而能自在的交流。</para>
	</listitem>

	<listitem>
	  <para><emphasis>網路：</emphasis> 你如果需要 路由器<indexterm>
	      <primary>router</primary>
	    </indexterm>、名稱伺服器 (DNS)<indexterm>
	      <primary>DNS Server</primary>
	    </indexterm> 或安全的防火牆， FreeBSD 可以輕易的將你沒有用到的 386 或 486 PC 變身成為絕佳的伺服器，甚至具有過濾封包的功能。</para>
	</listitem>

	<listitem>
	  <para><emphasis>嵌入式：</emphasis> FreeBSD 是一套可用來建立嵌入式系統的傑出平台。 <indexterm>
	      <primary>embedded</primary>
	    </indexterm> 支援 <trademark class="registered">ARM</trademark>, <trademark class="registered">MIPS</trademark> 以及 <trademark class="registered">PowerPC</trademark> 平台，再加上健全的網路環境、尖端的功能以及自由的 <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/books/faq/introduction.html#bsd-license-restrictions">BSD 授權條款</link>，FreeBSD 成為用來建置嵌入式路由器、防火牆及其他裝置的絕佳基礎。</para>
	</listitem>

	<listitem>
	  <para><indexterm>
	      <primary>X Window System</primary>
	    </indexterm> <indexterm>
	      <primary>GNOME</primary>
	    </indexterm> <indexterm>
	      <primary>KDE</primary>
	    </indexterm> <emphasis>桌面:</emphasis> FreeBSD 同時也是低成本桌面解決方案中不錯的選擇，使用了免費的 X11 伺服器。FreeBSD 提供許多開源桌面環境可選擇，包含了標準 <application>GNOME</application> 及 <application>KDE</application> 圖型化使用者介面。FreeBSD 甚至可以透過中央伺服器做 <quote>無磁碟</quote> 開機，讓個人工作站變的更便宜、更易於管理。</para>
	</listitem>

	<listitem>
	  <para><emphasis>軟體開發：</emphasis> 基本安裝的 FreeBSD 就包含了完整的程式開發工具，如 C/C++<indexterm>
	      <primary>Compiler</primary>
	    </indexterm> 編譯器及除錯器。 透過 Port 與套件管理系統也可支援需多其他語言。</para>
	</listitem>
      </itemizedlist>

      <para>你可以經由燒錄 CD-ROM、DVD 或是從 FTP 站上抓回 FreeBSD。 詳情請參閱 <xref linkend="mirrors"/> 取得 FreeBSD。</para>
    </sect2>

    <sect2 xml:id="introduction-nutshell-users">
      <title>誰在用 FreeBSD？</title>

      <indexterm><primary>使用者</primary> <secondary>執行 FreeBSD 的大型站台</secondary></indexterm>

      <para>FreeBSD 以其網頁 (Web) 服務功能而聞名 - 在 FreeBSD 上運作的網站包括 <link xlink:href="https://news.ycombinator.com/">Hacker News</link>, <link xlink:href="http://www.netcraft.com/">Netcraft</link>, <link xlink:href="http://www.163.com/">NetEase</link>, <link xlink:href="https://signup.netflix.com/openconnect">Netflix</link>, <link xlink:href="http://www.sina.com/">Sina</link>, <link xlink:href="http://www.sony.co.jp/">Sony Japan</link>, <link xlink:href="http://www.rambler.ru/">Rambler</link>, <link xlink:href="http://www.yahoo.com/">Yahoo!</link> 及 <link xlink:href="http://www.yandex.ru/">Yandex</link>。</para>

      <para>FreeBSD 先進的功能、成熟的安全性、可預測的發佈週期以及自由的授權條款，讓 FreeBSD 已經被用來做為建立許多商業、開源應用、裝置以及產品的平台，有許多世界上最大的資訊公司使用 FreeBSD：</para>

      <itemizedlist>
	<listitem>

	  <para><link xlink:href="http://www.apache.org/">Apache</link> <indexterm>
	      <primary>Apache</primary>
	    </indexterm> - Apache 軟體基金會中大部分面對大眾的基礎設施，包括可能是世界上最大的 SVN 檔案庫 (擁有超過 140 萬次提交) 都是在 FreeBSD 上運作。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.apple.com/">Apple</link> <indexterm>
	      <primary>Apple</primary>
	    </indexterm> - OS X 大量借鑒 FreeBSD 的網路 Stack、虛擬檔案系統以及許多使用者空間的元件。Apple iOS 中含有從 FreeBSD 借鑒來的元素。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.cisco.com/">Cisco</link> <indexterm>
	      <primary>Cisco</primary>
	    </indexterm> -  IronPort 網路安全及反垃圾郵件設備是採用改良後 FreeBSD 核心來運作。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.citrix.com/">Citrix</link> <indexterm>
	      <primary>Citrix</primary>
	    </indexterm> - 安全設備的 NetScaler 產品線提供的第 4-7 層的負載均衡、內容快取、應用層防火牆、安全的 VPN 以及行動雲端網路存取，皆運用了 FreeBSD Shell 強大的功能。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="https://www.emc.com/isilon">Dell EMC Isilon</link> <indexterm>
	      <primary>Isilon</primary>
	    </indexterm> - Isilon 的企業存儲設備是以 FreeBSD 為基礎。非常自由的 FreeBSD 授權條款讓 Isilon 整合了它們的智慧財產到整個核心，並專注打造自己的產品，而不是一個作業系統。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.quest.com/KACE">Quest KACE</link> <indexterm>
	      <primary>Quest KACE</primary>
	    </indexterm> - KACE 系統管理設備中運作了 FreeBSD，是因為 FreeBSD 的可靠性、可擴展性以及支持其持續發展的社群。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.ixsystems.com/">iXsystems</link> <indexterm>
	      <primary>iXsystems</primary>
	    </indexterm> - 統合存儲 (Unified Storage) 設備的 TrueNAS 產品線是以 FreeBSD 為基礎。除了該公司自己的商業產品外，iXsystems 也管理著 TrueOS 和 FreeNAS 兩個開源計劃的開發。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.juniper.net/">Juniper</link> <indexterm>
	      <primary>Juniper</primary>
	    </indexterm> -  JunOS 作業系統驅動了所有的 Juniper 網絡設備 (包括路由器，交換器，安全與網絡設備) 便是以 FreeBSD 為基礎。Juniper 在眾多廠商之中，展現了計劃與商業產品供應商之間的共生關係。由 Juniper 所開發的改進內容會回饋給 FreeBSD 來降低未來新功能從  FreeBSD 整合回 JunOS 的複雜性。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.mcafee.com/">McAfee</link> <indexterm>
	      <primary>McAfee</primary>
	    </indexterm> - SecurOS 是 McAfee 企業防火牆產品的基礎，其中包含了 Sidewinder ，也是以 FreeBSD 為基礎。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.netapp.com/">NetApp</link> <indexterm>
	      <primary>NetApp</primary>
	    </indexterm> - 存儲設備中的 Data ONTAP GX 產品線是以 FreeBSD 為基礎。除此之外，NetApp 還貢獻了回 FreeBSD 許多功能，包括新 BSD 條款授權的 hypervisor, bhyve。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.netflix.com/">Netflix</link> <indexterm>
	      <primary>Netflix</primary>
	    </indexterm> - Netflix 用來以串流傳送電影到客戶的 OpenConnect 設備是以 FreeBSD 為基礎。 Netflix 也做了大量貢獻到程式碼庫，並致力於維持與主線 FreeBSD 的零修正關係。Netflix 的 OpenConnect 設備負責了北美所有的網路流量 32％ 以上。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.sandvine.com/">Sandvine</link> <indexterm>
	      <primary>Sandvine</primary>
	    </indexterm> - Sandvine 使用 FreeBSD 作為它的高性能即時網路處理平台的基礎來建立它們的智慧網路策略控制產品。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.sony.com/">Sony</link> <indexterm>
	      <primary>Sony</primary>
	    </indexterm> - PlayStation 4 遊戲主機使用了修改過的 FreeBSD 版本來運作。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.sophos.com/">Sophos</link> <indexterm>
	      <primary>Sophos</primary>
	    </indexterm> - Sophos 電子郵件設備產品是以加強防護 (Hardened) 的 FreeBSD 為基礎，可掃描入站郵件中的垃圾郵件和病毒，同時也可監控出站郵件中的惡意軟體及敏感資訊。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.spectralogic.com/">Spectra Logic</link> <indexterm>
	      <primary>Spectra Logic</primary>
	    </indexterm> - 儲藏級儲存設備的 nTier 產品線以 FreeBSD 和 OpenZFS 來運作。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="https://www.stormshield.eu">Stormshield</link> <indexterm>
	      <primary>Stormshield</primary>

	    </indexterm> - Stormshield 網路安全設備使用了硬體化版本的 FreeBSD 做為基礎，BSD 授權條款讓他們可將其智慧財產與系統整合並同時回饋大量有趣的發展給社群。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.weather.com/">The Weather Channel</link> <indexterm>
	      <primary>The Weather Channel</primary>

	    </indexterm> - 被安裝在各地有線電視營運商前端，負責加入當地天氣預報到有線電視網路節目的 IntelliStar 設備便是使用 FreeBSD。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.verisign.com/">Verisign</link> <indexterm>
	      <primary>Verisign</primary>

	    </indexterm> - VeriSign 主要經營 .com 與 .net 根網域名稱註冊業務以及隨附的 DNS 基礎設施運作。這些基礎設施的運作仰賴各種不同的網路作業系統包括 FreeBSD 來確保不會有單點故障的問題。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.voxer.com/">Voxer</link> <indexterm>
	      <primary>Voxer</primary>

	    </indexterm> - Voxer 使用了 FreeBSD 的 ZFS 來驅動行動語音通訊平台，讓 Voxer 從 Solaris 改使用 FreeBSD 的原因是 FreeBSD 擁有詳盡的文件、更大型且活躍的社群、較便利的開發人員環境。除了提供關鍵的 <acronym>ZFS</acronym> 和 DTrace 功能之外 FreeBSD 的 <acronym>ZFS</acronym> 也支援了 TRIM。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.whatsapp.com/">WhatsApp</link> <indexterm>
	      <primary>WhatsApp</primary>
	    </indexterm> - 當 WhatsApp 面臨需要一個每台伺服器能夠同時處理超過 100 萬個 TCP 連線的平台時，它們選擇了 FreeBSD。它們接著擴大規模到每台伺服器處理超過 250 萬的連線。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://wheelsystems.com/">Wheel Systems</link> <indexterm>
	      <primary>Wheel Systems</primary>

	    </indexterm> - FUDO 安全性設備讓企業可以監控、控制、記錄以及稽查在其系統中作業的承包商與管理員。這些功能皆是以 FreeBSD 最佳的安全性功能為基礎，包括 ZFS, GELI, Capsicum, HAST 及 auditdistd。</para>
	</listitem>
      </itemizedlist>

      <para>FreeBSD 也催生了數個相關的開源計劃：</para>

      <itemizedlist>
	<listitem>
	  <para><link xlink:href="http://bsdrp.net/">BSD Router</link> <indexterm>
	      <primary>BSD Router</primary>
	    </indexterm> - 以 FreeBSD 為基礎的大型企業路由器替代方案，專門設計為可在標準 PC 硬體上運作。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.freenas.org/">FreeNAS</link> <indexterm>
	      <primary>FreeNAS</primary>
	    </indexterm> - 專為網路檔案伺服器設備使用所設計的 FreeBSD。提供了以 Python 為基礎的網頁介面來簡化 UFS 與 ZFS 檔案系統的管理，支援了 NFS、SMB/ CIFS、AFP、FTP 與 iSCSI，還有以 FreeBSD Jail 為基礎的套件系統。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.ghostbsd.org/">GhostBSD</link> <indexterm>
	      <primary>GhostBSD</primary>
	    </indexterm> - 採用 Gnome 桌面環境的 FreeBSD 發行版。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://mfsbsd.vx.sk/">mfsBSD</link> <indexterm>
	      <primary>mfsBSD</primary>
	    </indexterm> - 用來建置可完全從記憶體執行 FreeBSD 系統映像檔工具。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.nas4free.org/">NAS4Free</link> <indexterm>
	      <primary>NAS4Free</primary>
	    </indexterm> - 以 FreeBSD 及 PHP 驅動網頁介面為基礎的檔案伺服器。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.opnsense.org/">OPNSense</link> <indexterm>
	      <primary>OPNsense</primary>
	    </indexterm> - OPNsense 是一個以 FreeBSD 為基礎的開源、易於使用及易於建置的防火牆和路由平台。OPNsense 有大多數在昂貴的商業防火牆上才有的功能。它帶來了商業產品的豐富功能集，同時擁有開放和安全的來源。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="https://www.trueos.org">TrueOS</link> <indexterm>
	      <primary>TrueOS</primary>
	    </indexterm> - 訂製版本的 FreeBSD，裝備了給桌面使用者使用的圖型化工具來展示 FreeBSD 強大的功能給所有使用者，專門設計來緩解使用者在 Windows 與 OS X 間的過渡。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://www.pfsense.org/">pfSense</link> <indexterm>
	      <primary>pfSense</primary>
	    </indexterm> - 以 FreeBSD 為基礎的防火牆發行版，支援巨型陣列及大規模 IPv6。</para>
	</listitem>

	<listitem>
	  <para><link xlink:href="http://zrouter.org/">ZRouter</link> <indexterm>
	      <primary>ZRouter</primary>
	    </indexterm> - 嵌入式裝置韌體的開源替代方案，以 FreeBSD 為基礎，專門設計來取代現成路由器上的專用韌體。</para>
	</listitem>
      </itemizedlist>

      <para>在 FreeBSD 基金會網站上可以找到<link xlink:href="https://www.freebsdfoundation.org/about/testimonials/">以 FreeBSD 為基礎的產品與服務的公司的推薦</link> 清單。 Wikipedia 也維護了一份<link xlink:href="https://en.wikipedia.org/wiki/List_of_products_based_on_FreeBSD">以 FreeBSD 為基礎的產品清單</link>。</para>

    </sect2>
  </sect1>

  <sect1 xml:id="history">
    <title>關於 FreeBSD 計劃</title>

    <para>接下來講的是 FreeBSD 計劃的背景，包含歷史、計劃目標以及開發模式。</para>

    <sect2 xml:id="intro-history">
      <title>FreeBSD 歷史簡介</title>

      <indexterm xml:lang="en"><primary>386BSD Patchkit</primary></indexterm>
      <indexterm xml:lang="en"><primary>Hubbard, Jordan</primary></indexterm>
      <indexterm xml:lang="en"><primary>Williams, Nate</primary></indexterm>
      <indexterm xml:lang="en"><primary>Grimes, Rod</primary></indexterm>
      <indexterm xml:lang="en">
	<primary>FreeBSD Project</primary>
	<secondary>history</secondary>
      </indexterm>

      <para>FreeBSD 計畫起源於 1993 年初， 那是源自於維護一組『非官方 386BSD 修正工具』計劃的最後三個協調人 Nate Williams，Rod Grimes 和 Jordan Hubbard。</para>

      <indexterm xml:lang="en"><primary>386BSD</primary></indexterm>
      <para>最初的目標是做出一份 386BSD 的中間版本的快照 (Snapshot) 來修正使用修正工具 (Patchkit) 機制無法解決的數個問題，也因此早期的計劃名稱叫做 386BSD 0.5 或 386BSD Interim 便是這個原因。</para>

      <indexterm xml:lang="en"><primary>Jolitz, Bill</primary></indexterm>
      <para>386BSD 是 Bill Jolitz 的作業系統，在當時就已經忍受了將近一年的忽視，隨著修正工具日漸龐大的令人不舒服，他們決定提供一份過渡性的 <quote>簡潔</quote> 快照來幫助 Bill。 然而，由於 Bill Jolitz 忽然決定取消其對該計劃的認可，且沒有明確指出未來的打算，所以該計劃便突然面臨中止。</para>

      <indexterm xml:lang="en"><primary>Greenman, David</primary></indexterm>
      <indexterm xml:lang="en"><primary>Walnut Creek CDROM</primary></indexterm>

      <para>這三人認為這個目標即始沒有 Bill 的支持仍有保留的價值，最後他們採用 David Greenman 丟銅板決定的名字，也就是 "FreeBSD"。在詢問了當時的一些使用者意見之後決定了最初的目標，隨著目標越來越明確便開始著手進行。Jordan 找了 Walnut Creek CD-ROM 商討，著眼於如何改進 FreeBSD 的發行通路，讓那些不便上網的人可簡單的取得。 Walnut Creek CD-ROM 不只贊成以 CD 來發行 FreeBSD 的想法，同時提供了一台機器以及快速的網路。 若不是 Walnut Creek CD-ROM 在那個時間上史無前例的信任，這個默默無名的計劃很可能不會成為現在的 FreeBSD 快速的成長到今日這樣的規模。</para>

      <indexterm xml:lang="en"><primary>4.3BSD-Lite</primary></indexterm>
      <indexterm xml:lang="en"><primary>Net/2</primary></indexterm>
      <indexterm xml:lang="en"><primary>U.C. Berkeley</primary></indexterm>
      <indexterm xml:lang="en"><primary>386BSD</primary></indexterm>
      <indexterm xml:lang="en"><primary>Free Software
	  Foundation</primary></indexterm>
      <para>第一張以 CD-ROM (及網路) 發行的版本為 FreeBSD 1.0，是在 1993 年十二月發佈。 該版本採用了 U.C. Berkeley 以磁帶方式發行的 4.3BSD-Lite (<quote>Net/2</quote>) 及許多來自於 386BSD 和自由軟體基金會的元件為基礎。對於第一次發行而言還算成功，我們又接著於 1994 年 5 月發行了相當成功的 FreeBSD 1.1。</para>

      <indexterm xml:lang="en"><primary>Novell</primary></indexterm>
      <indexterm xml:lang="en"><primary>U.C. Berkeley</primary></indexterm>
      <indexterm xml:lang="en"><primary>Net/2</primary></indexterm>
      <indexterm xml:lang="en"><primary>AT&amp;T</primary></indexterm>
      <para>然而此後不久，另一個意外的風暴在 Novell 與 U.C. Berkeley 關於 Berkeley Net/2 磁帶之法律地位的訴訟確定之後形成。 U.C. Berkeley 承認大部份的 Net/2 的程式碼都是<quote>侵佔來的</quote>且是屬於 Novell 的財產 -- 事實上是當時不久前從 AT&amp;T 取得的。 Berkeley 得到的是 Novell 對於 4.4BSD-Lite 的<quote>祝福</quote>，最後當 4.4BSD-Lite 終於發行之後，便不再是侵佔行為。 而所有現有 Net/2 使用者都被強烈建議更換新版本，這包括了 FreeBSD。 於是，我們被要求於 1994 年 6 月底前停止散佈以 Net/2 為基礎的產品。在此前提之下，本計劃被允許在期限以前作最後一次發行，也就是 FreeBSD 1.1.5.1。</para>

      <para>FreeBSD 便開始了這宛如『重新發明輪子』的艱鉅工作 -- 從全新的且不完整的 4.4BSD-Lite 重新整合。 這個 <quote>Lite</quote> 版本是不完整的，因為 Berkeley 的 CSRG 已經刪除了大量在建立一個可以開機執行的系統所需要的程式碼 (基於若干法律上的要求)，且該版本在 Intel 平台的移植是非常不完整的。 直到 1994 年 11 月本計劃才完成了這個轉移， 同時在該年 12 月底以 CD-ROM 以及網路的形式發行了 FreeBSD 2.0。 雖然該份版本在當時有點匆促粗糙，但仍是富有意義的成功。 隨之於 1995 年 6 月又發行了更容易安裝，更好的 FreeBSD 2.0.5。</para>

      <para>自那時以來，FreeBSD 在每一次對先前版本改進穩定性、速度及功能時便會發佈一個新的發佈版本。</para>

      <para>目前，長期的開發計畫繼續在 10.X-CURRENT (trunk) 分支中進行，而 10.X 的快照 (Snapshot) 版本可以在 <link xlink:href="ftp://ftp.FreeBSD.org/pub/FreeBSD/snapshots/">快照伺服器</link> 取得。</para>
    </sect2>

    <sect2 xml:id="goals">
      <info>
	<title>FreeBSD 計劃目標</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Jordan</firstname>
	      <surname>Hubbard</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <indexterm><primary>FreeBSD 計劃</primary> <secondary>目標</secondary></indexterm>
      <para>FreeBSD 計劃的目標在於提供可作任意用途的軟體而不附帶任何限制條文。 我們之中許多人對程式碼 (以及計畫本身) 都有非常大的投入， 因此，當然不介意偶爾有一些資金上的補償，但我們並沒打算堅決地要求得到這類資助。 我們認為我們的首要<quote>使命</quote>是為任何人提供程式碼， 不管他們打算用這些程式碼做什麼， 因為這樣程式碼將能夠被更廣泛地使用，從而發揮其價值。 我認為這是自由軟體最基本的，同時也是我們所倡導的一個目標。</para>

      <indexterm><primary>GNU 通用公共授權條款 (GPL)</primary></indexterm>
      <indexterm><primary>GNU 較寬鬆通用公共授權條款 (LGPL)</primary></indexterm>
      <indexterm><primary>BSD 版權</primary></indexterm>
      <para>我們程式碼樹中，有若干是以 GNU 通用公共授權條款 (GPL) 或者 GNU 較寬鬆通用公共授權條款 (LGPL) 發佈的那些程式碼帶有少許的附加限制，還好只是強制性的要求開放程式碼而不是別的。 由於使用 GPL 的軟體在商業用途上會增加若干複雜性，因此，如果可以選擇的話， 我們會比較喜歡使用限制相對更寬鬆的 BSD 版權來發佈軟體。</para>
    </sect2>

    <sect2 xml:id="development">
      <info>
	<title>FreeBSD 開發模式</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Satoshi</firstname>
	      <surname>Asami</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <indexterm><primary>FreeBSD 專案</primary> <secondary>開發模式</secondary></indexterm>

      <para>FreeBSD 的開發是一個非常開放且具彈性的過程，就像從 <link xlink:href="@@URL_RELPREFIX@@/doc/zh_TW.UTF-8/articles/contributors/article.html">貢獻者名單</link> 所看到的，是由全世界成千上萬的貢獻者發展起來的。 FreeBSD 的開發基礎架構允許數以百計的開發者透過網際網路協同工作。 我們也經常關注著那些對我們的計畫感興趣的新開發者和新的創意， 那些有興趣更進一步參與計劃的人只需要在 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-hackers">FreeBSD 技術討論郵遞論壇</link> 連繫我們。 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-announce">FreeBSD 公告郵遞論壇</link> 對那些希望了解我們進度的人也是相當有用的。</para>

      <para>無論是單獨開發者或者封閉式的團隊合作，多瞭解 FreeBSD 計劃和它的開發過程會是不錯的：</para>

      <variablelist>
	<varlistentry>
	  <term>SVN 檔案庫<anchor xml:id="development-cvs-repository"/></term>

	  <listitem>
	    <para><indexterm>
		<primary>CVS</primary>
	      </indexterm> <indexterm>
		<primary>CVS Repository</primary>
	      </indexterm> <indexterm>
		<primary>Concurrent Versions System</primary>
		<see>CVS</see>
	      </indexterm> <indexterm>
		<primary>Subversion</primary>
	      </indexterm> <indexterm>
		<primary>Subversion Repository</primary>
	      </indexterm> <indexterm>
		<primary>SVN</primary>
		<see>Subversion</see>
	      </indexterm>過去數年來 FreeBSD 的中央原始碼樹 (Source tree) 一直是以 <link xlink:href="http://www.nongnu.org/cvs/">CVS</link> (Concurrent Versions System) 來維護的， 它是一套免費的原始碼控管工具。 從 2008 年 6 月起， FreeBSD 計劃開始改用 <link xlink:href="http://subversion.tigris.org">SVN</link> (Subversion)。 這是一個必要的更換動作，因為隨著原始碼樹及歷史版本儲存的數量不斷快速擴張，<application>CVS</application> 先天的技術限制越來越明顯。 文件計劃與 Port 套件集檔案庫也同樣於 2012 年 5 月及 2012 年 7 月由 <application>CVS</application> 改為 <application>SVN</application>。請參考 <link linkend="synching">同步您的原始碼樹</link> 一節來取得有關如何取得 FreeBSD <literal>src/</literal> 檔案庫的更多資訊，以及 <link linkend="ports-using">使用 Port 套件集</link> 了解如何取得 FreeBSD Port 套件集。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term>提交者名單<anchor xml:id="development-committers"/></term>

	  <listitem>
	    <para>所謂的 <firstterm>提交者 (Committer)</firstterm> 指的是對 Subversion 原始碼樹有 <emphasis>寫入</emphasis> 權限的人， 並且被授予修改 FreeBSD 原始碼的權限。 (<quote>committer</quote> 一詞源自版本管理系統中的 <command>commit</command> 指令，該指令是用來把新的修改提交給檔案庫)。 任何人都可以回報問題到 <link xlink:href="https://bugs.FreeBSD.org/submit/">Bug Database</link>，在回報問題之前，可以使用 FreeBSD 郵遞清單、IRC 頻道或論壇來確認問題真的是一個錯誤 (Bug)。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term>FreeBSD 核心團隊<anchor xml:id="development-core"/></term>

	  <listitem>
	    <para>如果把 FreeBSD 看成是一家公司的話， <firstterm>FreeBSD 核心團隊 (FreeBSD core team)</firstterm><indexterm>
		<primary>core team</primary>
	      </indexterm> 就相當於公司的董事會。 核心團隊的主要職責在於確保此計劃的整體有良好的架構，以朝著正確的方向發展。 此外，邀請敬業且負責的開發者加入提交者的行列也是核心團隊的職責之一，隨著其他新成員的加入也招募新的核心團隊成員。 目前的核心團隊是在 2018 年 7 月從提交者候選人之中選出來的，這個選舉每兩年會舉辦一次。</para>

	    <note>
	      <para>如同多數的開發者，核心團隊大部分成員加入 FreeBSD 開發都是志工性質而已， 並未從本計劃中獲得任何薪酬，所以這只是一個 <quote>承諾</quote> 不應該被誤解為 <quote>保證支援</quote> 才對。 前面用 <quote>董事會</quote> 來舉例可能不是很恰當，或許我們應該說： 他們是一群自願放棄原本的優渥生活、個人其他領域成就， 而選擇投入 FreeBSD 開發的熱血有為者才對！</para>
	    </note>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term>非官方貢獻者</term>

	  <listitem>
	    <para>最後一點，但這點絕非最不重要的， 最大的開發者團隊就是持續為我們提供回饋以及錯誤修正的使用者自己。 與 FreeBSD 非核心開發者互動的主要方式，便是透過訂閱 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-hackers">FreeBSD 技術討論郵遞論壇</link> 來進行溝通，這方面可參考，請參閱 <xref linkend="eresources"/> 以瞭解各式不同的 FreeBSD 郵遞論壇。</para>

	    <para><citetitle><link xlink:href="@@URL_RELPREFIX@@/doc/zh_TW.UTF-8/articles/contributors/article.html">FreeBSD 貢獻者名單</link></citetitle> <indexterm>
		<primary>contributors</primary>
	      </indexterm> 相當長且不斷成長中， 只要有貢獻就會被列入其中， 要不要立即考慮貢獻 FreeBSD 一些回饋呢？</para>

	    <para>提供原始碼並非為這個計劃做貢獻的唯一方式； 需要大家投入的完整工作清單請參閱 <link xlink:href="@@URL_RELPREFIX@@/index.html">FreeBSD 計畫網站</link>。</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para>總而言之，我們的開發模式像是由鬆散的同心圓所組織。這個集中模式的設計為的是讓 FreeBSD 的<emphasis>使用者</emphasis>更便利，可以很容易的追蹤同一個中央的程式庫，避免把潛在的貢獻者排除在外！而我們的目標是提供一個穩定的作業系統，並有大量相關的 <link linkend="ports">應用程式</link>，讓使用者能夠輕鬆的安裝與使用 — 而這個開發模式對我們要完成這個目標來說運作的非常好。</para>

      <para>我們對於那些想要加入 FreeBSD 開發者的期待是： 請保持如同前人一樣的投入，以確保繼續成功！</para>
    </sect2>

    <sect2 xml:id="third-party-programs">
      <title>第三方程式</title>

      <para>除了基礎發行版之外，FreeBSD 提供了擁有上千個常用的程式的移植軟體的套件集，在撰寫本文的同時，已有超過 24,000 個 Port！Port 的範圍從 HTTP 伺服器到遊戲、語系、編輯器，幾乎所有東西都在裡面。完整的 Port 套件集需要將近 500 MB。要編譯一個 Port 您只需要切換目錄到您想安裝的程式目錄，然後輸入 <command>make install</command>，接著系統便會處理剩下的動作。您編譯的每個 Port 完整原始發行版內容是動態下載的，所以您只需要有足夠的磁碟空間來編譯您想要的 Port。幾乎所有 Port 都提供已經預先編譯好的<quote>套件</quote>，您可以透過簡單的指令來安裝 (<command>pkg install</command>)，提供那些不想要自行從原始碼編譯的人使用。更多有關套件與 Port 的資訊可於 <xref linkend="ports"/> 取得。</para>
    </sect2>

    <sect2>
      <title>其他文件</title>

      <para>所有支援的 FreeBSD 版本都會在安裝程式中提供一個選項，讓您可以在初始化系統安裝的階段安裝額外的說明文件到 <filename>/usr/local/share/doc/freebsd</filename>。說明文件也可在往後隨時使用套件安裝，詳細說明於 <xref linkend="doc-ports-install-package"/>。您也可以使用任何支援 HTML 的瀏覽器進入下列 URL 檢視已安裝在本機的手冊：</para>

      <variablelist>
	<varlistentry>
	  <term>FreeBSD 使用手冊</term>

	  <listitem>
	    <para xml:lang="en"><link xlink:href="file://localhost/usr/local/share/doc/freebsd/handbook/index.html"><filename>/usr/local/share/doc/freebsd/handbook/index.html</filename></link></para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term>FreeBSD 常見問答集</term>

	  <listitem>
	    <para xml:lang="en"><link xlink:href="file://localhost/usr/local/share/doc/freebsd/faq/index.html"><filename>/usr/local/share/doc/freebsd/faq/index.html</filename></link></para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para>此外，可在下列網址找到最新版 (也是更新最頻繁的版本)：<uri xlink:href="https://www.FreeBSD.org/">https://www.FreeBSD.org/</uri>。</para>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->

<chapter version="5.0" xml:id="bsdinstall">

  <info>
    <title>安裝 FreeBSD</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Jim</firstname>
	  <surname>Mock</surname>
	</personname>

	<contrib>Restructured, reorganized, and parts rewritten
	  by </contrib>
      </author>
    </authorgroup>

    <!---
      <authorgroup>
	<author>
	  <personname>
	    <firstname>Randy</firstname>
	    <surname>Pratt</surname>
	  </personname>
	  <contrib>The sysinstall walkthrough, screenshots, and
	    general copy by </contrib>
	</author>
      </authorgroup>
    -->

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Gavin</firstname>
	  <surname>Atkinson</surname>
	</personname>

	<contrib>Updated for bsdinstall by </contrib>
      </author>

      <author xml:lang="en">
	<personname>
	  <firstname>Warren</firstname>
	  <surname>Block</surname>
	</personname>
      </author>
    </authorgroup>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Allan</firstname>
	  <surname>Jude</surname>
	</personname>

	<contrib>Updated for root-on-ZFS by </contrib>
      </author>
    </authorgroup>
  </info>

  <sect1 xml:id="bsdinstall-synopsis">
    <title>概述</title>

    <indexterm><primary>安裝</primary></indexterm>

    <para>有多種不同的方法可以執行 FreeBSD，根據所在環境，包含：</para>

    <itemizedlist>
      <listitem>
	<para>一般虛擬機映像檔，可下載並匯入到您所選擇的虛擬環境。映像檔可從 <link xlink:href="https://www.freebsd.org/where.html">Download FreeBSD</link> 頁面下載，KVM (<quote>qcow2</quote>), VMWare (<quote>vmdk</quote>), Hyper-V (<quote>vhd</quote>) 及原始裝置的映像檔都支援。這些並非安裝程式的映像檔，而是已經預先設定好 (<quote>已安裝好</quote>) 的實例，可直接使用並執行安裝後的作業。</para>
      </listitem>

      <listitem>
	<para>託管服務虛擬機映像檔，可在 Amazon 的 <link xlink:href="https://aws.amazon.com/mp/solutions/freebsd/">AWS Marketplace</link>, <link xlink:href="https://azuremarketplace.microsoft.com/en-us/marketplace/apps?search=freebsd&amp;page=1">Microsoft Azure Marketplace</link> 和 <link xlink:href="https://console.cloud.google.com/launcher/details/freebsd-cloud/freebsd-11">Google Cloud Platform</link> 等託管服務上運行的虛擬機映像檔。有關如何在 Azure 上部署 FreeBSD 的資訊可查詢 <link xlink:href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/freebsd-intro-on-azure">Azure 說明文件</link>中的相關章節。</para>
      </listitem>

      <listitem>
	<para>SD 卡映像檔，供嵌入式系統，如 Raspberry Pi 或 BeagleBone Black 使用的映像檔，可從 <link xlink:href="https://www.freebsd.org/where.html">Download FreeBSD</link> 頁面下載，這些檔案必須先解壓縮後以原始映像檔的格式寫入 SD 卡以讓這些開發電路板能夠啟動。</para>
      </listitem>

      <listitem>
	<para>安裝程式映像檔，用來安裝 FreeBSD 到硬碟，供一般的桌機、筆電或伺服器系統使用。</para>
      </listitem>
    </itemizedlist>

    <para>此章接下來的部份會介紹第四個案例，說明如何使用文字介面為基礎的安裝程式 <application>bsdinstall</application> 安裝 FreeBSD。</para>

    <para>一般來說，本章所寫的安裝說明是針對 <trademark>i386</trademark> 和 <acronym>AMD64</acronym> 架構。如果可以用於其他平台，將會列表說明。 安裝程式和本章所敘述的內容可能會有些微差異，所以請將本章視為通用的指引，而不是完全照著來做。</para>

    <note>
      <para>喜歡用圖形化安裝程式安裝 FreeBSD 的使用者， 可能會對 <application>pc-sysinstall</application> 有興趣，這是 TrueOS 計畫所使用的。 他可以用來安裝圖形化桌面 (TrueOS) 或是指令列版本的 FreeBSD。 細節請參考 TrueOS 使用者 Handbook (<link xlink:href="https://www.trueos.org/handbook/trueos.html">https://www.trueos.org/handbook/trueos.html</link>)。</para>
    </note>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>最低的硬體需求和 FreeBSD 支援的架構。</para>
      </listitem>

      <listitem>
	<para>如何建立 FreeBSD 的安裝媒體。</para>
      </listitem>

      <listitem>
	<para>如何開始執行 <application>bsdinstall</application>。</para>
      </listitem>

      <listitem>
	<para><application>bsdinstall</application> 會詢問的問題，問題代表的意思，以及如何回答。</para>
      </listitem>

      <listitem>
	<para>安裝失敗時如何做故障排除。</para>
      </listitem>

      <listitem>
	<para>如何在正式安裝前使用 live 版本的 FreeBSD。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>閱讀即將安裝的 FreeBSD 版本所附帶的硬體支援清單，並核對系統的硬體是否有支援。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="bsdinstall-hardware">
    <title>最低硬體需求</title>

    <para>安裝 FreeBSD 的硬體需求隨 FreeBSD 的版本和硬體架構而不同。 FreeBSD 發行版支援的硬體架構和裝置會列在 <link xlink:href="@@URL_RELPREFIX@@/releases/index.html">FreeBSD 發佈資訊</link> 頁面。<link xlink:href="@@URL_RELPREFIX@@/where.html">FreeBSD 下載頁面</link>
也有建議如何正確的選擇在不同架構使用的映像檔。</para>

    <para>FreeBSD 安裝程序需要至少 96 MB 的 <acronym>RAM</acronym> 以及 1.5 GB 的硬碟空間。然而，如此少的記憶體及磁碟空間只適合在客製的應用上，如嵌入式設備。一般用途的桌面系統會需要更多的資源，2-4 GB RAM 與至少 8 GB 的硬碟空間是不錯的起點。</para>

    <para>每一種架構的處理器需求概述如下：</para>

    <variablelist>
      <varlistentry>
	<term xml:lang="en">amd64</term>
	<listitem>
	  <para>桌面電腦與筆記型電腦最常見的處理器類型，運用在近代的系統。<trademark class="registered">Intel</trademark> 稱該類型為 <acronym>Intel64</acronym>，其他製造商則稱該類型為 <acronym>x86-64</acronym>。</para>

	  <para>與 amd64 相容的處理器範例包含：<trademark>AMD Athlon</trademark>64, <trademark>AMD Opteron</trademark>, 多核心 <trademark class="registered">Intel</trademark> <trademark>Xeon</trademark> 以及 <trademark class="registered">Intel</trademark> <trademark>Core</trademark> 2 與之後的處理器。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">i386</term>
	<listitem>
	  <para>舊型的桌面電腦與筆記型電腦常使用此 32-bit, x86 架構。</para>

	  <para>幾乎所有含浮點運算單元的 i386 相容處理器都有支援。所有 <trademark class="registered">Intel</trademark> 486 或是更高階的處理器也有支援。</para>

	  <para>FreeBSD 可在有支援實體位址延伸 (Physical Address Extensions, <acronym>PAE</acronym>) 功能的 <acronym>CPU</acronym> 上運用該功能所帶來的優點。有開啟 <acronym>PAE</acronym> 支援的核心會偵測超過 4 GB 的記憶體，並讓這些超過的記憶體能夠被系統使用。 但使用 <acronym>PAE</acronym> 會限制裝置驅動程式及 FreeBSD 的其他功能，詳情請見 <citerefentry><refentrytitle>pae</refentrytitle><manvolnum>4</manvolnum></citerefentry>。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">ia64</term>
	<listitem>
	  <para>目前支援的處理器是 <trademark class="registered">Itanium</trademark> 和 <trademark class="registered">Itanium</trademark> 2。支援的晶片組包括 HP zx1， <trademark class="registered">Intel</trademark> 460GX 和 <trademark class="registered">Intel</trademark> E8870。 單處理器 (Uniprocessor, <acronym>UP</acronym>) 和對稱多處理器 (Symmetric Multi-processor, <acronym>SMP</acronym>) 的設定都有支援。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">powerpc</term>
	<listitem>
	  <para>所有內建 <acronym>USB</acronym> 的 New World <acronym>ROM</acronym> <trademark class="registered">Apple</trademark> <trademark class="registered">Mac</trademark> 系統都有支援。 <acronym>SMP</acronym> 在多 <acronym>CPU</acronym> 的機器都有支援。</para>

	  <para>32 位元的核心只能使用前 2 GB 的 <acronym>RAM</acronym>。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">sparc64</term>
	<listitem>
	  <para>FreeBSD/sparc64 支援的系統列在 <link xlink:href="@@URL_RELPREFIX@@/platforms/sparc.html">FreeBSD/sparc64 計劃</link>。</para>

	  <para>所有超過一個處理器的系統都有支援 <acronym>SMP</acronym>。需要專用的磁碟系統，因為此時無法和其他作業系統共用磁碟。</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </sect1>

  <sect1 xml:id="bsdinstall-pre">
    <title>安裝前準備工作</title>

    <para>一旦確定系統符合安裝 FreeBSD 的最低硬體需求，就可以下載安裝檔案並準備安裝的媒體。 做這些之前，先檢查以下核對清單的項目是否準備好了：</para>

    <procedure>
      <step>
	<title>備份重要資料</title>

	<para>安裝任何作業系統前， <emphasis>總是</emphasis> 要先備份所有重要資料。 不要儲存備份在即將安裝的系統上，而是將資料儲存在可移除磁碟，像是 <acronym>USB</acronym> 隨身碟、網路上的另一個系統或是線上備份服務上。 開始安裝程序前要檢查備份，確定備份含有所有需要的檔案，一旦安裝程式格式化系統的磁碟，所有儲存在上面的資料都會遺失。</para>
      </step>

      <step>
	<title>決定 FreeBSD 安裝在哪裡</title>

	<para>如果 FreeBSD 是唯一一套要安裝到電腦的作業系統，這個步驟可以略過。 但是假如 FreeBSD 要和其他作業系統共用磁碟空間的話，就要決定 FreeBSD 要安裝在哪個磁碟或是哪個分割區 (Partition)。</para>

	<para>在 i386 和 amd64 架構，可將磁碟分割成多個分割區，可以選擇下列兩種分割表格式 (Partitioning scheme) 的其中一種達成。 傳統的<firstterm>主開機紀錄 (Master Boot Record, <acronym>MBR</acronym>)</firstterm> 的一個分割區表定義最多可有四個<firstterm>主分割區</firstterm> (Primary partition)，因一些歷史淵源，FreeBSD 稱這些主分割區為 <firstterm>slice</firstterm>，其中一個主分割區可作為<firstterm>延伸分割區</firstterm> (Extended partition)，延伸分割區又可分割成多個<firstterm>邏輯分割區</firstterm> (Logical partition)。 <firstterm>GUID 分割區表</firstterm> (GUID Partition Table, <acronym>GPT</acronym>) 是較新和較簡單的分割磁碟的方法，一般 <acronym>GPT</acronym> 實作允許每個磁碟多達 128 個分割區，不再需要使用邏輯分割區。</para>

	<warning>
	  <para>一些比較舊的作業系統，像是 <trademark class="registered">Windows</trademark> XP 並不相容 <acronym>GPT</acronym> 分割表格式。 如果 FreeBSD 將和這類作業系統共用一個磁碟，則需要用 <acronym>MBR</acronym> 分割表格式。</para>
	</warning>

	<para>FreeBSD 開機啟動程式需要主分割區或是 <acronym>GPT</acronym> 分割區。如果所有的主分割區或 <acronym>GPT</acronym> 分割區都已使用，必須釋放其中一個分割區讓 FreeBSD 使用。如果要建立一個分割區而不刪除原有的資料，可以使用磁碟重設大小的工具來縮小現有的分割區，並使用釋放出來的空間建立新分割區。</para>

	<para>各種免費和付費的磁碟重設大小工具列於 <link xlink:href="http://en.wikipedia.org/wiki/List_of_disk_partitioning_software">http://en.wikipedia.org/wiki/List_of_disk_partitioning_software</link>。<application>GParted Live</application> (<link xlink:href="http://gparted.sourceforge.net/livecd.php">http://gparted.sourceforge.net/livecd.php</link>) 是內含分割區編輯程式 <application>GParted</application> 的免費 Live <acronym>CD</acronym>。 GParted 同時也被許多 Linux Live <acronym>CD</acronym> 發行版所收錄。</para>

	<warning>
	  <para>在正確使用的情況下，磁碟重設大小的工具可以安全的建立讓新的分割區使用的空間。 但因仍有可能會誤選已經存在的分割區，所以在修改磁碟分割區前， 一定要備份重要資料，並確認備份的完整性。</para>
	</warning>

	<para>在磁碟分割區中儲存不同的作業系統讓一台電腦可以安裝多個作業系統，另一種作法是使用虛擬化技術 (<xref linkend="virtualization"/>) ，可讓多個作業系統同時間執行而不需要改變任何磁碟分割區。</para>
      </step>

      <step>
	<title>收集網路資訊</title>

	<para>部份 FreeBSD 安裝方式需要網路連線來下載安裝檔，因此之後的安裝程序，安裝程式進入設定系統網路的介面。</para>

	<para>如果網路中有 <acronym>DHCP</acronym> 伺服器，則可透過該伺服器自動設定網路，若無法使用 <acronym>DHCP</acronym>，則需要從區域網路管理者或是網際網路服務供應商 (Internet Service Provider, ISP) 取得以的網路資訊供系統使用：</para>

	<orderedlist xml:id="bsdinstall-collect-network-information">
	  <title>需要的網路資訊</title>

	  <listitem>
	    <para><acronym>IP</acronym> 位址</para>
	  </listitem>

	  <listitem>
	    <para>子網路遮罩</para>
	  </listitem>

	  <listitem>
	    <para>預設通訊閘 <acronym>IP</acronym> 位址</para>
	  </listitem>

	  <listitem>
	    <para>網路的網域名稱</para>
	  </listitem>

	  <listitem>
	    <para>網路 <acronym>DNS</acronym> 伺服器 <acronym>IP</acronym> 位址</para>
	  </listitem>
	</orderedlist>
      </step>

      <step>
	<title>檢查 FreeBSD 勘誤表</title>

	<para>儘管 FreeBSD 計劃努力確保每個 FreeBSD 發行版能夠儘可能地穩定，但臭蟲偶爾還是會悄悄出現，並有極小的可能會發生影響安裝流程的錯誤，當這些問題被發現並修正後，會被紀錄在 FreeBSD 網站的 FreeBSD 勘誤表 (<link xlink:href="@@URL_RELPREFIX@@/releases/12.0R/errata.html">https://www.freebsd.org/releases/12.0R/errata.html</link>)。 安裝前先檢查勘誤表，以確保沒有會影響到安裝的問題。</para>

	<para>所有發行版的資訊和勘誤表可以在 FreeBSD 網站的發行資訊找到 (<link xlink:href="@@URL_RELPREFIX@@/releases/index.html">https://www.freebsd.org/releases/index.html</link>)。</para>
      </step>
    </procedure>

    <sect2 xml:id="bsdinstall-installation-media">
      <title>準備安裝的媒體</title>

      <para>FreeBSD 安裝程式並不是一個可以在其他作業系統上執行的應用程式，反而您需要下載 FreeBSD 安裝檔，燒錄安裝檔到符合其檔案類型與大小的媒體 (<acronym>CD</acronym>, <acronym>DVD</acronym> 或 <acronym>USB</acronym>)，然後開機從插入的媒體來安裝。</para>

      <para>FreeBSD 的安裝檔可於 <link xlink:href="@@URL_RELPREFIX@@/where.html#download">www.freebsd.org/where.html#download</link> 取得。安裝檔的名稱由 FreeBSD 發佈版本、架構、以及檔案類型所組成，舉例，要從 <acronym>DVD</acronym> 安裝 FreeBSD 10.2 到 amd64 的系統，需下載 <filename>FreeBSD-10.2-RELEASE-amd64-dvd1.iso</filename>，並燒錄這個檔案到 <acronym>DVD</acronym>，然後使用插入 <acronym>DVD</acronym> 來開機。</para>

      <para>安裝檔有許多種可用的格式，格式會依據電腦架構及媒體類型的不同而異。</para>

      <para xml:id="bsdinstall-installation-media-uefi">還有另一種安裝檔是給使用 <acronym>UEFI</acronym> (Unified Extensible Firmware Interface) 開機的電腦使用，這些安裝檔的名稱會含有 <filename>uefi</filename>。</para>

      <para>檔案類型：</para>

      <itemizedlist>
	<listitem>
	  <para><literal>-bootonly.iso</literal>：這是最精簡的安裝檔，檔案中只含安裝程式。 安裝時需要網際網路連線來下載所需的檔案以完成 FreeBSD 安裝。這個檔案應使用 <acronym>CD</acronym> 燒錄應用程式燒錄到 <acronym>CD</acronym> 使用。</para>
	</listitem>

	<listitem>
	  <para><literal>-disc1.iso</literal>：這個檔案含有所有安裝 FreeBSD 所需的檔案，包含原始碼及 Port 套件集。這個檔案應使用 <acronym>CD</acronym> 燒錄應用程式燒錄到 <acronym>CD</acronym> 使用。</para>
	</listitem>

	<listitem>
	  <para><literal>-dvd1.iso</literal>：這個檔案含有所有安裝 FreeBSD 所需的檔案，包含原始碼及 Port 套件集，也內含熱門的 Binary 套件可安裝視窗管理程式以及一些應用程式，如此便可從媒體安裝完整的系統，無須連線到網際網路。這個檔案應使用 <acronym>DVD</acronym> 燒錄應用程式燒錄到 <acronym>DVD</acronym> 使用。</para>
	</listitem>

	<listitem>
	  <para><literal>-memstick.img</literal>：這個檔案含有所有安裝 FreeBSD 所需的檔案，包含原始碼及 Port 套件集。這個檔案應依據以下操作指示寫入到 <acronym>USB</acronym> 隨身碟使用。</para>
	</listitem>

	<listitem>
	  <para><literal>-mini-memstick.img</literal>：類似 <literal>-bootonly.iso</literal>，但不含安裝檔 (可依所要下載)，安裝時需要網際網路連線，可依 <xref linkend="bsdinstall-usb"/> 的說明將此檔案寫入至 <acronym>USB</acronym> 隨身碟。</para>
	</listitem>
      </itemizedlist>

      <para>映像檔下載完成之後，下載同一個目錄之中的 <filename>CHECKSUM.SHA256</filename>。FreeBSD 提供 <citerefentry><refentrytitle>sha256</refentrytitle><manvolnum>1</manvolnum></citerefentry> 可用來計算映像檔的 <firstterm>校驗碼 (Checksum)</firstterm>，使用方式為 <command>sha256 <replaceable>imagefilename</replaceable></command>，其他作業系統也會有類似的程式。</para>

      <para>比對計算後的校驗碼與 <filename>CHECKSUM.SHA256</filename> 檔案中的值，校驗碼應該要完全相符，若校驗碼不相符，則代表該映像檔是損壞的，必須再下載一次。</para>

      <sect3 xml:id="bsdinstall-usb">
	<title>寫入映象檔到 <acronym>USB</acronym></title>

	<para><filename>*.img</filename> 檔案是隨身碟的完整內容的<emphasis>映像檔 (image)</emphasis>，該檔案<emphasis>不能</emphasis>直接用檔案的方式複製到目標裝置。有許多應用程式可用來寫入 <filename>*.img</filename> 到 <acronym>USB</acronym> 隨身碟，本節會介紹其中兩種。</para>

	<important>
	  <para>在繼續之前，請先備份 <acronym>USB</acronym> 上的重要資料，這個程序會清除在隨身碟上既有的資料。</para>
	</important>

	<procedure xml:id="bsdinstall-usb-dd">
	  <title>使用 <command>dd</command> 來寫入映像檔</title>

	  <warning>
	    <para>本範例使用 <filename>/dev/da0</filename> 做為目標裝置，是映像檔將會寫入的位置。 務必<emphasis>十分小心</emphasis>確認要使用的裝置正確，因為這個指示會摧毀所有在指定目標裝置上已存在的資料。</para>
	  </warning>

	  <step>
	    <para><citerefentry><refentrytitle>dd</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令列工具在 BSD, <trademark class="registered">Linux</trademark> 以及<trademark class="registered">Mac OS</trademark> 系統皆可使用。要使用 <command>dd</command> 燒錄映像檔需先插入 <acronym>USB</acronym> 隨身碟，然後確認隨身碟的裝置名稱。然後指定已下載的安裝檔名稱以及 <acronym>USB</acronym> 隨身碟的裝置名稱。本例示範在已有的 FreeBSD 系統燒錄 amd64 安裝映像檔到第一個 <acronym>USB</acronym> 裝置。</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>dd if=<replaceable>FreeBSD-10.2-RELEASE-amd64-memstick.img</replaceable> of=/dev/<replaceable>da0</replaceable> bs=1M conv=sync</userinput></screen>

	    <para>若這個指示執行失敗，請確認 <acronym>USB</acronym> 隨身碟是否還未掛載，以及該裝置名稱是否指向這個隨身碟，而不是一個分割區。有些作業系統可能需要使用 <citerefentry><refentrytitle>sudo</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來執行這個指令。且 <citerefentry><refentrytitle>dd</refentrytitle><manvolnum>1</manvolnum></citerefentry> 的指令語法在不同的作業系統上有些不同，例如在 <trademark class="registered">Mac OS</trademark> 需要使用小寫的 <option>bs=1m</option>，而在 <trademark class="registered">Linux</trademark> 這類的系統可能會暫存寫入動作，要強制完成所有寫入動作，需使用 <citerefentry><refentrytitle>sync</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</para>
	  </step>
	</procedure>

	<procedure>
	  <title>使用 <trademark class="registered">Windows</trademark> 來寫入映象檔</title>

	  <warning>
	    <para>務必確認指定的磁碟機代號正確，因在指定磁碟機上的既有資料將會被覆蓋與摧毀。</para>
	  </warning>

	  <step>
	    <title>取得 <application>Image Writer <trademark class="registered">Windows</trademark> 版</application></title>

	    <para><application>Image Writer <trademark class="registered">Windows</trademark> 版</application> 是一個免費的應用程式，可以正確地將映像檔寫入隨身碟。可從 <uri xlink:href="https://sourceforge.net/projects/win32diskimager/">https://sourceforge.net/projects/win32diskimager/</uri> 下載，並解壓縮到一個資料夾。</para>
	  </step>

	  <step>
	    <title>用 Image Writer 寫入映象檔</title>

	    <para>雙擊 <application>Win32DiskImager</application> 圖示啟動程式。 確認 <computeroutput>Device</computeroutput> 顯示的磁碟機代號是隨身碟的磁碟機代號。 按下資料夾圖示選擇要寫入隨身碟的映像檔。 按下 <guibutton>[ Save ]</guibutton> 按鈕確定映像檔名。 確認所有東西都正確，隨身碟的資料夾並沒有在其他視窗開啟。 所有東西準備好後，按下 <guibutton>[ Write ]</guibutton> 將映像檔寫入隨身碟。</para>
	  </step>
	</procedure>

	<para>您現在可以開始安裝 FreeBSD 。</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="bsdinstall-start">
    <title>開始安裝</title>

    <important>
      <para>預設安裝程序在下列訊息顯示之前不會對磁碟做任何更動：</para>

      <programlisting xml:lang="en">Your changes will now be written to disk.  If you
have chosen to overwrite existing data, it will
be PERMANENTLY ERASED. Are you sure you want to
commit your changes?</programlisting>

      <para>在這個警告訊息之前可以隨時中止安裝，若有任何設定錯誤的疑慮，只需在此時關閉電腦，將不會對系統磁碟做任何更改。</para>
    </important>

    <para>本節將介紹如何使用根據 <xref linkend="bsdinstall-installation-media"/> 指示所準備的安裝媒體來開機。要使用可開機的 USB，請在開啟電腦前插入 <acronym>USB</acronym> 隨身碟。要使用 <acronym>CD</acronym> 或 <acronym>DVD</acronym>，則可開啟電腦後在第一時間插入媒體。如何設定系統使用插入的媒體開機依不同的系統架構會有所不同。</para>

    <sect2 xml:id="bsdinstall-starting-i386">
      <title>在 <trademark>i386</trademark> 及 amd64 開機</title>

      <para>這兩種架構提供了 <acronym>BIOS</acronym> 選單可選擇開機的裝置，依據要使用的安裝媒體類型，選擇 <acronym>CD</acronym>/<acronym>DVD</acronym> 或 <acronym>USB</acronym> 裝置做為第一個開機裝置。大多數的系統也會提供快速鍵可在啟動時選擇開機裝置，而不需要進入<acronym>BIOS</acronym>，通常這個按鍵可能是 <keycap>F10</keycap>, <keycap>F11</keycap>, <keycap>F12</keycap> 或 <keycap>Escape</keycap> 其中之一。</para>

      <para>若電腦仍載入了現有的作業系統，而不是 FreeBSD 安裝程式，原因可能為：</para>

      <orderedlist>
	<listitem>
	  <para>執行開機程序時安裝媒體插入主機的時間不夠早，請讓安裝媒體留在電腦中並重新啟動電腦。</para>
	</listitem>

	<listitem>
	  <para>未正確修改 <acronym>BIOS</acronym> 或未儲檔，請再三檢查第一個開機裝置選擇了正確的裝置。</para>
	</listitem>

	<listitem>
	  <para>系統太舊，無法支援使用選擇的開機媒體開機，發生這個情況可以使用 <application>Plop Boot Manager</application> (<link xlink:href="http://www.plop.at/en/bootmanagers.html"/>) 來從選擇的開機媒體開機。</para>
	</listitem>
      </orderedlist>
    </sect2>

    <sect2>
      <title>在 <trademark class="registered">PowerPC</trademark> 開機</title>

      <para>在大部份機型，可於開機時按住鍵盤上的 <keycap>C</keycap>，便可從 <acronym>CD</acronym> 開機。若在非 <trademark class="registered">Apple</trademark> 的鍵盤則可按住 <keycombo action="simul"> <keycap>Command</keycap> <keycap>Option</keycap> <keycap>O</keycap> <keycap>F</keycap> </keycombo> 或 <keycombo action="simul"> <keycap>Windows</keycap> <keycap>Alt</keycap> <keycap>O</keycap> <keycap>F</keycap> </keycombo>，出現 <prompt>0 &gt;</prompt> 提示時，輸入</para>

      <screen xml:lang="en"><userinput>boot cd:,\ppc\loader cd:0</userinput></screen>
    </sect2>

    <sect2>
      <title>在 <trademark class="registered">SPARC64</trademark> 開機</title>

      <para>大多數 <trademark class="registered">SPARC64</trademark> 系統會自動從磁碟開機，要從 <acronym>CD</acronym> 安裝 FreeBSD 需要進入 <acronym>PROM</acronym>。</para>

      <para>要進入 <acronym>PROM</acronym>，需重新開機系統然後等候開機訊息出現。訊息會依機型而有所不同，但大致結果會如：</para>

      <screen xml:lang="en">Sun Blade 100 (UltraSPARC-IIe), Keyboard Present
Copyright 1998-2001 Sun Microsystems, Inc.  All rights reserved.
OpenBoot 4.2, 128 MB memory installed, Serial #51090132.
Ethernet address 0:3:ba:b:92:d4, Host ID: 830b92d4.</screen>

      <para>若系統繼續從磁碟開機，此時按下鍵盤上的 <keycombo action="simul"><keycap>L1</keycap><keycap>A</keycap></keycombo> 或 <keycombo action="simul"><keycap>Stop</keycap><keycap>A</keycap></keycombo> 或透過序列 Console 送出 <command>BREAK</command>。當使用 <application>tip</application> 或 <application>cu</application>, <command>~#</command> 發出一個 BREAK 後，<acronym>PROM</acronym> 的提示會在單 <acronym>CPU</acronym> 的系統出現 <prompt>ok</prompt>，<acronym>SMP</acronym> 的系統出現 <prompt>ok {0} </prompt>，其中的數字代表啟動的 <acronym>CPU</acronym> 數。</para>

      <para>此時，放入 <acronym>CD</acronym> 到磁碟機然後在 <acronym>PROM</acronym> 提示畫面輸入 <command>boot cdrom</command>。</para>
    </sect2>

    <sect2 xml:id="bsdinstall-view-probe">
      <title>FreeBSD 開機選單</title>

      <para>從安裝媒體開機之後，會顯示如下的選單：</para>

      <figure xml:id="bsdinstall-newboot-loader-menu">
	<title>FreeBSD 開機載入程式選單</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-newboot-loader-menu"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>預設在開機進入 FreeBSD 安裝程式前選單會等候使用者輸入 10 秒鐘，若已經安裝 FreeBSD，則會在開機進入 FreeBSD 前等候。要暫停開機計時器來仔細查看選項，請按 <keycap>Space</keycap> 鍵。要選擇選項，按下明顯標示的數字、字元或按鍵。選單有以下選項可選。</para>

      <itemizedlist>
	<listitem>
	  <para>啟動多使用者模式 (<literal>Boot Multi User</literal>)：這個選項會繼續 FreeBSD 開機程序，若開機計時器已經暫停，可按 <keycap>1</keycap>、大寫或小寫 <keycap>B</keycap> 或 <keycap>Enter</keycap> 鍵。</para>
	</listitem>

	<listitem>
	  <para>啟動單使用者模式 (<literal>Boot Single User</literal>)：這個模式用來修正已安裝的 FreeBSD，如 <xref linkend="boot-singleuser"/> 所述。可按 <keycap>2</keycap>、大寫或小寫 <keycap>S</keycap> 進入這個模式。</para>
	</listitem>

	<listitem>
	  <para>離開到載入程式提示 (<literal>Escape to loader prompt</literal>)：這個選項會開機進入修復提示，這個模式含有有限數量的低階指令，這個模式詳細說明於 <xref linkend="boot-loader"/>。可按 <keycap>3</keycap> 或 <keycap>Esc</keycap> 進入這個提示。</para>
	</listitem>

	<listitem>
	  <para>重新開機 (<literal>Reboot</literal>)：重新開啟系統。</para>
	</listitem>

	<listitem>
	  <para>設定開機選項 (<literal>Configure Boot Options</literal>)：開啟內部選單，詳細說明於 <xref linkend="bsdinstall-boot-options-menu"/>。</para>
	</listitem>
      </itemizedlist>

      <figure xml:id="bsdinstall-boot-options-menu">
	<title>FreeBSD 開機選項選單</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-boot-options-menu"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>開機選項選單分成兩個部份。第一個部份用來返回主開機選單或重設任何已切換的選項回預設值。</para>

      <para>第二個部份用來切換可用的選項為開 (<literal>On</literal>) 或關 (<literal>Off</literal>)，透過按下選項明顯標示的編號或字元。系統將會一直使用這些選項開機，直到選項被修改。有數個選項可以在這個選單做切換：</para>

      <itemizedlist>
	<listitem>
	  <para>ACPI 支援 (<literal>ACPI Support</literal>)：若系統在開機時卡住，可嘗試切換這個選項為關 (<literal>Off</literal>)。</para>
	</listitem>

	<listitem>
	  <para>安全模式 (<literal>Safe Mode</literal>)：若系統在 ACPI 支援 (<literal>ACPI Support</literal>) 設為關 (<literal>Off</literal>) 時開機時仍然會卡住，可嘗試將此選項設為開 (<literal>On</literal>)。</para>
	</listitem>

	<listitem>
	  <para>單使用者 (<literal>Single User</literal>)：切換這個選項為開 (<literal>On</literal>) 來修正已存在的 FreeBSD 如 <xref linkend="boot-singleuser"/> 所述，問題修正後，將其設回關 (<literal>Off</literal>)。</para>
	</listitem>

	<listitem>
	  <para>詳細資訊 (<literal>Verbose</literal>)：切換這個選項為開 (<literal>On</literal>) 來查看開機程序中更詳細的訊息，這在診斷硬體問題時非常有用。</para>
	</listitem>
      </itemizedlist>

      <para>在做完所需的選擇後，按下 <keycap>1</keycap> 或 <keycap>Backspace</keycap> 返回主開機選單，然後按下 <keycap>Enter</keycap> 繼續開機進入 FreeBSD。FreeBSD 執行裝置偵測及載入安裝程式時會顯示一系列的開機訊息，開機完成之後，會顯示歡迎選單如 <xref linkend="bsdinstall-choose-mode"/>。</para>

      <figure xml:id="bsdinstall-choose-mode">
	<title>歡迎選單</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-choose-mode"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>按下 <keycap>Enter</keycap> 選擇預設的 <guibutton>[ Install ]</guibutton> 進入安裝程式，接下來本章將介紹如何使用這個安裝程式。 若要選擇其他項目，可使用右或左方向鍵或顏色標示的字母選擇想要的選單項目。<guibutton>[ Shell ]</guibutton> 可用來進入 FreeBSD 的 Shell 使用指令列工具在安裝之前準備磁碟。<guibutton>[ Live CD ]</guibutton> 選項可用來在安裝之前試用 FreeBSD，Live 版本的詳細說明於 <xref linkend="using-live-cd"/>。</para>

      <tip>
	<para>要重新檢視開機訊息，包含硬體裝置偵測，請按大寫或小寫 <keycap>S</keycap> 然後再按 <keycap>Enter</keycap> 進入 Shell。在 Shell 提示之後輸入 <command>more /var/run/dmesg.boot</command> 然後使用空白鍵來捲動訊息。當查看完畢後輸入 <command>exit</command> 返回歡迎選單。</para>
      </tip>
    </sect2>
  </sect1>

  <sect1 xml:id="using-bsdinstall">
    <title>使用 <application>bsdinstall</application></title>

    <para>本節將告訴您在系統安裝之前 <application>bsdinstall</application> 選單的順序以及會詢問的資訊類型，可使用方向鍵來選擇選單的選項，然後按下 <keycap>Space</keycap> 選擇或取消選擇選單項目。當完成之後，按下 <keycap>Enter</keycap> 儲存選項然後進入下一個畫面。</para>

    <sect2 xml:id="bsdinstall-keymap">
      <title>選擇鍵盤對應表選單</title>

      <para>依據使用的系統 Console，<application>bsdinstall</application> 可能一開始顯示的選單會如 <xref linkend="bsdinstall-keymap-select-default"/>。</para>

      <figure xml:id="bsdinstall-keymap-select-default">
	<title>鍵盤對應表選擇</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-keymap-select-default"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>要設定鍵盤配置，請選擇 <guibutton>[ YES ]</guibutton> 按下 <keycap>Enter</keycap>，接著會顯示選單如 <xref linkend="bsdinstall-config-keymap"/>。若要使用預設的配置，則可使用方向鍵選擇 <guibutton>[ NO ]</guibutton> 然後按下 <keycap>Enter</keycap> 跳過這個選單畫面。</para>

      <figure xml:id="bsdinstall-config-keymap">
	<title>選擇鍵盤選單</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-config-keymap"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>設定鍵盤配置時，可使用上與下方向鍵來選擇最接近已連接到系統的鍵盤的鍵盤對應表 (Keymap)，然後按下 <keycap>Enter</keycap> 儲存選項。</para>

      <note>
	<para>按 <keycap>Esc</keycap> 會離開這個選單然後使用預設的鍵盤對應表，若不清楚要使用那種鍵盤對應表，<guimenuitem>United States of America ISO-8859-1</guimenuitem> 是也是保險的選項。</para>
      </note>

      <para>在 FreeBSD 10.0-RELEASE 以及之後的版本，已經加強了這個選單，會顯示完整的鍵盤對應表選項，並預先選擇預設值。另外，當選擇其他鍵盤對應用時，在繼續之前會顯示對話框讓使用者測試鍵盤對應表來確認。</para>

      <figure xml:id="bsdinstall-keymap-10">
	<title>改進後的鍵盤對應表選單</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-keymap-10"/>
	  </imageobject>
	</mediaobject>
      </figure>

    </sect2>

    <sect2 xml:id="bsdinstall-hostname">
      <title>設定主機名稱</title>

      <para>下一個 <application>bsdinstall</application> 選單用來為新安裝的系統設定主機名稱。</para>

      <figure xml:id="bsdinstall-config-hostname">
	<title>設定主機名稱</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-config-hostname"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>輸入在網路上獨一無二的主機名稱，主機名稱要是完整的主機名稱，如 <systemitem class="fqdomainname">machine3.example.com</systemitem>。</para>
    </sect2>

    <sect2 xml:id="bsdinstall-components">
      <title>選擇要安裝的元件</title>

      <para>接下來 <application>bsdinstall</application> 會提示選擇要安裝的選用元件。</para>

      <figure xml:id="bsdinstall-config-components">
	<title>選擇要安裝的元件</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-config-components"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>決定要安裝的元件主要會根據系統的用途以及可用的磁碟空間容量。FreeBSD 核心 (Kernel) 及 Userland 統稱為 <firstterm>基礎系統 (Base system)</firstterm>，是必須安裝的部份。依據系統的架構，部份元件可能不會顯示：</para>

      <itemizedlist>
	<listitem>
	  <para><literal>doc</literal> - 額外的說明文件，大部份是經年累月的產物，會安裝到 <filename>/usr/share/doc</filename>。由 FreeBSD 文件計劃所提供的說明文件可在之後安裝，依照 <xref linkend="updating-upgrading-documentation"/> 中的指示操作。</para>
	</listitem>

	<listitem>
	  <para><literal>games</literal> - 數個傳統 <acronym>BSD</acronym> 遊戲，包含 <application>fortune</application>, <application>rot13</application> 以及其他。</para>
	</listitem>

	<listitem>
	  <para><literal>lib32</literal> - 在 64-bit 版本的 FreeBSD 供執行 32-bit 應用程式使用的相容性程式庫。</para>
	</listitem>

	<listitem>
	  <para><literal>ports</literal> - FreeBSD Port 套件集是一套可自動下載、編譯安裝第三方軟體套件的集合，<xref linkend="ports"/> 中會討論到如何使用 Port 套件集。</para>

	  <warning>
	    <para>安裝程式並不會檢查是否有充足的磁碟空間，FreeBSD Port 套件集會使用約 500 MB 的磁碟空間，只有在有足夠的磁碟空間時才選擇這個選項。</para>
	  </warning>
	</listitem>

	<listitem>
	  <para><literal>src</literal> - 完整的 FreeBSD 原始碼，包含核心 (Kernel) 與 Userland。雖然大多數的應用程式並不需要，但它可以編譯裝置驅動程式、核心模組或部份來自 Port 套件集的應用程式，它同時也用來做為開發 FreeBSD 本身所使用。完整的原始碼樹需要 1 GB 的磁碟空間，重新編譯整個 FreeBSD 系統需要額外再 5 GB 的空間。</para>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="bsdinstall-netinstall">
      <title>從網路安裝</title>

      <para>於 <xref linkend="bsdinstall-netinstall-notify"/> 所示的選單只會在使用 <filename>-bootonly.iso</filename> <acronym>CD</acronym> 安裝時顯示，因這個安裝媒體中並未含安裝檔的複本。由於安裝檔必須透過網路下載，此選單會告知要先設定網路介面。</para>

      <figure xml:id="bsdinstall-netinstall-notify">
	<title>從網路安裝</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-netinstall-files"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>要設定網路連線，按下 <keycap>Enter</keycap> 然後依照 <xref linkend="bsdinstall-config-network-dev"/> 中的指示操作，完成網路介面的設定之後，選擇與要安裝 FreeBSD 的電腦相同所在地區的鏡像站，當鏡像站越接近目標電腦，檔案下載的速度會比較快，這會減少安裝的時間。</para>

      <figure xml:id="bsdinstall-netinstall-mirror">
	<title>選擇鏡像站</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-netinstall-mirrorselect"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>若在本機的安裝媒體中找到安裝檔案，安裝程序便會繼續。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="bsdinstall-partitioning">
    <title>配置磁碟空間</title>

    <para>接下來的選單用來決定配置磁碟空間的方式。</para>

    <figure xml:id="bsdinstall-zfs-partmenu">
      <title>FreeBSD 10.x 或更新版本的磁碟分割選項</title>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="bsdinstall/bsdinstall-zfs-partmenu"/>
	</imageobject>
      </mediaobject>
    </figure>

    <para>引導式 (<literal>Guided</literal>) 磁碟分割會自動設定磁碟的分割區 (Partition)，手動 (<literal>Manual</literal>) 磁碟分割可讓進階的使用者使用選單項目建立自訂的分割區，而 <literal>Shell</literal> 會開啟 Shell 提示讓進階的使用者可以使用指示列工具如 <citerefentry><refentrytitle>gpart</refentrytitle><manvolnum>8</manvolnum></citerefentry>, <citerefentry><refentrytitle>fdisk</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>bsdlabel</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來建立自訂的分割區。<literal>ZFS</literal> 磁碟分割只在 FreeBSD 10 及之後的版本可以使用，可建立選擇性加密的 root-on-ZFS 系統並支援 <firstterm>開機環境 (Boot environment)</firstterm>。</para>

    <para>本節會介紹在配置磁碟分割時需要考量那些事情，並且會示範各種磁碟分割的方式。</para>

    <sect2 xml:id="configtuning-initial">
      <title>規劃分割區配置</title>

      <indexterm><primary>分割區配置</primary></indexterm>
      <indexterm xml:lang="en">
	<primary><filename>/etc</filename></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><filename>/var</filename></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><filename>/usr</filename></primary>
      </indexterm>

      <para>配置檔案系統時要記得硬碟的資料傳輸的速度外軌較內軌快，因此較小且大量存取的檔案系統應要較接近磁碟的外軌，而較大的分割區如 <filename>/usr</filename> 應放置在磁碟較內部，建議建立分割區的順序如下：<filename>/</filename>, swap, <filename>/var</filename> 然後 <filename>/usr</filename>。</para>

      <para>機器預期的用途會反映到 <filename>/var</filename> 分割區的大小，這個分割區用來保存郵件 (Mailbox)、日誌檔 (Log file) 及印表機緩衝 (Spool)。依使用者數及保存的期間，郵件及日誌檔可能成長到無法預期的大小，一般來說大部份的使用很少會在 <filename>/var</filename> 需要超過 1 GB 的可用磁碟空間。</para>

      <note>
	<para>有時在 <filename>/var/tmp</filename> 會需要較多的空間，當新軟體安裝，套件工具會從套件中取出暫存的複本置於 <filename>/var/tmp</filename>。若在 <filename>/var/tmp</filename> 沒有足夠的空間，要安裝大型軟體套件，例如 <application>Firefox</application>, <application>Apache OpenOffice</application> 或 <application>LibreOffice</application> 會很困難。</para>
      </note>

      <para><filename>/usr</filename> 分割區保存了許多支持系統運作的檔案，包含 FreeBSD Port 套件集以及系統原始碼，這個分割區建議至少要有 2 GB 的空間。</para>

      <para>在規劃分割區大小時，請牢記空間需求，當因某個分割區空間不足時要改使用其他分割區時會很麻煩。</para>

      <indexterm xml:lang="en">
	<primary>swap sizing</primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>swap partition</primary>
      </indexterm>

      <para>根據經驗，交換分割區應為是實體記憶體 (<acronym>RAM</acronym>) 的兩倍。使用最低需求的 <acronym>RAM</acronym> 來運作的系統會需要更多的交換空間來取得更好的表現。配置太小的交換交間可能導致 <acronym>VM</acronym> 分頁掃描碼效率不佳，且往後增加更多記憶體時可能會產生問題。</para>

      <para>在有數個 <acronym>SCSI</acronym> 磁碟或數個 <acronym>IDE</acronym> 磁碟在不同控制器的大型系統建議在每個磁碟機上都設定交換空間，最多可至四個磁碟機。每個交換分割區的大小應接近相同。核心雖可以處以任意大小的交換空間，但內部資料結構擴充到 4 倍的最大交換分割區大小時，讓交換分割區擁有相同的大小可以讓核心可以最佳的方式串連各個磁碟的交換空間。規劃較大交換空間是可以的，即使沒有使用到多少交換空間，這也會讓要從失控的程式恢復運作更容易，而不需強制重新啟動系統。</para>

      <para>正確的做磁碟分割，可以區隔頻繁寫入所產生的資料碎片與經常讀取的分割區，將寫入頻繁的分割區放在磁碟的邊緣可以增加 <acronym>I/O</acronym> 效率。雖然較大的分割區可能也需要增加 <acronym>I/O</acronym> 效率，但將這些分割區往磁碟邊緣移動所增加的效率並不會比將 <filename>/var</filename> 移到磁碟邊緣所增加的效率來的顯著。</para>
    </sect2>

    <sect2 xml:id="bsdinstall-part-guided">
      <title>引導式磁碟分割</title>

      <para>當選擇這個方法，選單上會顯示可用的磁碟，若電腦有安裝多個磁碟，則需選擇其中一個來安裝 FreeBSD。</para>

      <figure xml:id="bsdinstall-part-guided-disk">
	<title>自多個磁碟選擇</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-part-guided-disk"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>選擇磁碟之後，接下來選單會提示是否要安裝到整個磁碟或是使用剩餘的空間建立新的分割區。若選擇 <guibutton>[ Entire Disk ]</guibutton>，會自動建立通用的分割區配置來填滿整個磁碟。選擇 <guibutton>[ Partition ]</guibutton> 則會使用磁碟上未使用的空間來建立分割區配置。</para>

      <figure xml:id="bsdinstall-part-entire-part">
	<title>選擇完整磁碟或分割區</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-part-entire-part"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>分割區配置建立完成之後，再檢查一次確定是否符合安裝的需求。選擇 <guibutton>[ Revert ]</guibutton> 會重設分割區回復為原來的設定值，選擇 <guibutton>[ Auto ]</guibutton> 會重新建立自動配置的 FreeBSD 分割區。分割區也可以手動建立、修改或刪除。當確認磁碟分割正確之後，選擇 <guibutton>[ Finish ]</guibutton> 繼續安裝。</para>

      <figure xml:id="bsdinstall-part-review">
	<title>確認已建立的分割區</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-part-review"/>
	  </imageobject>
	</mediaobject>
      </figure>
    </sect2>

    <sect2 xml:id="bsdinstall-part-manual">
      <title>手動磁碟分割</title>

      <para>選擇這個方法會開啟分割區編輯程式：</para>

      <figure xml:id="bsdinstall-part-manual-create">
	<title>手動建立分割區</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-part-manual-create"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>選擇要安裝的磁碟機 (在這個例子為 <filename>ada0</filename>) 然後選擇 <guibutton>[ Create ]</guibutton> 會以選單顯示可用的分割表格式 (Partition scheme)：</para>

      <figure xml:id="bsdinstall-part-manual-partscheme">
	<title>手動建立分割區</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-part-manual-partscheme"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>amd64 電腦最適合的選擇通常是 <acronym>GPT</acronym>，無法相容 <acronym>GPT</acronym> 的舊電腦則應使用 <acronym>MBR</acronym>。而其他分割表格式一般會用在那些較罕見或較舊的電腦上。</para>

      <table frame="none" rowsep="1" pgwide="1">
	<title>磁碟分割表格式</title>

	<tgroup cols="2" align="left">
	  <thead>
	    <row>
	      <entry align="left">縮寫</entry>
	      <entry align="left">說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">APM</entry>
	      <entry>Apple Partition Map，用於 <trademark class="registered">PowerPC</trademark>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">BSD</entry>
	      <entry>無 <acronym>MBR</acronym> 的 <acronym>BSD</acronym> 標籤，因非 <acronym>BSD</acronym> 的磁碟工具可能無法辨識該標籤，有時被稱做 <firstterm>危險專用模式 (Dangerously dedicated mode)</firstterm>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">GPT</entry>
	      <entry>GUID 分割區表 (<link xlink:href="http://en.wikipedia.org/wiki/GUID_Partition_Table">http://en.wikipedia.org/wiki/GUID_Partition_Table</link>)。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">MBR</entry>
	      <entry>主開機記錄 (<link xlink:href="http://en.wikipedia.org/wiki/Master_boot_record">http://en.wikipedia.org/wiki/Master_boot_record</link>)。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">PC98</entry>
	      <entry>使用 <acronym>MBR</acronym> 改編，用於 NEC PC-98 電腦 (<link xlink:href="http://en.wikipedia.org/wiki/Pc9801">http://en.wikipedia.org/wiki/Pc9801</link>)。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">VTOC8</entry>
	      <entry>Volume Table Of Contents，用於 Sun SPARC64 及 UltraSPARC  電腦。</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>選擇完分割區表格式並建立之後，再選擇 <guibutton>[ Create ]</guibutton> 一次來建立分割區。<keycap>Tab</keycap> 鍵可用來在欄位間移動游標。</para>

      <figure xml:id="bsdinstall-part-manual-addpart">
	<title>手動建立分割區</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-part-manual-addpart"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>標準的 FreeBSD <acronym>GPT</acronym> 安裝會使用至少三種分割區：</para>

      <itemizedlist>
	<listitem>
	  <para><literal>freebsd-boot</literal> - 儲存 FreeBSD 開機程式 (Boot code)。</para>
	</listitem>

	<listitem>
	  <para><literal>freebsd-ufs</literal> - FreeBSD 的 <acronym>UFS</acronym> 檔案系統。</para>
	</listitem>

	<listitem>
	  <para><literal>freebsd-swap</literal> - FreeBSD 交換空間。</para>
	</listitem>
      </itemizedlist>

      <para>另一個值得注意的分割區類型是 <literal>freebsd-zfs</literal>，這個分割區用來放置 FreeBSD <acronym>ZFS</acronym> 檔案系統 (<xref linkend="zfs"/>)。請參考 <citerefentry><refentrytitle>gpart</refentrytitle><manvolnum>8</manvolnum></citerefentry> 取得可用的 <acronym>GPT</acronym> 分割區類型說明。</para>

      <para>檔案系統分割區可建立多個，且有部份人會偏好使用傳統的配置方式將 <filename>/</filename>, <filename>/var</filename>, <filename>/tmp</filename> 以及 <filename>/usr</filename> 分開存放在不同的分割區。請參考 <xref linkend="bsdinstall-part-manual-splitfs"/> 的範例。</para>

      <para>大小 (<literal>Size</literal>) 欄位可以使用常用的縮寫來輸入：<emphasis>K</emphasis> 代表 KB, <emphasis>M</emphasis> 代表 MB, <emphasis>G</emphasis> 代表 GB。</para>

      <tip>
	<para>適當的對齊磁碟扇區 (Sector) 會提供最佳的效能，而且讓分割區大小為 4 KB 的偶數倍數可協助確保對齊在磁碟機上的 512-byte 或 4K-byte 扇區。一般來說，使用分割區大小為 1M 或 1G 的偶數倍數是最簡單的方式確保每個分割區以 4K 的偶數倍數做為開始。唯一一個例外是：<emphasis>freebsd-boot</emphasis> 分割區因目前開機程式 (Boot code) 的限制，不可大於 512K。</para>
      </tip>

      <para>若分割區內含檔案系統便會需要一個掛載點 (<literal>Mountpoint</literal>)，若只要建立一個 <acronym>UFS</acronym> 分割區，那麼掛載點應設為 <filename>/</filename>。</para>

      <para>標籤 (<literal>Label</literal>) 是分割區的名稱，磁碟機名稱或編號可能因為磁碟機連接到不同的控制器或連結埠而有所不同，但分割區標籤並不會改變。因此在檔案如 <filename>/etc/fstab</filename> 中參照時，使用標籤來替代磁碟機名稱與分割區編號會讓系統對硬體變更有更多的容錯空間。<acronym>GPT</acronym> 標籤會於磁碟連結之後出現在 <filename>/dev/gpt/</filename>。其他分割表格式的標籤格有不同功能，且標籤會在 <filename>/dev/</filename> 中有各自的目錄。</para>

      <tip>
	<para>每個分割區請使用獨一無二的標籤來避免相同名稱的衝突，標籤可以加入與電腦名稱、用途、地點有關的文字。例如，使用 <literal>labroot</literal> 或 <literal>rootfslab</literal> 來做為電腦名稱為 <literal>lab</literal> 的 <acronym>UFS</acronym> 根目錄分割區。</para>
      </tip>

      <example xml:id="bsdinstall-part-manual-splitfs">
	<title>建立傳統分割的檔案系統分割區</title>

	<para>傳統的分割區配置會將 <filename>/</filename>, <filename>/var</filename>, <filename>/tmp</filename> 以及 <filename>/usr</filename> 分別使用不同的檔案系統與分割區。先建立 <acronym>GPT</acronym> 分割表格式，然後依照下表所示建立分割區。下表是針對 20G 目標磁碟的分割區大小，若在目標磁碟有更多可用的空間，則可增加交換空間 (Swap) 或 <filename>/var</filename> 會比較有用。以下所示的標籤皆以 <literal>ex</literal> 為字首，代表 <quote>example</quote>，讀者應照前面的說明使用其他獨一無二的標籤。</para>

	<para>預設 FreeBSD 的 <filename>gptboot</filename> 會預期第一個 <acronym>UFS</acronym> 分割區為 <filename>/</filename> 分割區。</para>

	<informaltable frame="none">
	  <tgroup cols="4">
	    <thead>
	      <row>
		<entry>分割區類型</entry>
		<entry>大小</entry>
		<entry>掛載點</entry>
		<entry>標籤</entry>
	      </row>
	    </thead>

	    <tbody>
	      <row>
		<entry xml:lang="en"><literal>freebsd-boot</literal></entry>
		<entry xml:lang="en"><literal>512K</literal></entry>
	      </row>

	      <row>
		<entry xml:lang="en"><literal>freebsd-ufs</literal></entry>
		<entry xml:lang="en"><literal>2G</literal></entry>
		<entry xml:lang="en"><filename>/</filename></entry>
		<entry xml:lang="en"><literal>exrootfs</literal></entry>
	      </row>

	      <row>
		<entry xml:lang="en"><literal>freebsd-swap</literal></entry>
		<entry xml:lang="en"><literal>4G</literal></entry>
		<entry/>
		<entry xml:lang="en"><literal>exswap</literal></entry>
	      </row>

	      <row>
		<entry xml:lang="en"><literal>freebsd-ufs</literal></entry>
		<entry xml:lang="en"><literal>2G</literal></entry>
		<entry xml:lang="en"><filename>/var</filename></entry>
		<entry xml:lang="en"><literal>exvarfs</literal></entry>
	      </row>

	      <row>
		<entry xml:lang="en"><literal>freebsd-ufs</literal></entry>
		<entry xml:lang="en"><literal>1G</literal></entry>
		<entry xml:lang="en"><filename>/tmp</filename></entry>
		<entry xml:lang="en"><literal>extmpfs</literal></entry>
	      </row>

	      <row>
		<entry xml:lang="en"><literal>freebsd-ufs</literal></entry>
		<entry>接受預設值 (依磁碟提示)</entry>
		<entry xml:lang="en"><filename>/usr</filename></entry>
		<entry xml:lang="en"><literal>exusrfs</literal></entry>
	      </row>
	    </tbody>
	  </tgroup>
	</informaltable>
      </example>

      <para>自訂的分割區建立完後，選擇 <guibutton>[ Finish ]</guibutton> 繼續安裝。</para>
    </sect2>

    <sect2 xml:id="bsdinstall-part-zfs">
      <title>Root-on-ZFS 自動磁碟分割</title>

      <para>在 FreeBSD 10.0-RELEASE 之後支援了自動建立 root-on-ZFS 的安裝程序。這種磁碟分割模式只能使用整個磁碟，並會清除整個磁碟內的內容。安裝程式會自動建立對齊 4k 邊界的分割區然後強制 <acronym>ZFS</acronym> 使用 4k 扇區 (Sector)。即使在 512 位元扇區的磁碟使用也很安全，並增加了確保在 512 位元的磁碟上建立儲存池 (Pool) 也可在未來加入 4k 扇區磁碟的好處，無論是作為額外的存儲空間或作為故障磁碟的替代品。安裝程式也可選擇性採用 <acronym>GELI</acronym> 磁碟加密，如 <xref linkend="disks-encrypting-geli"/> 所介紹，若開啟磁碟加密，會建立一個內含 <filename>/boot</filename> 目錄的 2 GB 未加密的開機儲存池，這個儲存池中會儲存核心及其他開機必要的檔案。然後剩餘的空用會給 <acronym>ZFS</acronym> 儲存池使用。</para>

      <para>主要 <acronym>ZFS</acronym> 設定選單提供了數個設定選項來控制儲存池的建立。</para>

      <figure xml:id="bsdinstall-zfs-menu">
	<title><acronym>ZFS</acronym> 磁碟分割選單</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-zfs-menu"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>選擇 <keycap>T</keycap> 來設定儲存池類型 (<literal>Pool Type</literal>) 以及要組成儲存池的磁碟。自動 <acronym>ZFS</acronym> 安裝程式目前僅支援建立單一頂層 vdev，除了在串連 (Stripe) 模式。要建立更複雜的儲存池，需使用 <xref linkend="bsdinstall-part-shell"/> 的操作來建立儲存池。安裝程式支援建立各種儲存池類型，包含串連 Stripe (不建議，沒有備援功能)、鏡像 Mirror (效能較佳，但可用空間較少) 以及 RAID-Z 1, 2, 與 3 (分別有能力承受同時 1, 2 與 3 個磁碟的損壞)。在選擇儲存池類型時會在螢幕的下方提示所需的磁碟數量，以及在使用 RAID-Z 時，每種配置最佳的磁碟數。</para>

      <figure xml:id="bsdinstall-zfs-vdev_type">
	<title><acronym>ZFS</acronym> 儲存池類型</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-zfs-vdev_type"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>選擇儲存池 (<literal>Pool Type</literal>) 之後，會顯示可用的磁碟清單，然後會提示使用者選擇一個或多個磁碟來建立儲存池。接著會檢驗設定來確定選擇的磁碟足夠，若不足，選擇更改選項 (<guibutton>&lt;Change Selection&gt;</guibutton>) 來返回磁碟清單或取消 (<guibutton>&lt;Cancel&gt;</guibutton>) 來更改儲存池類型。</para>

      <figure xml:id="bsdinstall-zfs-disk_select">
	<title>磁碟選擇</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-zfs-disk_select"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <figure xml:id="bsdinstall-zfs-vdev_invalid">
	<title>無效的選擇</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-zfs-vdev_invalid"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>若有一個或多磁碟未出現在清單上，或在安裝程式啟動後才連接的磁碟，可選擇重新掃描裝置 (<guibutton>- Rescan Devices</guibutton>) 來更新可用磁碟的清單。要避免清除掉錯的磁碟，可用磁碟資訊 (<guibutton>- Disk Info</guibutton>) 來檢查每個磁碟，包含磁碟中的分割表以及各種其他資訊如裝置型號與序號 (若有的話)。</para>

      <figure xml:id="bsdinstall-zfs-disk_info">
	<title>分析磁碟</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-zfs-disk_info"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>主 <acronym>ZFS</acronym> 設定選單也允許使用者輸入儲存池名稱、關閉強制 4k 扇區對齊、開啟或關閉加密、切換 <acronym>GPT</acronym> (建議) 與 <acronym>MBR</acronym> 分割表類型以及選擇交換空間容量。設定所有選項為想要的值之後，請選擇選單上方的安裝 (<guibutton>&gt;&gt;&gt; Install</guibutton>) 選項。</para>

      <para>若開啟了 <acronym>GELI</acronym> 磁碟加密，安裝程式會提示輸入兩次用來加密磁碟的密碼。</para>

      <figure xml:id="bsdinstall-zfs-geli_password">
	<title>磁碟加密密碼</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-zfs-geli_password"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>安裝程式接著會提供最後一次修改的機會可取消先前所選擇摧毀用來建立 <acronym>ZFS</acronym> 儲存池的磁碟機。</para>

      <figure xml:id="bsdinstall-zfs-warning">
	<title>最後修改</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-zfs-warning"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>然後安裝程序會正常繼續。</para>

    </sect2>

    <sect2 xml:id="bsdinstall-part-shell">
      <title>Shell 模式磁碟分割</title>

      <para>當要做進階的安裝時，<application>bsdinstall</application> 的磁碟分割選單可能無法提供需要的彈性。進階的使用者可以在磁碟分割選單選擇 <guibutton>Shell</guibutton> 選項來手動分割磁碟機、建立檔案系統、填寫 <filename>/tmp/bsdinstall_etc/fstab</filename> 以及掛載檔案系統到 <filename>/mnt</filename> 下。這些動作完成之後，輸入 <command>exit</command> 可返回 <application>bsdinstall</application> 繼續安裝程序。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="bsdinstall-final-warning">
    <title>確認安裝</title>

    <para>磁碟設定完之後，接下來的選單會讓您在格式化所選的硬碟之前有最後一次機會做變更，若需要做變更，可選 <guibutton>[ Back ]</guibutton> 返回到主磁碟分割選單。<guibutton>[ Revert &amp; Exit ]</guibutton> 則會離開安裝程式，不會對硬碟做任何變更。</para>

    <figure xml:id="bsdinstall-final-confirmation">
      <title>最後確認</title>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="bsdinstall/bsdinstall-final-confirmation"/>
	</imageobject>
      </mediaobject>
    </figure>

    <para>要開始實際的安裝，請選擇 <guibutton>[ Commit ]</guibutton> 然後按下 <keycap>Enter</keycap>。</para>

    <para>安裝時間會依據選擇的發行版、安裝媒體、電腦的速度而有所不同，接下來會有一系列訊息會告知目前的進度。</para>

    <para>首先，安裝程式會格式化選擇的磁碟，然後初始化分割區。然後，若使用僅可開機 (Boot only) 的媒體則會開始下載選擇的元件：</para>

    <figure xml:id="bsdinstall-distfile-fetching">
      <title>取得發行版檔案</title>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="bsdinstall/bsdinstall-distfile-fetching"/>
	</imageobject>
      </mediaobject>
    </figure>

    <para>接著，會檢驗發行版的檔案完整性來確保沒有因下載過程中或安裝媒體的讀取過程中讀取錯誤造成的損壞：</para>

    <figure xml:id="bsdinstall-distfile-verify">
      <title>檢驗發行版檔案</title>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="bsdinstall/bsdinstall-distfile-verifying"/>
	</imageobject>
      </mediaobject>
    </figure>

    <para>最後，檢驗過的發行版檔案會被取出儲存至磁碟：</para>

    <figure xml:id="bsdinstall-distfile-extract">
      <title>解開發行版檔案</title>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="bsdinstall/bsdinstall-distfile-extracting"/>
	</imageobject>
      </mediaobject>
    </figure>

    <para>所有選擇的發行版檔案取出後，<application>bsdinstall</application> 會顯示第一次安裝後設定畫面，可用的安裝後設定選項會在下一節說明。</para>
  </sect1>

  <sect1 xml:id="bsdinstall-post">
    <title>安裝後注意事項</title>

    <para>FreeBSD 安裝完之後，<application>bsdinstall</application> 會在開機進入新安裝的系統之前提示設定數個選項，本節將介紹這些設定選項。</para>

    <tip>
      <para>系統開機之後，<command>bsdconfig</command> 提供了一個選單導向的方式可用來設定系統使用這些以及其他的選項。</para>
    </tip>

    <sect2 xml:id="bsdinstall-post-root">
      <title>設定 <systemitem class="username">root</systemitem> 密碼</title>

      <para>首先，必需設定 <systemitem class="username">root</systemitem> 的密碼，輸入密碼時，並不會直接在畫面上顯示輸入的字元。輸入完密碼之後，必須再輸入一次來確認沒有輸入錯誤。</para>

      <figure xml:id="bsdinstall-post-set-root-passwd">
	<title>設定 <systemitem class="username">root</systemitem> 密碼</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-post-root-passwd"/>
	  </imageobject>
	</mediaobject>
      </figure>
    </sect2>

    <sect2 xml:id="bsdinstall-config-network-dev">
      <title>設定網路介面卡</title>

      <para>接著，會顯示在電腦上找到的網路介面卡清單。請選擇要設定的介面卡。</para>

      <note>
	<para>若使用 <emphasis>bootonly</emphasis> 的方式安裝在先前已有設定過網路，將會跳過網路設定選單。</para>
      </note>

      <figure xml:id="bsdinstall-configure-net-interface">
	<title>選擇網路介面卡</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-network-interface"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>若選擇的是乙太網路介面卡，安裝程式會跳過這部份直接到 <xref linkend="bsdinstall-configure-net-ipv4"/>，若選擇的是無線網路介面卡，系統則會開始掃描無線存取點 (Wireless Access Point)：</para>

      <figure xml:id="bsdinstall-wireless-scan">
	<title>掃描無線網路存取點</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-wireless-scan"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>網線網路會使用 Service Set Identifier (<acronym>SSID</acronym>) 來辦識，SSID 是一段簡短、獨一無二的名稱，用來命名每個網路。 掃描時找到的 <acronym>SSID</acronym> 會列到清單，並會說明該網路可用的加密類型。 若想要連線的 <acronym>SSID</acronym> 並未出現在清單上，可選擇 <guibutton>[ Rescan ]</guibutton> 再掃描一次，若想要連線的網路仍然沒有出現，請檢查天線的連線是否有問題，或者嘗試將電腦移至更靠近存取點的位置，然後再掃描一次。</para>

      <figure xml:id="bsdinstall-wireless-accesspoints">
	<title>選擇無線網路</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-wireless-accesspoints"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>然後，輸入加密資訊來連線到選擇的無線網路。強列建議使用 <acronym>WPA2</acronym> 加密，因較舊的加密類型，如 <acronym>WEP</acronym> 僅提供微弱的安全性。若網路使用 <acronym>WPA2</acronym> 則需輸入密碼，也稱作 Pre-Shared Key (<acronym>PSK</acronym>)。考量安全性，輸入到輸入框的字元會以星號顯示。</para>

      <figure xml:id="bsdinstall-wireless-wpa2">
	<title>WPA2 設定</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-wireless-wpa2setup"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>接下來，選擇是否要設定乙太網路或無線網路介面卡的 <acronym>IPv4</acronym> 位址：</para>

      <figure xml:id="bsdinstall-configure-net-ipv4">
	<title>選擇 <acronym>IPv4</acronym> 網路</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-network-interface-ipv4"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>有兩種方式可以設定 <acronym>IPv4</acronym>。 <acronym>DHCP</acronym> 會自動設定網路介面卡且該網路上需有 <acronym>DHCP</acronym> 伺服器才可使用。否則，必須手動輸入位址的資訊來做靜態設定。</para>

      <note>
	<para>請不要隨便輸入網路資訊，因為這不管用。如果沒有可用的 <acronym>DHCP</acronym> 伺服器，可向網路管理者或網路服務供應商 (Internet Service Provider, ISP) 索取列於 <xref linkend="bsdinstall-collect-network-information"/> 的資訊。</para>
      </note>

      <para>若有可用的 <acronym>DHCP</acronym> 伺服器，請在接下來的選單中選擇 <guibutton>[ Yes ]</guibutton> 則會自動設定網路介面卡。當找到 <acronym>DHCP</acronym> 伺服器並且取得系統的位址資訊時，安裝程式會出現一分鐘左右的停頓。</para>

      <figure xml:id="bsdinstall-net-ipv4-dhcp">
	<title>選擇 <acronym>IPv4</acronym> <acronym>DHCP</acronym> 設定</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-network-interface-ipv4-dhcp"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>若沒有可用的 <acronym>DHCP</acronym> 伺服器，則選擇 <guibutton>[ No ]</guibutton> 然後在這個選單中輸入以下位址資訊：</para>

      <figure xml:id="bsdinstall-net-ipv4-static">
	<title><acronym>IPv4</acronym> 靜態位置設定</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-network-interface-ipv4-static"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <itemizedlist>
	<listitem>
	  <para>IP 位址 (<literal>IP Address</literal>) - 要分配給這台電腦的 <acronym>IPv4</acronym> 位址。位址必須獨一無二且不可已被其他在區域網路上的設備使用。</para>
	</listitem>

	<listitem>
	  <para>子網路遮罩 (<literal>Subnet Mask</literal>) - 網路的子網路遮罩。</para>
	</listitem>

	<listitem>
	  <para>預設路由器 (<literal>Default Router</literal>) - <acronym>IP</acronym> 位址所在網段的預設通訊閘。</para>
	</listitem>
      </itemizedlist>

      <para>接下來的畫面會詢問是否要設定介面卡的 <acronym>IPv6</acronym> 位址，若可以且想要使用 <acronym>IPv6</acronym>，請選擇 <guibutton>[ Yes ]</guibutton>。</para>

      <figure xml:id="bsdinstall-net-ipv6">
	<title>選擇 IPv6 網路</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-network-interface-ipv6"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>同樣有兩種方式可以設定 <acronym>IPv6</acronym>。StateLess Address AutoConfiguration (<acronym>SLAAC</acronym>) 會自動向區域路由器請求取得正確的設定資訊，請參考 <link xlink:href="http://tools.ietf.org/html/rfc4862">http://tools.ietf.org/html/rfc4862</link> 取得進一步資訊。靜態設定則需要手動輸入網路資訊。</para>

      <para>若有可用的 <acronym>IPv6</acronym> 路由器，請在接下來的選單選擇 <guibutton>[ Yes ]</guibutton> 來自動設定網路介面卡。當找到路由器並且取得系統的位址資訊時，安裝程式會出現一分鐘左右的停頓。</para>

      <figure xml:id="bsdinstall-net-ipv6-slaac">
	<title>選擇 IPv6 SLAAC 設定</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-network-interface-slaac"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>若沒有可用的 <acronym>IPv6</acronym> 路由器，請選擇 <guibutton>[ No ]</guibutton> 然後在這個選單中輸入以下位址資訊：</para>

      <figure xml:id="bsdinstall-net-ipv6-static">
	<title>IPv6 靜態位置設定</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-network-interface-ipv6-static"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <itemizedlist>
	<listitem>
	  <para>IPv6 位址 (<literal>IPv6 Address</literal>) - 要分配給這台電腦的 <acronym>IPv6</acronym> 位址。位址必須獨一無二且不可已被其他在區域網路上的設備使用。</para>
	</listitem>

	<listitem>
	  <para>預設路由器 (<literal>Default Router</literal>) - <acronym>IPv6</acronym> 位址所在網段的預設通訊閘。</para>
	</listitem>
      </itemizedlist>

      <para>最後的網路設定選單是用來設定網域名稱系統 (Domain Name System, <acronym>DNS</acronym>) 的解析器，解析器會轉換主機名稱為網路位址。若已使用 <acronym>DHCP</acronym> 或 <acronym>SLAAC</acronym> 來自動設定網路介面卡，解析器設定 (<literal>Resolver Configuration</literal>) 的值可能會事先已填入，否則需輸入區域網路的網域名稱到搜尋 (<literal>Search</literal>) 欄位。 <literal>DNS #1</literal> 與 <literal>DNS #2</literal> 要填寫 <acronym>DNS</acronym> 伺服器的 <acronym>IPv4</acronym> 及/或 <acronym>IPv6</acronym> 位址，至少需填寫一個 <acronym>DNS</acronym> 伺服器。</para>

      <figure xml:id="bsdinstall-net-dns-config">
	<title>DNS 設定</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-configure-network-ipv4-dns"/>
	  </imageobject>
	</mediaobject>
      </figure>
    </sect2>

    <sect2 xml:id="bsdinstall-timezone">
      <title>設定時區</title>

      <para>接下來的選單會詢問系統時鐘要使用 <acronym>UTC</acronym> 或者當地時間。 若有疑問時可選擇 <guibutton>[ No ]</guibutton>使用更常用的當地時間。</para>

      <figure xml:id="bsdinstall-local-utc">
	<title>選擇本地或 UTC 時鐘</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-set-clock-local-utc"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>接下來一系列的選單會透過選擇地理區域、城市及時區來判斷正確的當地時間。設定時區可讓系統自動更正區域時間的更改，如日光節約時間以及正確執行其他時區相關的功能。</para>

      <para>此處以位於美國東部時區的機器為例，選擇會依據地理位置不同改變。</para>

      <figure xml:id="bsdinstall-timezone-region">
	<title>選擇區域</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-timezone-region"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>使用方向鍵選擇適當的區域然後按下 <keycap>Enter</keycap>。</para>

      <figure xml:id="bsdinstall-timezone-country">
	<title>選擇城市</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-timezone-country"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>使用方向鍵選擇適當的城市然後按下 <keycap>Enter</keycap>。</para>

      <figure xml:id="bsdinstall-timezone-zone">
	<title>選擇時區</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-timezone-zone"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>使用方向鍵選擇適當的時區然後按下 <keycap>Enter</keycap>。</para>

      <figure xml:id="bsdinstall-timezone-confirmation">
	<title>確認時區</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-timezone-confirm"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>確認時區的縮寫是否正確，若正確，按下 <keycap>Enter</keycap> 繼續安裝後設定。</para>
    </sect2>

    <sect2 xml:id="bsdinstall-sysconf">
      <title>開啟服務</title>

      <para>接下來的選單用來設定有那些系統服務要在系統啟動時執行。所有的服務為選用，只需開啟系統運作真正需要的服務。</para>

      <figure xml:id="bsdinstall-config-serv">
	<title>選擇要開啟的其他服務</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-config-services"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>這是可以在這個選單開啟的服務摘要：</para>

      <itemizedlist>
	<listitem>
	  <para><literal>sshd</literal> - Secure Shell (<acronym>SSH</acronym>) Daemon 可從遠端透過加密的連線存取系統，只有在系統允許遠端登入時開啟這個服務。</para>
	</listitem>

	<listitem>
	  <para><literal>moused</literal> - 若在指令列系統 Console 會使用到滑鼠時，可開啟此服務。</para>
	</listitem>

	<listitem>
	  <para><literal>ntpd</literal> - 網路時間通訊協定 (Network Time Protoco, <acronym>NTP</acronym>) Daemon 用來自動同步時間。若在網路上有使用 <trademark class="registered">Windows</trademark>, Kerberos 或 <acronym>LDAP</acronym> 伺服器時，可開啟此服務。</para>
	</listitem>

	<listitem>
	  <para><literal>powerd</literal> - 系統電源控制工具用來做電源控制與節能。</para>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="bsdinstall-crashdump">
      <title>開啟當機資訊 (Crash Dump)</title>

      <para>接下來的選單用來設定是否開啟當機資訊 (Crash dump)，開啟當機資訊對系統除錯非常有用，因此建議使用者開啟當機資訊。</para>

      <figure xml:id="bsdinstall-config-crashdump">
	<title>開啟當機資訊 (Crash Dump)</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-config-crashdump"/>
	  </imageobject>
	</mediaobject>
      </figure>
    </sect2>

    <sect2 xml:id="bsdinstall-addusers">
      <title>新增使用者</title>

      <para>下個選單會提示建立至少一個使用者帳號。建議使用 <systemitem class="username">root</systemitem> 以外的使用者帳號登入系統，當使用 <systemitem class="username">root</systemitem> 登入時，基本上沒有任何的限制或保護。
使用一般使用者登入較保險且安全。</para>

      <para>選擇 <guibutton>[ Yes ]</guibutton> 來新增新使用者。</para>

      <figure xml:id="bsdinstall-add-user1">
	<title>新增使用者帳號</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-adduser1"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>請依照提示輸入請求的使用者帳號資訊，<xref linkend="bsdinstall-add-user2"/> 的範例示範建立 <systemitem class="username">asample</systemitem> 使用者帳號。</para>

      <figure xml:id="bsdinstall-add-user2">
	<title>輸入使用者資訊</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-adduser2"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>這裡是要輸入的資訊摘要：</para>

      <itemizedlist>
	<listitem>
	  <para>使用者名稱 (<literal>Username</literal>) - 登入時使用者要輸入的名稱，常見的慣例是用姓的前一個字母與名結合，只要每個使用者名稱在系統唯一的皆可。使用者名稱區分大小寫且不應含有任何空白字元。</para>
	</listitem>

	<listitem>
	  <para>全名 (<literal>Full name</literal>) - 使用者的全名，這個欄位可使用空白並且會用來描述該使用者帳號。</para>
	</listitem>

	<listitem>
	  <para><literal>Uid</literal> - 使用者 <acronym>ID</acronym>，通常這個欄位會留空，系統會自動分配一個值。</para>
	</listitem>

	<listitem>
	  <para>登入群組 (<literal>Login group</literal>) - 使用者的群組，通常這個欄位會留空來使用預設值。</para>
	</listitem>

	<listitem>
	  <para>邀請使用者進入其他群組? (<literal>Invite <replaceable>user</replaceable> into other groups?</literal>) - 使用者要加入成為其成員的其他群組，若該使用者需要管理權限，則在此輸入 <literal>wheel</literal>。</para>
	</listitem>

	<listitem>
	  <para>登入類別 (<literal>Login class</literal>) - 通常會留空來使用預設值。</para>
	</listitem>

	<listitem>
	  <para><literal>Shell</literal> - 輸入清單中的其中一項來設定使用者所互動的 Shell，請參考 <xref linkend="shells"/> 取得更多有關  Shell 的資訊。</para>
	</listitem>

	<listitem>
	  <para>家目錄 (<literal>Home directory</literal>) - 使用者的家目錄，預設值通常是沒有問題的。</para>
	</listitem>

	<listitem>
	  <para>家目錄權限 (<literal>Home directory permissions</literal>) - 使用者家目錄的權限，預設值通常是沒有問題的。</para>
	</listitem>

	<listitem>
	  <para>使用密碼為基礎的認証方式? (<literal>Use password-based authentication?</literal>) - 通常為是 (<literal>yes</literal>)，使用者才可於登入時輸入密碼。</para>
	</listitem>

	<listitem>
	  <para>使用空白密碼? (<literal>Use an empty password?</literal>) - 通常為否 (<literal>no</literal>)，因為使用空白密碼並不安全。</para>
	</listitem>

	<listitem>
	  <para>使用隨機密碼? (<literal>Use a random password?</literal>) - 通常為否 (<literal>no</literal>)，這樣使用者接下來才可設定自己的密碼。</para>
	</listitem>

	<listitem>
	  <para>輸入密碼 (<literal>Enter password</literal>) - 這個使用者的密碼，輸入的字元不會顯示在畫面上。</para>
	</listitem>

	<listitem>
	  <para>再輸入密碼一次 (<literal>Enter password again</literal>) - 再輸入一次密碼來確認無誤。</para>
	</listitem>

	<listitem>
	  <para>建立後鎖定使用者帳號? (<literal>Lock out the account after creation?</literal>) - 通常為否 (<literal>no</literal>)，這樣使用者才可以登入。</para>
	</listitem>
      </itemizedlist>

      <para>在輸入完全部的資料後，會顯示摘要供檢查，若發現錯誤，可輸入否 (<literal>no</literal>) 然後再輸入一次，若輸入的所有資訊皆正確，輸入是 (<literal>yes</literal>) 以後便會建立新使用者。</para>

      <figure xml:id="bsdinstall-add-user3">
	<title>離開使用者與群組管理</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-adduser3"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>若還有其他要新增的使用者，則在詢問新增其他使用者? (<literal>Add another user?</literal>) 時回答是 (<literal>yes</literal>)。輸入否 (<literal>no</literal>) 來完成加入使用者然後繼續安裝。</para>

      <para>要取得新增使用者與使用者管理的更多資訊，請參考 <xref linkend="users-synopsis"/>。</para>
    </sect2>

    <sect2 xml:id="bsdinstall-final-conf">
      <title>最後設定</title>

      <para>在所有東西安裝並設定完之後，會提供最後一次修改設定的機會。</para>

      <figure xml:id="bsdinstall-final-config">
	<title>最後設定</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-finalconfiguration"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>使用這個選單在完成安裝前做任何更改或做任何額外的設定。</para>

      <itemizedlist>
	<listitem>
	  <para>新增使用者 (<literal>Add User</literal>) - 詳述於 <xref linkend="bsdinstall-addusers"/>。</para>
	</listitem>

	<listitem>
	  <para>Root 密碼 (<literal>Root Password</literal>) - 詳述於 <xref linkend="bsdinstall-post-root"/>。</para>
	</listitem>

	<listitem>
	  <para>主機名稱 (<literal>Hostname</literal>) - 詳述於 <xref linkend="bsdinstall-hostname"/>。</para>
	</listitem>

	<listitem>
	  <para>網路 (<literal>Network</literal>) - 詳述於 <xref linkend="bsdinstall-config-network-dev"/>。</para>
	</listitem>

	<listitem>
	  <para>服務 (<literal>Services</literal>) - 詳述於 <xref linkend="bsdinstall-sysconf"/>。</para>
	</listitem>

	<listitem>
	  <para>時區 (<literal>Time Zone</literal>) - 詳述於 <xref linkend="bsdinstall-timezone"/>。</para>
	</listitem>

	<listitem>
	  <para>使用手冊 (<literal>Handbook</literal>) - 下載並安裝 FreeBSD 使用手冊。</para>
	</listitem>
      </itemizedlist>

      <para>完成最後的設定之後，選擇 <guibutton>Exit</guibutton>。</para>

      <figure xml:id="bsdinstall-final-modification-shell">
	<title>手動設定</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-final-modification-shell"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para><application>bsdinstall</application> 會提示是否有任何額外的設定需要在重新開機進入新系統之前完成。選擇 <guibutton>[ Yes ]</guibutton> 會離開進入到新系統的 Shell 或 <guibutton>[ No ]</guibutton> 繼續最後的安裝步驟。</para>

      <figure xml:id="bsdinstall-final-main">
	<title>完成安裝</title>

	<mediaobject>
	  <imageobject>
	    <imagedata fileref="bsdinstall/bsdinstall-mainexit"/>
	  </imageobject>
	</mediaobject>
      </figure>

      <para>若有需要做進一步或特殊的設定，選擇 <guibutton>[ Live CD ]</guibutton> 會開機進入安裝媒體的 Live <acronym>CD</acronym> 模式。</para>

      <para>若安裝已完成，選擇 <guibutton>[ Reboot ]</guibutton> 重新開啟電腦然後啟動新的 FreeBSD 電腦。不要忘了移除 FreeBSD 安裝媒體，否則電腦會再次開機進入安裝程式。</para>

      <para>FreeBSD 開機的過程會顯示許多可以參考的訊息，系統開機完成後，會顯示登入提示，在 <prompt>login:</prompt> 提示，輸入安裝時新增的使用者名稱。登入時避免直接使用 <systemitem class="username">root</systemitem>，請參考 <xref linkend="users-superuser"/> 來取得當需要管理權限時如何成為超級使用者的說明。</para>

      <para>要查看開機過程顯示的訊息可按 <keycap>Scroll-Lock</keycap> 鍵來開啟卷軸暫存，然後可使用 <keycap>PgUp</keycap>, <keycap>PgDn</keycap> 以及方向鍵來捲動訊息。查看完成之後再按 <keycap>Scroll-Lock</keycap> 鍵一次來解除畫面鎖定並返回 Console。系統開機一段時間之後要查看這些訊息可在指令提示後輸入 <command>less /var/run/dmesg.boot</command>，查看後按下 <keycap>q</keycap> 鍵便可返回指令列。</para>

      <para>若在 <xref linkend="bsdinstall-config-serv"/> 有開啟 <application>sshd</application>，因系統會產生 <acronym>RSA</acronym> 及 <acronym>DSA</acronym> 金鑰第一次開機可能會有點慢，之後的開機便會恢復正常速度。接著會顯示金鑰的指紋 (Fingerprint)，如這個範例：</para>

      <screen xml:lang="en">Generating public/private rsa1 key pair.
Your identification has been saved in /etc/ssh/ssh_host_key.
Your public key has been saved in /etc/ssh/ssh_host_key.pub.
The key fingerprint is:
10:a0:f5:af:93:ae:a3:1a:b2:bb:3c:35:d9:5a:b3:f3 root@machine3.example.com
The key's randomart image is:
+--[RSA1 1024]----+
|    o..          |
|   o . .         |
|  .   o          |
|       o         |
|    o   S        |
|   + + o         |
|o . + *          |
|o+ ..+ .         |
|==o..o+E         |
+-----------------+
Generating public/private dsa key pair.
Your identification has been saved in /etc/ssh/ssh_host_dsa_key.
Your public key has been saved in /etc/ssh/ssh_host_dsa_key.pub.
The key fingerprint is:
7e:1c:ce:dc:8a:3a:18:13:5b:34:b5:cf:d9:d1:47:b2 root@machine3.example.com
The key's randomart image is:
+--[ DSA 1024]----+
|       ..     . .|
|      o  .   . + |
|     . ..   . E .|
|    . .  o o . . |
|     +  S = .    |
|    +  . = o     |
|     +  . * .    |
|    . .  o .     |
|      .o. .      |
+-----------------+
Starting sshd.</screen>

      <para>請參考 <xref linkend="openssh"/> 來取得更多有關指紋與 <acronym>SSH</acronym> 的資訊。</para>

      <para>FreeBSD 預設並不會安裝圖型化介面，請參考 <xref linkend="x11"/> 取得有關安裝與設定圖型化視窗管理程式的資訊。</para>

      <para>正確的將 FreeBSD 電腦關機對保護資料及避免硬體損壞有幫助。<emphasis>在系統尚未正常關機之前請不要關閉電源！</emphasis> 若使用者為 <systemitem class="groupname">wheel</systemitem> 群組的成員之一，可在指令列輸入 <command>su</command> 然後輸入 <systemitem class="username">root</systemitem> 密碼來成為超級使用者。接著輸入 <command>shutdown -p now</command> 系統便會關機，若硬體支援的話，電腦會自行關閉電源。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="bsdinstall-install-trouble">
    <title>疑難排解</title>

    <indexterm xml:lang="en">
      <primary>installation</primary>
      <secondary>troubleshooting</secondary>
    </indexterm>
    <para>本節涵蓋基礎的安裝疑難排解，例如一些已有人回報的常見問題。</para>

    <para>查看該 FreeBSD 版本的 Hardware Notes (<link xlink:href="@@URL_RELPREFIX@@/releases/index.html">https://www.freebsd.org/releases/index.html</link>) 文件來確認是否支援該硬體。若確定有支援該硬體但仍然卡住或發生其他問題，請依照 <xref linkend="kernelconfig"/> 的指示編譯自訂核心來加入未在 <filename>GENERIC</filename> 核心的裝置。預設的核心會假設大部份的硬體裝置會使用原廠預設的 <acronym>IRQ</acronym>s, <acronym>I/O</acronym> 位址，及 <acronym>DMA</acronym> 通道，若硬體已經被重新設定過，自訂的核心設定檔可以告訴 FreeBSD 到那找到這些裝置。</para>

    <note>
      <para>部份安裝問題可以透過更各種硬體元件的韌體來避免或緩解，特別是主機板。主機板的韌體通常稱為 <acronym>BIOS</acronym>，大部份主機板與電腦製造商會有網站可以取得升級程式與升級資訊。</para>

      <para>製造商通常會建議若沒有特殊原因盡量避免升級主機板 <acronym>BIOS</acronym>，例如：重大更新，升級的程多<emphasis>可能會</emphasis>出錯，導致未更新完成的 <acronym>BIOS</acronym> 並讓電腦無法運作。</para>
    </note>

    <para>若系統在開機偵測硬體時卡住或安裝時運作異常，可能主因為 <acronym>ACPI</acronym>，FreeBSD 在 i386, amd64 及 ia64 平台廣泛的使用了系統 <acronym>ACPI</acronym> 服務來協助設定系統組態，若在開機時有偵測到該功能。不幸的是，<acronym>ACPI</acronym> 驅動程式與系統主機板及 <acronym>BIOS</acronym> 韌體之間仍存在部份問題。可於開機載入程式的第三階段設定 <literal>hint.acpi.0.disabled</literal> Hint 來關閉 <acronym>ACPI</acronym>：</para>

    <screen xml:lang="en"><userinput>set hint.acpi.0.disabled="1"</userinput></screen>

    <para>每一次系統重開之後便會重設，因此需要在 <filename>/boot/loader.conf</filename> 檔案加入 <literal>hint.acpi.0.disabled="1"</literal>。更多有關開機載入程式的資訊可於 <xref linkend="boot-synopsis"/> 取得。</para>
  </sect1>

  <sect1 xml:id="using-live-cd">
    <title>使用 Live <acronym>CD</acronym></title>

    <para>如 <xref linkend="bsdinstall-choose-mode"/> 所示 <application>bsdinstall</application> 的歡迎選單提供了 <guibutton>[ Live CD ]</guibutton> 選項，這對那些對 FreeBSD 是否為正確的作業系統尚存疑慮的人非常有幫助，這可讓這些人在安裝前測試一部份功能。</para>

    <para>在使用 <guibutton>[ Live CD ]</guibutton> 之前必須注意以下幾點事項：</para>

    <itemizedlist>
      <listitem>
	<para>若要增加存取權限，必須透過認証。使用者名稱為 <systemitem class="username">root</systemitem> 而密碼則是空白。</para>
      </listitem>

      <listitem>
	<para>系統是直接從安裝媒體上執行，比起安裝到硬碟的系統，效能可能較差。</para>
      </listitem>

      <listitem>
	<para>這個選項只提供指令提示，不會有圖型化介面。</para>
      </listitem>
    </itemizedlist>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="basics">
  <!--
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Chris</firstname>
	<surname>Shumway</surname>
	<contrib>Rewritten by in Mar 2000</contrib>
      </author>
    </authorgroup>
  </chapterinfo>
  -->
  <title>FreeBSD 基礎</title>

  <sect1 xml:id="basics-synopsis">
    <title>概述</title>

    <para>接下來的這一章將涵蓋 FreeBSD 作業系統的基本指令及功能。 大部份的內容在 <trademark class="registered">UNIX</trademark>-like 作業系統中都是相通的。 如果您對這些內容熟悉的話，可以放心的跳過。 如果您剛接觸 FreeBSD，那您一定要仔細的讀完這章。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>如何使用 FreeBSD 的虛擬 Console。</para>
      </listitem>

      <listitem>
	<para>如何在 FreeBSD 建立與管理使用者與群組。</para>
      </listitem>

      <listitem>
	<para><trademark class="registered">UNIX</trademark> 檔案權限以及 FreeBSD 檔案標記的運作方式。</para>
      </listitem>

      <listitem>
	<para>預設的 FreeBSD 檔案系統配置。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 的磁碟組織。</para>
      </listitem>

      <listitem>
	<para>如何掛載 (Mount)、卸載 (Umount) 檔案系統。</para>
      </listitem>

      <listitem>
	<para>什麼是程序、Daemon 以及信號 (Signal)。</para>
      </listitem>

      <listitem>
	<para>什麼是 Shell，以及如何變更您預設的登入環境。</para>
      </listitem>

      <listitem>
	<para>如何使用基本的文字編輯器。</para>
      </listitem>

      <listitem>
	<para>什麼是裝置 (Device) 和裝置節點 (Device node)。</para>
      </listitem>

      <listitem>
	<para>如何閱讀操作手冊以獲得更多的資訊。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="consoles">
    <title>虛擬 Console 與終端機</title>

    <indexterm xml:lang="en">
      <primary>virtual consoles</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>terminals</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>console</primary>
    </indexterm>

    <para>如果您沒有將 FreeBSD 設定成開機時自動進入圖形化模式，系統會進入指令登入提示像是這樣的東西：</para>

    <screen xml:lang="en">FreeBSD/amd64 (pc3.example.org) (ttyv0)

login:</screen>

    <para>第一行包含了剛開機完系統的資訊，<literal>amd64</literal> 代表此範例所使用的系統是執行 64-位元版本的 FreeBSD，這台主機的名稱是 <systemitem>pc3.example.org</systemitem>，<filename>ttyv0</filename> 代表這是個 <quote>系統 Console</quote>。第二行則是登人的提示訊息。</para>

    <para>FreeBSD 是一個多使用者的系統，需要一套可以分辨不同使用者的方法。因此所有的使用者在執行程式之前必須先“登入”系統以取得系統內程式的存取權限。每個使用者都有一組獨一無二的使用者名稱 (<quote>username</quote>) 及個人密碼 (<quote>password</quote>)。</para>

    <para>要登入系統 Console 需輸入在系統安裝時設定的使用者名稱，請參考 <xref linkend="bsdinstall-addusers"/>，並按下 <keycap>Enter</keycap>。 接著輸入該使用者名稱的密碼按下 <keycap>Enter</keycap>。 輸入的密碼為了安全起見<emphasis>不會顯示</emphasis>在畫面上。</para>

    <para>如果您輸入了正確的密碼，您應該會看到今日訊息 (Message of the day, <acronym>MOTD</acronym>)，後面接著顯示指令提示字元，依使用者建立時所選擇的 Shell 會有不同的提示字元可能為 <literal>#</literal>, <literal>$</literal> 或者 <literal>%</literal>。 看到指令提示代表使用者現在已經登入 FreeBSD 系統 Console 且已經準備好可以下指令。</para>

    <sect2 xml:id="consoles-virtual">
      <title>虛擬 Console</title>

      <para>雖然系統 Console 已經可以用來與系統互動，但使用鍵盤來下指令使用 FreeBSD 系統的使用者通常會使用虛擬 Console 登入。 因為系統訊息預設會顯示在系統 Console，這些訊些會在使用者作業的過程中不斷出現，讓使用者難以專心作業。</para>

      <para>FreeBSD 預設提供多個虛擬 Console 可輸入指令，每個虛擬 Console 都有自己的登入提示及 Shell 並且可以輕易的在虛擬 Console 間切換。 這實際上讓指令輸入有了類似於圖型化環境中可以同時開啟多個視窗的功能。</para>

      <para>組合鍵 <keycombo><keycap>Alt</keycap><keycap>F1</keycap></keycombo> 至  <keycombo><keycap>Alt</keycap><keycap>F8</keycap></keycombo> 被 FreeBSD 保留用來切換虛擬 Console，使用 <keycombo><keycap>Alt</keycap><keycap>F1</keycap></keycombo> 可切換至系統 Console (<filename>ttyv0</filename>)，<keycombo><keycap>Alt</keycap><keycap>F2</keycap></keycombo> 可存取第一個虛擬 Console (<filename>ttyv1</filename>)，<keycombo><keycap>Alt</keycap><keycap>F3</keycap></keycombo> 可存取第二個虛擬 Console (<filename>ttyv2</filename>)，以此類推。當使用 <application>Xorg</application> 作為圖型化 Console 時，組合鍵則改使用 <keycombo> <keycap>Ctrl</keycap><keycap>Alt</keycap><keycap>F1</keycap> </keycombo> 來切換回文字介面的虛擬 Console。</para>

      <para>當您從一個 Console 切換到下一個的時候，FreeBSD 會切換畫面顯示的內容， 這就好像有很多虛擬的螢幕和鍵盤可以讓您輸入指令到 FreeBSD 執行。 在某一個虛擬 Console 上執行的程式並不會因為使用者切到別的 Console 而停止執行。</para>

      <para>請參考 <citerefentry><refentrytitle>kbdcontrol</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <citerefentry><refentrytitle>vidcontrol</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <citerefentry><refentrytitle>atkbd</refentrytitle><manvolnum>4</manvolnum></citerefentry>, <citerefentry><refentrytitle>syscons</refentrytitle><manvolnum>4</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>vt</refentrytitle><manvolnum>4</manvolnum></citerefentry> 來取得更多有關 FreeBSD Console 及鍵盤驅動程式的技術說明。</para>

      <para>FreeBSD 中虛擬 Console 的數量設定在 <filename>/etc/ttys</filename> 檔案中的下列章節：</para>

      <programlisting xml:lang="en"># name    getty                         type  status comments
#
ttyv0   "/usr/libexec/getty Pc"         xterm   on  secure
# Virtual terminals
ttyv1   "/usr/libexec/getty Pc"         xterm   on  secure
ttyv2   "/usr/libexec/getty Pc"         xterm   on  secure
ttyv3   "/usr/libexec/getty Pc"         xterm   on  secure
ttyv4   "/usr/libexec/getty Pc"         xterm   on  secure
ttyv5   "/usr/libexec/getty Pc"         xterm   on  secure
ttyv6   "/usr/libexec/getty Pc"         xterm   on  secure
ttyv7   "/usr/libexec/getty Pc"         xterm   on  secure
ttyv8   "/usr/X11R6/bin/xdm -nodaemon"  xterm   off secure</programlisting>


      <para>要關閉虛擬 Console 只要在指定的虛擬 Console 該行設定的一開始加上註解符號 (<literal>#</literal>)。 例如要將虛擬 Console 的數量由 8 個改為 4 個，則可將 <literal>#</literal> 加在代表虛擬 Console 的 <filename>ttyv5</filename> 到 <filename>ttyv8</filename> 的最後四行一開始。 <emphasis>請勿</emphasis>將系統 Console <filename>ttyv0</filename> 加上註解符號。 注意，若有依照 <xref linkend="x11"/> 安裝並設定 <application>Xorg</application> 時，會用到最後一個虛擬 Console (<filename>ttyv8</filename>)。</para>

      <para>有關各欄位的設定以及其他選項，請參閱 <citerefentry><refentrytitle>ttys</refentrytitle><manvolnum>5</manvolnum></citerefentry> 說明。</para>
    </sect2>

    <sect2 xml:id="consoles-singleuser">
      <title>單使用者模式</title>

      <para>FreeBSD 開機選單會提供一個選項為 <quote>Boot Single User</quote>，若選擇該項目，系統將會進入所謂 <quote>單使用者模式</quote> 的特殊模式。 此模式通常用在修復系統無法開機或重設已忘掉的 <systemitem class="username">root</systemitem> 密碼。 在當使用者模式中無法使用網路及其他虛擬 Console，但有完整 <systemitem class="username">root</systemitem> 對系統的存取權限，而且預設是不須要輸入 <systemitem class="username">root</systemitem> 密碼。 也因此，要能透過實體鍵盤操作才能進入此模式，在考量 FreeBSD 系統安全時須要限制可操作實體鍵盤的人員。</para>

      <para>有關單使用者模式的設定可在 <filename>/etc/ttys</filename> 中的以下章節中找到：</para>

      <programlisting xml:lang="en"># name  getty                           type  status  comments
#
# If console is marked "insecure", then init will ask for the root password
# when going to single-user mode.
console none                            unknown  off  secure</programlisting>

      <para>預設狀態為安全 (<literal>secure</literal>)，這代表誰能夠操作實體鍵盤不是不重要就是已受到實體安全規範管制。 若設定更該為不安全 (<literal>insecure</literal>) 則代表主機所在的環境不安全，因為任何人皆可接觸鍵盤。 當此行設定更改為不安全 (<literal>insecure</literal>) 時，當使用擇選擇單使用者模式時，FreeBSD 將會要求輸入 <systemitem class="username">root</systemitem> 的密碼。</para>

      <note>
	<para><emphasis>請審慎考慮是否要改為 <literal>insecure</literal></emphasis>！ 因為萬一忘記 <systemitem class="username">root</systemitem> 密碼的話，雖然還是有其他辦法可以登入單使用者模式，只是對不熟 FreeBSD 開機程序的人可就麻煩了。</para>
      </note>
    </sect2>

    <sect2 xml:id="consoles-vidcontrol">
      <title>更改 Console 影像模式</title>

      <para>FreeBSD Console 預設顯示大小可以調整為 1024x768、1280x1024 或其他顯示卡與螢幕有支援的解析度大小。 要使用不同的影像模式需載入 <literal>VESA</literal> 模組：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload vesa</userinput></screen>

      <para>要偵測硬體支援的影像模式，可使用 <citerefentry><refentrytitle>vidcontrol</refentrytitle><manvolnum>1</manvolnum></citerefentry>。 要取得支援的影像模式清單可輸入以下指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>vidcontrol -i mode</userinput></screen>

      <para>該指令會顯示硬體所支援的影像模式清單，要採用新的影像模式需以 <systemitem class="username">root</systemitem> 使用者執行 <citerefentry><refentrytitle>vidcontrol</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>vidcontrol MODE_279</userinput></screen>

      <para>若可接受新的影像模式，可以在 <filename>/etc/rc.conf</filename> 加入設定，讓每次重開機後會自動生效：</para>

      <programlisting xml:lang="en">allscreens_flags="MODE_279"</programlisting>
    </sect2>
  </sect1>

    <!--
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Neil</firstname>
	<surname>Blakey-Milner</surname>
	<contrib>Contributed by in Feb 2000</contrib>
      </author>
    </authorgroup>
  </chapterinfo>
  -->

  <sect1 xml:id="users-synopsis">
    <title>使用者與基礎帳號管理</title>

    <para>FreeBSD 允許多使用者同時使用電腦，在一次只能有一位使用者坐在電腦螢幕前使用鍵盤操作的同時，可讓任何數量的使用者透過網路登入到系統。每一位要使用該系統的使用者應有自己的帳號。</para>

    <para>本章介紹：</para>

    <itemizedlist>
      <listitem>
	<para>FreeBSD 系統中各種類型的使用者帳號。</para>
      </listitem>

      <listitem>
	<para>如何加入、移除與修改使用者帳號。</para>
      </listitem>

      <listitem>
	<para>如何設定用來控制使用者與群組允許存取的資源的限制。</para>
      </listitem>

      <listitem>
	<para>如何建立群組與加入使用者作為群組成員。</para>
      </listitem>
    </itemizedlist>

    <sect2 xml:id="users-introduction">
      <title>帳號類型</title>

      <para>由於所有對 FreeBSD 系統的存取是透過使用者帳號來達成，且所有的程序需要經由使用者來執行，因此使用者帳號管理非常重要。</para>

      <para>有三種主要類型的帳號：系統帳號、使用者帳號以及超級使用者帳號。</para>

      <sect3 xml:id="users-system">
	<title>系統帳號</title>

	<indexterm xml:lang="en">
	  <primary>accounts</primary>
	  <secondary>system</secondary>
	</indexterm>

	<para>系統帳號用來執行服務，例如 DNS、郵件及網頁伺服器，要這麼作是因為安全性考量，若所有的服務均以超級使用者來執行，那麼這些服務的運作將不會受到限制。</para>

	<indexterm xml:lang="en">
	  <primary>accounts</primary>
	  <secondary><systemitem class="username">daemon</systemitem></secondary>
	</indexterm>
	<indexterm xml:lang="en">
	  <primary>accounts</primary>
	  <secondary><systemitem class="username">operator</systemitem></secondary>
	</indexterm>

	<para>系統帳號的例子有 <systemitem class="username">daemon</systemitem>, <systemitem class="username">operator</systemitem>, <systemitem class="username">bind</systemitem>, <systemitem class="username">news</systemitem>, and <systemitem class="username">www</systemitem>。</para>

	<indexterm xml:lang="en">
	  <primary>accounts</primary>
	  <secondary><systemitem class="username">nobody</systemitem></secondary>
	</indexterm>

	<para><systemitem class="username">nobody</systemitem> 是通用的無權限系統帳號。雖然如此，只有要越多的服務使用 <systemitem class="username">nobody</systemitem>，就會有更多的檔案與程式與該使用者相關聯，會讓該使用者擁有更多的權限。</para>
      </sect3>

      <sect3 xml:id="users-user">
	<title>使用者帳號</title>

	<indexterm xml:lang="en">
	  <primary>accounts</primary>
	  <secondary>user</secondary>
	</indexterm>

	<para>使用者帳號會分配給實際人員，用來登入及使用系統。每位要存取系統的人員需要擁有一組唯一的使用者帳號，這可讓管理者辨識誰在做什麼以及避免使用者覆蓋其他使用者的設定。</para>

	<para>每位使用者可以設定自己的環境來配合自己使用系統的習慣，透過設定預設的 Shell、編輯器、組合鍵 (Key Binding) 及語言設定。</para>

	<para>每個在 FreeBSD 系統的使用者帳號都會有一些相關的資訊：</para>

	<variablelist>
	  <varlistentry>
	    <term>使用者名稱 (User name)</term>

	    <listitem>
	      <para>在 <prompt>login:</prompt> 提示出現時便要輸入使用者名稱，每位使用者必須要有一個唯一的使用者名稱。要建立有效的使用者名稱要遵守數條規則，在 <citerefentry><refentrytitle>passwd</refentrytitle><manvolnum>5</manvolnum></citerefentry> 中有說明。建議使用者名稱由 8 個或更少的字母組成，全部採用小寫字元以向下相容應用程式。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>密碼 (Password)</term>

	    <listitem>
	      <para>每個帳號都會有密碼。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>使用者 ID (<acronym>UID</acronym>)</term>

	    <listitem>
	      <para>使用者 ID (User ID, <acronym>UID</acronym>) 是一組數字用來獨一無二的辨識 FreeBSD 系統的使用者，用到使用者名稱的指令會先將使用者名稱轉換為 <acronym>UID</acronym>。建議使用小於 65535 的 UID，超過這個值可能會造成部份軟體的相容性問題。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>群組 ID (<acronym>GID</acronym>)</term>

	    <listitem>
	      <para>群組 ID (Group ID, <acronym>GID</acronym>) 是一組數字用來獨一無二的辨識使用者所屬的主要群組。群組是一個除了使用 <acronym>UID</acronym> 之外根據使用者的 <acronym>GID</acronym> 來控制資源存取權的機制。這可以顯著的降低某些設定檔的大小且可讓使用者成為一個以上群組的成員。建議使用 65535 或以下的 GID，因超過此值的 GID 可能會讓部份軟體無法運作。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>登入類別 (Login class)</term>

	    <listitem>
	      <para>登入類別 (Login class) 擴充了群組機制，當在對不同使用者客製化系統時可提供額外的彈性。在 <xref linkend="users-limiting"/> 有對登入類別更進一步的討論。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>密碼更改時間 (Password change time)</term>

	    <listitem>
	      <para>預設情況下密碼並不會過期，雖然如此，密碼期限可在各別使用者上開啟，可強制部份或所有使用者在某段期間過後更改他們的密碼。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>帳號到期時間 (Account expiration time)</term>

	    <listitem>
	      <para>預設情況下 FreeBSD 的帳號不會有期限。當建立需要有限壽命的帳號時，例如，學校的學生帳號，可使用 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 指定帳號的到期日期。到期日期過後，便無法使用該帳號登入到系統，儘管該帳號的目錄及檔案仍存在。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>使用者的全名 (User's full name)</term>

	    <listitem>
	      <para>使用者名稱用來獨一無二的辦識 FreeBSD 的帳號，但並不一定反映了使用者的真實姓名。類似註解，這個資訊可以含有空白、大寫字元並可超過 8 個字母的長度。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>家目錄 (Home directory)</term>

	    <listitem>
	      <para>家目錄是系統中某個目錄的完整路徑，這個目錄是使用者登入後的起點目錄。習慣上會將所有使用者目錄放置在 <filename><replaceable>/home/username</replaceable></filename> 或 <filename><replaceable>/usr/home/username</replaceable></filename>。每位使用者可以儲存他們的個人檔案及子目錄於他們自己的家目錄。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term>使用者 Shell (User shell)</term>

	    <listitem>
	      <para>Shell 提供了使用者預設的環境來與系統互動。有數種不同類型的 Shell，有經驗的使用者會有自己偏好的選擇，可儲存在自己的帳號設定。</para>
	    </listitem>
	  </varlistentry>
	</variablelist>
      </sect3>

      <sect3 xml:id="users-superuser">
	<title>超級使用者帳號</title>

	<indexterm xml:lang="en">
	  <primary>accounts</primary>
	  <secondary>superuser (root)</secondary>
	</indexterm>

	<para>超級使用者帳號，通常稱作 <systemitem class="username">root</systemitem>，用來管理系統，沒有權限的限制，也因這個原因，該帳號不應該用來做每日的例行作業，如：寄信與收信、系統的一般探索或程式設計。</para>

	<para>超級使用者並不像其他使用者帳號，可以沒有限制的操作，不正確的使用超級使用者帳號可能會造成可觀的災害。一般使用者帳號不會因為失誤而法摧毀作業系統，所以建議登入一般使用者帳號，只有在指令需要額外權限時切換為超級使用者。</para>

	<para>使用超級使用者下指令時永遠要再三檢查，由於一個多餘的空白或缺少的字元可能意味著無法挽回的資料遺失。</para>

	<para>有數種方法可以提升為超級使用者權限，雖然可以直接登入為 <systemitem class="username">root</systemitem>，但強烈不建議這樣做。</para>

	<para>改使用 <citerefentry><refentrytitle>su</refentrytitle><manvolnum>1</manvolnum></citerefentry> 切換為超級使用者。執行此指令時若指定 <literal>-</literal> 參數，該使用者會繼承 root 的使用者環境。執行此指令的使用者必須在 <systemitem class="groupname">wheel</systemitem> 群組中，否則指令會失敗。使用者也必須要知道 <systemitem class="username">root</systemitem> 使用者帳號的密碼。</para>

	<para>在此例當中，該使用者只在要執行 <command>make install</command> 時切換為超級使用者，因為這個步驟需要超級使用者權限。指令完成之後，該使用者輸入 <command>exit</command> 離開超級使用者帳號並返回他的使用者帳號權限。</para>

	<example>
	  <title>以超級使用者的身份安裝程式</title>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>configure</userinput>
<prompt>%</prompt> <userinput>make</userinput>
<prompt>%</prompt> <userinput>su -</userinput>
Password:
<prompt>#</prompt> <userinput>make install</userinput>
<prompt>#</prompt> <userinput>exit</userinput>
<prompt>%</prompt></screen>
	</example>

	<para>內建的 <citerefentry><refentrytitle>su</refentrytitle><manvolnum>1</manvolnum></citerefentry> 框架在單人系統或只有一位系統管理者的小型網路可以運作的很好。另一種方式是安裝 <package>security/sudo</package> 套件或 Port。此軟體提供了活動記錄且允許管理者設定那個使用者可以用超級使用者執行那個指令。</para>
      </sect3>
    </sect2>

    <sect2 xml:id="users-modifying">
      <title>管理帳號</title>

      <indexterm xml:lang="en">
	<primary>accounts</primary>
	<secondary>modifying</secondary>
      </indexterm>

      <para>FreeBSD 提供了各種不同指令來管理使用者帳號，最常用的指令已摘要於 <xref linkend="users-modifying-utilities"/>，接著有一些用法的範例。請參考每個工具的操作手冊來取得更多詳細的資訊與用法範例。</para>

      <table frame="none" pgwide="1" xml:id="users-modifying-utilities">
	<title>管理使用者帳號的工具</title>

	<tgroup cols="2">
	  <colspec colwidth="1*"/>
	  <colspec colwidth="2*"/>

	  <thead>
	    <row>
	      <entry>指令</entry>
	      <entry>摘要</entry>
	    </row>
	  </thead>
	  <tbody>
	    <row>
	      <entry xml:lang="en"><citerefentry><refentrytitle>adduser</refentrytitle><manvolnum>8</manvolnum></citerefentry></entry>
	      <entry>建議用來新增新使用者的指令列應用程式。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><citerefentry><refentrytitle>rmuser</refentrytitle><manvolnum>8</manvolnum></citerefentry></entry>
	      <entry>建議用來移除使用者的指令列應用程式。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><citerefentry><refentrytitle>chpass</refentrytitle><manvolnum>1</manvolnum></citerefentry></entry>
	      <entry>用來更改使用者資料庫資訊的工具。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><citerefentry><refentrytitle>passwd</refentrytitle><manvolnum>1</manvolnum></citerefentry></entry>
	      <entry>用來更改使用者密碼的指令列工具。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry></entry>
	      <entry>用來修改使用者帳號各方面資訊強大且靈活的工具。</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <sect3 xml:id="users-adduser">
	<title xml:lang="en"><command>adduser</command></title>

	<indexterm xml:lang="en">
	  <primary>accounts</primary>
	  <secondary>adding</secondary>
	</indexterm>
	<indexterm xml:lang="en">
	  <primary><command>adduser</command></primary>
	</indexterm>
	<indexterm xml:lang="en">
	  <primary><filename>/usr/share/skel</filename></primary>
	</indexterm>
	<indexterm xml:lang="en">
	  <primary>skeleton directory</primary>
	</indexterm>

	<para>建議用來新增新使用者的程式為 <citerefentry><refentrytitle>adduser</refentrytitle><manvolnum>8</manvolnum></citerefentry>。當新使用者新增之後，此程式會自動更新 <filename>/etc/passwd</filename> 以及 <filename>/etc/group</filename>，這同時也會建立新使用者的家目錄 (複製 <filename>/usr/share/skel</filename> 中的預設設定檔)，並且可以選擇是否要寄送歡迎訊息通知新使用者。這個工具必須使用超級使用者執行。</para>

	<para><citerefentry><refentrytitle>adduser</refentrytitle><manvolnum>8</manvolnum></citerefentry> 工具採用互動的方式，只需幾個步驟便可建立新使用者帳號。如 <xref linkend="users-modifying-adduser"/> 所示，可輸入必填的資訊或按 <keycap>Return</keycap> 鍵採用方括中的預設值。在此例當中，使用者被邀請加入 <systemitem class="groupname">wheel</systemitem> 群組，這讓使用者可使用 <citerefentry><refentrytitle>su</refentrytitle><manvolnum>1</manvolnum></citerefentry> 變成超級使用者。完成之後，此工具會詢問是否要建立其他的使用者或離開。</para>

	<example xml:id="users-modifying-adduser">
	  <title>在 FreeBSD 新增使用者</title>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>adduser</userinput>
Username: <userinput>jru</userinput>
Full name: <userinput>J. Random User</userinput>
Uid (Leave empty for default):
Login group [jru]:
Login group is jru. Invite jru into other groups? []: <userinput>wheel</userinput>
Login class [default]:
Shell (sh csh tcsh zsh nologin) [sh]: <userinput>zsh</userinput>
Home directory [/home/jru]:
Home directory permissions (Leave empty for default):
Use password-based authentication? [yes]:
Use an empty password? (yes/no) [no]:
Use a random password? (yes/no) [no]:
Enter password:
Enter password again:
Lock out the account after creation? [no]:
Username   : jru
Password   : ****
Full Name  : J. Random User
Uid        : 1001
Class      :
Groups     : jru wheel
Home       : /home/jru
Shell      : /usr/local/bin/zsh
Locked     : no
OK? (yes/no): <userinput>yes</userinput>
adduser: INFO: Successfully added (jru) to the user database.
Add another user? (yes/no): <userinput>no</userinput>
Goodbye!
<prompt>#</prompt></screen>
	</example>

	<note>
	  <para>由於密碼在輸入時並不會顯示，在建立使用者帳號時要小心密碼不要輸入錯誤。</para>
	</note>
      </sect3>

      <sect3 xml:id="users-rmuser">
	<title xml:lang="en"><command>rmuser</command></title>

	<indexterm xml:lang="en">
	  <primary><command>rmuser</command></primary>
	</indexterm>
	<indexterm xml:lang="en">
	  <primary>accounts</primary>
	  <secondary>removing</secondary>
	</indexterm>

	<para>要自系統完全移除一個使用者可使用超級使用者執行 <citerefentry><refentrytitle>rmuser</refentrytitle><manvolnum>8</manvolnum></citerefentry>。這個指令會執行以下步驟：</para>

	<procedure>
	  <step>
	    <para>移除使用者的 <citerefentry><refentrytitle>crontab</refentrytitle><manvolnum>1</manvolnum></citerefentry> 項目，若項目存在。</para>
	  </step>

	  <step>
	    <para>移除任何屬於該使用者的 <citerefentry><refentrytitle>at</refentrytitle><manvolnum>1</manvolnum></citerefentry> 工作。</para>
	  </step>

	  <step>
	    <para>中止所有該使用者擁有的程序。</para>
	  </step>

	  <step>
	    <para>自系統本地密碼檔移除該使用者。</para>
	  </step>

	  <step>
	    <para>選擇性移除該使用者的家目錄，若使用者擁有該目錄。</para>
	  </step>

	  <step>
	    <para>自 <filename>/var/mail</filename> 移除屬於該使用者的收件郵件檔。</para>
	  </step>

	  <step>
	    <para>自暫存檔儲存區域 (如 <filename>/tmp</filename>) 移除所有使用者擁有的檔案。</para>
	  </step>

	  <step>
	    <para>最後，自 <filename>/etc/group</filename> 中該使用者所屬的所有群組移除該使用者。若群組無任何成員且群組名稱與該使用者名稱相同，則該群組也會一併移除。這是為了輔助 <citerefentry><refentrytitle>adduser</refentrytitle><manvolnum>8</manvolnum></citerefentry> 替每位使用者建立獨一無二的群組。</para>
	  </step>
	</procedure>

	<para><citerefentry><refentrytitle>rmuser</refentrytitle><manvolnum>8</manvolnum></citerefentry> 無法用來移除超級使用者帳號，因為這幾乎代表著大規模破壞。</para>

	<para>預設會使用互動式模式，如下範例所示。</para>

	<example>
	  <title><command>rmuser</command> 互動式帳號移除</title>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>rmuser jru</userinput>
Matching password entry:
jru:*:1001:1001::0:0:J. Random User:/home/jru:/usr/local/bin/zsh
Is this the entry you wish to remove? <userinput>y</userinput>
Remove user's home directory (/home/jru)? <userinput>y</userinput>
Removing user (jru): mailspool home passwd.
<prompt>#</prompt></screen>
	</example>
      </sect3>

      <sect3 xml:id="users-chpass">
	<title xml:lang="en"><command>chpass</command></title>

	<indexterm xml:lang="en">
	  <primary><command>chpass</command></primary>
	</indexterm>

	<para>任何使用者都可以使用 <citerefentry><refentrytitle>chpass</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來變更自己的預設 Shell 以及與自己的使用者帳號關聯的個人資訊。超級使用者可以使用這個工具更改任何使用者的其他帳號資訊。</para>

	<para>除了選填的使用者名稱外，未傳入任何選項時，<citerefentry><refentrytitle>chpass</refentrytitle><manvolnum>1</manvolnum></citerefentry> 會開啟含有使用者資訊的編輯器。當使用者自編輯器離開，便會更新新的資訊到使用者資料庫。</para>

	<note>
	  <para>離開編輯器時，此工具會提示使用者輸入密碼，除非使用超級使用者執行此工具。</para>
	</note>

	<para>在 <xref linkend="users-modifying-chpass-su"/> 中，超級使用者輸入了 <command>chpass jru</command> 並正在檢視這個使用者可以更改的欄位。若改以 <systemitem class="username">jru</systemitem> 執行這個指令，只會顯示最後六個欄位供編輯，如 <xref linkend="users-modifying-chpass-ru"/> 所示。</para>

	<example xml:id="users-modifying-chpass-su">
	  <title>以超級使用者的身份使用 <command>chpass</command></title>

	  <screen xml:lang="en">#Changing user database information for jru.
Login: jru
Password: *
Uid [#]: 1001
Gid [# or name]: 1001
Change [month day year]:
Expire [month day year]:
Class:
Home directory: /home/jru
Shell: /usr/local/bin/zsh
Full Name: J. Random User
Office Location:
Office Phone:
Home Phone:
Other information:</screen>
	</example>

	<example xml:id="users-modifying-chpass-ru">
	  <title>以一般使用者的身份使用 <command>chpass</command></title>

	  <screen xml:lang="en">#Changing user database information for jru.
Shell: /usr/local/bin/zsh
Full Name: J. Random User
Office Location:
Office Phone:
Home Phone:
Other information:</screen>
	</example>

	<note>
	  <para>指令 <citerefentry><refentrytitle>chfn</refentrytitle><manvolnum>1</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>chsh</refentrytitle><manvolnum>1</manvolnum></citerefentry> 皆連結至 <citerefentry><refentrytitle>chpass</refentrytitle><manvolnum>1</manvolnum></citerefentry>，就如同 <citerefentry><refentrytitle>ypchpass</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <citerefentry><refentrytitle>ypchfn</refentrytitle><manvolnum>1</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>ypchsh</refentrytitle><manvolnum>1</manvolnum></citerefentry> 的關係。自從 NIS 支援自動化以後，便不再需要特別加上 <literal>yp</literal>，如何設定 NIS 在<xref linkend="network-servers"/> 中有說明。</para>
	</note>
      </sect3>

      <sect3 xml:id="users-passwd">
	<title xml:lang="en"><command>passwd</command></title>

	<indexterm xml:lang="en">
	  <primary><command>passwd</command></primary>
	</indexterm>
	<indexterm xml:lang="en">
	  <primary>accounts</primary>
	  <secondary>changing password</secondary>
	</indexterm>

	<para>任何使用者皆可簡單的使用 <citerefentry><refentrytitle>passwd</refentrytitle><manvolnum>1</manvolnum></citerefentry> 更改自己的密碼。要避免意外或未授權的變更，這個指令在設定新密碼之前會提示使用者輸入原來的密碼：</para>

	<example>
	  <title>更改您的密碼</title>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>passwd</userinput>
Changing local password for jru.
Old password:
New password:
Retype new password:
passwd: updating the database...
passwd: done</screen>
	</example>

	<para>超級使用者可以更改任何使用者的密碼透過在執行 <citerefentry><refentrytitle>passwd</refentrytitle><manvolnum>1</manvolnum></citerefentry> 時指定使用者名稱。當此工具以超級使用者執行時，將不會提示輸入使用者目前的密碼，這可在使用者忘記原來的密碼時更改密碼。</para>

	<example>
	  <title>以超級使用者的身份更改其他使用者的密碼</title>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>passwd jru</userinput>
Changing local password for jru.
New password:
Retype new password:
passwd: updating the database...
passwd: done</screen>
	</example>

	<note>
	  <para>如同 <citerefentry><refentrytitle>chpass</refentrytitle><manvolnum>1</manvolnum></citerefentry>，<citerefentry><refentrytitle>yppasswd</refentrytitle><manvolnum>1</manvolnum></citerefentry> 連結到 <citerefentry><refentrytitle>passwd</refentrytitle><manvolnum>1</manvolnum></citerefentry>，因此 <acronym>NIS</acronym> 在兩個指令上皆可運作。</para>
	</note>
      </sect3>

      <sect3 xml:id="users-pw">
	<title xml:lang="en"><command>pw</command></title>

	<indexterm xml:lang="en">
	  <primary><command>pw</command></primary>
	</indexterm>

	<para><citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 工具可以建立、移除、修改以及顯示使用者與群組，它的功能是做為系統使用者與群組檔的前端。<citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 有非常強大的的指令列選項集，這讓該指令非常適合用於 Shell scripts，但新的使用者可能會發現它比其他在本節的指令要複雜許多。</para>
      </sect3>
    </sect2>

    <sect2 xml:id="users-groups">
      <title>管理群組</title>

      <indexterm xml:lang="en">
	<primary>groups</primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><filename>/etc/groups</filename></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>accounts</primary>
	<secondary>groups</secondary>
      </indexterm>

      <para>群組代表一群使用者，群組可以由其群組名稱及 <acronym>GID</acronym> 來辨識。在 FreeBSD，核心會使用程序的 <acronym>UID</acronym> 以及其所屬的群組清單來決定程序可以做那些事。大多數情況使用者或程序的 <acronym>GID</acronym> 通常指的是清單中的第一個群組。</para>

      <para>群組名稱與 <acronym>GID</acronym> 的對應表列在 <filename>/etc/group</filename>。這個純文字檔案使用了四個以冒號分隔的欄位，第一個欄位為群組名稱，第二個欄位為加密後的密碼，第二個欄位為 <acronym>GID</acronym> 以及第四個欄位為以逗號分隔的成員清單。要取得更完整的語法說明，請參考 <citerefentry><refentrytitle>group</refentrytitle><manvolnum>5</manvolnum></citerefentry>。</para>

      <para>超級使用者可以使用文字編輯器修改 <filename>/etc/group</filename>，或者可使用 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 加入與編輯群組。例如，要加入一個叫做 <systemitem class="groupname">teamtwo</systemitem> 的群組然後確認該群組已新增：</para>

      <example>
	<title>使用 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 新增群組</title>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupadd teamtwo</userinput>
<prompt>#</prompt> <userinput>pw groupshow teamtwo</userinput>
teamtwo:*:1100:</screen>
      </example>

      <para>在本例中，<literal>1100</literal> 是 <systemitem class="groupname">teamtwo</systemitem> 的 <acronym>GID</acronym>。目前 <systemitem class="groupname">teamtwo</systemitem> 沒有任何成員，這個指令會加入 <systemitem class="username">jru</systemitem> 作為 <systemitem class="groupname">teamtwo</systemitem> 的成員。</para>

      <example>
	<title>使用 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 加入使用者帳號到新的群組</title>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupmod teamtwo -M jru</userinput>
<prompt>#</prompt> <userinput>pw groupshow teamtwo</userinput>
teamtwo:*:1100:jru</screen>
      </example>

      <para>給 <option>-M</option> 的參數是以逗號分隔的使用者清單，用來加入成員到新的 (空的) 群組或取代既有群組中的成員。對使用者來說這裡的群組成員與使用者列於密碼檔的主要群組不同 (額外的)，這代表在 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 使用 <option>groupshow</option> 時不會顯示做為使用者主要群組的成員，但會顯示在使用 <citerefentry><refentrytitle>id</refentrytitle><manvolnum>1</manvolnum></citerefentry> 或同類工具所查詢的資訊當中。當使用 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來加入使用者到某個群組，該指令只會處理 <filename>/etc/group</filename> 且不會嘗試自 <filename>/etc/passwd</filename> 讀取其他的資料。</para>

      <example>
	<title>使用 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 加入新成員到群組</title>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupmod teamtwo -m db</userinput>
<prompt>#</prompt> <userinput>pw groupshow teamtwo</userinput>
teamtwo:*:1100:jru,db</screen>
      </example>

      <para>在本例當中，給 <option>-m</option> 的參數是以逗號分隔的使用者清單，用來加入使用者到群組。不像前面的例子，這些使用者會加入到群組，而非取代既有群組中的使用者。</para>

      <example>
	<title>使用 <citerefentry><refentrytitle>id</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來查看所屬群組</title>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>id jru</userinput>
uid=1001(jru) gid=1001(jru) groups=1001(jru), 1100(teamtwo)</screen>
      </example>

      <para>在本例中，<systemitem class="username">jru</systemitem> 是群組 <systemitem class="groupname">jru</systemitem> 以及 <systemitem class="groupname">teamtwo</systemitem> 的成員。</para>

      <para>要取得更多有關此指令的資訊及 <filename>/etc/group</filename> 的格式，請參考 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>group</refentrytitle><manvolnum>5</manvolnum></citerefentry>。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="permissions">
    <title>權限</title>

    <indexterm xml:lang="en">
      <primary>UNIX</primary>
    </indexterm>

    <para>在 FreeBSD 中，每個檔案與目都有相關聯的數個權限，且有許多工具可以檢視與修改這些權限。了解權限如何運作是必須的，這可確保使用者能夠存存取它們所需的檔案以及無法不正確的存取供作業系統或其他使用者擁有的檔案。</para>

    <para>本節會探討在 FreeBSD 中所用到的傳統 <trademark class="registered">UNIX</trademark> 權限。要做檔案系統存取控制的微調，請參考 <xref linkend="fs-acl"/>。</para>

    <para>在 <trademark class="registered">UNIX</trademark>，基礎權限透過三種類型的存取來分配：讀取、寫入與執行。這些存取類型用來決定檔案擁有者、群組以及其他人 (其他任何人) 的檔案存取權。讀取、寫入及執行權限可使用 <literal>r</literal>, <literal>w</literal>, and <literal>x</literal> 字母來表示。這些權限也可以使用二進位數字來表示每種權限的開或關 (<literal>0</literal>)。當以二進位數字來表示時，閱讀的順序為 <literal>rwx</literal>，其中 <literal>r</literal> 開啟的值為 <literal>4</literal>，<literal>w</literal> 開啟的值為 <literal>2</literal> 以及 <literal>x</literal> 開啟的值為 <literal>1</literal>。</para>

    <para>表格 4.1 摘要了可用的數字及可用的字母。當閱讀 <quote>目錄清單標示</quote> 欄位時，<literal>-</literal> 用來代表該權限設為關閉。</para>

    <indexterm xml:lang="en">
      <primary>permissions</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>file permissions</primary>
    </indexterm>

    <table frame="none" pgwide="1">
      <title><trademark class="registered">UNIX</trademark> 權限</title>

      <tgroup cols="3">
	<thead>
	  <row>
	    <entry>數值</entry>
	    <entry>權限</entry>
	    <entry>目錄清單標示</entry>
	  </row>
	</thead>

	<tbody>
	  <row>
	    <entry xml:lang="en">0</entry>
	    <entry>不可讀取, 不可寫入, 不可執行</entry>
	    <entry xml:lang="en"><literal>---</literal></entry>
	  </row>

	  <row>
	    <entry xml:lang="en">1</entry>
	    <entry>不可讀取, 不可寫入, 可執行</entry>
	    <entry xml:lang="en"><literal>--x</literal></entry>
	  </row>

	  <row>
	    <entry xml:lang="en">2</entry>
	    <entry>不可讀取, 可寫入, 不可執行</entry>
	    <entry xml:lang="en"><literal>-w-</literal></entry>
	  </row>

	  <row>
	    <entry xml:lang="en">3</entry>
	    <entry>不可讀取, 可寫入, 可執行</entry>
	    <entry xml:lang="en"><literal>-wx</literal></entry>
	  </row>

	  <row>
	    <entry xml:lang="en">4</entry>
	    <entry>可讀取, 不可寫入, 不可執行</entry>
	    <entry xml:lang="en"><literal>r--</literal></entry>
	  </row>

	  <row>
	    <entry xml:lang="en">5</entry>
	    <entry>可讀取, 不可寫入, 可執行</entry>
	    <entry xml:lang="en"><literal>r-x</literal></entry>
	  </row>

	  <row>
	    <entry xml:lang="en">6</entry>
	    <entry>可讀取, 可寫入, 不可執行</entry>
	    <entry xml:lang="en"><literal>rw-</literal></entry>
	  </row>

	  <row>
	    <entry xml:lang="en">7</entry>
	    <entry>可讀取, 可寫入, 可執行</entry>
	    <entry xml:lang="en"><literal>rwx</literal></entry>
	  </row>
	</tbody>
      </tgroup>
    </table>

    <indexterm xml:lang="en">
      <primary><citerefentry><refentrytitle>ls</refentrytitle><manvolnum>1</manvolnum></citerefentry></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>directories</primary>
    </indexterm>

    <para>使用 <citerefentry><refentrytitle>ls</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令時，可以加上 <option>-l</option> 參數， 來檢視詳細的目錄清單。 清單中欄位的資訊包含檔案對所有者、群組及其他人的權限。 在任一個目錄底下執行 <command>ls -l</command>，會顯示如下的結果：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>ls -l</userinput>
total 530
-rw-r--r--  1 root  wheel     512 Sep  5 12:31 myfile
-rw-r--r--  1 root  wheel     512 Sep  5 12:31 otherfile
-rw-r--r--  1 root  wheel    7680 Sep  5 12:31 email.txt</screen>

    <para>第一個 (最左邊) 的字元用來表示這個檔案的類型為何，除標準檔案以外，尚有目錄、特殊字元裝置、Socket 及其他特殊虛擬檔案裝置， 在此例當中，<literal>-</literal> 表示該檔案為一個標準的檔案。 範例中接下來的三個字元中，<literal>rw-</literal> 代表所有者對檔案擁有的權限。 再接下來的三個字元， <literal>r--</literal> 則代表群組對檔案擁有的權限， 最後三個字元，<literal>r--</literal> 則代表其他人對檔案擁有的權限。 破折號 (-) 表示沒有權限，範例中的這個檔案的權限， 只允許所有者讀取、寫入檔案，群組以及其他人僅能讀取檔案。 根據以上的表格，此種權限的檔案可以使用 <literal>644</literal> 來表示， 每組數字分別代表檔案的三種權限。</para>

    <para>那系統如何控制裝置的權限？ 實際上 FreeBSD 對大多的硬碟裝置就如同檔案，程式可以開啟、讀取以及寫入資料如一般檔案。 這些特殊裝置檔案都儲存於 <filename>/dev/</filename> 目錄中。</para>

    <para>目錄也同如檔案，擁有讀取、寫入及執行的權限， 但在執行權限上與檔案有明顯的差異。 當目錄被標示為可執行時，代表可以使用 <citerefentry><refentrytitle>cd</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令切換進入該目錄。 也代表能夠存取在此目錄之中的已知檔名的檔案，但仍會受限於檔案本身所設定的權限。</para>

    <para>要能夠列出目錄內容，必須擁有目錄的讀取權限。 要刪除已知檔名的檔案，必須擁有檔案所在目錄的寫入 <emphasis>以及</emphasis> 執行的權限。</para>

    <para>還有一些權限位元，但這些權限主要在特殊情況使用，如 setuid 執行檔及 sticky 目錄。 如果您還想知道更多檔案權限的資訊及使用方法，請務必參閱 <citerefentry><refentrytitle>chmod</refentrytitle><manvolnum>1</manvolnum></citerefentry>。</para>

    <sect2>
      <info>
	<title>權限符號</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Tom</firstname>
	      <surname>Rhodes</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <indexterm xml:lang="en">
	<primary>permissions</primary>
	<secondary>symbolic</secondary>
      </indexterm>

      <para>權限符號可稱做符號表示，使用字元的方式來取代使用數值來設定檔案或目錄的權限。 符號表示的格式依序為 (某人)(動作)(權限)，可使用的符號如下：</para>

      <informaltable frame="none" pgwide="1">
	<tgroup cols="3">
	  <thead>
	    <row>
	      <entry>項目</entry>
	      <entry>字母</entry>
	      <entry>代表意義</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry>(某人)</entry>
	      <entry xml:lang="en">u</entry>
	      <entry>使用者</entry>
	    </row>

	    <row>
	      <entry>(某人)</entry>
	      <entry xml:lang="en">g</entry>
	      <entry>群組所有者</entry>
	    </row>

	    <row>
	      <entry>(某人)</entry>
	      <entry xml:lang="en">o</entry>
	      <entry>其他</entry>
	    </row>

	    <row>
	      <entry>(某人)</entry>
	      <entry xml:lang="en">a</entry>
	      <entry>全部 (<quote>world</quote>)</entry>
	    </row>

	    <row>
	      <entry>(動作)</entry>
	      <entry xml:lang="en">+</entry>
	      <entry>增加權限</entry>
	    </row>

	    <row>
	      <entry>(動作)</entry>
	      <entry xml:lang="en">-</entry>
	      <entry>移除權限</entry>
	    </row>

	    <row>
	      <entry>(動作)</entry>
	      <entry xml:lang="en">=</entry>
	      <entry>指定權限</entry>
	    </row>

	    <row>
	      <entry>(權限)</entry>
	      <entry xml:lang="en">r</entry>
	      <entry>讀取</entry>
	    </row>

	    <row>
	      <entry>(權限)</entry>
	      <entry xml:lang="en">w</entry>
	      <entry>寫入</entry>
	    </row>

	    <row>
	      <entry>(權限)</entry>
	      <entry xml:lang="en">x</entry>
	      <entry>執行</entry>
	    </row>

	    <row>
	      <entry>(權限)</entry>
	      <entry xml:lang="en">t</entry>
	      <entry>Sticky 位元</entry>
	    </row>

	    <row>
	      <entry>(權限)</entry>
	      <entry xml:lang="en">s</entry>
	      <entry>設定 UID 或 GID</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable>

      <para>如先前同樣使用 <citerefentry><refentrytitle>chmod</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令來設定，但使用的參數為這些字元。 例如，您可以使用下列指令禁止其他使用者存取檔案 <replaceable>FILE</replaceable>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>chmod go= FILE</userinput></screen>

      <para>若有兩個以上的權限更改可以使用逗號 (,) 區隔。 例如，下列指令將會移除群組及全部人 (<quote>world</quote>) 對檔案 <replaceable>FILE</replaceable> 的寫入權限， 並使全部人對該檔有執行權限：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>chmod go-w,a+x <replaceable>FILE</replaceable></userinput></screen>

<!--
      <para>Most users will not notice this, but it should be pointed
	out that using the octal method will only set or assign
	permissions to a file; it does not add or delete them.</para>
-->
    </sect2>

    <sect2>
      <info>
	<title>FreeBSD 檔案旗標</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Tom</firstname>
	      <surname>Rhodes</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para>除了前面提到的檔案權限外，FreeBSD 支援使用 <quote>檔案旗標</quote>。 這些旗標增加了檔案的安全性及管理性，但不包含目錄。有了檔案旗標可確保在某些時候 <systemitem class="username">root</systemitem> 不會意外將檔案修改或移除。</para>

      <para>修改的檔案 flag 僅需要使用擁有簡易的介面的 <citerefentry><refentrytitle>chflags</refentrytitle><manvolnum>1</manvolnum></citerefentry> 工具。 例如，標示系統禁止刪除的旗標於檔案 <filename>file1</filename>，使用下列指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>chflags sunlink file1</userinput></screen>

      <para>若要移除系統禁止刪除的旗標，只需要簡單在 <option>sunlink</option> 前加上 <quote>no</quote>，例如：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>chflags nosunlink file1</userinput></screen>

      <para>使用 <citerefentry><refentrytitle>ls</refentrytitle><manvolnum>1</manvolnum></citerefentry> 及參數 <option>-lo</option> 可檢視檔案目前的旗標：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ls -lo file1</userinput></screen>

      <programlisting xml:lang="en">-rw-r--r--  1 trhodes  trhodes  sunlnk 0 Mar  1 05:54 file1</programlisting>

      <para>多數的旗標僅能由 <systemitem class="username">root</systemitem> 使用者來標示或移除，而部份旗標可由檔案所有者設定。 我們建議系統管理者可閱讀 <citerefentry><refentrytitle>chflags</refentrytitle><manvolnum>1</manvolnum></citerefentry> 及 <citerefentry><refentrytitle>chflags</refentrytitle><manvolnum>2</manvolnum></citerefentry> 說明以瞭解相關細節。</para>
    </sect2>

    <sect2>
      <info>
	<title><literal>setuid</literal> 、<literal>setgid</literal> 與 <literal>sticky</literal> 權限</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Tom</firstname>
	      <surname>Rhodes</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para>除了已經探討過的權限外，這裡尚有另外三種特別的設定所有管理者都應該知道，這些設定為 <literal>setuid</literal>, <literal>setgid</literal> 以及 <literal>sticky</literal> 權限。</para>

      <para>這些設定對某些一般不會授權給一般使用者的 <trademark class="registered">UNIX</trademark> 操作非常重要，它讓這些功能可運作。要了解這些權限，就必須說明真實使用者 ID (Real user ID) 與有效使用者 ID (Effective user ID) 的差異。</para>

      <para>真實使用者 ID 即是擁有者或啟動程序者的 <acronym>UID</acronym>，而有效 <acronym>UID</acronym> 是執行程序所使用的使用者 ID。例如，<citerefentry><refentrytitle>passwd</refentrytitle><manvolnum>1</manvolnum></citerefentry> 在使用者更改自己的密碼時會以真實使用者 ID 執行，然而，為了要更新密碼資料庫，該指令必須以 <systemitem class="username">root</systemitem> 使用者做為有效 ID 來執行，這讓使用者可以更改自己的密碼而不會遇到權限不足 (<errorname>Permission Denied</errorname>) 的錯誤。</para>

      <para>setuid 權限可以透過在權限集前加上數字 (4) 來設定，如下範例所示：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>chmod 4755 suidexample.sh</userinput></screen>

      <para>現在 <filename><replaceable>suidexample.sh</replaceable></filename> 的權限會如下所示：</para>

      <programlisting xml:lang="en">-rwsr-xr-x   1 trhodes  trhodes    63 Aug 29 06:36 suidexample.sh</programlisting>

      <para>注意，<literal>s</literal> 現在取代了原來的執行位元成為指定檔案擁有者權限集的一部份，這會允許須要提升權限的工具，如 <citerefentry><refentrytitle>passwd</refentrytitle><manvolnum>1</manvolnum></citerefentry> 可正常使用。</para>

      <note>
	<para><citerefentry><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的 <literal>nosuid</literal> 選項會造成這類 Binary 執行失敗，但不會警告使用者。由於 <literal>nosuid</literal> Wrapper 可能可繞過該選項，因此該選項並非完全可靠。</para>
      </note>

      <para>實際來看這個範例，先開啟兩個終端機，其中一個用一般使用者輸入 <command>passwd</command>。在等待輸入新密碼的同時，檢查程序表並查看 <citerefentry><refentrytitle>passwd</refentrytitle><manvolnum>1</manvolnum></citerefentry> 程序的使用者資訊：</para>

      <para>於終端機 A：</para>

      <screen xml:lang="en">Changing local password for trhodes
Old Password:</screen>

      <para>於終端機 B：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ps aux | grep passwd</userinput></screen>

      <screen xml:lang="en">trhodes  5232  0.0  0.2  3420  1608   0  R+    2:10AM   0:00.00 grep passwd
root     5211  0.0  0.2  3620  1724   2  I+    2:09AM   0:00.01 passwd</screen>

      <para>雖然使用一般使用者來執行 <citerefentry><refentrytitle>passwd</refentrytitle><manvolnum>1</manvolnum></citerefentry>，但該程序使用了 <systemitem class="username">root</systemitem> 的有效 <acronym>UID</acronym>。</para>

      <para><literal>setgid</literal> 權限的功能與 <literal>setuid</literal> 相似，當應用程式或工具使用此設定執行時，將會以擁有該檔案的群組來執行，而非執行行該程序的使用者。</para>

      <para>要在檔案設定 <literal>setgid</literal> 權限，需在 <citerefentry><refentrytitle>chmod</refentrytitle><manvolnum>1</manvolnum></citerefentry> 的參數前加上 (2)：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>chmod 2755 sgidexample.sh</userinput></screen>

      <para>注意以下清單中，<literal>s</literal> 現在位於指定群組權限設定的欄位：</para>

      <screen xml:lang="en">-rwxr-sr-x   1 trhodes  trhodes    44 Aug 31 01:49 sgidexample.sh</screen>

      <note>
	<para>在以上這些範例中，雖然在例子中的 Shell script 是可執行的檔案，但並不會以其他的 <acronym>EUID</acronym> 或有效使用者 ID 執行，這是因為 Shell script 並不會存取 <citerefentry><refentrytitle>setuid</refentrytitle><manvolnum>2</manvolnum></citerefentry> 系統呼叫 (System call)。</para>
      </note>

      <para><literal>setuid</literal> 及 <literal>setgid</literal> 權限位元可能會因允許提升權限而降低系統的安全性，因此有了第三個特殊的權限：<literal>sticky bit</literal>，可以加強系統的安全性。</para>

      <para>當在目錄上設定 <literal>sticky bit</literal>，將只允許由檔案擁有者刪除檔案。這對避免公開目錄，如 <filename>/tmp</filename> 中的檔案被不擁有該檔案的人刪除非常有用。要使用這個權限，可在權限集前加上 (1)：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>chmod 1777 /tmp</userinput></screen>

      <para><literal>sticky bit</literal> 權限會以 <literal>t</literal> 顯示於權限集的最後：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ls -al / | grep tmp</userinput></screen>

      <screen xml:lang="en">drwxrwxrwt  10 root  wheel         512 Aug 31 01:49 tmp</screen>

    </sect2>
  </sect1>

  <sect1 xml:id="dirstructure">
    <title>目錄結構</title>

    <indexterm xml:lang="en">
      <primary>directory hierarchy</primary>
    </indexterm>

    <para>認識 FreeBSD 的目錄架構，就可對系統有概略的基礎理解。 最重要的莫過於整個目錄的根目錄，就是 <quote>/</quote> 目錄， 該目錄會在開機時最先掛載 (mount)，裡面會有開機所會用到必備檔案。 此外，根目錄還有紀錄其他檔案系統的掛載點相關設定。</para>

    <para>「掛載點」就是讓新增的檔案系統，能接到上層的檔案系統 (通常就是「根目錄」檔案系統) 的目錄。 在 <xref linkend="disk-organization"/> 這邊對此有更詳細介紹。 標準的掛載點包括了 <filename>/usr/</filename>, <filename>/var/</filename>, <filename>/tmp/</filename>, <filename>/mnt/</filename> 以及 <filename>/cdrom/</filename>。 這些目錄通常會記錄在 <filename>/etc/fstab</filename> 設定檔內。 <filename>/etc/fstab</filename> 是記錄各檔案系統及相關掛載點的表格。 大部分在 <filename>/etc/fstab</filename> 有記錄的檔案系統，會在開機時由 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> Script 來自動掛載，除非它們有設定 <option>noauto</option> 選項。 其中細節說明可參閱 <xref linkend="disks-fstab"/>。</para>

    <para>有關檔案系統架構的完整說明可參閱 <citerefentry><refentrytitle>hier</refentrytitle><manvolnum>7</manvolnum></citerefentry>。 現在呢，讓我們大致先一窺常見的目錄有哪些吧。</para>

    <para>
      <informaltable frame="none" pgwide="1">
	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>目錄</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>
	  <tbody valign="top">
	    <row>
	      <entry xml:lang="en"><filename>/</filename></entry>
	      <entry>檔案系統的根目錄。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/bin/</filename></entry>
	      <entry>單使用者 (Single-user)、多使用者 (Multi-user) 兩種模式皆可使用的基本工具 。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/boot/</filename></entry>
	      <entry>作業系統開機過程會用到的程式、設定檔。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/boot/defaults/</filename></entry>
	      <entry>預設的開機啟動設定檔，詳情請參閱 <citerefentry><refentrytitle>loader.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/dev/</filename></entry>
	      <entry>裝置節點 (Device node)，詳情請參閱 <citerefentry><refentrytitle>intro</refentrytitle><manvolnum>4</manvolnum></citerefentry>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/etc/</filename></entry>
	      <entry>系統設定檔及一些 Script 檔。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/etc/defaults/</filename></entry>
	      <entry>預設的系統設定檔，詳情請參閱 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/etc/mail/</filename></entry>
	      <entry>郵件傳輸代理程式，像是 <citerefentry><refentrytitle>sendmail</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的相關設定檔。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/etc/periodic/</filename></entry>
	      <entry>每日、每週、每月透過 <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry>，執行的定期排程 Script，詳情請參閱 <citerefentry><refentrytitle>periodic</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/etc/ppp/</filename></entry>
	      <entry><citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry> 設定檔。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/mnt/</filename></entry>
	      <entry>系統管理者慣用充當臨時掛載點的空目錄。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/proc/</filename></entry>
	      <entry>程序 (Process) 檔案系統，詳情請參閱 <citerefentry><refentrytitle>procfs</refentrytitle><manvolnum>5</manvolnum></citerefentry> 及 <citerefentry><refentrytitle>mount_procfs</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/rescue/</filename></entry>
	      <entry>緊急救援用途的一些靜態連結 (Statically linked) 的程式，詳情請參閱 <citerefentry><refentrytitle>rescue</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/root/</filename></entry>
	      <entry><systemitem class="username">root</systemitem> 帳號的家目錄。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/sbin/</filename></entry>
	      <entry>供單使用者 (Single-user) 及多使用者 (Multi-user) 環境使用的系統程式及管理工具 。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/tmp/</filename></entry>
	      <entry>臨時檔案。 一般而言，重開機之後 /tmp 內的東西會被<emphasis>清除</emphasis>掉。 而通常會將以記憶體為基礎 (Memory-based) 的檔案系統掛載在 <filename>/tmp</filename> 上。 這些瑣事可透過 tmpmfs 相關的 <citerefentry><refentrytitle>rc.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 環境變數來自動完成 。(或是在 <filename>/etc/fstab</filename> 內做設定， 詳情請參閱 <citerefentry><refentrytitle>mdmfs</refentrytitle><manvolnum>8</manvolnum></citerefentry>)。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/</filename></entry>
	      <entry>主要是使用者所安裝的工具程式、應用程式存放處。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/bin/</filename></entry>
	      <entry>常用工具、開發工具、應用軟體。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/include/</filename></entry>
	      <entry>標準 C include 檔案。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/lib/</filename></entry>
	      <entry>程式庫存放處。</entry>
	    </row>


	    <row>
	      <entry xml:lang="en"><filename>/usr/libdata/</filename></entry>
	      <entry>其他各式工具的資料檔。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/libexec/</filename></entry>
	      <entry>系統 Daemon 及系統工具程式 (透過其他程式來執行)。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/local/</filename></entry>
	      <entry>存放一些自行安裝的執行檔、程式庫等等。 同時，也是 FreeBSD Port 架構的預設安裝目錄。 <filename>/usr/local</filename> 內的目錄架構大致與 <filename>/usr</filename> 相同，詳情請參閱 <citerefentry><refentrytitle>hier</refentrytitle><manvolnum>7</manvolnum></citerefentry> 說明。 但 man 目錄例外，它們是直接放在 <filename>/usr/local</filename> 底下，而非 <filename>/usr/local/share</filename>，而 Port 所安裝的說明文件則在 <filename>share/doc/<replaceable>port</replaceable></filename>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/obj/</filename></entry>
	      <entry>在編譯 <filename>/usr/src</filename> 目錄時所產生的相關架構目地檔。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/ports/</filename></entry>
	      <entry>FreeBSD Port 套件集 (選用)。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/sbin/</filename></entry>
	      <entry>由使用者執行的系統 Daemon 及系統工具。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/share/</filename></entry>
	      <entry>各架構皆共通的檔案。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/src/</filename></entry>
	      <entry>BSD 原始碼 (或自行新增的)。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/var/</filename></entry>
	      <entry>存放各種用途的日誌 (Log) 檔、臨時或暫時存放、列印或郵件的緩衝 (Spool) 檔案。有時候，以記憶體為基礎 (Memory-based) 的檔案系統也會掛載在 <filename>/var</filename>。 這些瑣事可透過 varmfs 相關的 <citerefentry><refentrytitle>rc.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 環境變數來自動完成。(或是在 <filename>/etc/fstab</filename> 內做設定，相關細節請參閱 <citerefentry><refentrytitle>mdmfs</refentrytitle><manvolnum>8</manvolnum></citerefentry>)。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/var/log/</filename></entry>
	      <entry>各項系統記錄的日誌 (Log) 檔。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/var/mail/</filename></entry>
	      <entry>各使用者的郵件 (Mailbox) 檔案。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/var/spool/</filename></entry>
	      <entry>各種印表機、郵件系統的緩衝 (Spool) 目錄。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/var/tmp/</filename></entry>
	      <entry>臨時檔案。 這些檔案在重開機後通常仍會保留，除非 <filename>/var</filename> 是屬於以記憶體為基礎 (Memory-based) 的檔案系統。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/var/yp/</filename></entry>
	      <entry>NIS 對應表。</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable></para>
  </sect1>

  <sect1 xml:id="disk-organization">
    <title>磁碟組織</title>

    <para>FreeBSD 用來尋找檔案的最小單位就是檔案的名稱了。 檔案的名稱有大小寫之分，所以說 <filename>readme.txt</filename> 和 <filename>README.TXT</filename> 是兩個不同的檔案。 FreeBSD 並不使用副檔名 (.txt) 來判別這是一個程式檔、文件檔或是其他類型的檔案。</para>

    <para>檔案存在目錄裡面。 一個目錄中可能沒有任何檔案，也可能有好幾百個檔案。 目錄之中也可以包含其他的目錄； 您可以建立階層式的目錄以便資料的管理。</para>

    <para>檔案或目錄的對應是藉由給定的檔案或目錄名稱，然後加上正斜線符號 (<literal>/</literal>)；之後再視需要加上其他的目錄名稱。 如果您有一個目錄 <filename>foo</filename> ，裡面有一個目錄叫作 <filename>bar</filename>，這個目錄中又包含了一個叫 <filename>readme.txt</filename> 的檔案，那麼這個檔案的全名，或者說檔案的<firstterm>路徑 (Path)</firstterm>就是 <filename>foo/bar/readme.txt</filename>。注意這與 <trademark class="registered">Windows</trademark> 用來分隔檔案與目錄名稱所使用的 <literal>\</literal> 不同，且 FreeBSD 在路徑上並不使用磁碟機代號或其他磁碟機名稱，意思是，在 FreeBSD 上不會有人輸入 <filename>c:\foo\bar\readme.txt</filename> 這種路徑。</para>

    <para>目錄及檔案儲存在檔案系統 (File system) 之中。 每個檔案系統都有唯一一個最上層的目錄，叫做<firstterm>根目錄 (Root directory)</firstterm>。 然後在這個根目錄下面才能有其他的目錄。其中一個檔案系統會被指定成為<firstterm>根檔案系統 (Root file system)</firstterm> 或 <literal>/</literal>，其他的檔案系統均會<firstterm>掛載 (Mount)</firstterm> 在該根檔案系統之下，不論在 FreeBSD 有多少個磁碟，所有目錄都會成為該磁碟的一部份。</para>

    <para>假設您有三個檔案系統，分別叫作 <literal>A</literal>, <literal>B</literal> 及 <literal>C</literal>。 每個檔案系統都包含兩個目錄，叫做 <literal>A1</literal>, <literal>A2</literal> (以此類推得 <literal>B1</literal>, <literal>B2</literal> 及 <literal>C1</literal>, <literal>C2</literal>)。</para>

    <para>稱 <literal>A</literal> 為主要的檔案系統；如果您用 <citerefentry><refentrytitle>ls</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令查看此目錄的內容，您會看到兩個子目錄： <literal>A1</literal> 及 <literal>A2</literal>，如下所示：</para>

    <mediaobject>
      <imageobject>
	<imagedata fileref="basics/example-dir1"/>
      </imageobject>

      <textobject>
	<literallayout class="monospaced" xml:lang="en"> /
 |
 +--- A1
 |
 `--- A2</literallayout>
      </textobject>
    </mediaobject>

    <para>一個檔案系統必須以目錄形式掛載於另一個檔案系統上。 因此，假設您將 <literal>B</literal> 掛載於 <literal>A1</literal> 之上，則 <literal>B</literal> 的根目錄就變成了 <literal>A1</literal>，而在 <literal>B</literal> 之下的任何目錄的路徑也隨之改變：</para>

    <mediaobject>
      <imageobject>
	<imagedata fileref="basics/example-dir2"/>
      </imageobject>

      <textobject>
	<literallayout class="monospaced" xml:lang="en"> /
 |
 +--- A1
 |     |
 |     +--- B1
 |     |
 |     `--- B2
 |
 `--- A2</literallayout>
      </textobject>
    </mediaobject>

    <para>在 <literal>B1</literal> 或 <literal>B2</literal> 目錄中的任何檔案必須經由路徑 <filename>/A1/B1</filename> 或 <filename>/A1/B2</filename> 才能達到。 所有原來在 <filename>/A1</filename> 中的檔案會暫時被隱藏起來，直到 <literal>B</literal> 被<firstterm>卸載 (Unmount)</firstterm> 後才會再顯現出來。</para>

    <para>如果 <literal>B</literal> 掛載在 <literal>A2</literal> 之上，則會變成：</para>

    <mediaobject>
      <imageobject>
	<imagedata fileref="basics/example-dir3"/>
      </imageobject>

      <textobject>
	<literallayout class="monospaced" xml:lang="en"> /
 |
 +--- A1
 |
 `--- A2
       |
       +--- B1
       |
       `--- B2</literallayout>
      </textobject>
    </mediaobject>

    <para>上面的路徑分別為 <filename>/A2/B1</filename> 及 <filename>/A2/B2</filename>。</para>

    <para>檔案系統可以掛在其他檔案系統的目錄之上。 延續之前的例子，<literal>C</literal> 檔案系統可以掛在檔案系統 <literal>B</literal> 的 <literal>B1</literal> 目錄之上，如圖所示：</para>

    <mediaobject>
      <imageobject>
	<imagedata fileref="basics/example-dir4"/>
      </imageobject>

      <textobject>
	<literallayout class="monospaced" xml:lang="en"> /
 |
 +--- A1
 |
 `--- A2
       |
       +--- B1
       |     |
       |     +--- C1
       |     |
       |     `--- C2
       |
       `--- B2</literallayout>
      </textobject>
    </mediaobject>

    <para>或者 <literal>C</literal> 直接掛載於 <literal>A</literal> 的 <literal>A1</literal> 目錄之上：</para>

    <mediaobject>
      <imageobject>
	<imagedata fileref="basics/example-dir5"/>
      </imageobject>

      <textobject>
	<literallayout class="monospaced" xml:lang="en"> /
 |
 +--- A1
 |     |
 |     +--- C1
 |     |
 |     `--- C2
 |
 `--- A2
       |
       +--- B1
       |
       `--- B2</literallayout>
      </textobject>
    </mediaobject>

    <para>您可以使用單一的一個大的根檔案系統而不建立其他的檔案系統。 這樣有好處也有有壞處。</para>

    <itemizedlist>
      <title>使用多個檔案系統的好處</title>

      <listitem>
	<para>不同的檔案系統在掛上的時候可以有不同的 <firstterm>掛載參數 (Mount option)</firstterm>。 舉例來說，為求謹慎您可以將根檔案系統設成唯讀， 以避免不小心刪除或修改掉重要的檔案。 將使用者可寫入的檔案系統 (例如 <filename>/home</filename>) 獨立出來也可以讓他們用 <firstterm>nosuid</firstterm> 的參數掛載，此選項可以讓在這個檔案系統中執行檔的 <firstterm>suid</firstterm>/<firstterm>guid</firstterm> 位元失效，可讓系統更安全。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 會自動根據您檔案系統的使用方式來做最佳的檔案配置方式。 因此，一個有很多小檔案、 常常寫入的檔案系統跟只有幾個較大的檔案的檔案系統配置是不一樣的。 如果您只有單一個大的檔案系統，這部分就沒用了。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 的檔案系統在停電的時候很穩固。 然而，在某些重要的時候停電仍然會對檔案系統結構造成損害。 分割成許多個檔案系統的話在系統在停電後比較能夠正常啟動， 以便您在需要的時候將備份資料回存回來。</para>
      </listitem>
    </itemizedlist>

    <itemizedlist>
      <title>使用單一檔案系統的好處</title>

      <listitem>
	<para>檔案系統的大小是固定的。 若您在當初安裝 FreeBSD 的時指定了一個大小，可是後來您想把空間加大，在沒有備份的情況下很難達成，您必須將檔案系統重新建立為您需要的大小，然後將備份回存回來。</para>

	<important>
	  <para>FreeBSD 的 <citerefentry><refentrytitle>growfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> 指令可以突破此限制直接變更檔案系統的大小。</para>
	</important>
      </listitem>
    </itemizedlist>

    <para>檔案系統放在分區 (Partition) 中。 因為 FreeBSD 承襲 <trademark class="registered">UNIX</trademark> 架構，這邊講的分區和一般提到的分割區 (例如 <trademark class="registered">MS-DOS</trademark> 分割區) 不同。每一個分區由一個代號 (字母) 表示，從 <literal>a</literal> 到 <literal>h</literal>。 每個分區只能含有一個檔案系統，因此在表示檔案系統時，除了用該檔案系統的常用的掛載點表示外，也可以使用該檔案系統所在的分區來表示。</para>

    <para>FreeBSD 也會使用磁碟空間作為<firstterm>交換空間 (Swap space)</firstterm> 來提供<firstterm>虛擬記憶體 (Virtual memory)</firstterm>。 這讓您的電腦好像擁有比實際更多的記憶體。 當 FreeBSD 的記憶體用完的時候，它會把一些目前沒用到的資料移到交換空間，然後在用到的時候移回去 (同時移出部份沒用到的)。</para>

    <para>有些分割區有特定的使用慣例。</para>

    <informaltable frame="none" pgwide="1">
      <tgroup cols="2">
	<colspec colwidth="1*"/>
	<colspec colwidth="5*"/>

	<thead>
	  <row>
	    <entry>分區</entry>
	    <entry>慣例</entry>
	  </row>
	</thead>

	<tbody valign="top">
	  <row>
	    <entry xml:lang="en"><literal>a</literal></entry>
	    <entry>通常含有根檔案系統。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><literal>b</literal></entry>
	    <entry>通常含有交換空間。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><literal>c</literal></entry>
	    <entry>通常用來代表整個切割區 (Slice)，因此大小會與其所在的切割區一樣。這可讓需要對整個切割區處理的工具 (例如硬碟壞軌檢查工具) 可在 <literal>c</literal> 分區上執行。一般來說不會把檔案系統建立在這個分區。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><literal>d</literal></entry>
	    <entry>分區 <literal>d</literal> 曾經有代表特殊意義，但是已經不再使用。所以現在 <literal>d</literal> 和一般的分區相同。</entry>
	  </row>
	</tbody>
      </tgroup>
    </informaltable>

    <para>在 FreeBSD 的磁碟會分割成數個切割區 (Slice)，如同 <trademark class="registered">Windows</trademark> 中由編號 1 到 4 表示的分割區。這些切割區會再分成數個分區，每個分區內含檔案系統，且會使用字母來標示。</para>

    <indexterm xml:lang="en">
      <primary>slices</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>partitions</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>dangerously dedicated</primary>
    </indexterm>

    <para>切割區的編號在裝置名稱後面，會先以 <literal>s</literal> 為字首，然後從 1 開始編號。 因此 <quote>da0<emphasis>s1</emphasis></quote> 是指第一個 SCSI 硬碟的第一個切割區。 一個磁碟上只能有四個實體切割區，但是在實體切割區中放進適當類型的邏輯切割區。這些延伸的切割區編號會從 5 開始，所以 <quote>ada0<emphasis>s5</emphasis></quote> 是第一個 SATA 硬碟上的第一個延伸切割區。因此可以預期這些由檔案系統使用的裝置 (Device) 上均會各別佔據一個切割區。</para>

    <para>切割區、<quote>危險專用 (Dangerously dedicated)</quote> 的實體磁碟機以及其他內含<firstterm>分割區 (Partition)</firstterm> 的磁碟都是以字母 <literal>a</literal> 到 <literal>h</literal> 來表示。 字母會接在裝置名稱的後面，因此 <quote>da0<emphasis>a</emphasis></quote> 是第一顆 <quote>dangerously dedicated</quote> 磁碟機 <literal>da</literal> 上的 <literal>a</literal> 分割區。 而 <quote>ada1s3<emphasis>e</emphasis></quote> 則是第二顆 SATA 硬碟上第三個切割區的第五個分區。</para>

    <para>終於，我們可以辨識系統上的每個磁碟了，一個磁碟的名稱會有一個代碼來表示這個磁碟的類型，接著是一個表示這是那一個磁碟的編號。不像切割區，磁碟的編號從 0 開始。常見的代碼可以參考 <xref linkend="disks-naming"/>。</para>

    <para>當要參照一個分區的時候，需包含磁碟機名稱、<literal>s</literal>、切割區編號以及分區字母。範例可以參考 <xref linkend="basics-disk-slice-part"/>。</para>

    <para><xref linkend="basics-concept-disk-model"/> 示範了一個基本的磁碟配置，相信對您有些幫助。</para>

    <para>要安裝 FreeBSD，您必須先建置磁碟的切割區，接著於切割區中建立要給 FreeBSD 用的分區。 最後在這些分區中建立檔案系統 (或交換空間) 並決定要將這些檔案系統掛載於哪裡。</para>

    <table frame="none" pgwide="1" xml:id="disks-naming">
      <title>磁碟裝置名稱</title>

      <tgroup cols="2">
	<colspec colwidth="1*"/>
	<colspec colwidth="5*"/>

	<thead>
	  <row>
	    <entry>磁碟機類型</entry>
	    <entry>磁碟機裝置稱</entry>
	  </row>
	</thead>

	<tbody>
	  <row>
	    <entry><acronym>SATA</acronym> 及 <acronym>IDE</acronym> 硬碟</entry>
	    <entry><literal>ada</literal> 或 <literal>ad</literal></entry>
	  </row>

	  <row>
	    <entry><acronym>SCSI</acronym> 硬碟與 <acronym>USB</acronym> 儲存裝置</entry>
	    <entry xml:lang="en"><literal>da</literal></entry>
	  </row>

	  <row>
	    <entry><acronym>SATA</acronym> 與 <acronym>IDE</acronym> <acronym>CD-ROM</acronym> 光碟機</entry>
	    <entry><literal>cd</literal> 或 <literal>acd</literal></entry>
	  </row>

	  <row>
	    <entry><acronym>SCSI</acronym> <acronym>CD-ROM</acronym> 光碟機</entry>
	    <entry xml:lang="en"><literal>cd</literal></entry>
	  </row>

	  <row>
	    <entry>軟碟機</entry>
	    <entry xml:lang="en"><literal>fd</literal></entry>
	  </row>

	  <row>
	    <entry>各種非標準 <acronym>CD-ROM</acronym> 光碟機</entry>
	    <entry><literal>mcd</literal> 代表 Mitsumi <acronym>CD-ROM</acronym> 以及 <literal>scd</literal> 代表 Sony <acronym>CD-ROM</acronym> 光碟機</entry>
	  </row>

	  <row>
	    <entry><acronym>SCSI</acronym> 磁帶機</entry>
	    <entry xml:lang="en"><literal>sa</literal></entry>
	  </row>

	  <row>
	    <entry><acronym>IDE</acronym> 磁帶機</entry>
	    <entry xml:lang="en"><literal>ast</literal></entry>
	  </row>

	  <row>
	    <entry>RAID 磁碟機</entry>
	    <entry>範例包含 <literal>aacd</literal> 代表 <trademark class="registered">Adaptec</trademark> AdvancedRAID，<literal>mlxd</literal> 及 <literal>mlyd</literal> 代表 <trademark class="registered">Mylex</trademark>，<literal>amrd</literal> 代表 AMI <trademark class="registered">MegaRAID</trademark>，<literal>idad</literal> 代表 Compaq Smart RAID，<literal>twed</literal> 代表 <trademark class="registered">3ware</trademark> RAID.</entry>
	  </row>
	</tbody>
      </tgroup>
    </table>

    <example xml:id="basics-disk-slice-part">
      <title>磁碟、切割區及分區命名範例</title>

      <informaltable frame="none" pgwide="1">
	<tgroup cols="2">
	  <colspec colwidth="1*"/>
	  <colspec colwidth="5*"/>

	  <thead>
	    <row>
	      <entry>名稱</entry>
	      <entry>意義</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><literal>ada0s1a</literal></entry>
	      <entry>第一個 SATA 硬碟 (<literal>ada0</literal>) 上第一個切割區 (<literal>s1</literal>)的第一個分區(<literal>a</literal>) 。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><literal>da1s2e</literal></entry>
	      <entry>第二個 SCSI 硬碟 (<literal>da1</literal>) 上第二個切割區 (<literal>s2</literal>) 的第五個分區 (<literal>e</literal>) 。</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable>
    </example>

    <example xml:id="basics-concept-disk-model">
      <title>磁碟的概念模型</title>

      <para>此圖顯示 FreeBSD 中連接到系統的第一個 <acronym>SATA</acronym> 磁碟機內部配置圖。 假設這個磁碟的容量是 250 GB，並且包含了一個 80 GB 的切割區及一個 170 GB 的切割區 (<trademark class="registered">MS-DOS</trademark> 的分割區)。 第一個切割區是 <trademark class="registered">Windows</trademark> <acronym>NTFS</acronym> 檔案系統的 <filename>C:</filename> 磁碟機，第二個則安裝了 FreeBSD。 本範例中安裝的 FreeBSD 有四個資料分區及一個交換分區。</para>

      <para>這四個分區中各有一個檔案系統。 分區 <literal>a</literal> 是根檔案系統、分區 <literal>d</literal> 是 <filename>/var/</filename>、分區 <literal>e</literal> 是 <filename>/tmp/</filename>，而分區 <literal>f</literal> 是 <filename>/usr/</filename>。分區字母 <literal>c</literal> 用來代表整個切割區，因此並不作為一般分區使用。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="basics/disk-layout"/>
	</imageobject>
      </mediaobject>
    </example>
  </sect1>

  <sect1 xml:id="mount-unmount">
    <title>掛載與卸載檔案系統</title>

    <para>檔案系統就像一顆樹。<filename>/</filename> 就像是樹根，而 <filename>/dev</filename>，<filename>/usr</filename> 以及其他在根目錄下的目錄就像是樹枝，而這些樹枝上面又還有分支，像是 <filename>/usr/local</filename> 等。</para>

    <indexterm xml:lang="en">
      <primary>root file system</primary>
    </indexterm>

    <para>因為某些原因，我們會將一些目錄分別放在不同的檔案系統上。 如 <filename>/var</filename> 包含了可能會滿出來的 <filename>log/</filename>，<filename>spool/</filename> 等目錄以及各式各樣的暫存檔。 把根檔案系統塞到滿出來顯然不是個好主意，所以我們往往會比較傾向把 <filename>/var</filename> 從 <filename>/</filename> 中拉出來。</para>

    <para>另一個常見到把某些目錄放在不同檔案系統上的理由是： 這些檔案在不同的實體或虛擬磁碟機上。 像是網路檔案系統 (Network File System) 詳情可參考 <xref linkend="network-nfs"/> 或是光碟機。</para>

    <sect2 xml:id="disks-fstab">
      <title><filename>fstab</filename> 檔</title>

      <indexterm xml:lang="en">
	<primary>file systems</primary>
	<secondary>mounted with fstab</secondary>
      </indexterm>

      <para>在 <filename>/etc/fstab</filename> 裡面有設定的檔案系統會在開機 (<xref linkend="boot"/>) 的過程中自動地被掛載 (除非該檔案系統有被加上 <option>noauto</option> 參數)。檔案內容的格式如下：</para>

      <programlisting xml:lang="en"><replaceable>device</replaceable>       <replaceable>/mount-point</replaceable> <replaceable>fstype</replaceable>     <replaceable>options</replaceable>      <replaceable>dumpfreq</replaceable>     <replaceable>passno</replaceable></programlisting>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en"><literal>device</literal></term>
	  <listitem>
	    <para>已存在的裝置名稱，詳情請參閱 <xref linkend="disks-naming"/>。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><literal>mount-point</literal></term>

	  <listitem>
	    <para>檔案系統要掛載到的目錄 (該目錄必須存在)。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><literal>fstype</literal></term>

	  <listitem>
	    <para>檔案系統類型，這是要傳給 <citerefentry><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的參數。 FreeBSD 預設的檔案系統是 <literal>ufs</literal>。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><literal>options</literal></term>

	  <listitem>
	    <para>可讀可寫 (Read-Write) 的檔案系統用 <option>rw</option>，而唯讀 (Read-Only) 的檔案系統則是用 <option>ro</option>，後面視需要還可以加其他選項。 常見的選項如 <option>noauto</option> 是用在不要於開機過程中自動的掛載的檔案系統。 其他選項可參閱 <citerefentry><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry> 說明。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><literal>dumpfreq</literal></term>

	  <listitem>
	    <para><citerefentry><refentrytitle>dump</refentrytitle><manvolnum>8</manvolnum></citerefentry> 由此項目決定那些檔案系統需要傾印。 如果這格空白則以零為預設值。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><literal>passno</literal></term>

	  <listitem>
	    <para>這個項目決定檔案系統檢查的順序。 對於要跳過檢查的檔案系統，它們的 <literal>passno</literal> 值要設為零。 根檔案系統的 <literal>passno</literal> 值應設為一 (因為需要比所有其他的還要先檢查)，而其他的檔案系統的 <literal>passno</literal> 值應該要設得比一大。 若有多個檔案系統具有相同的 <literal>passno</literal> 值，則 <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry> 會試著平行地 (如果可能的話) 檢查這些檔案系統。</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para>更多關於 <filename>/etc/fstab</filename> 檔案格式及選項的資訊請參閱 <citerefentry><refentrytitle>fstab</refentrytitle><manvolnum>5</manvolnum></citerefentry> 說明文件。</para>
    </sect2>

    <sect2 xml:id="disks-mount">
      <title>使用 <citerefentry><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry></title>

      <indexterm xml:lang="en">
	<primary>file systems</primary>
	<secondary>mounting</secondary>
      </indexterm>

      <para><citerefentry><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry> 指令是拿來掛載檔案系統用的。基本的操作指令格式如下：</para>

      <informalexample>
	<screen xml:lang="en"><prompt>#</prompt> <userinput>mount <replaceable>device</replaceable> <replaceable>mountpoint</replaceable></userinput></screen>
      </informalexample>

      <para>在 <citerefentry><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry> 裡面有提到一大堆的選項，不過最常用的就是這些：</para>

      <variablelist>
	<title>掛載選項</title>

	<varlistentry>
	  <term xml:lang="en"><option>-a</option></term>

	  <listitem>
	    <para>把 /etc/fstab 裡面所有還沒有被掛載、沒有被標記成 <filename>/etc/fstab</filename> 而且沒有用 <option>-t</option> 排除的檔案系統掛載起來。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><option>-d</option></term>

	  <listitem>

	    <para>執行所有的動作，但是不真的去呼叫掛載的系統呼叫 (System call)。 這個選項和 <option>-v</option> 搭配拿來推測 <citerefentry><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry> 將要做什麼動作時很好用。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><option>-f</option></term>

	  <listitem>
	    <para>強迫掛載不乾淨的檔案系統 (危險)，或是用來強制取消寫入權限 (把檔案系統的掛載狀態從可存取變成唯讀)。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><option>-r</option></term>

	  <listitem>
	    <para>用唯讀的方式掛載檔案系統。 這個選項和在 -o 選項中指定 ro 參數是一樣的。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><option>-t</option>
	    <replaceable>fstype</replaceable></term>

	  <listitem>
	    <para>用指定的檔案系統型態來掛載指定的檔案系統，或是在有 <option>-a</option> 選項時只掛載指定型態的檔案系統。預設的檔案系統類型為 <quote>ufs</quote>。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><option>-u</option></term>

	  <listitem>
	    <para>更新檔案系統的掛載選項。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><option>-v</option></term>

	  <listitem>
	    <para>顯示詳細資訊。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><option>-w</option></term>

	  <listitem>
	    <para>以可讀寫的模式掛載檔案系統。</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para><option>-o</option> 選項後面會接著以逗號分隔的參數：</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">nosuid</term>

	  <listitem>
	    <para>不解析檔案系統上的 setuid 或 setgid 旗標， 這也是一個蠻有用的安全選項。</para>
	  </listitem>
	</varlistentry>
      </variablelist>
    </sect2>

    <sect2 xml:id="disks-umount">
      <title>使用 <citerefentry><refentrytitle>umount</refentrytitle><manvolnum>8</manvolnum></citerefentry></title>

      <indexterm xml:lang="en">
	<primary>file systems</primary>
	<secondary>unmounting</secondary>
      </indexterm>

      <para>要卸載檔案系統可使用 <citerefentry><refentrytitle>umount</refentrytitle><manvolnum>8</manvolnum></citerefentry> 指令。該指令需要一個參數可以是掛載點 (mountpoint)，裝置名稱，以及 <option>-a</option> 或是 <option>-A</option> 等選項。</para>

      <para>加上 <option>-f</option> 可以強制卸載，加上 <option>-v</option> 則是會顯示詳細資訊。 要注意的是一般來說用 <option>-f</option> 並不是個好主意，強制卸載檔案系統有可能會造成電腦當機， 或者損壞檔案系統內的資料。</para>

      <para><option>-a</option> 和 <option>-A</option> 是用來卸載所有已掛載的檔案系統，另外還可以用 <option>-t</option> 來指定要卸載的是哪些種類的檔案系統。 要注意的是 <option>-A</option> 並不會試圖卸載根檔案系統。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="basics-processes">
    <title>程序與 Daemon</title>

    <para>FreeBSD 是一個多工的作業系統，也就是說在同一時間內可以跑超過一個程式。 每一個正在花時間跑的程式就叫做<firstterm>程序 (Process)</firstterm>。 您下的每個指令都至少會開啟一個新的程序， 而有些系統程序是一直在跑以維持系統正常運作的。</para>

    <para>每一個程序都有一個獨一無二的數字叫做 <firstterm>程序代號 (Process ID, <acronym>PID</acronym>)</firstterm>，而且就像檔案一樣，每一個程序也有擁有者及群組。 擁有者及群組的資訊是用來決定什麼檔案或裝置是這個程序可以開啟的 (前面有提到過檔案權限)。 大部份的程序都有父程序。 父程序是開啟這個程序的程序，例如：您對 Shell 輸入指令，Shell 本身就是一個程序，而您執行的指令也是程序。 每一個您用這種方式跑的程序的父程序都是 Shell。 有一個特別的程序叫做 <citerefentry><refentrytitle>init</refentrytitle><manvolnum>8</manvolnum></citerefentry> 是個例外，在 FreeBSD 開機的時候 init 會自動地被開啟，init 永遠是第一個程序，所以他的 <acronym>PID</acronym> 一直都會是 <literal>1</literal>。</para>

    <para>有些程式並不是設計成一直在接收使用者的輸入的， 而是在開始執行的時候就從中斷與終端機的連線。 例如說， 網頁伺服器整天都在回應網頁方面的要求，它通常不需要您輸入任何東西。 另外，像是把信從一個站傳送到另一個站的程式，也是這種類型的應用程式。我們把這種程式稱作 <firstterm>Daemon</firstterm>。 Daemon 一詞是來自是希臘神話中的角色：祂們既不屬於善良陣營或邪惡陣營，祂們在背地裡做一些有用的事情。這也就是為何 BSD 的吉祥物，是一隻穿著帆布鞋拿著三叉耙的快樂小惡魔的原因。</para>

    <para>通常來說做為 Deamon 執行的程式名字後面都會加一個字母 <quote>d</quote>。 <application>BIND</application> 是 Berkeley Internet Name Domain 的縮寫，但實際上執行的程式名稱是 <command>named</command>、<application>Apache</application> 網頁伺服器的程式名稱是 <command>httpd</command>、行列式印表機緩衝服務 (Line Printer Spooling) Daemon 是 <command>lpd</command>，依此類推。 但這是習慣用法，並沒有硬性規定，例如 <application>Sendmail</application> 主要的寄信 Daemon 是叫做 <command>sendmail</command> 而不是 <literal>maild</literal>。</para>

    <sect2>
      <title>檢視程序</title>

      <para>要看系統執行中的程序，有兩個相當有用的指令可用： <citerefentry><refentrytitle>ps</refentrytitle><manvolnum>1</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>top</refentrytitle><manvolnum>1</manvolnum></citerefentry>。<citerefentry><refentrytitle>ps</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令是用來列出正在執行之程序，而且可以顯示它們的 <acronym>PID</acronym>、用了多少記憶體、執行的指令名稱及其後之參數是什麼等等。 <citerefentry><refentrytitle>top</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令則是顯示所有正在執行的程序， 並且數秒鐘更新一次。因此您可以互動式的觀看您的電腦正在做什麼。</para>

      <para>在預設的情況下，<citerefentry><refentrytitle>ps</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令只會顯示使用者所擁有的的程序。 例如：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>ps</userinput>
 PID TT  STAT    TIME COMMAND
8203  0  Ss   0:00.59 /bin/csh
8895  0  R+   0:00.00 ps</screen>

      <para>在這個範例裡可以看到 <citerefentry><refentrytitle>ps</refentrytitle><manvolnum>1</manvolnum></citerefentry> 的輸出分成好幾個欄位。 <literal>PID</literal> 就是前面有提到的程序代號。 <literal>PID</literal> 的分配是從 1 開始一直到 99999，如果用完的話又會繞回來重頭開始分配 (若該 <acronym>PID</acronym> 已經在用了，則 PID 不會重新分配)。 <literal>TT</literal> 欄位是指這個程式在哪個 Console (tty) 上執行，在這裡可以先忽略不管。<literal>STAT</literal> 是程式的狀態，也可以先不要管。<literal>TIME</literal> 是這個程式在 CPU 上執行的時間—這通常不是程式總共花的時間， 因為當您開始執行程式後，大部份的程式在 CPU 上執行前會先花上不少時間等待 。 最後，<literal>COMMAND</literal> 是執行這個程式的指令。</para>

      <para>有幾個不同的選項組合可以用來變更顯示出來的資訊，其中一個最有用的組合是 <literal>auxww</literal>。 <option>a</option> 可以顯示所有正在跑的程序的指令，不只是您自已的。 <option>u</option> 則是顯示程序的擁有者名稱以及記憶體使用情況。 <option>x</option> 可以把 daemon 程序顯示出來， 而 <option>ww</option> 可讓 <citerefentry><refentrytitle>ps</refentrytitle><manvolnum>1</manvolnum></citerefentry> 顯示出每個程序完整的內容， 而不致因過長而被螢幕截掉了。</para>

      <para><citerefentry><refentrytitle>top</refentrytitle><manvolnum>1</manvolnum></citerefentry> 也有類似的輸出。 一般的情況看像是這樣：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>top</userinput>
last pid:  9609;  load averages:  0.56,  0.45,  0.36              up 0+00:20:03  10:21:46
107 processes: 2 running, 104 sleeping, 1 zombie
CPU:  6.2% user,  0.1% nice,  8.2% system,  0.4% interrupt, 85.1% idle
Mem: 541M Active, 450M Inact, 1333M Wired, 4064K Cache, 1498M Free
ARC: 992M Total, 377M MFU, 589M MRU, 250K Anon, 5280K Header, 21M Other
Swap: 2048M Total, 2048M Free

  PID USERNAME    THR PRI NICE   SIZE    RES STATE   C   TIME   WCPU COMMAND
  557 root          1 -21  r31   136M 42296K select  0   2:20  9.96% Xorg
 8198 dru           2  52    0   449M 82736K select  3   0:08  5.96% kdeinit4
 8311 dru          27  30    0  1150M   187M uwait   1   1:37  0.98% firefox
  431 root          1  20    0 14268K  1728K select  0   0:06  0.98% moused
 9551 dru           1  21    0 16600K  2660K CPU3    3   0:01  0.98% top
 2357 dru           4  37    0   718M   141M select  0   0:21  0.00% kdeinit4
 8705 dru           4  35    0   480M    98M select  2   0:20  0.00% kdeinit4
 8076 dru           6  20    0   552M   113M uwait   0   0:12  0.00% soffice.bin
 2623 root          1  30   10 12088K  1636K select  3   0:09  0.00% powerd
 2338 dru           1  20    0   440M 84532K select  1   0:06  0.00% kwin
 1427 dru           5  22    0   605M 86412K select  1   0:05  0.00% kdeinit4</screen>

      <para>輸出的資訊分成兩個部份。開頭 (前五行或六行) 顯示出最近一個程序的 <acronym>PID</acronym>、系統平均負載 (系統忙磁程度評估方式)、系統的開機時間 (自上次重新開機) 以及現在的時間等。 在開頭裡面的其他數字分別是在講有多少程序正在執行、有多少記憶體及交換空間被占用了，還有就是系統分別花了多少時間在不同的 CPU 狀態上。若有載入 <acronym>ZFS</acronym> 檔案系統模組，會有一行 <literal>ARC</literal> 標示有多少資料從磁碟改由記憶體快取中取得。</para>

      <para>接下來的部份是由好幾個欄位所構成，和 <citerefentry><refentrytitle>ps</refentrytitle><manvolnum>1</manvolnum></citerefentry> 輸出的資訊類似。 就如同前例，您可以看到 <acronym>PID</acronym>、使用者名稱、CPU 花費的時間以及正在執行的指令。 <citerefentry><refentrytitle>top</refentrytitle><manvolnum>1</manvolnum></citerefentry> 在預設的情況下還會告訴您程序用掉了多少的記憶體空間。 在這邊會分成兩欄，一個是總用量 (Total size)，另一個是實際用量 (Resident size)——總用量是指這個應用程式需要的記憶體空間，而實際用量則是指目前實際上該程式的記憶體使用量。</para>

      <para>top(1) 每隔 2 秒鐘會自動更新顯示內容，可用 <option>-s</option> 選項來改變間隔的時間。</para>
    </sect2>

    <sect2 xml:id="basics-daemons">
      <title>終止程序</title>

      <para>要與執行中的程序或 Daemon 溝通唯一的方法是透過 <citerefentry><refentrytitle>kill</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令傳送<firstterm>信號 (Signal)</firstterm>。 信號有很多種，有些有特定的意義，有些則是會由應用程式來解讀，應用程式的說明文件會告訴您該程式是如何解讀信號。 使用者只能送信號給自己所擁有的程序，送信號給其他人的程序會出現權限不足的錯誤。 唯一的例外是 <systemitem class="username">root</systemitem>使用者，他可以送信號給任何人的程序。</para>

      <para>作業系統在某些情況也會送信號給應用程式。 假設有個應用程式寫得不好，企圖要存取它不該碰的記憶體的時候，FreeBSD 會送一個 <quote>Segmentation Violation</quote> 信號 (<literal>SIGSEGV</literal>) 給這個程序。 如果有一個應用程式用了 <citerefentry><refentrytitle>alarm</refentrytitle><manvolnum>3</manvolnum></citerefentry> 的系統呼叫 (System call) 要求系統在過一段時間之後發出通知，時間到了的時候系統就會發出<quote>通知</quote>信號 (<literal>SIGALRM</literal>) 給該程式。</para>

      <para><literal>SIGTERM</literal> 與 <literal>SIGKILL</literal> 這兩個信號可以拿來終止程序。 用 <literal>SIGTERM</literal> 結束程序是比較有禮貌的方式，該程序收到信號後可以把自已所使用的日誌檔關閉及其他要在結束前要做的事完成， 然後在關掉程序之前結束掉手邊的工作。 在某些情況下程序有可能會忽略 <literal>SIGTERM</literal>，如它正在做一些不能中斷的工作的話。</para>

      <para><literal>SIGKILL</literal> 就沒有辦法被程序忽略。 傳送 <literal>SIGKILL</literal> 信號給程序通常會將程序直接中止<footnote><para>還是有少數東西不能被中斷。 例如有個程序正在從網路上的別的電腦讀一個檔案， 而那部電腦因為某些理由連不到，那這個程序就是一個 <quote>不能中斷的</quote> 程序。 通常在經過 2 分鐘左右之後這個程序會逾時。 當發生逾時的時候這個程序就會被結束掉了。</para></footnote>。</para>

      <para>其他常用的信號有：<literal>SIGHUP</literal>, <literal>SIGUSR1</literal> 及 <literal>SIGUSR2</literal>。 這些是通用的信號，對不同的應用程式會有不同的反應。</para>

      <para>舉例來說，當您更動了網頁伺服器的設定檔，您想要叫網頁伺服器去重新讀取設定。 重新啟動 <command>httpd</command> 會造成網頁伺服器暫停服務一段時間，我們可以傳送 <literal>SIGHUP</literal> 信號來取代關掉重開。 不同的 Daemon 會有不同的行為，所以使用前請先參考 Deamon 的說明文件查看是否可以達到想要的結果。</para>

      <procedure>
	<title>送信號給程序</title>

	<para>這個範例將會示範如何送一個信號給 <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry>。<citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的設定檔是 <filename>/etc/inetd.conf</filename>，而 <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 會在收到 <literal>SIGHUP</literal> 的時候重新讀取這個設定檔。</para>

	<step>
	  <para>使用 <citerefentry><refentrytitle>pgrep</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來查詢要傳送信號的目標程序。 在這個例子中 <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的 <acronym>PID</acronym> 為 198：</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>pgrep -l inetd</userinput>
198  inetd -wW</screen>

	</step>

	<step>
	  <para>使用 <citerefentry><refentrytitle>kill</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來發送信號。因為 <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 是 <systemitem class="username">root</systemitem> 所有，因此必須先用 <citerefentry><refentrytitle>su</refentrytitle><manvolnum>1</manvolnum></citerefentry> 切換成 <systemitem class="username">root</systemitem> 先。</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>su</userinput>
<prompt>Password:</prompt>
<prompt>#</prompt> <userinput>/bin/kill -s HUP 198</userinput></screen>

	  <para>對大多數 <trademark class="registered">UNIX</trademark> 指令來講，<citerefentry><refentrytitle>kill</refentrytitle><manvolnum>1</manvolnum></citerefentry> 執行成功時並不會輸出任何訊息。 假設您送一個信號給某個不是使用者所擁有的程序， 那麼就會顯示這個錯誤訊息： <errorname>kill: <replaceable>PID</replaceable>: Operation not permitted</errorname>。 若打錯 <acronym>PID</acronym> 的話，那就會把信號送給錯誤的程序，並把該程序關閉，或者是把信號送給一個非使用中的 <acronym>PID</acronym>，那您就會看到錯誤：<errorname>kill: <replaceable>PID</replaceable>: No such process</errorname>。</para>

	  <note>
	    <title>為何要使用 <command>/bin/kill</command>？</title>

	    <para>多數 Shell 都有提供內建的 <command>kill</command> 指令。 也就是說這種 shell 會直接發送信號，而不是執行 <filename>/bin/kill</filename>。 但要小心不同的 shell 會有不同的語法來指定信號的名稱等。 與其嘗試去把它們通通學會，不如就單純的直接用 <command>/bin/kill</command>。</para>
	  </note>
	</step>
      </procedure>

      <para>要送其他的信號的話也是非常類似，就視需要把指令中的 <literal>TERM</literal> 或 <literal>KILL</literal> 替換成其他信號的名稱即可。</para>

      <important>
	<para>隨便抓一個系統中的程序然後把他砍掉並不是個好主意。 特別是 <citerefentry><refentrytitle>init</refentrytitle><manvolnum>8</manvolnum></citerefentry>， <acronym>PID</acronym> 1 是一個非常特別的程序。 執行 <command>/bin/kill -s KILL 1</command> 的結果就是系統立刻關機。 因此在您按下 <keycap>Return</keycap> 要執行 <citerefentry><refentrytitle>kill</refentrytitle><manvolnum>1</manvolnum></citerefentry> 之前， 請<emphasis>一定要</emphasis>記得再次確認您下的參數。</para>
      </important>
    </sect2>
  </sect1>

  <sect1 xml:id="shells">
    <title>Shell</title>

    <indexterm xml:lang="en">
      <primary>shells</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>command line</primary>
    </indexterm>

    <para><firstterm>Shell</firstterm> 提供了指令列介面可用來與作業系統互動，Shell 負責從輸入的頻道接收指令並執行它們。 多數 Shell 也內建一些有助於日常工作的功能，像是檔案管理、檔案搜尋、指令列編輯、指令巨集以及環境變數等。 FreeBSD 有內附了幾個 Shell，包含 Bourne Shell (<citerefentry><refentrytitle>sh</refentrytitle><manvolnum>1</manvolnum></citerefentry>)，與改良版的 C-shell (<citerefentry><refentrytitle>tcsh</refentrytitle><manvolnum>1</manvolnum></citerefentry>)。 還有許多其他的 Shell 可以從 FreeBSD Port 套件集中取得，像是 <command>zsh</command> 以及 <command>bash</command> 等。</para>

    <para>要用哪個 Shell 牽涉到每個人的喜好。 如果您是一個 C 程式設計師，那對於使用像是 <citerefentry><refentrytitle>tcsh</refentrytitle><manvolnum>1</manvolnum></citerefentry> 這種 C-like 的 shell 可能會感到較容易上手。 如果是 <trademark class="registered">Linux</trademark> 的使用者，那您也許會想要用 <command>bash</command>。 每一個 Shell 都有自已獨特之處，至於這些特點能不能符合使用者的喜好，就是您選擇 shell 的重點了。</para>

    <para>常見的 Shell 功能之一就是檔名自動補齊。 首先輸入指令或檔案的前幾個字母，然後按下 <keycap>Tab</keycap> 鍵，Shell 就會自動把指令或是檔案名稱剩餘的部份補齊。 假設您有兩個檔案分別叫作 <filename>foobar</filename> 及 <filename>football</filename>。 要刪掉 <filename>foobar</filename>，那麼可以輸入 <command>rm foo</command> 然後按下 <keycap>Tab</keycap> 來補齊檔名。</para>

    <para>但 Shell 只顯示了 <command>rm foo</command>，這代表它沒有辦法完全自動補齊檔名，因為有不只一個檔名符合條件。 <filename>foobar</filename> 和 <filename>football</filename> 都是 <literal>foo</literal> 開頭的檔名。 有一些 Shell 會有嗶的音效或者顯示所有符符條件的檔名。 使用者只需要多打幾個字元來分辦想要的檔名。 輸入 <literal>t</literal> 然後再按 <keycap>Tab</keycap> 一次，那 Shell 就能夠替您把剩下的檔名填滿了。</para>

    <indexterm xml:lang="en">
      <primary>environment variables</primary>
    </indexterm>

    <para>Shell 的另一項特點是使用了環境變數。 環境變數是以變數與鍵值 (Variable/Key) 的對應關係儲存於 Shell 的環境，任何由該 Shell 所產生的程序都可以讀取此環境變數， 因此環境變數儲存了許多程序的設定。 <xref linkend="shell-env-vars"/> 提供了常見的環境變數與其涵義的清單。 請注意環境變數的名稱永遠以大寫表示。</para>

    <table xml:id="shell-env-vars" frame="none" pgwide="1">
      <title>常用環境變數</title>

      <tgroup cols="2">
	<thead>
	  <row>
	    <entry>變數</entry>
	    <entry>說明</entry>
	  </row>
	</thead>

	<tbody>
	  <row>
	    <entry xml:lang="en"><envar>USER</envar></entry>
	    <entry>目前登入的使用者名稱。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><envar>PATH</envar></entry>
	    <entry>以冒號 (:) 隔開的目錄列表，用以搜尋執行檔的路徑。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><envar>DISPLAY</envar></entry>
	    <entry>若存在這個環境變數，則代表 <application>Xorg</application> 顯示器的網路名稱。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><envar>SHELL</envar></entry>
	    <entry>目前使用的 Shell。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><envar>TERM</envar></entry>

	    <entry>使用者終端機類型的名稱，用來判斷終端機有那些功能。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><envar>TERMCAP</envar></entry>

	    <entry>用來執行各種終端機功能的終端機跳脫碼 (Terminal escape code) 的資料庫項目。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><envar>OSTYPE</envar></entry>
	    <entry>作業系統的類型。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><envar>MACHTYPE</envar></entry>
	    <entry>系統的 CPU 架構。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><envar>EDITOR</envar></entry>
	    <entry>使用者偏好的文字編輯器。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><envar>PAGER</envar></entry>
	    <entry>使用者偏好的文字分頁檢視工具。</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><envar>MANPATH</envar></entry>
	    <entry>以冒號 (:) 隔開的目錄列表，用以搜尋使用手冊的路徑。</entry>
	  </row>
	</tbody>
      </tgroup>
    </table>

    <indexterm xml:lang="en">
      <primary>Bourne shells</primary>
    </indexterm>

    <para>在不同的 Shell 底下設定環境變數的方式也有所不同。 在 <citerefentry><refentrytitle>tcsh</refentrytitle><manvolnum>1</manvolnum></citerefentry> 和 <citerefentry><refentrytitle>csh</refentrytitle><manvolnum>1</manvolnum></citerefentry>，使用 <command>setenv</command> 來設定環境變數。 在 <citerefentry><refentrytitle>sh</refentrytitle><manvolnum>1</manvolnum></citerefentry> 和 <command>bash</command> 則使用 <command>export</command> 來設定目前環境的變數。 以下範例將 <citerefentry><refentrytitle>tcsh</refentrytitle><manvolnum>1</manvolnum></citerefentry> Shell 下的 <envar>EDITOR</envar> 環境變數從預設值更改為 <filename>/usr/local/bin/emacs</filename>：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>setenv EDITOR /usr/local/bin/emacs</userinput></screen>

    <para>相同功能的指令在 <command>bash</command> 下則是：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>export EDITOR="/usr/local/bin/emacs"</userinput></screen>

    <para>要展開以顯示目前環境變數中的值，只要在指令列輸入環境變數之前加上 <literal>$</literal> 字元。 舉例來說，<command>echo $TERM</command> 會顯示出目前 <envar>$TERM</envar> 的設定值。</para>

    <para>Shell 中有特殊字元用來表示特殊資料，我們將其稱作 Meta-character。 其中最常見的 Meta-character 是 <literal>*</literal> 字元，它代表了檔名中的任意字元。 Meta-character 可以用在搜尋檔名，舉例來說，輸入 <command>echo *</command> 會和輸入 <command>ls</command> 得到幾乎相同的結果，這是因為 shell 會將所有符合 <literal>*</literal> 字元的檔案由 <command>echo</command> 顯示出來。</para>

    <para>為了避免 Shell 轉譯這些特殊字元，我們可以在這些特殊字元前放一個反斜線 (<literal>\</literal>) 字元使他們跳脫 (Escape) Shell 的轉譯。舉例來說，<command>echo $TERM</command> 會印出你目前終端機的設定， <command>echo \$TERM</command> 則會直接印出 <literal>$TERM</literal> 這幾個字。</para>

    <sect2 xml:id="changing-shells">
      <title>變更 Shell</title>

      <para>永久變更 Shell 最簡單的方法就是透過 <command>chsh</command> 指令。 執行 <command>chsh</command> 將會使用環境變數中 <envar>EDITOR</envar> 指定的文字編輯器，如果沒有設定，則預設是 <citerefentry><refentrytitle>vi</refentrytitle><manvolnum>1</manvolnum></citerefentry>。 請修改 <literal>Shell:</literal> 為新的 Shell 的完整路徑。</para>

      <para>或者，使用 <command>chsh -s</command>， 來直接設定 Shell 而不開啟文字編輯器。 例如， 假設想把 Shell 更改為 <command>bash</command>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>chsh -s /usr/local/bin/bash</userinput></screen>

      <note>
	<para>新的 Shell <emphasis>必須</emphasis>已列於 <filename>/etc/shells</filename> 裡頭。 若是依 <xref linkend="ports"/> 說明由 Port 套件集來裝的 Shell， 那就會自動列入至該檔案裡。 若仍缺少，請使用以下指令加入檔案 (請將路徑替換為新的 Shell 的路徑)：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>echo <replaceable>/usr/local/bin/bash</replaceable> &gt;&gt; /etc/shells</userinput></screen>

	<para>然後重新執行 <citerefentry><refentrytitle>chsh</refentrytitle><manvolnum>1</manvolnum></citerefentry>。</para>
      </note>
    </sect2>

    <sect2>
      <info>
	<title>進階 Shell 技巧</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Tom</firstname>
	      <surname>Rhodes</surname>
	    </personname>
	    <contrib>Written by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para><trademark class="registered">UNIX</trademark> Shell 不只是指令的直譯器，它是一個強大的工具可讓使用者執行指令、重新導向指令的輸出、重新導向指令的輸入並將指令串連在一起來改進最終指令的輸出結果。當這個功能與內建的指令混合使用時，可提供一個可以最佳化效率的環境給使用者。</para>

      <para>Shell 重新導向是將一個指令的輸出或輸入傳送給另一個指令或檔案。例如，要擷取 <citerefentry><refentrytitle>ls</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令的輸出到一個檔案，可以重新導向輸出：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>ls &gt; directory_listing.txt</userinput></screen>

      <para>目錄的內容現在會列到 <filename>directory_listing.txt</filename> 中，部份指令可以讀取輸入，例如 <citerefentry><refentrytitle>sort</refentrytitle><manvolnum>1</manvolnum></citerefentry>。要排序這個清單，可重新導向輸入：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>sort &lt; directory_listing.txt</userinput></screen>

      <para>輸入的內容會被排序後呈現在畫面上，要重新導向該輸入到另一個檔案，可以重新導向 <citerefentry><refentrytitle>sort</refentrytitle><manvolnum>1</manvolnum></citerefentry> 的出輸：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>sort &lt; directory_listing.txt &gt; sorted.txt</userinput></screen>

      <para>於上述所有的範例中，指令會透過檔案描述符 (File descriptor) 來執行重新導向。每個 <trademark class="registered">UNIX</trademark> 系統都有檔案描述符，其中包含了標準輸入 (stdin)、標準輸出 (stdout) 以及標準錯誤 (stderr)。每一種檔案描述符都有特定的用途，輸入可能來自鍵盤或滑鼠、任何可能提供輸入的來源，輸出則可能是螢幕或印表機中的紙張，而錯誤則為任何可能用來診斷的資訊或錯誤訊息。這三種皆被認為是以 I/O 為基礎的檔案描述符，有些也會被當做串流。</para>

      <para>透過使用這些檔案描述符，Shell 能夠讓輸出與輸入在各種指令間傳遞與重新導向到或自檔案。另一種重新導向的方式是使用管線運算子 (Pipe operator)。</para>

      <para><trademark class="registered">UNIX</trademark> 的管線運算子，即 <quote>|</quote>，可允許指令的輸出可直接傳遞或導向到另一個程式。基本上，管線運算子允許指令的標準輸出以標準輸入傳遞給另一個指令，例如：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>cat directory_listing.txt | sort | less</userinput></screen>

      <para>在這個例子中，<filename>directory_listing.txt</filename> 的內容會被排序然後輸出傳遞給 <citerefentry><refentrytitle>less</refentrytitle><manvolnum>1</manvolnum></citerefentry>，這可讓使用者依自己的閱讀步調捲動輸出的結果，避免結果直接捲動出畫面。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="editors">
    <title>文字編輯器</title>

    <indexterm xml:lang="en">
      <primary>text editors</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>editors</primary>
    </indexterm>

    <para>在 FreeBSD 中有許多設定必須透過編輯文字檔完成。 因此，若能熟悉文字編輯器是再好不過的。 FreeBSD 本身就內建幾種文字編輯器， 您也可以透過 Port 套件集來安裝其他的文字編輯器。</para>

    <indexterm xml:lang="en">
      <primary><command>ee</command></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>editors</primary>
      <secondary><citerefentry><refentrytitle>ee</refentrytitle><manvolnum>1</manvolnum></citerefentry></secondary>
    </indexterm>

    <para>最簡單易學的文字編輯器叫做 <citerefentry><refentrytitle>ee</refentrytitle><manvolnum>1</manvolnum></citerefentry>，意為簡易的編輯器 (Easy Editor)。 要開始使用這個編輯器， 只需輸入 <command>ee <replaceable>filename</replaceable></command>，其中 <replaceable>filename</replaceable> 代表你想要編輯的檔案名稱。 在編輯器中， 所有編輯器的功能與操作都顯示在螢幕的上方。 其中的插入符號 (<literal>^</literal>) 代表鍵盤上的 <keycap>Ctrl</keycap> 鍵，所以 <literal>^e</literal> 代表的是  <keycombo action="simul"> <keycap>Ctrl</keycap> <keycap>e</keycap> </keycombo>。 若要結束 <citerefentry><refentrytitle>ee</refentrytitle><manvolnum>1</manvolnum></citerefentry>，請按下 <keycap>Esc</keycap> 鍵，接著選擇 <quote>leave editor</quote> 即可。 此時如果該檔案有修改過，編輯器會提醒你是否要存檔。</para>

    <indexterm xml:lang="en">
      <primary><command>vi</command></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>editors</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><command>emacs</command></primary>
    </indexterm>

    <para>FreeBSD 同時也內建功能強大的文字編輯器，像是<citerefentry><refentrytitle>vi</refentrytitle><manvolnum>1</manvolnum></citerefentry>。 其他編輯器如 <package>editors/emacs</package> 及 <package>editors/vim</package> 則由 FreeBSD Port 套件集提供。 這些編輯器提供更強的功能，但是也比較難學習。 長期來看學習 <application>vim</application> 或 <application>Emacs</application> 會在日後為您省下更多的時間。</para>

    <para>有許多應用程式在修改檔案或需要輸入時會自動開啟文字編輯器，要更改預設的編輯器可設定 <envar>EDITOR</envar> 環境變數如 <xref linkend="shells"/> 所說明。</para>
  </sect1>

  <sect1 xml:id="basics-devices">
    <title>裝置及裝置節點</title>

    <para>裝置 (Device) 一詞大多是跟硬體比較有關的術語，包括磁碟、印表機、顯示卡和鍵盤。 FreeBSD 開機過程當中，開機訊息 (Boot Message) 中主要是會列出偵測到的硬體裝置，開機訊息的複本也會存放在 <filename>/var/run/dmesg.boot</filename>。</para>

    <para>每一個裝置都有一個裝置名稱及編號，舉例來說 <filename>ada0</filename> 是第一台 SATA 硬碟，而 <filename>kbd0</filename> 則代表鍵盤。</para>

    <para>在 FreeBSD 中大多數的裝置必須透過裝置節點 (Device Node) 的特殊檔案來存取，這些檔案會放置在 <filename>/dev</filename>。</para>
  </sect1>

  <sect1 xml:id="basics-more-information">
    <title>操作手冊</title>

    <indexterm xml:lang="en">
      <primary>manual pages</primary>
    </indexterm>

    <para>在 FreeBSD 中，最詳細的文件莫過於操作手冊。 幾乎在系統上所有程式都會有簡短的操作手冊來介紹該程式的基本操作以及可用的參數。 這些操作手冊可以使用 <command>man</command> 指令來檢視：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>man <replaceable>command</replaceable></userinput></screen>

    <para>其中 <replaceable>command</replaceable> 想要瞭解指令的名稱。 舉例，要知道 <citerefentry><refentrytitle>ls</refentrytitle><manvolnum>1</manvolnum></citerefentry> 的詳細用法，就可以打：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>man ls</userinput></screen>

    <para>操作手冊被分成很多個章節，每個章節有不同的主題。 在 FreeBSD 中操作手冊有以下章節：</para>

    <orderedlist>
      <listitem>
	<para>使用者指令。</para>
      </listitem>

      <listitem>
	<para>系統呼叫 (System call) 與錯誤編號。</para>
      </listitem>

      <listitem>
	<para>C 程式庫函數。</para>
      </listitem>

      <listitem>
	<para>裝置驅動程式。</para>
      </listitem>

      <listitem>
	<para>檔案格式。</para>
      </listitem>

      <listitem>
	<para>遊戲及其他程式。</para>
      </listitem>

      <listitem>
	<para>其他資訊。</para>
      </listitem>

      <listitem>
	<para>系統維護與操作指令。</para>
      </listitem>

      <listitem>
	<para>系統核心介面。</para>
      </listitem>
    </orderedlist>

    <para>有些情況會有同樣主題會同時出現在不同章節。 舉個例子，系統內會有 <command>chmod</command> 使用者指令，但同時也有 <function>chmod()</function> 系統呼叫。 在這種情況，要告訴 <citerefentry><refentrytitle>man</refentrytitle><manvolnum>1</manvolnum></citerefentry> 要查詢的章節編號：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>man 1 chmod</userinput></screen>

    <para>如此一來就會查詢使用者指令 <citerefentry><refentrytitle>chmod</refentrytitle><manvolnum>1</manvolnum></citerefentry>。 通常在寫文件時會把有參考到特定章節的號碼寫在括號內。 所以 <citerefentry><refentrytitle>chmod</refentrytitle><manvolnum>1</manvolnum></citerefentry> 就是指使用者指令，而 <citerefentry><refentrytitle>chmod</refentrytitle><manvolnum>2</manvolnum></citerefentry> 則是指系統呼叫。</para>

    <para>若不曉得操作手冊的名稱，可以使用 <command>man -k</command> 來以關鍵字查詢所有操作手冊的描述：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>man -k <replaceable>mail</replaceable></userinput></screen>

    <para>這個指令會顯示所有描述中有使用到關鍵字 <quote>mail</quote> 的指令。 這等同使用 <citerefentry><refentrytitle>apropos</refentrytitle><manvolnum>1</manvolnum></citerefentry>。</para>

    <para>想要閱讀所有在 <filename>/usr/bin</filename> 底下的指令說明則可輸入：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>cd /usr/bin</userinput>
<prompt>%</prompt> <userinput>man -f * | more</userinput></screen>

    <para>或</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>cd /usr/bin</userinput>
<prompt>%</prompt> <userinput>whatis * |more</userinput></screen>

    <sect2 xml:id="basics-info">
      <title>GNU Info 檔</title>

      <indexterm xml:lang="en">
	<primary>Free Software Foundation</primary>
      </indexterm>

      <para>FreeBSD 有許多應用程式與工具來自自由軟體基金會 (Free Software Foundation, FSF)。 除了操作手冊之外，這些程式提供了另外一種更具有彈性的超文字文件叫做 <literal>info</literal> 檔。 這些檔案可以使用 <citerefentry><refentrytitle>info</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令來閱讀，或者若有裝 <package>editors/emacs</package> 亦可透過 <application>emacs</application> 的 info 模式閱讀。</para>

      <para>要使用 <citerefentry><refentrytitle>info</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令，只需輸入：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>info</userinput></screen>

      <para>要查詢簡單說明請按 <literal>h</literal> 鍵，若要查訊快速指令參考請按 <literal>?</literal> 鍵。</para>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="ports">

  <title>安裝應用程式：套件與 Port</title>

  <sect1 xml:id="ports-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en"><primary>ports</primary></indexterm>
    <indexterm><primary>套件</primary></indexterm>
    <para>FreeBSD 內建豐富的系統工具集，此外 FreeBSD 提供了兩種安裝第三方軟體的套件管理技術︰由原始碼安裝的 FreeBSD Port 套件集，以及由預先編譯好的 Binary 安裝的 Binary  套件集。兩種方法都可使用本地的媒體或網路來安裝軟體。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>Binary 套件集與 Port 的差別。</para>
      </listitem>

      <listitem>
	<para>如何找到已移植到 FreeBSD 的第三方軟體。</para>
      </listitem>

      <listitem>
	<para>如何使用 <application>pkg</application> 管理 Binary 套件。</para>
      </listitem>

      <listitem>
	<para>如何編譯來自 Port 套件集的第三方軟體原始碼。</para>
      </listitem>

      <listitem>
	<para>如何找到應用程式已安裝的檔案來完成安裝後的設定。</para>
      </listitem>

      <listitem>
	<para>若軟體安裝失敗要如何處理。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="ports-overview">
    <title>安裝軟體的概要</title>

    <para>通常要在 <trademark class="registered">UNIX</trademark> 系統上安裝第三方軟體時，有幾個步驟要作：</para>

    <procedure>
      <step>
	<para>找到並且下載軟體，該軟體有可能以原始碼或 Binary 格式發佈。</para>
      </step>

      <step>
	<para>自發佈的格式解壓縮軟體。 發佈的格式通常為 tarball 並以程式壓縮，如 <citerefentry><refentrytitle>compress</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <citerefentry><refentrytitle>gzip</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <citerefentry><refentrytitle>bzip2</refentrytitle><manvolnum>1</manvolnum></citerefentry> 或 <citerefentry><refentrytitle>xz</refentrytitle><manvolnum>1</manvolnum></citerefentry>。</para>
      </step>

      <step>
	<para>找到位於 <filename>INSTALL</filename>, <filename>README</filename> 或者 <filename>doc/</filename> 子目錄底下的檔案閱讀如何安裝該軟體。</para>
      </step>

      <step>
	<para>若軟體是以原始碼的格式發佈則需要編譯該軟體。 這可能會需要修改 <filename>Makefile</filename> 或執行 <command>configure</command> Script。</para>
      </step>

      <step>
	<para>測試並安裝該軟體。</para>
      </step>
    </procedure>

    <para>FreeBSD <emphasis>Port</emphasis> 是指設計用來自動化從原始碼編譯應用程式整個程序的一系列檔案，組成 Port 的檔案包含了自動下載、解壓縮、修補、編譯與安裝應用程式的必要資訊。</para>

    <para>若軟體尚未被 FreeBSD 採用並測試，可能會需要經過一些修正才能正常安裝並執行。</para>

    <para>雖然如此，目前已有超過 <link xlink:href="@@URL_RELPREFIX@@/ports/index.html">24,000</link> 個第三方應用程式已經被移植到 FreeBSD。當可行時，這些應用程式也會做成預先編譯好的 <emphasis>套件 (Package)</emphasis> 供下載。</para>

    <para>這些 Binary 套件可使用 FreeBSD 套件管理指令來管理。</para>

    <para>不論是 Binary 套件或者 Port 都有相依性，若用 Binary 套件或 Port 來安裝應用程式，且該應用程式若有相依的程式庫尚未被安裝，則會自動先安裝該程式庫。</para>

    <para>FreeBSD  Binary 套件中含有一個應用程式中所有預先編譯好的指令、設定檔以及文件，Binary 套件可以使用 <citerefentry><refentrytitle>pkg</refentrytitle><manvolnum>8</manvolnum></citerefentry> 指令來管理，如 <command>pkg install</command>。</para>

    <para>雖然兩種技術非常相似，但 Binary 套件及 Port 有各自的優點。 要視您要安裝的應用程式需求來選擇。</para>

    <itemizedlist>
      <title>Binary 套件優點</title>

      <listitem>
	<para>應用程式壓縮 Binary 套件的 tarball 會比壓縮原始碼的 tarball 還要小。</para>
      </listitem>

      <listitem>
	<para>安裝 Binary 套件不需要編譯的時間，對於較慢的電腦要安裝大型的應用程式如 <application>Mozilla</application>, <application>KDE</application> 或 <application>GNOME</application> 這點顯的相當重要。</para>
      </listitem>

      <listitem>
	<para>Binary 套件不需要了解在 FreeBSD 上編譯軟體的流程。</para>
      </listitem>
    </itemizedlist>

    <itemizedlist>
      <title>Port 套件優點</title>

      <listitem>
	<para>由於 Binary 套件必須盡可能在大多數系統上執行，通常會採用較通用的編譯選項來編譯，由 Port 來編輯可更改編譯選項。</para>
      </listitem>

      <listitem>
	<para>部份應用程式編譯期選項會與要安裝的功能有關，舉例來說 <application>Apache</application> 便有大量不同的內建選項可以設定。</para>

	<para>在某些情況，同樣的應用程式會存在多個不同的 Binary 套件，如 <application>Ghostscript</application> 有 <filename>ghostscript</filename> 及 <filename>ghostscript-nox11</filename> 兩種 Binary 套件，用來區別是否有安裝 <application>Xorg</application>。 若應用程式有一個以上的編譯期選項便無法用這個方式來區別 Binary 套件。</para>
      </listitem>

      <listitem>
	<para>部份軟體的授權條款中禁止以 Binary 格式發佈。 這種軟體必須以原始碼發佈並由終端使用者編譯。</para>
      </listitem>

      <listitem>
	<para>部份人並不相信 Binary 發佈版本，寧願閱讀原始碼來查看是否潛藏的問題。</para>
      </listitem>

      <listitem>
	<para>原始碼可套用自訂的修補。</para>
      </listitem>
    </itemizedlist>

    <para>要持續追蹤 Port 的更新可以訂閱 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ports">FreeBSD Port 郵遞論壇</link> 與 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ports-bugs">FreeBSD Port 問題郵遞論壇</link>。</para>

    <warning>
      <para>在安裝任何應用程式之前，請先查看 <link xlink:href="https://vuxml.freebsd.org/"/> 是否有與該應用程式相關的安全性問題或輸入 <command>pkg audit -F</command> 來檢查所有已安裝的應用程式是否有已知的漏洞。</para>
    </warning>

    <para>本章接下來的部份將說明如何在 FreeBSD 使用 Binary 套件及 Port 套件安裝與管理第三方軟體。</para>
  </sect1>

  <sect1 xml:id="ports-finding-applications">
    <title>搜尋軟體</title>

    <para>FreeBSD 上可安裝的軟體清單不斷在增加， 有幾種方式可以來找你想安裝的軟體：</para>

    <itemizedlist>
      <listitem>
	<para>FreeBSD 網站有維護一份可搜尋的最新應用程式清單，在 <link xlink:href="@@URL_RELPREFIX@@/ports/index.html">https://www.FreeBSD.org/ports/</link>。 可以依應用程式名稱或軟體分類來搜尋 Port。</para>
      </listitem>

      <listitem>
	<indexterm xml:lang="en"><primary>FreshPorts</primary></indexterm>

	<para>由 Dan Langille 維護的 <link xlink:href="http://www.FreshPorts.org/">FreshPorts.org</link>，提供完整的搜尋工具並且可追蹤在 Port 套件集中的應用程式變更。註冊的使用者可以建立自訂的監視清單會自動寄發電子郵件通知 Port 的更新資訊。</para>
      </listitem>

      <listitem>
	<indexterm xml:lang="en"><primary>SourceForge</primary></indexterm>

	<para>若找不到指定的應用程式，可以先到網站 <link xlink:href="http://www.sourceforge.net/">SourceForge.net</link> 或 <link xlink:href="http://www.github.com/">GitHub.com</link> 搜尋，後然再回到 <link xlink:href="@@URL_RELPREFIX@@/ports/index.html">FreeBSD 網站</link> 檢查該應用程式是否已被移植。</para>
      </listitem>

      <listitem>
	<indexterm xml:lang="en">
	  <primary>pkg</primary>
	  <secondary>search</secondary>
	</indexterm>

	<para xml:id="pkg-search">要搜尋 Binary 套件檔案庫中的應用程式可：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pkg search <replaceable>subversion</replaceable></userinput>
git-subversion-<replaceable>1.9.2</replaceable>
java-subversion-<replaceable>1.8.8_2</replaceable>
p5-subversion-<replaceable>1.8.8_2</replaceable>
py27-hgsubversion-<replaceable>1.6</replaceable>
py27-subversion-<replaceable>1.8.8_2</replaceable>
ruby-subversion-<replaceable>1.8.8_2</replaceable>
subversion-<replaceable>1.8.8_2</replaceable>
subversion-book-<replaceable>4515</replaceable>
subversion-static-<replaceable>1.8.8_2</replaceable>
subversion16-<replaceable>1.6.23_4</replaceable>
subversion17-<replaceable>1.7.16_2</replaceable></screen>

	<para>套件名稱包含版本編號，且若 Port 使用 Python 為基礎，也會包含用來編譯該套件的 Python 版本。有些 Port 會有多個版本可使用，如 <application>Subversion</application> ，因編譯選項不同，有多個版本可用，這個例子中即指靜態連結版本的 <application>Subversion</application>。在指定要安裝的套件時，最好使用 Port 來源來指定該應用程式，Port 來源是指應用程式在 Port 樹中的路徑。再輸入一次 <command>pkg search</command> 並加上 <option>-o</option> 來列出每個套件來源：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pkg search -o <replaceable>subversion</replaceable></userinput>
devel/git-subversion
java/java-subversion
devel/p5-subversion
devel/py-hgsubversion
devel/py-subversion
devel/ruby-subversion
devel/subversion16
devel/subversion17
devel/subversion
devel/subversion-book
devel/subversion-static</screen>

	<para><command>pkg search</command> 支援使用 Shell 萬手字元 (globs)、正規表示法、描述或檔案庫中的其他其他內容。在安裝 <package>ports-mgmt/pkg</package> 或 <package>ports-mgmt/pkg-devel</package> 之後，可參考 <citerefentry><refentrytitle>pkg-search</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以取得更多詳細資訊。</para>
      </listitem>

      <listitem>
	<para>若 Port 套件集已安裝，有數個方法可以查詢 Port 樹中的本地版本。要找到 Port 所在的分類，可輸入 <command>whereis <replaceable>file</replaceable></command>，其中 <replaceable>file</replaceable> 是要安裝的程式：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>whereis lsof</userinput>
lsof: /usr/ports/sysutils/lsof</screen>

	<para>或者，也可使用 <citerefentry><refentrytitle>echo</refentrytitle><manvolnum>1</manvolnum></citerefentry>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>echo /usr/ports/*/*lsof*</userinput>
/usr/ports/sysutils/lsof</screen>

	<para>請注意，這也會顯示已下載至 <filename>/usr/ports/distfiles</filename> 目錄中任何已符合條件的檔案。</para>
      </listitem>

      <listitem>
	<para>另一個方法是使用 Port 套件集內建的搜尋機制來找軟體。要使用搜尋的功能需先 <application>cd</application> 到 <filename>/usr/ports</filename> 然後執行 <command>make search name=program-name</command>，其中 <replaceable>program-name</replaceable> 代表軟體的名稱。舉例搜尋 <command>lsof</command>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports</userinput>
<prompt>#</prompt> <userinput>make search name=lsof</userinput>
Port:   lsof-4.88.d,8
Path:   /usr/ports/sysutils/lsof
Info:   Lists information about open files (similar to fstat(1))
Maint:  ler@lerctr.org
Index:  sysutils
B-deps:
R-deps: </screen>

	<tip>
	  <para>內建的搜尋機制會使用索引檔內的資訊。若出現訊息指出需要 <filename>INDEX</filename> 檔，可執行 <command>make fetchindex</command> 來下載最新的索引檔。當 <filename>INDEX</filename> 檔存在時，<command>make search</command> 方可執行請求的搜尋動作。</para>
	</tip>

	<para><quote>Path:</quote> 此行代表 Port 的所在位置。</para>

	<para>若不要接受這麼多資訊，可使用 <command>quicksearch</command> 功能：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports</userinput>
<prompt>#</prompt> <userinput>make quicksearch name=lsof</userinput>
Port:   lsof-4.88.d,8
Path:   /usr/ports/sysutils/lsof
Info:   Lists information about open files (similar to fstat(1))</screen>

	<para>若要進行更有深度的搜尋，使用 <command>make search key=<replaceable>string</replaceable></command> 或 <command>make quicksearch key=<replaceable>string</replaceable></command> 其中 <replaceable>string</replaceable> 是要搜尋的文字。該文字可以是一部份的註解、描述或相依套件，當不清楚程式的名稱時可以找到與特定主題相關的 Port。</para>

	<para>當使用 <buildtarget>search</buildtarget> 或 <buildtarget>quicksearch</buildtarget> 時，搜尋的字串不分大小寫。 搜尋 <quote>LSOF</quote> 會與搜尋 <quote>lsof</quote> 產生相同的結果。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="pkgng-intro">
    <title>使用 <application>pkg</application> 管理 Binary 套件</title>

    <para><application>pkg</application> 是新一代套件管理工具用來取代舊版工具，提供許多功能讓處理 Binary 套件更快更簡單。</para>

    <para>對於只想要使用在 FreeBSD 鏡像站上預先編譯 Binary 套件的站台，使用 <application>pkg</application> 管理套件便已足夠。</para>

    <para>但是，對於那些想要從原始碼或使用自己的檔案庫編譯的站台，則會需要 <link linkend="ports-upgrading-tools">Port 管理工具</link>。</para>

    <para>因為 <application>pkg</application> 僅能管理 Binary 套件，所以不能當做為替代 Port 管理工具，這些工具可用來安裝來自 Binary 與 Port 套件集的軟體，而 <application>pkg</application> 僅能安裝 Binary 套件。</para>

    <sect2 xml:id="pkgng-initial-setup">
      <title>開始使用 <application>pkg</application></title>

      <para>FreeBSD 內建啟動 (Bootstrap) 工具可用來下載並安裝 <application>pkg</application> 及其操作手冊。這個工具是設計在 FreeBSD 版本 10.<replaceable>X</replaceable> 之後使用。</para>

      <note>
	<para>不是所有 FreeBSD 版本及架構支援此啟動程序，目前支援的清單列於 <link xlink:href="https://pkg.freebsd.org/"/>，對不支援的版本，必須改透過 Port 套件集或者 Binary 套件來安裝 <application>pkg</application>。</para>

      </note>

      <para>要啟動 (Bootstrap) 系統請執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>/usr/sbin/pkg</userinput></screen>

      <para>您必須有可用的網際網路連線供啟動程式使用方可成功。</para>

      <para>否則，要安裝 Port 套件，則須執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/ports-mgmt/pkg</userinput>
<prompt>#</prompt> <userinput>make</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>當升級原使用舊版 pkg_* 工具的既有系統時，必須將資料庫轉換成新的格式，如此新的工具才會知道有那些已安裝過的套件。<application>pkg</application> 安裝完後，必須執行以下指令將套件資料庫從舊版格式轉換到新版格式：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg2ng</userinput></screen>

      <note><para>新安裝的版本因尚未安裝任何第三方軟體因此不須做這個步驟。</para></note>

      <important>
	<para>這個步驟無法還原。一旦套件資料庫轉為成 <application>pkg</application> 的格式，舊版 <literal>pkg_*</literal> 工具就不該再繼續使用。</para>
      </important>

      <note>
	<para>套件資料庫轉換的過程可能會因內容轉換為新版本產生錯誤。通常，這些錯誤皆可安全忽略，即使如此，仍然有在執行 <command>pkg2ng</command> 後無法成功轉換的軟體清單，這些應用程式則必須手動重新安裝。</para>
      </note>

      <para>為了確保 FreeBSD Port 套件集會將新軟體的資訊註冊到 <application>pkg</application> 而非舊版套件資料庫，FreeBSD 版本 10.<replaceable>X</replaceable> 之前需要在 <filename>/etc/make.conf</filename> 加入此行：</para>

      <programlisting xml:lang="en">WITH_PKGNG=	yes</programlisting>

      <para>預設 <application>pkg</application> 會使用 FreeBSD 套件鏡像站 (<emphasis>Repository</emphasis>) 的 Binary 套件。若要取得有關編譯自訂套件檔案庫的資訊，請參考 <xref linkend="ports-poudriere"/>。</para>

      <para>其他 <application>pkg</application> 設定選項說明請參考 <citerefentry><refentrytitle>pkg.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>。</para>

      <para><application>pkg</application> 的用法資訊可在 <citerefentry><refentrytitle>pkg</refentrytitle><manvolnum>8</manvolnum></citerefentry> 操作手冊或不加任何參數執行 <command>pkg</command> 來取得。</para>

      <para>每個 <application>pkg</application> 指令參數皆記庫在指令操件手冊。要閱讀 <command>pkg install</command> 的操作手冊，可執行以下指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg help install</userinput></screen>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>man pkg-install</userinput></screen>

      <para>本章節剩餘的部份將會示範使用 <application>pkg</application> 執行常用的 Binary 套件管理工作。每個示範的指令皆會提供多個參數可使用，請參考指令的說明或操作手冊以取得詳細資訊或更多範例。</para>
    </sect2>

    <sect2 xml:id="pkgng-pkg-info">
      <title>取得有關已安裝套件的資訊</title>

      <para>有關已安裝在系統的套件資訊可透過執行 <command>pkg info</command> 來檢視，若執行時未指定任何參數，將會列出所有已安裝或指定的套件版本。</para>

      <para>例如，要查看已安裝的 <application>pkg</application> 版本可執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg info pkg</userinput>
pkg-1.1.4_1</screen>
    </sect2>

    <sect2 xml:id="pkgng-installing-deinstalling">
      <title>安裝與移除套件</title>

      <para>要安裝 Binary 套件可使用以下指令，其中 <replaceable>packagename</replaceable> 為要安裝的套件名稱：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install <replaceable>packagename</replaceable></userinput></screen>

      <para>這個指令會使用檔案庫的資料來決定要安裝的軟體版本以及是否有任何未安裝的相依。例如，要安裝 <application>curl</application>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install curl</userinput>
Updating repository catalogue
/usr/local/tmp/All/curl-7.31.0_1.txz          100% of 1181 kB 1380 kBps 00m01s

/usr/local/tmp/All/ca_root_nss-3.15.1_1.txz   100% of  288 kB 1700 kBps 00m00s

Updating repository catalogue
The following 2 packages will be installed:

        Installing ca_root_nss: 3.15.1_1
        Installing curl: 7.31.0_1

The installation will require 3 MB more space

0 B to be downloaded

Proceed with installing packages [y/N]: <userinput>y</userinput>
Checking integrity... done
[1/2] Installing ca_root_nss-3.15.1_1... done
[2/2] Installing curl-7.31.0_1... done
Cleaning up cache files...Done</screen>

	<para>新的套件以及任何做為相依安裝的額外套件可在已安裝的套件清單中看到：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pkg info</userinput>
ca_root_nss-3.15.1_1	The root certificate bundle from the Mozilla Project
curl-7.31.0_1	Non-interactive tool to get files from FTP, GOPHER, HTTP(S) servers
pkg-1.1.4_6	New generation package manager</screen>

	<para>不再需要的套件可以使用 <command>pkg delete</command> 來移除，例如：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pkg delete curl</userinput>
The following packages will be deleted:

	curl-7.31.0_1

The deletion will free 3 MB

Proceed with deleting packages [y/N]: <userinput>y</userinput>
[1/1] Deleting curl-7.31.0_1... done</screen>
    </sect2>

    <sect2 xml:id="pkgng-upgrading">
      <title>升級已安裝套件</title>

      <para>執行以下指令，可將已安裝的套件升級到最新版本：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg upgrade</userinput></screen>

      <para>這個指令將會比對已安裝的版本與在檔案庫分類中的版本，並從檔案庫升級這些套件。</para>
    </sect2>

    <sect2 xml:id="pkgng-auditing">
      <title>稽查已安裝套件</title>

      <para>在第三方的應用程式中偶爾可能會發現軟體漏洞，要找出這些程式，可使用 <application>pkg</application> 內建的稽查機制。要查詢已安裝在系統上的軟體是否有任何已知的漏洞可執行：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pkg audit -F</userinput></screen>
    </sect2>

    <sect2 xml:id="pkgng-autoremove">
      <title>自動移除未使用的套件</title>

      <para>移除一個套件可能會留下不再需要使用的相依套件。不再需要的相依套件是當初隨著其套件所安裝的套件 (枝葉套件)，可以使用以下指令自動偵測並移除：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg autoremove</userinput>
Packages to be autoremoved:
	ca_root_nss-3.15.1_1

The autoremoval will free 723 kB

Proceed with autoremoval of packages [y/N]: <userinput>y</userinput>
Deinstalling ca_root_nss-3.15.1_1... done</screen>

      <para>因為相依所安裝的套件稱作 <emphasis>自動 (Automatic)</emphasis> 套件，而非自動套件即套件被安裝的原因不是因為其他套件所相依，可以使用以下方式查詢：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg prime-list</userinput>
nginx
openvpn
sudo</screen>

      <para><command>pkg prime-list</command> 是一個別名指令，定義在 <filename>/usr/local/etc/pkg.conf</filename>，尚還有許多其他相關指令可以用來查詢系統的套件資料庫，例如，指令 <command>pkg prime-origins</command> 可用來取得上述清單的來源 Port 目錄：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg prime-origins</userinput>
www/nginx
security/openvpn
security/sudo</screen>

      <para>這份清單可以用來重新編譯所有安裝在系統中的套件，使用 <package> ports-mgmt/poudriere</package> 或 <package> ports-mgmt/synth</package> 這類的編譯工具。</para>

    <para>要將一個安裝好的套件註記成為 "自動" 可以用：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg set -A 1 devel/cmake</userinput></screen>

      <para>當套件為末端套件 (Leaf Package) 且被註記為 "自動"，則會被 <command>pkg autoremove</command> 挑選出來。</para>

      <para>要註記一個安裝好的套件為 "<emphasis>非</emphasis>自動" 可以用：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg set -A 0 devel/cmake</userinput></screen>

    </sect2>

    <sect2 xml:id="pkgng-backup">
      <title>還原套件資料庫</title>

      <para>不如傳統的套件管理系統，<application>pkg</application> 有自己的套件資料庫備份機制，此功能預設是開啟的。</para>

      <tip>
	<para>要停止週期的 Script 備份套件資料庫可在 <citerefentry><refentrytitle>periodic.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 設定 <literal>daily_backup_pkgdb_enable="NO"</literal>。</para>
      </tip>

      <para>要還原先前套件資料庫的備份，可執行以下指令並將 <replaceable>/path/to/pkg.sql</replaceable> 替換為備份的位置：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg backup -r <replaceable>/path/to/pkg.sql</replaceable></userinput></screen>

      <note>
	<para>若要還原有週期 Script 所產生的備份必須在還原前先解壓縮。</para>
      </note>

      <para>要手動備份 <application>pkg</application> 資料庫，可執行以下指令，並替換 <replaceable>/path/to/pkg.sql</replaceable> 為適當的檔案名稱與位置：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg backup -d <replaceable>/path/to/pkg.sql</replaceable></userinput></screen>
    </sect2>

    <sect2 xml:id="pkgng-clean">
      <title>移除過時的套件</title>

      <para>預設 <application>pkg</application> 會儲存 Binary 套件在快取目錄定義在  <citerefentry><refentrytitle>pkg.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 中的 <envar>PKG_CACHEDIR</envar>，只會保留最後安裝的套件複本。較舊版的 <application>pkg</application>  會保留所有先前的套件，若要移除這些過時的  Binary 套件，可執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg clean</userinput></screen>

      <para>使用以下指令可清空全部的快取：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg clean -a</userinput></screen>
    </sect2>

    <sect2 xml:id="pkgng-set">
      <title>修改套件 Metadata</title>

      <para>在 FreeBSD Port 套件集中的軟體可能會經歷主要版號的修改，要解決這個問題可使用 <application>pkg</application> 內建的指令來更新套件來源。這非常有用，例如 <package>lang/php5</package> 重新命名為 <package>lang/php53</package> 因此 <package>lang/php5</package> 從此之後代表版本 <literal>5.4</literal>。</para>

      <para>要更改上述例子中的套件來源，可執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg set -o lang/php5:lang/php53</userinput></screen>

      <para>再一個例子，要更新 <package>lang/ruby18</package> 為 <package>lang/ruby19</package>，可執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg set -o lang/ruby18:lang/ruby19</userinput></screen>

      <para>最後一個例子，要更改 <filename>libglut</filename> 共用程式庫的來源從 <package>graphics/libglut</package> 改成 <package>graphics/freeglut</package> 可執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg set -o graphics/libglut:graphics/freeglut</userinput></screen>

      <note>
	<para>在更改套件來源之後，很重要的一件事是要重新安裝套件，來讓相依的套件也同時使用修改後的來源。要強制重新安裝相依套件，可執行：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install -Rf <replaceable>graphics/freeglut</replaceable></userinput></screen>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="ports-using">
    <title>使用 Port 套件集</title>

    <para>Port 套件集是指一數個 <filename>Makefiles</filename>、修補及描述檔案，每一組這些檔案可用來編譯與安裝在 FreeBSD 上的一個應用程式，即稱為一個 <emphasis>Port</emphasis>。</para>

    <para>預設，Port 套件集儲存在 <filename>/usr/ports</filename> 的子目錄下。</para>

    <para>在應用程式可以使用 Port 編譯之前，必須先安裝 Port 套件集。若在安裝 FreeBSD 時沒有安裝，可以使用以下其中一種方式安裝：</para>

    <procedure xml:id="ports-using-portsnap-method">
      <title>Portsnap 方法</title>

      <para>FreeBSD 的基礎系統內含 <application>Portsnap</application>，這是一個可用來取得 Port 套件集簡單又快速的工具，較建議多數使用者使用這個方式。此工具會連線到 FreeBSD 的網站，驗証密鑰，然後下載 Port 套件集的新複本。該金鑰是要用來檢驗所有已下載檔案的完整性。</para>

      <step>
	<para>要下載壓縮後的 Port 套件集快照 (Snapshot) 到 <filename>/var/db/portsnap</filename>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portsnap fetch</userinput></screen>
      </step>

      <step>
	<para>當第一次執行 <application>Portsnap</application> 時，要先解壓縮快照到 <filename>/usr/ports</filename>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portsnap extract</userinput></screen>
      </step>

      <step>
	<para>在完成上述第一次使用 <application>Portsnap</application> 的動作之後，往後可隨需要執行以下指令來更新 <filename>/usr/ports</filename> ：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portsnap fetch</userinput>
<prompt>#</prompt> <userinput>portsnap update</userinput></screen>

	<para>當使用 <literal>fetch</literal> 時也可同時執行 <literal>extract</literal> 或 <literal>update</literal> 如：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portsnap fetch update</userinput></screen>
      </step>
    </procedure>

    <procedure xml:id="ports-using-subversion-method">
      <title>Subversion 方法</title>

      <para>若要取得更多對 Port 樹的控制，或若有本地的變更需要維護，可以使用 <application>Subversion</application> 來取得 Port 套件集。請參考 <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/committers-guide/subversion-primer.html">Subversion Primer</link> 來取得 <application>Subversion</application> 的詳細說明。</para>

      <step>
	<para>必須安裝 <application>Subversion</application> 才可用來取出 (Check out) Port 樹。若已存在 Port 樹的複本，可使用此方式安裝 <application>Subversion</application>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/devel/subversion</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

	<para>若尚無法使用 Port 樹，或已經使用 <application>pkg</application> 來管理套件，可使用套件來安裝 <application>Subversion</application>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install subversion</userinput></screen>

      </step>

      <step>
	<para>取出 Port 樹的複本：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>svn checkout https://svn.FreeBSD.org/ports/head /usr/ports</userinput></screen>
      </step>

      <step>
	<para>若需要，在第一次 <application>Subversion</application> 取出後可使用以下指令更新 <filename>/usr/ports</filename>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>svn update /usr/ports</userinput></screen>
      </step>
    </procedure>

    <para>Port 套件集中含有代表不同軟體分類的目錄，每個分類底下的子目錄代表每個應用程式，每個內含數個用來告訴 FreeBSD 如何編譯與安裝該程式檔案的應用程式子目錄即稱作 <emphasis>Port Skeleton</emphasis>，每個 Port Skeleton 會含有以下檔案及目錄：</para>

    <itemizedlist>
      <listitem>
	<para><filename>Makefile</filename>：內含用來說明應用程式要如何編譯、要安裝該程式到那的敘述句。</para>
      </listitem>

      <listitem>
	<para><filename>distinfo</filename>：內含編譯 Port 必須下載的檔案名稱以及校驗碼 (Checksum)。</para>
      </listitem>

      <listitem>
	<para><filename>files/</filename>：此目錄含有編譯與安裝程式到 FreeBSD 時所需的修補檔。此目錄也可能含有其他用來編譯 Port 的檔案。</para>
      </listitem>

      <listitem>
	<para><filename>pkg-descr</filename>：提供程式更詳細的說明。</para>
      </listitem>

      <listitem>
	<para><filename>pkg-plist</filename>：Port 安裝的所有檔案清單，也同時會告訴 Port 系統解除安裝時要移除那一些檔案。</para>
      </listitem>
    </itemizedlist>

    <para>部份 Port 含有 <filename>pkg-message</filename> 或其他檔案用來處理特殊情況。要取得有關這些檔案的詳細資訊，以及 Port 的概要可參考 <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/books/porters-handbook/index.html">FreeBSD Porter's Handbook</link>。</para>

    <para>Port 中並不含實際的原始碼，即為 <filename>distfile</filename>，在編譯 Port 解壓縮時會自動下載的原始碼到 <filename>/usr/ports/distfiles</filename>。</para>

    <sect2 xml:id="ports-skeleton">
      <title>安裝 Port</title>

      <indexterm xml:lang="en">
	<primary>ports</primary>
	<secondary>installing</secondary>
      </indexterm>

      <para>下面我們會介紹如何使用 Port 套件集來安裝、移除軟體的基本用法。 <command>make</command> 可用的目標及環境變數詳細說明可參閱 <citerefentry><refentrytitle>ports</refentrytitle><manvolnum>7</manvolnum></citerefentry>。</para>

      <warning>
	<para>在編譯任何 Port 套件前，請先確認已經如前章節所敘述之方法更新 Port 套件集。安裝任何第三方軟體皆可能會導致安全性漏洞，建議在安裝前先閱讀 <link xlink:href="https://vuxml.freebsd.org/"/> 了解 Port 已知的安全性問題。或者在每次安裝新 Port 前執行 <command>pkg audit -F</command>。此指令可以設定在每日系統安全性檢查時自動完成安全性稽查以及更新漏洞資料庫。要取得更多資訊，請參考 <citerefentry><refentrytitle>pkg-audit</refentrytitle><manvolnum>8</manvolnum></citerefentry> 及 <citerefentry><refentrytitle>periodic</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</para>
      </warning>

      <para>使用 Port 套件集會假設您擁有可正常連線的網路，同時也會需要超級使用者的權限。</para>

      <para>要編譯並安裝 Port，需切換目錄到要安裝的 Port 底下，然後輸入 <command>make install</command>，訊息中會顯示安裝的進度：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/sysutils/lsof</userinput>
<prompt>#</prompt> <userinput>make install</userinput>
&gt;&gt; lsof_4.88D.freebsd.tar.gz doesn't seem to exist in /usr/ports/distfiles/.
&gt;&gt; Attempting to fetch from ftp://lsof.itap.purdue.edu/pub/tools/unix/lsof/.
===&gt;  Extracting for lsof-4.88
...
[extraction output snipped]
...
&gt;&gt; Checksum OK for lsof_4.88D.freebsd.tar.gz.
===&gt;  Patching for lsof-4.88.d,8
===&gt;  Applying FreeBSD patches for lsof-4.88.d,8
===&gt;  Configuring for lsof-4.88.d,8
...
[configure output snipped]
...
===&gt;  Building for lsof-4.88.d,8
...
[compilation output snipped]
...

===&gt;  Installing for lsof-4.88.d,8
...
[installation output snipped]
...
===&gt;   Generating temporary packing list
===&gt;   Compressing manual pages for lsof-4.88.d,8
===&gt;   Registering installation for lsof-4.88.d,8
===&gt;  SECURITY NOTE:
      This port has installed the following binaries which execute with
      increased privileges.
/usr/local/sbin/lsof
<prompt>#</prompt></screen>

      <para><command>lsof</command> 是需要進階權限才有辦法執行的程式，因此當該程式安裝完成時會顯示安全性警告。一旦安裝完成便會顯示指令提示。</para>

      <para>有些 Shell 會將 <envar>PATH</envar> 環境變數中所列目錄中可用的指令做快取，來增加在執行指這些指令時的查詢速度。<command>tcsh</command> Shell 的使用者應輸入 <command>rehash</command> 來讓新安裝的指令不須指定完整路徑便可使用。若在 <command>sh</command> Shell 則使用 <command>hash -r</command>。請參考 Shell 的說明文件以取得更多資訊。</para>

      <para>安裝過程中會建立工作用的子目錄用來儲存編譯時暫存的檔案。可移除此目錄來節省磁碟空間並漸少往後升級新版 Port 時造成問題：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>make clean</userinput>
===&gt;  Cleaning for lsof-88.d,8
<prompt>#</prompt></screen>

      <note>
	<para>若想要少做這個額外的步驟，可以編譯 Port 時使用 <command>make install clean</command>。</para>
      </note>

      <sect3>
	<title>自訂 Port 安裝</title>

	<para>部份 Port 提供編譯選項，可用來開啟或關閉應用程式中的元件、安全選項、或其他允許自訂的項目。這類的應用程式例子包括 <package>www/firefox</package>, <package>security/gpgme</package> 以及 <package>mail/sylpheed-claws</package>。若 Port 相依的其他 Port 有可設定的選項時，預設的模式會提示使用者選擇選單中的選項，這可能會讓安裝的過程暫停讓使用者操作數次。要避免這個情況，可一次設定所有選項，只要在 Port skeleton 中執行 <command>make config-recursive</command>，然後再執行 <command>make install [clean]</command> 編譯與安裝該 Port。</para>

	<tip>
	  <para>使用 <buildtarget>config-recursive</buildtarget> 時，會使用 <buildtarget>all-depends-list</buildtarget> Target 來收集所有要設定 Port 清單。建議執行 <command>make config-recursive</command> 直到所有相依的 Port 選項都已定義，直到 Port 的選項畫面不會再出現，來確定所有相依的選項都已經設定。</para>
	</tip>

	<para>有許多方式可以重新進入 Port 的編譯選項清單，以便在編譯 Port 之後加入、移除或更改這些選項。方法之一是 <command>cd</command> 進入含有 Port 的目錄並輸入 <command>make config</command>。還有另一個方法是使用 <command>make showconfig</command>。最後一個方法是執行 <command>make rmconfig</command> 來移除所有曾選擇過的選項，讓您能夠重新設定。這些方法在 <citerefentry><refentrytitle>ports</refentrytitle><manvolnum>7</manvolnum></citerefentry> 中都有詳細的說明。</para>

	<para>Port 系統使用 <citerefentry><refentrytitle>fetch</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來下載檔案，它支援許多的環境變數可設定。若 FreeBSD 系統在防火牆或 FTP/HTTP 代理伺服器後面，可以設定 <envar>FTP_PASSIVE_MODE</envar>, <envar>FTP_PROXY</envar> 以及 <envar>FTP_PASSWORD</envar> 變數。請參考 <citerefentry><refentrytitle>fetch</refentrytitle><manvolnum>3</manvolnum></citerefentry> 取得完整支援的變數清單。</para>

	<para>對於那些無法一直連線到網際網路的使用者，可在 <filename>/usr/ports</filename> 下執行 <command>make fetch</command> 來下載所有的 distfiles，或是可在某個分類的目錄中，例如 <filename>/usr/ports/net</filename>，或指定的 Port Skeleton 中執行。要注意的是，若 Port 有任何的相依，在分類或 Port Skeleton 中執行此指令並 <emphasis>不會</emphasis> 下載相依在其他分類的 Port distfiles。可使用 <command>make fetch-recursive</command> 來下載所有相依 Port 的 distfiles。</para>

	<para>在部份少數情況，例如當公司或組織有自己的本地 distfiles 檔案庫，可使用 <varname>MASTER_SITES</varname> 變數來覆蓋在 <filename>Makefile</filename> 中指定的下載位址。當要指定替代的位址時可：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/<replaceable>directory</replaceable></userinput>
<prompt>#</prompt> <userinput>make MASTER_SITE_OVERRIDE= \
<replaceable>ftp://ftp.organization.org/pub/FreeBSD/ports/distfiles/</replaceable> fetch</userinput></screen>

	<para>也可使用 <varname>WRKDIRPREFIX</varname> 及 <varname>PREFIX</varname> 變數來覆蓋預設的工作及目標目錄。例如：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make WRKDIRPREFIX=/usr/home/example/ports install</userinput></screen>

	<para>會編譯在 <filename>/usr/home/example/ports</filename> 的 Port 並安裝所有東西到 <filename>/usr/local</filename> 下。</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make PREFIX=/usr/home/example/local install</userinput></screen>

	<para>會編譯在 <filename>/usr/ports</filename> Port 並安裝到 <filename>/usr/home/example/local</filename>。然後：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make WRKDIRPREFIX=../ports PREFIX=../local install</userinput></screen>

	<para>來同時設定工作及目標目錄。</para>

	<para>這些變數也可做為環境變數設定，請參考您使用的 Shell 操作手冊來取得如何設定環境變數的說明。</para>
      </sect3>
    </sect2>

    <sect2 xml:id="ports-removing">
      <title>移除已安裝的 Port</title>

      <indexterm xml:lang="en">
	<primary>ports</primary>
	<secondary>removing</secondary>
      </indexterm>

      <para>安裝的 Port 可以使用 <command>pkg delete</command> 解除安裝。 使用這個指令的範例可以在 <citerefentry><refentrytitle>pkg-delete</refentrytitle><manvolnum>8</manvolnum></citerefentry> 操作手冊找到。</para>

      <para>或者，可在 Port 的目錄下執行 <command>make deinstall</command>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/sysutils/lsof</userinput>
<userinput>make deinstall</userinput>
===&gt;  Deinstalling for sysutils/lsof
===&gt;   Deinstalling
Deinstallation has been requested for the following 1 packages:

	lsof-4.88.d,8

The deinstallation will free 229 kB
[1/1] Deleting lsof-4.88.d,8... done</screen>

      <para>建議閱讀 Port 解除安裝後的訊息，若有任何相依該 Port 的應用程式，這些資訊會被顯示出來，但解除安裝的程序仍會繼續。在這種情況下最好重新安裝應用程式來避免破壞相依性。</para>
    </sect2>

    <sect2 xml:id="ports-upgrading">
      <title>升級 Port</title>

      <indexterm xml:lang="en">
	<primary>ports</primary>
	<secondary>upgrading</secondary>
      </indexterm>

      <para>隨著時間推移，Port 套件集中會有新版的軟體可用。本節將說明如何檢查是否有可以升級的軟體及如何升級。</para>

      <para>要檢查已安裝 Port 是否有新版可用，請先確定已安裝最新版本的 Port 樹，使用 <xref linkend="ports-using-portsnap-method"/> 或 <xref linkend="ports-using-subversion-method"/> 中說明的指令來更新。在 FreeBSD 10 與更新的版本，或若套件系統已轉換為 <application>pkg</application>，可以使用下列指令列出已經安裝的 Port 中有那些已過時：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg version -l "&lt;"</userinput></screen>

      <para>在 FreeBSD 9.<replaceable>X</replaceable> 與較舊的版本，可以使用下列指令列出已經安裝的 Port 中有那些已過時：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg_version -l "&lt;"</userinput></screen>

      <important>
	<para>在嘗試升級之前，請先從檔首閱讀 <filename>/usr/ports/UPDATING</filename> 來取得最近有那些 Port 已升級或系統已安裝。這個檔案中會說明各種問題及在升級 Port 時可能會需要使用者執行的額外步驟，例如檔案格式更改、設定檔位置更改、或任何與先前版本不相容的問題。留意那些與您要升級 Port 相關的指示，並依照這些指示執行升級。</para>
      </important>

      <sect3 xml:id="ports-upgrading-tools">
	<title>升級與管理 Port 的工具</title>

	<indexterm><primary>ports</primary> <secondary>upgrading-tools</secondary></indexterm>

	<para>Port 套件集含有數個工具可以進行升級，每一種工具都有其優點及缺點。</para>

	<para>以往大多 Port 安裝會使用 <application>Portmaster</application> 或 <application>Portupgrade</application>，現在有較新的 <application>Synth</application> 可使用。</para>

	<note>
	  <para>那一種工具對特定系統是最佳的選擇取決於系統管理員。建議在使用任何這些工具之前先備份資料。</para>
	</note>

      </sect3>

      <sect3 xml:id="portmaster">
	<title>使用 <application>Portmaster</application> 升級 Port</title>

	<indexterm xml:lang="en">
	  <primary>portmaster</primary>
	</indexterm>

	<para><package>ports-mgmt/portmaster</package> 是可用來升級已安裝 Port 的小巧工具，它只使用了隨 FreeBSD 基礎系統安裝的工具，不需要相依其他 Port 或資料庫便可在 FreeBSD 使用，要使用 Port 安裝此工具可：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/ports-mgmt/portmaster</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

	<para><application>Portmaster</application> 將 Port 定義成四種類型：</para>

	<itemizedlist>
	  <listitem>
	    <para>根 Port：沒有相依且也不被任何其他 Port 相依。</para>
	  </listitem>

	  <listitem>
	    <para>主幹 Port：沒有相依，但被其他 Port 相依。</para>
	  </listitem>

	  <listitem>
	    <para>分支 Port：有相依，且其被其他 Port 相依。</para>
	  </listitem>

	  <listitem>
	    <para>枝 Port：有相依，但沒有被其他 Port 相依。</para>
	  </listitem>
	</itemizedlist>

	<para>要列出這幾個分類並搜尋是否有新版：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portmaster -L</userinput>
===&gt;&gt;&gt; Root ports (No dependencies, not depended on)
===&gt;&gt;&gt; ispell-3.2.06_18
===&gt;&gt;&gt; screen-4.0.3
        ===&gt;&gt;&gt; New version available: screen-4.0.3_1
===&gt;&gt;&gt; tcpflow-0.21_1
===&gt;&gt;&gt; 7 root ports
...
===&gt;&gt;&gt; Branch ports (Have dependencies, are depended on)
===&gt;&gt;&gt; apache22-2.2.3
        ===&gt;&gt;&gt; New version available: apache22-2.2.8
...
===&gt;&gt;&gt; Leaf ports (Have dependencies, not depended on)
===&gt;&gt;&gt; automake-1.9.6_2
===&gt;&gt;&gt; bash-3.1.17
        ===&gt;&gt;&gt; New version available: bash-3.2.33
...
===&gt;&gt;&gt; 32 leaf ports

===&gt;&gt;&gt; 137 total installed ports
        ===&gt;&gt;&gt; 83 have new versions available</screen>

	<para>此指令用來升級所有過時的 Port：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portmaster -a</userinput></screen>

	<note>
	  <para>預設 <application>Portmaster</application> 會在刪除已存在的 Port 前備份套件，若成功安裝新版 <application>Portmaster</application> 會刪除該備份。使用 <option>-b</option> 來讓 <application>Portmaster</application> 不會自動刪除備份。加入 <option>-i</option> 可啟動 <application>Portmaster</application> 的互動模式，會在升級每個 Port 前提示訊息。尚有許多可用的其他選項，請閱讀 <citerefentry vendor="ports"><refentrytitle>portmaster</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的操作手冊來取得詳細的用法。</para>
	</note>

	<para>若升級的過程發生錯誤，可加入 <option>-f</option> 來升級並重新編譯所有 Port：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portmaster -af</userinput></screen>

	<para><application>Portmaster</application> 也可用來安裝新的 Port 到系統，在編譯及安裝新 Port 前升級所有相依模組。要使用這個功能，要指定 Port 位於 Port 套件集中的位置：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portmaster <replaceable>shells/bash</replaceable></userinput></screen>

	<para>更多有關 <package>ports-mgmt/portmaster</package> 的資訊可至其 <filename>pkg-descr</filename> 取得。</para>
      </sect3>

      <sect3 xml:id="portupgrade">
	<title>使用 Portupgrade 升級 Port</title>

	<indexterm xml:lang="en">
	  <primary>portupgrade</primary>
	</indexterm>

	<para><package>ports-mgmt/portupgrade</package> 是另一個可以用來升級 Port 的工具，此工具會安裝一套可以用來管理 Port 的應用程式，它需要相依 Ruby。要安裝該 Port：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/ports-mgmt/portupgrade</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

	<para>在執行升級之前使用此工具，建議使用 <command>pkgdb -F</command> 掃描已安裝的 Port 並修正該指令回報的所有資訊不一致的套件。</para>

	<para>要升級所有安裝在系統上過時的 Port，可使用 <command>portupgrade -a</command>，或者加上 <option>-i</option> 會在每個套件升級時詢問確認：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portupgrade -ai</userinput></screen>

	<para>要升級指定的應用程式而非所有可用 Port 可使用 <command>portupgrade <replaceable>pkgname</replaceable></command>，非常重要的是，要加上 <option>-R</option> 來先升級指定應用程式所有相依的 Port：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portupgrade -R firefox</userinput></screen>

	<para>若使用 <option>-P</option>，<application>Portupgrade</application> 會先在 <envar>PKG_PATH</envar> 清單中的本地目錄中搜尋可用的套件。若本地沒有可用的套件，則會從遠端下載。若套件無法在本地或遠端找到，<application>Portupgrade</application> 則會使用 Port 來安裝。要避免完全使用 Port 安裝，可使用 <option>-PP</option>，這個選項會告訴 <application>Portupgrade</application> 若沒有套件可用時放棄安裝：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portupgrade -PP gnome3</userinput></screen>

	<para>若只想要下載 Port distfiles 或套件，使用 <option>-P</option> 參數。若不要編譯或安裝任何東西，使用 <option>-F</option>。請參考 <command>portupgrade</command> 的操作手冊來取得所有可用選項的更多資訊。</para>

	<para>更多有關 <package>ports-mgmt/portupgrade</package> 的資訊可至其 <filename>pkg-descr</filename> 取得。</para>
      </sect3>

    </sect2>

    <sect2 xml:id="ports-disk-space">
      <title>Port 與磁碟空間</title>

      <indexterm xml:lang="en">
	<primary>ports</primary>
	<secondary>disk-space</secondary>
      </indexterm>

      <para>使用 Port 套件集會隨著時間消耗磁碟空間。在編譯與安裝 Port 完之後，在 Port Skeleton 中執行 <command>make clean</command> 可清除暫存的 <filename>work</filename> 目錄。若使用 <application>Portmaster</application> 來安裝 Port，則會自動移除該目錄，除非使用 <option>-K</option>。若有安裝 <application>Portupgrade</application>，此指令將會移除所有在 Port 套件集的本地複本中找到的 <filename>work</filename> 目錄：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>portsclean -C</userinput></screen>

      <para>除此之外，許多過時的原始碼發行檔案會儲存在 <filename>/usr/ports/distfiles</filename>。使用 <application>Portupgrade</application> 刪除所有不再被任何 Port 所引用的 distfiles：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>portsclean -D</userinput></screen>

      <para><application>Portupgrade</application> 可以移除所有未被任何安裝在系統上的 Port 所引用的 distfiles：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>portsclean -DD</userinput></screen>

      <para>若有安裝 <application>Portmaster</application>，則可使用：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>portmaster --clean-distfiles</userinput></screen>

      <para>預設，若 distfile 應要被刪除，這個指令會以互動的方式向使用者確認。</para>

      <para>除了以上指令外，<package>ports-mgmt/pkg_cutleaves</package> 可自動移除不再需要使用的 Port。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="ports-poudriere">
    <title>使用 <application>Poudriere</application> 編譯套件</title>

    <para><application>Poudriere</application> 是一個使用 <acronym>BSD</acronym> 授權條款用來建立與測試 FreeBSD 套件的工具。它使用 FreeBSD Jail 來建置獨立的編譯環境，這些 Jail 可以用來編譯與目前所在系統不同 FreeBSD 版本的套件，也同樣可以在主機為 amd64 的系統上編譯供 i386 使用的套件。套件編譯完成後的目錄配置會與官方鏡像站完全相同。這些套件可由 <citerefentry><refentrytitle>pkg</refentrytitle><manvolnum>8</manvolnum></citerefentry> 及其他套件管理工具使用。</para>

    <para><application>Poudriere</application> 可使用 <package role="port">ports-mgmt/poudriere</package> 套件或 Port 安裝。安裝完成後會有一個範例的設定檔 <filename>/usr/local/etc/poudriere.conf.sample</filename>。複製此檔案到 <filename>/usr/local/etc/poudriere.conf</filename>，編輯複製的檔案來配合本地的設定。</para>

    <para>雖然在系統上執行 <application>poudriere</application> 並不一定要使用 <acronym>ZFS</acronym>，但使用了是有幫助的。當使用了 <acronym>ZFS</acronym>，則必須在 <filename>/usr/local/etc/poudriere.conf</filename> 指定 <varname>ZPOOL</varname> 以及 <varname>FREEBSD_HOST</varname> 應設定到一個最近的鏡像站。定義 <varname>CCACHE_DIR</varname> 可開啟使用 <package role="port">devel/ccache</package> 快取的功能來快取編譯結果並減少那些需時常編譯的程式碼的編譯次數。將 <application>poudriere</application> 資料集放到一個獨立的目錄並掛載到 <filename>/poudriere</filename> 可能會比較方便，其他設定項目採用預設值便足夠。</para>

    <para>偵測到的處理器數量可用來定義要同時執行多少個編譯。並給予足夠的虛擬記憶體，不論是 <acronym>RAM</acronym> 或交換空間，若虛擬記憶體不足，編譯 Jail 的動作將會停止並被清除，會造成奇怪的錯誤訊息。</para>

    <sect2 xml:id="poudriere-initialization">
      <title>初始化 Jail 與 Port 樹</title>

      <para>在設定之後，初始化 <application>poudriere</application> 來安裝 Jail 及其所需的 FreeBSD 樹與 Port 樹。使用 <option>-j</option> 來指定 Jail 的名稱以及 <option>-v</option> 來指定 FreeBSD 的版本。在執行 FreeBSD/amd64 的系統上可使用 <option>-a</option> 來設定要使用的架構為 <literal>i386</literal> 或 <literal>amd64</literal>，預設會採用使用 <command>uname</command> 所顯示的架構。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>poudriere jail -c -j <replaceable>10amd64</replaceable> -v <replaceable>10.0-RELEASE</replaceable></userinput>
====&gt;&gt; Creating 10amd64 fs... done
====&gt;&gt; Fetching base.txz for FreeBSD 10.0-RELEASE amd64
/poudriere/jails/10amd64/fromftp/base.txz      100% of   59 MB 1470 kBps 00m42s
====&gt;&gt; Extracting base.txz... done
====&gt;&gt; Fetching src.txz for FreeBSD 10.0-RELEASE amd64
/poudriere/jails/10amd64/fromftp/src.txz       100% of  107 MB 1476 kBps 01m14s
====&gt;&gt; Extracting src.txz... done
====&gt;&gt; Fetching games.txz for FreeBSD 10.0-RELEASE amd64
/poudriere/jails/10amd64/fromftp/games.txz     100% of  865 kB  734 kBps 00m01s
====&gt;&gt; Extracting games.txz... done
====&gt;&gt; Fetching lib32.txz for FreeBSD 10.0-RELEASE amd64
/poudriere/jails/10amd64/fromftp/lib32.txz     100% of   14 MB 1316 kBps 00m12s
====&gt;&gt; Extracting lib32.txz... done
====&gt;&gt; Cleaning up... done
====&gt;&gt; Jail 10amd64 10.0-RELEASE amd64 is ready to be used</screen>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>poudriere ports -c -p <replaceable>local</replaceable></userinput>
====&gt;&gt; Creating local fs... done
====&gt;&gt; Extracting portstree "local"...
Looking up portsnap.FreeBSD.org mirrors... 7 mirrors found.
Fetching public key from ec2-eu-west-1.portsnap.freebsd.org... done.
Fetching snapshot tag from ec2-eu-west-1.portsnap.freebsd.org... done.
Fetching snapshot metadata... done.
Fetching snapshot generated at Tue Feb 11 01:07:15 CET 2014:
94a3431f0ce567f6452ffde4fd3d7d3c6e1da143efec76100% of   69 MB 1246 kBps 00m57s
Extracting snapshot... done.
Verifying snapshot integrity... done.
Fetching snapshot tag from ec2-eu-west-1.portsnap.freebsd.org... done.
Fetching snapshot metadata... done.
Updating from Tue Feb 11 01:07:15 CET 2014 to Tue Feb 11 16:05:20 CET 2014.
Fetching 4 metadata patches... done.
Applying metadata patches... done.
Fetching 0 metadata files... done.
Fetching 48 patches.
(48/48) 100.00%  done.
done.
Applying patches...
done.
Fetching 1 new ports or files... done.
/poudriere/ports/tester/CHANGES
/poudriere/ports/tester/COPYRIGHT

[...]

Building new INDEX files... done.</screen>

      <para>在一台電腦，<application>poudriere</application> 可使用多組設定在多個 Jail 編譯來自不同 Port 樹的 Port。用來定義這些組合的自訂設定稱作 <emphasis>sets</emphasis>，可在安裝 <package>ports-mgmt/poudriere</package> 或 <package>ports-mgmt/poudriere-devel</package> 後參考 <citerefentry vendor="ports"><refentrytitle>poudriere</refentrytitle><manvolnum>8</manvolnum></citerefentry> 中的 CUSTOMIZATION 章節來取得詳細的資訊。</para>

      <para>在此處示範的基本設定放了單一個 jail-, port- 以及 set- 特定的 <filename>make.conf</filename> 在 <filename>/usr/local/etc/poudriere.d</filename>。在此範例使用的檔案名稱由 Jail 名稱、Port 名稱以及 set 名稱所組成：<filename><replaceable>10amd64-local-workstation</replaceable>-make.conf</filename>。系統 <filename>make.conf</filename> 與這個新的檔案在編譯時期會被合併為編譯 Jail 要使用的 <filename>make.conf</filename>。</para>

      <para>要編譯的套件會輸入到 <filename><replaceable>10amd64-local-workstation</replaceable>-pkglist</filename>：</para>

      <programlisting xml:lang="en">editors/emacs
devel/git
ports-mgmt/pkg
...</programlisting>

      <para>可使用以下方式設定選項及相依：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>poudriere options -j <replaceable>10amd64</replaceable> -p <replaceable>local</replaceable> -z <replaceable>workstation</replaceable> -f <replaceable>10amd64-local-workstation-pkglist</replaceable></userinput></screen>

      <para>最後，編譯套件並建立套件檔案庫：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>poudriere bulk -j <replaceable>10amd64</replaceable> -p <replaceable>local</replaceable> -z <replaceable>workstation</replaceable> -f <replaceable>10amd64-local-workstation-pkglist</replaceable></userinput></screen>

      <para>在執行時，按下 <keycombo action="simul"><keycap>Ctrl</keycap><keycap>t</keycap></keycombo> 可以顯示目前編譯的狀態，<application>Poudriere</application> 也會編譯在 <filename>/poudriere/logs/bulk/<replaceable>jailname</replaceable></filename> 中的檔案，可用在網頁伺服器來顯示編譯資訊。</para>

      <para>完成之後，新套件現在可以從 <application>poudriere</application> 檔案庫來安裝。</para>

      <para>要取得更多使用 <application>poudriere</application> 的資訊，請參考 <citerefentry vendor="ports"><refentrytitle>poudriere</refentrytitle><manvolnum>8</manvolnum></citerefentry> 及主網站 <link xlink:href="https://github.com/freebsd/poudriere/wiki"/>。</para>
    </sect2>
    <sect2>
      <title>設定 pkg 客戶端使用 Poudriere 檔案庫</title>

      <para>雖然可以同時使用自訂的檔案庫與官方檔案庫，但有時關閉官方檔案庫會有幫助。這可以透過建立一個設定檔覆蓋並關閉官方的設定檔來完成。建立 <filename>/usr/local/etc/pkg/repos/FreeBSD.conf</filename> 包含以下內容：</para>

      <programlisting xml:lang="en">FreeBSD: {
	enabled: no
}</programlisting>

      <para>通常最簡單要提供 poudriere 檔案庫給客戶端的方式是透過 HTTP。安裝一個網頁伺服器來提供套件目錄，通常會像：<filename>/usr/local/poudriere/data/packages/<replaceable>10amd64</replaceable></filename>，其中 <filename>10amd64</filename> 是編譯的名稱。</para>

      <para>若要連往套件檔案庫的 URL 是：<literal>http://pkg.example.com/10amd64</literal>，則在 <filename>/usr/local/etc/pkg/repos/custom.conf</filename> 的檔案庫設定檔為：</para>

      <programlisting xml:lang="en">custom: {
	url: "<replaceable>http://pkg.example.com/10amd64</replaceable>",
	enabled: yes,
}</programlisting>
    </sect2>
  </sect1>

  <sect1 xml:id="ports-nextsteps">
    <title>安裝後的注意事項</title>

    <para>不論軟體是從套件或 Port 安裝，大部份的第三方應用程式安裝完後需要做某種程度的設定，下列指令與位置可以用來協助找到應用程式安裝了什麼。</para>

    <itemizedlist>
      <listitem>
	<para>大部份應用程式安裝會在 <filename>/usr/local/etc</filename> 安裝至少一個預設的設定檔，若應用程式有大量設定檔的時則會建立一個子目錄來存放這些設定檔。範例的設定檔案名稱通常使用 <filename>.sample</filename> 結尾，設定檔應要仔細查看並可能要做一些編輯讓設定檔符合系統的需求，要編輯設定檔範本前需先複製該檔案並去除 <filename>.sample</filename> 副檔名。</para>
      </listitem>

      <listitem>
	<para>應用程式提供的文件會安裝到 <filename>/usr/local/share/doc</filename>，且許多應用程式也同時會安裝操作手冊，在繼續使用應用程式前應先查看這些文件。</para>
      </listitem>

      <listitem>
	<para>部份應用程式會以服務的方式執行，在啟動應用程式前前需要加入設定到 <filename>/etc/rc.conf</filename>。這些應用程式通常會安裝啟動 Script 到 <filename>/usr/local/etc/rc.d</filename>，請參考 <link linkend="configtuning-starting-services">啟動服務</link> 來取得更多資訊。</para>

	<note>
	  <para>依設計，應用程式不會在安裝時執行其啟動 Script，也不會在解除安裝或升級時執行其中止 Script，這留給各系統的管理者去做決定。</para>
	</note>

      </listitem>

      <listitem>
	<para><citerefentry><refentrytitle>csh</refentrytitle><manvolnum>1</manvolnum></citerefentry> 的使用者應要執行 <command>rehash</command> 來更新已知 Binary 清單到 Shell 的 <envar>PATH</envar>。</para>
      </listitem>

      <listitem>
	<para>使用 <command>pkg info</command> 來了解應用程式安裝了那些檔案、操作手冊以及 Binary。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="ports-broken">
    <title>處理損壞的 Port</title>

    <para>當發現某個 Port 無法順利編譯或安裝，可以嘗試以下幾種方法解決：</para>

    <orderedlist>
      <listitem>
	<para>搜尋 <link xlink:href="@@URL_RELPREFIX@@/support.html">問題回報資料庫</link> 看該 Port 有沒有待審核的修正，若有的話可以使用該修正來修正問題。</para>
      </listitem>

      <listitem>
	<para>尋求維護人員的協助，在 Port Skeleton 目錄中輸入 <command>make maintainer</command> 或閱讀 Port 的 <filename>Makefile</filename> 來取得維護人員的電子郵件位址。寄給維護人員的郵件內容請記得要包含 Port 的 <filename>Makefile</filename> 中的 <literal>$FreeBSD:</literal> 一整行及輸出的錯誤訊息。</para>

	<note>
	  <para>有一些 Port 並非由個人維護，而是由 <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/mailing-list-faq/article.html">郵遞論壇</link> 維護，有許多，但並非全部，只要郵件地址長的像 <email role="nolink">freebsd-listname@FreeBSD.org</email> 都是，寄信時記得代入實際的論壇名稱。</para>

	  <para>尤其是由 <email role="nolink">ports@FreeBSD.org</email> 所維護的  Port  都不是由特定個人維護，而該 Port 的修正與支援都是來自訂閱該郵遞論壇的一般社群所提供，我們隨時歡迎志工參與!</para>
	</note>

	<para>若寄信後沒有取得任何回應，可以依照 <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/problem-reports/article.html">撰寫 FreeBSD 問題回報</link> 的說明使用 Bugzilla 提出問題回報。</para>
      </listitem>

      <listitem>
	<para>自行修正看看！<link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/books/porters-handbook/index.html">Porter's Handbook</link> 中含有 Port 基礎架構的詳細資訊，可提供資訊讓您可修正偶然損壞的 Port 或甚至您可以提交之自己的 Port！</para>
      </listitem>

      <listitem>
	<para>依照 <xref linkend="pkgng-intro"/> 中的說明安裝 Binary 套件，替代使用 Port 安裝。</para>
      </listitem>
    </orderedlist>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="x11">
  <!--
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Ken</firstname>
	<surname>Tom</surname>
	<contrib>Updated for X.Org's X11 server by </contrib>
      </author>
      <author>
	<firstname>Marc</firstname>
	<surname>Fonvieille</surname>
      </author>
    </authorgroup>
  </chapterinfo>
  -->

  <title>X Window 系統</title>

  <sect1 xml:id="x11-synopsis">
    <title>概述</title>

    <para>使用 <application>bsdinstall</application> 安裝 FreeBSD 並不會自動安裝圖型化使用者介面。本章將說明如何安裝並設定 <application>Xorg</application>，該應用程式提供開放源碼的 X Window 系統來提供圖型化環境。接著會說明如何找到並安裝桌面環境或視窗管理程式。</para>

    <note>
      <para>偏好安裝時會自動設定 <application>Xorg</application> 並且在安裝過程提供視窗管理程式選項的使用者請參考 <link xlink:href="http://www.trueos.org/"/> 網站。</para>
    </note>

    <para>更多有關 <application>Xorg</application> 支援影像硬體資訊，請參考 <link xlink:href="http://www.x.org/">x.org</link> 網站。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>組成 X Window 系統的各種元件以及它們是如何相互運作。</para>
      </listitem>

      <listitem>
	<para>如何安裝並設定 <application>Xorg</application>。</para>
      </listitem>

      <listitem>
	<para>如何安裝並設定各種視窗管理程式與桌面環境。</para>
      </listitem>

      <listitem>
	<para>如何在 <application>Xorg</application> 上使用 <trademark class="registered">TrueType</trademark> 字型。</para>
      </listitem>

      <listitem>
	<para>如何設定系統以使用圖形化登入 (<application>XDM</application>)。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>了解如何依照 <xref linkend="ports"/> 說明安裝其他第三方軟體。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="x-understanding">
    <title>術語</title>

    <para>雖然 X 各元件的所有細節及運作方式，並不是必須要知道的。 但對它們有些基本概念會更容易上手。</para>

    <variablelist>
      <varlistentry>
	<term>X 伺服器 (X Server)</term>

	<listitem>
	  <para>X 最初設計是以網路為中心，採用 <quote>client-server</quote> 架構。在此架構下 <quote>X 伺服器</quote> 在有鍵盤、螢幕、滑鼠的電腦上運作。該伺服器負責的工作包含管理顯示、處理來自鍵盤、滑鼠的輸入及來自其他設備 (如平板或或影像投影機) 的輸入或輸出。這點可能會讓人感到困惑，因為 X 使用的術語與一般的認知剛好相反。 一般認知會以為 <quote>X 伺服器</quote> 是要在最強悍的主機上執行，而 <quote>X 客戶端</quote> 才是在桌機上面執行，實際上卻是相反。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>X 客戶端 (X Client)</term>

	<listitem>
	  <para>每個 X 應用程式，如 <application>XTerm</application>、<application>Firefox</application> 都是 <quote>客戶端</quote>。 客戶端會傳訊息到伺服器，例如：<quote>請在這些座標畫一個視窗</quote>，接著伺服器會傳回訊息，如：<quote>使用者剛點選了確定按鈕</quote>。</para>

	  <para>在家庭或小型辦公室環境，通常 X 伺服器跟 X 客戶端都是在同一台電腦上執行。也可以在比較慢的電腦上執行 X 伺服器， 並在比較強、比較貴的系統上執行 X 應用程式。 在這種情景，X 客戶端與伺服器之間的溝通就需透過網路來進行。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>視窗管理程式 (Window Manager)</term>

	<listitem>
	  <para>X 並不規定螢幕上的視窗該長什麼樣、要如何移動滑鼠指標、 要用什麼鍵來在視窗切換、每個視窗的標題列長相，及是否該有關閉按鈕，等等。事實上，X 把這部分交給所謂的視窗管理程式來管理。可用的<link xlink:href="http://www.xwinman.org/">視窗管理程式有很多種</link>，每一種視窗管理程式都提供不同的使用介面風格：有些支援虛擬桌面，有些允許自訂組合鍵來管理桌面，有些有 <quote>開始</quote> 鈕，有些則是可更換佈景主題，可自行安裝新的佈景主題以更換外觀。 視窗管理程式可在 Port 套件集的 <filename>x11-wm</filename> 分類找到。</para>

	  <para>每個視窗管理程式也各有其不同的設定機制，有些需要手動修改設定檔， 而有的則可透過圖型化工具來完成大部分的設定工作。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>桌面環境 (Desktop Environment)</term>

	<listitem>
	  <para><application>KDE</application> 與 <application>GNOME</application> 會被稱作桌面環境是因為包含了完整常用桌面作業的應用程式，這些應用程式可能包含文書軟體、網頁瀏覽器及遊戲。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>聚焦政策 (Focus Policy)</term>

	<listitem>
	  <para>視窗管理程式負責滑鼠指標的聚焦政策。 聚焦政策指的是如何決定使用中及接收鍵盤輸入的視窗。</para>

	  <para>通常較為人熟悉的聚焦政策叫做 <quote>click-to-focus</quote>，這個模式中，滑鼠點選到的視窗便會處於作用中 (Active) 的狀態。在 <quote>focus-follows-mouse</quote> 模式滑鼠指標所在的視窗便是作用中的視窗，只要把滑鼠移到其他視窗就可以改變作用中的視窗，若滑鼠移到根視窗 (Root Window)，則會聚焦在根視窗。在 <quote>sloppy-focus</quote> 模式，既使滑鼠移到根視窗，仍然會聚焦在最後聚焦的視窗上，此模式只有當滑鼠進入新的視窗時才會聚焦於該視窗，而非離開目前視窗時。<quote>click-to-focus</quote> 模式用滑鼠點擊來決定作用中的視窗，且該視窗會被置頂到所有其他視窗之前，即使滑鼠移到其他視窗，所有的鍵盤輸入仍會由該視窗所接收。</para>

	  <para>不同的視窗管理程式支援不同的聚焦模式，全部都支援 click-to-focus 且其中大部份支援其他模式，請查看視窗管理程式的說明文件來了解可用的聚焦模式。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>視窗元件 (Widget)</term>

	<listitem>
	  <para>視窗元件指的是在所有在使用者介面上可被點選或操作的項目，這包括按鈕、核選方塊、單選按鈕、圖示及清單。 視窗元件工具包 (Widget toolkit) 是指用來建立圖型化應用程式的一系列的視窗元件。目前有數個有名的視窗元件工具包，包含 <application>KDE</application> 所使用的 Qt、<application>GNOME</application> 所使用的 GTK+。 因此應用程式會依其開發時所選用的視窗元件工具包而有不同的外觀。</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </sect1>

  <sect1 xml:id="x-install">
    <title>安裝 <application>Xorg</application></title>

    <para>在 FreeBSD，<application>Xorg</application> 可透過套件或 Port 來安裝。</para>

    <para>使用 Binary 套件的安裝速度較快，但可用的自訂選項較少：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install xorg</userinput></screen>

    <para>要從 Port 套件集編譯與安裝：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/x11/xorg</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

    <para>兩種安裝方式皆可完整安裝 <application>Xorg</application> 系統，對大多數使用者較建議使用 Binary 套件安裝。</para>

    <para>較精簡版本的 X 系統適合給有經驗的使用者使用，可至 <package>x11/xorg-minimal</package> 取得。這個版本就不會安裝大多數的文件、函數庫以及應用程式，而部份應用程式會需要這些額外的元件才能運作。</para>
  </sect1>

  <sect1 xml:id="x-config">
    <title><application>Xorg</application> 設定</title>

    <info>
      <author xml:lang="en">
	<personname>
	  <firstname>Warren</firstname>
	  <surname>Block</surname>
	</personname>
	<contrib>Originally contributed by</contrib>
      </author>
    </info>

    <indexterm xml:lang="en"><primary>Xorg</primary></indexterm>
    <indexterm xml:lang="en"><primary><application>Xorg</application></primary></indexterm>

    <sect2 xml:id="x-config-quick-start">
      <title>快速開始</title>

      <para><application>Xorg</application> 支援大多數常見的顯示卡、鍵盤以及指標裝置。</para>

      <tip>
	<para>顯示卡、顯示器以及輸入裝置會自動偵測，無須任何手動設置。除非自動設置失敗，否則請勿建立 <filename>xorg.conf</filename> 或執行 <option>-configure</option> 步驟。</para>
      </tip>

      <procedure>
	<step>
	  <para>若 <application>Xorg</application> 曾經在電腦使用過，可先將現有的設定檔重新命名或移除：</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mv /etc/X11/xorg.conf ~/xorg.conf.etc</userinput>
<prompt>#</prompt> <userinput>mv /usr/local/etc/X11/xorg.conf ~/xorg.conf.localetc</userinput></screen>
	</step>

	<step>
	  <para>加入要執行 <application>Xorg</application> 的使用者到 <literal>video</literal> 或 <literal>wheel</literal> 群組，以便在可用時能開啟 3D 加速。要加入使用者 <replaceable>jru</replaceable> 到任一個可用的群組：</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupmod video -m <replaceable>jru</replaceable> || pw groupmod wheel -m <replaceable>jru</replaceable></userinput></screen>
	</step>

	<step>
	  <para>預設內含 <acronym>TWM</acronym> 視窗管理程式，啟動 <application>Xorg</application> 時便會啟動該視窗管理程式：</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>startx</userinput></screen>
	</step>

	<step>
	  <para>在部份較舊版的 FreeBSD，在切換回文字 Console 前系統 Console 必須設為 <citerefentry><refentrytitle>vt</refentrytitle><manvolnum>4</manvolnum></citerefentry> 才可正常運作，請參考 <xref linkend="x-config-kms"/>。</para>
	</step>
      </procedure>
    </sect2>

    <sect2 xml:id="x-config-user-group">
      <title>可加速影像處理的使用者群組</title>

      <para>要存取 <filename>/dev/dri</filename> 需要允許顯示卡的 3D 加速功能，這通常只需要將要執行 X 的使用者加入 <literal>video</literal> 或 <literal>wheel</literal> 群組。此處使用 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來將使用者 <replaceable>slurms</replaceable> 加入 <literal>video</literal> 群組，若沒有 <literal>video</literal> 則會加入 <literal>wheel</literal> 群組：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupmod video -m <replaceable>slurms</replaceable> || pw groupmod wheel -m <replaceable>slurms</replaceable></userinput></screen>
    </sect2>

    <sect2 xml:id="x-config-kms">
      <title>核心模式設定 (Kernel Mode Setting, <acronym>KMS</acronym>)</title>

      <para>當電腦顯示從 Console 切換到高螢幕解析度供 X 使用時，必須設定影像輸出<emphasis>模式</emphasis>。最近版本的 <acronym>Xorg</acronym> 使用了核心內部的系統來讓切換模式更有效率。較舊版的 FreeBSD 使用的 <citerefentry><refentrytitle>sc</refentrytitle><manvolnum>4</manvolnum></citerefentry> 並不知到 <acronym>KMS</acronym> 系統的存在，這會導致關閉 X 之後即始仍在運作但系統 Console 卻呈現空白。較新版的 <citerefentry><refentrytitle>vt</refentrytitle><manvolnum>4</manvolnum></citerefentry> Console 可避免這個問題。</para>

      <para>加入此行到 <filename>/boot/loader.conf</filename> 來開啟 <citerefentry><refentrytitle>vt</refentrytitle><manvolnum>4</manvolnum></citerefentry>：</para>

      <programlisting xml:lang="en">kern.vty=vt</programlisting>
    </sect2>

    <sect2 xml:id="x-config-files">
      <title>設定檔</title>

      <para>通常不需要做手動設置，除非自動設置無法運作，否則請不要手動建立設定檔。</para>

      <sect3 xml:id="x-config-files-directory">
	<title>目錄</title>

	<para><application>Xorg</application> 會查看數個目錄來尋找設定檔，在 FreeBSD 較建議使用 <filename>/usr/local/etc/X11/</filename> 來存放這些設定檔，使用這個目錄可以幫助將應用程式檔案與作業系統檔案分離。</para>

	<para>儲存設定檔在傳統的 <filename>/etc/X11/</filename> 仍可運作，但並不建議將應用程式檔案與基礎 FreeBSD 檔案混合在一起存放。</para>
      </sect3>

      <sect3 xml:id="x-config-files-single-or-multi">
	<title>單檔或多檔</title>

	<para>使用多檔，每一個檔案只設定一個指定項目會較傳統使用單一 <filename>xorg.conf</filename> 設定來的簡單。這些檔案會存放在主設定檔目錄下的 <filename>xorg.conf.d/</filename> 子目錄，完整路徑通常為 <filename>/usr/local/etc/X11/xorg.conf.d/</filename>。</para>

	<para>於本節稍後會有這些檔案的範例。</para>

	<para>傳統單一 <filename>xorg.conf</filename> 的方式仍可運作，但比起在 <filename>xorg.conf.d/</filename> 子目錄中的多檔設定方式較不明瞭且沒有彈性。</para>
      </sect3>
    </sect2>

    <sect2 xml:id="x-config-video-cards">
      <title>顯示卡</title>

      <para>由於最近 FreeBSD 版本所做的變更，現在可以使用由 Port 或套件所提供的繪圖驅動程式，所以使用者可以使用下列來自 <package>graphics/drm-kmod</package> 的驅動程式。</para>

      <variablelist>
	<varlistentry xml:id="x-config-video-cards-ports">
	  <term>Intel KMS 驅動程式</term>
	  <term>Radeon KMS 驅動程式</term>
	  <term>AMD KMS 驅動程式</term>

	  <listitem>
	    <para>大多數使用 Intel KMS 驅動程式的 Intel 顯示卡支援 2D 與 3D 加速。</para>

	    <para>驅動程式名稱：<literal>i915kms</literal></para>

	    <para>大多數使用 Radeon KMS 驅動程式的舊 AMD 顯示卡支援 2D 與 3D 加速。</para>

	    <para>驅動程式名稱：<literal>radeonkms</literal></para>

	    <para>大多數使用 AMD KMS 驅動程式的新 AMD 顯示卡支援 2D 與 3D 加速。</para>

	    <para>驅動程式名稱：<literal>amdgpu</literal></para>

	    <para>參考文獻請至 <link xlink:href="https://en.wikipedia.org/wiki/List_of_Intel_graphics_processing_units"/> 或至 <link xlink:href="https://en.wikipedia.org/wiki/List_of_AMD_graphics_processing_units"/> 取得支援的 GPU 清單。</para>
	  </listitem>
	</varlistentry>

	<varlistentry xml:id="x-config-video-cards-intel">
	  <term xml:lang="en"><trademark class="registered">Intel</trademark></term>

	  <listitem>
	    <para>3D 加速在大多數 <trademark class="registered">Intel</trademark> 顯示晶片都有支援，最新到 Ivy Bridge (HD Graphics 2500, 4000, 及 P4000) 包含 Iron Lake (HD Graphics) 與 Sandy Bridge (HD Graphics 2000)。</para>

	    <para>驅動程式名稱：<literal>intel</literal></para>

	    <para>參考文獻請至 <link xlink:href="https://en.wikipedia.org/wiki/List_of_Intel_graphics_processing_units"/>。</para>
	  </listitem>
	</varlistentry>

	<varlistentry xml:id="x-config-video-cards-radeon">
	  <term xml:lang="en"><trademark class="registered">AMD</trademark> Radeon</term>

	  <listitem>
	    <para>Radeon 顯示卡支援 2D 及 3D 加速，最新到 HD6000 系列。</para>

	    <para>驅動程式名稱：<literal>radeon</literal></para>

	    <para>參考文獻請至 <link xlink:href="https://en.wikipedia.org/wiki/List_of_AMD_graphics_processing_units"/>。</para>
	  </listitem>
	</varlistentry>

	<varlistentry xml:id="x-config-video-cards-nvidia">
	  <term xml:lang="en">NVIDIA</term>

	  <listitem>
	    <para>有數個 NVIDIA 驅動程式可於 Port 套件集中的 <filename>x11</filename> 分類取得，請安裝其中與顯示卡相符的驅動程式。</para>

	    <para>參考文獻請至 <link xlink:href="https://en.wikipedia.org/wiki/List_of_Nvidia_graphics_processing_units"/>。</para>
	  </listitem>
	</varlistentry>

	<varlistentry xml:id="x-config-video-cards-hybrid">
	  <term>混合組合繪圖晶片</term>

	  <listitem>
	    <para>部份筆記型電腦加入了額外繪圖處理單元到那些內建晶片組或處理。<emphasis>Optimus</emphasis> 結合了 <trademark class="registered">Intel</trademark> 及 NVIDIA 的硬體，<emphasis>Switchable Graphics</emphasis> 或 <emphasis>Hybrid Graphics</emphasis> 則是結合了 <trademark class="registered">Intel</trademark> 或 <trademark class="registered">AMD</trademark> 處理器與 <trademark class="registered">AMD</trademark> Radeon <acronym>GPU</acronym>。</para>

	    <para>這些混合繪圖系統的實作方式均不同，FreeBSD 的 <application>Xorg</application> 尚無法驅動所有的混合繪圖系統版本。</para>

	    <para>部份電腦提供了 <acronym>BIOS</acronym> 的選項可以關閉其中一個繪圖介面卡或選擇 <emphasis>discrete</emphasis> 模式，可用使用其中一種標準顯示卡驅動程式來驅動。例如，有時關閉 Optimus 系統中的 NVIDIA <acronym>GPU</acronym> 是可能讓 <trademark class="registered">Intel</trademark> 顯示晶片可用 <trademark class="registered">Intel</trademark> 驅動程式驅動。</para>

	    <para><acronym>BIOS</acronym> 設定會依電腦的型號有所不同，在某些情況下，可以同時開啟兩個 <acronym>GPU</acronym>，而在建立的設定檔中的 <literal>Device</literal> 節只使用主要的 <acronym>GPU</acronym> 便能讓系統運作。</para>
	  </listitem>
	</varlistentry>

	<varlistentry xml:id="x-config-video-cards-other">
	  <term>其他顯示卡</term>

	  <listitem>
	    <para>較不常見的顯示卡驅動程式可在 Port 套件集的 <filename>x11-drivers</filename> 目錄找到。</para>

	    <para>若沒有特定的驅動程式可以支援顯示卡，仍可能可用 <package>x11-drivers/xf86-video-vesa</package> 驅動程式來驅動。該驅動程式可使用 <package>x11/xorg</package> 安裝，也可使用 <package>x11-drivers/xf86-video-vesa</package> 手動安裝。當沒有指定驅動程式時 <application>Xorg</application> 會嘗試使用這個驅動程式來驅動顯示卡。</para>

	    <para><package>x11-drivers/xf86-video-scfb</package> 也是不特定顯示卡的驅動程式，可在許多 <acronym>UEFI</acronym> 及 <trademark class="registered">ARM</trademark> 的電腦上運作。</para>
	  </listitem>
	</varlistentry>

	<varlistentry xml:id="x-config-video-cards-file">
	  <term>在檔案中設定影像驅動程式</term>

	  <listitem>
	    <para>要在設定檔設定使用 <trademark class="registered">Intel</trademark> 驅動程式：</para>

	    <example xml:id="x-config-video-cards-file-intel">
	      <title>在單檔中選擇 <trademark class="registered">Intel</trademark> 影像驅動程式</title>

	      <para xml:lang="en"><filename>/usr/local/etc/X11/xorg.conf.d/driver-intel.conf</filename></para>

	      <programlisting xml:lang="en">Section "Device"
	Identifier "Card0"
	Driver     "intel"
	# BusID    "PCI:1:0:0"
EndSection</programlisting>

	      <para>若有多張顯示卡，可取消註解 <literal>BusID</literal> identifier 然後設定為想要的顯示卡，顯示卡的 Bus <acronym>ID</acronym> 清單可以使用 <command>pciconf -lv | grep -B3 display</command> 取得。</para>
	    </example>

	    <para>要在設定檔設定使用 Radeon 驅動程式：</para>

	    <example xml:id="x-config-video-cards-file-radeon">
	      <title>在單檔中選擇 Radeon 影像驅動程式</title>

	      <para xml:lang="en"><filename>/usr/local/etc/X11/xorg.conf.d/driver-radeon.conf</filename></para>

	      <programlisting xml:lang="en">Section "Device"
	Identifier "Card0"
	Driver     "radeon"
EndSection</programlisting>
	    </example>

	    <para>要在設定檔設定使用 <acronym>VESA</acronym> 驅動程式：</para>

	    <example xml:id="x-config-video-cards-file-vesa">
	      <title>在單檔中選擇 <acronym>VESA</acronym> 影像驅動程式</title>

	      <para xml:lang="en"><filename>/usr/local/etc/X11/xorg.conf.d/driver-vesa.conf</filename></para>

	      <programlisting xml:lang="en">Section "Device"
	Identifier "Card0"
	Driver     "vesa"
EndSection</programlisting>
	    </example>

	    <para>要設定 <acronym>UEFI</acronym> 或 <trademark class="registered">ARM</trademark> 電腦使用 <literal>scfb</literal> 驅動程式：</para>

	    <example xml:id="x-config-video-cards-file-scfb">
	      <title>在單檔中選擇 <literal>scfb</literal> 影像驅動程式</title>

	      <para xml:lang="en"><filename>/usr/local/etc/X11/xorg.conf.d/driver-scfb.conf</filename></para>

	      <programlisting xml:lang="en">Section "Device"
	Identifier "Card0"
	Driver     "scfb"
EndSection</programlisting>
	    </example>
	  </listitem>
	</varlistentry>
      </variablelist>
    </sect2>

    <sect2 xml:id="x-config-monitors">
      <title>顯示器</title>

      <para>幾乎所有顯示器都支援延伸顯示辨識資料標準 (Extended Display Identification Data, <acronym>EDID</acronym>)，<application>Xorg</application> 會使用 <acronym>EDID</acronym> 與顯示器通訊並偵測支援的解析度與更新頻率，然後選擇最適合的設定組合使用該顯示器。</para>

      <para>其他顯示器支援的解析度可透過在設定檔中設定想要的解析度來選擇，或者在 X 伺服器啟動之後使用 <citerefentry vendor="xfree86"><refentrytitle>xrandr</refentrytitle><manvolnum>1</manvolnum></citerefentry>。</para>

      <variablelist>
	<varlistentry xml:id="x-config-monitors-xrandr">
	  <term>使用 <citerefentry vendor="xfree86"><refentrytitle>xrandr</refentrytitle><manvolnum>1</manvolnum></citerefentry></term>

	  <listitem>
	    <para>執行 <citerefentry vendor="xfree86"><refentrytitle>xrandr</refentrytitle><manvolnum>1</manvolnum></citerefentry> 不加任何參數可檢查影像輸出及已偵測到的顯示器模式清單：</para>

	    <screen xml:lang="en"><prompt>%</prompt> <userinput>xrandr</userinput>
Screen 0: minimum 320 x 200, current 3000 x 1920, maximum 8192 x 8192
DVI-0 connected primary 1920x1200+1080+0 (normal left inverted right x axis y axis) 495mm x 310mm
   1920x1200     59.95*+
   1600x1200     60.00
   1280x1024     85.02    75.02    60.02
   1280x960      60.00
   1152x864      75.00
   1024x768      85.00    75.08    70.07    60.00
   832x624       74.55
   800x600       75.00    60.32
   640x480       75.00    60.00
   720x400       70.08
DisplayPort-0 disconnected (normal left inverted right x axis y axis)
HDMI-0 disconnected (normal left inverted right x axis y axis)</screen>

	    <para>這個結果顯示 <literal>DVI-0</literal> 輸出被用來顯示解析度為 1920x1200 像素於更新頻率約 60 Hz 的畫面，未有顯示器連接到 <literal>DisplayPort-0</literal> 與 <literal>HDMI-0</literal> 接頭。</para>

	    <para>可使用 <citerefentry vendor="xfree86"><refentrytitle>xrandr</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來選擇任何其他的顯示模式。例如要切換為 1280x1024 於 60 Hz：</para>

	    <screen xml:lang="en"><prompt>%</prompt> <userinput>xrandr --mode 1280x1024 --rate 60</userinput></screen>

	    <para>在筆記型電腦使用外部顯示輸出到投影機是常見的作業。</para>

	    <para>不同裝置間輸出接頭的類型與數量也不同，給每個輸出的名稱在不同驅動程式間也不同。在某些驅動程式稱為 <literal>HDMI-1</literal> 的輸出在其他驅動程式則可能稱為 <literal>HDMI1</literal>。因此第一個步驟是執行 <citerefentry vendor="xfree86"><refentrytitle>xrandr</refentrytitle><manvolnum>1</manvolnum></citerefentry> 列出所有可用的輸出：</para>

	    <screen xml:lang="en"><prompt>%</prompt> <userinput>xrandr</userinput>
Screen 0: minimum 320 x 200, current 1366 x 768, maximum 8192 x 8192
LVDS1 connected 1366x768+0+0 (normal left inverted right x axis y axis) 344mm x 193mm
   1366x768      60.04*+
   1024x768      60.00
   800x600       60.32    56.25
   640x480       59.94
VGA1 connected (normal left inverted right x axis y axis)
   1280x1024     60.02 +  75.02
   1280x960      60.00
   1152x864      75.00
   1024x768      75.08    70.07    60.00
   832x624       74.55
   800x600       72.19    75.00    60.32    56.25
   640x480       75.00    72.81    66.67    60.00
   720x400       70.08
HDMI1 disconnected (normal left inverted right x axis y axis)
DP1 disconnected (normal left inverted right x axis y axis)</screen>

	    <para>已找到四個輸出：內建面板的 <literal>LVDS1</literal>，外接的 <literal>VGA1</literal>, <literal>HDMI1</literal> 以及 <literal>DP1</literal> 接頭。</para>

	    <para>投影機已連接至 <literal>VGA1</literal> 輸出，現在使用 <citerefentry vendor="xfree86"><refentrytitle>xrandr</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來設定該輸出到投影機 (原始解析度) 並加入額外的空間到桌面的右側：</para>

	    <screen xml:lang="en"><prompt>%</prompt> <userinput>xrandr --output VGA1 --auto --right-of LVDS1</userinput></screen>

	    <para><literal>--auto</literal> 會選擇使用 <acronym>EDID</acronym> 偵測到的解析度與更新頻率。若未正確偵測解析度，可替換 <literal>--auto</literal> 為 <literal>--mode</literal> 然後給予固定值。例如大部份的投影機可使用 1024x768 解析度為，則可設定 <literal>--mode 1024x768</literal>。</para>

	    <para><citerefentry vendor="xfree86"><refentrytitle>xrandr</refentrytitle><manvolnum>1</manvolnum></citerefentry> 通常會在 <filename>.xinitrc</filename> 執行以在 X 啟動時設定適合的模式。</para>
	  </listitem>
	</varlistentry>

	<varlistentry xml:id="x-config-monitors-files">
	  <term>在檔案中設定螢幕解析度</term>

	  <listitem>
	    <para>在設定檔設定螢幕解析度為 1024x768：</para>

	    <example>
	      <title>在單檔中設定螢幕解析度</title>

	      <para xml:lang="en"><filename>/usr/local/etc/X11/xorg.conf.d/screen-resolution.conf</filename></para>

	      <programlisting xml:lang="en">Section "Screen"
	Identifier "Screen0"
	Device     "Card0"
	SubSection "Display"
	Modes      "1024x768"
	EndSubSection
EndSection</programlisting>
	    </example>

	    <para>少數顯示器沒有 <acronym>EDID</acronym>，可設定 <literal>HorizSync</literal> 及 <literal>VertRefresh</literal> 為顯示器支援的頻率範圍。</para>

	    <example>
	      <title>手動設定顯示器頻率</title>

	      <para xml:lang="en"><filename>/usr/local/etc/X11/xorg.conf.d/monitor0-freq.conf</filename></para>

	      <programlisting xml:lang="en">Section "Monitor"
	Identifier   "Monitor0"
	HorizSync    30-83   # kHz
	VertRefresh  50-76   # Hz
EndSection</programlisting>
	    </example>
	  </listitem>
	</varlistentry>
      </variablelist>
    </sect2>

    <sect2 xml:id="x-config-input">
      <title>輸入裝置</title>

      <sect3 xml:id="x-config-input-keyboard">
	<title>鍵盤</title>

	<variablelist>
	  <varlistentry xml:id="x-config-input-keyboard-layout">
	    <term>鍵盤配置</term>

	    <listitem>
	      <para>鍵盤上標準按鍵的位置稱做 <emphasis>配置 (Layout)</emphasis>。配置與其他可調整的參數列於 <citerefentry vendor="xfree86"><refentrytitle>xkeyboard-config</refentrytitle><manvolnum>7</manvolnum></citerefentry>。</para>

	      <para>預設為 United States 配置，要選擇其他的配置可在 <literal>InputClass</literal> 設定 <literal>XkbLayout</literal> 與 <literal>XkbVariant</literal> 選項。這會套用所有符合該類別的輸入裝置。</para>

	      <para>這個例子選擇 French 鍵盤配置使用 <literal>oss</literal> 變體。</para>

	      <example>
		<title>設定鍵盤配置</title>

		<para xml:lang="en"><filename>/usr/local/etc/X11/xorg.conf.d/keyboard-fr-oss.conf</filename></para>

		<programlisting xml:lang="en">Section	"InputClass"
	Identifier	"KeyboardDefaults"
	Driver		"keyboard"
	MatchIsKeyboard	"on"
	Option		"XkbLayout" "fr"
	Option		"XkbVariant" "oss"
EndSection</programlisting>
	      </example>

	      <example>
		<title>設定多個鍵盤配置</title>

		<para>設定 United States, Spanish 與 Ukrainian 鍵盤配置，並可按 <keycombo action="simul"> <keycap>Alt</keycap> <keycap>Shift</keycap> </keycombo> 來切換這些配置。可使用 <package>x11/xxkb</package> 或 <package>x11/sbxkb</package> 來加強配置切換控制與目前配置的指示。</para>

		<para xml:lang="en"><filename>/usr/local/etc/X11/xorg.conf.d/kbd-layout-multi.conf</filename></para>

		<programlisting xml:lang="en">Section	"InputClass"
	Identifier	"All Keyboards"
	MatchIsKeyboard	"yes"
	Option		"XkbLayout" "us, es, ua"
EndSection</programlisting>
	      </example>
	    </listitem>
	  </varlistentry>

	  <varlistentry xml:id="x-config-input-keyboard-zap">
	    <term>從鍵盤關閉 <application>Xorg</application></term>

	    <listitem>
	      <para>X 可以使用組合鍵來關閉，預設並未設定組合鍵，因為該組合鍵與部份應用程式的鍵盤指令衝突。要開啟這個選項需要更改鍵盤 <literal>InputDevice</literal> 節：</para>

	      <example>
		<title>開啟鍵盤離開 X 功能</title>

		<para xml:lang="en"><filename>/usr/local/etc/X11/xorg.conf.d/keyboard-zap.conf</filename></para>

		<programlisting xml:lang="en">Section	"InputClass"
	Identifier	"KeyboardDefaults"
	Driver		"keyboard"
	MatchIsKeyboard	"on"
	Option		"XkbOptions" "terminate:ctrl_alt_bksp"
EndSection</programlisting>
	      </example>
	    </listitem>
	  </varlistentry>
	</variablelist>
      </sect3>

      <sect3 xml:id="x11-input-mice">
	<title>滑鼠與指標裝置</title>

	<para>有許多滑鼠參數可使用設定選項來調整，請參考 <citerefentry vendor="xorg"><refentrytitle>mousedrv</refentrytitle><manvolnum>4</manvolnum></citerefentry> 來取得完整清單。</para>

	<variablelist>
	  <varlistentry xml:id="x11-input-mice-buttons">
	    <term>滑鼠按鍵</term>

	    <listitem>
	      <para>滑鼠的按鍵數可在 <filename>xorg.conf</filename> 的滑鼠 <literal>InputDevice</literal> 節設定，例如要設定按鍵數為 7：</para>

	      <example>
		<title>設定滑鼠按鍵數</title>

		<para xml:lang="en"><filename>/usr/local/etc/X11/xorg.conf.d/mouse0-buttons.conf</filename></para>

		<programlisting xml:lang="en">Section "InputDevice"
	Identifier  "Mouse0"
	Option      "Buttons" "7"
EndSection</programlisting>
	      </example>
	    </listitem>
	  </varlistentry>
	</variablelist>
      </sect3>
    </sect2>

    <sect2 xml:id="x-config-manual-configuration">
      <title>手動設定</title>

      <para>在某些情況 <application>Xorg</application> 的自動設定無法在特定硬體上運作，或需要使用不同的設定。針對這些情況會建立自訂的設定檔。</para>

      <warning>
	<para>非必要請勿手動建立設定檔，非必要的手動設置會造成運作不正常。</para>
      </warning>

      <para>設定檔可由 <application>Xorg</application> 根據偵測到的硬體產生，這個檔案對一開始自訂設定很有幫助。</para>

      <para>產生 <filename>xorg.conf</filename>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>Xorg -configure</userinput></screen>

      <para>設定檔會儲存至 <filename>/root/xorg.conf.new</filename>，做任何需要的更改，然後使用以下指令測試該檔案：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>Xorg -config /root/xorg.conf.new</userinput></screen>

      <para>在新設定檔調整與測試過後，便可分開成較小的檔案放置到正常的位置 <filename>/usr/local/etc/X11/xorg.conf.d/</filename>。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="x-fonts">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Murray</firstname>
	  <surname>Stokely</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>在 <application>Xorg</application> 使用字型</title>

    <sect2 xml:id="type1">
      <title>Type1 字型</title>

      <para>由於 <application>Xorg</application> 內建的預設字型用在典型的桌面出版應用程式並不是很理想，大字型會呈現鋸齒狀邊緣，看起來很不專業，小字型幾乎完全看不清楚。不過，這裡有幾個免費高品質的 Type1 (<trademark class="registered">PostScript</trademark>) 字型可用，且能容易的在 <application>Xorg</application> 使用。例如，URW 字型集 (<trademark class="registered">Times Roman</trademark>, <trademark class="registered">Helvetica</trademark>, <trademark class="registered">Palatino</trademark> 及其他)。 Freefont 字型集 (<package>x11-fonts/freefonts</package>) 包含了更多的字型，但其中大部分是給圖形軟體如 GIMP 所使用的字型，並不能完全作為螢幕字型使用。此外，<application>Xorg</application> 可以簡單的設定使用 <trademark class="registered">TrueType</trademark> 字型。更多有關本主題的詳細資訊，請參考 <citerefentry vendor="xfree86"><refentrytitle>X</refentrytitle><manvolnum>7</manvolnum></citerefentry> 操作手冊或 <xref linkend="truetype"/>。</para>

      <para>要由 Binary 套件安裝上述的 Type1 字型集可執行以下指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install urwfonts</userinput></screen>

      <para>或由 Port 套件集編譯，可執行以下指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/x11-fonts/urwfonts</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>同樣的安裝方式也適用 Freefont 或其他字型集。要讓 X 伺服器偵測到這些新安裝的字型，可加入適當的設定到 X 伺服器設定檔 (<filename>/etc/X11/xorg.conf</filename>)，內容為：</para>

      <programlisting xml:lang="en">FontPath "/usr/local/share/fonts/urwfonts/"</programlisting>

      <para>或者在 X session 的指令列執行：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>xset fp+ /usr/local/share/fonts/urwfonts</userinput>
<prompt>%</prompt> <userinput>xset fp rehash</userinput></screen>

      <para>這樣便可，但在 X session 關閉時將會失效，除非將該設定加入啟動檔 (一般的 <command>startx</command> session 可在 <filename>~/.xinitrc</filename> 設定，若透過圖型化登入管理程式如 <application>XDM</application> 登入時則在 <filename>~/.xsession</filename> 設定)。第三種方式是使用新 <filename>/usr/local/etc/fonts/local.conf</filename>，如 <xref linkend="antialias"/> 的示範。</para>
    </sect2>

    <sect2 xml:id="truetype">
      <title><trademark class="registered">TrueType</trademark> 字型</title>

      <indexterm xml:lang="en">
	<primary>TrueType Fonts</primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>fonts</primary>
	<secondary>TrueType</secondary>
      </indexterm>

      <para><application>Xorg</application> 內建支援繪製 <trademark class="registered">TrueType</trademark> 字型，目前有兩個模組可以支援這項功能。在本例中使用 freetype 模組，由於此模組與其他字型繪製後端較為一致。要開啟 freetype 模組只需要將下行加入到 <filename>/etc/X11/xorg.conf</filename> 中的 <literal>"Module"</literal> section。</para>

      <programlisting xml:lang="en">Load  "freetype"</programlisting>

      <para>現在要建立一個儲存 <trademark class="registered">TrueType</trademark> 字型的目錄 (例如，<filename>/usr/local/share/fonts/TrueType</filename>) 然後複製所有 <trademark class="registered">TrueType</trademark> 字型到這個目錄。要注意 <trademark class="registered">TrueType</trademark> 字型並無法直接取自 <trademark class="registered">Apple</trademark> <trademark class="registered">Mac</trademark>，<application>Xorg</application> 使用的字型必須為 <trademark class="registered">UNIX</trademark>/<trademark class="registered">MS-DOS</trademark>/<trademark class="registered">Windows</trademark> 的格式。檔案複製到讓目錄之後，使用 <application>mkfontscale</application> 來建立 <filename>fonts.dir</filename> 來讓 X 字型繪製程式知道安裝了新的檔案。<command>mkfontscale</command> 可用套件的方式安裝：</para>

      <screen><prompt>#</prompt> <userinput>pkg install mkfontscale</userinput></screen>

      <para>然後在目錄中建立 X 字型檔的索引：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/local/share/fonts/TrueType</userinput>
<prompt>#</prompt> <userinput>mkfontscale</userinput></screen>

      <para>接著加入 <trademark class="registered">TrueType</trademark> 目錄到字型路徑。這個動作與 <xref linkend="type1"/> 中所介紹的方式相同：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>xset fp+ /usr/local/share/fonts/TrueType</userinput>
<prompt>%</prompt> <userinput>xset fp rehash</userinput></screen>

      <para>或直接加入 <literal>FontPath</literal> 一行到 <filename>xorg.conf</filename>。</para>

      <para>現在 <application>Gimp</application>, <application>Apache OpenOffice</application> 以及其他 X 應用程式應可以辨識到已安裝的 <trademark class="registered">TrueType</trademark> 字型。極小的字型 (以高解析度在網頁中顯示的文字) 與極大的字型 (在 <application><trademark>StarOffice</trademark></application> 中) 現在會看起來比較像樣了。</para>
    </sect2>

    <sect2 xml:id="antialias">
      <!--
      <sect2info>
	<authorgroup>
	  <author>
	    <firstname>Joe Marcus</firstname>
	    <surname>Clarke</surname>
	    <contrib>Updated in May 2003 by</contrib>
	  </author>
	</authorgroup>
      </sect2info>
      -->
      <title>反鋸齒字型</title>

      <indexterm xml:lang="en">
	<primary>anti-aliased fonts</primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>fonts</primary>
	<secondary>anti-aliased</secondary>
      </indexterm>

      <para>所有可在 <filename>/usr/local/share/fonts/</filename> 及 <filename>~/.fonts/</filename> 找到的 <application>Xorg</application> 字型均可在  Xft-aware 的應用程式使用反鋸齒的效果。大多最近的應用程式均為 Xft-aware 的，包括 <application>KDE</application>, <application>GNOME</application> 以及 <application>Firefox</application>。</para>

      <para>要控制那一些字型要做反鋸齒或設定反鋸齒的屬性，需建立 <filename>/usr/local/etc/fonts/local.conf</filename> 檔案 (若檔案存在則編輯)。在這個檔案中可以調整 Xft 字型系統的數項進階功能，本章節僅介紹部份簡單的項目，要取得進一步資訊，請參考 <citerefentry vendor="xorg"><refentrytitle>fonts-conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>。</para>

      <indexterm xml:lang="en"><primary>XML</primary></indexterm>

      <para>這個檔案必須使用 XML 格式，小心文字大小寫，且要確定所有標籤均有正常結尾。檔案的開頭使用常見的 XML 檔首，接著為 DOCTYPE 定義，然後是 <literal>&lt;fontconfig&gt;</literal> 標籤：</para>

      <programlisting xml:lang="en">&lt;?xml version="1.0"?&gt;
      &lt;!DOCTYPE fontconfig SYSTEM "fonts.dtd"&gt;
      &lt;fontconfig&gt;</programlisting>

      <para>如同前面所提到的，所有在 <filename>/usr/local/share/fonts/</filename> 與 <filename>~/.fonts/</filename> 的字型均可在 Xft-aware 的應用程式做反鋸齒效果，若您想要加入除了上兩者以外的目錄，可加入如下行設定到 <filename>/usr/local/etc/fonts/local.conf</filename>：</para>

      <programlisting xml:lang="en">&lt;dir&gt;/path/to/my/fonts&lt;/dir&gt;</programlisting>

      <para>加入新字型及額外的新字型目錄之後，需重新建立字型快取：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>fc-cache -f</userinput></screen>

      <para>反鋸齒效果會讓文字的邊緣變模糊，這會讓非常小的文字更能閱讀且去除大型文字的 <quote>鋸齒</quote>，但套用在一般的文字可能會造成眼睛的疲勞。要排除小於 14 點的字型大小使用反鋸齒效果，可加入這些行：</para>

      <programlisting xml:lang="en">        &lt;match target="font"&gt;
	    &lt;test name="size" compare="less"&gt;
		&lt;double&gt;14&lt;/double&gt;
	    &lt;/test&gt;
	    &lt;edit name="antialias" mode="assign"&gt;
		&lt;bool&gt;false&lt;/bool&gt;
	    &lt;/edit&gt;
	&lt;/match&gt;
	&lt;match target="font"&gt;
	    &lt;test name="pixelsize" compare="less" qual="any"&gt;
		&lt;double&gt;14&lt;/double&gt;
	    &lt;/test&gt;
	    &lt;edit mode="assign" name="antialias"&gt;
		&lt;bool&gt;false&lt;/bool&gt;
	    &lt;/edit&gt;
	&lt;/match&gt;</programlisting>

      <indexterm xml:lang="en">
	<primary>fonts</primary>
	<secondary>spacing</secondary>
      </indexterm>

      <para>反鋸齒所產生的間距對於部份等寬字型並不合適，尤其是在使用 <application>KDE</application> 時會成為一個問題。可能的修正方式是強制這類字型的間距為 100，可加入以下行：</para>

      <programlisting xml:lang="en">	&lt;match target="pattern" name="family"&gt;
	   &lt;test qual="any" name="family"&gt;
	       &lt;string&gt;fixed&lt;/string&gt;
	   &lt;/test&gt;
	   &lt;edit name="family" mode="assign"&gt;
	       &lt;string&gt;mono&lt;/string&gt;
	   &lt;/edit&gt;
	&lt;/match&gt;
	&lt;match target="pattern" name="family"&gt;
	    &lt;test qual="any" name="family"&gt;
		&lt;string&gt;console&lt;/string&gt;
	    &lt;/test&gt;
	    &lt;edit name="family" mode="assign"&gt;
		&lt;string&gt;mono&lt;/string&gt;
	    &lt;/edit&gt;
	&lt;/match&gt;</programlisting>

      <para>(這會設定等寬字型的其他常用名稱為 <literal>"mono"</literal>)，然後加入：</para>

      <programlisting xml:lang="en">         &lt;match target="pattern" name="family"&gt;
	     &lt;test qual="any" name="family"&gt;
		 &lt;string&gt;mono&lt;/string&gt;
	     &lt;/test&gt;
	     &lt;edit name="spacing" mode="assign"&gt;
		 &lt;int&gt;100&lt;/int&gt;
	     &lt;/edit&gt;
	 &lt;/match&gt;      </programlisting>

      <para>部份字型，如 Helvetica，在使用反鋸齒時可能會發生問題，通常會呈現像垂直切成兩半的字型，最差還可能會導致應用程式當掉。要避免這個問題，可考慮加入以下設定到 <filename>local.conf</filename>：</para>

      <programlisting xml:lang="en">         &lt;match target="pattern" name="family"&gt;
	     &lt;test qual="any" name="family"&gt;
		 &lt;string&gt;Helvetica&lt;/string&gt;
	     &lt;/test&gt;
	     &lt;edit name="family" mode="assign"&gt;
		 &lt;string&gt;sans-serif&lt;/string&gt;
	     &lt;/edit&gt;
	 &lt;/match&gt;        </programlisting>

      <para>編輯 <filename>local.conf</filename> 完之後，請確認有使用 <literal>&lt;/fontconfig&gt;</literal> 標籤結尾，若沒有使用會讓所做的更改被忽略。</para>

      <para>使用者可透過建立自己的 <filename>~/.config/fontconfig/fonts.conf</filename> 來加入個人化的設定，此檔案使用與上述說明相同的 <acronym>XML</acronym> 格式。</para>

      <indexterm xml:lang="en"><primary>LCD screen</primary></indexterm>
      <indexterm xml:lang="en"><primary>Fonts</primary>
	<secondary>LCD screen</secondary></indexterm>

      <para>最後一點：若有使用 LCD 螢幕，可能會想要使用子像素取樣 (Sub-pixel sampling)，這基本上會分開處理 (水平分隔)  紅、綠、藍色彩組成來提高垂直解析度，結果可能是無法預料的。要開啟這個功能，加入下行到 <filename>local.conf</filename> 的任一處：</para>

      <programlisting xml:lang="en">	 &lt;match target="font"&gt;
	     &lt;test qual="all" name="rgba"&gt;
		 &lt;const&gt;unknown&lt;/const&gt;
	     &lt;/test&gt;
	     &lt;edit name="rgba" mode="assign"&gt;
		 &lt;const&gt;rgb&lt;/const&gt;
	     &lt;/edit&gt;
	 &lt;/match&gt;</programlisting>

      <note>
	<para>依據不同的顯示器類型可能會需要將 <literal>rgb</literal> 更改為 <literal>bgr</literal>, <literal>vrgb</literal> 或 <literal>vbgr</literal>：可實驗看看然後看那一個效果最好。</para>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="x-xdm">
    <info>
      <title>X 顯示管理程式</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Seth</firstname>
	    <surname>Kingsley</surname>
	  </personname>
	  <contrib>Originally contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en"><primary>X Display Manager</primary></indexterm>
    <para><application>Xorg</application> 提供了 X 顯示管理程式 (X Display Manager, <application>XDM</application>)，可用來做登入階段的管理。<application>XDM</application> 提供了一個圖型化的介面來選擇要連結的顯示伺服器以及輸入認証資訊 (登入與密碼)。</para>

    <para>本節將示範如何設定 FreeBSD 的 X 顯示管理程式。部份桌面環境會提供自己的圖型化登入管理程式，請參考 <xref linkend="x11-wm-gnome"/> 取得如何設定 GNOME 顯示管理程式 (GNOME Display Manager) 的操作方式以及 <xref linkend="x11-wm-kde"/> 取得如何設定 KDE 顯示管理程式 (KDE Display Manager) 的操作方式。</para>

    <sect2>
      <title>設定 <application>XDM</application></title>

      <para>要安裝 <application>XDM</application> 可使用 <package>x11/xdm</package> 套件或 Port。安裝完成之後，可設定 <application>XDM</application> 在開機時執行，只需編輯 <filename>/etc/ttys</filename> 中的此項目：</para>

      <screen xml:lang="en">ttyv8   "/usr/local/bin/xdm -nodaemon"  xterm   off secure</screen>

      <para>更改關 (<literal>off</literal>) 為開 (<literal>on</literal>) 然後儲存編輯。在此項目中的 <literal>ttyv8</literal> 代表 <application>XDM</application> 會在第 9 個虛擬終端機執行。</para>

      <para><application>XDM</application> 的設定目錄位於 <filename>/usr/local/etc/X11/xdm</filename>。此目錄中包含數個可用來更改 <application>XDM</application> 行為與外觀的檔案以及在 <application>XDM</application> 執行時用來設定桌面的一些 Script 及程式，<xref linkend="xdm-config-files"/> 摘要了每個檔案的功能。這些檔案正確的語法與用法在 <citerefentry vendor="xfree86"><refentrytitle>xdm</refentrytitle><manvolnum>1</manvolnum></citerefentry> 有說明。</para>

      <table frame="none" pgwide="1" xml:id="xdm-config-files">
	<title>XDM 設定檔</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>檔案</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><filename>Xaccess</filename></entry>
	      <entry>連線到 <application>XDM</application> 所需的通訊協定稱做 X 顯示管理程式連線通訊協定  (X Display Manager Connection Protocol, <acronym>XDMCP</acronym>)，此檔案為客戶端認証規則，用來控制來自遠端機器的 <acronym>XDMCP</acronym> 連線。預設此檔案並不允許任何遠端的客戶端連線。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>Xresources</filename></entry>
	      <entry>此檔案控制 <application>XDM</application> 顯示選擇器及登入畫面的外觀。預設的設定簡單的矩形登入視窗，上方用較大的字型顯示機器的主機名稱，並在下方顯示 <quote>Login:</quote> 與 <quote>Password:</quote> 提示。此檔案的格式與 <application>Xorg</application> 說明文件中說明的 app-defaults 檔相同。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>Xservers</filename></entry>
	      <entry>登入選擇時在選擇器上要提供的本地及遠端顯示清單。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>Xsession</filename></entry>
	      <entry>預設的登入階段 Script，使用者登入之後由 <application>XDM</application> 執行。這會指向使用者自訂的登入階段 Script 於 <filename>~/.xsession</filename>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>Xsetup_</filename>*</entry>
	      <entry>用來在顯示選擇器與登入介面之前自動執行應用程式的 Script。每一個顯示各有一個 Script，名稱為 <filename>Xsetup_*</filename>，其中 <literal>*</literal> 為本地顯示編號。正常情況這些 Script 會在背景執行一兩個程式，例如 <command>xconsole</command>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>xdm-config</filename></entry>
	      <entry>用來設定所有在此機器上執行的顯示的全域設定檔。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>xdm-errors</filename></entry>
	      <entry>內含由伺服器程式產生的錯誤訊息，若 <application>XDM</application> 嘗試啟動的顯示沒有回應，可查看此檔案來取得錯誤訊息。以登入階段為基礎，這些訊息也同樣會寫入至使用者的 <filename>~/.xsession-errors</filename>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>xdm-pid</filename></entry>
	      <entry><application>XDM</application> 的執行程序 <acronym>ID</acronym>。</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>
    </sect2>

    <sect2>
      <title>設定遠端存取</title>

      <para>預設只有同系統的使用者可以使用 <application>XDM</application> 登入。要開啟讓其他系統的使用者可連線到顯示伺服器，需編輯存取控制規則及開啟連線傾聽程式。</para>

      <para>要設定 <application>XDM</application> 傾聽任何遠端的連線，在 <filename>/usr/local/etc/X11/xdm/xdm-config</filename> 中的 <literal>DisplayManager.requestPort</literal> 行前加上 <literal>!</literal> 來註解該行：</para>

      <screen xml:lang="en">! SECURITY: do not listen for XDMCP or Chooser requests
! Comment out this line if you want to manage X terminals with xdm
DisplayManager.requestPort:     0</screen>

      <para>儲存編輯並重新啟動 <application>XDM</application>，要限制遠端存取，請看 <filename>/usr/local/etc/X11/xdm/Xaccess</filename> 中的範例項目，並參考 <citerefentry vendor="xfree86"><refentrytitle>xdm</refentrytitle><manvolnum>1</manvolnum></citerefentry> 取得進一步資訊。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="x11-wm">
    <info>
      <title>桌面環境</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Valentino</firstname>
	    <surname>Vaschetto</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	   <!-- in June 2001 -->
	</author>
      </authorgroup>
    </info>

    <para>本節將介紹如何在 FreeBSD 系統安裝三種熱門的桌面環境。一套桌面環境的範圍可從簡單的視窗管理程式到完整的桌面應用程式集。有上百套的桌面環境可在 Port 套件集的 <filename>x11-wm</filename> 分類取得。</para>

    <sect2 xml:id="x11-wm-gnome">
      <title xml:lang="en">GNOME</title>

      <indexterm xml:lang="en"><primary>GNOME</primary></indexterm>
      <para><application>GNOME</application> 是一個擁有友善使用者介面的的桌面環境，它包括用於啟動應用程式和顯示狀態的面板、一系列工具與應用程序及一套可讓應用程式更容易進行合作、相互一致的協定。更多有關 FreeBSD <application>GNOME</application> 的訊息可在 <link xlink:href="https://www.FreeBSD.org/gnome">https://www.FreeBSD.org/gnome</link> 取得，該網站包含了有關在 FreeBSD 安裝、設定和管理 <application>GNOME</application> 的額外文件。</para>

      <para>這套桌面環境可以從套件安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install gnome3</userinput></screen>

      <para>也可使用以下指令從 Port 編譯 <application>GNOME</application>，<application>GNOME</application> 是一套大型的應用程式，即使在速度較快的電腦上，也會需要花費一些時間編譯。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/x11/gnome3</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para><application>GNOME</application> 需要掛載 <filename>/proc</filename>。加入下行到 <filename>/etc/fstab</filename> 讓系統啟動時會自動掛載這個檔案系統：</para>

      <programlisting xml:lang="en">proc           /proc       procfs  rw  0   0</programlisting>

      <para><application>GNOME</application> 使用了 <application>D-Bus</application> 以及 <application>HAL</application> 的 Message bus 與 Hardware abstraction。這兩個應用程式會隨著 <application>GNOME</application> 的相依一併自動安裝，但需要在 <filename>/etc/rc.conf</filename> 開啟，這樣在系統開機時才會啟動：</para>

      <programlisting xml:lang="en">dbus_enable="YES"
hald_enable="YES"</programlisting>

      <para>安裝完之後，需設定讓 <application>Xorg</application> 啟動 <application>GNOME</application>。最簡單的方法是開啟 GNOME Display Manager, <application>GDM</application>，該程式已做為 <application>GNOME</application> 套件或 Port 的一部份安裝了，可加入下行到 <filename>/etc/rc.conf</filename> 來開啟：</para>

      <programlisting xml:lang="en">gdm_enable="YES"</programlisting>

      <para>通常也會需要啟動所有的 <application>GNOME</application> 服務，可加入下行到 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">gnome_enable="YES"</programlisting>

      <para><application>GDM</application> 則會在系統開機時自動啟動。</para>

      <para>第二種啟動 <application>GNOME</application> 的方法是在設定完 <filename>~/.xinitrc</filename> 後在指令列輸入 <command>startx</command>。若這個檔案已經存在，替換啟動目前視窗管理程式的那一行，改為啟動 <filename>/usr/local/bin/gnome-session</filename>。若檔案不存在，則使用以下指令建立一個：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>echo "exec /usr/local/bin/gnome-session" &gt; ~/.xinitrc</userinput></screen>

      <para>第三種方法是使用 <application>XDM</application> 做為顯示管理程式，在這個方法需要建立一個可執行的 <filename>~/.xsession</filename>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>echo "exec /usr/local/bin/gnome-session" &gt; ~/.xsession</userinput></screen>
    </sect2>

    <sect2 xml:id="x11-wm-kde">
      <title xml:lang="en">KDE</title>

      <indexterm xml:lang="en"><primary>KDE</primary></indexterm>

      <para><application>KDE</application> 是另一套易於使用的桌面環境。這個桌面環境提供了一致外觀的應用程式、標準化的選單和工具列、組合鍵、配色方案、國際化與集中、對話框導向的桌面設定。更多有關 <application>KDE</application> 可在 <link xlink:href="http://www.kde.org/">http://www.kde.org/</link> 取得。要取得 FreeBSD 特定的資訊，則可參考 <link xlink:href="http://freebsd.kde.org/">http://freebsd.kde.org</link>。</para>

      <para>要安裝 <application>KDE</application> 套件，請輸入：</para>

      <screen><prompt>#</prompt> <userinput>pkg install x11/kde5</userinput></screen>

      <para>或者要使用 <application>KDE</application> Port 編譯，可使用以下指令，採用 Port 方式安裝會有選單可以選擇要安裝的元件。<application>KDE</application> 是一個大型的應用程式，即使在較快的電腦上仍需要花費一段時間來編譯。</para>

      <screen><prompt>#</prompt> <userinput>cd /usr/ports/x11/kde5</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <indexterm xml:lang="en">
	<primary>KDE</primary>
	<secondary>display manager</secondary>
      </indexterm>

      <para><application>KDE</application> 需要掛載 <filename>/proc</filename>。加入下行到 <filename>/etc/fstab</filename> 讓系統啟動時會自動掛載這個檔案系統：</para>

      <programlisting xml:lang="en">proc           /proc       procfs  rw  0   0</programlisting>

      <para><application>KDE</application> 使用了 <application>D-Bus</application> 以及 <application>HAL</application> 的 Message bus 與 Hardware abstraction。這兩個應用程式會隨著 <application>KDE</application> 的相依一併自動安裝，但需要在 <filename>/etc/rc.conf</filename> 開啟，這樣在系統開機時才會啟動：</para>

      <programlisting xml:lang="en">dbus_enable="YES"
hald_enable="YES"</programlisting>

      <para>自 KDE Plasma 5 開始，KDE Display Manager, <application>KDM</application> 便停止開發，可能的替代方案為 <application>SDDM</application>，要安裝該套件可輸入：</para>

      <screen><prompt>#</prompt> <userinput>pkg install x11/sddm</userinput></screen>

      <para>加入下行到 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">sddm_enable="YES"</programlisting>

      <para>第二種執行 <application>KDE</application> 的方法是在在指令列輸入 <command>startx</command>。要採用這個方式，需要加入下行到 <filename>~/.xinitrc</filename>：</para>

      <programlisting xml:lang="en">exec ck-launch-session startkde</programlisting>

      <para>第三種啟動 <application>KDE</application> 的方式是透過 <application>XDM</application>，要使用這個方法需要建立一個可執行的 <filename>~/.xsession</filename> 如下：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>echo "exec ck-launch-session startkde" &gt; ~/.xsession</userinput></screen>

      <para>啟動 <application>KDE</application> 之後，請參考內建的說明系統來取得更多有關如何使用各種選單及應用程式的資訊。</para>
    </sect2>

    <sect2 xml:id="x11-wm-xfce">
      <title xml:lang="en">Xfce</title>

      <para><application>Xfce</application> 是以 <application>GNOME</application> 使用的 GTK +工具包做為基礎所開發的桌面環境，但是它更輕巧且提供了一種簡單、高效、易於使用的桌面。它可完全自訂設定、附有選單、Applet 及應用程式啟動器的主面板、提供檔案管理程式和音效管理程式並且可設定主題。由於它是快速、輕巧、高效的桌面環境，因此它非常適合有記憶體限制的較舊或較慢機器。更多有關 <application>Xfce</application> 的資訊可至 <link xlink:href="http://www.xfce.org/">http://www.xfce.org</link> 取得。</para>

      <para>要安裝 <application>Xfce</application> 套件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install xfce</userinput></screen>

      <para>或者使用 Port 編譯：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/x11-wm/xfce4</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para><application>Xfce</application> 使用了 <application>D-Bus</application> 作為 Message bus，由於是 <application>Xfce</application> 的相依，因此會自動安裝，但仍要在 <filename>/etc/rc.conf</filename> 中開啟該程式才會在系統開機時啟動：</para>

      <programlisting xml:lang="en">dbus_enable="YES"</programlisting>

      <para>不像 <application>GNOME</application> 或 <application>KDE</application>，<application>Xfce</application> 並沒有自己的登入管理程式，要能用 <command>startx</command> 指令列啟動 <application>Xfce</application> 之前需先加入其項目到 <filename>~/.xinitrc</filename>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>echo ". /usr/local/etc/xdg/xfce4/xinitrc" &gt; ~/.xinitrc</userinput></screen>

      <para>另一種方式是使用 <application>XDM</application>，要設定這個方式需建立一個可執行的 <filename>~/.xsession</filename>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>echo ". /usr/local/etc/xdg/xfce4/xinitrc" &gt; ~/.xsession</userinput></screen>
    </sect2>
  </sect1>

  <sect1 xml:id="x-compiz-fusion">
    <title>安裝 Compiz Fusion</title>

    <para>要令使用桌面電腦更令人愉快的方法是用炫麗的 3D 效果。</para>

    <para>安裝 <application>Compiz Fusion</application> 套件非常簡單，但設定該套件需要一些未在 Port 說明文件中說明的步驟。</para>

    <sect2 xml:id="x-compiz-video-card">
      <title>設定 FreeBSD nVidia 驅動程式</title>

      <para>桌面特效需要使用相當程度的顯示卡，對於以 nVidia 為基礎的顯示卡，需要使用專用的驅動程序來取得較佳的性能。其他顯示卡的使用可以跳過這一節，並繼續 <filename>xorg.conf</filename> 設定。</para>

      <para>要知道需要那一種 nVidia 驅動程式可以查看 <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/books/faq/x.html#idp59950544">FAQ 中與此主題相關的問題</link>。</para>

      <para>知道您的顯示卡要使用那種驅動程式才是正確的之後，接下來的安裝程序跟安裝其他套件一樣簡單。</para>

      <para>例如，要安裝最新的驅動程式：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install x11/nvidia-driver</userinput></screen>

      <para>驅動程式會建立一個需要在系統啟動時載入的核心模組，加入下行到 <filename>/boot/loader.conf</filename>：</para>

      <programlisting xml:lang="en">nvidia_load="YES"</programlisting>

      <note>
	<para>要立即載入核心模組到執行中的核心可以下 <command>kldload nvidia</command> 指令，但是需要注意，若不是在開機時載入，某些 <application>Xorg</application> 版本會無法正常運作。因此編輯完 <filename>/boot/loader.conf</filename> 之後建議要重新開機。</para>
      </note>

      <para>核心模組載入之後，您只需要更改 <filename>xorg.conf</filename> 的其中一行來開啟專用的驅動程式：</para>

      <para>找到 <filename>/etc/X11/xorg.conf</filename> 中的下行：</para>

      <programlisting xml:lang="en">Driver      "nv"</programlisting>

      <para>然後更改該行為：</para>

      <programlisting xml:lang="en">Driver      "nvidia"</programlisting>

      <para>如往常般啟動 GUI，您應該會看到 nVidia 的啟動畫面，其他東西應如往常般運作。</para>
    </sect2>

    <sect2 xml:id="xorg-configuration">
      <title>設定 xorg.conf 來啟動桌面特效</title>

      <para>要開啟 <application>Compiz Fusion</application> 需要修改 <filename>/etc/X11/xorg.conf</filename>：</para>

      <para>加入以下 Section 來開啟合成特效：</para>

      <programlisting xml:lang="en">Section "Extensions"
    Option         "Composite" "Enable"
EndSection</programlisting>

      <para>找到 <quote>Screen</quote> section，長的應該如下所示：</para>

      <programlisting xml:lang="en">Section "Screen"
    Identifier     "Screen0"
    Device         "Card0"
    Monitor        "Monitor0"
    ...</programlisting>

      <para>然後加入以下兩行 (在<quote>Monitor</quote> 之後)：</para>

      <programlisting xml:lang="en">DefaultDepth    24
Option         "AddARGBGLXVisuals" "True"</programlisting>

      <para>找到您欲使用的螢幕解析度所在的 <quote>Subsection</quote>，例如，您想要使用 1280x1024，則找到如下所示的 Section。若想要使用的解析度不在任何 Subsection 之中，您可以手動加入對應的項目：</para>

      <programlisting xml:lang="en">SubSection     "Display"
    Viewport    0 0
    Modes      "1280x1024"
EndSubSection</programlisting>

      <para>桌面合成需要 24 bit 的色彩深度，更改上述 Subsection 為：</para>

      <programlisting xml:lang="en">SubSection     "Display"
    Viewport    0 0
    Depth       24
    Modes      "1280x1024"
EndSubSection</programlisting>

      <para>最後確認在 <quote>Module</quote> section 中已經載入 <quote>glx</quote> 與 <quote>extmod</quote> 模組：</para>

      <programlisting xml:lang="en">Section "Module"
    Load           "extmod"
    Load           "glx"
    ...</programlisting>

      <para>前面所述的動作可以執行 <package>x11/nvidia-xconfig</package> 來自動完成 (使用 root)：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>nvidia-xconfig --add-argb-glx-visuals</userinput>
<prompt>#</prompt> <userinput>nvidia-xconfig --composite</userinput>
<prompt>#</prompt> <userinput>nvidia-xconfig --depth=24</userinput></screen>
    </sect2>

    <sect2 xml:id="compiz-fusion">
      <title>安裝與設定 Compiz Fusion</title>

      <para>安裝 <application>Compiz Fusion</application> 如同安裝其他套件一樣簡單：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install x11-wm/compiz-fusion</userinput></screen>

      <para>安裝完成之後，開啟您的圖型化桌面，然後在終端機的畫面輸入以下指令 (使用一般使用者)：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>compiz --replace --sm-disable --ignore-desktop-hints ccp &amp;</userinput>
<prompt>%</prompt> <userinput>emerald --replace &amp;</userinput></screen>

      <para>由於您的視窗管理程式 (例如：<application>Metacity</application>，若您使用 <application>GNOME</application>) 會被替換成 <application>Compiz Fusion</application>，您的螢幕會閃爍幾秒。而 <application>Emerald</application> 會處理視窗的裝飾  (例如：關閉、最小化、最大化按鈕、標題列及其他相關)。</para>

      <para>您或許可以將這些指令改寫成較小的 Script 然後在啟動時自動執行 (加到 <application>GNOME</application> 桌面的 <quote>Sessions</quote> 中)：</para>

      <programlisting xml:lang="en">#! /bin/sh
compiz --replace --sm-disable --ignore-desktop-hints ccp &amp;
emerald --replace &amp;</programlisting>

      <para>儲存這個 Script 到您的家目錄所在位置，例如 <filename>start-compiz</filename>，然後讓該檔案可以執行：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>chmod +x ~/start-compiz</userinput></screen>

      <para>接著使用 GUI  將該檔案加入啟動程式 <guimenuitem>Startup Programs</guimenuitem> (位於 <application>GNOME</application> 桌面的系統 <guimenuitem>System</guimenuitem>, 偏好設定 <guimenuitem>Preferences</guimenuitem>, 工作階段 <guimenuitem>Sessions</guimenuitem>)。</para>

      <para>要選擇所想使用的特效與相關設定，可執行 (一樣使用一般使用者) Compiz Config 設定管理程式 <application>Compiz Config Settings Manager</application>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>ccsm</userinput></screen>

      <note>
	<para>在 <application>GNOME</application> 中，也可在系統 <guimenuitem>System</guimenuitem>, 偏好設定 <guimenuitem>Preferences</guimenuitem> 選單中找到。</para>
      </note>

      <para>若您在編譯時選擇了 <quote>gconf support</quote>，您便可使用 <command>gconf-editor</command> 在 <literal>apps/compiz</literal> 下查看設定。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="x11-understanding">

    <title>疑難排解</title>

    <para>若滑鼠無法使用，您將需要做第一次設定方可繼續。在最近的 <application>Xorg</application> 版本，使用自動偵測裝置會忽略在 <filename>xorg.conf</filename> 中的 <literal>InputDevice</literal> section。要採用舊的方式，需在此檔案加入下行到 <literal>ServerLayout</literal> 或 <literal>ServerFlags</literal> section：</para>

      <programlisting xml:lang="en">Option "AutoAddDevices" "false"</programlisting>

      <para>輸入裝置便可如先前版本一樣設定，連同其他所需的選項 (如：切換鍵盤配置)。</para>

      <note>
	<para>如同前面有說明過，<application>hald</application> Daemon 預設會自動偵測您的鍵盤，因此您的鍵盤配置或型號可能不正確，桌面環境如 <application>GNOME</application>, <application>KDE</application> 或 <application>Xfce</application> 會提供設定鍵盤的工具。即使如此，還是有可能透過 <citerefentry vendor="xorg"><refentrytitle>setxkbmap</refentrytitle><manvolnum>1</manvolnum></citerefentry> 工具或 <application>hald</application> 的設定規則的協助來直接設定鍵盤屬性。</para>

	<para>舉例來說，若有人想要使用 PC 102 鍵的鍵盤，採用法語 (French) 配置，我們便需要建立一個給 <application>hald</application> 的鍵盤設定檔，名稱為 <filename>x11-input.fdi</filename>，然後儲存到 <filename>/usr/local/etc/hal/fdi/policy</filename> 目錄。這個檔案中應要有以下幾行：</para>

	<programlisting xml:lang="en">&lt;?xml version="1.0" encoding="iso-8859-1"?&gt;
&lt;deviceinfo version="0.2"&gt;
  &lt;device&gt;
    &lt;match key="info.capabilities" contains="input.keyboard"&gt;
	  &lt;merge key="input.x11_options.XkbModel" type="string"&gt;pc102&lt;/merge&gt;
	  &lt;merge key="input.x11_options.XkbLayout" type="string"&gt;fr&lt;/merge&gt;
    &lt;/match&gt;
  &lt;/device&gt;
&lt;/deviceinfo&gt;</programlisting>

	<para>若這個檔案已經存在，只需要複製並貼上您的檔案中有關鍵盤設定的那幾行。</para>

	<para>您會需要重新啟動您的機器來讓 <application>hald</application> 讀取這個檔案。</para>

	<para>也是可以從 X 終端機或 Script 下指令來做同樣的設定：</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>setxkbmap -model pc102 -layout fr</userinput></screen>

	<para><filename>/usr/local/share/X11/xkb/rules/base.lst</filename> 中列出了各種可用的鍵盤、配置與設定。</para>
      </note>

      <indexterm xml:lang="en"><primary><application>Xorg</application>
	  tuning</primary></indexterm>

      <para>現在可以開始調整 <filename>xorg.conf.new</filename> 設定檔，在文字編輯器如 <citerefentry vendor="ports"><refentrytitle>emacs</refentrytitle><manvolnum>1</manvolnum></citerefentry> 或 <citerefentry><refentrytitle>ee</refentrytitle><manvolnum>1</manvolnum></citerefentry> 開啟該設定檔。若顯示器是不支援自動偵測同步頻率 (Sync frequency) 的舊或特殊的型號，同步頻率的設定可以手動加到 <filename>xorg.conf.new</filename> 的 <literal>"Monitor"</literal> section：</para>

      <programlisting xml:lang="en">Section "Monitor"
	Identifier   "Monitor0"
	VendorName   "Monitor Vendor"
	ModelName    "Monitor Model"
	HorizSync    30-107
	VertRefresh  48-120
EndSection</programlisting>

      <para>多數顯示器都支援自動偵測同步頻率，並不需要手動設定這些數值。對於那些不支援自動偵測的顯示器，請輸入由製造商提供的數值來避免損壞顯示器。</para>

      <para>X 允許在支援的顯示器使用 DPMS (Energy Star) 功能，<citerefentry vendor="xfree86"><refentrytitle>xset</refentrytitle><manvolnum>1</manvolnum></citerefentry> 程式可以控制逾時並可強制待機 (Standby)、暫停 (Suspend) 或關閉 (Off) 模式。若您想要為您的顯示器開啟 DPMS 功能，您需要加入下行到顯示器 (Monitor) 的 Section：</para>

      <programlisting xml:lang="en">Option       "DPMS"</programlisting>

      <indexterm xml:lang="en">
	<primary><filename>xorg.conf</filename></primary>
      </indexterm>

      <para>在編輯器還未關閉 <filename>xorg.conf.new</filename> 設定檔前，選擇想要使用的預設解析度及色彩深度。這些項目可在 <literal>"Screen"</literal> section 定義：</para>

      <programlisting xml:lang="en">Section "Screen"
	Identifier "Screen0"
	Device     "Card0"
	Monitor    "Monitor0"
	DefaultDepth 24
	SubSection "Display"
		Viewport  0 0
		Depth     24
		Modes     "1024x768"
	EndSubSection
EndSection</programlisting>

      <para><literal>DefaultDepth</literal> 關鍵字代表預設執行要使用的色彩深度，這個設定可以被 <citerefentry vendor="xorg"><refentrytitle>Xorg</refentrytitle><manvolnum>1</manvolnum></citerefentry> 的指令列參數 <option>-depth</option> 覆蓋。<literal>Modes</literal> 關鍵字代表執行要使用的解析度，注意，只有 VESA 標準模式才支援目標系統的繪圖硬體來定義解析度。在上述的例子中，預設使用的色彩深度為每像素 24 bit，這個色彩深度可用的解析度為 1024 x 768 像素。</para>

      <para>最後，儲存設定檔並使用測試模式來測試上述的設定。</para>

      <note>
	<para>有一個工具可以協助您診斷問題，那就是 <application>Xorg</application> 日誌檔。該日誌檔中記錄了 <application>Xorg</application> 連接的每個裝置的資訊。<application>Xorg</application> 記錄檔名稱的格式為 <filename>/var/log/Xorg.0.log</filename>，確切的記錄檔名會可能從 <filename>Xorg.0.log</filename> 到 <filename>Xorg.8.log</filename> 以此類推。</para>
      </note>

      <para>若一且運作正常，設定檔需要安裝到 <citerefentry vendor="xorg"><refentrytitle>Xorg</refentrytitle><manvolnum>1</manvolnum></citerefentry> 會尋找的常用設定檔位置，通常是 <filename>/etc/X11/xorg.conf</filename> 或 <filename>/usr/local/etc/X11/xorg.conf</filename>。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cp xorg.conf.new /etc/X11/xorg.conf</userinput></screen>

      <para>現在已經完成了 <application>Xorg</application> 的設定程序。<application>Xorg</application> 現在可以使用 <citerefentry vendor="xfree86"><refentrytitle>startx</refentrytitle><manvolnum>1</manvolnum></citerefentry> 工具啟動。<application>Xorg</application> 伺服器也可以使用 <citerefentry vendor="xfree86"><refentrytitle>xdm</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來啟動。</para>

      <sect2>
	<title>設定 <trademark class="registered">Intel</trademark> <literal>i810</literal> 繪圖晶片組</title>

	<indexterm xml:lang="en">
	  <primary>Intel i810 graphic chipset</primary>
	</indexterm>

	<para>要設定 <trademark class="registered">Intel</trademark> i810 整合晶片組需要使用 <filename>agpgart</filename> AGP 程式介面來控制 <application>Xorg</application> 驅動該顯示卡。請參考 <citerefentry><refentrytitle>agp</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式操作手冊來取得更多詳細資訊。</para>

	<para>這也可讓您可以設定任何其他繪圖卡的硬體。注意，在未編譯 <citerefentry><refentrytitle>agp</refentrytitle><manvolnum>4</manvolnum></citerefentry> 到核心的系統，並無法使用 <citerefentry><refentrytitle>kldload</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來載入該模組，因此驅動程式必須在開機時便在核心啟動，所以需要透過編譯或使用 <filename>/boot/loader.conf</filename> 來載入。</para>
      </sect2>

      <sect2>
	<title>加入寬螢幕平板顯示器到設定檔</title>

	<indexterm xml:lang="en">
	  <primary>widescreen flatpanel configuration</primary>
	</indexterm>

	<para>此章節會需要有一些進階的設定知識，若嘗試使用上述的標準設定工具仍無法產生可運作的設定，在日誌檔中應有足夠的資訊可運用來讓顯示卡運作。在此會需要使用文字編輯器。</para>

	<para>目前使用寬螢幕 (WSXGA, WSXGA+, WUXGA, WXGA, WXGA+, et.al.) 格式支援的 16:10 及 10:9 格式或其他的寬高比可會有問題。例如一些 16:10 寬高比常見的螢幕解析度：</para>

	<itemizedlist>
	  <listitem>
	    <para xml:lang="en">2560x1600</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">1920x1200</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">1680x1050</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">1440x900</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">1280x800</para>
	  </listitem>
	</itemizedlist>

	<para>在某些時候，可以簡單的將這些要使用的解析度以 <literal>Mode</literal>  加入到  Section "Screen"：</para>

	<programlisting xml:lang="en">Section "Screen"
Identifier "Screen0"
Device     "Card0"
Monitor    "Monitor0"
DefaultDepth 24
SubSection "Display"
	Viewport  0 0
	Depth     24
	Modes     "1680x1050"
EndSubSection
EndSection</programlisting>

	<para><application>Xorg</application> 能夠從寬螢幕設定取得解析度資訊 (透過 I2C/DDC)，因此能夠知道螢幕能處理的頻率及解析度。</para>

	<para>若驅動程式中不存在那些螢幕能處理的 <literal>ModeLines</literal>，則需要給 <application>Xorg</application> 一點提示。透過 <filename>/var/log/Xorg.0.log</filename> 可以取得足夠的資訊來手動建立可運作的 <literal>ModeLine</literal>。只需要在日誌檔中找到類似以下的訊息：</para>

	<programlisting xml:lang="en">(II) MGA(0): Supported additional Video Mode:
(II) MGA(0): clock: 146.2 MHz   Image Size:  433 x 271 mm
(II) MGA(0): h_active: 1680  h_sync: 1784  h_sync_end 1960 h_blank_end 2240 h_border: 0
(II) MGA(0): v_active: 1050  v_sync: 1053  v_sync_end 1059 v_blanking: 1089 v_border: 0
(II) MGA(0): Ranges: V min: 48  V max: 85 Hz, H min: 30  H max: 94 kHz, PixClock max 170 MHz</programlisting>

	<para>這些資訊稱作 EDID 資訊，使用 EDIT 資訊建立 <literal>ModeLine</literal> 只需要將數據使用正確的順序放入：</para>

	<programlisting xml:lang="en">ModeLine &lt;name&gt; &lt;clock&gt; &lt;4 horiz. timings&gt; &lt;4 vert. timings&gt;</programlisting>

	<para>將資訊放入之後，本例中 <literal>Section "Monitor"</literal> 中的 <literal>ModeLine</literal> 會看起來像這樣：</para>

	<programlisting xml:lang="en">Section "Monitor"
Identifier      "Monitor1"
VendorName      "Bigname"
ModelName       "BestModel"
ModeLine        "1680x1050" 146.2 1680 1784 1960 2240 1050 1053 1059 1089
Option          "DPMS"
EndSection</programlisting>

	<para>便完成編輯的步驟，接著需要在您的寬螢幕顯示器啟動 X。</para>
      </sect2>

      <sect2 xml:id="compiz-troubleshooting">
	<title>Compiz Fusion 疑難排解</title>

	<qandaset>
	  <qandaentry>
	    <question xml:id="no-decorations">
	      <para>我已經安裝了 <application>Compiz Fusion</application>，但在執行了您所提到的指令後，我的視窗的標題列與按鈕便消失了。是那裡有問題?</para>
	    </question>

	    <answer>
	      <para>您可能忘記在 <filename>/etc/X11/xorg.conf</filename> 中的設定。請重新檢查這個檔案，特別是 <literal>DefaultDepth</literal> 及 <literal>AddARGBGLXVisuals</literal> 指令項。</para>
	    </answer>
	  </qandaentry>

	  <qandaentry>
	    <question xml:id="xorg-crash">
	      <para>當我執行指令來啟動 <application>Compiz Fusion</application>，X 伺服器便當掉了，然後我又返回 Console。是那裡有問題?</para>
	    </question>

	    <answer>
	      <para>若您檢查 <filename>/var/log/Xorg.0.log</filename>，您可能可以找到當 X 啟動時所發生的錯誤訊息。最常發生的錯誤會是：</para>

	      <screen xml:lang="en">(EE) NVIDIA(0):     Failed to initialize the GLX module; please check in your X
(EE) NVIDIA(0):     log file that the GLX module has been loaded in your X
(EE) NVIDIA(0):     server, and that the module is the NVIDIA GLX module.  If
(EE) NVIDIA(0):     you continue to encounter problems, Please try
(EE) NVIDIA(0):     reinstalling the NVIDIA driver.</screen>

	    <para>會發生這個情形通常是因為您升級了 <application>Xorg</application>，您需要重新安裝 <package>x11/nvidia-driver</package> 套件來重新編譯 glx。</para>
	  </answer>
	</qandaentry>
      </qandaset>
    </sect2>
  </sect1>
</chapter>

  </part>

  <part xml:id="common-tasks">
    <title>一般作業</title>

    <partintro>
      <para>既然基礎的部分已經提過了，接下來的這個部分將會討論一些常會用到的 FreeBSD 的特色，這些章節包括：</para>

      <itemizedlist>
	<listitem>
	  <para>介紹給您常見且實用的桌面應用軟體：瀏覽器、辦工工具、文件閱覽程式等。</para>
	</listitem>

	<listitem>
	  <para>介紹給您眾多 FreeBSD 上可用的多媒體工具。</para>
	</listitem>

	<listitem>
	  <para>解釋如何編譯量身訂做的 FreeBSD 核心以增加額外系統功能的流程。</para>
	</listitem>

	<listitem>
	  <para>詳細描述列印系統，包含桌上型印表機及網路印表機的設定。</para>
	</listitem>

	<listitem>
	  <para>展示給您看如何在您的 FreeBSD 系統中執行 Linux 應用軟體。</para>
	</listitem>
      </itemizedlist>

      <para>這些章節中有些需要您預先閱讀些相關文件，在各章節開頭的概要內會提及。</para>
    </partintro>

    
<!--
     The FreeBSD Documentation Project
     $FreeBSD$
-->
<chapter version="5.0" xml:id="desktop">
  <!--
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Christophe</firstname>
	<surname>Juniet</surname>
	<contrib>Contributed by </contrib>
      </author>
    </authorgroup>
  </chapterinfo>
  -->

  <title>桌面應用程式</title>

  <sect1 xml:id="desktop-synopsis">
    <title>概述</title>

    <para>隨著 FreeBSD 優越的效能及穩定性越來越熱門，它同時適合作為每日使用的桌面系統。FreeBSD 套件或 Port 有超過 24,000 個可用的應用程式，可以簡單的建立一個自訂的桌面環境來執行各種不同的桌面應用程式。本章將示範如何安裝數個桌面應用程式，包含網頁瀏覽器、辦工軟體、文件閱覽程式以及財務軟體。</para>

    <note>
      <para>比起重頭設定與編譯，較偏好使用 FreeBSD 桌面環境已預先編譯好版本的使用者可參考 <link xlink:href="http://www.trueos.org/">trueos.org 網站</link>。</para>
    </note>

    <para>在閱讀這章之前，你必須了解如何：</para>

    <itemizedlist>
      <listitem>
	<para>使用套件或 Port 安裝其他軟體如 <xref linkend="ports"/> 所敘述。</para>
      </listitem>

      <listitem>
	<para>安狀 X 與視窗管理程式如 <xref linkend="x11"/> 所敘述。</para>
      </listitem>
    </itemizedlist>

    <para>要取得有關如何設定多媒體環境的資訊，請參考 <xref linkend="multimedia"/>。</para>
  </sect1>

  <sect1 xml:id="desktop-browsers">
    <title>瀏覽器</title>

    <indexterm xml:lang="en">
      <primary>browsers</primary>
      <secondary>web</secondary>
    </indexterm>

    <para>在 FreeBSD 中並未預先安裝好網頁瀏覽器。 但在 Port 套件集中的 <link xlink:href="https://www.FreeBSD.org/ports/www.html">www</link> 分類中有許多瀏覽器可以採 Binary 套件安裝或自 Port 套件集編譯的方式安裝。</para>

    <para><application>KDE</application> 和 <application>GNOME</application> 桌面環境都有提供自有的 HTML 瀏覽器。請參考 <xref linkend="x11-wm"/> 來了解更多有關如何設定完整桌面環境的資訊。</para>

    <para>有一些輕量化的瀏覽器可使用，包含 <package>www/dillo2</package>, <package>www/links</package> 以及 <package>www/w3m</package>。</para>

    <para>本章節將示範如何安裝下列常見的網頁瀏覽器並說明該應用程式是否需要用到大量資源、花費大量時間自 Port 編譯或何主要的相依套件。</para>

    <informaltable frame="none" pgwide="1">
      <tgroup cols="4">
	<thead>
	  <row>
	    <entry>應用程式名稱</entry>
	    <entry>所需資源</entry>
	    <entry>自 Port 安裝時間</entry>
	    <entry>說明</entry>
	  </row>
	</thead>

	<tbody>
	  <row>
	    <entry xml:lang="en"><application>Firefox</application></entry>
	    <entry>中</entry>
	    <entry>多</entry>
	    <entry>有 FreeBSD 、 <trademark class="registered">Linux</trademark> 及在地化版本</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>Opera</application></entry>
	    <entry>少</entry>
	    <entry>少</entry>
	    <entry>有 FreeBSD 、 <trademark class="registered">Linux</trademark> 版本</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>Konqueror</application></entry>
	    <entry>中</entry>
	    <entry>多</entry>
	    <entry>需要 <application>KDE</application> 程式庫</entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>Chromium</application></entry>
	    <entry>中</entry>
	    <entry>多</entry>
	    <entry>需要 <application>Gtk+</application> 程式庫</entry>
	  </row>
	</tbody>
      </tgroup>
    </informaltable>

    <sect2>
      <title xml:lang="en">Firefox</title>

      <indexterm xml:lang="en">
	<primary><application>Firefox</application></primary>
      </indexterm>

      <para><application>Firefox</application> 是一套開放源始碼的瀏覽器，它具備符合 HTML 標準的顯示引擎、頁籤瀏覽、彈出視窗封鎖、擴充套件、強化安全性及其他更多功能。<application>Firefox</application> 的基礎使用了 <application>Mozilla</application> 的程式庫。</para>

      <para>要安裝最新釋出版本的 <application>Firefox</application> 套件可輸入：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install firefox</userinput></screen>

      <para>要安裝延長支援發佈 (Extended Support Release, ESR) 版本的 <application>Firefox</application>，可使用：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install firefox-esr</userinput></screen>

      <para>在地化的版本可在 <package>www/firefox-i18n</package> 及 <package>www/firefox-esr-i18n</package> 取得。</para>

      <para>使用 Port 套件地可以用原始碼編譯成您想要的 <application>Firefox</application> 版本。此範例編譯 <package>www/firefox</package>，其中 <literal>firefox</literal> 可替換為 ESR 或在地化版本來安裝。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/www/firefox</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
    </sect2>

    <sect2>
      <title xml:lang="en">Opera</title>

      <indexterm xml:lang="en">
	<primary><application>Opera</application></primary>
      </indexterm>

      <para><application>Opera</application> 是個具備完整功能、符合標準且輕量、執行速度快的瀏覽器。 它同時也具備了內建的郵件、新聞閱讀器、IRC 客戶端、RSS/Atom 來源閱讀器等。 可用的版本有兩種原生的 FreeBSD 版本及 <trademark class="registered">Linux</trademark> 模擬模式下執行的版本。</para>

      <para>以下指令可安裝 FreeBSD Binary 套件版本的 Opera，替換 <literal>opera</literal> 為 <literal>linux-opera</literal> 則可改安裝 <trademark class="registered">Linux</trademark> 版本。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install opera</userinput></screen>

      <para>或者，可安裝 Port 套件集中的版本，以下範例會編譯原生的版本：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/www/opera</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>要安裝 <trademark class="registered">Linux</trademark> 則替換 <literal>opera</literal> 為 <literal>linux-opera</literal>。</para>

      <para>要安裝 <trademark class="registered">Adobe</trademark> <trademark class="registered">Flash</trademark> 附加元件，需先編譯 <package role="port">www/linux-flashplayer</package> Port，因受到授權條款限制無法事先編譯為 Binary 套件。然後再安裝 <package role="port">www/opera-linuxplugins</package>。以下範例示範如何編譯 Port 中的這兩個應用程式：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/www/linux-flashplayer</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput>
<prompt>#</prompt> <userinput>cd /usr/ports/www/opera-linuxplugins</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>安裝完成後，開啟瀏覽器檢查附加元件是否存在，在網址列輸入 <literal>opera:plugins</literal> 並按下 <keycap>Enter</keycap> 鍵，便會有清單顯示目前可用的附加元件。</para>

      <para>若要安裝 <application><trademark>Java</trademark></application> 附加元件請接著安裝 <package role="port">java/icedtea-web</package>。</para>
    </sect2>

    <sect2>
      <title xml:lang="en">Konqueror</title>

      <indexterm xml:lang="en">
	<primary><application>Konqueror</application></primary>
      </indexterm>

      <para><application>Konqueror</application> 不只是個網頁瀏覽器， 它同時也是檔案管理器和多媒體瀏覽器。它包含在 <package>x11/kde4-baseapps</package> 套件或 Port 中。</para>

      <para><application>Konqueror</application> 使用支援 WebKit 以及它自有的 KTHML。WebKit  是一套被許多現代瀏覽器所使用的繪圖引擎，包含 Chromium。要在 FreeBSD 的 <application>Konqueror</application> 使用 WebKit 需安裝 <package>www/kwebkitpart</package> 套件或 Port。此範例示範使用 Binary 套件安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install kwebkitpart</userinput></screen>

      <para>從 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/www/kwebkitpart</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>要啟動 <application>Konqueror</application> 中的 WebKit 點選 <quote>Settings</quote>、<quote>Configure Konqueror</quote>。在 <quote>General</quote> 設定頁面內點選 <quote>Default web browser engine</quote> 旁的下拉示選單並變更 <quote>KHTML</quote> 為 <quote>WebKit</quote>。</para>

      <para><application>Konqueror</application> 也支援 <application><trademark class="registered">Flash</trademark></application>，<quote>如何</quote>在 <application>Konqueror</application> 上安裝 <application><trademark class="registered">Flash</trademark></application> 的說明可參考 <uri xlink:href="http://freebsd.kde.org/howtos/konqueror-flash.php">http://freebsd.kde.org/howtos/konqueror-flash.php</uri>。</para>
    </sect2>

    <sect2>
      <title xml:lang="en">Chromium</title>

      <indexterm xml:lang="en">
	<primary><application>Chromium</application></primary>
      </indexterm>

      <para><application>Chromium</application> 是一個開放源始碼的瀏覽器計劃，該計劃的目標是要建立一個安全、快速且更穩定的網頁瀏覽體驗。<application>Chromium</application> 的功能有頁籤式瀏覽、彈出視窗封鎖、擴充套件等等。</para>

      <para><application>Chromium</application> 可以使用套件來安裝，只要輸入：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install chromium</userinput></screen>

      <para>或者可從 Port 套件集的原始碼編譯 <application>Chromium</application>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/www/chromium</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <note>
	<para><application>Chromium</application> 的執行檔為 <filename>/usr/local/bin/chrome</filename>，並非 <filename>/usr/local/bin/chromium</filename>。</para>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="desktop-productivity">
    <title>辦工工具</title>

    <para>當開始進行辦公，使用者通常會找好用的辦公軟體或是好上手的文書處理程式。 雖然有些 <link linkend="x11-wm">桌面環境</link> 像是 <application>KDE</application> 已經提供了辦公軟體，但並沒有預設的辦公軟體，FreeBSD 提供多套辦公軟體以及圖型化文書處理程式，不論您用那種的視窗管理程式都能使用。</para>

    <para>本章節元範如何安裝以下熱門的辦公軟體以及說明該應用程式所需的資源、自 Port 編譯的時間或者是否有其他主要相依套件。</para>

    <informaltable frame="none" pgwide="1">
      <tgroup cols="4">
	<thead>
	  <row>
	    <entry>應用程式名稱</entry>
	    <entry>所需資源</entry>
	    <entry>自 Port 安裝時間</entry>
	    <entry>主要相依套件</entry>
	  </row>
	</thead>

	<tbody>
	  <row>
	    <entry xml:lang="en"><application>Calligra</application></entry>
	    <entry>少</entry>
	    <entry>多</entry>
	    <entry xml:lang="en"><application>KDE</application></entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>AbiWord</application></entry>
	    <entry>少</entry>
	    <entry>少</entry>
	    <entry><application>Gtk+</application> 或 <application>GNOME</application></entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>The Gimp</application></entry>
	    <entry>少</entry>
	    <entry>多</entry>
	    <entry xml:lang="en"><application>Gtk+</application></entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>Apache
		OpenOffice</application></entry>
	    <entry>多</entry>
	    <entry>非常多</entry>
	    <entry><application><trademark>JDK</trademark></application> 及 <application>Mozilla</application></entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>LibreOffice</application></entry>
	    <entry>有點多</entry>
	    <entry>非常多</entry>
	    <entry><application>Gtk+</application> 或 <application>KDE</application>/ <application>GNOME</application> 或 <application><trademark>JDK</trademark></application></entry>
	  </row>
	</tbody>
      </tgroup>
    </informaltable>

    <sect2>
      <title xml:lang="en">Calligra</title>

      <indexterm xml:lang="en">
	<primary><application>Calligra</application></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>office suite</primary>
	<secondary><application>Calligra</application></secondary>
      </indexterm>

      <para>KDE 桌面環境中內含辦公軟體可以與 <application>KDE</application> 分開安裝。<application>Calligra</application> 中也有可在其他辦公軟體中找到的標準元件，如 <application>Words</application> 是文件處理程式、<application>Sheets</application> 是試算表程式、<application>Stage</application> 可管理投影片以及 <application>Karbon</application> 用來繪製圖型文件。</para>

      <para>在 FreeBSD 中 <package>editors/calligra</package> 可以使用套件或 Port 的方式安裝，要使用套件安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install calligra</userinput></screen>

      <para>若沒有可用的套件，可改使用 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/editors/calligra</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
    </sect2>

    <sect2>
      <title xml:lang="en">AbiWord</title>

      <indexterm xml:lang="en">
	<primary><application>AbiWord</application></primary>
      </indexterm>

      <para><application>AbiWord</application> 是一個免費的文件處理軟體，外觀和感覺都近似於 <application><trademark class="registered">Microsoft</trademark> Word</application>。 它非常快速，包含了許多功能而且非常容易上手。</para>

      <para><application>AbiWord</application> 可以輸入或輸出許多檔案格式， 包括一些有專用的格式，例如 <trademark class="registered">Microsoft</trademark> <filename>.rtf</filename> 格式。</para>

      <para>要安裝 <application>AbiWord</application> Binary 套件，可使用下列指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install abiword</userinput></screen>

      <para>若沒有 Binary 套件版本，也可以從 Port 套件集中編譯安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/editors/abiword</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
    </sect2>

    <sect2>
      <title>The GIMP</title>

      <indexterm xml:lang="en">
	<primary><application>The GIMP</application></primary>
      </indexterm>

      <para>對於影像的編輯及修改來說，<application>The GIMP</application> 是非常精緻的影像處理軟體。 它可以當作簡單的繪圖軟體或是高品質的相片處理軟體。 它支援為數眾多的外掛程式及指令稿 (script-fu) 介面。 <application>The GIMP</application> 可以讀寫許多檔案格式。 它也支援掃描器和手寫板。</para>

      <para>要安裝套件可：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install gimp</userinput></screen>

      <para>或使用 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/graphics/gimp</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>在 Port 套件集的 graphics 分類 (<link xlink:href="https://www.FreeBSD.org/ports/graphics.html">freebsd.org/ports/graphics.html</link>) 下也包含了許多 <application>GIMP</application> 相關的附加元件，說明檔及使用手冊。</para>

    </sect2>

    <sect2>
      <title xml:lang="en">Apache OpenOffice</title>

      <indexterm xml:lang="en">
	<primary>
	  <application>Apache OpenOffice</application>
	</primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>office suite</primary>
	<secondary>
	  <application>Apache OpenOffice</application>
	</secondary>
      </indexterm>

      <para><application>Apache OpenOffice</application> 是開放原始碼的辦工室軟體，由 Apache Software Foundation's Incubator 底下的團隊所開發。 它包含了所有完整的辦公軟體組合： 文字處理器、試算表、簡報軟體還有繪圖軟體。 除了它的使用者介面非常類似其他的辦公軟體， 他還能夠輸入和輸出許多熱門的檔案格式。 它也包含了不同語言的使用者介面、拼字檢查和字典。</para>

      <para><application>Apache OpenOffice</application> 的文字處理器使用原生的 XML 檔案格式來增加移植性及彈性。 試算表程式支援巨集 (Macro) 功能而且能夠使用外來的資料庫介面。 <application>Apache OpenOffice</application> 已經十分穩定， 並且能夠在 <trademark class="registered">Windows</trademark>, <trademark>Solaris</trademark>, <trademark class="registered">Linux</trademark>, FreeBSD 及 <trademark class="registered">Mac OS</trademark> X 等作業系統上面執行。 想知道更多關於 <application>Apache OpenOffice</application> 的資訊可以在 <link xlink:href="http://openoffice.org/">openoffice.org</link> 網頁上查詢。在 FreeBSD 特定的資訊可參考 <link xlink:href="http://porting.openoffice.org/freebsd/">porting.openoffice.org/freebsd/</link>。</para>

      <para>要安裝 <application>Apache OpenOffice</application> 套件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install apache-openoffice</userinput></screen>

      <para>當套件安裝完成之後，只要輸入下面的指令就能執行 <application>Apache OpenOffice</application>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>openoffice-<replaceable>X.Y.Z</replaceable></userinput></screen>

      <para>其中 <replaceable>X.Y.Z</replaceable> 是已安裝的 <application>Apache OpenOffice</application> 的版本編號。第一次執行 <application>Apache OpenOffice</application> 會詢問一些問題且會在使用者的家目錄建立一個 <filename>.openoffice.org</filename> 資料夾。</para>

      <para>若無法由套件取得想要的 <application>Apache OpenOffice</application>，仍可選擇從 Port 編譯。 不過必須注意：編譯的過程會需要大量的磁碟空間與時間：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/editors/openoffice-4</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <note>
	<para>如果想要編譯在地化的版本，將前面的指令替換成為：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make LOCALIZED_LANG=<replaceable>your_language</replaceable> install clean</userinput></screen>

	<para>替換 <replaceable>your_language</replaceable> 為正確的語言 ISO 編碼。支援的語言編碼清單在 <filename>files/Makefile.localized</filename>，位於該 Port 的目錄。</para>
      </note>
    </sect2>

    <sect2>
      <title xml:lang="en">LibreOffice</title>

      <indexterm xml:lang="en">
	<primary><application>LibreOffice</application></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>office suite</primary>
	<secondary><application>LibreOffice</application></secondary>
      </indexterm>

      <para><application>LibreOffice</application> 是一套自由的辦公軟體由 <link xlink:href="http://www.documentfoundation.org/">documentfoundation.org</link> 所開發。它可相容其他主流的辦公軟體以及可在各種平台上使用。它是 <application>Apache OpenOffice</application> 品牌重塑後的分支，含有可在完整辦公生產力軟體中找到的應用程式：文件處理程式、試算表、簡報管理程式、繪圖程式、資料庫管理程式以及建立與編輯數學公式的工具。它也支援數種語言與國際化一直延伸到介面、拼字檢查程式與字典。</para>

      <para><application>LibreOffice</application> 的文件處理程式使用了原生的 XML 檔案格式來增加可攜性與彈性，試算表程式支援可與外部資料庫連接的巨集語言。<application>LibreOffice</application> 非常穩定且可直接在 <trademark class="registered">Windows</trademark>, <trademark class="registered">Linux</trademark>, FreeBSD 以及 <trademark class="registered">Mac OS</trademark> X 上執行。更多有關 <application>LibreOffice</application> 的資訊可在 <link xlink:href="http://www.libreoffice.org/">libreoffice.org</link> 找到。</para>

      <para>要安裝英文版本的 <application>LibreOffice</application> 套件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install libreoffice</userinput></screen>

      <para>Port 套件集的編輯器分類 (<link xlink:href="https://www.FreeBSD.org/ports/editors.html">freebsd.org/ports/editors.html</link>) 中含有數個 <application>LibreOffice</application> 的語系。安裝在地化套件時，請替換 <literal>libreoffice</literal> 為在地化套件的名稱。</para>

      <para>套件安裝之後，輸入以下指令來執行 <application>LibreOffice</application>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>libreoffice</userinput></screen>

      <para>第一次啟動的過程中會詢問一些問題並在使用者的家目錄建立 <filename>.libreoffice</filename> 資料夾。</para>

      <para>若找不到想使用的 <application>LibreOffice</application> 套件，也可從 Port 編譯，但這會要大量的磁碟空間及漫長的時間編譯。以下例子示範編譯英文版本：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/editors/libreoffice</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <note>
	<para>要編譯在地化版本，則需 <command>cd</command> 進入想要的語言 Port 目錄。支援的語言可在 Port 套件集的編輯器分類 (<link xlink:href="https://www.FreeBSD.org/ports/editors.html">freebsd.org/ports/editors.html</link>) 中找到。</para>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="desktop-viewers">
    <title>文件閱覽程式</title>

    <para><trademark class="registered">UNIX</trademark> 出現之後，有一些新的文件格式才越來越熱門，這些文件所需的檢視程式可能並不在基礎系統中。本節將示範如何安裝以下文件檢視程式：</para>

    <informaltable frame="none" pgwide="1">
      <tgroup cols="4">
	<thead>
	  <row>
	    <entry>應用程式名稱</entry>
	    <entry>所需資源</entry>
	    <entry>自 Port 安裝時間</entry>
	    <entry>主要相依套件</entry>
	  </row>
	</thead>

	<tbody>
	  <row>
	    <entry xml:lang="en"><application>Xpdf</application></entry>
	    <entry>少</entry>
	    <entry>少</entry>
	    <entry xml:lang="en"><application>FreeType</application></entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>gv</application></entry>
	    <entry>少</entry>
	    <entry>少</entry>
	    <entry xml:lang="en"><application>Xaw3d</application></entry>
	  </row>

	  <row>
	    <entry><application>Geeqie</application></entry>
	    <entry>少</entry>
	    <entry>少</entry>
	    <entry><application>Gtk+</application> 或 <application>GNOME</application></entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>ePDFView</application></entry>
	    <entry>少</entry>
	    <entry>少</entry>
	    <entry xml:lang="en"><application>Gtk+</application></entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>Okular</application></entry>
	    <entry>少</entry>
	    <entry>多</entry>
	    <entry xml:lang="en"><application>KDE</application></entry>
	  </row>
	</tbody>
      </tgroup>
    </informaltable>

    <sect2>
      <title xml:lang="en">Xpdf</title>

      <indexterm xml:lang="en">
	<primary><application>Xpdf</application></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>PDF</primary>
	<secondary>viewing</secondary>
      </indexterm>

      <para>如果你想要一個小型的 FreeBSD PDF 閱覽軟體， <application>Xpdf</application> 是個輕量級而且有效率的閱覽器。 它只需要非常少的資源而且十分穩定。 它只使用標準的 X 字型且不需要額外的工具包(Toolkit)。</para>

      <para>安裝 <application>Xpdf</application> 套件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install xpdf</userinput></screen>

      <para>若沒有可用的套件版本，可使用 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/graphics/xpdf</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>完成安裝後，執行 <command>xpdf</command> 並使用滑鼠右鍵開啟選單。</para>
    </sect2>

    <sect2>
      <title xml:lang="en"><application>gv</application></title>

      <indexterm xml:lang="en">
	<primary><application>gv</application></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>PDF</primary>
	<secondary>viewing</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>PostScript</primary>
	<secondary>viewing</secondary>
      </indexterm>

      <para><application>gv</application> 是 <trademark class="registered">PostScript</trademark> 和 PDF 的閱覽器。 它建構於 <application>ghostview</application> 的基礎上，不過因為使用 <application>Xaw3d</application> 視窗元件工具包，所以外觀看起來比較漂亮。 <application>gv</application> 有許多可設定的功能，比如說紙張方向、紙張大小、縮放比例、和反鋸齒(Anti-aliasing)等。 而且幾乎所有的使用都可以從鍵盤或滑鼠來完成。</para>

      <para>安裝 <application>gv</application> 套件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install gv</userinput></screen>

      <para>若沒有可用的套件版本，可使用 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/print/gv</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
    </sect2>

    <sect2>
      <title xml:lang="en">Geeqie</title>

      <indexterm><primary><application>Geeqie</application></primary></indexterm>

      <para><application>Geeqie</application> 是由已經停止維護的 <application>GQView</application> 專案所衍伸出來的分支，並致力開發新功能並整合已有的修補。<application>Geeqie</application> 是一套影像管理軟體，支援單鍵閱覽檔案、啟動外部編輯器、縮圖預覽等功能。 它也有幻燈片模式及一些基本的檔案操作的功能，能輕鬆的管理大量影像並找出重複的檔案。 <application>Geeqie</application> 也支援使用全螢幕閱覽以及國際化。</para>

      <para>安裝 <application>Geeqie</application> 套件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install geeqie</userinput></screen>

      <para>若沒有可用的套件版本，可使用 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/graphics/geeqie</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
    </sect2>

    <sect2>
      <title xml:lang="en">ePDFView</title>

      <indexterm xml:lang="en">
	<primary><application>ePDFView</application></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>PDF</primary>
	<secondary>viewing</secondary>
      </indexterm>

      <para><application>ePDFView</application> 是一套小巧的 <acronym>PDF</acronym> 文件檢視程式，只使用了 <application>Gtk+</application> 與 <application>Poppler</application> 程式庫。它目前還在開發當中，但已經可以開啟大部份 <acronym>PDF</acronym> 檔案 (甚至是加密過的)、儲存文件複本以及支援使用 <application>CUPS</application> 來列印。</para>

      <para>要以套件安裝 <application>ePDFView</application>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install epdfview</userinput></screen>

      <para>若沒有可用的套件版本，可使用 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/graphics/epdfview</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
    </sect2>

    <sect2>
      <title xml:lang="en">Okular</title>

      <indexterm xml:lang="en">
	<primary><application>Okular</application></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><acronym>PDF</acronym></primary>
	<secondary>viewing</secondary>
      </indexterm>

      <para><application>Okular</application> 是一套通用的文件檢視程式，以 <application>KDE</application> 的 <application>KPDF</application> 為基礎。它可以開啟許多種文件格式，包含了 <acronym>PDF</acronym>, <trademark class="registered">PostScript</trademark>, DjVu, <acronym>CHM</acronym>, <acronym>XPS</acronym> 以及 ePub。</para>

      <para>要以套件安裝 <application>Okular</application>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install okular</userinput></screen>

      <para>若沒有可用的套件版本，可使用 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/graphics/okular</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
    </sect2>
  </sect1>

  <sect1 xml:id="desktop-finance">
    <title>財務</title>

    <para>如果有任何理由你想要在你的 FreeBSD 桌面環境上管理你的個人財務， 這裡有一些功能強大、使用簡單的應用程式可供安裝。 這些財務管理軟體之中有些是相容於流行的 <application>Quicken</application> 或 <application>Excel</application> 文件。</para>

    <para>這節涵蓋了下面這些軟體：</para>

    <informaltable frame="none" pgwide="1">
      <tgroup cols="4">
	<thead>
	  <row>
	    <entry>應用程式名稱</entry>
	    <entry>所需資源</entry>
	    <entry>自 Port 安裝時間</entry>
	    <entry>主要相依套件</entry>
	  </row>
	</thead>

	<tbody>
	  <row>
	    <entry xml:lang="en"><application>GnuCash</application></entry>
	    <entry>少</entry>
	    <entry>多</entry>
	    <entry xml:lang="en"><application>GNOME</application></entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>Gnumeric</application></entry>
	    <entry>少</entry>
	    <entry>多</entry>
	    <entry xml:lang="en"><application>GNOME</application></entry>
	  </row>

	  <row>
	    <entry xml:lang="en"><application>KMyMoney</application></entry>
	    <entry>少</entry>
	    <entry>多</entry>
	    <entry xml:lang="en"><application>KDE</application></entry>
	  </row>
	</tbody>
      </tgroup>
    </informaltable>

    <sect2>
      <title xml:lang="en">GnuCash</title>

      <indexterm xml:lang="en">
	<primary><application>GnuCash</application></primary>
      </indexterm>

      <para><application>GnuCash</application> 是 <application>GNOME</application> 團隊努力成果中的一部分， <application>GNOME</application> 團隊主要提供親切而強大的桌面應用程式給終端使用者。使用 <application>GnuCash</application> 可以持續追蹤收入與花費、銀行帳戶以及股票證券等。 它的特性是介面直覺但功能仍非常專業。</para>

      <para><application>GnuCash</application> 提供了智慧的計數器、多階層帳戶系統以及快速鍵及自動完成功能。 它也能分開單一的報表至數個詳細的部份。 <application>GnuCash</application> 也能夠匯入及合併 <application>Quicken</application> QIF 檔案。 它也能處理大部分國際的日期及通用貨幣之格式。</para>

      <para>安裝 <application>GnuCash</application> 套件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install gnucash</userinput></screen>

      <para>若沒有可用的套件版本，可使用 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/finance/gnucash</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
    </sect2>

    <sect2>
      <title xml:lang="en">Gnumeric</title>

      <indexterm xml:lang="en">
	<primary><application>Gnumeric</application></primary>
      </indexterm>
      <indexterm><primary>試算表</primary> <secondary><application>Gnumeric</application></secondary></indexterm>

      <para><application>Gnumeric</application> 是 <application>GNOME</application> 社群所開發的試算表程式。 它的特點是擁有能夠根據儲存格格式 「猜出」使用者的輸入來自動補齊的系統。 它也能夠匯入許多熱門的檔案格式，像是 <application>Excel</application>, <application>Lotus 1-2-3</application> 以及 <application>Quattro Pro</application>。 它有大量內建的函數而且能夠使用常用的儲存格格式，像是：數字、貨幣、日期、時間及其他格式等。</para>

      <para>安裝 <application>Gnumeric</application> 套件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install gnumeric</userinput></screen>

      <para>若沒有可用的套件版本，可使用 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/math/gnumeric</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
    </sect2>

    <sect2>
      <title xml:lang="en">KMyMoney</title>

      <indexterm xml:lang="en"><primary><application>KMyMoney</application></primary></indexterm>

      <indexterm><primary>試算表</primary> <secondary><application>KMyMoney</application></secondary></indexterm>

      <para><application>KMyMoney</application> 是一套個人財務應用程式，由 <application>KDE</application> 社群所開發。<application>KMyMoney</application> 的目標是提供可在商業個人財務管理應用程式中找到的重要功能，它也強調簡單易用及其功能間採用合適的複式記帳。<application>KMyMoney</application> 可從標準 <application>Quicken</application> QIF 檔案匯入資料、追蹤投資、處理多種貨幣並提供財務報表。</para>

      <para>要以套件安裝 <application>KMyMoney</application>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install kmymoney-kde4</userinput></screen>

      <para>若沒有可用的套件版本，可使用 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/finance/kmymoney-kde4</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="multimedia">

  <info>
    <title>多媒體</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Ross</firstname>
	  <surname>Lippert</surname>
	</personname>
	<contrib>Edited by </contrib>
      </author>
    </authorgroup>
  </info>

  <sect1 xml:id="multimedia-synopsis">
    <title>概述</title>

    <para>FreeBSD 廣泛地支援各種音效卡， 讓使用者可以享受來自電腦上的高傳真音質(Hi-Fi)， 此外還包括了錄製和播放 MPEG Audio Layer 3 (<acronym>MP3</acronym>)、 Waveform Audio File (<acronym>WAV</acronym>)、Ogg Vorbis 以及其他許多種格式聲音的能力。同時 FreeBSD Port 套件集也包含了許多可讓您可以錄音、編修音效以及控制 MIDI 配備的應用程式。</para>

    <para>FreeBSD 也能播放一般的視訊檔和 <acronym>DVD</acronym>。 FreeBSD Port 套件集中含有可編碼、轉換以及播放格種影像媒體的應用程式。</para>

    <para>本章會說明如何設定 FreeBSD 上的音效卡、影像播放器、電視卡及掃描器。同時會說明有那些應用程式可以使用這些裝置。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>設定 FreeBSD 上的音效卡。</para>
      </listitem>

      <listitem>
	<para>音效設定疑難排解。</para>
      </listitem>

      <listitem>
	<para>播放、錄製 MP3 及其他聲音檔案格式。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 系統播放影像的準備工具。</para>
      </listitem>

      <listitem>
	<para>播放 <acronym>DVD</acronym> 的 <filename>.mpg</filename> 及 <filename>.avi</filename> 檔。</para>
      </listitem>

      <listitem>
	<para>擷取(Rip) <acronym>CD</acronym> 和 <acronym>DVD</acronym>的內容至檔案。</para>
      </listitem>

      <listitem>
	<para>設定電視卡。</para>
      </listitem>

      <listitem>
	<para>在 FreeBSD 安裝 MythTV</para>
      </listitem>

      <listitem>
	<para>設定影像掃描機。</para>
      </listitem>

      <listitem>
	<para>設定藍芽耳機。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem><para>知道如何安裝應用程式如 <xref linkend="ports"/> 所敘述。</para></listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="sound-setup">
    <info>
      <title>設定音效卡</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Moses</firstname>
	    <surname>Moore</surname>
	  </personname>
	  <contrib>Contributed by </contrib> <!-- in November 2000-->
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Fonvieille</surname>
	  </personname>
	  <contrib>Enhanced by </contrib> <!--in September 2004-->
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en"><primary>PCI</primary></indexterm>
    <indexterm xml:lang="en"><primary>sound cards</primary></indexterm>
    <para>開始設定之前，必須先知道你的音效卡型號、晶片為何。 FreeBSD 支援許多種音效卡，請檢查支援的音效硬體表 <link xlink:href="https://www.FreeBSD.org/releases/12.0R/hardware.html">Hardware Notes</link>，以確認你的音效卡是否支援以及如何在 FreeBSD 上驅動。</para>

    <indexterm xml:lang="en">
      <primary>kernel</primary>
      <secondary>configuration</secondary>
    </indexterm>

    <para>要使用音效裝置，必須要載入正確的驅動程式才行。最簡單方式就是以 <citerefentry><refentrytitle>kldload</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來載入核心模組。以下範例示範載入 Intel 規格內建的音效晶片驅動程式：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload snd_hda</userinput></screen>

    <para>要開機時自動載入驅動程式，需將驅動程式加到 <filename>/boot/loader.conf</filename> 檔，以此驅動程式為例：</para>

    <programlisting xml:lang="en">snd_hda_load="YES"</programlisting>

    <para>其他可用的音效卡模組清單列於 <filename>/boot/defaults/loader.conf</filename>。當不確認要使用何種驅動程式時，可載入 <filename>snd_driver</filename> 模組：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload snd_driver</userinput></screen>

    <para>它是 metadriver 會載入所有最通用的音效驅動程式並且用來加速尋找正確的驅動程式。也可以把 metadriver 加入 <filename>/boot/loader.conf</filename> 檔來載入所有音效驅動程式。</para>

    <para>要知道載入 <filename>snd_driver</filename> metadriver 後使用了那個音效卡驅動程式，請輸入 <command>cat /dev/sndstat</command>。</para>

    <sect2>
      <title>設定自訂核心支援音效</title>

      <para xml:lang="en">This section is for users who prefer to statically compile
	in support for the sound card in a custom kernel.  For more
	information about recompiling a kernel, refer to <xref linkend="kernelconfig"/>.</para>

      <para xml:lang="en">When using a custom kernel to provide sound support, make
	sure that the audio framework driver exists in the custom
	kernel configuration file:</para>

      <programlisting xml:lang="en">device sound</programlisting>

      <para xml:lang="en">Next, add support for the sound card.  To continue the
	example of the built-in audio chipset based on the Intel
	specification from the previous section, use the following
	line in the custom kernel configuration file:</para>

      <programlisting xml:lang="en">device snd_hda</programlisting>

      <para xml:lang="en">Be sure to read the manual page of the driver for the
	device name to use for the driver.</para>

      <para xml:lang="en">Non-PnP ISA sound cards may require the IRQ and I/O port
	settings of the card to be added to
	<filename>/boot/device.hints</filename>.  During the boot
	process, <citerefentry><refentrytitle>loader</refentrytitle><manvolnum>8</manvolnum></citerefentry> reads this file and passes the
	settings to the kernel.  For example, an old Creative
	<trademark class="registered">SoundBlaster</trademark> 16 ISA non-PnP card will use the
	<citerefentry><refentrytitle>snd_sbc</refentrytitle><manvolnum>4</manvolnum></citerefentry> driver in conjunction with
	<literal>snd_sb16</literal>.  For this card, the following
	lines must be added to the kernel configuration file:</para>

      <programlisting xml:lang="en">device snd_sbc
device snd_sb16</programlisting>

      <para xml:lang="en">If the card uses the <literal>0x220</literal> I/O port and
	IRQ <literal>5</literal>, these lines must also be added to
	<filename>/boot/device.hints</filename>:</para>

      <programlisting xml:lang="en">hint.sbc.0.at="isa"
hint.sbc.0.port="0x220"
hint.sbc.0.irq="5"
hint.sbc.0.drq="1"
hint.sbc.0.flags="0x15"</programlisting>

      <para xml:lang="en">The syntax used in <filename>/boot/device.hints</filename>
	is described in <citerefentry><refentrytitle>sound</refentrytitle><manvolnum>4</manvolnum></citerefentry> and the manual page for the
	driver of the sound card.</para>

      <para xml:lang="en">The settings shown above are the defaults.  In some
	cases, the IRQ or other settings may need to be changed to
	match the card.  Refer to <citerefentry><refentrytitle>snd_sbc</refentrytitle><manvolnum>4</manvolnum></citerefentry> for more information
	about this card.</para>
    </sect2>

    <sect2 xml:id="sound-testing">
      <title>測試音效</title>

      <para xml:lang="en">After loading the required module or rebooting into the
	custom kernel, the sound card should be detected.  To confirm,
	run <command>dmesg | grep pcm</command>.  This example is
	from a system with a built-in Conexant CX20590 chipset:</para>

      <screen xml:lang="en">pcm0: &lt;NVIDIA (0x001c) (HDMI/DP 8ch)&gt; at nid 5 on hdaa0
pcm1: &lt;NVIDIA (0x001c) (HDMI/DP 8ch)&gt; at nid 6 on hdaa0
pcm2: &lt;Conexant CX20590 (Analog 2.0+HP/2.0)&gt; at nid 31,25 and 35,27 on hdaa1</screen>

      <para xml:lang="en">The status of the sound card may also be checked using
	this command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cat /dev/sndstat</userinput>
FreeBSD Audio Driver (newpcm: 64bit 2009061500/amd64)
Installed devices:
pcm0: &lt;NVIDIA (0x001c) (HDMI/DP 8ch)&gt; (play)
pcm1: &lt;NVIDIA (0x001c) (HDMI/DP 8ch)&gt; (play)
pcm2: &lt;Conexant CX20590 (Analog 2.0+HP/2.0)&gt; (play/rec) default</screen>

      <para xml:lang="en">The output will vary depending upon the sound card.  If no
	<filename>pcm</filename> devices are listed, double-check
	that the correct device driver was loaded or compiled into the
	kernel.  The next section lists some common problems and their
	solutions.</para>

      <para xml:lang="en">If all goes well, the sound card should now work in FreeBSD.
	If the <acronym>CD</acronym> or <acronym>DVD</acronym> drive
	is properly connected to the sound card, one can insert an
	audio <acronym>CD</acronym> in the drive and play it with
	<citerefentry><refentrytitle>cdcontrol</refentrytitle><manvolnum>1</manvolnum></citerefentry>:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>cdcontrol -f /dev/acd0 play 1</userinput></screen>

      <warning>
	<para xml:lang="en">Audio <acronym>CD</acronym>s have specialized encodings
	  which means that they should not be mounted using
	  <citerefentry><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
      </warning>

      <para xml:lang="en">Various applications, such as
	<package>audio/workman</package>, provide a friendlier
	interface.  The <package>audio/mpg123</package> port can be
	installed to listen to MP3 audio files.</para>

      <para xml:lang="en">Another quick way to test the card is to send data to
	<filename>/dev/dsp</filename>:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>cat <replaceable>filename</replaceable> &gt; /dev/dsp</userinput></screen>

      <para xml:lang="en">where
	<filename><replaceable>filename</replaceable></filename> can
	be any type of file.  This command should produce some noise,
	confirming that the sound card is working.</para>

      <note>
	<para xml:lang="en">The <filename>/dev/dsp*</filename> device nodes will
	  be created automatically as needed.  When not in use, they
	  do not exist and will not appear in the output of
	  <citerefentry><refentrytitle>ls</refentrytitle><manvolnum>1</manvolnum></citerefentry>.</para>
      </note>
    </sect2>

    <sect2 xml:id="bluetooth-headset">
      <title>設定藍芽音效裝置</title>

      <indexterm><primary>藍牙音訊</primary></indexterm>

      <para xml:lang="en">Connecting to a Bluetooth device is out of scope for this
	chapter.  Refer to <xref linkend="network-bluetooth"/> for more information.</para>

      <para xml:lang="en">To get Bluetooth sound sink working with FreeBSD's sound
	system, users have to install
	<package>audio/virtual_oss</package> first:</para>

      <screen><prompt>#</prompt> <userinput>pkg install virtual_oss</userinput></screen>

      <para xml:lang="en"><package>audio/virtual_oss</package> requires
	<literal>cuse</literal> to be loaded into the kernel:</para>

      <screen><prompt>#</prompt> <userinput>kldload cuse</userinput></screen>

      <para xml:lang="en">To load <literal>cuse</literal> during system startup, run
	this command:</para>

      <screen><prompt>#</prompt> <userinput>sysrc -f /boot/loader.conf cuse_load=yes</userinput></screen>

      <para xml:lang="en">To use headphones as a sound sink with
	<package>audio/virtual_oss</package>, users need to create a
	virtual device after connecting to a Bluetooth audio
	device:</para>

      <screen><prompt>#</prompt> <userinput>virtual_oss -C 2 -c 2 -r 48000 -b 16 -s 768 -R /dev/null -P /dev/bluetooth/<replaceable>headphones</replaceable> -d dsp</userinput></screen>

      <note>
	<para xml:lang="en"><replaceable>headphones</replaceable> in this example is
	  a hostname from <filename>/etc/bluetooth/hosts</filename>.
	  <literal>BT_ADDR</literal> could be used instead.</para>
      </note>

      <para>請參考 <citerefentry vendor="ports"><refentrytitle>virtual_oss</refentrytitle><manvolnum>8</manvolnum></citerefentry> 取得更多資訊。</para>
    </sect2>

    <sect2 xml:id="troubleshooting">
      <title>疑難排解音效</title>

      <indexterm xml:lang="en"><primary>device nodes</primary></indexterm>
      <indexterm xml:lang="en"><primary>I/O port</primary></indexterm>
      <indexterm xml:lang="en"><primary>IRQ</primary></indexterm>
      <indexterm xml:lang="en"><primary>DSP</primary></indexterm>

      <para xml:lang="en"><xref linkend="multimedia-sound-common-error-messages"/>
	lists some common error messages and their solutions:</para>

      <table xml:id="multimedia-sound-common-error-messages" frame="none" pgwide="1">
	<title>常見錯誤訊息</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>錯誤</entry>
	      <entry>解決方式</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><errorname>sb_dspwr(XX) timed
		  out</errorname></entry>
	      <entry><para xml:lang="en">The I/O port is not set
		correctly.</para></entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><errorname>bad irq XX</errorname></entry>
	      <entry><para xml:lang="en">The IRQ is set incorrectly.  Make sure
		that the set IRQ and the sound IRQ are the
		same.</para></entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><errorname>xxx: gus pcm not attached, out of
		  memory</errorname></entry>
	      <entry><para xml:lang="en">There is not enough available memory to
		use the device.</para></entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><errorname>xxx: can't open
		  /dev/dsp!</errorname></entry>
	      <entry><para xml:lang="en">Type <command>fstat | grep
		  dsp</command> to check if another application is
		holding the device open.  Noteworthy troublemakers are
		<application>esound</application> and
		<application>KDE</application>'s sound
		support.</para></entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para xml:lang="en">Modern graphics cards often come with their own sound
	driver for use with <acronym>HDMI</acronym>.  This sound
	device is sometimes enumerated before the sound card meaning
	that the sound card will not be used as the default playback
	device.  To check if this is the case, run
	<application>dmesg</application> and look for
	<literal>pcm</literal>.  The output looks something like
	this:</para>

      <programlisting xml:lang="en">...
hdac0: HDA Driver Revision: 20100226_0142
hdac1: HDA Driver Revision: 20100226_0142
hdac0: HDA Codec #0: NVidia (Unknown)
hdac0: HDA Codec #1: NVidia (Unknown)
hdac0: HDA Codec #2: NVidia (Unknown)
hdac0: HDA Codec #3: NVidia (Unknown)
pcm0: &lt;HDA NVidia (Unknown) PCM #0 DisplayPort&gt; at cad 0 nid 1 on hdac0
pcm1: &lt;HDA NVidia (Unknown) PCM #0 DisplayPort&gt; at cad 1 nid 1 on hdac0
pcm2: &lt;HDA NVidia (Unknown) PCM #0 DisplayPort&gt; at cad 2 nid 1 on hdac0
pcm3: &lt;HDA NVidia (Unknown) PCM #0 DisplayPort&gt; at cad 3 nid 1 on hdac0
hdac1: HDA Codec #2: Realtek ALC889
pcm4: &lt;HDA Realtek ALC889 PCM #0 Analog&gt; at cad 2 nid 1 on hdac1
pcm5: &lt;HDA Realtek ALC889 PCM #1 Analog&gt; at cad 2 nid 1 on hdac1
pcm6: &lt;HDA Realtek ALC889 PCM #2 Digital&gt; at cad 2 nid 1 on hdac1
pcm7: &lt;HDA Realtek ALC889 PCM #3 Digital&gt; at cad 2 nid 1 on hdac1
...</programlisting>

      <para xml:lang="en">In this example, the graphics card
	(<literal>NVidia</literal>) has been enumerated before the
	sound card (<literal>Realtek ALC889</literal>).  To use the
	sound card as the default playback device, change
	<varname>hw.snd.default_unit</varname> to the unit that should
	be used for playback:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl hw.snd.default_unit=<replaceable>n</replaceable></userinput></screen>

      <para xml:lang="en">where <literal>n</literal> is the number of the sound
	device to use.  In this example, it should be
	<literal>4</literal>.  Make this change permanent by adding
	the following line to
	<filename>/etc/sysctl.conf</filename>:</para>

      <programlisting xml:lang="en">hw.snd.default_unit=<replaceable>4</replaceable></programlisting>
    </sect2>

    <sect2 xml:id="sound-multiple-sources">
      <info>
	<title>使用多個音效來源</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Munish</firstname>
	      <surname>Chopra</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para xml:lang="en">It is often desirable to have multiple sources of sound
	that are able to play simultaneously.  FreeBSD uses
	<quote>Virtual Sound Channels</quote> to multiplex the sound
	card's playback by mixing sound in the kernel.</para>

      <para xml:lang="en">Three <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> knobs are available for configuring
	virtual channels:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl dev.pcm.0.play.vchans=4</userinput>
<prompt>#</prompt> <userinput>sysctl dev.pcm.0.rec.vchans=4</userinput>
<prompt>#</prompt> <userinput>sysctl hw.snd.maxautovchans=4</userinput></screen>

      <para xml:lang="en">This example allocates four virtual channels, which is a
	practical number for everyday use.  Both
	<varname>dev.pcm.0.play.vchans=4</varname> and
	<varname>dev.pcm.0.rec.vchans=4</varname> are configurable
	after a device has been attached and represent the number of
	virtual channels <filename>pcm0</filename> has for playback
	and recording.  Since the <filename>pcm</filename> module can
	be loaded independently of the hardware drivers,
	<varname>hw.snd.maxautovchans</varname> indicates how many
	virtual channels will be given to an audio device when it is
	attached.  Refer to <citerefentry><refentrytitle>pcm</refentrytitle><manvolnum>4</manvolnum></citerefentry> for more information.</para>

      <note>
	<para xml:lang="en">The number of virtual channels for a device cannot be
	  changed while it is in use.  First, close any programs using
	  the device, such as music players or sound daemons.</para>
      </note>

      <para xml:lang="en">The correct <filename>pcm</filename> device will
	automatically be allocated transparently to a program that
	requests <filename>/dev/dsp0</filename>.</para>
    </sect2>

    <sect2>
      <info>
	<title>設定混音器頻道的預設值</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Josef</firstname>
	      <surname>El-Rayes</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para xml:lang="en">The default values for the different mixer channels are
	hardcoded in the source code of the <citerefentry><refentrytitle>pcm</refentrytitle><manvolnum>4</manvolnum></citerefentry> driver.  While
	sound card mixer levels can be changed using <citerefentry><refentrytitle>mixer</refentrytitle><manvolnum>8</manvolnum></citerefentry> or
	third-party applications and daemons, this is not a permanent
	solution.  To instead set default mixer values at the driver
	level, define the appropriate values in
	<filename>/boot/device.hints</filename>, as seen in this
	example:</para>

      <programlisting xml:lang="en">hint.pcm.0.vol="50"</programlisting>

      <para xml:lang="en">This will set the volume channel to a default value of
	<literal>50</literal> when the <citerefentry><refentrytitle>pcm</refentrytitle><manvolnum>4</manvolnum></citerefentry> module is
	loaded.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="sound-mp3">
    <info>
      <title>MP3 音樂</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Chern</firstname>
	    <surname>Lee</surname>
	  </personname>
	  <contrib>Contributed by </contrib> <!--in Sept 2001-->
	</author>
      </authorgroup>
    </info>

    <para xml:lang="en">This section describes some <acronym>MP3</acronym>
      players available for FreeBSD, how to rip audio
      <acronym>CD</acronym> tracks, and how to encode and decode
      <acronym>MP3</acronym>s.</para>

    <sect2 xml:id="mp3-players">
      <title>MP3 播放器</title>

      <para xml:lang="en">A popular graphical <acronym>MP3</acronym> player is
	<application>Audacious</application>.  It supports
	<application>Winamp</application> skins and additional
	plugins.  The interface is intuitive, with a playlist, graphic
	equalizer, and more.  Those familiar with
	<application>Winamp</application> will find
	<application>Audacious</application> simple to use.  On FreeBSD,
	<application>Audacious</application> can be installed from the
	<package>multimedia/audacious</package> port or package.
	Audacious is a descendant of XMMS.</para>

      <para xml:lang="en">The <package>audio/mpg123</package> package or port
	provides an alternative, command-line <acronym>MP3</acronym>
	player.  Once installed, specify the <acronym>MP3</acronym>
	file to play on the command line.  If the system has multiple
	audio devices, the sound device can also be specified:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mpg123 <replaceable>-a /dev/dsp1.0 Foobar-GreatestHits.mp3</replaceable></userinput>
High Performance MPEG 1.0/2.0/2.5 Audio Player for Layers 1, 2 and 3
        version 1.18.1; written and copyright by Michael Hipp and others
        free software (LGPL) without any warranty but with best wishes

Playing MPEG stream from Foobar-GreatestHits.mp3 ...
MPEG 1.0 layer III, 128 kbit/s, 44100 Hz joint-stereo</screen>

      <para xml:lang="en">Additional <acronym>MP3</acronym> players are available in
	the FreeBSD Ports Collection.</para>
    </sect2>

    <sect2 xml:id="rip-cd">
      <title>擷取 <acronym>CD</acronym> 音軌</title>

      <para xml:lang="en">Before encoding a <acronym>CD</acronym> or
	<acronym>CD</acronym> track to <acronym>MP3</acronym>, the
	audio data on the <acronym>CD</acronym> must be ripped to the
	hard drive.  This is done by copying the raw
	<acronym>CD</acronym> Digital Audio (<acronym>CDDA</acronym>)
	data to <acronym>WAV</acronym> files.</para>

      <para xml:lang="en">The <command>cdda2wav</command> tool, which is installed
	with the <package>sysutils/cdrtools</package> suite, can be
	used to rip audio information from
	<acronym>CD</acronym>s.</para>

      <para xml:lang="en">With the audio <acronym>CD</acronym> in the drive, the
	following command can be issued as
	<systemitem class="username">root</systemitem> to rip an
	entire <acronym>CD</acronym> into individual, per track,
	<acronym>WAV</acronym> files:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cdda2wav -D <replaceable>0,1,0</replaceable> -B</userinput></screen>

      <para xml:lang="en">In this example, the
	<option>-D <replaceable>0,1,0</replaceable></option> indicates
	the <acronym>SCSI</acronym> device <filename>0,1,0</filename>
	containing the <acronym>CD</acronym> to rip.  Use
	<command>cdrecord -scanbus</command> to determine the correct
	device parameters for the system.</para>

      <para xml:lang="en">To rip individual tracks, use <option>-t</option> to
	specify the track:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cdda2wav -D <replaceable>0,1,0</replaceable> -t 7</userinput></screen>

      <para xml:lang="en">To rip a range of tracks, such as track one to seven,
	specify a range:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cdda2wav -D <replaceable>0,1,0</replaceable> -t 1+7</userinput></screen>

      <para xml:lang="en">To rip from an <acronym>ATAPI</acronym>
	(<acronym>IDE</acronym>) <acronym>CDROM</acronym> drive,
	specify the device name in place of the
	<acronym>SCSI</acronym> unit numbers.  For example, to rip
	track 7 from an IDE drive:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cdda2wav -D <replaceable>/dev/acd0 -t 7</replaceable></userinput></screen>

      <para xml:lang="en">Alternately, <command>dd</command> can be used to extract
	audio tracks on <acronym>ATAPI</acronym> drives, as described
	in <xref linkend="duplicating-audiocds"/>.</para>
    </sect2>

    <sect2 xml:id="mp3-encoding">
      <title>MP3 編碼與解碼</title>

      <para xml:lang="en"><application>Lame</application> is a popular
	<acronym>MP3</acronym> encoder which can be installed from the
	<package>audio/lame</package> port.  Due to patent issues, a
	package is not available.</para>

      <para xml:lang="en">The following command will convert the ripped
	<acronym>WAV</acronym> file
	<filename><replaceable>audio01.wav</replaceable></filename> to
	<filename><replaceable>audio01.mp3</replaceable></filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>lame -h -b <replaceable>128</replaceable> --tt "<replaceable>Foo Song Title</replaceable>" --ta "<replaceable>FooBar Artist</replaceable>" --tl "<replaceable>FooBar Album</replaceable>" \
--ty "<replaceable>2014</replaceable>" --tc "<replaceable>Ripped and encoded by Foo</replaceable>" --tg "<replaceable>Genre</replaceable>" <replaceable>audio01.wav audio01.mp3</replaceable></userinput></screen>

      <para xml:lang="en">The specified 128 kbits is a standard
	<acronym>MP3</acronym> bitrate while the 160 and 192 bitrates
	provide higher quality.  The higher the bitrate, the larger
	the size of the resulting <acronym>MP3</acronym>.  The
	<option>-h</option> turns on the
	<quote>higher quality but a little slower</quote>
	mode.  The options beginning with <option>--t</option>
	indicate <acronym>ID3</acronym> tags, which usually contain
	song information, to be embedded within the
	<acronym>MP3</acronym> file.  Additional encoding options can
	be found in the <application>lame</application> manual
	page.</para>

      <para xml:lang="en">In order to burn an audio <acronym>CD</acronym> from
	<acronym>MP3</acronym>s, they must first be converted to a
	non-compressed file format.  <application>XMMS</application>
	can be used to convert to the <acronym>WAV</acronym> format,
	while <application>mpg123</application> can be used to convert
	to the raw Pulse-Code Modulation (<acronym>PCM</acronym>)
	audio data format.</para>

      <para xml:lang="en">To convert <filename>audio01.mp3</filename> using
	<application>mpg123</application>, specify the name of the
	<acronym>PCM</acronym> file:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mpg123 -s <replaceable>audio01.mp3</replaceable> &gt; <replaceable>audio01.pcm</replaceable></userinput></screen>

      <para xml:lang="en">To use <application>XMMS</application> to convert a
	<acronym>MP3</acronym> to <acronym>WAV</acronym> format, use
	these steps:</para>

      <procedure>
	<title xml:lang="en">Converting to <acronym>WAV</acronym> Format in
	  <application>XMMS</application></title>

	<step>
	  <para xml:lang="en">Launch <application>XMMS</application>.</para>
	</step>

	<step>
	  <para xml:lang="en">Right-click the window to bring up the
	    <application>XMMS</application> menu.</para>
	</step>

	<step>
	  <para xml:lang="en">Select <literal>Preferences</literal> under
	    <literal>Options</literal>.</para>
	</step>

	<step>
	  <para xml:lang="en">Change the Output Plugin to <quote>Disk Writer
	      Plugin</quote>.</para>
	</step>

	<step>
	  <para xml:lang="en">Press <literal>Configure</literal>.</para>
	</step>

	<step>
	  <para xml:lang="en">Enter or browse to a directory to write the
	    uncompressed files to.</para>
	</step>

	<step>
	  <para xml:lang="en">Load the <acronym>MP3</acronym> file into
	    <application>XMMS</application> as usual, with volume at
	    100% and EQ settings turned off.</para>
	</step>

	<step>
	  <para xml:lang="en">Press <literal>Play</literal>.  The
	    <application>XMMS</application> will appear as if it is
	    playing the <acronym>MP3</acronym>, but no music will be
	    heard.  It is actually playing the <acronym>MP3</acronym>
	    to a file.</para>
	</step>

	<step>
	  <para xml:lang="en">When finished, be sure to set the default Output
	    Plugin back to what it was before in order to listen to
	    <acronym>MP3</acronym>s again.</para>
	</step>
      </procedure>

      <para xml:lang="en">Both the <acronym>WAV</acronym> and <acronym>PCM</acronym>
	formats can be used with <application>cdrecord</application>.
	When using <acronym>WAV</acronym> files, there will be a small
	tick sound at the beginning of each track.  This sound is the
	header of the <acronym>WAV</acronym> file.  The
	<package>audio/sox</package> port or package can be used to
	remove the header:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>sox -t wav -r 44100 -s -w -c 2 <replaceable>track.wav track.raw</replaceable></userinput></screen>

      <para xml:lang="en">Refer to <xref linkend="creating-cds"/> for more
	information on using a <acronym>CD</acronym> burner in
	FreeBSD.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="video-playback">
    <info>
      <title>影片播放</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Ross</firstname>
	    <surname>Lippert</surname>
	  </personname>
	  <contrib>Contributed by </contrib> <!--in June 2002-->
	</author>
      </authorgroup>
    </info>

    <para xml:lang="en">Before configuring video playback, determine the model and
      chipset of the video card.  While
      <application>Xorg</application> supports a wide variety of
      video cards, not all provide good playback performance.  To
      obtain a list of extensions supported by the
      <application>Xorg</application> server using the card, run
      <command>xdpyinfo</command> while
      <application>Xorg</application> is running.</para>

    <para xml:lang="en">It is a good idea to have a short MPEG test file for
      evaluating various players and options.  Since some
      <acronym>DVD</acronym> applications look for
      <acronym>DVD</acronym> media in <filename>/dev/dvd</filename> by
      default, or have this device name hardcoded in them, it might be
      useful to make a symbolic link to the proper device:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>ln -sf /dev/cd0 /dev/dvd</userinput></screen>

    <para xml:lang="en">Due to the nature of <citerefentry vendor="current"><refentrytitle>devfs</refentrytitle><manvolnum>5</manvolnum></citerefentry>, manually created links
      will not persist after a system reboot.  In order to recreate
      the symbolic link automatically when the system boots, add the
      following line to <filename>/etc/devfs.conf</filename>:</para>

    <programlisting xml:lang="en">link cd0 dvd</programlisting>

    <para xml:lang="en"><acronym>DVD</acronym> decryption invokes certain functions
      that require write permission to the <acronym>DVD</acronym>
      device.</para>

    <para xml:lang="en">To enhance the shared memory
      <application>Xorg</application> interface, it is recommended
      to increase the values of these <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
      variables:</para>

    <programlisting xml:lang="en">kern.ipc.shmmax=67108864
kern.ipc.shmall=32768</programlisting>

    <sect2 xml:id="video-interface">
      <title>偵測影像處理能力</title>

      <indexterm xml:lang="en"><primary>XVideo</primary></indexterm>
      <indexterm xml:lang="en"><primary>SDL</primary></indexterm>
      <indexterm xml:lang="en"><primary>DGA</primary></indexterm>

      <para xml:lang="en">There are several possible ways to display video under
	<application>Xorg</application> and what works is largely
	hardware dependent.  Each method described below will have
	varying quality across different hardware.</para>

      <para xml:lang="en">Common video interfaces include:</para>

      <orderedlist>
	<listitem>
	  <para xml:lang="en"><application>Xorg</application>: normal output using
	    shared memory.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">XVideo: an extension to the
	    <application>Xorg</application> interface which
	    allows video to be directly displayed in drawable objects
	    through a special acceleration.  This extension provides
	    good quality playback even on low-end machines.  The next
	    section describes how to determine if this extension is
	    running.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><acronym>SDL</acronym>: the Simple Directmedia Layer
	    is a porting layer for many operating systems, allowing
	    cross-platform applications to be developed which make
	    efficient use of sound and graphics.
	    <acronym>SDL</acronym> provides a low-level abstraction to
	    the hardware which can sometimes be more efficient than
	    the <application>Xorg</application> interface.  On FreeBSD,
	    <acronym>SDL</acronym> can be installed using the
	    <package>devel/sdl20</package> package or port.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><acronym>DGA</acronym>: the Direct Graphics Access is
	    an <application>Xorg</application> extension which
	    allows a program to bypass the
	    <application>Xorg</application> server and directly
	    alter the framebuffer.  Because it relies on a low level
	    memory mapping, programs using it must be run as
	    <systemitem class="username">root</systemitem>.  The
	    <acronym>DGA</acronym> extension can be tested and
	    benchmarked using <citerefentry vendor="xfree86"><refentrytitle>dga</refentrytitle><manvolnum>1</manvolnum></citerefentry>.  When
	    <command>dga</command> is running, it changes the colors
	    of the display whenever a key is pressed.  To quit, press
	    <keycap>q</keycap>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">SVGAlib: a low level console graphics layer.</para>
	</listitem>
      </orderedlist>

      <sect3 xml:id="video-interface-xvideo">
	<title xml:lang="en">XVideo</title>

	<para xml:lang="en">To check whether this extension is running, use
	  <command>xvinfo</command>:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>xvinfo</userinput></screen>

	<para xml:lang="en">XVideo is supported for the card if the result is
	  similar to:</para>

	<screen xml:lang="en">X-Video Extension version 2.2
  screen #0
  Adaptor #0: "Savage Streams Engine"
    number of ports: 1
    port base: 43
    operations supported: PutImage
    supported visuals:
      depth 16, visualID 0x22
      depth 16, visualID 0x23
    number of attributes: 5
      "XV_COLORKEY" (range 0 to 16777215)
              client settable attribute
              client gettable attribute (current value is 2110)
      "XV_BRIGHTNESS" (range -128 to 127)
              client settable attribute
              client gettable attribute (current value is 0)
      "XV_CONTRAST" (range 0 to 255)
              client settable attribute
              client gettable attribute (current value is 128)
      "XV_SATURATION" (range 0 to 255)
              client settable attribute
              client gettable attribute (current value is 128)
      "XV_HUE" (range -180 to 180)
              client settable attribute
              client gettable attribute (current value is 0)
    maximum XvImage size: 1024 x 1024
    Number of image formats: 7
      id: 0x32595559 (YUY2)
        guid: 59555932-0000-0010-8000-00aa00389b71
        bits per pixel: 16
        number of planes: 1
        type: YUV (packed)
      id: 0x32315659 (YV12)
        guid: 59563132-0000-0010-8000-00aa00389b71
        bits per pixel: 12
        number of planes: 3
        type: YUV (planar)
      id: 0x30323449 (I420)
        guid: 49343230-0000-0010-8000-00aa00389b71
        bits per pixel: 12
        number of planes: 3
        type: YUV (planar)
      id: 0x36315652 (RV16)
        guid: 52563135-0000-0000-0000-000000000000
        bits per pixel: 16
        number of planes: 1
        type: RGB (packed)
        depth: 0
        red, green, blue masks: 0x1f, 0x3e0, 0x7c00
      id: 0x35315652 (RV15)
        guid: 52563136-0000-0000-0000-000000000000
        bits per pixel: 16
        number of planes: 1
        type: RGB (packed)
        depth: 0
        red, green, blue masks: 0x1f, 0x7e0, 0xf800
      id: 0x31313259 (Y211)
        guid: 59323131-0000-0010-8000-00aa00389b71
        bits per pixel: 6
        number of planes: 3
        type: YUV (packed)
      id: 0x0
        guid: 00000000-0000-0000-0000-000000000000
        bits per pixel: 0
        number of planes: 0
        type: RGB (packed)
        depth: 1
        red, green, blue masks: 0x0, 0x0, 0x0</screen>

	<para xml:lang="en">The formats listed, such as YUV2 and YUV12, are not
	  present with every implementation of XVideo and their
	  absence may hinder some players.</para>

	<para xml:lang="en">If the result instead looks like:</para>

	<screen xml:lang="en">X-Video Extension version 2.2
screen #0
no adaptors present</screen>

	<para xml:lang="en">XVideo is probably not supported for the card.  This
	  means that it will be more difficult for the display to meet
	  the computational demands of rendering video, depending on
	  the video card and processor.</para>
      </sect3>
    </sect2>

    <sect2 xml:id="video-ports">
      <title>可處理影像的 Port 與套件</title>

      <indexterm xml:lang="en"><primary>video ports</primary></indexterm>
      <indexterm xml:lang="en"><primary>video packages</primary></indexterm>

      <para xml:lang="en">This section introduces some of the software available
	from the FreeBSD Ports Collection which can be used for video
	playback.</para>

      <sect3 xml:id="video-mplayer">
	<title><application>MPlayer</application> 與 <application>MEncoder</application></title>

	<para xml:lang="en"><application>MPlayer</application> is a command-line
	  video player with an optional graphical interface which aims
	  to provide speed and flexibility.  Other graphical
	  front-ends to <application>MPlayer</application> are
	  available from the FreeBSD Ports Collection.</para>

	<indexterm xml:lang="en"><primary>MPlayer</primary></indexterm>

	<para xml:lang="en"><application>MPlayer</application> can be installed
	  using the <package>multimedia/mplayer</package> package or
	  port.  Several compile options are available and a variety
	  of hardware checks occur during the build process.  For
	  these reasons, some users prefer to build the port rather
	  than install the package.</para>

	<para xml:lang="en">When compiling the port, the menu options should be
	  reviewed to determine the type of support to compile into
	  the port.  If an option is not selected,
	  <application>MPlayer</application> will not be able to
	  display that type of video format.  Use the arrow keys and
	  spacebar to select the required formats.  When finished,
	  press <keycap>Enter</keycap> to continue the port compile
	  and installation.</para>

	<para xml:lang="en">By default, the package or port will build the
	  <command>mplayer</command> command line utility and the
	  <command>gmplayer</command> graphical utility.  To encode
	  videos, compile the <package>multimedia/mencoder</package>
	  port.  Due to licensing restrictions, a package is not
	  available for <application>MEncoder</application>.</para>

	<para xml:lang="en">The first time <application>MPlayer</application> is
	  run, it will create <filename>~/.mplayer</filename> in the
	  user's home directory.  This subdirectory contains default
	  versions of the user-specific configuration files.</para>

	<para xml:lang="en">This section describes only a few common uses.  Refer to
	  mplayer(1) for a complete description of its numerous
	  options.</para>

	<para xml:lang="en">To play the file
	  <filename><replaceable>testfile.avi</replaceable></filename>,
	  specify the video interfaces with <option>-vo</option>, as
	  seen in the following examples:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>mplayer -vo xv <replaceable>testfile.avi</replaceable></userinput></screen>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>mplayer -vo sdl <replaceable>testfile.avi</replaceable></userinput></screen>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>mplayer -vo x11 <replaceable>testfile.avi</replaceable></userinput></screen>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mplayer -vo dga <replaceable>testfile.avi</replaceable></userinput></screen>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mplayer -vo 'sdl:dga' <replaceable>testfile.avi</replaceable></userinput></screen>

	<para xml:lang="en">It is worth trying all of these options, as their
	  relative performance depends on many factors and will vary
	  significantly with hardware.</para>

	<para xml:lang="en">To play a <acronym>DVD</acronym>, replace
	  <filename><replaceable>testfile.avi</replaceable></filename>
	  with <option>dvd://<replaceable>N</replaceable> -dvd-device
	   <replaceable>DEVICE</replaceable></option>, where
	  <replaceable>N</replaceable> is the title number to play and
	  <replaceable>DEVICE</replaceable> is the device node for the
	  <acronym>DVD</acronym>.  For example, to play title 3 from
	  <filename>/dev/dvd</filename>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mplayer -vo xv dvd://3 -dvd-device /dev/dvd</userinput></screen>

	<note>
	  <para xml:lang="en">The default <acronym>DVD</acronym> device can be
	    defined during the build of the
	    <application>MPlayer</application> port by including the
	    <varname>WITH_DVD_DEVICE=/path/to/desired/device</varname>
	    option.  By default, the device is
	    <filename>/dev/cd0</filename>.  More details can be found
	    in the port's
	    <filename>Makefile.options</filename>.</para>
	</note>

	<para xml:lang="en">To stop, pause, advance, and so on, use a keybinding.
	  To see the list of keybindings, run <command>mplayer
	    -h</command> or read mplayer(1).</para>

	<para xml:lang="en">Additional playback options include <option>-fs
	    -zoom</option>, which engages fullscreen mode, and
	  <option>-framedrop</option>, which helps performance.</para>

	<para xml:lang="en">Each user can add commonly used options to their
	  <filename>~/.mplayer/config</filename> like so:</para>

	<programlisting xml:lang="en">vo=xv
fs=yes
zoom=yes</programlisting>

	<para xml:lang="en"><command>mplayer</command> can be used to rip a
	  <acronym>DVD</acronym> title to a <filename>.vob</filename>.
	  To dump the second title from a
	  <acronym>DVD</acronym>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mplayer -dumpstream -dumpfile out.vob dvd://2 -dvd-device /dev/dvd</userinput></screen>

	<para xml:lang="en">The output file, <filename>out.vob</filename>, will be
	  in <acronym>MPEG</acronym> format.</para>

	<para xml:lang="en">Anyone wishing to obtain a high level of expertise with
	  <trademark class="registered">UNIX</trademark> video should consult <link xlink:href="http://www.mplayerhq.hu/DOCS/">mplayerhq.hu/DOCS</link>
	  as it is technically informative.  This documentation should
	  be considered as required reading before submitting any bug
	  reports.</para>

	<indexterm xml:lang="en">
	  <primary>mencoder</primary>
	</indexterm>

	<para xml:lang="en">Before using <command>mencoder</command>, it is a good
	  idea to become familiar with the options described at <link xlink:href="http://www.mplayerhq.hu/DOCS/HTML/en/mencoder.html">mplayerhq.hu/DOCS/HTML/en/mencoder.html</link>.
	  There are innumerable ways to improve quality, lower
	  bitrate, and change formats, and some of these options may
	  make the difference between good or bad performance.
	  Improper combinations of command line options can yield
	  output files that are unplayable even by
	  <command>mplayer</command>.</para>

	<para xml:lang="en">Here is an example of a simple copy:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>mencoder <replaceable>input.avi</replaceable> -oac copy -ovc copy -o <replaceable>output.avi</replaceable></userinput></screen>

	<para xml:lang="en">To rip to a file, use <option>-dumpfile</option> with
	  <command>mplayer</command>.</para>

	<para xml:lang="en">To convert
	  <filename><replaceable>input.avi</replaceable></filename> to
	  the MPEG4 codec with MPEG3 audio encoding, first install the
	  <package>audio/lame</package> port.  Due to licensing
	  restrictions, a package is not available.  Once installed,
	  type:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>mencoder <replaceable>input.avi</replaceable> -oac mp3lame -lameopts br=192 \
	 -ovc lavc -lavcopts vcodec=mpeg4:vhq -o <replaceable>output.avi</replaceable></userinput></screen>

	<para xml:lang="en">This will produce output playable by applications such
	  as <command>mplayer</command> and
	  <command>xine</command>.</para>

	<para xml:lang="en"><filename><replaceable>input.avi</replaceable></filename>
	  can be replaced with <option>dvd://1 -dvd-device
	    /dev/dvd</option> and run as <systemitem class="username">root</systemitem> to re-encode a
	  <acronym>DVD</acronym> title directly.  Since it may take a
	  few tries to get the desired result, it is recommended to
	  instead dump the title to a file and to work on the
	  file.</para>
      </sect3>

      <sect3 xml:id="video-xine">
	<title><application>xine</application> 影像播放器</title>

	<para xml:lang="en"><application>xine</application> is a video player with a
	  reusable base library and a modular executable which can be
	  extended with plugins.  It can be installed using the
	  <package>multimedia/xine</package> package or port.</para>

	<para xml:lang="en">In practice, <application>xine</application> requires
	  either a fast CPU with a fast video card, or support for the
	  XVideo extension.  The <application>xine</application> video
	  player performs best on XVideo interfaces.</para>

	<para xml:lang="en">By default, the <application>xine</application> player
	  starts a graphical user interface.  The menus can then be
	  used to open a specific file.</para>

	<para xml:lang="en">Alternatively, <application>xine</application> may be
	  invoked from the command line by specifying the name of the
	  file to play:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>xine -g -p <replaceable>mymovie.avi</replaceable></userinput></screen>

	<para xml:lang="en">Refer to <link xlink:href="http://www.xine-project.org/faq">
	    xine-project.org/faq</link> for more information and
	  troubleshooting tips.</para>
      </sect3>

      <sect3 xml:id="video-ports-transcode">
	<title><application>Transcode</application> 工具</title>

	<para xml:lang="en"><application>Transcode</application> provides a suite of
	  tools for re-encoding video and audio files.
	  <application>Transcode</application> can be used to merge
	  video files or repair broken files using command line tools
	  with stdin/stdout stream interfaces.</para>

	<para xml:lang="en">In FreeBSD, <application>Transcode</application> can be
	  installed using the <package>multimedia/transcode</package>
	  package or port.  Many users prefer to compile the port as
	  it provides a menu of compile options for specifying the
	  support and codecs to compile in.  If an option is not
	  selected, <application>Transcode</application> will not be
	  able to encode that format.  Use the arrow keys and spacebar
	  to select the required formats.  When finished, press
	  <keycap>Enter</keycap> to continue the port compile and
	  installation.</para>

	<para xml:lang="en">This example demonstrates how to convert a DivX file
	  into a PAL MPEG-1 file (PAL VCD):</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>transcode -i <replaceable>input.avi</replaceable> -V --export_prof vcd-pal -o output_vcd</userinput>
<prompt>%</prompt> <userinput>mplex -f 1 -o <replaceable>output_vcd.mpg output_vcd.m1v output_vcd.mpa</replaceable></userinput></screen>

	<para xml:lang="en">The resulting <acronym>MPEG</acronym> file,
	  <filename><replaceable>output_vcd.mpg</replaceable></filename>,
	  is ready to be played with
	  <application>MPlayer</application>.  The file can be burned
	  on a <acronym>CD</acronym> media to create a video
	  <acronym>CD</acronym> using a utility such as
	  <package>multimedia/vcdimager</package> or
	  <package>sysutils/cdrdao</package>.</para>

	<para xml:lang="en">In addition to the manual page for
	  <command>transcode</command>, refer to  <link xlink:href="http://www.transcoding.org/cgi-bin/transcode">transcoding.org/cgi-bin/transcode</link>
	  for further information and examples.</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="tvcard">
    <info>
      <title>電視卡</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Josef</firstname>
	    <surname>El-Rayes</surname>
	  </personname>
	  <contrib>Original contribution by </contrib>
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Fonvieille</surname>
	  </personname>
	  <contrib>Enhanced and adapted by </contrib> <!-- in January 2004-->
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>TV cards</primary>
    </indexterm>

    <para>電視卡 (TV card) 可以讓您用電腦來看無線、有線電視節目。許多卡都是透過 <acronym>RCA</acronym> 或 S-video 輸入端子來接收視訊，而且有些卡還可接收 <acronym>FM</acronym> 廣播的功能。</para>

    <para>FreeBSD 可透過 <citerefentry><refentrytitle>bktr</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式，來支援 PCI 介面的電視卡，只要這些卡使用的是 Brooktree Bt848/849/878/879 或 Conexant CN-878/Fusion 878a 視訊擷取晶片。此外，要再確認哪些卡上所附的選台功能是否有支援，可以參考 <citerefentry><refentrytitle>bktr</refentrytitle><manvolnum>4</manvolnum></citerefentry> 說明，以查看所支援的硬體清單。</para>

    <sect2>
      <title>載入驅動程式</title>

      <para>要用電視卡的話，就要載入 <citerefentry><refentrytitle>bktr</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式，這個可以透過在 <filename>/boot/loader.conf</filename> 檔加上下面這一行就可以了：</para>

      <programlisting xml:lang="en">bktr_load="YES"</programlisting>

      <para>或者可以將電視卡支援靜態編譯到自訂的核心當中，若要這麼做則可在自訂核心設定檔加入以下行：</para>

      <programlisting xml:lang="en">device	 bktr
device	iicbus
device	iicbb
device	smbus</programlisting>

      <para>之所以要加上這些額外的驅動程式，是因為卡的各組成部分都是透過 I2C 匯流排而相互連接的。接下來，請編譯、安裝新的核心 。</para>

      <para>要測試調諧器 (Tuner) 是否被正確的偵測，請先重新啟動系統。電視卡應該會出現在開機訊息檔中，如同此範例：</para>

      <programlisting xml:lang="en">bktr0: &lt;BrookTree 848A&gt; mem 0xd7000000-0xd7000fff irq 10 at device 10.0 on pci0
iicbb0: &lt;I2C bit-banging driver&gt; on bti2c0
iicbus0: &lt;Philips I2C bus&gt; on iicbb0 master-only
iicbus1: &lt;Philips I2C bus&gt; on iicbb0 master-only
smbus0: &lt;System Management Bus&gt; on bti2c0
bktr0: Pinnacle/Miro TV, Philips SECAM tuner.</programlisting>

      <para>該訊息會依硬體不同而有所不同。若必要，可以使用 <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 系統偵測的參數或者自訂核心設定選項。例如要強制使用 Philips SECAM 調諧器則可加入下列行至自訂核心設定檔：</para>

      <programlisting xml:lang="en">options OVERRIDE_TUNER=6</programlisting>

      <para>或使用 <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl hw.bt848.tuner=6</userinput></screen>

      <para>請參考 <citerefentry><refentrytitle>bktr</refentrytitle><manvolnum>4</manvolnum></citerefentry> 查看 <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 可用的參數說明及核心選項。</para>
    </sect2>

    <sect2>
      <title>好用的應用程式</title>

      <para xml:lang="en">To use the TV card, install one of the following
	applications:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><package>multimedia/fxtv</package>
	    provides TV-in-a-window and image/audio/video capture
	    capabilities.</para>
	</listitem>
	<listitem>
	  <para xml:lang="en"><package>multimedia/xawtv</package>
	    is another TV application with similar features.</para>
	</listitem>
	<listitem>
	  <para xml:lang="en"><package>audio/xmradio</package>
	    provides an application for using the FM radio tuner of a
	    TV card.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">More applications are available in the FreeBSD Ports
	Collection.</para>
    </sect2>

    <sect2>
      <title>疑難排解</title>

      <para xml:lang="en">If any problems are encountered with the TV card, check
	that the video capture chip and the tuner are supported by
	<citerefentry><refentrytitle>bktr</refentrytitle><manvolnum>4</manvolnum></citerefentry> and that the right configuration options were
	used.  For more support or to ask questions about supported TV
	cards, refer to the <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-multimedia">freebsd-multimedia</link> mailing list.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="mythtv">
    <title xml:lang="en">MythTV</title>

    <para xml:lang="en">MythTV is a popular, open source Personal Video Recorder
      (<acronym>PVR</acronym>) application.  This section demonstrates
      how to install and setup MythTV on FreeBSD.  Refer to <link xlink:href="http://www.mythtv.org/wiki/">mythtv.org/wiki</link>
      for more information on how to use MythTV.</para>

    <para xml:lang="en">MythTV requires a frontend and a backend.  These components
      can either be installed on the same system or on different
      machines.</para>

    <para xml:lang="en">The frontend can be installed on FreeBSD using the
      <package>multimedia/mythtv-frontend</package> package or port.
      <application>Xorg</application> must also be installed and
      configured as described in <xref linkend="x11"/>.  Ideally, this
      system has a video card that supports X-Video Motion
      Compensation (<acronym>XvMC</acronym>) and, optionally, a Linux
      Infrared Remote Control (<acronym>LIRC</acronym>)-compatible
      remote.</para>

    <para xml:lang="en">To install both the backend and the frontend on FreeBSD, use
      the <package>multimedia/mythtv</package> package or port.  A
      <trademark>MySQL</trademark> database server is also required and should
      automatically be installed as a dependency.  Optionally, this
      system should have a tuner card and sufficient storage to hold
      recorded data.</para>

    <sect2>
      <title>硬體</title>

      <para xml:lang="en">MythTV uses Video for Linux (<acronym>V4L</acronym>) to
	access video input devices such as encoders and tuners.  In
	FreeBSD, MythTV works best with <acronym>USB</acronym> DVB-S/C/T
	cards as they are well supported by the
	<package>multimedia/webcamd</package> package or port which
	provides a <acronym>V4L</acronym> userland application.  Any
	Digital Video Broadcasting (<acronym>DVB</acronym>) card
	supported by <application>webcamd</application> should work
	with MythTV.  A list of known working cards can be found at
	<link xlink:href="https://wiki.freebsd.org/WebcamCompat">wiki.freebsd.org/WebcamCompat</link>.
	Drivers are also available for Hauppauge cards in the
	<package>multimedia/pvr250</package> and
	<package>multimedia/pvrxxx</package> ports, but they provide a
	non-standard driver interface that does not work with versions
	of MythTV greater than 0.23.  Due to licensing restrictions,
	no packages are available and these two ports must be
	compiled.</para>

      <para xml:lang="en">The <link xlink:href="https://wiki.freebsd.org/HTPC">wiki.freebsd.org/HTPC</link>
	page contains a list of all available <acronym>DVB</acronym>
	drivers.</para>
    </sect2>

    <sect2>
      <title>設定 MythTV 後端</title>

      <para>要使用 Binary 套件安裝 MythTV 可：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install mythtv</userinput></screen>

      <para>或從 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/multimedia/mythtv</userinput>
<prompt>#</prompt> <userinput>make install</userinput></screen>

      <para xml:lang="en">Once installed, set up the MythTV database:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mysql -uroot -p &lt; /usr/local/share/mythtv/database/mc.sql</userinput></screen>

      <para xml:lang="en">Then, configure the backend:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mythtv-setup</userinput></screen>

      <para xml:lang="en">Finally, start the backend:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc mythbackend_enable=yes</userinput>
<prompt>#</prompt> <userinput>service mythbackend start</userinput></screen>
    </sect2>
  </sect1>

  <sect1 xml:id="scanners">
    <info>
      <title>影像掃描器</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Fonvieille</surname>
	  </personname>
	  <contrib>Written by </contrib> <!-- in August 2004-->
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>image scanners</primary>
    </indexterm>

    <para xml:lang="en">In FreeBSD, access to image scanners is provided by
      <application>SANE</application> (Scanner Access Now Easy), which
      is available in the FreeBSD Ports Collection.
      <application>SANE</application> will also use some FreeBSD device
      drivers to provide access to the scanner hardware.</para>

    <para xml:lang="en">FreeBSD supports both <acronym>SCSI</acronym> and
      <acronym>USB</acronym> scanners.  Depending upon the scanner
      interface, different device drivers are required.  Be sure the
      scanner is supported by <application>SANE</application> prior
      to performing any configuration.  Refer to <link xlink:href="http://www.sane-project.org/sane-supported-devices.html">
      http://www.sane-project.org/sane-supported-devices.html</link>
      for more information about supported scanners.</para>

    <para xml:lang="en">This chapter describes how to determine if the scanner has
      been detected by FreeBSD.  It then provides an overview of how to
      configure and use <application>SANE</application> on a FreeBSD
      system.</para>

    <sect2 xml:id="scanners-kernel-usb">
      <title>檢查掃描器</title>

      <para xml:lang="en">The <filename>GENERIC</filename> kernel includes the
	device drivers needed to support <acronym>USB</acronym>
	scanners.  Users with a custom kernel should ensure that the
	following lines are present in the custom kernel configuration
	file:</para>

      <programlisting xml:lang="en">device usb
device uhci
device ohci
device ehci</programlisting>

      <para xml:lang="en">To determine if the <acronym>USB</acronym> scanner is
	detected, plug it in and use <command>dmesg</command> to
	determine whether the scanner appears in the system message
	buffer.  If it does, it should display a message similar to
	this:</para>

      <screen xml:lang="en">ugen0.2: &lt;EPSON&gt; at usbus0</screen>

      <para xml:lang="en">In this example, an <trademark class="registered">EPSON
  Perfection</trademark> 1650
	<acronym>USB</acronym> scanner was detected on
	<filename>/dev/ugen0.2</filename>.</para>

      <para xml:lang="en">If the scanner uses a <acronym>SCSI</acronym> interface,
	it is important to know which <acronym>SCSI</acronym>
	controller board it will use.  Depending upon the
	<acronym>SCSI</acronym> chipset, a custom kernel configuration
	file may be needed.  The <filename>GENERIC</filename> kernel
	supports the most common <acronym>SCSI</acronym> controllers.
	Refer to <filename>/usr/src/sys/conf/NOTES</filename> to
	determine the correct line to add to a custom kernel
	configuration file.  In addition to the
	<acronym>SCSI</acronym> adapter driver, the following lines
	are needed in a custom kernel configuration file:</para>

      <programlisting xml:lang="en">device scbus
device pass</programlisting>

      <para xml:lang="en">Verify that the device is displayed in the system message
	buffer:</para>

      <screen xml:lang="en">pass2 at aic0 bus 0 target 2 lun 0
pass2: &lt;AGFA SNAPSCAN 600 1.10&gt; Fixed Scanner SCSI-2 device
pass2: 3.300MB/s transfers</screen>

      <para xml:lang="en">If the scanner was not powered-on at system boot, it is
	still possible to manually force detection by performing a
	<acronym>SCSI</acronym> bus scan with
	<command>camcontrol</command>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>camcontrol rescan all</userinput>
Re-scan of bus 0 was successful
Re-scan of bus 1 was successful
Re-scan of bus 2 was successful
Re-scan of bus 3 was successful</screen>

      <para xml:lang="en">The scanner should now appear in the
	<acronym>SCSI</acronym> devices list:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>camcontrol devlist</userinput>
&lt;IBM DDRS-34560 S97B&gt;              at scbus0 target 5 lun 0 (pass0,da0)
&lt;IBM DDRS-34560 S97B&gt;              at scbus0 target 6 lun 0 (pass1,da1)
&lt;AGFA SNAPSCAN 600 1.10&gt;           at scbus1 target 2 lun 0 (pass3)
&lt;PHILIPS CDD3610 CD-R/RW 1.00&gt;     at scbus2 target 0 lun 0 (pass2,cd0)</screen>

      <para xml:lang="en">Refer to <citerefentry><refentrytitle>scsi</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>camcontrol</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more
	details about <acronym>SCSI</acronym> devices on FreeBSD.</para>
    </sect2>

    <sect2>
      <title><application>SANE</application> 設定</title>

      <para xml:lang="en">The <application>SANE</application> system is split in two
	parts: the backends
	(<package>graphics/sane-backends</package>) and the frontends
	(<package>graphics/sane-frontends</package> or
	<package>graphics/xsane</package>).  The backends provide
	access to the scanner.  Refer to <link xlink:href="http://www.sane-project.org/sane-supported-devices.html">http://www.sane-project.org/sane-supported-devices.html</link>
	to determine which backend supports the scanner.  The
	frontends provide the graphical scanning interface.
	<package>graphics/sane-frontends</package> installs
	<application>xscanimage</application> while
	<package>graphics/xsane</package> installs
	<application>xsane</application>.</para>

      <para>要由 Binary 套件安裝這兩個部份可：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install xsane sane-frontends</userinput></screen>

      <para>或由 Port 套件集安裝</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/graphics/sane-frontends</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput>
<prompt>#</prompt> <userinput>cd /usr/ports/graphics/xsane</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para xml:lang="en">After installing the
	<package>graphics/sane-backends</package> port or package, use
	<command>sane-find-scanner</command> to check the scanner
	detection by the <application>SANE</application>
	system:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sane-find-scanner -q</userinput>
found SCSI scanner "AGFA SNAPSCAN 600 1.10" at /dev/pass3</screen>

      <para xml:lang="en">The output should show the interface type of the scanner
	and the device node used to attach the scanner to the system.
	The vendor and the product model may or may not appear.</para>

      <note>
	<para xml:lang="en">Some <acronym>USB</acronym> scanners require firmware to
	  be loaded.  Refer to sane-find-scanner(1) and sane(7) for
	  details.</para>
      </note>

      <para xml:lang="en">Next, check if the scanner will be identified by a
	scanning frontend.  The <application>SANE</application>
	backends include <command>scanimage</command> which can be
	used to list the devices and perform an image acquisition.
	Use <option>-L</option> to list the scanner devices.  The
	first example is for a <acronym>SCSI</acronym> scanner and the
	second is for a <acronym>USB</acronym> scanner:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>scanimage -L</userinput>
device `snapscan:/dev/pass3' is a AGFA SNAPSCAN 600 flatbed scanner
<prompt>#</prompt> <userinput>scanimage -L</userinput>
device 'epson2:libusb:/dev/usb:/dev/ugen0.2' is a Epson GT-8200 flatbed scanner</screen>

      <para xml:lang="en">In this second example,
	<literal>'epson2:libusb:/dev/usb:/dev/ugen0.2'</literal> is
	the backend name (<literal>epson2</literal>) and
	<literal>/dev/ugen0.2</literal> is the device node used by the
	scanner.</para>

      <para xml:lang="en">If <command>scanimage</command> is unable to identify the
	scanner, this message will appear:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>scanimage -L</userinput>

No scanners were identified. If you were expecting something different,
check that the scanner is plugged in, turned on and detected by the
sane-find-scanner tool (if appropriate). Please read the documentation
which came with this software (README, FAQ, manpages).</screen>

      <para xml:lang="en">If this happens, edit the backend configuration file in
	<filename>/usr/local/etc/sane.d/</filename> and define the
	scanner device used.  For example, if the undetected scanner
	model is an <trademark class="registered">EPSON
  Perfection</trademark> 1650 and it uses the
	<literal>epson2</literal> backend, edit
	<filename>/usr/local/etc/sane.d/epson2.conf</filename>.  When
	editing, add a line specifying the interface and the device
	node used.  In this case, add the following line:</para>

      <programlisting xml:lang="en">usb /dev/ugen0.2</programlisting>

      <para xml:lang="en">Save the edits and verify that the scanner is identified
	with the right backend name and the device node:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>scanimage -L</userinput>
device 'epson2:libusb:/dev/usb:/dev/ugen0.2' is a Epson GT-8200 flatbed scanner</screen>

      <para xml:lang="en">Once <command>scanimage -L</command> sees the scanner, the
	configuration is complete and the scanner is now ready to
	use.</para>

      <para xml:lang="en">While <command>scanimage</command> can be used to perform
	an image acquisition from the command line, it is often
	preferable to use a graphical interface to perform image
	scanning.  The <package>graphics/sane-frontends</package>
	package or port installs a simple but efficient graphical
	interface, <application>xscanimage</application>.</para>

      <para xml:lang="en">Alternately, <application>xsane</application>, which is
	installed with the <package>graphics/xsane</package> package
	or port, is another popular graphical scanning frontend.  It
	offers advanced features such as various scanning modes, color
	correction, and batch scans.  Both of these applications are
	usable as a <application>GIMP</application> plugin.</para>
    </sect2>

    <sect2>
      <title>掃描器權限</title>

      <para xml:lang="en">In order to have access to the scanner, a user needs read
	and write permissions to the device node used by the scanner.
	In the previous example, the <acronym>USB</acronym> scanner
	uses the device node <filename>/dev/ugen0.2</filename> which
	is really a symlink to the real device node
	<filename>/dev/usb/0.2.0</filename>.  The symlink and the
	device node are owned, respectively, by the <systemitem class="groupname">wheel</systemitem> and <systemitem class="groupname">operator</systemitem> groups.  While
	adding the user to these groups will allow access to the
	scanner, it is considered insecure to add a user to
	<systemitem class="groupname">wheel</systemitem>.  A better
	solution is to create a group and make the scanner device
	accessible to members of this group.</para>

      <para xml:lang="en">This example creates a group called <systemitem class="groupname"><replaceable>usb</replaceable></systemitem>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupadd usb</userinput></screen>

      <para xml:lang="en">Then, make the <filename>/dev/ugen0.2</filename> symlink
	and the <filename>/dev/usb/0.2.0</filename> device node
	accessible to the <systemitem class="groupname">usb</systemitem> group with write
	permissions of <literal>0660</literal> or
	<literal>0664</literal> by adding the following lines to
	<filename>/etc/devfs.rules</filename>:</para>

      <programlisting xml:lang="en">[system=5]
add path ugen0.2 mode 0660 group usb
add path usb/0.2.0 mode 0666 group usb</programlisting>

      <para xml:lang="en">Finally, add the users to <systemitem class="groupname"><replaceable>usb</replaceable></systemitem>
	in order to allow access to the scanner:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupmod usb -m <replaceable>joe</replaceable></userinput></screen>

      <para xml:lang="en">For more details refer to <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="kernelconfig">
<!--<chapterinfo>
    <authorgroup>
      <author>
	<firstname>Jim</firstname>
	<surname>Mock</surname>
	<contrib>Updated and restructured in Mar 2000 by </contrib>
      </author>
    </authorgroup>
    <authorgroup>
      <author>
	<firstname>Jake</firstname>
	<surname>Hamby</surname>
	<contrib>Originally contributed 6 Oct 1995 by </contrib>
      </author>
    </authorgroup>
  </chapterinfo>
  -->

  <title>設定 FreeBSD 核心</title>

  <sect1 xml:id="kernelconfig-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en">
      <primary>kernel</primary>
      <secondary>building a custom kernel</secondary>
    </indexterm>

    <para>核心 (Kernel) 是 FreeBSD 作業系統最重要的部份之一。它負責記憶體管理、安全控管、網路、硬碟存取等等。 儘管目前 FreeBSD 大多可以用動態設定， 但有時仍需要設定並編譯自訂的核心。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>何時需要編譯自訂核心。</para>
      </listitem>

      <listitem>
	<para>如何取得硬體資訊。</para>
      </listitem>

      <listitem>
	<para>如何量身訂做核心設定檔。</para>
      </listitem>

      <listitem>
	<para>如何使用核心設定檔來建立並編譯新的核心。</para>
      </listitem>

      <listitem>
	<para>如何安裝新的核心。</para>
      </listitem>

      <listitem>
	<para>發生錯誤時如何排除問題。</para>
      </listitem>
    </itemizedlist>

    <para>所有在本章所列出的指令均應以 <systemitem class="username">root</systemitem> 來執行。</para>
  </sect1>

  <sect1 xml:id="kernelconfig-custom-kernel">
    <title>為何要編譯自訂的核心?</title>

    <para>早期的 FreeBSD 的核心 (Kernel) 被戲稱為 “巨石”。因為當時的核心是一個非常大的程式，且只支援固定的硬體裝置，如果您想改變核心的設定，就必須編譯一個新核心並重新開機，才能使用。</para>

    <para>現今，大多數在 FreeBSD 核心的功能已採用模組 (Module) 的方式包裝，並可依需求動態從核心載入或卸載。 這使得執行中的核心能夠快速適應新硬體環境並在核心開啟新的功能，這就是所謂模組化核心 (Modular Kernel)。</para>

    <para>儘管如此，還是有一些功能因使用到靜態的核心設定須要編譯，因為這些功能與核心緊密結合，無法將做成可動態載入的模組。且部份強調安全性的環境會盡量避免載入與卸載核心模組，且只要將需要的功能靜態的編譯到核心當中。</para>

    <para>編譯自訂的核心幾乎是每位進階的 BSD 使用者所必須經歷的過程。儘管這項工作可能比較耗時，但在 FreeBSD 的使用上會有許多好處。 跟必須支援大多數各式硬體的 <filename>GENERIC</filename> 核心相比的話， 自訂的核心可以更『體貼』，只支援『自己硬體』的部分就好。 自訂核心有許多項優點，如：</para>

    <itemizedlist>
      <listitem>
	<para>加速開機，因為自訂的核心只需要偵測您系統上存在的硬體，所以讓啟動所花的過程更流暢快速。</para>
      </listitem>

      <listitem>
	<para>減少記憶體使用，自訂的核心通常會比 <filename>GENERIC</filename> 核心使用更少的記憶體，這很重要，因為核心必須一直存放在實體記憶體內，會讓其他應用程式無法使用。因此，自訂核心對於記憶體較小的系統來說，發揮很大的作用。</para>
      </listitem>

      <listitem>
	<para>支援額外的硬體，自訂的核心可以增加一些 <filename>GENERIC</filename> 核心沒有提供的硬體支援。</para>
      </listitem>
    </itemizedlist>

    <para>在編譯自訂核心之前，請思考要這麼做的原因，若是因為需要特定硬體的支援，很可能已有既有的模組可以使用。</para>

    <para>核心模組會放在 <filename>/boot/kernel</filename> 並且可使用 <citerefentry><refentrytitle>kldload</refentrytitle><manvolnum>8</manvolnum></citerefentry> 動態載入到執行中的核心。大部份的核心驅動程式都有可載入的模組與操作手冊。例如 <citerefentry><refentrytitle>ath</refentrytitle><manvolnum>4</manvolnum></citerefentry> 無線乙太網路驅動程式在其操作手冊有以下資訊：</para>

    <screen xml:lang="en">Alternatively, to load the driver as a module at boot time, place the
following line in <citerefentry><refentrytitle>loader.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>:

    if_ath_load="YES"</screen>

    <para>加入 <literal>if_ath_load="YES"</literal> 到 <filename>/boot/loader.conf</filename> 會於開機期間自動載入這個模組。</para>

    <para>部份情況在 <filename>/boot/kernel</filename> 會沒有相關的模組，這對於某些子系統大多是真的。</para>
  </sect1>

  <sect1 xml:id="kernelconfig-devices">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>偵測系統硬體</title>

    <para>在編輯核心設定檔之前，建議先調查清楚機器各項硬體資訊。在雙作業系統的環境，也可透過其他作業系統來了解目前機器上的硬體資訊。 舉例來說，<trademark class="registered">Microsoft</trademark> 的 <application>裝置管理員</application> (Device Manager) 內會有目前已安裝的硬體資訊。</para>

    <note>
      <para>某些版本的 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 會有<application>系統</application> (System) 圖示可用來進入 <application>裝置管理員</application>。</para>
    </note>

    <para>若 FreeBSD 是唯一安裝的作業系統，則可使用 <citerefentry><refentrytitle>dmesg</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來查看開時時系統偵測到的硬體資訊 。FreeBSD 上大多硬體驅動程式都有操作手冊會列出支援的硬體。例如，以下幾行是說 <citerefentry><refentrytitle>psm</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式偵測到了一隻滑鼠：</para>

    <screen xml:lang="en">psm0: &lt;PS/2 Mouse&gt; irq 12 on atkbdc0
psm0: [GIANT-LOCKED]
psm0: [ITHREAD]
psm0: model Generic PS/2 mouse, device ID 0</screen>

    <para>因為該硬體存在，此驅動程式便不應該從自訂核心設定檔中移除。</para>

    <para>若 <command>dmesg</command> 輸出的結果未顯示開機偵測硬體的部份，則可改閱讀 <filename>/var/run/dmesg.boot</filename> 檔案的內容。</para>

    <para>另外，也可以透過 <citerefentry><refentrytitle>pciconf</refentrytitle><manvolnum>8</manvolnum></citerefentry> 工具可用來查詢硬體資訊，該工具會列出更詳細的硬體資訊如：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>pciconf -lv</userinput>
ath0@pci0:3:0:0:        class=0x020000 card=0x058a1014 chip=0x1014168c rev=0x01 hdr=0x00
    vendor     = 'Atheros Communications Inc.'
    device     = 'AR5212 Atheros AR5212 802.11abg wireless'
    class      = network
    subclass   = ethernet</screen>

    <para>以上輸出資訊說明 <filename>ath</filename> 驅動程式已經找到一個無線乙太網路裝置。</para>

    <para>在 <citerefentry><refentrytitle>man</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令加上 <option>-k</option> 旗標可提供有用的資訊，例如，這可列出有包含指定裝置品牌或名稱的手冊頁面清單：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>man -k <replaceable>Atheros</replaceable></userinput>
ath(4)                   - Atheros IEEE 802.11 wireless network driver
ath_hal(4)               - Atheros Hardware Access Layer (HAL)</screen>

    <para>準備好硬體清單之後，參考該清單來確認已安裝的硬體驅動程式在編輯自訂核心設定時沒有被移除。</para>
  </sect1>

  <sect1 xml:id="kernelconfig-config">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Joel</firstname>
	  <surname>Dahl</surname>
	  <contrib>Updated by </contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>設定檔</title>

    <para>為了要建立自訂核心設定檔並編譯自訂核心，必須先安裝完整的 FreeBSD 原始碼樹。</para>

    <para>若 <filename>/usr/src/</filename> 目錄不存在或者是空的，代表尚未安裝。原始碼可以使用 <application>Subversion</application> 並依據 <xref linkend="svn"/> 中的操作說明來安裝。</para>

    <para>完成原始碼安裝完成後，需檢查 <filename>/usr/src/sys</filename> 內的檔案。該目錄內包含數個子目錄，這些子目錄代表著支援的硬體架構 (Architecture) 如下：<filename>amd64</filename>, <filename>i386</filename>, <filename>ia64</filename>, <filename>powerpc</filename> 以及 <filename>sparc64</filename>。在指定架構目錄中的內容只對該架構有效，其餘部份的程式碼與硬體架構無關，可通用所有平台。每個支援的硬體架構中會有 <filename>conf</filename> 子目錄，裡面含有供該架構使用的 <filename>GENERIC</filename> 核心設定檔。</para>

    <para>請不要直接對 <filename>GENERIC</filename> 檔案做編輯。複製該檔案為另一個名稱，並對複製出來的檔案做編輯，習慣上檔名會全部使用大寫字元。當維護多台安裝不同的硬體的 FreeBSD 機器時，將檔名後方加上機器的主機名稱 (Host name) 是個不錯的方法。以下範例使用 <literal>amd64</literal> 架構的 <filename>GENERIC</filename> 設定檔建立了一個複本名稱為 <filename>MYKERNEL</filename>：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src/sys/<replaceable>amd64</replaceable>/conf</userinput>
<prompt>#</prompt> <userinput>cp GENERIC <replaceable>MYKERNEL</replaceable></userinput></screen>

    <para>現在可以使用任何 <acronym>ASCII</acronym> 文字編輯器來自訂 <filename><replaceable>MYKERNEL</replaceable></filename>。預設的編輯器為 <application>vi</application>，在 FreeBSD 也內建一個易於初學者使用的編輯器叫做 <application>ee</application>。</para>

    <indexterm xml:lang="en">
      <primary>kernel</primary>
      <secondary>NOTES</secondary>
    </indexterm>
    <indexterm xml:lang="en"><primary>NOTES</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>kernel</primary>
      <secondary>configuration file</secondary>
    </indexterm>

    <para>核心設定檔的格式很簡單，每一行會含有代表裝置 (Device) 或子系統 (Subsystem) 的關鍵字、參數以及簡短的說明。任何在 <literal>#</literal> 符號之後的文字會被當做註解並且略過。要移除核心對某個裝置或子系統的支援，僅需要在代表該裝置或子系統的行前加上 <literal>#</literal> 符號。請不要在您還不了解用途的行前加上或移除 <literal>#</literal> 符號。</para>

    <warning>
      <para>移除對裝置或選項的支援很容易會造成核心損壞。例如，若從核心設定檔 <citerefentry><refentrytitle>ata</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式，那麼使用 <acronym>ATA</acronym> 磁碟驅動程式的系統便會無法開機。因此當您不確定時，請在核心保留該項目的支援。</para>
    </warning>

    <para>除了在設定檔中提供的簡短說明之外，尚有其他的說明在 <filename>NOTES</filename> 檔案中，可在與該架構 <filename>GENERIC</filename> 相同的目錄底下找到。要查看所有架構通用的選項，請參考 <filename>/usr/src/sys/conf/NOTES</filename>。</para>

    <tip>
      <para>當完成自訂的核心設定檔，請備份到 <filename>/usr/src</filename> 位置之外。</para>

      <para>或者，將核心設定檔放在其他地方，然後建立一個符號連結 (Symbolic link) 至該檔案：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src/sys/amd64/conf</userinput>
<prompt>#</prompt> <userinput>mkdir /root/kernels</userinput>
<prompt>#</prompt> <userinput>cp GENERIC /root/kernels/MYKERNEL</userinput>
<prompt>#</prompt> <userinput>ln -s /root/kernels/MYKERNEL</userinput></screen>
    </tip>

    <para>設定檔中可以使用 <literal>include</literal> 指令 (Directive)。該指令可以引用其他設定檔到目前的設定檔，這讓只需根據現有檔案設定做些微調整時更簡單。若只有少量的額外選項或驅動程式需要設定，該指令可引用 <filename>GENERIC</filename> 並設定額外增加的選項，如範例所示：</para>

    <programlisting xml:lang="en">include GENERIC
ident MYKERNEL

options         IPFIREWALL
options         DUMMYNET
options         IPFIREWALL_DEFAULT_TO_ACCEPT
options         IPDIVERT</programlisting>

    <para>使用此方法，設定檔只含有與 <filename>GENERIC</filename> 核心不同的部份。當升級有新功能加入 <filename>GENERIC</filename> 時，也可一併引用，除非特別使用 <literal>nooptions</literal> 或 <literal>nodevice</literal> 選項來排除設定。更詳細的設定檔指令及其說明可在 <citerefentry><refentrytitle>config</refentrytitle><manvolnum>5</manvolnum></citerefentry> 找到。</para>

    <note>
      <para>要產生含有所有可用選項的設定檔，可以 <systemitem class="username">root</systemitem> 執行以下指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src/sys/<replaceable>arch</replaceable>/conf &amp;&amp; make LINT</userinput></screen>
    </note>

<!--
    <indexterm>
      <primary>kernel options</primary>
      <secondary>ident</secondary>
    </indexterm>

This is outdated and specific to one architecture.

    <programlisting>ident          GENERIC</programlisting>

    <para>This is the identification of the kernel.  Change
      this to the new kernel name, such as
      <literal><replaceable>MYKERNEL</replaceable></literal>.
      The value in the <literal>ident</literal> string will
      print when the kernel boots.</para>

    <programlisting>makeoptions     DEBUG=-g          # Build kernel with gdb(1) debug symbols</programlisting>

    <para>This option enables debugging information when passed to
      &man.gcc.1;.</para>

    <programlisting>options          SCHED_ULE         # ULE scheduler</programlisting>

    <para>The default system scheduler for &os;.  Keep this.</para>

    <programlisting>options          INET              # InterNETworking</programlisting>

    <para>Networking support.  This is mandatory as most programs
      require at least loopback networking.</para>

    <programlisting>options          INET6             # IPv6 communications protocols</programlisting>

    <para>This enables the IPv6 communication protocols.</para>

    <programlisting>options          FFS               # Berkeley Fast Filesystem</programlisting>

    <para>This is the basic hard drive file system.  Leave it in if
      the system boots from the hard disk.</para>

    <programlisting>options          SOFTUPDATES       # Enable FFS Soft Updates support</programlisting>

    <para>This option enables Soft Updates in the kernel which helps
      to speed up write access on the disks.  Even when this
      functionality is provided by the kernel, it must be turned on
      for specific disks.  Review the output of &man.mount.8; to
      determine if Soft Updates is enabled.  If the
      <literal>soft-updates</literal> option is not in the output, it
      can be activated using &man.tunefs.8; for existing file systems
      or &man.newfs.8; for new file systems.</para>

    <programlisting>options          UFS_ACL           # Support for access control lists</programlisting>

    <para>This option enables kernel support for access control lists
      (<acronym>ACL</acronym>s).  This relies on the use of extended
      attributes and <acronym>UFS2</acronym>, and the feature is
      described in detail in <xref linkend="fs-acl"/>.
      <acronym>ACL</acronym>s are enabled by default and should not be
      disabled in the kernel if they have been used previously on a
      file system, as this will remove the ACLs, changing the way
      files are protected in unpredictable ways.</para>

    <programlisting>options          UFS_DIRHASH       # Improve performance on big directories</programlisting>

    <para>This option includes functionality to speed up disk
      operations on large directories, at the expense of using
      additional memory.  Keep this for a large server or interactive
      workstation, and remove it from smaller systems where memory is
      at a premium and disk access speed is less important, such as a
      firewall.</para>

    <programlisting>options          MD_ROOT           # MD is a potential root device</programlisting>

    <para>This option enables support for a memory backed virtual disk
      used as a root device.</para>

    <indexterm>
      <primary>kernel options</primary>
      <secondary>NFS</secondary>
    </indexterm>
    <indexterm>
      <primary>kernel options</primary>
      <secondary>NFS_ROOT</secondary>
    </indexterm>
    <programlisting>options          NFSCLIENT         # Network Filesystem Client
options          NFSSERVER         # Network Filesystem Server
options          NFS_ROOT          # NFS usable as /, requires NFSCLIENT</programlisting>

    <para>The network file system (<acronym>NFS</acronym>).  These
      lines can be commented unless the system needs to mount
      partitions from a <acronym>NFS</acronym> file server over
      TCP/IP.</para>

    <indexterm>
      <primary>kernel options</primary>
      <secondary>MSDOSFS</secondary>
    </indexterm>
    <programlisting>options          MSDOSFS           # MSDOS Filesystem</programlisting>

    <para>The &ms-dos; file system.  Unless the system needs to mount
      a DOS formatted hard drive partition at boot time, comment this
      out.  It will be automatically loaded the first time a DOS
      partition is mounted.  The <package>emulators/mtools</package>
      package allows access to DOS floppies without having to mount
      and unmount them and does not require
      <literal>MSDOSFS</literal>.</para>

    <programlisting>options          CD9660            # ISO 9660 Filesystem</programlisting>

    <para>The ISO 9660 file system for CDROMs.  Comment it out if the
      system does not have a CDROM drive or only mounts data CDs
      occasionally since it will be dynamically loaded the first
      time a data CD is mounted.  Audio CDs do not need this file
      system.</para>

    <programlisting>options          PROCFS            # Process filesystem (requires PSEUDOFS)</programlisting>

    <para>The process file system.  This is a <quote>pretend</quote>
      file system mounted on <filename>/proc</filename> which allows
      some programs to provide more information on what processes are
      running.  Use of <literal>PROCFS</literal> is not required under
      most circumstances, as most debugging and monitoring tools have
      been adapted to run without <literal>PROCFS</literal>.  The
      default installation will not mount this file system by
      default.</para>

    <programlisting>options          PSEUDOFS          # Pseudo-filesystem framework</programlisting>

    <para>Kernels making use of <literal>PROCFS</literal> must
      also include support for <literal>PSEUDOFS</literal>.</para>

    <programlisting>options          GEOM_PART_GPT     # GUID Partition Tables.</programlisting>

    <para>Adds support for <link
	xlink:href="http://en.wikipedia.org/wiki/GUID_Partition_Table">GUID
	Partition Tables</link> (<acronym>GPT</acronym>).  GPT
      provides the ability to have a large number of partitions per
      disk, 128 in the standard configuration.</para>

    <programlisting>options          COMPAT_43         # Compatible with BSD 4.3 [KEEP THIS!]</programlisting>

    <para>Compatibility with 4.3BSD.  Leave this in as some programs
      will act strangely if this is commented out.</para>

    <programlisting>options          COMPAT_FREEBSD4   # Compatible with &os;4</programlisting>

    <para>This option is required to support applications compiled on
      older versions of &os; that use older system call interfaces.
      It is recommended that this option be used on all &i386; systems
      that may run older applications.  Platforms that gained support
      after &os;&nbsp;4.X, such as ia64 and &sparc64;, do not require
      this option.</para>

    <programlisting>options          COMPAT_FREEBSD5   # Compatible with &os;5</programlisting>

    <para>This option is required to support applications compiled on
      &os;&nbsp;5.X versions that use &os;&nbsp;5.X system call
      interfaces.</para>

    <programlisting>options          COMPAT_FREEBSD6   # Compatible with &os;6</programlisting>

    <para>This option is required to support applications compiled on
      &os;&nbsp;6.X versions that use &os;&nbsp;6.X system call
      interfaces.</para>

    <programlisting>options          COMPAT_FREEBSD7   # Compatible with &os;7</programlisting>

    <para>This option is required on &os;&nbsp;8 and above to support
      applications compiled on &os;&nbsp;7.X versions that use
      &os;&nbsp;7.X system call interfaces.</para>

    <programlisting>options          SCSI_DELAY=5000  # Delay (in ms) before probing SCSI</programlisting>

    <para>This causes the kernel to pause for 5 seconds before probing
      each <acronym>SCSI</acronym> device in the system.  If
      <acronym>SCSI</acronym> drives are not recognized, increase the
      number.  If the system does not have any <acronym>SCSI</acronym>
      drives, this value can be ignored or decreased to speed up
      booting.</para>

    <programlisting>options          KTRACE            # ktrace(1) support</programlisting>

    <para>This enables kernel process tracing, which is useful in
      debugging.</para>

    <programlisting>options          SYSVSHM           # SYSV-style shared memory</programlisting>

    <para>This option provides for System&nbsp;V shared memory.  The
      most common use of this is the XSHM extension in X, which many
      graphics-intensive programs will automatically take advantage of
      for extra speed.  If <application>Xorg</application> is
      installed, include this.</para>

    <programlisting>options          SYSVMSG           # SYSV-style message queues</programlisting>

    <para>Support for System&nbsp;V messages.  This option only adds
      a few hundred bytes to the kernel.</para>

    <programlisting>options          SYSVSEM           # SYSV-style semaphores</programlisting>

    <para>Support for System&nbsp;V semaphores.  Less commonly used,
      but only adds a few hundred bytes to the kernel.</para>

    <note>
      <para>Using <option>-p</option> with &man.ipcs.1; will list any
	processes using each of these System&nbsp;V facilities.</para>
    </note>

    <programlisting>options 	     _KPOSIX_PRIORITY_SCHEDULING # POSIX P1003_1B real-time extensions</programlisting>

    <para>Real-time extensions added in the 1993 &posix;.  Certain
      applications in the Ports Collection use these.</para>

    <programlisting>options          KBD_INSTALL_CDEV  # install a CDEV entry in /dev</programlisting>

    <para>This option is required to allow the creation of keyboard
      device nodes in <filename>/dev</filename>.</para>

    <indexterm>
      <primary>kernel options</primary>
      <secondary>SMP</secondary>
    </indexterm>
    <programlisting>device          apic               # I/O APIC</programlisting>

    <para>This device enables the use of the I/O APIC for interrupt
      delivery.  It can be used in both uni-processor and SMP kernels,
      but is required for SMP kernels.  Add <literal>options
	SMP</literal> to include support for multiple
      processors.</para>

    <note>
      <para>This device exists only on the &i386; architecture and
	this configuration line should not be used on other
	architectures.</para>
    </note>

    <programlisting>device          eisa</programlisting>

    <para>Include this for systems with an EISA motherboard.  This
      enables auto-detection and configuration support for all devices
      on the EISA bus.</para>

    <programlisting>device          pci</programlisting>

    <para>Include this for systems with a PCI motherboard.  This
      enables auto-detection of PCI cards and gatewaying from the PCI
      to ISA bus.</para>

    <programlisting># Floppy drives
device          fdc</programlisting>

    <para>This is the floppy drive controller.</para>

    <programlisting># ATA and ATAPI devices
device          ata</programlisting>

    <para>This driver supports all ATA and ATAPI devices.  Only
      one <literal>device ata</literal> line is needed for the kernel
      to detect all PCI ATA/ATAPI devices on modern machines.</para>

    <programlisting>device          atadisk                 # ATA disk drives</programlisting>

    <para>This is needed along with <literal>device ata</literal> for
      ATA disk drives.</para>

    <programlisting>device          ataraid                 # ATA RAID drives</programlisting>

    <para>This is needed along with <literal>device ata</literal>
      for ATA RAID drives.</para>

    <programlisting><anchor xml:id="kernelconfig-atapi"/>
device          atapicd                 # ATAPI CDROM drives</programlisting>

    <para>This is needed along with <literal>device ata</literal>
      for ATAPI CDROM drives.</para>

    <programlisting>device          atapifd                 # ATAPI floppy drives</programlisting>

    <para>This is needed along with <literal>device ata</literal> for
      ATAPI floppy drives.</para>

    <programlisting>device          atapist                 # ATAPI tape drives</programlisting>

    <para>This is needed along with <literal>device ata</literal> for
      ATAPI tape drives.</para>

    <programlisting>options         ATA_STATIC_ID           # Static device numbering</programlisting>

    <para>This makes the controller number static.  Without this, the
      device numbers are dynamically allocated.</para>

    <programlisting># SCSI Controllers
device          ahb        # EISA AHA1742 family
device          ahc        # AHA2940 and onboard AIC7xxx devices
options         AHC_REG_PRETTY_PRINT    # Print register bitfields in debug
                                        # output.  Adds ~128k to driver.
device          ahd        # AHA39320/29320 and onboard AIC79xx devices
options         AHD_REG_PRETTY_PRINT    # Print register bitfields in debug
                                        # output.  Adds ~215k to driver.
device          amd        # AMD 53C974 (Teckram DC-390(T))
device          isp        # Qlogic family
#device         ispfw      # Firmware for QLogic HBAs- normally a module
device          mpt        # LSI-Logic MPT-Fusion
#device         ncr        # NCR/Symbios Logic
device          sym        # NCR/Symbios Logic (newer chipsets + those of `ncr')
device          trm        # Tekram DC395U/UW/F DC315U adapters

device          adv        # Advansys SCSI adapters
device          adw        # Advansys wide SCSI adapters
device          aha        # Adaptec 154x SCSI adapters
device          aic        # Adaptec 15[012]x SCSI adapters, AIC-6[23]60.
device          bt         # Buslogic/Mylex MultiMaster SCSI adapters

device          ncv        # NCR 53C500
device          nsp        # Workbit Ninja SCSI-3
device          stg        # TMC 18C30/18C50</programlisting>

    <para>In this section, comment out any SCSI controllers not on
      the system.  For an IDE only system, these lines can be removed.
      The <literal>*_REG_PRETTY_PRINT</literal> lines are
      debugging options for their respective drivers.</para>

    <programlisting># SCSI peripherals
device          scbus      # SCSI bus (required for SCSI)
device          ch         # SCSI media changers
device          da         # Direct Access (disks)
device          sa         # Sequential Access (tape etc)
device          cd         # CD
device          pass       # Passthrough device (direct SCSI access)
device          ses        # SCSI Environmental Services (and SAF-TE)</programlisting>

    <para>Comment out any SCSI peripherals not on the system.  If
      the system only has IDE hardware, these lines can be removed
      completely.</para>

    <note>
      <para>The USB &man.umass.4; driver and a few other drivers use
	the SCSI subsystem even though they are not real SCSI devices.
	Do not remove SCSI support if any such drivers are included in
	the kernel configuration.</para>
    </note>

    <programlisting># RAID controllers interfaced to the SCSI subsystem
device          amr        # AMI MegaRAID
device          arcmsr     # Areca SATA II RAID
device          asr        # DPT SmartRAID V, VI and Adaptec SCSI RAID
device          ciss       # Compaq Smart RAID 5*
device          dpt        # DPT Smartcache III, IV - See NOTES for options
device          hptmv      # Highpoint RocketRAID 182x
device          hptrr      # Highpoint RocketRAID 17xx, 22xx, 23xx, 25xx
device          iir        # Intel Integrated RAID
device          ips        # IBM (Adaptec) ServeRAID
device          mly        # Mylex AcceleRAID/eXtremeRAID
device          twa        # 3ware 9000 series PATA/SATA RAID

# RAID controllers
device          aac        # Adaptec FSA RAID
device          aacp       # SCSI passthrough for aac (requires CAM)
device          ida        # Compaq Smart RAID
device          mfi        # LSI MegaRAID SAS
device          mlx        # Mylex DAC960 family
device          pst        # Promise Supertrak SX6000
device          twe        # 3ware ATA RAID</programlisting>

    <para>Supported RAID controllers.  If the system does not have any
      of these, comment them out or remove them.</para>

    <programlisting># atkbdc0 controls both the keyboard and the PS/2 mouse
device          atkbdc     # AT keyboard controller</programlisting>

    <para>The <literal>atkbdc</literal> keyboard controller provides
      I/O services for the AT keyboard and PS/2 style pointing
      devices.  This controller is required by &man.atkbd.4; and
      &man.psm.4;.</para>

    <programlisting>device          atkbd      # AT keyboard</programlisting>

    <para>The &man.atkbd.4; driver, together with the &man.atkbdc.4;
      controller, provides access to the AT 84 keyboard or the AT
      enhanced keyboard which is connected to the AT keyboard
      controller.</para>

    <programlisting>device          psm        # PS/2 mouse</programlisting>

    <para>Use this device if the mouse plugs into the PS/2 mouse
      port.</para>

    <programlisting>device          kbdmux        # keyboard multiplexer</programlisting>

    <para>Basic support for keyboard multiplexing.  If the system
      does not use more than one keyboard, this line can be safely
      removed.</para>

    <programlisting>device          vga        # VGA video card driver</programlisting>

    <para>The &man.vga.4; video card driver.</para>

    <programlisting>device          splash     # Splash screen and screen saver support</programlisting>

    <para>Required by the boot splash screen and screen savers.</para>

    <programlisting># syscons is the default console driver, resembling a SCO console
device          sc</programlisting>

    <para>&man.sc.4; is the default console driver and resembles a SCO
      console.  Since most full-screen programs access the console
      through a terminal database library like
      <filename>termcap</filename>, it should not matter whether
      this or <literal>vt</literal>, the
      <literal>VT220</literal> compatible console driver, is used.
      When a user logs in, the <envar>TERM</envar> variable can be set
      to <literal>scoansi</literal> if full-screen programs have
      trouble running under this console.</para>

    <programlisting># Enable this for the pcvt (VT220 compatible) console driver
#device          vt
#options         XSERVER          # support for X server on a vt console
#options         FAT_CURSOR       # start with block cursor</programlisting>

    <para>This is a VT220-compatible console driver, backward
      compatible to VT100/102.  It works well on some laptops which
      have hardware incompatibilities with <literal>sc</literal>.
      Users may need to set <envar>TERM</envar> to
      <literal>vt100</literal> or <literal>vt220</literal> after
      login.  This driver is useful when connecting to a large number
      of different machines over the network, where
      <filename>termcap</filename> or <filename>terminfo</filename>
      entries for the <literal>sc</literal> device are not
      available as <literal>vt100</literal> should be available
      on virtually any platform.</para>

    <programlisting>device          agp</programlisting>

    <para>Include this if the system has an AGP card.  This will
      enable support for AGP and AGP GART for boards which have these
      features.</para>

    <programlisting># Add suspend/resume support for the i8254.
device           pmtimer</programlisting>

    <para>Timer device driver for power management events, such as
      APM and ACPI.</para>

    <programlisting># PCCARD (PCMCIA) support
# PCMCIA and cardbus bridge support
device          cbb               # cardbus (yenta) bridge
device          pccard            # PC Card (16-bit) bus
device          cardbus           # CardBus (32-bit) bus</programlisting>

    <para>PCMCIA support.  Keep this on laptop systems.</para>

    <programlisting># Serial (COM) ports
device          sio               # 8250, 16[45]50 based serial ports</programlisting>

    <para>These are the serial ports referred to as
      <filename>COM</filename> ports in &windows;.</para>

    <note>
      <para>If the system has an internal modem on
	<filename>COM4</filename> and a serial port at
	<filename>COM2</filename>, change the IRQ of the modem to
	2.  For a multiport serial card, refer to &man.sio.4; for more
	information on the proper values to add to
	<filename>/boot/device.hints</filename>.  Some video cards,
	notably those based on S3 chips, use I/O addresses in the
	form of <literal>0x*2e8</literal>.  Since many cheap serial
	cards do not fully decode the 16-bit I/O address space, they
	clash with these cards, making the
	<filename>COM4</filename> port practically
	unavailable.</para>

      <para>Each serial port is required to have a unique IRQ and the
	default IRQs for <filename>COM3</filename> and
	<filename>COM4</filename> cannot be used.  The exception
	is multiport cards where shared interrupts are
	supported.</para>
    </note>

    <programlisting># Parallel port
device          ppc</programlisting>

    <para>This is the ISA bus parallel port interface.</para>

    <programlisting>device          ppbus      # Parallel port bus (required)</programlisting>

    <para>Provides support for the parallel port bus.</para>

    <programlisting>device          lpt        # Printer</programlisting>

    <para>Adds support for parallel port printers.</para>

    <note>
      <para>All three of the above are required to enable parallel
	printer support.</para>
    </note>

    <programlisting>device          ppi        # Parallel port interface device</programlisting>

    <para>The general-purpose I/O (<quote>geek port</quote>) +
      IEEE1284 I/O.</para>

    <programlisting>#device         vpo        # Requires scbus and da</programlisting>

    <indexterm><primary>zip drive</primary></indexterm>
    <para>This is for an Iomega Zip drive.  It requires
      <literal>scbus</literal> and <literal>da</literal> support.
      Best performance is achieved with ports in EPP 1.9 mode.</para>

    <programlisting>#device         puc</programlisting>

    <para>Uncomment this device if the system has a
      <quote>dumb</quote> serial or parallel PCI card that is
      supported by the &man.puc.4; glue driver.</para>

    <programlisting># PCI Ethernet NICs.
device          de         # DEC/Intel DC21x4x (<quote>Tulip</quote>)
device          em         # Intel PRO/1000 adapter Gigabit Ethernet Card
device          ixgb       # Intel PRO/10GbE Ethernet Card
device          txp        # 3Com 3cR990 (<quote>Typhoon</quote>)
device          vx         # 3Com 3c590, 3c595 (<quote>Vortex</quote>)</programlisting>

    <para>Various PCI network card drivers.  Comment out or remove
      any of these which are not present in the system.</para>

    <programlisting># PCI Ethernet NICs that use the common MII bus controller code.
# NOTE: Be sure to keep the 'device miibus' line in order to use these NICs!
device          miibus     # MII bus support</programlisting>

    <para>MII bus support is required for some PCI 10/100 Ethernet
      NICs, namely those which use MII-compliant transceivers or
      implement transceiver control interfaces that operate like an
      MII.  Adding <literal>device miibus</literal> to the kernel
      config pulls in support for the generic miibus API and all of
      the PHY drivers, including a generic one for PHYs that are not
      specifically handled by an individual driver.</para>

    <programlisting>device          bce        # Broadcom BCM5706/BCM5708 Gigabit Ethernet
device          bfe        # Broadcom BCM440x 10/100 Ethernet
device          bge        # Broadcom BCM570xx Gigabit Ethernet
device          dc         # DEC/Intel 21143 and various workalikes
device          fxp        # Intel EtherExpress PRO/100B (82557, 82558)
device          lge        # Level 1 LXT1001 gigabit ethernet
device          msk        # Marvell/SysKonnect Yukon II Gigabit Ethernet
device          nge        # NatSemi DP83820 gigabit ethernet
device          nve        # nVidia nForce MCP on-board Ethernet Networking
device          pcn        # AMD Am79C97x PCI 10/100 (precedence over 'lnc')
device          re         # RealTek 8139C+/8169/8169S/8110S
device          rl         # RealTek 8129/8139
device          sf         # Adaptec AIC-6915 (<quote>Starfire</quote>)
device          sis        # Silicon Integrated Systems SiS 900/SiS 7016
device          sk         # SysKonnect SK-984x &amp; SK-982x gigabit Ethernet
device          ste        # Sundance ST201 (D-Link DFE-550TX)
device          stge       # Sundance/Tamarack TC9021 gigabit Ethernet
device          ti         # Alteon Networks Tigon I/II gigabit Ethernet
device          tl         # Texas Instruments ThunderLAN
device          tx         # SMC EtherPower II (83c170 <quote>EPIC</quote>)
device          vge        # VIA VT612x gigabit ethernet
device          vr         # VIA Rhine, Rhine II
device          wb         # Winbond W89C840F
device          xl         # 3Com 3c90x (<quote>Boomerang</quote>, <quote>Cyclone</quote>)</programlisting>

    <para>Drivers that use the MII bus controller code.</para>

    <programlisting># ISA Ethernet NICs.  pccard NICs included.
device          cs         # Crystal Semiconductor CS89x0 NIC
# 'device ed' requires 'device miibus'
device          ed         # NE[12]000, SMC Ultra, 3c503, DS8390 cards
device          ex         # Intel EtherExpress Pro/10 and Pro/10+
device          ep         # Etherlink III based cards
device          fe         # Fujitsu MB8696x based cards
device          ie         # EtherExpress 8/16, 3C507, StarLAN 10 etc.
device          lnc        # NE2100, NE32-VL Lance Ethernet cards
device          sn         # SMC's 9000 series of Ethernet chips
device          xe         # Xircom pccard Ethernet

# ISA devices that use the old ISA shims
#device         le</programlisting>

    <para>ISA Ethernet drivers.  See
      <filename>/usr/src/sys/<replaceable>arch</replaceable>/conf/NOTES</filename>
      for details of which cards are supported by which driver.</para>

    <programlisting># Wireless NIC cards
device          wlan            # 802.11 support</programlisting>

    <para>Generic 802.11 support.  This line is required for wireless
      networking.</para>

    <programlisting>device          wlan_wep        # 802.11 WEP support
device          wlan_ccmp       # 802.11 CCMP support
device          wlan_tkip       # 802.11 TKIP support</programlisting>

    <para>Crypto support for 802.11 devices.  These lines are needed
      on systems which use encryption and 802.11i security
      protocols.</para>

    <programlisting>device          an         # Aironet 4500/4800 802.11 wireless NICs.
device          ath             # Atheros pci/cardbus NIC's
device          ath_hal         # Atheros HAL (Hardware Access Layer)
device          ath_rate_sample # SampleRate tx rate control for ath
device          awi        # BayStack 660 and others
device          ral        # Ralink Technology RT2500 wireless NICs.
device          wi         # WaveLAN/Intersil/Symbol 802.11 wireless NICs.
#device         wl         # Older non 802.11 Wavelan wireless NIC.</programlisting>

    <para>Support for various wireless cards.</para>

    <programlisting># Pseudo devices
device   loop          # Network loopback</programlisting>

    <para>This is the generic loopback device for TCP/IP.  This is
      <emphasis>mandatory</emphasis>.</para>

    <programlisting>device   random        # Entropy device</programlisting>

    <para>Cryptographically secure random number generator.</para>

    <programlisting>device   ether         # Ethernet support</programlisting>

    <para><literal>ether</literal> is only needed if the system has
      an Ethernet card.  It includes generic Ethernet protocol
      code.</para>

    <programlisting>device   sl            # Kernel SLIP</programlisting>

    <para><literal>sl</literal> provides SLIP support.  This has been
      almost entirely supplanted by PPP, which is easier to set up,
      better suited for modem-to-modem connection, and more
      powerful.</para>

    <programlisting>device   ppp           # Kernel PPP</programlisting>

    <para>This is for kernel PPP support for dial-up connections.
      There is also a version of PPP implemented as a userland
      application that uses <literal>tun</literal> and offers more
      flexibility and features such as demand dialing.</para>

    <programlisting>device   tun           # Packet tunnel.</programlisting>

    <para>This is used by the userland PPP software.  See the <link
	linkend="userppp">PPP</link> section of the Handbook for more
      information.</para>

    <programlisting><anchor xml:id="kernelconfig-ptys"/>
device   pty           # Pseudo-ttys (telnet etc)</programlisting>

    <para>This is a <quote>pseudo-terminal</quote> or simulated
      login port.  It is used by incoming <command>telnet</command>
      and <command>rlogin</command> sessions,
      <application>xterm</application>, and some other applications
      such as <application>Emacs</application>.</para>

    <programlisting>device   md            # Memory <quote>disks</quote></programlisting>

    <para>Memory disk pseudo-devices.</para>

    <programlisting>device   gif           # IPv6 and IPv4 tunneling</programlisting>

    <para>This implements IPv6 over IPv4 tunneling, IPv4 over IPv6
      tunneling, IPv4 over IPv4 tunneling, and IPv6 over IPv6
      tunneling.  The <literal>gif</literal> device is
      <quote>auto-cloning</quote>, and will create device nodes as
      needed.</para>

    <programlisting>device   faith         # IPv6-to-IPv4 relaying (translation)</programlisting>

    <para>This pseudo-device captures packets that are sent to it and
      diverts them to the IPv4/IPv6 translation daemon.</para>

    <programlisting># The `bpf' device enables the Berkeley Packet Filter.
# Be aware of the administrative consequences of enabling this!
# Note that 'bpf' is required for DHCP.
device   bpf           # Berkeley packet filter</programlisting>

    <para>The Berkeley Packet Filter pseudo-device allows network
      interfaces to be placed in promiscuous mode, capturing every
      packet on a broadcast network such as an Ethernet network.
      These packets can be captured to disk and or examined using
      &man.tcpdump.1;.</para>

    <note>
      <para>The &man.bpf.4; device is also used by &man.dhclient.8;.
	If DHCP is used, leave this uncommented.</para>
    </note>

    <programlisting># USB support
device          uhci          # UHCI PCI-&gt;USB interface
device          ohci          # OHCI PCI-&gt;USB interface
device          ehci          # EHCI PCI-&gt;USB interface (USB 2.0)
device          usb           # USB Bus (required)
#device         udbp          # USB Double Bulk Pipe devices
device          ugen          # Generic
device          uhid          # <quote>Human Interface Devices</quote>
device          ukbd          # Keyboard
device          ulpt          # Printer
device          umass         # Disks/Mass storage - Requires scbus and da
device          ums           # Mouse
device          ural          # Ralink Technology RT2500USB wireless NICs
device          urio          # Diamond Rio 500 MP3 player
device          uscanner      # Scanners
# USB Ethernet, requires mii
device          aue           # ADMtek USB Ethernet
device          axe           # ASIX Electronics USB Ethernet
device          cdce          # Generic USB over Ethernet
device          cue           # CATC USB Ethernet
device          kue           # Kawasaki LSI USB Ethernet
device          rue           # RealTek RTL8150 USB Ethernet</programlisting>

    <para>Support for various USB devices.</para>

    <programlisting># FireWire support
device          firewire      # FireWire bus code
device          sbp           # SCSI over FireWire (Requires scbus and da)
device          fwe           # Ethernet over FireWire (non-standard!)</programlisting>

    <para>Support for various Firewire devices.</para>

    <para>For more information and additional devices supported by
      &os;, see
      <filename>/usr/src/sys/<replaceable>arch</replaceable>/conf/NOTES</filename>.</para>
      -->

  <!--
  This section refers to ancient hardware.
    <sect2>
      <title>Large Memory Configurations
	(<acronym>PAE</acronym>)</title>

      <indexterm>
	<primary>Physical Address Extensions
	    (<acronym>PAE</acronym>)</primary>
	  <secondary>large memory</secondary>
      </indexterm>

      <para>Large memory configuration machines require access to
	more than the 4 gigabyte limit on User+Kernel Virtual
	Address (<acronym>KVA</acronym>) space.  Due to this
	limitation, Intel added support for 36-bit physical address
	space access in the &pentium; Pro and later line of
	CPUs.</para>

      <para>The Physical Address Extension (<acronym>PAE</acronym>)
	capability of the &intel; &pentium; Pro and later CPUs allows
	memory configurations of up to 64 gigabytes.  &os; provides
	support for this capability via the <option>PAE</option>
	kernel configuration option, available in all current release
	versions of &os;.  Due to the limitations of the Intel memory
	architecture, no distinction is made for memory above or below
	4 gigabytes.  Memory allocated above 4 gigabytes is simply
	added to the pool of available memory.</para>

      <para>To enable <acronym>PAE</acronym> support in the kernel,
	add the following line to the kernel configuration
	file:</para>

      <programlisting>options		    PAE</programlisting>

	<note>
	  <para>The <acronym>PAE</acronym> support in &os; is only
	    available for &intel; IA-32 processors.  It should also be
	    noted that the <acronym>PAE</acronym> support in &os; has
	    not received wide testing, and should be considered beta
	    quality compared to other stable features of &os;.</para>
	</note>

	<para><acronym>PAE</acronym> support in &os; has a few
	  limitations:</para>

	<itemizedlist>
	  <listitem>
	    <para>A process is not able to access more than 4
	      gigabytes of virtual memory space.</para>
	  </listitem>

	  <listitem>
	    <para>Device drivers that do not use the &man.bus.dma.9;
	      interface will cause data corruption in a
	      <acronym>PAE</acronym> enabled kernel and are not
	      recommended for use.  For this reason, a
	      <filename>PAE</filename> kernel configuration file is
	      provided in &os; which excludes all drivers not known to
	      work in a <acronym>PAE</acronym> enabled kernel.</para>
	  </listitem>

	  <listitem>
	    <para>Some system tunables determine memory resource usage
	      by the amount of available physical memory.  Such
	      tunables can unnecessarily over-allocate due to the
	      large memory nature of a <acronym>PAE</acronym> system.
	      One such example is the
	      <varname>kern.maxvnodes</varname> sysctl, which controls
	      the maximum number of vnodes allowed in the kernel.  It
	      is advised to adjust this and other such tunables to a
	      reasonable value.</para>
	  </listitem>

	  <listitem>
	    <para>It might be necessary to increase the kernel virtual
	      address (<acronym>KVA</acronym>) space or to reduce the
	      amount of specific kernel resource that is heavily used
	      in order to avoid <acronym>KVA</acronym> exhaustion.
	      The <option>KVA_PAGES</option> kernel option can be used
	      for increasing the <acronym>KVA</acronym> space.</para>
	  </listitem>
	</itemizedlist>

	<para>For performance and stability concerns, it is advised to
	  consult &man.tuning.7;.  &man.pae.4; contains up-to-date
	  information on &os;'s <acronym>PAE</acronym> support.</para>
      </sect2>
-->
  </sect1>

  <sect1 xml:id="kernelconfig-building">
    <title>編譯與安裝自訂核心</title>

    <para>完成自訂設定檔的編輯並儲存之後，便可依據以下步驟編譯核心的原始碼：</para>

    <procedure>
      <title>編譯核心</title>

      <indexterm xml:lang="en">
	<primary>kernel</primary>
	<secondary>building / installing</secondary>
      </indexterm>

      <step>
	<para>切換至此目錄：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src</userinput></screen>
      </step>

      <step>
	<para>指定自訂核心設定檔的名稱來編譯新的核心：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make buildkernel KERNCONF=<replaceable>MYKERNEL</replaceable></userinput></screen>
      </step>

      <step>
	<para>安裝使用指定核心設定檔所編譯的新核心。此指令將會複製新核心到 <filename>/boot/kernel/kernel</filename> 並將舊核心備份到 <filename>/boot/kernel.old/kernel</filename>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make installkernel KERNCONF=<replaceable>MYKERNEL</replaceable></userinput></screen>
      </step>

      <step>
	<para>關機並重新開機載入新的核心，若發生錯誤請參考 <xref linkend="kernelconfig-noboot"/>。</para>
      </step>
    </procedure>

    <para>預設在自訂核心編譯完成後，所有核心模組也同被重新編譯。要快速更新核心或只編譯自訂的模組，需在開始編譯之前先編輯 <filename>/etc/make.conf</filename>。</para>

    <para>例如，使用以下變數可指定要編譯的模組清單來替代預設編譯所有模組的設定：</para>

    <programlisting xml:lang="en">MODULES_OVERRIDE = linux acpi</programlisting>

    <para>或者，可使用以下變數來從編譯程序中排除要編譯的模組：</para>

    <programlisting xml:lang="en">WITHOUT_MODULES = linux acpi sound</programlisting>

    <para>尚有其他可用的變數，請參考 <citerefentry><refentrytitle>make.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 取得詳細資訊。</para>

    <indexterm xml:lang="en">
      <primary><filename>/boot/kernel.old</filename></primary>
    </indexterm>
  </sect1>

  <sect1 xml:id="kernelconfig-trouble">
    <title>如果發生錯誤</title>

    <para>當編譯自訂核心時可能發生以下四種類型的問題：</para>

    <variablelist>
      <varlistentry>
	<term><command>config</command> 失敗</term>

	<listitem>
	  <para>若 <command>config</command> 失敗，會列出不正確的行號。使用以下訊息為例子，需要與 <filename>GENERIC</filename> 或 <filename>NOTES</filename> 比對來確認第 17 行輸入的內容正確：</para>

	  <screen xml:lang="en">config: line 17: syntax error</screen>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><command>make</command> 失敗</term>

	<listitem>
	  <para>若 <command>make</command> 失敗，通常是因為核心設定檔未提供足夠的資訊讓 <command>config</command> 找到問題。請仔細檢查設定檔，若仍不清楚問題，請寄發電子郵件給 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-questions">FreeBSD general questions mailing list</link> 並附上核心設定檔。</para>
	</listitem>
      </varlistentry>

      <varlistentry xml:id="kernelconfig-noboot">
	<term>無法使用核心開機</term>

	<listitem>
	  <para>若新核心無法開機或無法辨識裝置並不要恐慌！幸好，FreeBSD 有良好的機制可以從不相容的核心復原。只需要在 FreeBSD 開機載入程式 (Boot loader) 選擇要用來開機的核心便可，當系統開機選單出現時選擇 <quote>Escape to a loader prompt</quote> 選項，並在指令提示後輸入 <command>boot <replaceable>kernel.old</replaceable></command> 或替換為任何其他已經知道可以正常開機的核心名稱。</para>

	  <para>使用好的核心開機之後，檢查設定檔並嘗試再編譯一次。<filename>/var/log/messages</filename> 是有用的資源，它在每次成功開機時會記錄核心訊息。同樣的，<citerefentry><refentrytitle>dmesg</refentrytitle><manvolnum>8</manvolnum></citerefentry> 也會印出自本次開機後的核心訊息。</para>

	  <note>
	    <para>在排除核心問題時，請確定留有 <filename>GENERIC</filename> 的複本，或者其他已知可以運作的核心，並使用不同的名稱來確保下次編譯時不會被刪除，這很重要，因此每當新的核心被安裝之後，<filename>kernel.old</filename> 都會被最後安裝的核心覆寫，有可能會無法開機。盡快，透過重新命名將可運作的核心目錄移動到目前運作的核心目錄：</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>mv /boot/kernel <replaceable>/boot/kernel.bad</replaceable></userinput>
<prompt>#</prompt> <userinput>mv /boot/<replaceable>kernel.good</replaceable> /boot/kernel</userinput></screen>
	  </note>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>核心可運作，但 <citerefentry><refentrytitle>ps</refentrytitle><manvolnum>1</manvolnum></citerefentry> 無法運作</term>

	<listitem>
	  <para>若核心版本與系統工具所編譯的版本不同，例如，有一個核心使用 -CURRENT 的原始碼編譯並安裝在 -RELEASE 的系統上，許多系統狀態指令如 <citerefentry><refentrytitle>ps</refentrytitle><manvolnum>1</manvolnum></citerefentry> 及 <citerefentry><refentrytitle>vmstat</refentrytitle><manvolnum>8</manvolnum></citerefentry> 將會無法運作。要修正此問題，請使用與核心相同版本的原始碼樹 (Source tree) <link linkend="makeworld">重新編譯並安裝 World</link>。使用與作業系統其他部份版本不同的核心永遠不會是個好主意。</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </sect1>
</chapter>

    
<!--
    The FreeBSD Documentation Project

    $FreeBSD$
-->
<chapter version="5.0" xml:id="printing">

  <info>
    <title>列印</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Warren</firstname>
	  <surname>Block</surname>
	</personname><contrib>Originally contributed by </contrib>
      </author>
    </authorgroup>
  </info>

  <para>儘管很多人試圖淘汰列印功能，但列印資訊到紙上仍是一個重要的功能。列印由兩個基本元件組成，包含了資料傳送到印表機的方式以及印表機可以理解的資料形式。</para>

  <sect1 xml:id="printing-quick-start">
    <title>快速開始</title>

    <para>基本的列印功能可以快速設定完成，列印機必須能夠列印純 <acronym>ASCII</acronym> 文字。若要列印其他類型的檔案，請參考 <xref linkend="printing-lpd-filters"/>。</para>

    <procedure>
      <step>
	<para>建立一個目錄來儲存要被列印的檔案：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir -p /var/spool/lpd/lp</userinput>
<prompt>#</prompt> <userinput>chown daemon:daemon /var/spool/lpd/lp</userinput>
<prompt>#</prompt> <userinput>chmod 770 /var/spool/lpd/lp</userinput></screen>
      </step>

      <step>
	<para>以 <systemitem class="username">root</systemitem> 建立 <filename>/etc/printcap</filename> 內容如下：</para>

	<programlisting xml:lang="en">lp:\
	<replaceable>:lp=/dev/unlpt0:\</replaceable>  <co xml:id="printing-qs-co-printcap"/>
	:sh:\
	:mx#0:\
	:sd=/var/spool/lpd/lp:\
	:lf=/var/log/lpd-errs:</programlisting>

	<calloutlist>
	  <callout arearefs="printing-qs-co-printcap">
	    <para>此行是針對連接到 <acronym>USB</acronym> 埠的印表機。</para>

	    <para>連接到並列或 <quote>印表器 (Printer)</quote> 埠的印表機要使用：</para>

	    <programlisting xml:lang="en">:lp=/dev/lpt0:\</programlisting>

	    <para>直接連接到網路的印表機要使用：</para>

	    <programlisting xml:lang="en">:lp=:rm=<replaceable>network-printer-name</replaceable>:rp=raw:\</programlisting>

	    <para>替換 <replaceable>network-printer-name</replaceable> 為網路印表機的 <acronym>DNS</acronym> 主機名稱。</para>
	  </callout>
	</calloutlist>
      </step>

      <step>
	<para>編輯 <filename>/etc/rc.conf</filename> 加入下行來開啟 <command>lpd</command>：</para>

	<programlisting xml:lang="en">lpd_enable="YES"</programlisting>

	<para>啟動服務：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service lpd start</userinput>
Starting lpd.</screen>
      </step>

      <step>
	<para>測試列印：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>printf "1. This printer can print.\n2. This is the second line.\n" | lpr</userinput></screen>

	<tip>
	  <para>若列印的兩行未從左邊界開始，而是呈現 <quote>階梯狀 (Stairstep)</quote>，請參考 <xref linkend="printing-lpd-filters-stairstep"/>。</para>
	</tip>

	<para>現在可以使用 <command>lpr</command> 來列印文字檔，只要在指令列給序檔案名稱，或者將輸出使用管線符號 (Pipe) 傳送給 <command>lpr</command>。</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>lpr textfile.txt</userinput>
<prompt>%</prompt> <userinput>ls -lh | lpr</userinput></screen>
      </step>
    </procedure>
  </sect1>

  <sect1 xml:id="printing-connections">
    <title>印表機連線</title>

    <para>印表機有許多方式可以連接到電腦，小型的桌面印表機會直接連接到電腦的 <acronym>USB</acronym> 埠，舊式的印表機會連接到並列 (Parallel) 或 <quote>印表機 (Printer)</quote> 埠，而有一部份印表機則是直接連接網路，讓印表機能夠給多台電腦共享使用，還有少部分印表機則是連接到較罕見的序列 (Serial) 埠。</para>

    <para>FreeBSD 可以與這些類型的印表機溝通。</para>

    <variablelist>
      <varlistentry xml:id="printing-connections-usb">
	<term xml:lang="en"><acronym>USB</acronym></term>

	<listitem>
	  <para><acronym>USB</acronym> 印表機可以連接到電腦上任何可用的 <acronym>USB</acronym> 埠。</para>

	  <para>當 FreeBSD 偵測到 <acronym>USB</acronym> 印表機，會建立兩個裝置項目：<filename>/dev/ulpt0</filename> 以及 <filename>/dev/unlpt0</filename>，傳送到兩者任一裝置的資料都會被轉發到印表機。在每個列印工作完成後 <filename>ulpt0</filename> 便會重設 <acronym>USB</acronym> 埠，重設 <acronym>USB</acronym> 埠可能會在部份印表機造成問題，因此通常可以改使用 <filename>unlpt0</filename>  裝置。<filename>unlpt0</filename> 不會重設 USB 埠。</para>
	</listitem>
      </varlistentry>

      <varlistentry xml:id="printing-connections-parallel">
	<term>並列 (<acronym>IEEE</acronym>-1284)</term>

	<listitem>
	  <para>並列埠裝置使用 <filename>/dev/lpt0</filename>，此裝置不論印表機是否連接上都會存在，它並不會自動偵測。</para>

	  <para>供應商已不再採用這種 <quote>舊式</quote> 連接埠，且有許多電腦甚至已沒有這種連接埠。可以用轉接器來連接並列印表機到 <acronym>USB</acronym> 埠，有了轉接器，並列印表機可以被當作 <acronym>USB</acronym> 印表機使用。有另一種稱作 <emphasis>列印伺服器 (Print server)</emphasis> 的裝置也可用來連接並列印表機到網路。</para>
	</listitem>
      </varlistentry>

      <varlistentry xml:id="printing-connections-serial">
	<term>序列 (RS-232)</term>

	<listitem>
	  <para>序列埠也是另一種舊式連接埠，已很少用在印表機上，除了某些特殊的應用外，纜線、接頭與需要的佈線方式依需求變化性很大。</para>

	  <para>內建在主機板的序列埠的序列裝置名稱為 <filename>/dev/cuau0</filename> 或 <filename>/dev/cuau1</filename>。也有序列 <acronym>USB</acronym> 轉接器可使用，而裝置的的名稱則會是 <filename>/dev/cuaU<replaceable>0</replaceable></filename>。</para>

	  <para>要與序列印表機通訊必須知道數個通訊參數，其中最重要的是 <emphasis>傳輸速率 (Baud rate)</emphasis> 或 <acronym>BPS</acronym> (Bits Per Second) 以及 <emphasis>同位檢查 (Parity)</emphasis>。數值有數種，但一般序列印表機會使用 的傳輸速率是 9600 且無同位檢查。</para>
	</listitem>
      </varlistentry>

      <varlistentry xml:id="printing-connections-network">
	<term>網路</term>

	<listitem>
	  <para>網路印表機可直接連接到區域網路。</para>

	  <para>若印表機透過 <acronym>DHCP</acronym> 分配動態位址，則必須要知道 <acronym>DNS</acronym> 主機名稱，<acronym>DNS</acronym> 應動態更新來讓主機名稱能夠對應到正確的 <acronym>IP</acronym> 位址。指定網路印表機一個靜態的 <acronym>IP</acronym> 位址可避免這個問題。</para>

	  <para>大多數網路印表機可以認得使用 <acronym>LPD</acronym> 通訊協定所送出的列印工作，列印佇列 (Print queue) 的名稱也會在這時指定。部份印表機會依據使用的佇列來決定處理資料的方式，例如 <literal>raw</literal> 佇列會列印原始資料，而 <literal>text</literal> 佇列則會在純文字上增加換行符號 (Carriage return)。</para>

	  <para>大部份網路印表機也可列印直接傳送到埠號 9100 的資料。</para>
	</listitem>
      </varlistentry>
    </variablelist>

    <sect2 xml:id="printing-connections-summary">
      <title>摘要</title>

      <para>有線網路連線通常是安裝最簡單的方式，且可以提供快速的列印。若要直接連接到電腦，較建議使用 <acronym>USB</acronym>，由於較快速、簡單。並列連線仍然可以使用，但有纜線長度與速度上的限制。而序列連線則比較難設定，不同型號的纜線佈線方式不同，且通訊參數如傳輸速率及同位檢查增加了複雜性，所幸序列印表機並不多。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="printing-pdls">
    <title>常見的頁面描述語言</title>

    <para>傳送給印表機的資料必須使用印表機能夠理解的語言，這些語言稱為頁面描述語言 (Page Description Languages) 或 <acronym>PDL</acronym>。</para>

    <variablelist>
      <varlistentry xml:id="print-pdls-ascii">
	<term xml:lang="en"><acronym>ASCII</acronym></term>

	<listitem>
	  <para>純 <acronym>ASCII</acronym> 文字是傳送資料到印表機最簡單的方式，一個字元對應一個要列印的文字：資料中的 <literal>A</literal> 會列印一個 <literal>A</literal> 在頁面。可以使用的格式非常少，沒有辦法選擇字型或者比例間距。強迫使用簡單的純 <acronym>ASCII</acronym> 為的是讓文字可以直接從電腦列印只需一點或甚至不需要編碼或轉譯，列印的結果可直接對應傳送的內容。</para>

	  <para>部份便宜印表機無法列印純 <acronym>ASCII</acronym> 文字，這讓這些印表機較難設定。</para>
	</listitem>
      </varlistentry>

      <varlistentry xml:id="print-pdls-postscript">
	<term xml:lang="en"><trademark class="registered">PostScript</trademark></term>

	<listitem>
	  <para><trademark class="registered">PostScript</trademark> 與 <acronym>ASCII</acronym> 幾乎相反，與簡單的文字不同，<trademark class="registered">PostScript</trademark> 程式語言有一套指令可以繪出最終所要的文件，可以使用不同的字型與圖形，但是，這樣強大的功能是有代價的，繪製頁面需要搛寫程式語言，通常這個程式語言會由應用程式產生，所以使用者是看不到的。</para>

	  <para>便宜的印表機有時會移除 <trademark class="registered">PostScript</trademark>  的相容性來節省成本。</para>
	</listitem>
      </varlistentry>

      <varlistentry xml:id="print-pdls-pcl">
	<term xml:lang="en"><acronym>PCL</acronym> (Printer Command Language)</term>

	<listitem>
	  <para><acronym>PCL</acronym> 由 <acronym>ASCII</acronym> 延伸而來，加入了跳脫序列 (Escape sequence) 來標示格式、選擇字型以及列印圖型。大部份印表機都支援 <acronym>PCL5</acronym>，少數支援較新的 <acronym>PCL6</acronym> 或 <acronym>PCLXL</acronym>，這些後來的版本是 <acronym>PCL5</acronym> 的超集合 (Superset)，並可以提供更快的列印速度。</para>
	</listitem>
      </varlistentry>

      <varlistentry xml:id="print-pdls-host-based">
	<term>以主機為基礎 (Host-Based)</term>

	<listitem>
	  <para>製造商可能會使用簡單的處理器和較小的記憶體來降低印表機的成本，這些印表機無法列印純文字，相反的，文字與圖形會先在機器上的驅動程式畫完後傳送到印表機。這些稱為<emphasis>以主機為基礎 (Host-based)</emphasis> 的印表機。</para>

	  <para>驅動程式與以主機為基礎的印表機通訊通常會透過專用或無文件的通訊協定，這讓這些印表機只能在最常用的作業系統上運作。</para>
	</listitem>
      </varlistentry>
    </variablelist>

    <sect2 xml:id="print-pdls-table">
      <title>轉換 <trademark class="registered">PostScript</trademark> 至其他 <acronym>PDL</acronym></title>

      <para>Port 套件集與 FreeBSD 工具集有許多可以處理 <trademark class="registered">PostScript</trademark> 輸出的應用程式，此表整理出了可轉換 <trademark class="registered">PostScript</trademark> 成其他常用 <acronym>PDL</acronym> 的工具：</para>

      <table xml:id="print-pdls-ps-to-other-tbl" frame="none">
	<title>輸出 <acronym>PDL</acronym> 格式</title>

	<tgroup cols="3" align="left">
	  <thead>
	    <row>
	      <entry align="left">輸出 <acronym>PDL</acronym></entry>
	      <entry align="left">產生由</entry>
	      <entry align="left">說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry><acronym>PCL</acronym> 或 <acronym>PCL5</acronym></entry>
	      <entry xml:lang="en"><package role="port">print/ghostscript9-base</package></entry>
	      <entry>單色使用 <literal>-sDEVICE=ljet4</literal>、彩色使用 <literal>-sDEVICE=cljet5</literal></entry>
	    </row>

	    <row>
	      <entry><acronym>PCLXL</acronym> 或 <acronym>PCL6</acronym></entry>
	      <entry xml:lang="en"><package role="port">print/ghostscript9-base</package></entry>
	      <entry>單色使用 <literal>-sDEVICE=pxlmono</literal>、彩色使用 <literal>-sDEVICE=pxlcolor</literal></entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><acronym>ESC/P2</acronym></entry>
	      <entry xml:lang="en"><package role="port">print/ghostscript9-base</package></entry>
	      <entry xml:lang="en"><literal>-sDEVICE=uniprint</literal></entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><acronym>XQX</acronym></entry>
	      <entry xml:lang="en"><package role="port">print/foo2zjs</package></entry>
	      <entry/>
	    </row>
	  </tbody>
	</tgroup>
      </table>
    </sect2>

    <sect2 xml:id="print-pdls-summary">
      <title>摘要</title>

      <para>要可以列印最簡單的方式就是選擇支援 <trademark class="registered">PostScript</trademark> 的印表機，再來是支援 <acronym>PCL</acronym> 的印表機，有了 <package role="port">print/ghostscript9-base</package> 這些印表機也可像原生支援 <trademark class="registered">PostScript</trademark> 的印表機一般使用。有直接支援 <trademark class="registered">PostScript</trademark> 或 <acronym>PCL</acronym> 的印表機通常也會直接支援純 <acronym>ASCII</acronym> 文字檔案。</para>

      <para>行列式印表機如同典型的噴墨式印表機通常不支援 <trademark class="registered">PostScript</trademark> 或 <acronym>PCL</acronym>，這種印表機通常可以列印純 <acronym>ASCII</acronym> 文字檔案。<package role="port">print/ghostscript9-base</package> 支援部份這種印表機使用的 <acronym>PDL</acronym>，不過要在這種印表機上列印完全以圖型為基礎的頁面通常會非常緩慢，由於需要傳送大量的資料並列印。</para>

      <para>以主機為基礎的印表機通常較難設定，有些會因為用了專用的 <acronym>PDL</acronym> 而無法使用，盡可能避免使用這類的印表機。</para>

      <para>有關各種 <acronym>PDL</acronym> 的介紹可至 <link xlink:href="http://www.undocprint.org/formats/page_description_languages"/>。各種型號印表機所使用的特定 <acronym>PDL</acronym> 可至 <link xlink:href="http://www.openprinting.org/printers"/> 查詢。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="printing-direct">
    <title>直接列印</title>

    <para>對於偶爾列印，檔案可以直接傳送到印表機裝置，無需做任何設定。例如，要傳送一個名稱為 <filename>sample.txt</filename> 的檔案到 <acronym>USB</acronym> 印表機：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>cp sample.txt /dev/unlpt0</userinput></screen>

    <para>要直接使用網路印表機列印需看該印表機支援的功能，但大多數會接受埠號 9100 的列印作業，可使用 <citerefentry><refentrytitle>nc</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來完成。要使用 <acronym>DNS</acronym> 主機名稱為 <replaceable>netlaser</replaceable> 的印表機列印與上述相同的檔案可：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>nc <replaceable>netlaser</replaceable> 9100 &lt; sample.txt</userinput></screen>
  </sect1>

  <sect1 xml:id="printing-lpd">
    <title><acronym>LPD</acronym> (行列式印表機 Daemon)</title>

    <para>在背景列印一個檔案稱作 <emphasis>Spooling</emphasis>，緩衝程式 (Spooler) 讓使用者能夠繼續執行電腦的其他程式而不需要等候印表機緩慢的完成列印工作。</para>

    <para>FreeBSD 內含的緩衝程式 (Spooler) 稱作 <citerefentry><refentrytitle>lpd</refentrytitle><manvolnum>8</manvolnum></citerefentry>，而列印工作會使用 <citerefentry><refentrytitle>lpr</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來提交。</para>

    <sect2 xml:id="printing-lpd-setup">
      <title>初始設定</title>

      <para>建立要用來儲存列印工作的目錄、設定擁有關係以及權限來避免其他使用者可以檢視這些檔案的內容：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir -p /var/spool/lpd/lp</userinput>
<prompt>#</prompt> <userinput>chown daemon:daemon /var/spool/lpd/lp</userinput>
<prompt>#</prompt> <userinput>chmod 770 /var/spool/lpd/lp</userinput></screen>

      <para>印表機會定義在 <filename>/etc/printcap</filename>，每台印表機項目所包含的詳細資料有名稱、連接的接頭以及各種其他設定。建立 <filename>/etc/printcap</filename> 使用以下內容：</para>

      <programlisting xml:lang="en">lp:\				<co xml:id="printing-lpd-co-name"/>
	:lp=/dev/unlpt0:\	<co xml:id="printing-lpd-co-device"/>
	:sh:\			<co xml:id="printing-lpd-co-header"/>
	:mx#0:\			<co xml:id="printing-lpd-co-mx"/>
	:sd=/var/spool/lpd/lp:\	<co xml:id="printing-lpd-co-sd"/>
	:lf=/var/log/lpd-errs:	<co xml:id="printing-lpd-co-lf"/></programlisting>

      <calloutlist>
	<callout arearefs="printing-lpd-co-name">
	  <para>印表機的名稱。 <citerefentry><refentrytitle>lpr</refentrytitle><manvolnum>1</manvolnum></citerefentry> 會傳送列印工作到 <literal>lp</literal> 印表機，除非有使用 <option>-P</option> 來指定其他印表機，所以預的印表機名稱應使用 <literal>lp</literal>。</para>
	</callout>

	<callout arearefs="printing-lpd-co-device">
	  <para>印表機所連接到裝置。替換此行為正確的連線類型，如此處所示。</para>

	  <informaltable xml:id="printing-lpd-co-device-tbl">
	    <tgroup cols="2">
	      <thead>
		<row>
		  <entry>連線類型</entry>
		  <entry>在 <filename>/etc/printcap</filename> 的裝置項目</entry>
		</row>
	      </thead>

	      <tbody>
		<row>
		  <entry xml:lang="en"><acronym>USB</acronym></entry>
		  <entry><programlisting xml:lang="en">:lp=/dev/unlpt0:\</programlisting>

		    <para>此為<emphasis>不會重設</emphasis> <acronym>USB</acronym> 印表機的裝置，若使用上發生問題，請改使用 <filename>ulpt0</filename>，這個裝置會在每次使用後重設 <acronym>USB</acronym> 埠。</para></entry>
		</row>

		<row>
		  <entry>並列</entry>
		  <entry><programlisting xml:lang="en">:lp=/dev/lpt0:\</programlisting></entry>
		</row>

		<row>
		  <entry>網路</entry>

		  <entry><para>針對支援 <acronym>LPD</acronym> 通訊協定的印表機：</para>

		    <programlisting xml:lang="en">:lp=:rm=<replaceable>network-printer-name</replaceable>:rp=raw:\</programlisting>

		    <para>針對支援使用埠號 9100 列印的印表機：</para>

		    <programlisting xml:lang="en">:lp=9100@<replaceable>network-printer-name</replaceable>:\</programlisting>

		    <para>針對兩者皆支援的印表機，請替換 <replaceable>network-printer-name</replaceable> 為網路印表機的 <acronym>DNS</acronym> 主機名稱。</para></entry>
		</row>

		<row>
		  <entry>序列</entry>
		  <entry><programlisting xml:lang="en">:lp=/dev/cuau0:br=9600:pa=none:\</programlisting>

		    <para>這些是一般序列印表機連接到主機板序列埠會採用的數值，傳輸速率 (Baud rate) 是 9600 且無同位檢查 (No Parity)。</para></entry>
		</row>
	      </tbody>
	    </tgroup>
	  </informaltable>
	</callout>

	<callout arearefs="printing-lpd-co-header">
	  <para>在列印工作開始時不列印首頁。</para>
	</callout>

	<callout arearefs="printing-lpd-co-mx">
	  <para>不限制列印工作的最大尺寸。</para>
	</callout>

	<callout arearefs="printing-lpd-co-sd">
	  <para>此印表機的緩衝 (Spooling) 目錄路徑，每台印表機會自己使用一個獨立的緩衝 (Spooling) 目錄。</para>
	</callout>

	<callout arearefs="printing-lpd-co-lf">
	  <para>回報此印表機的錯誤的日誌檔。</para>
	</callout>
      </calloutlist>

      <para>在建立 <filename>/etc/printcap</filename> 之後，使用 <citerefentry><refentrytitle>chkprintcap</refentrytitle><manvolnum>8</manvolnum></citerefentry> 測試印表機是否有錯誤：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>chkprintcap</userinput></screen>

      <para>在繼續之前修正任何回報的問題。</para>

      <para>開啟 <filename>/etc/rc.conf</filename> 中的 <citerefentry><refentrytitle>lpd</refentrytitle><manvolnum>8</manvolnum></citerefentry>：</para>

      <programlisting xml:lang="en">lpd_enable="YES"</programlisting>

      <para>啟動服務：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service lpd start</userinput></screen>
    </sect2>

    <sect2 xml:id="printing-lpd-lpr">
      <title>使用 <citerefentry><refentrytitle>lpr</refentrytitle><manvolnum>1</manvolnum></citerefentry> 列印</title>

      <para xml:lang="en">Documents are sent to the printer with
	<command>lpr</command>.  A file to be printed can be named on
	the command line or piped into <command>lpr</command>.  These
	two commands are equivalent, sending the contents of
	<filename>doc.txt</filename> to the default printer:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>lpr doc.txt</userinput>
<prompt>%</prompt> <userinput>cat doc.txt | lpr</userinput></screen>

      <para xml:lang="en">Printers can be selected with <option>-P</option>.  To
	print to a printer called
	<replaceable>laser</replaceable>:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>lpr -Plaser doc.txt</userinput></screen>
    </sect2>

    <sect2 xml:id="printing-lpd-filters">
      <title>過濾器</title>

      <para xml:lang="en">The examples shown so far have sent the contents of a text
	file directly to the printer.  As long as the printer
	understands the content of those files, output will be printed
	correctly.</para>

      <para xml:lang="en">Some printers are not capable of printing plain text, and
	the input file might not even be plain text.</para>

      <para xml:lang="en"><emphasis>Filters</emphasis> allow files to be
	translated or processed.  The typical use is to translate one
	type of input, like plain text, into a form that the printer
	can understand, like <trademark class="registered">PostScript</trademark> or <acronym>PCL</acronym>.
	Filters can also be used to provide additional features, like
	adding page numbers or highlighting source code to make it
	easier to read.</para>

      <para xml:lang="en">The filters discussed here are
	<emphasis>input filters</emphasis> or
	<emphasis>text filters</emphasis>.  These filters convert the
	incoming file into different forms.  Use <citerefentry><refentrytitle>su</refentrytitle><manvolnum>1</manvolnum></citerefentry> to become
	<systemitem class="username">root</systemitem> before
	creating the files.</para>

      <para xml:lang="en">Filters are specified in
	<filename>/etc/printcap</filename> with the
	<literal>if=</literal> identifier.  To use
	<filename>/usr/local/libexec/lf2crlf</filename> as a filter,
	modify <filename>/etc/printcap</filename> like this:</para>

      <programlisting xml:lang="en">lp:\
	:lp=/dev/unlpt0:\
	:sh:\
	:mx#0:\
	:sd=/var/spool/lpd/lp:\
	:if=/usr/local/libexec/lf2crlf:\   <co xml:id="printing-lpd-filters-co-if"/>
	:lf=/var/log/lpd-errs:</programlisting>

      <calloutlist>
	<callout arearefs="printing-lpd-filters-co-if">
	  <para xml:lang="en"><literal>if=</literal> identifies the
	    <emphasis>input filter</emphasis> that will be used on
	    incoming text.</para>
	</callout>
      </calloutlist>

      <tip xml:id="printing-lpd-filters-oneline">
	<para xml:lang="en">The backslash <emphasis>line continuation</emphasis>
	  characters at the end of the lines in
	  <filename>printcap</filename> entries reveal that an entry
	  for a printer is really just one long line with entries
	  delimited by colon characters.  An earlier example can be
	  rewritten as a single less-readable line:</para>

	<programlisting xml:lang="en">lp:lp=/dev/unlpt0:sh:mx#0:sd=/var/spool/lpd/lp:if=/usr/local/libexec/lf2crlf:lf=/var/log/lpd-errs:</programlisting>
      </tip>

      <sect3 xml:id="printing-lpd-filters-stairstep">
	<title>避免在純文字印表機階梯狀列印</title>

	<para xml:lang="en">Typical FreeBSD text files contain only a single line feed
	  character at the end of each line.  These lines will
	  <quote>stairstep</quote> on a standard printer:</para>

	<programlisting xml:lang="en">A printed file looks
                    like the steps of a staircase
                                                 scattered by the wind</programlisting>

	<para xml:lang="en">A filter can convert the newline characters into
	  carriage returns and newlines.  The carriage returns make
	  the printer return to the left after each line.  Create
	  <filename>/usr/local/libexec/lf2crlf</filename> with these
	  contents:</para>

	<programlisting xml:lang="en">#!/bin/sh
CR=$'\r'
/usr/bin/sed -e "s/$/${CR}/g"</programlisting>

	<para xml:lang="en">Set the permissions and make it executable:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>chmod 555 /usr/local/libexec/lf2crlf</userinput></screen>

	<para xml:lang="en">Modify <filename>/etc/printcap</filename> to use the
	  new filter:</para>

	<programlisting xml:lang="en">:if=/usr/local/libexec/lf2crlf:\</programlisting>

	<para xml:lang="en">Test the filter by printing the same plain text file.
	  The carriage returns will cause each line to start at the
	  left side of the page.</para>
      </sect3>

      <sect3 xml:id="printing-lpd-filters-enscript">
	<title>使用 <package>print/enscript</package> 在 <trademark class="registered">PostScript</trademark> 印表機美化純文字內容</title>

	<para xml:lang="en"><acronym>GNU</acronym>
	  <application>Enscript</application> converts plain text
	  files into nicely-formatted <trademark class="registered">PostScript</trademark> for printing on
	  <trademark class="registered">PostScript</trademark> printers.  It adds page numbers, wraps long
	  lines, and provides numerous other features to make printed
	  text files easier to read.  Depending on the local paper
	  size, install either
	  <package role="port">print/enscript-letter</package> or
	  <package role="port">print/enscript-a4</package> from the
	  Ports Collection.</para>

	<para xml:lang="en">Create <filename>/usr/local/libexec/enscript</filename>
	  with these contents:</para>

	<programlisting xml:lang="en">#!/bin/sh
/usr/local/bin/enscript -o -</programlisting>

	<para xml:lang="en">Set the permissions and make it executable:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>chmod 555 /usr/local/libexec/enscript</userinput></screen>

	<para xml:lang="en">Modify <filename>/etc/printcap</filename> to use the
	  new filter:</para>

	<programlisting xml:lang="en">:if=/usr/local/libexec/enscript:\</programlisting>

	<para xml:lang="en">Test the filter by printing a plain text file.</para>
      </sect3>

      <sect3 xml:id="printing-lpd-filters-ps2pcl">
	<title>列印 <trademark class="registered">PostScript</trademark> 到 <acronym>PCL</acronym> 印表機</title>

	<para xml:lang="en">Many programs produce <trademark class="registered">PostScript</trademark> documents.
	  However, inexpensive printers often only understand plain
	  text or <acronym>PCL</acronym>.  This filter converts
	  <trademark class="registered">PostScript</trademark> files to <acronym>PCL</acronym> before sending
	  them to the printer.</para>

	<para>由 Port 套件集安裝 Ghostscript <trademark class="registered">PostScript</trademark> 直譯器，<package role="port">print/ghostscript9-base</package>。</para>

	<para xml:lang="en">Create <filename>/usr/local/libexec/ps2pcl</filename>
	  with these contents:</para>

	<programlisting xml:lang="en">#!/bin/sh
/usr/local/bin/gs -dSAFER -dNOPAUSE -dBATCH -q -sDEVICE=ljet4 -sOutputFile=- -</programlisting>

	<para xml:lang="en">Set the permissions and make it executable:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>chmod 555 /usr/local/libexec/ps2pcl</userinput></screen>

	<para xml:lang="en"><trademark class="registered">PostScript</trademark> input sent to this script will be rendered
	  and converted to <acronym>PCL</acronym> before being sent on
	  to the printer.</para>

	<para xml:lang="en">Modify <filename>/etc/printcap</filename> to use this
	  new input filter:</para>

	<programlisting xml:lang="en">:if=/usr/local/libexec/ps2pcl:\</programlisting>

	<para xml:lang="en">Test the filter by sending a small <trademark class="registered">PostScript</trademark> program
	  to it:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>printf "%%\!PS \n /Helvetica findfont 18 scalefont setfont \
72 432 moveto (PostScript printing successful.) show showpage \004" | lpr</userinput></screen>
      </sect3>

      <sect3 xml:id="printing-lpd-filters-smart">
	<title>智慧過濾器</title>

	<para xml:lang="en">A filter that detects the type of input and
	  automatically converts it to the correct format for the
	  printer can be very convenient.  The first two characters of
	  a <trademark class="registered">PostScript</trademark> file are usually <literal>%!</literal>.  A
	  filter can detect those two characters.  <trademark class="registered">PostScript</trademark> files
	  can be sent on to a <trademark class="registered">PostScript</trademark> printer unchanged.  Text
	  files can be converted to <trademark class="registered">PostScript</trademark> with
	  <application>Enscript</application> as shown earlier.
	  Create <filename>/usr/local/libexec/psif</filename> with
	  these contents:</para>

	<programlisting xml:lang="en">#!/bin/sh
#
#  psif - Print PostScript or plain text on a PostScript printer
#
IFS="" read -r first_line
first_two_chars=`expr "$first_line" : '\(..\)'`

case "$first_two_chars" in
%!)
    # %! : PostScript job, print it.
    echo "$first_line" &amp;&amp; cat &amp;&amp; exit 0
    exit 2
    ;;
*)
    # otherwise, format with enscript
    ( echo "$first_line"; cat ) | /usr/local/bin/enscript -o - &amp;&amp; exit 0
    exit 2
    ;;
esac</programlisting>

	<para xml:lang="en">Set the permissions and make it executable:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>chmod 555 /usr/local/libexec/psif</userinput></screen>

	<para xml:lang="en">Modify <filename>/etc/printcap</filename> to use this
	  new input filter:</para>

	<programlisting xml:lang="en">:if=/usr/local/libexec/psif:\</programlisting>

	<para xml:lang="en">Test the filter by printing <trademark class="registered">PostScript</trademark> and plain text
	  files.</para>
      </sect3>

      <sect3 xml:id="printing-lpd-filters-othersmart">
	<title>其他智慧過濾器</title>

	<para xml:lang="en">Writing a filter that detects many different types of
	  input and formats them correctly is challenging.
	  <package role="port">print/apsfilter</package> from the
	  Ports Collection is a smart <quote>magic</quote> filter that
	  detects dozens of file types and automatically converts them
	  to the <acronym>PDL</acronym> understood by the printer.
	  See <link xlink:href="http://www.apsfilter.org"/> for
	  more details.</para>
      </sect3>
    </sect2>

    <sect2 xml:id="printing-lpd-queues">
      <title>多序列</title>

      <para xml:lang="en">The entries in <filename>/etc/printcap</filename> are
	really definitions of <emphasis>queues</emphasis>.  There can
	be more than one queue for a single printer.  When combined
	with filters, multiple queues provide users more control over
	how their jobs are printed.</para>

      <para xml:lang="en">As an example, consider a networked <trademark class="registered">PostScript</trademark> laser
	printer in an office.  Most users want to print plain text,
	but a few advanced users want to be able to print <trademark class="registered">PostScript</trademark>
	files directly.  Two entries can be created for the same
	printer in <filename>/etc/printcap</filename>:</para>

      <programlisting xml:lang="en">textprinter:\
	:lp=9100@officelaser:\
	:sh:\
	:mx#0:\
	:sd=/var/spool/lpd/textprinter:\
	:if=/usr/local/libexec/enscript:\
	:lf=/var/log/lpd-errs:

psprinter:\
	:lp=9100@officelaser:\
	:sh:\
	:mx#0:\
	:sd=/var/spool/lpd/psprinter:\
	:lf=/var/log/lpd-errs:</programlisting>

      <para xml:lang="en">Documents sent to <literal>textprinter</literal> will be
	formatted by the
	<filename>/usr/local/libexec/enscript</filename> filter shown
	in an earlier example.  Advanced users can print <trademark class="registered">PostScript</trademark>
	files on <literal>psprinter</literal>, where no filtering is
	done.</para>

      <para xml:lang="en">This multiple queue technique can be used to provide
	direct access to all kinds of printer features.  A printer
	with a duplexer could use two queues, one for ordinary
	single-sided printing, and one with a filter that sends the
	command sequence to enable double-sided printing and then
	sends the incoming file.</para>
    </sect2>

    <sect2 xml:id="printing-lpd-monitor">
      <title>監視與控制列印</title>

      <para xml:lang="en">Several utilities are available to monitor print jobs and
	check and control printer operation.</para>

      <sect3 xml:id="printing-lpd-monitor-lpq">
	<title xml:lang="en"><citerefentry><refentrytitle>lpq</refentrytitle><manvolnum>1</manvolnum></citerefentry></title>

	<para xml:lang="en"><citerefentry><refentrytitle>lpq</refentrytitle><manvolnum>1</manvolnum></citerefentry> shows the status of a user's print
	  jobs.  Print jobs from other users are not shown.</para>

	<para xml:lang="en">Show the current user's pending jobs on a single
	  printer:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>lpq -P<replaceable>lp</replaceable></userinput>
Rank   Owner      Job  Files                                 Total Size
1st    jsmith     0    (standard input)                      12792 bytes</screen>

	<para xml:lang="en">Show the current user's pending jobs on all
	  printers:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>lpq -a</userinput>
lp:
Rank   Owner      Job  Files                                 Total Size
1st    jsmith     1    (standard input)                      27320 bytes

laser:
Rank   Owner      Job  Files                                 Total Size
1st    jsmith     287  (standard input)                      22443 bytes</screen>
      </sect3>

      <sect3 xml:id="printing-lpd-monitor-lprm">
	<title xml:lang="en"><citerefentry><refentrytitle>lprm</refentrytitle><manvolnum>1</manvolnum></citerefentry></title>

	<para xml:lang="en"><citerefentry><refentrytitle>lprm</refentrytitle><manvolnum>1</manvolnum></citerefentry> is used to remove print jobs.  Normal users
	  are only allowed to remove their own jobs.
	  <systemitem class="username">root</systemitem> can remove
	  any or all jobs.</para>

	<para xml:lang="en">Remove all pending jobs from a printer:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>lprm -P<replaceable>lp</replaceable> -</userinput>
dfA002smithy dequeued
cfA002smithy dequeued
dfA003smithy dequeued
cfA003smithy dequeued
dfA004smithy dequeued
cfA004smithy dequeued</screen>

	<para xml:lang="en">Remove a single job from a
	  printer.  <citerefentry><refentrytitle>lpq</refentrytitle><manvolnum>1</manvolnum></citerefentry> is used to find the job number.</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>lpq</userinput>
Rank   Owner      Job  Files                                 Total Size
1st    jsmith     5    (standard input)                      12188 bytes
<prompt>%</prompt> <userinput>lprm -P<replaceable>lp</replaceable> <replaceable>5</replaceable></userinput>
dfA005smithy dequeued
cfA005smithy dequeued</screen>
      </sect3>

      <sect3 xml:id="printing-lpd-monitor-lpc">
	<title xml:lang="en"><citerefentry><refentrytitle>lpc</refentrytitle><manvolnum>8</manvolnum></citerefentry></title>

	<para xml:lang="en"><citerefentry><refentrytitle>lpc</refentrytitle><manvolnum>8</manvolnum></citerefentry> is used to check and modify printer status.
	  <literal>lpc</literal> is followed by a command and an
	  optional printer name.  <literal>all</literal> can be used
	  instead of a specific printer name, and the command will be
	  applied to all printers.  Normal users can view status with
	  <citerefentry><refentrytitle>lpc</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  Only
	  <systemitem class="username">root</systemitem> can use
	  commands which modify printer status.</para>

	<para xml:lang="en">Show the status of all printers:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>lpc status all</userinput>
lp:
	queuing is enabled
	printing is enabled
	1 entry in spool area
	printer idle
laser:
	queuing is enabled
	printing is enabled
	1 entry in spool area
	waiting for laser to come up</screen>

	<para xml:lang="en">Prevent a printer from accepting new jobs, then begin
	  accepting new jobs again:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>lpc disable <replaceable>lp</replaceable></userinput>
lp:
	queuing disabled
<prompt>#</prompt> <userinput>lpc enable <replaceable>lp</replaceable></userinput>
lp:
	queuing enabled</screen>

	<para xml:lang="en">Stop printing, but continue to accept new jobs.  Then
	  begin printing again:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>lpc stop <replaceable>lp</replaceable></userinput>
lp:
	printing disabled
<prompt>#</prompt> <userinput>lpc start <replaceable>lp</replaceable></userinput>
lp:
	printing enabled
	daemon started</screen>

	<para xml:lang="en">Restart a printer after some error condition:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>lpc restart <replaceable>lp</replaceable></userinput>
lp:
	no daemon to abort
	printing enabled
	daemon restarted</screen>

	<para xml:lang="en">Turn the print queue off and disable printing, with a
	  message to explain the problem to users:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>lpc down <replaceable>lp</replaceable> Repair parts will arrive on Monday</userinput>
lp:
	printer and queuing disabled
	status message is now: Repair parts will arrive on Monday</screen>

	<para xml:lang="en">Re-enable a printer that is down:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>lpc up <replaceable>lp</replaceable></userinput>
lp:
	printing enabled
	daemon started</screen>

	<para xml:lang="en">See <citerefentry><refentrytitle>lpc</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more commands and options.</para>
      </sect3>
    </sect2>

    <sect2 xml:id="printing-lpd-shared">
      <title>分享印表機</title>

      <para xml:lang="en">Printers are often shared by multiple users in businesses
	and schools.  Additional features are provided to make sharing
	printers more convenient.</para>

      <sect3 xml:id="printing-shared-aliases">
	<title>別名</title>

	<para xml:lang="en">The printer name is set in the first line of the
	  entry in <filename>/etc/printcap</filename>.  Additional
	  names, or <emphasis>aliases</emphasis>, can be added after
	  that name.  Aliases are separated from the name and each
	  other by vertical bars:</para>

	<programlisting xml:lang="en">lp|<replaceable>repairsprinter</replaceable>|<replaceable>salesprinter</replaceable>:\</programlisting>

	<para xml:lang="en">Aliases can be used in place of the printer name.  For
	  example, users in the Sales department print to their
	  printer with</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>lpr -P<replaceable>salesprinter</replaceable> <replaceable>sales-report.txt</replaceable></userinput></screen>

	<para xml:lang="en">Users in the Repairs department print to
	  <emphasis>their</emphasis> printer with</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>lpr -P<replaceable>repairsprinter</replaceable> <replaceable>repairs-report.txt</replaceable></userinput></screen>

	<para xml:lang="en">All of the documents print on that single printer.  When
	  the Sales department grows enough to need their own printer,
	  the alias can be removed from the shared printer entry and
	  used as the name of a new printer.  Users in both
	  departments continue to use the same commands, but the Sales
	  documents are sent to the new printer.</para>
      </sect3>

      <sect3 xml:id="printing-shared-headers">
	<title>頁首</title>

	<para xml:lang="en">It can be difficult for users to locate their documents
	  in the stack of pages produced by a busy shared printer.
	  <emphasis>Header pages</emphasis> were created to solve this
	  problem.  A header page with the user name and document name
	  is printed before each print job.  These pages are also
	  sometimes called <emphasis>banner</emphasis> or
	  <emphasis>separator</emphasis> pages.</para>

	<para xml:lang="en">Enabling header pages differs depending on whether the
	  printer is connected directly to the computer with a
	  <acronym>USB</acronym>, parallel, or serial cable, or
	  is connected remotely over a network.</para>

	<para xml:lang="en">Header pages on directly-connected printers are enabled
	  by removing the <literal>:sh:\</literal> (Suppress Header)
	  line from the entry in <filename>/etc/printcap</filename>.
	  These header pages only use line feed characters for new
	  lines.  Some printers will need the
	  <filename>/usr/share/examples/printing/hpif</filename>
	  filter to prevent stairstepped text.  The filter configures
	  <acronym>PCL</acronym> printers to print both carriage
	  returns and line feeds when a line feed is received.</para>

	<para xml:lang="en">Header pages for network printers must be configured on
	  the printer itself.  Header page entries in
	  <filename>/etc/printcap</filename> are ignored.  Settings
	  are usually available from the printer front panel or a
	  configuration web page accessible with a web browser.</para>
      </sect3>
      <!-- conversion filters?,
	restricting printer usage?, accounting? -->
    </sect2>

    <sect2 xml:id="printing-lpd-references">
      <title>參考文獻</title>

      <para xml:lang="en">Example files: <filename role="directory">/usr/share/examples/printing/</filename>.</para>

      <para xml:lang="en">The <emphasis>4.3BSD Line Printer Spooler
	  Manual</emphasis>,
	<filename>/usr/share/doc/smm/07.lpd/paper.ascii.gz</filename>.</para>

      <para xml:lang="en">Manual pages: <citerefentry><refentrytitle>printcap</refentrytitle><manvolnum>5</manvolnum></citerefentry>, <citerefentry><refentrytitle>lpd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, <citerefentry><refentrytitle>lpr</refentrytitle><manvolnum>1</manvolnum></citerefentry>,
	<citerefentry><refentrytitle>lpc</refentrytitle><manvolnum>8</manvolnum></citerefentry>, <citerefentry><refentrytitle>lprm</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <citerefentry><refentrytitle>lpq</refentrytitle><manvolnum>1</manvolnum></citerefentry>.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="printing-other">
    <title>其他列印系統</title>

    <para xml:lang="en">Several other printing systems are available in
      addition to the built-in <citerefentry><refentrytitle>lpd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  These systems
      offer support for other protocols or additional features.</para>

    <sect2 xml:id="printing-other-cups">
      <title xml:lang="en"><acronym>CUPS</acronym> (Common <trademark class="registered">UNIX</trademark> Printing
	System)</title>

      <para xml:lang="en"><acronym>CUPS</acronym> is a popular printing system
	available on many operating systems.  Using
	<acronym>CUPS</acronym> on FreeBSD is documented in a separate
	article:<link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/cups"/></para>
    </sect2>

    <sect2 xml:id="printing-other-hplip">
      <title xml:lang="en">HPLIP</title>

      <para xml:lang="en">Hewlett Packard provides a printing system that supports
	many of their inkjet and laser printers.  The port is
	<package role="port">print/hplip</package>.  The main web page
	is at <link xlink:href="http://hplipopensource.com/hplip-web/index.html"/>.
	The port handles all the installation details on FreeBSD.
	Configuration information is shown at <link xlink:href="http://hplipopensource.com/hplip-web/install/manual/hp_setup.html"/>.</para>
    </sect2>

    <sect2 xml:id="printing-other-lprng">
      <title xml:lang="en">LPRng</title>

      <para xml:lang="en"><application>LPRng</application> was developed as an
	enhanced alternative to <citerefentry><refentrytitle>lpd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  The port is
	<package role="port">sysutils/LPRng</package>.  For details
	and documentation, see
	<link xlink:href="http://www.lprng.com/"/>.</para>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="linuxemu">

  <info>
    <title><trademark class="registered">Linux</trademark> Binary 相容性</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Jim</firstname>
	  <surname>Mock</surname>
	</personname>
	<contrib>Restructured and parts updated by </contrib>
      </author>
      <!-- 22 Mar 2000 -->
    </authorgroup>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Brian N.</firstname>
	  <surname>Handy</surname>
	</personname>
	<contrib>Originally contributed by </contrib>
      </author>

      <author xml:lang="en">
	<personname>
	  <firstname>Rich</firstname>
	  <surname>Murphey</surname>
	</personname>
      </author>
    </authorgroup>
  </info>

  <sect1 xml:id="linuxemu-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en">
      <primary>Linux binary compatibility</primary>
    </indexterm>
    <indexterm><primary>Binary 相容性</primary> <secondary>Linux</secondary></indexterm>

    <para>FreeBSD 提供 <trademark class="registered">Linux</trademark> Binary 的相容性，允許使用者在 FreeBSD 系統上不需要修改就可以安裝和執行大部份的 <trademark class="registered">Linux</trademark> Binary。 曾經有報告指出，在某些情況下，<trademark class="registered">Linux</trademark> Binary 在 FreeBSD 的表現比在 <trademark class="registered">Linux</trademark> 好。</para>

    <para>然而，部份特定在 <trademark class="registered">Linux</trademark> 作業系統上的功能在 FreeBSD 並沒有支援。例如，若 <trademark class="registered">Linux</trademark> Binary 過度的使用 <trademark>i386</trademark> 特定的呼叫，如啟動虛擬 8086 模式，會無法在 FreeBSD 執行。</para>

    <note>
      <para>FreeBSD 10.3 後支援 64 位元的 <trademark class="registered">Linux</trademark> Binary 相容性。</para>
    </note>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>如何在 FreeBSD 系統啟用 <trademark class="registered">Linux</trademark> Binary 相容模式。</para>
      </listitem>

      <listitem>
	<para>如何安裝其他的 <trademark class="registered">Linux</trademark> 共用程式庫。</para>
      </listitem>

      <listitem>
	<para>如何在 FreeBSD 系統安裝 <trademark class="registered">Linux</trademark> 應用程式。</para>
      </listitem>

      <listitem>
	<para>在 FreeBSD 中 <trademark class="registered">Linux</trademark> 相容性的實作細節。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>知道如何安裝 <link linkend="ports">其他的第三方軟體</link>。</para>
      </listitem>
    </itemizedlist>

  </sect1>

  <sect1 xml:id="linuxemu-lbc-install">
    <title>設定 <trademark class="registered">Linux</trademark> Binary 相容性</title>

    <indexterm xml:lang="en"><primary>Ports Collection</primary></indexterm>

    <para><trademark class="registered">Linux</trademark> 程式庫預設並不會安裝，且並不會開啟 <trademark class="registered">Linux</trademark> Binary 相容性。 <trademark class="registered">Linux</trademark> 程式庫可以手動安裝或是從 FreeBSD Port 套件集安裝。</para>

    <para>在嘗試編譯 Port 前，要載入 <trademark class="registered">Linux</trademark> 核心模組，否則編譯會失敗：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload linux</userinput></screen>

    <para>對 64-位元的相容性：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload linux64</userinput></screen>

    <para>確認模組已載入：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>kldstat</userinput>
      Id Refs Address    Size     Name
      1    2 0xc0100000 16bdb8   kernel
      7    1 0xc24db000 d000     linux.ko</screen>

    <para>在 FreeBSD 安裝基本的 <trademark class="registered">Linux</trademark>  程式庫和 Binary 最簡單的方式是安裝 <package>emulators/linux_base-c6</package> 套件或是 Port 。要安裝 Port：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install emulators/linux_base-c6</userinput></screen>

    <para>要在開機時開啟 <trademark class="registered">Linux</trademark> 相容性，可以加入這行到 <filename>/etc/rc.conf</filename>：</para>

    <programlisting xml:lang="en">linux_enable="YES"</programlisting>

    <para>在 64-位元的機器上，<filename>/etc/rc.d/abi</filename> 會自動載入用來做 64-位元模擬的模組。</para>

    <indexterm><primary>核心選項</primary> <secondary>COMPAT_LINUX</secondary></indexterm>

    <para xml:lang="en">Since the <trademark class="registered">Linux</trademark> binary compatibility layer has gained
      support for running both 32- and 64-bit <trademark class="registered">Linux</trademark> binaries (on
      64-bit x86 hosts), it is no longer possible to link the
      emulation functionality statically into a custom kernel.</para>

    <sect2 xml:id="linuxemu-libs-manually">
      <title>手動安裝其他程式庫</title>

      <indexterm xml:lang="en">
	<primary>shared libraries</primary>
      </indexterm>

      <para>若有 <trademark class="registered">Linux</trademark> 應用程式在設定 <trademark class="registered">Linux</trademark> Binary 相容性後出現缺少共用程式庫的情況，確認這個 <trademark class="registered">Linux</trademark> Binary 需要哪個共用程式庫並手動安裝。</para>

      <para>在 <trademark class="registered">Linux</trademark> 系統，可使用 <command>ldd</command> 來找出應用程式需要哪個共用程式庫。 例如，檢查 <command>linuxdoom</command> 需要哪個共用程式庫，在有安裝 <application>Doom</application> 的 <trademark class="registered">Linux</trademark> 系統執行這個指令：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>ldd linuxdoom</userinput>
libXt.so.3 (DLL Jump 3.1) =&gt; /usr/X11/lib/libXt.so.3.1.0
libX11.so.3 (DLL Jump 3.1) =&gt; /usr/X11/lib/libX11.so.3.1.0
libc.so.4 (DLL Jump 4.5pl26) =&gt; /lib/libc.so.4.6.29</screen>

      <indexterm xml:lang="en">
	<primary>symbolic links</primary>
      </indexterm>

      <para>然後，複製所有 <trademark class="registered">Linux</trademark> 系統輸出結果中最後一欄的檔案到 FreeBSD 系統的 <filename>/compat/linux</filename>。 複製完後，建立符號連結 (Symbolic link) 至輸出結果第一欄的名稱。以這個例子會在 FreeBSD 系統產生以下檔案：</para>

      <screen xml:lang="en">/compat/linux/usr/X11/lib/libXt.so.3.1.0
/compat/linux/usr/X11/lib/libXt.so.3 -&gt; libXt.so.3.1.0
/compat/linux/usr/X11/lib/libX11.so.3.1.0
/compat/linux/usr/X11/lib/libX11.so.3 -&gt; libX11.so.3.1.0
/compat/linux/lib/libc.so.4.6.29
/compat/linux/lib/libc.so.4 -&gt; libc.so.4.6.29</screen>

      <para>若 <trademark class="registered">Linux</trademark> 共用程式庫已經存在，並符合 <command>ldd</command> 輸出結果第一欄的主要修訂版號，則不需要複製該行最後一欄的檔案，使用既有的程式庫應可運作。若有較新的版本建議仍要複製共用程式庫，只要符號連結指向新版的程式庫，舊版便可移除。</para>

      <para>例如，以下程式庫已存在 FreeBSD 系統：</para>

      <screen xml:lang="en">/compat/linux/lib/libc.so.4.6.27
/compat/linux/lib/libc.so.4 -&gt; libc.so.4.6.27</screen>

      <para>且 <command>ldd</command> 顯示 Binary 需要使用較新的版本：</para>

      <screen xml:lang="en">libc.so.4 (DLL Jump 4.5pl26) -&gt; libc.so.4.6.29</screen>

      <para>雖然既有的程式庫只有在最後一碼過時一或兩個版本，程式應該仍可使用稍微舊的版本執行，雖然如此，保險起見還替換既有的 <filename>libc.so</filename> 為較新的版本：</para>

      <screen xml:lang="en">/compat/linux/lib/libc.so.4.6.29
/compat/linux/lib/libc.so.4 -&gt; libc.so.4.6.29</screen>

      <para>一般來說，只有在安裝 <trademark class="registered">Linux</trademark> 程式到 FreeBSD 完的前幾次會需要查看 <trademark class="registered">Linux</trademark> Binary 相依的共用程式庫。之後系統便有足夠的 <trademark class="registered">Linux</trademark> 共用程式庫能夠執行新安裝的 <trademark class="registered">Linux</trademark> Binary，便不再需要額外的動作。</para>
    </sect2>

    <sect2>
      <title>安裝 <trademark class="registered">Linux</trademark> <acronym>ELF</acronym> Binary</title>

      <indexterm xml:lang="en">
	<primary>Linux</primary>
	<secondary>ELF binaries</secondary>
      </indexterm>

      <para><acronym>ELF</acronym> Binary 有時候需要額外的步驟。當執行無商標 (Unbranded) 的 <acronym>ELF</acronym> Binary，會產生錯誤訊息：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>./my-linux-elf-binary</userinput>
ELF binary type not known
Abort</screen>

      <para>要協助 FreeBSD 核心區別是 FreeBSD <acronym>ELF</acronym> Binary 還是 <trademark class="registered">Linux</trademark> Binary，可使用 <citerefentry><refentrytitle>brandelf</refentrytitle><manvolnum>1</manvolnum></citerefentry>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>brandelf -t Linux my-linux-elf-binary</userinput></screen>

      <indexterm xml:lang="en">
	<primary>GNU toolchain</primary>
      </indexterm>

      <para>由於 GNU 工具鏈會自動放置適當的商標資訊到 <acronym>ELF</acronym> Binary，通常不需要這個步驟。</para>
    </sect2>

    <sect2>
      <title>安裝以 <trademark class="registered">Linux</trademark> <acronym>RPM</acronym> 為基礎的應用程式</title>

      <para>要安裝 <trademark class="registered">Linux</trademark> <acronym>RPM</acronym> 為基礎的應用程式，需先安裝 <package>archivers/rpm4</package> 套件或 Port。安裝完成之後，<systemitem class="username">root</systemitem> 可以使用這個指令安裝 <filename>.rpm</filename>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /compat/linux</userinput>
<prompt>#</prompt> <userinput>rpm2cpio &lt; /path/to/linux.archive.rpm | cpio -id</userinput></screen>

      <para>如果需要， <command>brandelf</command> 已安裝的 <acronym>ELF</acronym> Binary。注意，這將會無法乾淨地解除安裝。</para>
    </sect2>

    <sect2>
      <title>設定主機名稱解析器</title>

      <para>如果 <acronym>DNS</acronym> 無法運作或出現這個錯誤：</para>

      <screen xml:lang="en">resolv+: "bind" is an invalid keyword resolv+:
"hosts" is an invalid keyword</screen>

      <para>將 <filename>/compat/linux/etc/host.conf</filename> 設定如下：</para>

      <programlisting xml:lang="en">order hosts, bind
multi on</programlisting>

      <para>這指定先搜尋 <filename>/etc/hosts</filename>，其次為 <acronym>DNS</acronym>。 當 <filename>/compat/linux/etc/host.conf</filename> 不存在， <trademark class="registered">Linux</trademark> 應用程式會使用 <filename>/etc/host.conf</filename> 並會警告不相容的 FreeBSD 語法。如果名稱伺服器未設定使用 <filename>/etc/resolv.conf</filename> 的話，則可移除 <literal>bind</literal>。</para>
    </sect2>
  </sect1>

  <?ignore While the installer works, the binaries do not.  As of Oct 2013,
  Linux emulation is 32-bit but the trial version of Mathematica is
  only available as 64-bit.  This section should be revisited if Linux
  emulation gets 64-bit binary support.

  <sect1 id="linuxemu-mathematica">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Boris</firstname>
	  <surname>Hollas</surname>
	  <contrib>Updated for Mathematica 5.X by </contrib>
	</author>
      </authorgroup>
    </sect1info>

    <title>Installing &mathematica;</title>

    <indexterm>
      <primary>applications</primary>
      <secondary><application>Mathematica</application></secondary>
    </indexterm>

    <para>This section describes the process of installing the &linux;
      version of <application>&mathematica; 9.X</application> onto a
      &os; system.  <application>&mathematica;</application> is a
      commercial, computational software program used in scientific,
      engineering, and mathematical fields.  A 30 day trial version is
      available for download from <ulink
	url="http://www.wolfram.com/mathematica/">wolfram.com/mathematica</ulink>.</para>

    <sect2>
      <title>Running the &mathematica; Installer</title>

      <para>Before installing &mathematica;, make sure that the
	<filename role="package">textproc/linux-c6-aspell</filename>
	package or port is installed and that the &man.linprocfs.5;
	file system is mounted.</para>

      <screen>&prompt.root; <userinput>sysctl kern.fallback_elf_brand=3</userinput></screen>

      <para>&os; will now assume that unbranded ELF binaries use the
	&linux; <acronym>ABI</acronym> which should allow the
	installer to execute from the CDROM.</para>

      <para>The downloaded file will be saved to
	<filename>/tmp/Mathematica_9.0.1_LINUX.sh</filename>.  Become
	the superuser and run this installer file:</para>

      <programlisting>&prompt.root; <userinput>sh /tmp/Mathematica_9.0.1_LINUX.sh</userinput>
Mathematica Secured 9.0.1 for LINUX Installer Archive

Verifying archive integrity.
Extracting installer. ...
                               Wolfram Mathematica 9 Installer
Copyright (c) 1988-2013 Wolfram Research, Inc. All rights reserved.

WARNING: Wolfram Mathematica is protected by copyright law and international treaties. Unauthorized
reproduction or distribution may result in severe civil and criminal
penalties and will be prosecuted to the maximum extent possible under law.

Enter the installation directory, or press ENTER to select /usr/local/Wolfram/Mathematica/9.0:
>
Now installing...
***********************
Installation complete.</programlisting>
    </sect2>

    <sect2>
      <title>Running the &mathematica; Frontend over a Network</title>

      <para><application>&mathematica;</application> uses some special
	fonts to display characters not present in any of the standard
	font sets.  <application>Xorg</application> requires these
	fonts to be installed locally.  This means that these fonts
	need to be copied from the CDROM or from a host with
	<application>&mathematica;</application> installed to the
	local machine.  These fonts are normally stored in <filename
	  >/cdrom/Unix/Files/SystemFiles/Fonts</filename>
	on the CDROM, or <filename
	  >/usr/local/mathematica/SystemFiles/Fonts</filename>
	on the hard drive.  The actual fonts are in the subdirectories
	<filename>Type1</filename> and
	<filename>X</filename>.  There are several
	ways to use them, as described below.</para>

      <para>The first way is to copy the fonts into one of the
	existing font directories in <filename
	  >/usr/local/lib/X11/fonts</filename> then
	running &man.mkfontdir.1; within the directory containing the
	new fonts.</para>

      <para>The second way to do this is to copy the directories to
	<filename
	  >/usr/local/lib/X11/fonts</filename>:</para>

      <screen>&prompt.root; <userinput>cd /usr/local/lib/X11/fonts</userinput>
&prompt.root; <userinput>mkdir X</userinput>
&prompt.root; <userinput>mkdir MathType1</userinput>
&prompt.root; <userinput>cd /cdrom/Unix/Files/SystemFiles/Fonts</userinput>
&prompt.root; <userinput>cp X/* /usr/local/lib/X11/fonts/X</userinput>
&prompt.root; <userinput>cp Type1/* /usr/local/lib/X11/fonts/MathType1</userinput>
&prompt.root; <userinput>cd /usr/local/lib/X11/fonts/X</userinput>
&prompt.root; <userinput>mkfontdir</userinput>
&prompt.root; <userinput>cd ../MathType1</userinput>
&prompt.root; <userinput>mkfontdir</userinput></screen>

      <para>Now add the new font directories to the font path:</para>

      <screen>&prompt.root; <userinput>xset fp+ /usr/local/lib/X11/fonts/X</userinput>
&prompt.root; <userinput>xset fp+ /usr/local/lib/X11/fonts/MathType1</userinput>
&prompt.root; <userinput>xset fp rehash</userinput></screen>

      <para>When using the <application>&xorg;</application> server,
	these font directories can be loaded automatically by adding
	them to <filename>/etc/X11/xorg.conf</filename>.</para>

      <indexterm><primary>fonts</primary></indexterm>

      <para>If <filename
	  >/usr/local/lib/X11/fonts/Type1</filename>
	does not already exist, change the name of the <filename
	  >MathType1</filename> directory in the
	example above to <filename
	  >Type1</filename>.</para>
    </sect2>
  </sect1>
  -->

  <!--
  As of October 2013, the trial version is only available in the
  Professional and Academic editions (not the Student or Personal
  editions) and requires a contact with a product specialist before
  the evaluation download link is made available.
  <sect1 id="linuxemu-maple">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Aaron</firstname>
	  <surname>Kaplan</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Robert</firstname>
	  <surname>Getschmann</surname>
	  <contrib>Thanks to </contrib>
	</author>
      </authorgroup>
    </sect1info>
    <title>Installing &maple;</title>

    <indexterm>
      <primary>applications</primary>
      <secondary><application>Maple</application></secondary>
    </indexterm>

    <para><application>&maple;</application> is a commercial
      mathematics program similar to
      <application>&mathematica;</application>.  This software must be
      purchased and licensed from <ulink
	url="http://www.maplesoft.com/products/maple/">Maplesoft</ulink>.
      To install the &linux; version of this software on &os;, follow
      these steps.</para>

    <procedure>
      <step><para>Execute the <filename>INSTALL</filename> shell
	script from the product distribution.  Choose the
	<quote>RedHat</quote> option when prompted by the
	installation program.  A typical installation directory
	might be <filename
	  >/usr/local/maple</filename>.</para></step>

      <step>
	<para>Copy the license to
	  <filename>/usr/local/maple/license/license.dat</filename>.</para>
      </step>

      <step>
	<para>Install the <application>FLEXlm</application> license
	  manager by running the <filename>INSTALL_LIC</filename>
	  install shell script that comes with
	  <application>&maple;</application>.  Specify the primary
	  hostname for the machine for the license server.</para>
      </step>

      <step>
	<para>Patch
	  <filename>/usr/local/maple/bin/maple.system.type</filename>
	  with the following:</para>


	<programlisting>   ----- snip ------------------
*** maple.system.type.orig      Sun Jul  8 16:35:33 2001
-- - maple.system.type   Sun Jul  8 16:35:51 2001
***************
*** 72,77 ****
-- - 72,78 ----
          # the IBM RS/6000 AIX case
          MAPLE_BIN="bin.IBM_RISC_UNIX"
          ;;
+     "FreeBSD"|\
      "Linux")
          # the Linux/x86 case
        # We have two Linux implementations, one for Red Hat and
   ----- snip end of patch -----</programlisting>

	<para>Note that no whitespace should be present after
	  <literal>"FreeBSD"|\</literal>.</para>

	<para>This patch instructs <application>&maple;</application>
	  to recognize &os; as a type of &linux; system.  The
	  <filename>bin/maple</filename> shell script calls the
	  <filename>bin/maple.system.type</filename> shell script
	  which in turn calls <command>uname -a</command> to find out
	  the operating system name.  Depending on the OS name it will
	  find out which binaries to use.</para>
      </step>

      <step>
	<para>Start the license server.</para>

	<para>The following script, installed as
	  <filename>/usr/local/rtc/rc.d/lmgrd</filename> is a
	  convenient way to start up <command>lmgrd</command>:</para>

	<programlisting>   ----- snip ------------

#! /bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
PATH=${PATH}:/usr/local/maple/bin:/usr/local/maple/FLEXlm/UNIX/LINUX
export PATH

LICENSE_FILE=/usr/local/maple/license/license.dat
LOG=/var/log/lmgrd.log

case "$1" in
start)
	lmgrd -c ${LICENSE_FILE} 2&gt;&gt; ${LOG} 1&gt;&amp;2
	echo -n " lmgrd"
	;;
stop)
	lmgrd -c ${LICENSE_FILE} -x lmdown 2&gt;&gt; ${LOG} 1&gt;&amp;2
	;;
*)
	echo "Usage: `basename $0` {start|stop}" 1&gt;&amp;2
	exit 64
	;;
esac

exit 0
   ----- snip ------------</programlisting>
      </step>

      <step>
	<para>Test that <application>&maple;</application>
	  starts:</para>

	<screen>&prompt.user; <userinput>cd /usr/local/maple/bin</userinput>
&prompt.user; <userinput>./xmaple</userinput></screen>

	<para>Once everything is working, consider writing Maplesoft
	  to let them know you would like a native &os;
	  version!</para>
      </step>
    </procedure>

    <sect2>
      <title>Common Pitfalls</title>

      <itemizedlist>
	<listitem>
	  <para><command>lmgrd</command> is known to be picky about
	    the license file and to dump core if there are any
	    problems.  A correct license file should look like
	    this:</para>

	  <programlisting>#
=======================================================
# License File for UNIX Installations ("Pointer File")
# =======================================================
SERVER chillig ANY
#USE_SERVER
VENDOR maplelmg

FEATURE Maple maplelmg 2000.0831 permanent 1 XXXXXXXXXXXX \
         PLATFORMS=i86_r ISSUER="Waterloo Maple Inc." \
         ISSUED=11-may-2000 NOTICE=" Technische Universitat Wien" \
         SN=XXXXXXXXX</programlisting>

	  <note>
	    <para>In this example, the serial number and key were
	      replaced with <literal>X</literal>.
	      <hostid>chillig</hostid> is the hostname.</para>
	  </note>

	  <para>Editing the license file works as long as the
	    <quote>FEATURE</quote> line is not edited.  That line is
	    protected by the license key.</para>
	</listitem>
      </itemizedlist>
    </sect2>
  </sect1>
  -->
  <!--
  As of October, 2013, the Linux version of Matlab is only available
  for 64-bit.

  <sect1 id="linuxemu-matlab">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Dan</firstname>
	  <surname>Pelleg</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </sect1info>

    <title>Installing &matlab;</title>

    <indexterm>
      <primary>applications</primary>
      <secondary><application>MATLAB</application></secondary>
    </indexterm>

    <para>This document describes the process of installing the
      &linux; version of
      <application>&matlab; version 6.5</application> onto a &os;
      system.  It works quite well, with the exception of the
      <application>&java.virtual.machine;</application> which is
      described further in <xref linkend="matlab-jre"/>.</para>

    <para>The &linux; version of <application>&matlab;</application>
      can be purchased and licensed from <ulink
	url="http://www.mathworks.com/products/matlab/">MathWorks</ulink>.
      Consider letting the company know that you would like a native
      &os; version of this software.</para>

    <sect2>
      <title>Installing &matlab;</title>

      <para>To install <application>&matlab;</application>:</para>

      <procedure>
	<step>
	  <para>Become <username>root</username>, as recommended by
	    the installation script.  Insert the installation CD and
	    mount it.  To start the installation script type:</para>

	  <screen>&prompt.root; <userinput>/compat/linux/bin/sh /cdrom/install</userinput></screen>

	  <tip>
	    <para>The installer is graphical.  If it is not able to
	      open a display, type <command>setenv HOME
		~<replaceable>USER</replaceable></command>,
	      where <replaceable>USER</replaceable> is the user who
	      ran &man.su.1;.</para>
	  </tip>
	</step>

	<step>
	  <para>When asked for the <application>&matlab;</application>
	    root directory, type:
	    <userinput>/compat/linux/usr/local/matlab</userinput>.</para>

	  <tip>
	    <para>For easier typing on the rest of the installation
	      process, type this at the shell prompt: <command>set
		MATLAB=/compat/linux/usr/local/matlab</command>.</para>
	  </tip>
	</step>

	<step>
	  <para>Edit the license file as instructed when obtaining
	    the <application>&matlab;</application> license.</para>

	  <tip>
	    <para>This file can be prepared in advance using an
	      editor, and copied to
	      <filename>$MATLAB/license.dat</filename> before the
	      installer asks to edit it.</para>
	  </tip>
	</step>

	<step>
	  <para>Complete the installation process.</para>
	</step>
      </procedure>

      <para>At this point the <application>&matlab;</application>
	installation is complete.  The following steps apply
	<quote>glue</quote> to connect it to the &os; system.</para>
    </sect2>

    <sect2>
      <title>License Manager Startup</title>

      <procedure>
	<step>
	  <para>Create symlinks for the license manager
	    scripts:</para>

	  <screen>&prompt.root; <userinput>ln -s $MATLAB/etc/lmboot /usr/local/etc/lmboot_TMW</userinput>
&prompt.root; <userinput>ln -s $MATLAB/etc/lmdown /usr/local/etc/lmdown_TMW</userinput></screen>
	</step>

	<step>
	  <para>Create a startup file named
	    <filename>/usr/local/etc/rc.d/flexlm</filename>.  The
	    example below is a modified version of the distributed
	    <filename>$MATLAB/etc/rc.lm.glnx86</filename>.  The
	    changes are file locations and startup of the license
	    manager under &linux; emulation.</para>

	  <programlisting>#!/bin/sh
case "$1" in
  start)
        if [ -f /usr/local/etc/lmboot_TMW ]; then
              /compat/linux/bin/sh /usr/local/etc/lmboot_TMW -u <replaceable>username</replaceable> &amp;&amp; echo 'MATLAB_lmgrd'
        fi
        ;;
  stop)
	if [ -f /usr/local/etc/lmdown_TMW ]; then
            /compat/linux/bin/sh /usr/local/etc/lmdown_TMW  &gt; /dev/null 2&gt;&amp;1
	fi
        ;;
  *)
	echo "Usage: $0 {start|stop}"
	exit 1
	;;
esac

exit 0</programlisting>

	  <important>
	    <para>The file must be made executable:</para>

	    <screen>&prompt.root; <userinput>chmod +x /usr/local/etc/rc.d/flexlm</userinput></screen>

	    <para>Replace <replaceable>username</replaceable> with the
	      name of a valid user on the system which is not
	      <username>root</username>.</para>
	  </important>
	</step>

	<step>
	  <para>Start the license manager with the command:</para>

	  <screen>&prompt.root; <userinput>service flexlm start</userinput></screen>
	</step>
      </procedure>
    </sect2>

    <sect2 id="matlab-jre">
      <title>Linking the &java; Runtime Environment</title>

      <para>Change the <application>&java;</application> Runtime
	Environment (<acronym>JRE</acronym>) link to one working under
	&os;:</para>

      <screen>&prompt.root; <userinput>cd $MATLAB/sys/java/jre/glnx86/</userinput>
&prompt.root; <userinput>unlink jre; ln -s ./jre1.1.8 ./jre</userinput></screen>
    </sect2>

    <sect2>
      <title>Creating a &matlab; Startup Script</title>

      <procedure>
	<step>
	  <para>Place the following startup script in
	    <filename
	      >/usr/local/bin/matlab</filename>:</para>

	  <programlisting>#!/bin/sh
/compat/linux/bin/sh /compat/linux/usr/local/matlab/bin/matlab "$@"</programlisting>
	</step>

	<step>
	  <para>Then, type the command
	    <command>chmod +x /usr/local/bin/matlab</command>.</para>
	</step>
      </procedure>

      <tip>
	<para>Depending on the version of
	  <filename role="package">emulators/linux_base</filename>,
	  running this script may result in errors.  To avoid errors,
	  edit
	  <filename>/compat/linux/usr/local/matlab/bin/matlab</filename>,
	  and change the line that says:</para>

	<programlisting>if [ `expr "$lscmd" : '.*-&gt;.*'` -ne 0 ]; then</programlisting>

	<para>to this line:</para>

	<programlisting>if test -L $newbase; then</programlisting>
      </tip>
    </sect2>

    <sect2>
      <title>Creating a &matlab; Shutdown Script</title>

      <para>The following is needed to solve a problem with &matlab;
	not exiting correctly.</para>

      <procedure>
	<step>
	  <para>Create
	    <filename>$MATLAB/toolbox/local/finish.m</filename>
	    containing the single line:</para>

	  <programlisting>! $MATLAB/bin/finish.sh</programlisting>

	  <note>
	    <para>The <literal>$MATLAB</literal> is literal.</para>
	  </note>

	  <tip>
	    <para>The same directory contains
	      <filename>finishsav.m</filename> and
	      <filename>finishdlg.m</filename>, which allow the
	      workspace to be saved before quitting.  If either file
	      is used, insert the line above immediately after the
	      <literal>save</literal> command.</para>
	  </tip>
	</step>

	<step>
	  <para>Create <filename>$MATLAB/bin/finish.sh</filename>
	    which contains the following:</para>

	  <programlisting>#!/compat/linux/bin/sh
(sleep 5; killall -1 matlab_helper) &amp;
exit 0</programlisting>
	</step>

	<step>
	  <para>Make the file executable:</para>

	  <screen>&prompt.root; <userinput>chmod +x $MATLAB/bin/finish.sh</userinput></screen>
	</step>
      </procedure>
    </sect2>

    <sect2 id="matlab-using">
      <title>Using &matlab;</title>

      <para>At this point, <command>matlab</command> is ready for
	use.</para>
    </sect2>
  </sect1>

  <sect1 id="linuxemu-oracle">
    While the Oracle website is unclear, the installation script is:
    You are attempting to install 64-bit Oracle on a 32-bit operating
    system.  This is not supported and will not work.

    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Marcel</firstname>
	  <surname>Moolenaar</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </sect1info>

    <title>Installing &oracle;</title>

    <indexterm>
      <primary>applications</primary>
      <secondary><application>Oracle</application></secondary>
    </indexterm>

    <para>This document describes the process of installing
      <application>&oracle; 8.0.5</application> and
      <application>&oracle; 8.0.5.1 Enterprise Edition</application>
      for &linux; onto a &os; machine.</para>

    <sect2>
      <title>Installing the &linux; Environment</title>

      <para>Make sure <filename
	  role='package'>emulators/linux_base</filename>
	has been installed from the Ports Collection.</para>

      <para>To run the intelligent agent, install the Red Hat Tcl
	package:  <filename>tcl-8.0.3-20.i386.rpm</filename>.  The
	general command for installing RPMs with the
	<filename role='package'>archivers/rpm</filename> port
	is:</para>

      <screen>&prompt.root; <userinput>rpm -i --ignoreos --root /compat/linux --dbpath /var/lib/rpm <replaceable>package</replaceable></userinput></screen>

      <para>This command should not generate any errors.</para>
    </sect2>

    <sect2>
      <title>Creating the &oracle; Environment</title>

      <para>Before installing <application>&oracle;</application>, set
	up a proper environment.  This section only describes how to
	install <application>&oracle;</application> for &linux; on
	&os;, not what has been described in the
	<application>&oracle;</application> installation guide.</para>

      <sect3 id="linuxemu-kernel-tuning">
	<title>Kernel Tuning</title>

	<indexterm>
	  <primary>kernel tuning</primary>
	</indexterm>

	<para>As described in the <application>&oracle;</application>
	  installation guide, the maximum size of shared memory needs
	  to be set.  Do not use <literal>SHMMAX</literal> under &os;
	  as it is calculated from <literal>SHMMAXPGS</literal> and
	  <literal>PGSIZE</literal>.  Therefore, define
	  <literal>SHMMAXPGS</literal>.  All other options can be
	  used as described in the guide.  For example:</para>

	<programlisting>options SHMMAXPGS=10000
options SHMMNI=100
options SHMSEG=10
options SEMMNS=200
options SEMMNI=70
options SEMMSL=61</programlisting>

	<para>Set these options to suit the intended use of
	  <application>&oracle;</application>.</para>

	<para>Also, make sure the following options are in the
	  kernel configuration file:</para>

	<programlisting>options SYSVSHM #SysV shared memory
options SYSVSEM #SysV semaphores
options SYSVMSG #SysV interprocess communication</programlisting>
      </sect3>

      <sect3 id="linuxemu-oracle-account">

	<title>&oracle; Account</title>

	<para>Create a user account to be used as the
	  <username>oracle</username> account.  Add
	  <literal>/compat/linux/bin/bash</literal> to
	  <filename>/etc/shells</filename> and set the shell for
	  the <username>oracle</username> account to
	  <filename>/compat/linux/bin/bash</filename>.</para>
      </sect3>

      <sect3 id="linuxemu-environment">
	<title>Environment</title>

	<para>Besides the normal <application>&oracle;</application>
	  variables, such as <envar>ORACLE_HOME</envar> and
	  <envar>ORACLE_SID</envar> set the following
	  environment variables:</para>

	<informaltable frame="none" pgwide="1">
	  <tgroup cols="2">
	    <colspec colwidth="1*"/>
	    <colspec colwidth="2*"/>
	    <thead>
	      <row>
		<entry>Variable</entry>
		<entry>Value</entry>
	      </row>
	    </thead>

	    <tbody>
	      <row>
		<entry><envar>LD_LIBRARY_PATH</envar></entry>
		<entry><literal>$ORACLE_HOME/lib</literal></entry>
	      </row>

	      <row>
		<entry><envar>CLASSPATH</envar></entry>
		<entry><literal>$ORACLE_HOME/jdbc/lib/classes111.zip</literal></entry>
	      </row>

	      <row>
		<entry><envar>PATH</envar></entry>
		<entry><literal>/compat/linux/bin
		    /compat/linux/sbin
		    /compat/linux/usr/bin
		    /compat/linux/usr/sbin
		    /bin
		    /sbin
		    /usr/bin
		    /usr/sbin
		    /usr/local/bin
		    $ORACLE_HOME/bin</literal></entry>
	      </row>
	    </tbody>
	  </tgroup>
	</informaltable>

	<para>It is advised to set all the environment variables in
	  <filename>~/.profile</filename> as follows:</para>

	<programlisting>ORACLE_BASE=/oracle; export ORACLE_BASE
ORACLE_HOME=/oracle; export ORACLE_HOME
LD_LIBRARY_PATH=$ORACLE_HOME/lib
export LD_LIBRARY_PATH
ORACLE_SID=ORCL; export ORACLE_SID
ORACLE_TERM=386x; export ORACLE_TERM
CLASSPATH=$ORACLE_HOME/jdbc/lib/classes111.zip
export CLASSPATH
PATH=/compat/linux/bin:/compat/linux/sbin:/compat/linux/usr/bin
PATH=$PATH:/compat/linux/usr/sbin:/bin:/sbin:/usr/bin:/usr/sbin
PATH=$PATH:/usr/local/bin:$ORACLE_HOME/bin
export PATH</programlisting>
      </sect3>
    </sect2>

    <sect2>
      <title>Installing &oracle;</title>

      <para>Before starting the installer, create a directory named
	<filename>/var/tmp/.oracle</filename> which
	is owned by the <username>oracle</username> user.  The
	installation of <application>&oracle;</application> should
	work without any problems.  If errors are encountered, check
	the <application>&oracle;</application> distribution and
	configuration.  Once <application>&oracle;</application> is
	installed, apply the patches described in the next two
	subsections.</para>

      <para>A frequent error is that the TCP protocol adapter is not
	installed correctly.  As a consequence, no TCP listeners can
	be started.  The following actions help to solve this
	problem:</para>

      <screen>&prompt.root; <userinput>cd $ORACLE_HOME/network/lib</userinput>
&prompt.root; <userinput>make -f ins_network.mk ntcontab.o</userinput>
&prompt.root; <userinput>cd $ORACLE_HOME/lib</userinput>
&prompt.root; <userinput>ar r libnetwork.a ntcontab.o</userinput>
&prompt.root; <userinput>cd $ORACLE_HOME/network/lib</userinput>
&prompt.root; <userinput>make -f ins_network.mk install</userinput></screen>

    <para>Do not forget to run <filename>root.sh</filename>
      again.</para>

    <sect3 id="linuxemu-patch-root">
      <title>Patching <filename>root.sh</filename></title>

      <para>When installing <application>&oracle;</application>,
	some actions, which need to be performed as
	<username>root</username>, are recorded in a shell script
	called <filename>root.sh</filename>.  This script is
	found in <filename>orainst</filename>.
	Apply the following patch to <filename>root.sh</filename>
	so that it can find the &os; location of
	<command>chown</command>.  Alternatively, run the script
	under a &linux; native shell.</para>

      <programlisting>*** orainst/root.sh.orig Tue Oct 6 21:57:33 1998
--- orainst/root.sh Mon Dec 28 15:58:53 1998
***************
*** 31,37 ****
# This is the default value for CHOWN
# It will redefined later in this script for those ports
# which have it conditionally defined in ss_install.h
! CHOWN=/bin/chown
#
# Define variables to be used in this script
 --- 31,37 ----
# This is the default value for CHOWN
# It will redefined later in this script for those ports
# which have it conditionally defined in ss_install.h
! CHOWN=/usr/sbin/chown
#
# Define variables to be used in this script</programlisting>

      <para>If <application>&oracle;</application> is not installed
	from CD, patch the source for <filename>root.sh</filename>.
	It is called <filename>rthd.sh</filename> and is located in
	<filename>orainst</filename> in the source
	tree.</para>
    </sect3>

    <sect3 id="linuxemu-patch-tcl">
      <title>Patching <filename>genclntsh</filename></title>

      <para>The script <command>genclntsh</command> is used to create
	a single shared client library when building the demos.  Apply
	the following patch to comment out the definition of
	<envar>PATH</envar>:</para>

      <programlisting>*** bin/genclntsh.orig Wed Sep 30 07:37:19 1998
--- bin/genclntsh Tue Dec 22 15:36:49 1998
***************
*** 32,38 ****
#
# Explicit path to ensure that we're using the correct commands
#PATH=/usr/bin:/usr/ccs/bin export PATH
! PATH=/usr/local/bin:/bin:/usr/bin export PATH
#
# each product MUST provide a $PRODUCT/admin/shrept.lst
--- 32,38 ----
#
# Explicit path to ensure that we're using the correct commands
#PATH=/usr/bin:/usr/ccs/bin export PATH
! #PATH=/usr/local/bin:/bin:/usr/bin: export PATH
#
# each product MUST provide a $PRODUCT/admin/shrept.lst</programlisting>
      </sect3>
    </sect2>

    <sect2>
      <title>Running &oracle;</title>

      <para>After following these instructions,
	<application>&oracle;</application> should run as if it was
	running on &linux;.</para>
    </sect2>
  </sect1>
  ?>

  <sect1 xml:id="linuxemu-advanced">
    <title>進階主題</title>

    <para xml:lang="en">This section describes how <trademark class="registered">Linux</trademark> binary compatibility
      works and is based on an email written to <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-chat">FreeBSD chat mailing list</link> by
      Terry Lambert <email>tlambert@primenet.com</email> (Message ID:
      <literal>&lt;199906020108.SAA07001@usr09.primenet.com&gt;</literal>).</para>

    <indexterm xml:lang="en"><primary>execution class loader</primary></indexterm>

    <para xml:lang="en">FreeBSD has an abstraction called an
      <quote>execution class loader</quote>.  This is a wedge into the
      <citerefentry><refentrytitle>execve</refentrytitle><manvolnum>2</manvolnum></citerefentry> system call.</para>

    <para xml:lang="en">Historically, the <trademark class="registered">UNIX</trademark> loader examined the magic number
      (generally the first 4 or 8 bytes of the file) to see if it was
      a binary known to the system, and if so, invoked the binary
      loader.</para>

    <para xml:lang="en">If it was not the binary type for the system, the
      <citerefentry><refentrytitle>execve</refentrytitle><manvolnum>2</manvolnum></citerefentry> call returned a failure, and the shell
      attempted to start executing it as shell commands.  The
      assumption was a default of
      <quote>whatever the current shell is</quote>.</para>

    <para xml:lang="en">Later, a hack was made for <citerefentry><refentrytitle>sh</refentrytitle><manvolnum>1</manvolnum></citerefentry> to examine the first
      two characters, and if they were <literal>:\n</literal>, it
      invoked the <citerefentry><refentrytitle>csh</refentrytitle><manvolnum>1</manvolnum></citerefentry> shell instead.</para>

    <para xml:lang="en">FreeBSD has a list of loaders, instead of a single loader, with
      a fallback to the <literal>#!</literal> loader for running shell
      interpreters or shell scripts.</para>

    <indexterm xml:lang="en">
      <primary>ELF</primary>
    </indexterm>

    <indexterm xml:lang="en">
      <primary>Solaris</primary>
    </indexterm>

    <para xml:lang="en">For the <trademark class="registered">Linux</trademark> <acronym>ABI</acronym> support, FreeBSD sees
      the magic number as an ELF binary.  The ELF loader looks for a
      specialized <emphasis>brand</emphasis>, which is a comment
      section in the ELF image, and which is not present on
      SVR4/<trademark>Solaris</trademark> ELF binaries.</para>

    <para xml:lang="en">For <trademark class="registered">Linux</trademark> binaries to function, they must be
      <emphasis>branded</emphasis> as type <literal>Linux</literal>
      using <citerefentry><refentrytitle>brandelf</refentrytitle><manvolnum>1</manvolnum></citerefentry>:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>brandelf -t Linux file</userinput></screen>

    <indexterm xml:lang="en">
      <primary>ELF</primary>
      <secondary>branding</secondary>
    </indexterm>

    <para xml:lang="en">When the ELF loader sees the <literal>Linux</literal>
      brand, the loader replaces a pointer in the
      <literal>proc</literal> structure.  All system calls are indexed
      through this pointer.  In addition, the process is flagged for
      special handling of the trap vector for the signal trampoline
      code, and several other (minor) fix-ups that are handled by the
      <trademark class="registered">Linux</trademark> kernel module.</para>

    <para xml:lang="en">The <trademark class="registered">Linux</trademark> system call vector contains, among other things,
      a list of <literal>sysent[]</literal> entries whose addresses
      reside in the kernel module.</para>

    <para xml:lang="en">When a system call is called by the <trademark class="registered">Linux</trademark> binary, the trap
      code dereferences the system call function pointer off the
      <literal>proc</literal> structure, and gets the <trademark class="registered">Linux</trademark>, not the
      FreeBSD, system call entry points.</para>

    <para xml:lang="en"><trademark class="registered">Linux</trademark> mode dynamically <emphasis>reroots</emphasis>
      lookups.  This is, in effect, equivalent to
      <option>union</option> to file system mounts.  First, an
      attempt is made to lookup the file in
      <filename>/compat/linux/<replaceable>original-path</replaceable></filename>.
      If that fails, the lookup is done in
      <filename>/<replaceable>original-path</replaceable></filename>.
      This makes sure that binaries that require other binaries can
      run.  For example, the <trademark class="registered">Linux</trademark> toolchain can all run under
      <trademark class="registered">Linux</trademark> <acronym>ABI</acronym> support.  It also means that the
      <trademark class="registered">Linux</trademark> binaries can load and execute FreeBSD binaries, if there
      are no corresponding <trademark class="registered">Linux</trademark> binaries present, and that a
      <citerefentry><refentrytitle>uname</refentrytitle><manvolnum>1</manvolnum></citerefentry> command can be placed in the
      <filename>/compat/linux</filename> directory tree to ensure that
      the <trademark class="registered">Linux</trademark> binaries cannot tell they are not running on
      <trademark class="registered">Linux</trademark>.</para>

    <para xml:lang="en">In effect, there is a <trademark class="registered">Linux</trademark> kernel in the FreeBSD kernel.
      The various underlying functions that implement all of the
      services provided by the kernel are identical to both the FreeBSD
      system call table entries, and the <trademark class="registered">Linux</trademark> system call table
      entries: file system operations, virtual memory operations,
      signal delivery, and System V IPC.  The only difference is that
      FreeBSD binaries get the FreeBSD <emphasis>glue</emphasis> functions,
      and <trademark class="registered">Linux</trademark> binaries get the <trademark class="registered">Linux</trademark> <emphasis>glue</emphasis>
      functions.  The FreeBSD <emphasis>glue</emphasis> functions are
      statically linked into the kernel, and the <trademark class="registered">Linux</trademark>
      <emphasis>glue</emphasis> functions can be statically linked, or
      they can be accessed via a kernel module.</para>

    <para xml:lang="en">Technically, this is not really emulation, it is an
      <acronym>ABI</acronym> implementation.  It is sometimes called
      <quote><trademark class="registered">Linux</trademark> emulation</quote> because the implementation was
      done at a time when there was no other word to describe what was
      going on.  Saying that FreeBSD ran <trademark class="registered">Linux</trademark> binaries was not true,
      since the code was not compiled in.</para>
  </sect1>
</chapter>

  </part>

  <part xml:id="system-administration">
    <title>系統管理</title>

    <partintro>
      <para>FreeBSD 使用手冊剩下的這些章節涵蓋了全方位的 FreeBSD 系統管理。 每個章節的開頭會先描述在該您讀完該章節後您會學到什麼，也會詳述在您在看這些資料時應該要有的一些背景知識。</para>

      <para>這些章節是讓您在需要查資料的時候翻閱用的。 您不需要依照特定的順序來讀，也不需要將這些章節全部過讀之後才開始用 FreeBSD。</para>
    </partintro>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="config-tuning">

  <info>
    <title>設定與調校</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Chern</firstname>
	  <surname>Lee</surname>
	</personname>
	<contrib>Written by </contrib>
      </author>
    </authorgroup>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Mike</firstname>
	  <surname>Smith</surname>
	</personname>
	<contrib>Based on a tutorial written by </contrib>
      </author>
    </authorgroup>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Matt</firstname>
	  <surname>Dillon</surname>
	</personname>
	<contrib>Also based on tuning(7) written by </contrib>
      </author>
    </authorgroup>
  </info>

  <sect1 xml:id="config-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en">
      <primary>system configuration</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>system optimization</primary>
    </indexterm>

    <para>在 FreeBSD 使用過程中，相當重要的環節之一就是如何正確設定系統。 本章著重於介紹 FreeBSD 的設定流程，包括一些可以調整 FreeBSD 效能的參數設定。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para><filename>rc.conf</filename> 設定的基礎概念及 <filename>/usr/local/etc/rc.d</filename> 啟動 Script。</para>
      </listitem>

      <listitem>
	<para>如何設定並測試網路卡。</para>
      </listitem>

      <listitem>
	<para>如何在網路裝置上設定虛擬主機。</para>
      </listitem>

      <listitem>
	<para>如何使用在 <filename>/etc</filename> 中的各種設定檔。</para>
      </listitem>

      <listitem>
	<para>如何使用 <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 變數調校 FreeBSD。</para>
      </listitem>

      <listitem>
	<para>如何調校磁碟效能及修改核心限制。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>了解 <trademark class="registered">UNIX</trademark> 及 FreeBSD 基礎 (<xref linkend="basics"/>)。</para>
      </listitem>

      <listitem>
	<para>熟悉核心設定與編譯的基礎 (<xref linkend="kernelconfig"/>)。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="configtuning-starting-services">
    <info>
      <title>啟動服務</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>services</primary>
    </indexterm>

    <para>許多使用者會使用 Port 套件集安裝第三方軟體到 FreeBSD 且需要安裝服務在系統初始化時可啟動該軟體。服務，例如 <package>mail/postfix</package> 或 <package>www/apache22</package> 僅只是在眾多需要在系統初始化時啟動的軟體之中的兩個。本章節將說明可用來啟動第三方軟體的程序。</para>

    <para>在 FreeBSD 大多數內建的服務，例如 <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> 也是透過系統啟動 Script 來執行。</para>

    <sect2>
      <title>延伸應用程式設定</title>

      <para>現在 FreeBSD 會引用 <filename>rc.d</filename>，設定應用程式啟動變的更簡單且提供更多的功能。使用於 <xref linkend="configtuning-rcd"/> 所提到的關鍵字，可以設定應用程式在其他特定服務之後啟動且可以透過 <filename>/etc/rc.conf</filename> 來傳遞額外的旗標來取代寫死在啟動 Script 中的旗標。一個基本的 Script 可能會如下例所示：</para>

      <programlisting xml:lang="en">#!/bin/sh
#
# PROVIDE: utility
# REQUIRE: DAEMON
# KEYWORD: shutdown

. /etc/rc.subr

name=utility
rcvar=utility_enable

command="/usr/local/sbin/utility"

load_rc_config $name

#
# DO NOT CHANGE THESE DEFAULT VALUES HERE
# SET THEM IN THE /etc/rc.conf FILE
#
utility_enable=${utility_enable-"NO"}
pidfile=${utility_pidfile-"/var/run/utility.pid"}

run_rc_command "$1"</programlisting>

      <para>這個 Script 會確保要執行的 <literal>utility</literal> 會在虛構的服務 <literal>DAEMON</literal> 之後啟動，也同時提供設定與追蹤程序 ID (Process ID, <acronym>PID</acronym>) 的方法。</para>

      <para>接著此應用程式便可將下行放到 <filename>/etc/rc.conf</filename> 中：</para>

      <programlisting xml:lang="en">utility_enable="YES"</programlisting>

      <para>使用這種方式可以簡單的處理指令列參數、引用 <filename>/etc/rc.subr</filename> 所提供的預設函數、與 <citerefentry><refentrytitle>rcorder</refentrytitle><manvolnum>8</manvolnum></citerefentry> 相容並可在 <filename>rc.conf</filename> 簡單的設定。</para>
    </sect2>

    <sect2>
      <title>使用服務來啟動其他服務</title>

      <para>其他的服務可以使用 <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來啟動，在 <xref linkend="network-inetd"/> 有如何使用 <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以及其設定的深入說明。</para>

      <para>在某些情況更適合使用 <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來啟動系統服務，由於 <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> 會使用 <citerefentry><refentrytitle>crontab</refentrytitle><manvolnum>5</manvolnum></citerefentry> 的擁有者來執行這些程序，所以這個方法有不少優點，這讓一般的使用者也可以啟動與維護自己的應用程式。</para>

      <para><citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的 <literal>@reboot</literal> 功能，可用來替代指定詳細的時間，而該工作會在系統初始化時執行 <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> 後執行。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="configtuning-cron">
    <info>
      <title>設定 <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry></title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>cron</primary>
      <secondary>configuration</secondary>
    </indexterm>

    <para>在 FreeBSD 其中最有用的其中一項工具便是 <application>cron</application>，這個工具會在背景執行並且定期檢查 <filename>/etc/crontab</filename> 是否有要執行的工作然後搜尋 <filename>/var/cron/tabs</filename> 是否有自訂的 crontab 檔案，這些檔案用來安排要讓 <application>cron</application> 在指定的時間執行的工作，crontab 中的每一個項目定義了一個要執行的工作，又稱作 <firstterm>cron job</firstterm>。</para>

    <para>這裡使用了兩種類型的設定檔：其一是系統 crontab，系統 crontab 不應該被修改，其二為使用者 crontab，使用者 crontab 可以依需要建立與編輯。這兩種檔案的格式在 <citerefentry><refentrytitle>crontab</refentrytitle><manvolnum>5</manvolnum></citerefentry> 有說明。系統 crontab <filename>/etc/crontab</filename> 的格式含有在使用者 crontab 所沒有的 <literal>who</literal> 欄位，在系統 crontab，<application>cron</application> 會依據該欄位所指定的使用者來執行指令，而在使用者 crontab，會以建立 crontab 的使用者來執行指令。</para>

    <para>使用者 crontab 讓個別使用者可以安排自己的工作，<systemitem class="username">root</systemitem> 使用者也可有自己的使用者 <filename>crontab</filename> 來安排不在系統 <filename>crontab</filename> 中的工作。</para>

    <para>以下為系統 crontab <filename>/etc/crontab</filename> 的範例項目：</para>

    <programlisting xml:lang="en"># /etc/crontab - root's crontab for FreeBSD
#
# <phrase its:translate="no">$FreeBSD$</phrase>
# <co xml:id="co-comments"/>
SHELL=/bin/sh
PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin <co xml:id="co-env"/>
#
#minute	hour	mday	month	wday	who	command <co xml:id="co-field-descr"/>
#
*/5	*	*	*	*	root	/usr/libexec/atrun <co xml:id="co-main"/></programlisting>

    <calloutlist>
      <callout arearefs="co-comments">
	<para>以 <literal>#</literal> 字元為首的行代表註解。可在檔案中放置註解提醒要執行什麼動作及為何要執行。註解不可與指令同行，否則會被當做指令的一部份，註解必須在新的一行，空白行則會被忽略掉。</para>
      </callout>

      <callout arearefs="co-env">
	<para>等號 (<literal>=</literal>) 字元用來定義任何環境設定。在這個例子當中，使用了等號來定義 <envar>SHELL</envar> 及 <envar>PATH</envar>。若 <envar>SHELL</envar> 被省略，<application>cron</application> 則會使用預設的 Bourne shell。若 <envar>PATH</envar> 被省略，則必須指定指令或 Script 的完整路徑才能執行。</para>
      </callout>

      <callout arearefs="co-field-descr">
	<para>此行定義了在系統 crontab 會使用到的七個欄位：<literal>minute</literal>, <literal>hour</literal>, <literal>mday</literal>, <literal>month</literal>, <literal>wday</literal>, <literal>who</literal> 以及 <literal>command</literal>。<literal>minute</literal> 欄位是指定指令要執行的時間中的分，<literal>hour</literal> 指定指令要執行的時，<literal>mday</literal> 是月裡面的日，<literal>month</literal> 是月，以及 <literal>wday</literal> 是週裡面的日。這些欄位必須數值代表 24 小時制的時間或 <literal>*</literal> 來代表所有可能的值。<literal>who</literal> 這個欄位只有系統 crontab 才有，用來指定要用那一個使用者來執行指令。最後一個欄位則是要執行的指令。</para>
      </callout>

      <callout arearefs="co-main">
	<para>這個項目定義了該工作所使用的數值，<literal>*/5</literal> 後接著數個 <literal>*</literal> 字元指的是每個月的每一週的每一日的每個小時的每 5 分鐘會使用 <systemitem class="username">root</systemitem> 執行 <command>/usr/libexec/atrun</command>。</para>

	<para>指令可含任何數量的參數，但若指令要使用多行則需以反斜線 <quote>\</quote> 連線字元換行。</para>
      </callout>
    </calloutlist>

    <sect2 xml:id="configtuning-installcrontab">
      <title>建立使用者的 Crontab</title>

      <para>要建立一個使用者 crontab 可使用編輯模式執行 <command>crontab</command>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>crontab -e</userinput></screen>

      <para>這樣會使用預設的文字編輯器來開啟使用者的 crontab，使用者第一次執行這個指令會開啟一個空的檔案，使用者建立 crontab 之後這個指令則會開啟已建立的 crontab 供編輯。</para>

      <para>加入這些行到 crontab 檔的最上方來設定環境變數以及備忘在 crontab 中欄位的意思非常有用：</para>

      <programlisting xml:lang="en">SHELL=/bin/sh
PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin
# Order of crontab fields
# minute	hour	mday	month	wday	command</programlisting>

      <para>然後每一個要執行的指令或 Script 加入一行，指定要執行指令的時間。這個例子會每天在下午 2 點執行指定的自訂 Bourne shell script，由於沒有在 <literal>PATH</literal> 指定 Script 的路徑，所以必須給予完整的 Script 路徑：</para>

      <programlisting xml:lang="en">0	14	*	*	*	/usr/home/dru/bin/mycustomscript.sh</programlisting>

      <tip>
	<para>在使用自訂的 Script 之前，請先確定該 Script 可以執行並且使用 cron 在有限的環境變數下測試。要複製一個用來執行上述 cron 項目的環境可以使用：</para>

	<programlisting xml:lang="en">env -i SHELL=/bin/sh PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin HOME=/home/<replaceable>dru</replaceable> LOGNAME=<replaceable>dru</replaceable> <replaceable>/usr/home/dru/bin/mycustomscript.sh</replaceable></programlisting>

	<para>在 <citerefentry><refentrytitle>crontab</refentrytitle><manvolnum>5</manvolnum></citerefentry> 有討論 cron 使用的環境變數，若 Script 中含有任何會使用萬用字元刪除檔案的指令，那麼檢查 Script 可正常在 cron 的環境運作非常重要。</para>
      </tip>

      <para>編輯完成 crontab 之後儲存檔案，編輯完的 crontab 會被自動安裝且 <application>cron</application> 會讀取該 crontab 並在其指定的時指執行其 cron job。要列出 crontab 中有那一些 cron job 可以使用此指令：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>crontab -l</userinput>
0	14	*	*	*	/usr/home/dru/bin/mycustomscript.sh</screen>

      <para>要移除使用在使用者 crontab 中的 cron job 可：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>crontab -r</userinput>
remove crontab for dru? <userinput>y</userinput></screen>
    </sect2>
  </sect1>

  <sect1 xml:id="configtuning-rcd">
    <info>
      <title>管理 FreeBSD 中的服務</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <para>FreeBSD 在系統初始化時使用 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> 系統的啟動 Script。列於 <filename>/etc/rc.d</filename> 的 Script 提供了基本的服務可使用 <citerefentry><refentrytitle>service</refentrytitle><manvolnum>8</manvolnum></citerefentry> 加上 <option>start</option>, <option>stop</option> 以及 <option>restart</option> 選項來控制。例如，使用以下指令可以重新啟動 <citerefentry><refentrytitle>sshd</refentrytitle><manvolnum>8</manvolnum></citerefentry>：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>service sshd restart</userinput></screen>

    <para>這個程序可以用來在執行中的系統上啟動服務，而在 <citerefentry><refentrytitle>rc.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 中有指定的服務則會在開機時自動啟動。例如，要在系統啟動時開啟 <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry>，可入下行到 <filename>/etc/rc.conf</filename>：</para>

    <programlisting xml:lang="en">natd_enable="YES"</programlisting>

    <para>若 <option>natd_enable="NO"</option> 行已存在，則將 <literal>NO</literal> 更改為 <literal>YES</literal>，在下次開機時 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> script 便會自動載入任何相依的服務，詳細如下所述。</para>

    <para>由於 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> 系統主要用於在系統開機與關機時啟動與停止服務，只有當有服務的變數設定在 <filename>/etc/rc.conf</filename> 時 <option>start</option>, <option>stop</option> 以及 <option>restart</option> 才會有作用。例如 <command>sshd restart</command> 只會在 <filename>/etc/rc.conf</filename> 中的 <varname> sshd_enable</varname> 設為 <option>YES</option> 時才會運作，若要不透過 <filename>/etc/rc.conf</filename> 的設定來 <option>start</option>, <option>stop</option> 或 <option>restart</option> 一個服務則需要在指令前加上 <quote>one</quote>，例如要不透過目前在 <filename>/etc/rc.conf</filename> 的設定重新啟動 <citerefentry><refentrytitle>sshd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 可執行以下指令：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>service sshd onerestart</userinput></screen>

    <para>要檢查一個服務是否有在 <filename>/etc/rc.conf</filename> 開啟，可執行服務的 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> Script 加上 <option>rcvar</option>。這個例子會檢查 <citerefentry><refentrytitle>sshd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 是否在 <filename>/etc/rc.conf</filename> 已經開啟：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>service sshd rcvar</userinput>
# sshd
#
sshd_enable="YES"
#   (default: "")</screen>

    <note>
      <para>行 <literal># sshd</literal> 的輸出來自上述指令，而非 <systemitem class="username">root</systemitem> console。</para>
    </note>

    <para>要判斷是一個服務是否正在執行，可使用 <option>status</option>，例如要確認 <citerefentry><refentrytitle>sshd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 是否正常在執行：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>service sshd status</userinput>
sshd is running as pid 433.</screen>

    <para>在某些情況，也可以 <option>reload</option> 一個服務。這個動作會嘗試發送一個信號給指定的服務，強制服務重新載入其設定檔，在大多數的情況下，發送給服務的信號是 <literal>SIGHUP</literal>。並不是每個服務都有支援此功能。</para>

    <para><citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> 系統會用在網路服務及也應用在大多數的系統初化 。例如執行 <filename>/etc/rc.d/bgfsck</filename> Script 會列印出以下訊息：</para>

    <screen xml:lang="en">Starting background file system checks in 60 seconds.</screen>

    <para>這個 Script 用來在背景做檔案系統檢查，只有在系統初始化時要執行。</para>

    <para>許多系統服務會相依其他服務來運作，例如 <citerefentry><refentrytitle>yp</refentrytitle><manvolnum>8</manvolnum></citerefentry> 及其他以 <acronym>RPC</acronym> 為基礎的服務在 <citerefentry><refentrytitle>rpcbind</refentrytitle><manvolnum>8</manvolnum></citerefentry> 服務啟動前可能會啟動失敗。要解決這種問題，就必須在啟動 Script 上方的註解中加入相依及其他 meta-data。在系統初始化時會用 <citerefentry><refentrytitle>rcorder</refentrytitle><manvolnum>8</manvolnum></citerefentry> 程式分析這些註解來決定要以什麼順序來執行系統服務以滿足相依。</para>

    <para>因 <citerefentry><refentrytitle>rc.subr</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的需要，以下的關鍵字必須加入到所有的啟動 Script 方可 <quote>enable</quote> 啟動 Script：</para>

    <itemizedlist>
      <listitem>
	<para><literal>PROVIDE</literal>: 設定此檔案所提供的服務。</para>
      </listitem>
    </itemizedlist>

    <para>以下關鍵字可能會在每個啟動 Script 的上方引用，雖然非必要，但是對於 <citerefentry><refentrytitle>rcorder</refentrytitle><manvolnum>8</manvolnum></citerefentry> 是非常有用的提示：</para>

    <itemizedlist>
      <listitem>
	<para><literal>REQUIRE</literal>: 列出此服務需要引用的服務。有使用此關鍵字的 Script 會在指定服務啟動 <emphasis>之後</emphasis> 才執行。</para>
      </listitem>

      <listitem>
	<para><literal>BEFORE</literal>: 列出相依此服務的服務。有使用此關鍵字的 Script 會在指定的服務啟動 <emphasis>之前</emphasis> 執行。</para>
      </listitem>
    </itemizedlist>

    <para>透過仔細的設定每個啟動 Script 的這些關鍵字，管理者便可對 Script 的啟動順序進行微調，而不需使用到其他 <trademark class="registered">UNIX</trademark> 作業系統所使用的 <quote>runlevels</quote>。</para>

    <para>額外的資訊可在 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>rc.subr</refentrytitle><manvolnum>8</manvolnum></citerefentry> 中找到。請參考 <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/rc-scripting">此文章</link> 來取得如何建立自訂 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> Script 的操作說明。</para>

    <sect2 xml:id="configtuning-core-configuration">
      <title>管理系統特定的設定</title>

      <indexterm xml:lang="en">
	<primary>rc files</primary>
	<secondary><filename>rc.conf</filename></secondary>
      </indexterm>

      <para>系統設定資訊的主要位於 <filename>/etc/rc.conf</filename>，這個檔案的設定資訊範圍非常廣且會在系統啟動時讀取來設定系統，它也提供設定資訊給 <filename>rc*</filename> 檔案使用。</para>

      <para>在 <filename>/etc/rc.conf</filename> 中的設定項目會覆蓋在 <filename>/etc/defaults/rc.conf</filename> 的預設設定，不應直接編輯該檔案中的預設設定，所有系統特定的設定應到 <filename>/etc/rc.conf</filename> 所修改。</para>

      <para>在叢集應用時要將系統特定的設定與各站特定的設定分開，藉此減少管理成本有好幾種方法，建議的方法是將系統特定的設定放置在 <filename>/etc/rc.conf.local</filename>，例如以下將要套用到所有系統的設定項目放在 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">sshd_enable="YES"
keyrate="fast"
defaultrouter="10.1.1.254"</programlisting>

      <para>而只套用到此系統的設定放在 <filename>/etc/rc.conf.local</filename>：</para>

      <programlisting xml:lang="en">hostname="node1.example.org"
ifconfig_fxp0="inet 10.1.1.1/8"</programlisting>

      <para>使用應用程式如 <application>rsync</application> 或 <application>puppet</application> 將 <filename>/etc/rc.conf</filename> 散布到每個系統，而在各系統保留自己的 <filename>/etc/rc.conf.local</filename>。</para>

      <para>升級系統並不會覆寫 <filename>/etc/rc.conf</filename>，所以系統設定資訊不會因此遺失。</para>

      <tip>
	<para><filename>/etc/rc.conf</filename> 以及 <filename>/etc/rc.conf.local</filename> 兩個檔案都會使用 <citerefentry><refentrytitle>sh</refentrytitle><manvolnum>1</manvolnum></citerefentry> 解析，這讓系統操作者能夠建立較複雜的設定方案。請參考 <citerefentry><refentrytitle>rc.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 來取得更多有關此主題的資訊。</para>
      </tip>
    </sect2>
  </sect1>

  <sect1 xml:id="config-network-setup">
    <info>
      <title>設定網路介面卡</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Fonvieille</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>network cards</primary>
      <secondary>configuration</secondary>
    </indexterm>

    <para>對 FreeBSD 管理者來說加入與設定網路介面卡 (Network Interface Card, <acronym>NIC</acronym>) 會是一件常見的工作。</para>

    <sect2>
      <title>找到正確的驅動程式</title>

      <indexterm xml:lang="en">
	<primary>network cards</primary>
	<secondary>driver</secondary>
      </indexterm>

      <para>首先，要先確定 <acronym>NIC</acronym> 的型號及其使用的晶片。FreeBSD 支援各種 <acronym>NIC</acronym>，可檢查該 FreeBSD 發佈版本的硬體相容性清單來查看是否有支援該 <acronym>NIC</acronym>。</para>

      <para>若有支援該 <acronym>NIC</acronym>，接著要確定該 <acronym>NIC</acronym> 所要需要的 FreeBSD 驅動程式名稱。請參考 <filename>/usr/src/sys/conf/NOTES</filename> 及 <filename>/usr/src/sys/<replaceable>arch</replaceable>/conf/NOTES</filename> 來取得 <acronym>NIC</acronym> 驅動程式清單及其支援的晶片組相關資訊。當有疑問是，請閱讀該驅動程式的操作手冊，會有提供更多有關支援硬體及該驅動程式已知問題的資訊。</para>

      <para><filename>GENERIC</filename> 核心已有內含常見 <acronym>NIC</acronym> 的驅動程式 ，意思是在開機時應該會偵測到 <acronym>NIC</acronym>。可以輸入 <command>more /var/run/dmesg.boot</command> 來檢視系統的開機訊息並使用空白鍵捲動文字。在此例中，兩個乙太網路 <acronym>NIC</acronym> 使用系統已有的 <citerefentry><refentrytitle>dc</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式：</para>

      <screen xml:lang="en">dc0: &lt;82c169 PNIC 10/100BaseTX&gt; port 0xa000-0xa0ff mem 0xd3800000-0xd38
000ff irq 15 at device 11.0 on pci0
miibus0: &lt;MII bus&gt; on dc0
bmtphy0: &lt;BCM5201 10/100baseTX PHY&gt; PHY 1 on miibus0
bmtphy0:  10baseT, 10baseT-FDX, 100baseTX, 100baseTX-FDX, auto
dc0: Ethernet address: 00:a0:cc:da:da:da
dc0: [ITHREAD]
dc1: &lt;82c169 PNIC 10/100BaseTX&gt; port 0x9800-0x98ff mem 0xd3000000-0xd30
000ff irq 11 at device 12.0 on pci0
miibus1: &lt;MII bus&gt; on dc1
bmtphy1: &lt;BCM5201 10/100baseTX PHY&gt; PHY 1 on miibus1
bmtphy1:  10baseT, 10baseT-FDX, 100baseTX, 100baseTX-FDX, auto
dc1: Ethernet address: 00:a0:cc:da:da:db
dc1: [ITHREAD]</screen>

      <para>若在 <filename>GENERIC</filename> 中沒有該 <acronym>NIC</acronym> 的驅動程式，但有可用的驅動程式，那麼在設定及使用 <acronym>NIC</acronym> 前要先載入該驅動程式，有兩種方式可以完成這件事：</para>

      <itemizedlist>
	<listitem>
	  <para>最簡單的方式是使用 <citerefentry><refentrytitle>kldload</refentrytitle><manvolnum>8</manvolnum></citerefentry> 載入 <acronym>NIC</acronym> 要使用的核心模組。要在開機時自動載入，可加入適當的設定到 <filename>/boot/loader.conf</filename>。不是所有 <acronym>NIC</acronym> 驅動程式皆可當做模組使用。</para>
	</listitem>

	<listitem>
	  <para>或者，靜態編譯對 <acronym>NIC</acronym> 的支援到自訂核心，請參考  <filename>/usr/src/sys/conf/NOTES</filename>, <filename>/usr/src/sys/<replaceable>arch</replaceable>/conf/NOTES</filename> 及驅動程式的操作手冊來了解要在自訂核心設定檔中要加入那些設定。要取得更多有關重新編譯核心的資訊可參考 <xref linkend="kernelconfig"/>。若在開機時有偵測到 <acronym>NIC</acronym>，就不需要再重新編譯核心。</para>
	</listitem>
      </itemizedlist>

      <sect3 xml:id="config-network-ndis">
	<title>使用 <trademark class="registered">Windows</trademark> <acronym>NDIS</acronym> 驅動程式</title>

	<indexterm xml:lang="en">
	  <primary><acronym>NDIS</acronym></primary>
	</indexterm>
	<indexterm xml:lang="en">
	  <primary>NDISulator</primary>
	</indexterm>
	<indexterm xml:lang="en">
	  <primary><trademark class="registered">Windows</trademark> drivers</primary>
	</indexterm>
	<indexterm xml:lang="en">
	  <primary><trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark></primary>
	  <secondary>device drivers</secondary>
	</indexterm>
	<indexterm xml:lang="en">
	  <primary><acronym>KLD</acronym> (kernel loadable
	    object)</primary>
	</indexterm>
<!-- We should probably omit the expanded name, and add a <see> entry
for it.  Whatever is done must also be done to the same indexterm in
linuxemu/chapter.xml -->

	<para>很不幸的，仍有很多供應商並沒有提供它們驅動程式的技術文件給開源社群，因為這些文件有涉及商業機密。因此，FreeBSD 及其他作業系統的開發人員只剩下兩種方案可以選擇：透過長期與艱苦的過程做逆向工程來開發驅動程式或是使用現有供 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 平台用的驅動程式 Binary。</para>

	<para>FreeBSD 對 Network Driver Interface Specification (<acronym>NDIS</acronym>) 有提供 <quote>原生</quote> 的支援，這包含了 <citerefentry><refentrytitle>ndisgen</refentrytitle><manvolnum>8</manvolnum></citerefentry> 可用來轉換 <trademark class="registered">Windows</trademark> XP 驅動程式成可在 FreeBSD 上使用的格式。由於 <citerefentry><refentrytitle>ndis</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式使用的是 <trademark class="registered">Windows</trademark> XP binary，所以只能在 <trademark>i386</trademark> 及 amd64 系統上執行。<acronym>PCI</acronym>, CardBus, <acronym>PCMCIA</acronym> 以及 <acronym>USB</acronym> 裝置也都有支援。</para>

	<para>要使用 <citerefentry><refentrytitle>ndisgen</refentrytitle><manvolnum>8</manvolnum></citerefentry> 需要三樣東西：</para>

	<orderedlist>
	  <listitem>
	    <para>FreeBSD 核心原始碼。</para>
	  </listitem>

	  <listitem>
	    <para>一個 <filename>.SYS</filename> 附檔名的 <trademark class="registered">Windows</trademark> XP 驅動程式 Binary。</para>
	  </listitem>

	  <listitem>
	    <para>一個 <filename>.INF</filename> 附檔名的 <trademark class="registered">Windows</trademark> XP 驅動程式設定檔。</para>
	  </listitem>
	</orderedlist>

	<para>下載供指定 <acronym>NIC</acronym> 使用的 <filename>.SYS</filename> 及 <filename>.INF</filename> 檔。通常這些檔案可以在驅動程式 CD 或者供應商的網站上找到。以下範例會使用 <filename>W32DRIVER.SYS</filename> 及 <filename>W32DRIVER.INF</filename>。</para>

	<para>驅動程式的位元寬度必須與 FreeBSD 的版本相符。例如 FreeBSD/i386 需要使用 <trademark class="registered">Windows</trademark> 32-bit 驅動程式，而 FreeBSD/amd64 則需要使用 <trademark class="registered">Windows</trademark> 64-bit 驅動程式。</para>

	<para>下個步驟是編譯驅動程式 Binary 成可載入的核心模組。以 <systemitem class="username">root</systemitem> 身份使用 <citerefentry><refentrytitle>ndisgen</refentrytitle><manvolnum>8</manvolnum></citerefentry>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ndisgen <replaceable>/path/to/W32DRIVER.INF</replaceable> <replaceable>/path/to/W32DRIVER.SYS</replaceable></userinput></screen>

	<para>這個指令是互動式的，會提示輸入任何所需的額外資訊，新的核心模組會被產生在目前的目錄，使用 <citerefentry><refentrytitle>kldload</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來載入新的模組：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>kldload <replaceable>./W32DRIVER_SYS.ko</replaceable></userinput></screen>

	<para>除了產生的核心模組之外，<filename>ndis.ko</filename> 以及 <filename>if_ndis.ko</filename> 也必須載入，會在任何有相依 <citerefentry><refentrytitle>ndis</refentrytitle><manvolnum>4</manvolnum></citerefentry> 的模組被載入時一併自動載入。若沒有自動載入，則需使用以下指令手動載入：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>kldload ndis</userinput>
<prompt>#</prompt> <userinput>kldload if_ndis</userinput></screen>

	<para>第一個指令會載入 <citerefentry><refentrytitle>ndis</refentrytitle><manvolnum>4</manvolnum></citerefentry> miniport 驅動程式包裝程式，而第二個指令會載入產生的 <acronym>NIC</acronym> 驅動程式。</para>

	<para>檢查 <citerefentry><refentrytitle>dmesg</refentrytitle><manvolnum>8</manvolnum></citerefentry> 查看是否有任何載入錯誤，若一切正常，輸出結果應會如下所示：</para>

	<screen xml:lang="en">ndis0: &lt;Wireless-G PCI Adapter&gt; mem 0xf4100000-0xf4101fff irq 3 at device 8.0 on pci1
ndis0: NDIS API version: 5.0
ndis0: Ethernet address: 0a:b1:2c:d3:4e:f5
ndis0: 11b rates: 1Mbps 2Mbps 5.5Mbps 11Mbps
ndis0: 11g rates: 6Mbps 9Mbps 12Mbps 18Mbps 36Mbps 48Mbps 54Mbps</screen>

	<para>到此之後 <filename>ndis0</filename> 可以像任何其他 <acronym>NIC</acronym> 設定使用。</para>

	<para>要設定系統於開機時載入 <citerefentry><refentrytitle>ndis</refentrytitle><manvolnum>4</manvolnum></citerefentry> 模組，可複製產生的模組 <filename>W32DRIVER_SYS.ko</filename> 到 <filename>/boot/modules</filename>。然後加入下行到 <filename>/boot/loader.conf</filename>：</para>

	<programlisting xml:lang="en">W32DRIVER_SYS_load="YES"</programlisting>
      </sect3>
    </sect2>

    <sect2>
      <title>設定網路卡</title>

      <indexterm xml:lang="en">
	<primary>network cards</primary>
	<secondary>configuration</secondary>
      </indexterm>

      <para>載入正確的 <acronym>NIC</acronym> 驅動程式之後，接著需要設定介面卡，這個動作可能在安裝時已經使用 <citerefentry><refentrytitle>bsdinstall</refentrytitle><manvolnum>8</manvolnum></citerefentry> 設定過了。</para>

      <para>要查看 <acronym>NIC</acronym> 設定可輸入以下指令：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>ifconfig</userinput>
dc0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=80008&lt;VLAN_MTU,LINKSTATE&gt;
        ether 00:a0:cc:da:da:da
        inet 192.168.1.3 netmask 0xffffff00 broadcast 192.168.1.255
        media: Ethernet autoselect (100baseTX &lt;full-duplex&gt;)
        status: active
dc1: flags=8802&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=80008&lt;VLAN_MTU,LINKSTATE&gt;
        ether 00:a0:cc:da:da:db
        inet 10.0.0.1 netmask 0xffffff00 broadcast 10.0.0.255
        media: Ethernet 10baseT/UTP
        status: no carrier
lo0: flags=8049&lt;UP,LOOPBACK,RUNNING,MULTICAST&gt; metric 0 mtu 16384
        options=3&lt;RXCSUM,TXCSUM&gt;
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x4
        inet6 ::1 prefixlen 128
        inet 127.0.0.1 netmask 0xff000000
        nd6 options=3&lt;PERFORMNUD,ACCEPT_RTADV&gt;</screen>

      <para>在這個例子中列出了以下裝置：</para>

      <itemizedlist>
	<listitem>
	  <para><filename>dc0</filename>: 第一個乙太網路介面。</para>
	</listitem>

	<listitem>
	  <para><filename>dc1</filename>: 第二個乙太網路介面。</para>
	</listitem>

	<listitem>
	  <para><filename>lo0</filename>: Loopback 裝置。</para>
	</listitem>
      </itemizedlist>

      <para>FreeBSD 會使用驅動程式名稱接著開機時所偵測到的介面卡順序來命名 <acronym>NIC</acronym>。例如 <filename>sis2</filename> 是指在系統上使用 <citerefentry><refentrytitle>sis</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式的第三個 <acronym>NIC</acronym>。</para>

      <para>在此例中，<filename>dc0</filename> 已經上線並且執行中。主要的依據有：</para>

      <orderedlist>
	<listitem>
	  <para><literal>UP</literal> 代表介面卡已設定好並且準備就緒。</para>
	</listitem>

	<listitem>
	  <para>介面卡有網際網路 (<literal>inet</literal>) 位址，<systemitem class="ipaddress">192.168.1.3</systemitem>。</para>
	</listitem>

	<listitem>
	  <para>介面卡有一個有效的子網路遮罩 (<literal>netmask</literal>)，其中 <systemitem class="netmask">0xffffff00</systemitem> 等同於 <systemitem class="netmask">255.255.255.0</systemitem>。</para>
	</listitem>

	<listitem>
	  <para>介面卡有一個有效的廣播位址，<systemitem class="ipaddress">192.168.1.255</systemitem>。</para>
	</listitem>

	<listitem>
	  <para>介面卡 (<literal>ether</literal>) 的 <acronym>MAC</acronym> 位址是 <systemitem class="etheraddress">00:a0:cc:da:da:da</systemitem>。</para>
	</listitem>

	<listitem>
	  <para>實體媒介選擇為自動選擇模式 (<literal>media: Ethernet autoselect (100baseTX &lt;full-duplex&gt;)</literal>)。在本例中 <filename>dc1</filename> 被設定使用 <literal>10baseT/UTP</literal> 媒介。要取得更多有關可用的驅動程式媒介類型請參考操作手冊。</para>
	</listitem>

	<listitem>
	  <para>連結的狀態 (<literal>status</literal>) 為使用中 (<literal>active</literal>)，代表有偵測到載波信號 (Carrier Signal)。若 <filename>dc1</filename> 所代表的介面卡未插入乙太網路線則狀態為 <literal>status: no carrier</literal> 是正常的。</para>
	</listitem>
      </orderedlist>

      <para>若 <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的輸出結果如下：</para>

      <screen xml:lang="en">dc0: flags=8843&lt;BROADCAST,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	options=80008&lt;VLAN_MTU,LINKSTATE&gt;
	ether 00:a0:cc:da:da:da
	media: Ethernet autoselect (100baseTX &lt;full-duplex&gt;)
	status: active</screen>

      <para>則代表尚未設定介面卡。</para>

      <para>介面卡必須以 <systemitem class="username">root</systemitem> 來設定。<acronym>NIC</acronym> 的設定可在指令列執行 <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來完成，但重新開機之後變會消失，除非將設定也加到 <filename>/etc/rc.conf</filename>。若在 LAN 中有 <acronym>DHCP</acronym> 伺服器，則只需加入此行：</para>

      <programlisting xml:lang="en">ifconfig_dc0="DHCP"</programlisting>

      <para>替換 <replaceable>dc0</replaceable> 為該系統的正確值。</para>

      <para>加入這行之後，接著依據 <xref linkend="config-network-testing"/> 指示操作。</para>

      <note>
	<para>若網路在安裝時已設定，可能會已經有 <acronym>NIC</acronym> 的設定項目。在加入任何設定前請再次檢查 <filename>/etc/rc.conf</filename>。</para>
      </note>

      <para>在這個例中，沒有 <acronym>DHCP</acronym> 伺服器，必須手動設定 <acronym>NIC</acronym>。提每一個在系統上的 <acronym>NIC</acronym> 加入一行設定，如此例：</para>

      <programlisting xml:lang="en">ifconfig_dc0="inet 192.168.1.3 netmask 255.255.255.0"
ifconfig_dc1="inet 10.0.0.1 netmask 255.255.255.0 media 10baseT/UTP"</programlisting>

      <para>替換 <filename>dc0</filename> 及 <filename>dc1</filename> 以及 <acronym>IP</acronym> 位址資訊為系統的正確值。請參考驅動程式的操作手冊、<citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>rc.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 取得更多有關可用的選項及 <filename>/etc/rc.conf</filename> 的語法。</para>

      <para>若網路沒有使用 <acronym>DNS</acronym>，則編輯 <filename>/etc/hosts</filename> 加入 <acronym>LAN</acronym> 上主機的名稱與 <acronym>IP</acronym> 位址。要取得更多資訊請參考 <citerefentry><refentrytitle>hosts</refentrytitle><manvolnum>5</manvolnum></citerefentry> 及 <filename>/usr/share/examples/etc/hosts</filename>。</para>

      <note>
	<para>若沒有 <acronym>DHCP</acronym> 伺服器且需要存取網際網路，那麼需要手動設定預設閘道及名稱伺服器：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>echo 'defaultrouter="<replaceable>your_default_router</replaceable>"' &gt;&gt; /etc/rc.conf</userinput>
<prompt>#</prompt> <userinput>echo 'nameserver <replaceable>your_DNS_server</replaceable>' &gt;&gt; /etc/resolv.conf</userinput></screen>
      </note>
    </sect2>

    <sect2 xml:id="config-network-testing">
      <title>測試與疑難排解</title>

      <para>必要的變更儲存到 <filename>/etc/rc.conf</filename> 之後，需要重新啟動系統來測試網路設定並檢查系統重新啟動是否沒有任何設定錯誤。或者使用這個指令將設定套用到網路系統：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service netif restart</userinput></screen>

      <note>
	<para>若預設的通訊閘已設定於 <filename>/etc/rc.conf</filename> 也同樣要下這個指令：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service routing restart</userinput></screen>
      </note>

      <para>網路系統重新啟動後，便可接著測試 <acronym>NIC</acronym>。</para>

      <sect3>
	<title>測試乙太網路卡</title>

	<indexterm xml:lang="en">
	  <primary>network cards</primary>
	  <secondary>testing</secondary>
	</indexterm>

	<para>要檢查乙太網路卡是否已正確設定可 <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry> 介面卡自己，然後 <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry> 其他於 <acronym>LAN</acronym> 上的主機：</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>ping -c5 192.168.1.3</userinput>
PING 192.168.1.3 (192.168.1.3): 56 data bytes
64 bytes from 192.168.1.3: icmp_seq=0 ttl=64 time=0.082 ms
64 bytes from 192.168.1.3: icmp_seq=1 ttl=64 time=0.074 ms
64 bytes from 192.168.1.3: icmp_seq=2 ttl=64 time=0.076 ms
64 bytes from 192.168.1.3: icmp_seq=3 ttl=64 time=0.108 ms
64 bytes from 192.168.1.3: icmp_seq=4 ttl=64 time=0.076 ms

--- 192.168.1.3 ping statistics ---
5 packets transmitted, 5 packets received, 0% packet loss
round-trip min/avg/max/stddev = 0.074/0.083/0.108/0.013 ms</screen>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>ping -c5 192.168.1.2</userinput>
PING 192.168.1.2 (192.168.1.2): 56 data bytes
64 bytes from 192.168.1.2: icmp_seq=0 ttl=64 time=0.726 ms
64 bytes from 192.168.1.2: icmp_seq=1 ttl=64 time=0.766 ms
64 bytes from 192.168.1.2: icmp_seq=2 ttl=64 time=0.700 ms
64 bytes from 192.168.1.2: icmp_seq=3 ttl=64 time=0.747 ms
64 bytes from 192.168.1.2: icmp_seq=4 ttl=64 time=0.704 ms

--- 192.168.1.2 ping statistics ---
5 packets transmitted, 5 packets received, 0% packet loss
round-trip min/avg/max/stddev = 0.700/0.729/0.766/0.025 ms</screen>

	<para>要測試網路解析，可使用主機名稱來替代 <acronym>IP</acronym> 位址。若在網路上沒有 <acronym>DNS</acronym> 伺服器則必須先設定 <filename>/etc/hosts</filename>，若主機尚未設定到 <filename>/etc/hosts</filename> 中，則需編輯 <filename>/etc/hosts</filename> 加入 <acronym>LAN</acronym> 上主機的名稱及 <acronym>IP</acronym> 位址，要取得更多資訊請參考 <citerefentry><refentrytitle>hosts</refentrytitle><manvolnum>5</manvolnum></citerefentry> 及 <filename>/usr/share/examples/etc/hosts</filename>。</para>
      </sect3>

      <sect3>
	<title>疑難排解</title>

	<indexterm xml:lang="en">
	  <primary>network cards</primary>
	  <secondary>troubleshooting</secondary>
	</indexterm>

	<para>在排除硬體及軟體設定問題時，要先檢查幾件簡單的事。網路線插上了沒？網路的服務都正確設定了嗎？防火牆設定是否正確？FreeBSD 是否支援該 <acronym>NIC</acronym>？在回報問題之前，永遠要先檢查 Hardware Notes、更新 FreeBSD 到最新的 STABLE 版本、檢查郵遞論壇封存記錄以及上網查詢。</para>

	<para>若介面卡可以運作，但是效能很差，請閱讀 <citerefentry><refentrytitle>tuning</refentrytitle><manvolnum>7</manvolnum></citerefentry>，同時也要檢查網路設定，因為不正確的網路設定會造成連線速度緩慢。</para>

	<para>部份使用者會遇到一次或兩次 <errorname>device timeout</errorname> 的訊息，在對某些介面卡是正常的。若訊息持續發生或很煩的，請確認是否有與其他的裝置衝突，再次檢查網路線，或考慮使用其他介面卡。</para>

	<para>要解決 <errorname>watchdog timeout</errorname> 錯誤，先檢查網路線。許多介面卡需要使用支援 Bus Mastering 的 <acronym>PCI</acronym> 插槽，在一些舊型的主機板，只會有一個 <acronym>PCI</acronym> 插槽支援，通常是插槽 0。檢查 <acronym>NIC</acronym> 以及主機板說明文件來確定是否為此問題。</para>

	<para>若系統無法路由傳送封包到目標主機則會出現 <errorname>No route to host</errorname> 訊息，這可能是因為沒有指定預設的路由或未插上網路線。請檢查 <command>netstat -rn</command> 的輸出並確認有一個有效的路由可連線至主機，若沒有，請閱讀 <xref linkend="network-routing"/>。</para>

	<para>造成 <errorname>ping: sendto: Permission denied</errorname>  錯誤訊息的原因通常是防火牆設定錯誤。若在 FreeBSD 上有開啟防火牆，但卻未定義任何的規則，預設的原則是拒絕所有傳輸，即使是用 <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry>。請參考 <xref linkend="firewalls"/> 取得更多資訊。</para>

	<para>有時介面卡的效能很差或低於平均值，在這種情況可嘗試設定媒介選擇模式由 <literal>autoselect</literal> 更改為正確的媒介選項，雖然這在大部份硬體可運作，但可能無法解決問題，同樣的，檢查所有網路設定並參考 <citerefentry><refentrytitle>tuning</refentrytitle><manvolnum>7</manvolnum></citerefentry>。</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="configtuning-virtual-hosts">
    <title>虛擬主機</title>

    <indexterm xml:lang="en"><primary>virtual hosts</primary></indexterm>
    <indexterm xml:lang="en"><primary><acronym>IP</acronym>
	aliases</primary></indexterm>

    <para>FreeBSD 最常見的用途之一就是虛擬網站代管，即以一台伺服器在網路上扮演多台伺服器，這可以透過指定多個網路位置到一個網路介面來做到。</para>

    <para>一個網路介面會有一個 <quote>真實 (Real)</quote> 位址且可以有許多個 <quote>別名 (Alias)</quote> 位址。一般會在 <filename>/etc/rc.conf</filename> 中放置別名項目來增加別名，如下例：</para>

    <programlisting xml:lang="en">ifconfig_fxp0_alias0="inet xxx.xxx.xxx.xxx netmask xxx.xxx.xxx.xxx"</programlisting>

    <para>別名項目必須以 <literal>alias<replaceable>0</replaceable></literal> 開頭，使用連續數字例如 <literal>alias0</literal>, <literal>alias1</literal> 以此類推，設定程序會在第一個遇到缺號的地方中止。</para>

    <para>要注意別名網路遮罩 (Netmask) 的計算，使用的介面必須至少有一個正確的填寫網路遮罩的位址，而其他所有在此網路中的位址則必須使用全部 <literal>1</literal> 的網路遮罩，可用 <systemitem class="netmask">255.255.255.255</systemitem> 或 <systemitem class="netmask">0xffffffff</systemitem> 來表示。</para>

    <para>舉例來說，有一個 <filename>fxp0</filename> 介面連結到兩個網路：<systemitem class="ipaddress">10.1.1.0</systemitem> 使用網路遮罩 <systemitem class="netmask">255.255.255.0</systemitem> 以及 <systemitem class="ipaddress">202.0.75.16</systemitem> 使用網路遮罩 <systemitem class="netmask">255.255.255.240</systemitem>。而系統將要設定使用範圍 <systemitem class="ipaddress">10.1.1.1</systemitem> 到 <systemitem class="ipaddress">10.1.1.5</systemitem> 以及 <systemitem class="ipaddress">202.0.75.17</systemitem> 到 <systemitem class="ipaddress">202.0.75.20</systemitem>。在指定的網路範圍中只有第一個位址應使用真實的網路遮罩，其餘 (<systemitem class="ipaddress">10.1.1.2</systemitem> 到 <systemitem class="ipaddress">10.1.1.5</systemitem> 及 <systemitem class="ipaddress">202.0.75.18</systemitem> 到 <systemitem class="ipaddress">202.0.75.20</systemitem>) 則必須設定使用 <systemitem class="netmask">255.255.255.255</systemitem> 的遮罩。</para>

    <para>在此情境下正確設定網路介面的方式如下 <filename>/etc/rc.conf</filename> 中的項目：</para>

    <programlisting xml:lang="en">ifconfig_fxp0="inet 10.1.1.1 netmask 255.255.255.0"
ifconfig_fxp0_alias0="inet 10.1.1.2 netmask 255.255.255.255"
ifconfig_fxp0_alias1="inet 10.1.1.3 netmask 255.255.255.255"
ifconfig_fxp0_alias2="inet 10.1.1.4 netmask 255.255.255.255"
ifconfig_fxp0_alias3="inet 10.1.1.5 netmask 255.255.255.255"
ifconfig_fxp0_alias4="inet 202.0.75.17 netmask 255.255.255.240"
ifconfig_fxp0_alias5="inet 202.0.75.18 netmask 255.255.255.255"
ifconfig_fxp0_alias6="inet 202.0.75.19 netmask 255.255.255.255"
ifconfig_fxp0_alias7="inet 202.0.75.20 netmask 255.255.255.255"</programlisting>

    <para>有一種更簡單的方式可以表達這些設定，便是使用以空白分隔的 <acronym>IP</acronym> 位址清單。只有第一個位址會使用指定的子網路遮罩，其他的位址則會使用 <literal>255.255.255.255</literal> 的子網路遮罩。</para>

    <programlisting xml:lang="en">ifconfig_fxp0_aliases="inet 10.1.1.1-5/24 inet 202.0.75.17-20/28"</programlisting>
  </sect1>

  <sect1 xml:id="configtuning-syslog">
    <info>
      <title>設定系統日誌</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Niclas</firstname>
	    <surname>Zeising</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>system logging</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>syslog</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><citerefentry><refentrytitle>syslogd</refentrytitle><manvolnum>8</manvolnum></citerefentry></primary>
    </indexterm>

    <para>產生與讀取系統日誌對系統管理來說是一件非常重要的事，在系統日誌中的資訊可以用來偵測硬體與軟體的問題，同樣也可以偵測應用程式與系統設定的錯誤。這些資訊在安全性稽查與事件回應也同樣扮演了重要的角色，大多數系統 Daemon 與應用程式都會產生日誌項目。</para>

    <para>FreeBSD 提供了一個系統日誌程式 <application>syslogd</application> 用來管理日誌。預設 <application>syslogd</application> 會與系統開機時啟動。這可使用在 <filename>/etc/rc.conf</filename> 中的變數 <literal>syslogd_enable</literal> 來控制。而且有數個應用程式參數可在 <filename>/etc/rc.conf</filename> 使用 <literal>syslogd_flags</literal> 來設定。請參考 <citerefentry><refentrytitle>syslogd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來取得更多可用參數的資訊。</para>

    <para>此章節會介紹如何設定 FreeBSD 系統日誌程式來做本地與遠端日誌並且介紹如何執行日誌翻轉 (Log rotation) 與日誌管理。</para>

    <sect2>
      <title>設定本地日誌</title>

      <indexterm xml:lang="en"><primary>syslog.conf</primary></indexterm>

      <para>設定檔 <filename>/etc/syslog.conf</filename> 控制 <application>syslogd</application> 收到日誌項目時要做的事情，有數個參數可以用來控制接收到事件時的處理方式。<firstterm>設施 (facility)</firstterm> 用來描述記錄產生訊息的子系統 (subsystem)，如核心或者 Daemon，而 <firstterm>層級 (level)</firstterm> 用來描述所發生的事件嚴重性。也可以依據應用程式所發出的訊息及產生日誌事件機器的主機名稱來決定後續處置的動作。</para>

      <para>此設定檔中一行代表一個動作，每一行的格式皆為一個選擇器欄位 (Selector field) 接著一個動作欄位 (Action field)。選擇器欄位的格式為 <replaceable>facility.level</replaceable> 可以用來比對來自 <replaceable>facility</replaceable> 於層級 <replaceable>level</replaceable> 或更高層的日誌訊息，也可以在層級前加入選擇性的比對旗標來更確切的指定記錄的內容。同樣一個動作可以使用多個選擇器欄位並使用分號 (<literal>;</literal>) 來分隔。用 <literal>*</literal> 可以比對任何東西。動作欄位可用來指定傳送日誌訊息的目標，如一個檔案或遠端日誌主機。範例為以下為 FreeBSD 預設的 <filename>syslog.conf</filename>：</para>

      <programlisting xml:lang="en"># <phrase its:translate="no">$FreeBSD$</phrase>
#
#       Spaces ARE valid field separators in this file. However,
#       other *nix-like systems still insist on using tabs as field
#       separators. If you are sharing this file between systems, you
#       may want to use only tabs as field separators here.
#       Consult the syslog.conf(5) manpage.
*.err;kern.warning;auth.notice;mail.crit                /dev/console
*.notice;authpriv.none;kern.debug;lpr.info;mail.crit;news.err   /var/log/messages
security.*                                      /var/log/security
auth.info;authpriv.info                         /var/log/auth.log
mail.info                                       /var/log/maillog
lpr.info                                        /var/log/lpd-errs
ftp.info                                        /var/log/xferlog
cron.*                                          /var/log/cron
!-devd
*.=debug                                        /var/log/debug.log
*.emerg                                         *
# uncomment this to log all writes to /dev/console to /var/log/console.log
#console.info                                   /var/log/console.log
# uncomment this to enable logging of all log messages to /var/log/all.log
# touch /var/log/all.log and chmod it to mode 600 before it will work
#*.*                                            /var/log/all.log
# uncomment this to enable logging to a remote loghost named loghost
#*.*                                            @loghost
# uncomment these if you're running inn
# news.crit                                     /var/log/news/news.crit
# news.err                                      /var/log/news/news.err
# news.notice                                   /var/log/news/news.notice
# Uncomment this if you wish to see messages produced by devd
# !devd
# *.&gt;=info
!ppp
*.*                                             /var/log/ppp.log
!*</programlisting>

      <para>在這個範例中：</para>

      <itemizedlist>
	<listitem>
	  <para>第 8 行會找出所有符合 <literal>err</literal> 或以上層級的訊息，還有 <literal>kern.warning</literal>, <literal>auth.notice</literal> 與 <literal>mail.crit</literal> 的訊息，然後將這些日誌訊息傳送到 Console (<filename>/dev/console</filename>)。</para>
	</listitem>

	<listitem>
	  <para>第 12 行會找出所有符合 <literal>mail</literal> 設施中於 <literal>info</literal> 或以上層級的訊息，並記錄訊息至 <filename>/var/log/maillog</filename>。</para>
	</listitem>

	<listitem>
	  <para>第 17 行使用了比較旗標 (<literal>=</literal>) 來只找出符合 <literal>debug</literal> 層級的訊息，並將訊息記錄至 <filename>/var/log/debug.log</filename>。</para>
	</listitem>

	<listitem>
	  <para>第 33 行是指定程式的範例用法。這可以讓在該行以下的規則只對指定的程式生效。在此例中，只有由 <application>ppp</application> 產生的訊息會被記錄到 <filename>/var/log/ppp.log</filename>。</para>
	</listitem>
      </itemizedlist>

      <para>所以可用層級從最嚴重到最不嚴重的順序為 <literal>emerg</literal>, <literal>alert</literal>, <literal>crit</literal>, <literal>err</literal>, <literal>warning</literal>, <literal>notice</literal>, <literal>info</literal> 以及 <literal>debug</literal>。</para>

      <para>設施 (facility) 則無特定順序，可用的有 <literal>auth</literal>, <literal>authpriv</literal>, <literal>console</literal>, <literal>cron</literal>, <literal>daemon</literal>, <literal>ftp</literal>, <literal>kern</literal>, <literal>lpr</literal>, <literal>mail</literal>, <literal>mark</literal>, <literal>news</literal>, <literal>security</literal>, <literal>syslog</literal>, <literal>user</literal>, <literal>uucp</literal> 及 <literal>local0</literal> 到 <literal>local7</literal>。要注意在其他作業系統的設施可能會不同。</para>

      <para>要記錄所有所有 <literal>notice</literal> 與以上層級的訊息到 <filename>/var/log/daemon.log</filename> 可加入以下項目：</para>

      <programlisting xml:lang="en">daemon.notice                                        /var/log/daemon.log</programlisting>

      <para>要取得更多有關不同的層級與設施的資訊請參考 <citerefentry><refentrytitle>syslog</refentrytitle><manvolnum>3</manvolnum></citerefentry> 及 <citerefentry><refentrytitle>syslogd</refentrytitle><manvolnum>8</manvolnum></citerefentry>。要取得更多有關 <filename>/etc/syslog.conf</filename>、語法以及更多進階用法範例的資訊請參考 <citerefentry><refentrytitle>syslog.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>。</para>
    </sect2>

    <sect2>
      <title>日誌管理與翻轉</title>

      <indexterm xml:lang="en"><primary>newsyslog</primary></indexterm>
      <indexterm xml:lang="en"><primary>newsyslog.conf</primary></indexterm>
      <indexterm xml:lang="en"><primary>log rotation</primary></indexterm>
      <indexterm xml:lang="en"><primary>log management</primary></indexterm>

      <para>日誌檔案會成長的非常快速，這會消耗磁碟空間並且會更難在日誌中找到有用的資訊，日誌管理便是為了嘗試減緩這種問題。在 FreeBSD 可以使用 <application>newsyslog</application> 來管理日誌檔案，這個內建的程式會定期翻轉 (Rotate) 與壓縮日誌檔案，並且可選擇性的建立遺失的日誌檔案並在日誌檔案被移動位置時通知程式。日誌檔案可能會由 <application>syslogd</application> 產生或由其他任何會產生日誌檔案的程式。<application>newsyslog</application> 正常會由 <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來執行，它並非一個系統 Daemon，預設會每個小時執行一次。</para>

      <para><application>newsyslog</application> 會讀取其設定檔 <filename>/etc/newsyslog.conf</filename> 來決定其要採取的動作，每個要由 <application>newsyslog</application> 所管理的日誌檔案會在此設定檔中設定一行，每一行要說明檔案的擁有者、權限、何時要翻轉該檔案、選用的日誌翻轉旗標，如：壓縮，以及日誌翻轉時要通知的程式。以下為 FreeBSD 的預設設定：</para>

      <programlisting xml:lang="en"># configuration file for newsyslog
# <phrase its:translate="no">$FreeBSD$</phrase>
#
# Entries which do not specify the '/pid_file' field will cause the
# syslogd process to be signalled when that log file is rotated.  This
# action is only appropriate for log files which are written to by the
# syslogd process (ie, files listed in /etc/syslog.conf).  If there
# is no process which needs to be signalled when a given log file is
# rotated, then the entry for that file should include the 'N' flag.
#
# The 'flags' field is one or more of the letters: BCDGJNUXZ or a '-'.
#
# Note: some sites will want to select more restrictive protections than the
# defaults.  In particular, it may be desirable to switch many of the 644
# entries to 640 or 600.  For example, some sites will consider the
# contents of maillog, messages, and lpd-errs to be confidential.  In the
# future, these defaults may change to more conservative ones.
#
# logfilename          [owner:group]    mode count size when  flags [/pid_file] [sig_num]
/var/log/all.log                        600  7     *    @T00  J
/var/log/amd.log                        644  7     100  *     J
/var/log/auth.log                       600  7     100  @0101T JC
/var/log/console.log                    600  5     100  *     J
/var/log/cron                           600  3     100  *     JC
/var/log/daily.log                      640  7     *    @T00  JN
/var/log/debug.log                      600  7     100  *     JC
/var/log/kerberos.log                   600  7     100  *     J
/var/log/lpd-errs                       644  7     100  *     JC
/var/log/maillog                        640  7     *    @T00  JC
/var/log/messages                       644  5     100  @0101T JC
/var/log/monthly.log                    640  12    *    $M1D0 JN
/var/log/pflog                          600  3     100  *     JB    /var/run/pflogd.pid
/var/log/ppp.log        root:network    640  3     100  *     JC
/var/log/devd.log                       644  3     100  *     JC
/var/log/security                       600  10    100  *     JC
/var/log/sendmail.st                    640  10    *    168   B
/var/log/utx.log                        644  3     *    @01T05 B
/var/log/weekly.log                     640  5     1    $W6D0 JN
/var/log/xferlog                        600  7     100  *     JC</programlisting>

      <para>每一行的開始為要翻轉的日誌名稱、接著是供翻轉與新建檔案使用的擁有者及群組 (選填)。<literal>mode</literal> 欄位可設定日誌檔案的權限，<literal>count</literal> 代表要保留多少個翻轉過的日誌檔案，而 <literal>size</literal> 與 <literal>when</literal> 欄位會告訴 <application>newsyslog</application> 何時要翻轉該檔案。日誌檔案會在當其檔案超過 <literal>size</literal> 欄位的大小或已超過 <literal>when</literal> 欄位指定的時間時翻轉，可使用星號 (<literal>*</literal>) 忽略該欄位。<replaceable>flags</replaceable> 欄位可以給予進階的參數，例如：如何壓縮翻轉後檔案或建立遺失的日誌檔案。最後兩個欄位皆為選填，可指定程序的程序 ID (<acronym>PID</acronym>) 檔名稱以及檔案翻轉後要傳送給該程序的信號 (Signal) 編號。</para>

      <para>要取的更多有關所有欄位、可用的旗標及如何指定翻轉時間，請參考 <citerefentry><refentrytitle>newsyslog.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>。由於 <application>newsyslog</application> 是由 <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> 執行，因此無法比其在 <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> 中所排定的時間間距內更頻繁的執行翻轉檔案。</para>
    </sect2>

    <sect2 xml:id="network-syslogd">
      <info>
	<title>設定遠端日誌</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Tom</firstname>
	      <surname>Rhodes</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para xml:lang="en">Monitoring the log files of multiple hosts can become
	unwieldy as the number of systems increases.  Configuring
	centralized logging can reduce some of the administrative
	burden of log file administration.</para>

      <para xml:lang="en">In FreeBSD, centralized log file aggregation, merging, and
	rotation can be configured using
	<application>syslogd</application> and
	<application>newsyslog</application>.  This section
	demonstrates an example configuration, where host
	<systemitem>A</systemitem>, named <systemitem class="fqdomainname">logserv.example.com</systemitem>, will
	collect logging information for the local network.  Host
	<systemitem>B</systemitem>, named <systemitem class="fqdomainname">logclient.example.com</systemitem>,
	will be configured to pass logging information to the logging
	server.</para>

      <sect3>
	<title>日誌伺服器設定</title>

	<para xml:lang="en">A log server is a system that has been configured to
	  accept logging information from other hosts.  Before
	  configuring a log server, check the following:</para>

	<itemizedlist>
	  <listitem>
	    <para xml:lang="en">If there is a firewall between the logging server
	      and any logging clients, ensure that the firewall
	      ruleset allows <acronym>UDP</acronym> port 514 for both
	      the clients and the server.</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">The logging server and all client  machines must
	      have forward and reverse entries in the local
	      <acronym>DNS</acronym>.  If the network does not have a
	      <acronym>DNS</acronym> server, create entries in each
	      system's <filename>/etc/hosts</filename>.  Proper name
	      resolution is required so that log entries are not
	      rejected by the logging server.</para>
	  </listitem>
	</itemizedlist>

	<para xml:lang="en">On the log server, edit
	  <filename>/etc/syslog.conf</filename> to specify the name of
	  the client to receive log entries from, the logging facility
	  to be used, and the name of the log to store the host's log
	  entries.  This example adds the hostname of
	  <systemitem>B</systemitem>, logs all facilities, and stores
	  the log entries in
	  <filename>/var/log/logclient.log</filename>.</para>

	<example>
	  <title>日誌伺服器設定範例</title>

	  <programlisting xml:lang="en">+logclient.example.com
*.*     /var/log/logclient.log</programlisting>
	</example>

	<para xml:lang="en">When adding multiple log clients, add a similar two-line
	  entry for each client.  More information about the available
	  facilities may be found in <citerefentry><refentrytitle>syslog.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

	<para xml:lang="en">Next, configure
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">syslogd_enable="YES"
syslogd_flags="-a logclient.example.com -v -v"</programlisting>

	<para xml:lang="en">The first entry starts
	  <application>syslogd</application> at system boot.  The
	  second entry allows log entries from the specified client.
	  The <option>-v -v</option> increases the verbosity of logged
	  messages.  This is useful for tweaking facilities as
	  administrators are able to see what type of messages are
	  being logged under each facility.</para>

	<para xml:lang="en">Multiple <option>-a</option> options may be specified to
	  allow logging from multiple clients.  <acronym>IP</acronym>
	  addresses and whole netblocks may also be specified.  Refer
	  to <citerefentry><refentrytitle>syslogd</refentrytitle><manvolnum>8</manvolnum></citerefentry> for a full list of possible
	  options.</para>

	<para xml:lang="en">Finally, create the log file:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>touch /var/log/logclient.log</userinput></screen>

	<para xml:lang="en">At this point, <application>syslogd</application> should
	  be restarted and verified:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service syslogd restart</userinput>
<prompt>#</prompt> <userinput>pgrep syslog</userinput></screen>

	<para xml:lang="en">If a <acronym>PID</acronym> is returned, the server
	  restarted successfully, and client configuration can begin.
	  If the server did not restart, consult
	  <filename>/var/log/messages</filename> for the error.</para>
      </sect3>

      <sect3>
	<title>日誌客戶端設定</title>

	<para xml:lang="en">A logging client sends log entries to a logging server
	  on the network.  The client also keeps a local copy of its
	  own logs.</para>

	<para xml:lang="en">Once a logging server has been configured, edit
	  <filename>/etc/rc.conf</filename> on the logging
	  client:</para>

	<programlisting xml:lang="en">syslogd_enable="YES"
syslogd_flags="-s -v -v"</programlisting>

	<para xml:lang="en">The first entry enables
	  <application>syslogd</application> on boot up.  The second
	  entry prevents logs from being accepted by this client from
	  other hosts (<option>-s</option>) and increases the
	  verbosity of logged messages.</para>

	<para xml:lang="en">Next, define the logging server in the client's
	  <filename>/etc/syslog.conf</filename>.  In this example, all
	  logged facilities are sent to a remote system, denoted by
	  the <literal>@</literal> symbol, with the specified
	  hostname:</para>

	<programlisting xml:lang="en">*.*		@logserv.example.com</programlisting>

	<para xml:lang="en">After saving the edit, restart
	  <application>syslogd</application> for the changes to take
	  effect:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service syslogd restart</userinput></screen>

	<para xml:lang="en">To test that log messages are being sent across the
	  network, use <citerefentry><refentrytitle>logger</refentrytitle><manvolnum>1</manvolnum></citerefentry> on the client to send a message
	  to <application>syslogd</application>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>logger "<replaceable>Test message from logclient</replaceable>"</userinput></screen>

	<para xml:lang="en">This message should now exist both in
	  <filename>/var/log/messages</filename> on the client and
	  <filename>/var/log/logclient.log</filename> on the log
	  server.</para>
      </sect3>

      <sect3>
	<title>日誌伺服器除錯</title>

	<para xml:lang="en">If no messages are being received on the log server, the
	  cause is most likely a network connectivity issue, a
	  hostname resolution issue, or a typo in a configuration
	  file.  To isolate the cause, ensure that both the logging
	  server and the logging client are able to
	  <command>ping</command> each other using the hostname
	  specified in their <filename>/etc/rc.conf</filename>.  If
	  this fails, check the network cabling, the firewall ruleset,
	  and the hostname entries in the <acronym>DNS</acronym>
	  server or <filename>/etc/hosts</filename> on both the
	  logging server and clients.  Repeat until the
	  <command>ping</command> is successful from both
	  hosts.</para>

	<para xml:lang="en">If the <command>ping</command> succeeds on both hosts
	  but log messages are still not being received, temporarily
	  increase logging verbosity to narrow down the configuration
	  issue.  In the following example,
	  <filename>/var/log/logclient.log</filename> on the logging
	  server is empty and <filename>/var/log/messages</filename>
	  on the logging client does not indicate a reason for the
	  failure.  To increase debugging output, edit the
	  <literal>syslogd_flags</literal> entry on the logging server
	  and issue a restart:</para>

	<programlisting xml:lang="en">syslogd_flags="-d -a logclient.example.com -v -v"</programlisting>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service syslogd restart</userinput></screen>

	<para xml:lang="en">Debugging data similar to the following will flash on
	  the console immediately after the restart:</para>

	<screen xml:lang="en">logmsg: pri 56, flags 4, from logserv.example.com, msg syslogd: restart
syslogd: restarted
logmsg: pri 6, flags 4, from logserv.example.com, msg syslogd: kernel boot file is /boot/kernel/kernel
Logging to FILE /var/log/messages
syslogd: kernel boot file is /boot/kernel/kernel
cvthname(192.168.1.10)
validate: dgram from IP 192.168.1.10, port 514, name logclient.example.com;
rejected in rule 0 due to name mismatch.</screen>

	<para xml:lang="en">In this example, the log messages are being rejected due
	  to a typo which results in a hostname mismatch.  The
	  client's hostname should be <literal>logclient</literal>,
	  not <literal>logclien</literal>.  Fix the typo, issue a
	  restart, and verify the results:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service syslogd restart</userinput>
logmsg: pri 56, flags 4, from logserv.example.com, msg syslogd: restart
syslogd: restarted
logmsg: pri 6, flags 4, from logserv.example.com, msg syslogd: kernel boot file is /boot/kernel/kernel
syslogd: kernel boot file is /boot/kernel/kernel
logmsg: pri 166, flags 17, from logserv.example.com,
msg Dec 10 20:55:02 &lt;syslog.err&gt; logserv.example.com syslogd: exiting on signal 2
cvthname(192.168.1.10)
validate: dgram from IP 192.168.1.10, port 514, name logclient.example.com;
accepted in rule 0.
logmsg: pri 15, flags 0, from logclient.example.com, msg Dec 11 02:01:28 trhodes: Test message 2
Logging to FILE /var/log/logclient.log
Logging to FILE /var/log/messages</screen>

	<para xml:lang="en">At this point, the messages are being properly received
	  and placed in the correct file.</para>
      </sect3>

      <sect3>
	<title>安全注意事項</title>

	<para xml:lang="en">As with any network service, security requirements
	  should be considered before implementing a logging server.
	  Log files may contain sensitive data about services enabled
	  on the local host, user accounts, and configuration data.
	  Network data sent from the client to the server will not be
	  encrypted or password protected.  If a need for encryption
	  exists, consider using <package>security/stunnel</package>,
	  which will transmit the logging data over an encrypted
	  tunnel.</para>

	<para xml:lang="en">Local security is also an issue.  Log files are not
	  encrypted during use or after log rotation.  Local users may
	  access log files to gain additional insight into system
	  configuration.  Setting proper permissions on log files is
	  critical.  The built-in log rotator,
	  <application>newsyslog</application>, supports setting
	  permissions on newly created and rotated log files.  Setting
	  log files to mode <literal>600</literal> should prevent
	  unwanted access by local users.  Refer to
	  <citerefentry><refentrytitle>newsyslog.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for additional information.</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="configtuning-configfiles">
    <title>設定檔</title>

    <sect2>
      <title><filename>/etc</filename> 配置</title>

      <para>有數個目錄中儲存著設定資訊，這些目錄有：</para>

      <informaltable frame="none" pgwide="1">
	<tgroup cols="2">
	  <colspec colwidth="1*"/>
	  <colspec colwidth="2*"/>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><filename>/etc</filename></entry>
	      <entry>通用系統特定的設定資訊。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/etc/defaults</filename></entry>
	      <entry>系統設定檔的預設版本。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/etc/mail</filename></entry>
	      <entry><citerefentry><refentrytitle>sendmail</refentrytitle><manvolnum>8</manvolnum></citerefentry> 額外的設定以及其他 <acronym>MTA</acronym> 設定檔。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/etc/ppp</filename></entry>
	      <entry>user- 及 kernel-ppp 程式的設定。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/local/etc</filename></entry>
	      <entry>已安裝應用程式的設定檔，可能會有以應用程式區分的子目錄。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/usr/local/etc/rc.d</filename></entry>
	      <entry>已安裝應用程式的 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> Script。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><filename>/var/db</filename></entry>
	      <entry>自動產生的系統特定資料庫檔案，例如套件資料庫以及 <citerefentry><refentrytitle>locate</refentrytitle><manvolnum>1</manvolnum></citerefentry> 資料庫。</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable>
    </sect2>

    <sect2>
      <title>主機名稱</title>

      <indexterm xml:lang="en"><primary>hostname</primary></indexterm>
      <indexterm xml:lang="en"><primary>DNS</primary></indexterm>

      <sect3>
	<title xml:lang="en"><filename>/etc/resolv.conf</filename></title>

	<indexterm xml:lang="en">
	  <primary><filename>resolv.conf</filename></primary>
	</indexterm>

	<para>FreeBSD 要如何存取網際網路網域名稱系統 (Internet Domain Name System, <acronym>DNS</acronym>) 是由 <citerefentry><refentrytitle>resolv.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 來控制。</para>

	<para><filename>/etc/resolv.conf</filename> 中最常用的項目為：</para>

	<informaltable frame="none" pgwide="1">
	  <tgroup cols="2">
	    <colspec colwidth="1*"/>
	    <colspec colwidth="2*"/>

	    <tbody>
	      <row>
		<entry xml:lang="en"><literal>nameserver</literal></entry>
		<entry>解析程式 (Resolver) 要查詢的名稱伺服器 <acronym>IP</acronym> 位置，這些伺服器會依所列的順序來查詢，最多可以有三個。</entry>
	      </row>

	      <row>
		<entry xml:lang="en"><literal>search</literal></entry>
		<entry>主機名稱查詢使用的搜尋清單。這通常會使用本機主機名稱所在的網域。</entry>
	      </row>

	      <row>
		<entry xml:lang="en"><literal>domain</literal></entry>
		<entry>本地網域名稱。</entry>
	      </row>
	    </tbody>
	  </tgroup>
	</informaltable>

	<para>典型的 <filename>/etc/resolv.conf</filename> 會如下：</para>

	<programlisting xml:lang="en">search example.com
nameserver 147.11.1.11
nameserver 147.11.100.30</programlisting>

	<note>
	  <para><literal>search</literal> 與 <literal>domain</literal> 選項應擇一使用。</para>
	</note>

	<para>當使用 <acronym>DHCP</acronym> 時，<citerefentry><refentrytitle>dhclient</refentrytitle><manvolnum>8</manvolnum></citerefentry> 通常會使用從 <acronym>DHCP</acronym> 伺服器所接收到的資訊覆寫 <filename>/etc/resolv.conf</filename>。</para>
      </sect3>

      <sect3>
	<title xml:lang="en"><filename>/etc/hosts</filename></title>

	<indexterm xml:lang="en"><primary>hosts</primary></indexterm>

	<para><filename>/etc/hosts</filename> 是簡單的文字資料庫，會與 <acronym>DNS</acronym> 及 <acronym>NIS</acronym> 一併使用來提供主機名稱與 <acronym>IP</acronym> 位址的對應。可將透過 <acronym>LAN</acronym> 所連結的在地電腦項目加入到這個檔案做最簡單的命名，來替代設定一個 <citerefentry><refentrytitle>named</refentrytitle><manvolnum>8</manvolnum></citerefentry> 伺服器。除此之外 <filename>/etc/hosts</filename> 可以用來提供本地的網際網路名稱記錄，來減少常用名稱向外部 <acronym>DNS</acronym> 伺服器查詢的需求。</para>

	<programlisting xml:lang="en"># <phrase its:translate="no">$FreeBSD$</phrase>
#
#
# Host Database
#
# This file should contain the addresses and aliases for local hosts that
# share this file.  Replace 'my.domain' below with the domainname of your
# machine.
#
# In the presence of the domain name service or NIS, this file may
# not be consulted at all; see /etc/nsswitch.conf for the resolution order.
#
#
::1			localhost localhost.my.domain
127.0.0.1		localhost localhost.my.domain
#
# Imaginary network.
#10.0.0.2		myname.my.domain myname
#10.0.0.3		myfriend.my.domain myfriend
#
# According to RFC 1918, you can use the following IP networks for
# private nets which will never be connected to the Internet:
#
#	10.0.0.0	-   10.255.255.255
#	172.16.0.0	-   172.31.255.255
#	192.168.0.0	-   192.168.255.255
#
# In case you want to be able to connect to the Internet, you need
# real official assigned numbers.  Do not try to invent your own network
# numbers but instead get one from your network provider (if any) or
# from your regional registry (ARIN, APNIC, LACNIC, RIPE NCC, or AfriNIC.)
#</programlisting>

	<para><filename>/etc/hosts</filename> 的格式如下：</para>

	<programlisting xml:lang="en">[Internet address] [official hostname] [alias1] [alias2] ...</programlisting>

	<para>例如：</para>

	<programlisting xml:lang="en">10.0.0.1 myRealHostname.example.com myRealHostname foobar1 foobar2</programlisting>

	<para>請參考 <citerefentry><refentrytitle>hosts</refentrytitle><manvolnum>5</manvolnum></citerefentry> 取得更多資訊。</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="configtuning-sysctl">
    <title>使用 <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 調校</title>

    <indexterm xml:lang="en"><primary>sysctl</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>tuning</primary>
      <secondary>with sysctl</secondary>
    </indexterm>

    <para><citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 可用來更改執行中的 FreeBSD 系統，這包含許多 <acronym>TCP/IP</acronym> 堆疊及虛擬記憶體系統的進階選項，讓有經驗的系統管理者能夠簡單的提升效能。有超過五百個系統變數可以使用 <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來讀取與設定。</para>

    <para><citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 主要提供兩個功能：讀取與修改系統設定。</para>

    <para>檢視所有可讀取的變數：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>sysctl -a</userinput></screen>

    <para>要讀取特定變數只要指定其名稱：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>sysctl kern.maxproc</userinput>
kern.maxproc: 1044</screen>

    <para>要設定特定變數可使用 <replaceable>variable</replaceable>=<replaceable>value</replaceable> 語法：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl kern.maxfiles=5000</userinput>
kern.maxfiles: 2088 -&gt; 5000</screen>

    <para>sysctl 的設定值通常為字串、數字或布林值，其中布林值的 <literal>1</literal> 代表是，<literal>0</literal> 代表否。</para>

    <para>要在每次機器開機時自動設定一些變數可將其加入到 <filename>/etc/sysctl.conf</filename>。要取得更多的資訊請參考 <citerefentry><refentrytitle>sysctl.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 及 <xref linkend="configtuning-sysctlconf"/>。</para>

    <sect2 xml:id="configtuning-sysctlconf">
      <title xml:lang="en"><filename>sysctl.conf</filename></title>

      <indexterm xml:lang="en"><primary>sysctl.conf</primary></indexterm>
      <indexterm xml:lang="en"><primary>sysctl</primary></indexterm>

      <para><citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的設定檔於 <filename>/etc/sysctl.conf</filename>，內容很像 <filename>/etc/rc.conf</filename>，設定數值使用 <literal>variable=value</literal> 格式。指定的數值會在系統進入多使用者模式時設定，但並非所有變數皆可在此模式設定。</para>

      <para>例如，要關閉嚴重信號 (Fatal signal) 中止的記錄並避免使用者看到其他使用者所執行的程序，可加入以下設定到 <filename>/etc/sysctl.conf</filename>：</para>

      <programlisting xml:lang="en"># Do not log fatal signal exits (e.g., sig 11)
kern.logsigexit=0

# Prevent users from seeing information about processes that
# are being run under another UID.
security.bsd.see_other_uids=0</programlisting>
    </sect2>

    <sect2 xml:id="sysctl-readonly">
      <info>
	<title>唯讀 <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry></title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Tom</firstname>
	      <surname>Rhodes</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para>在有些情況可能會需要修改唯讀的 <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 數值，而這會需要重新啟動系統。</para>

      <para>例如，某些筆電型號的 <citerefentry><refentrytitle>cardbus</refentrytitle><manvolnum>4</manvolnum></citerefentry> 裝置無法偵測到記憶體範圍而且會失效並有類似以下的錯誤：</para>

      <screen xml:lang="en">cbb0: Could not map register memory
device_probe_and_attach: cbb0 attach returned 12</screen>

      <para>這個修正需要修改唯讀的 <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 設定。加入 <option>hw.pci.allow_unsupported_io_range=1</option> 到 <filename>/boot/loader.conf</filename> 然後重新啟動。現在 <citerefentry><refentrytitle>cardbus</refentrytitle><manvolnum>4</manvolnum></citerefentry> 應可正常運作。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="configtuning-disk">
    <title>調校磁碟</title>

    <para>接下來的章節會討論在磁碟裝置上各種可調校的機制與選項。在大多數案例中，有使用機械元件的硬碟，如 <acronym>SCSI</acronym> 磁碟機，會成為導致整體系統效能低下的瓶頸。雖然已經有不使用機械元件的磁碟機解決方案，如，固態硬碟，但使用機械元件的磁碟機短期內並不會消失。在調校磁碟時，建議可以利用 <citerefentry><refentrytitle>iostat</refentrytitle><manvolnum>8</manvolnum></citerefentry> 指令的功能來測試各種對系統的變更，這個指令可讓使用者取得系統 <acronym>IO</acronym> 相關的有用資訊。</para>

    <sect2>
      <title>Sysctl 變數</title>

      <sect3>
	<title xml:lang="en"><varname>vfs.vmiodirenable</varname></title>

	<indexterm xml:lang="en">
	  <primary><varname>vfs.vmiodirenable</varname></primary>
	</indexterm>

	<para xml:lang="en">The <varname>vfs.vmiodirenable</varname> <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	  variable
	  may be set to either <literal>0</literal> (off) or
	  <literal>1</literal> (on).  It is set to
	  <literal>1</literal> by default.  This variable controls
	  how directories are cached by the system.  Most directories
	  are small, using just a single fragment (typically 1 K)
	  in the file system and typically 512 bytes in the
	  buffer cache.  With this variable turned off, the buffer
	  cache will only cache a fixed number of directories, even
	  if the system has a huge amount of memory.  When turned on,
	  this <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> allows the buffer cache to use the
	  <acronym>VM</acronym> page cache to cache the directories,
	  making all the memory available for caching directories.
	  However, the minimum in-core memory used to cache a
	  directory is the physical page size (typically 4 K)
	  rather than 512  bytes.  Keeping this option enabled
	  is recommended if the system is running any services which
	  manipulate large numbers of files.  Such services can
	  include web caches, large mail systems, and news systems.
	  Keeping this option on will generally not reduce
	  performance, even with the wasted memory, but one should
	  experiment to find out.</para>
      </sect3>

      <sect3>
	<title xml:lang="en"><varname>vfs.write_behind</varname></title>

	<indexterm xml:lang="en">
	  <primary><varname>vfs.write_behind</varname></primary>
	</indexterm>

	<para xml:lang="en">The <varname>vfs.write_behind</varname> <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	  variable
	  defaults to <literal>1</literal> (on).  This tells the file
	  system to issue media writes as full clusters are collected,
	  which typically occurs when writing large sequential files.
	  This avoids saturating the buffer cache with dirty buffers
	  when it would not benefit I/O performance.  However, this
	  may stall processes and under certain circumstances should
	  be turned off.</para>
      </sect3>

      <sect3>
	<title xml:lang="en"><varname>vfs.hirunningspace</varname></title>

	<indexterm xml:lang="en">
	  <primary><varname>vfs.hirunningspace</varname></primary>
	</indexterm>

	<para xml:lang="en">The <varname>vfs.hirunningspace</varname> <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	  variable determines how much outstanding write I/O may be
	  queued to disk controllers system-wide at any given
	  instance.  The default is usually sufficient, but on
	  machines with many disks, try bumping it up to four or five
	  <emphasis>megabytes</emphasis>.  Setting too high a value
	  which exceeds the buffer cache's write threshold can lead
	  to bad clustering performance.  Do not set this value
	  arbitrarily high as higher write values may add latency to
	  reads occurring at the same time.</para>

	<para xml:lang="en">There are various other buffer cache and
	  <acronym>VM</acronym> page cache related <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	  values.  Modifying these values is not recommended as the
	  <acronym>VM</acronym> system does a good job of
	  automatically tuning itself.</para>
      </sect3>

      <sect3>
	<title xml:lang="en"><varname>vm.swap_idle_enabled</varname></title>

	<indexterm xml:lang="en">
	  <primary><varname>vm.swap_idle_enabled</varname></primary>
	</indexterm>

	<para xml:lang="en">The <varname>vm.swap_idle_enabled</varname>
	  <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> variable is useful in large multi-user
	  systems with many active login users and lots of idle
	  processes.  Such systems tend to generate continuous
	  pressure on free memory reserves.  Turning this feature on
	  and tweaking the swapout hysteresis (in idle seconds) via
	  <varname>vm.swap_idle_threshold1</varname> and
	  <varname>vm.swap_idle_threshold2</varname> depresses the
	  priority of memory pages associated with idle processes more
	  quickly then the normal pageout algorithm.  This gives a
	  helping hand to the pageout daemon.  Only turn this option
	  on if needed, because the tradeoff is essentially pre-page
	  memory sooner rather than later which eats more swap and
	  disk bandwidth.  In a small system this option will have a
	  determinable effect, but in a large system that is already
	  doing moderate paging, this option allows the
	  <acronym>VM</acronym> system to stage whole processes into
	  and out of memory easily.</para>
      </sect3>

      <sect3>
	<title xml:lang="en"><varname>hw.ata.wc</varname></title>

	<indexterm xml:lang="en">
	  <primary><varname>hw.ata.wc</varname></primary>
	</indexterm>

	<para xml:lang="en">Turning off <acronym>IDE</acronym> write caching reduces
	  write bandwidth to <acronym>IDE</acronym> disks, but may
	  sometimes be necessary due to data consistency issues
	  introduced by hard drive vendors.  The problem is that
	  some <acronym>IDE</acronym> drives lie about when a write
	  completes.  With <acronym>IDE</acronym> write caching
	  turned on, <acronym>IDE</acronym> hard drives write data
	  to disk out of order and will sometimes delay writing some
	  blocks indefinitely when under heavy disk load.  A crash or
	  power failure may cause serious file system corruption.
	  Check the default on the system by observing the
	  <varname>hw.ata.wc</varname> <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> variable.  If
	  <acronym>IDE</acronym> write caching is turned off, one can
	  set this read-only variable to
	  <literal>1</literal> in
	  <filename>/boot/loader.conf</filename> in order to enable
	  it at boot time.</para>

	<para xml:lang="en">For more information, refer to <citerefentry><refentrytitle>ata</refentrytitle><manvolnum>4</manvolnum></citerefentry>.</para>
      </sect3>

      <sect3>
	<title xml:lang="en"><literal>SCSI_DELAY</literal>
	  (<varname>kern.cam.scsi_delay</varname>)</title>

	<indexterm xml:lang="en">
	  <primary><varname>kern.cam.scsi_delay</varname></primary>
	</indexterm>

	<indexterm><primary>核心選項</primary> <secondary><literal>SCSI DELAY</literal></secondary></indexterm>

	<para xml:lang="en">The <literal>SCSI_DELAY</literal> kernel configuration
	  option may be used to reduce system boot times.  The
	  defaults are fairly high and can be responsible for
	  <literal>15</literal> seconds of delay in the boot process.
	  Reducing it to <literal>5</literal> seconds usually works
	  with modern drives.  The
	  <varname>kern.cam.scsi_delay</varname> boot time tunable
	  should be used.  The tunable and kernel configuration
	  option accept values in terms of
	  <emphasis>milliseconds</emphasis> and
	  <emphasis>not</emphasis>
	  <emphasis>seconds</emphasis>.</para>
      </sect3>
    </sect2>

    <sect2 xml:id="soft-updates">
      <title>軟更新</title>

      <indexterm xml:lang="en"><primary>Soft Updates</primary></indexterm>
      <indexterm xml:lang="en"><primary><citerefentry><refentrytitle>tunefs</refentrytitle><manvolnum>8</manvolnum></citerefentry></primary></indexterm>

      <para xml:lang="en">To fine-tune a file system, use <citerefentry><refentrytitle>tunefs</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  This
	program has many different options.  To toggle Soft Updates
	on and off, use:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>tunefs -n enable /filesystem</userinput>
<prompt>#</prompt> <userinput>tunefs -n disable /filesystem</userinput></screen>

      <para xml:lang="en">A file system cannot be modified with <citerefentry><refentrytitle>tunefs</refentrytitle><manvolnum>8</manvolnum></citerefentry> while
	it is mounted.  A good time to enable Soft Updates is before
	any partitions have been mounted, in single-user mode.</para>

      <para xml:lang="en">Soft Updates is recommended for <acronym>UFS</acronym>
	file systems as it drastically improves meta-data performance,
	mainly file creation and deletion, through the use of a memory
	cache.  There are two downsides to Soft Updates to be aware
	of.  First, Soft Updates guarantee file system consistency
	in the case of a crash, but could easily be several seconds
	or even a minute behind updating the physical disk.  If the
	system crashes, unwritten data may be lost.  Secondly, Soft
	Updates delay the freeing of file system blocks.  If the
	root file system is almost full, performing a major update,
	such as <command>make installworld</command>, can cause the
	file system to run out of space and the update to fail.</para>

      <sect3>
	<title>有關軟更新的更多詳細資訊</title>

	<indexterm xml:lang="en">
	  <primary>Soft Updates</primary>
	  <secondary>details</secondary>
	</indexterm>

	<para xml:lang="en">Meta-data updates are updates to non-content data like
	  inodes or directories.  There are two traditional approaches
	  to writing a file system's meta-data back to disk.</para>

	<para xml:lang="en">Historically, the default behavior was to write out
	  meta-data updates synchronously.  If a directory changed,
	  the system waited until the change was actually written to
	  disk.  The file data buffers (file contents) were passed
	  through the buffer cache and backed up to disk later on
	  asynchronously.  The advantage of this implementation is
	  that it operates safely.  If there is a failure during an
	  update, meta-data is always in a consistent state.  A
	  file is either created completely or not at all.  If the
	  data blocks of a file did not find their way out of the
	  buffer cache onto the disk by the time of the crash,
	  <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry> recognizes this and repairs the file system
	  by setting the file length to <literal>0</literal>.
	  Additionally, the implementation is clear and simple.  The
	  disadvantage is that meta-data changes are slow.  For
	  example, <command>rm -r</command> touches all the files in a
	  directory sequentially, but each directory change will be
	  written synchronously to the disk.  This includes updates to
	  the directory itself, to the inode table, and possibly to
	  indirect blocks allocated by the file.  Similar
	  considerations apply for unrolling large hierarchies using
	  <command>tar -x</command>.</para>

	<para xml:lang="en">The second approach is to use asynchronous meta-data
	  updates.  This is the default for a <acronym>UFS</acronym>
	  file system mounted with <command>mount -o async</command>.
	  Since all meta-data updates are also passed through the
	  buffer cache, they will be intermixed with the updates of
	  the file content data.  The advantage of this
	  implementation is there is no need to wait until each
	  meta-data update has been written to disk, so all operations
	  which cause huge amounts of meta-data updates work much
	  faster than in the synchronous case.  This implementation
	  is still clear and simple, so there is a low risk for bugs
	  creeping into the code.  The disadvantage is that there is
	  no guarantee for a consistent state of the file system.
	  If there is a failure during an operation that updated
	  large amounts of meta-data, like a power failure or someone
	  pressing the reset button, the file system will be left
	  in an unpredictable state.  There is no opportunity to
	  examine the state of the file system when the system comes
	  up again as the data blocks of a file could already have
	  been written to the disk while the updates of the inode
	  table or the associated directory were not.  It is
	  impossible to implement a <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry> which is able to
	  clean up the resulting chaos because the necessary
	  information is not available on the disk.  If the file
	  system has been damaged beyond repair, the only choice
	  is to reformat it and restore from backup.</para>

	<para xml:lang="en">The usual solution for this problem is to implement
	  <emphasis>dirty region logging</emphasis>, which is also
	  referred to as <emphasis>journaling</emphasis>.
	  Meta-data updates are still written synchronously, but only
	  into a small region of the disk.  Later on, they are moved
	  to their proper location.  Because the logging area is a
	  small, contiguous region on the disk, there are no long
	  distances for the disk heads to move, even during heavy
	  operations, so these operations are quicker than synchronous
	  updates.  Additionally, the complexity of the implementation
	  is limited, so the risk of bugs being present is low.  A
	  disadvantage is that all meta-data is written twice, once
	  into the logging region and once to the proper location, so
	  performance <quote>pessimization</quote> might result.  On
	  the other hand, in case of a crash, all pending meta-data
	  operations can be either quickly rolled back or completed
	  from the logging area after the system comes up again,
	  resulting in a fast file system startup.</para>

	<para xml:lang="en">Kirk McKusick, the developer of Berkeley
	  <acronym>FFS</acronym>, solved this problem with Soft
	  Updates.  All pending meta-data updates are kept in memory
	  and written out to disk in a sorted sequence
	  (<quote>ordered meta-data updates</quote>).  This has the
	  effect that, in case of heavy meta-data operations, later
	  updates to an item <quote>catch</quote> the earlier ones
	  which are still in memory and have not already been written
	  to disk.  All operations are generally performed in memory
	  before the update is written to disk and the data blocks are
	  sorted according to their position so that they will not be
	  on the disk ahead of their meta-data.  If the system
	  crashes, an implicit <quote>log rewind</quote> causes all
	  operations which were not written to the disk appear as if
	  they never happened.  A consistent file system state is
	  maintained that appears to be the one of 30 to 60 seconds
	  earlier.  The algorithm used guarantees that all resources
	  in use are marked as such in their blocks and inodes.
	  After a crash, the only resource allocation error that
	  occurs is that resources are marked as <quote>used</quote>
	  which are actually <quote>free</quote>.  <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	  recognizes this situation, and frees the resources that
	  are no longer used.  It is safe to ignore the dirty state
	  of the file system after a crash by forcibly mounting it
	  with <command>mount -f</command>.  In order to free
	  resources that may be unused, <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry> needs to be run
	  at a later time.  This is the idea behind the
	  <emphasis>background <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry></emphasis>: at system
	  startup time, only a <emphasis>snapshot</emphasis> of the
	  file system is recorded and <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry> is run afterwards.
	  All file systems can then be mounted
	  <quote>dirty</quote>, so the system startup proceeds in
	  multi-user mode.  Then, background <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry> is
	  scheduled for all file systems where this is required, to
	  free resources that may be unused.  File systems that do
	  not use Soft Updates still need the usual foreground
	  <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

	<para xml:lang="en">The advantage is that meta-data operations are nearly
	  as fast as asynchronous updates and are faster than
	  <emphasis>logging</emphasis>, which has to write the
	  meta-data twice.  The disadvantages are the complexity of
	  the code, a higher memory consumption, and some
	  idiosyncrasies.  After a crash, the state of the file
	  system appears to be somewhat <quote>older</quote>.  In
	  situations where the standard synchronous approach would
	  have caused some zero-length files to remain after the
	  <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry>, these files do not exist at all with Soft
	  Updates because neither the meta-data nor the file contents
	  have been written to disk.  Disk space is not released until
	  the updates have been written to disk, which may take place
	  some time after running <citerefentry><refentrytitle>rm</refentrytitle><manvolnum>1</manvolnum></citerefentry>.  This may cause problems
	  when installing large amounts of data on a file system
	  that does not have enough free space to hold all the files
	  twice.</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="configtuning-kernel-limits">
    <title>調校核心限制</title>

    <indexterm xml:lang="en">
      <primary>tuning</primary>
      <secondary>kernel limits</secondary>
    </indexterm>

    <sect2 xml:id="file-process-limits">
      <title>檔案/程序限制</title>

      <sect3 xml:id="kern-maxfiles">
	<title xml:lang="en"><varname>kern.maxfiles</varname></title>

	<indexterm xml:lang="en">
	  <primary><varname>kern.maxfiles</varname></primary>
	</indexterm>

	<para xml:lang="en">The <varname>kern.maxfiles</varname> <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	  variable can be raised or lowered based upon system
	  requirements.  This variable indicates the maximum number
	  of file descriptors on the system.  When the file descriptor
	  table is full, <errorname>file: table is full</errorname>
	  will show up repeatedly in the system message buffer, which
	  can be viewed using <citerefentry><refentrytitle>dmesg</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

	<para xml:lang="en">Each open file, socket, or fifo uses one file
	  descriptor.  A large-scale production server may easily
	  require many thousands of file descriptors, depending on the
	  kind and number of services running concurrently.</para>

	<para xml:lang="en">In older FreeBSD releases, the default value of
	  <varname>kern.maxfiles</varname> is derived from
	  <option>maxusers</option> in the kernel configuration file.
	  <varname>kern.maxfiles</varname> grows proportionally to the
	  value of <option>maxusers</option>.  When compiling a custom
	  kernel, consider setting this kernel configuration option
	  according to the use of the system.  From this number, the
	  kernel is given most of its pre-defined limits.  Even though
	  a production machine may not have 256 concurrent users, the
	  resources needed may be similar to a high-scale web
	  server.</para>

	<para xml:lang="en">The read-only <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> variable
	  <varname>kern.maxusers</varname> is automatically sized at
	  boot based on the amount of memory available in the system,
	  and may be determined at run-time by inspecting the value
	  of <varname>kern.maxusers</varname>.  Some systems require
	  larger or smaller values of
	  <varname>kern.maxusers</varname> and values of
	  <literal>64</literal>, <literal>128</literal>, and
	  <literal>256</literal> are not uncommon.  Going above
	  <literal>256</literal> is not recommended  unless a huge
	  number of file descriptors is needed.  Many of the tunable
	  values set to their defaults by
	  <varname>kern.maxusers</varname> may be individually
	  overridden at boot-time or run-time in
	  <filename>/boot/loader.conf</filename>.  Refer to
	  <citerefentry><refentrytitle>loader.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> and
	  <filename>/boot/defaults/loader.conf</filename> for more
	  details and some hints.</para>

	<para xml:lang="en">In older releases, the system will auto-tune
	  <literal>maxusers</literal> if it is set to
	  <literal>0</literal>.
	  <footnote><para xml:lang="en">The auto-tuning algorithm sets
	      <literal>maxusers</literal> equal to the amount of
	      memory in the system, with a minimum of
	      <literal>32</literal>, and a maximum of
	      <literal>384</literal>.</para></footnote>.  When
	  setting this option, set <literal>maxusers</literal> to
	  at least <literal>4</literal>, especially if the system
	  runs <application>Xorg</application> or is used to
	  compile software.  The most important table set by
	  <literal>maxusers</literal> is the maximum number of
	  processes, which is set to
	  <literal>20 + 16 * maxusers</literal>.  If
	  <literal>maxusers</literal> is set to <literal>1</literal>,
	  there can only be
	  <literal>36</literal> simultaneous processes, including
	  the <literal>18</literal> or so that the system starts up
	  at boot time and the <literal>15</literal> or so used by
	  <application>Xorg</application>.  Even a simple task like
	  reading a manual page will start up nine processes to
	  filter, decompress, and view it.  Setting
	  <literal>maxusers</literal> to <literal>64</literal> allows
	  up to <literal>1044</literal> simultaneous processes, which
	  should be enough for nearly all uses.  If, however, the
	  <errortype>proc table full</errortype> error is displayed
	  when trying to start another program, or a server is
	  running with a large number of simultaneous users, increase
	  the number and rebuild.</para>

	<note>
	  <para xml:lang="en"><literal>maxusers</literal> does
	    <emphasis>not</emphasis> limit the number of users which
	    can log into the machine.  It instead sets various table
	    sizes to reasonable values considering the maximum number
	    of users on the system and how many processes each user
	    will be running.</para>
	</note>
      </sect3>

      <sect3>
	<title xml:lang="en"><varname>kern.ipc.soacceptqueue</varname></title>

	<indexterm xml:lang="en">
	  <primary><varname>kern.ipc.soacceptqueue</varname></primary>
	</indexterm>

	<para xml:lang="en">The <varname>kern.ipc.soacceptqueue</varname>
	  <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> variable limits the size of the listen queue
	  for accepting new <literal>TCP</literal> connections.  The
	  default value of <literal>128</literal> is typically too low
	  for robust handling of new connections on a heavily loaded
	  web server.  For such environments, it is recommended to
	  increase this value to <literal>1024</literal> or higher.  A
	  service such as <citerefentry><refentrytitle>sendmail</refentrytitle><manvolnum>8</manvolnum></citerefentry>, or
	  <application>Apache</application> may itself limit the
	  listen queue size, but will often have a directive in its
	  configuration file to adjust the queue size.  Large listen
	  queues do a better job of avoiding Denial of Service
	  (<acronym>DoS</acronym>) attacks.</para>
      </sect3>
    </sect2>

    <sect2 xml:id="nmbclusters">
      <title>網路限制</title>

      <para xml:lang="en">The <literal>NMBCLUSTERS</literal> kernel configuration
	option dictates the amount of network Mbufs available to the
	system.  A heavily-trafficked server with a low number of
	Mbufs will hinder performance.  Each cluster represents
	approximately 2 K of memory, so a value of
	<literal>1024</literal> represents <literal>2</literal>
	megabytes of kernel memory reserved for network buffers.  A
	simple calculation can be done to figure out how many are
	needed.  A web server which maxes out at
	<literal>1000</literal> simultaneous connections where each
	connection uses a 6 K receive and 16 K send buffer,
	requires approximately 32 MB worth of network buffers
	to cover the web server.  A good rule of thumb is to multiply
	by <literal>2</literal>, so
	2x32 MB / 2 KB =
	64 MB / 2 kB =
	<literal>32768</literal>.  Values between
	<literal>4096</literal> and <literal>32768</literal> are
	recommended for machines with greater amounts of memory.
	Never specify an arbitrarily high value for this parameter
	as it could lead to a boot time crash.  To observe network
	cluster usage, use <option>-m</option> with
	<citerefentry><refentrytitle>netstat</refentrytitle><manvolnum>1</manvolnum></citerefentry>.</para>

      <para xml:lang="en">The <varname>kern.ipc.nmbclusters</varname> loader tunable
	should be used to tune this at boot time.  Only older versions
	of FreeBSD will require the use of the
	<literal>NMBCLUSTERS</literal> kernel <citerefentry><refentrytitle>config</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	option.</para>

      <para xml:lang="en">For busy servers that make extensive use of the
	<citerefentry><refentrytitle>sendfile</refentrytitle><manvolnum>2</manvolnum></citerefentry> system call, it may be necessary to increase
	the number of <citerefentry><refentrytitle>sendfile</refentrytitle><manvolnum>2</manvolnum></citerefentry> buffers via the
	<literal>NSFBUFS</literal> kernel configuration option or by
	setting its value in <filename>/boot/loader.conf</filename>
	(see <citerefentry><refentrytitle>loader</refentrytitle><manvolnum>8</manvolnum></citerefentry> for details).  A common indicator that
	this parameter needs to be adjusted is when processes are seen
	in the <literal>sfbufa</literal> state.  The <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	variable <varname>kern.ipc.nsfbufs</varname> is read-only.
	This parameter nominally scales with
	<varname>kern.maxusers</varname>, however it may be necessary
	to tune accordingly.</para>

      <important>
	<para xml:lang="en">Even though a socket has been marked as non-blocking,
	  calling <citerefentry><refentrytitle>sendfile</refentrytitle><manvolnum>2</manvolnum></citerefentry> on the non-blocking socket may
	  result in the <citerefentry><refentrytitle>sendfile</refentrytitle><manvolnum>2</manvolnum></citerefentry> call blocking until enough
	  <literal>struct sf_buf</literal>'s are made
	  available.</para>
      </important>

      <sect3>
	<title xml:lang="en"><varname>net.inet.ip.portrange.*</varname></title>

	<indexterm xml:lang="en">
	  <primary>net.inet.ip.portrange.*</primary>
	</indexterm>

	<para xml:lang="en">The <varname>net.inet.ip.portrange.*</varname>
	  <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> variables control the port number ranges
	  automatically bound to <literal>TCP</literal> and
	  <literal>UDP</literal> sockets.  There are three ranges: a
	  low range, a default range, and a high range.  Most network
	  programs use the default range which is controlled by
	  <varname>net.inet.ip.portrange.first</varname> and
	  <varname>net.inet.ip.portrange.last</varname>, which default
	  to <literal>1024</literal> and <literal>5000</literal>,
	  respectively.  Bound port ranges are used for outgoing
	  connections and it is possible to run the system out of
	  ports under certain circumstances.  This most commonly
	  occurs when running a heavily loaded web proxy.  The port
	  range is not an issue when running a server which handles
	  mainly incoming connections, such as a web server, or has
	  a limited number of outgoing connections, such as a mail
	  relay.  For situations where there is a shortage of ports,
	  it is recommended to increase
	  <varname>net.inet.ip.portrange.last</varname> modestly.  A
	  value of <literal>10000</literal>, <literal>20000</literal>
	  or <literal>30000</literal> may be reasonable.  Consider
	  firewall effects when changing the port range.  Some
	  firewalls may block large ranges of ports, usually
	  low-numbered ports, and expect systems to use higher ranges
	  of ports for outgoing connections.  For this reason, it
	  is not recommended that the value of
	  <varname>net.inet.ip.portrange.first</varname> be
	  lowered.</para>
      </sect3>

      <sect3>
	<title><literal>TCP</literal> 頻寬延遲乘積</title>

	<indexterm xml:lang="en">
	  <primary><literal>TCP</literal> Bandwidth Delay Product
	      Limiting</primary>
	  <secondary><varname>net.inet.tcp.inflight.enable</varname></secondary>
	</indexterm>

	<para xml:lang="en"><literal>TCP</literal> bandwidth delay product limiting
	  can be enabled by setting the
	  <varname>net.inet.tcp.inflight.enable</varname>
	  <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> variable to <literal>1</literal>.  This
	  instructs the system to attempt to calculate the bandwidth
	  delay product for each connection and limit the amount of
	  data queued to the network to just the amount required to
	  maintain optimum throughput.</para>

	<para xml:lang="en">This feature is useful when serving data over modems,
	  Gigabit Ethernet, high speed <literal>WAN</literal> links,
	  or any other link with a high bandwidth delay product,
	  especially when also using window scaling or when a large
	  send window has been configured.  When enabling this option,
	  also set <varname>net.inet.tcp.inflight.debug</varname> to
	  <literal>0</literal> to disable debugging.  For production
	  use, setting <varname>net.inet.tcp.inflight.min</varname>
	  to at least <literal>6144</literal> may be beneficial.
	  Setting high minimums may effectively disable bandwidth
	  limiting, depending on the link.  The limiting feature
	  reduces the amount of data built up in intermediate route
	  and switch packet queues and reduces the amount of data
	  built up in the local host's interface queue.  With fewer
	  queued packets, interactive connections, especially over
	  slow modems, will operate with lower
	  <emphasis>Round Trip Times</emphasis>.  This feature only
	  effects server side data transmission such as uploading.
	  It has no effect on data reception or downloading.</para>

	<para xml:lang="en">Adjusting <varname>net.inet.tcp.inflight.stab</varname>
	  is <emphasis>not</emphasis> recommended.  This parameter
	  defaults to <literal>20</literal>, representing 2 maximal
	  packets added to the bandwidth delay product window
	  calculation.  The additional window is required to stabilize
	  the algorithm and improve responsiveness to changing
	  conditions, but it can also result in higher <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	  times over slow links, though still much lower than without
	  the inflight algorithm.  In such cases, try reducing this
	  parameter to <literal>15</literal>, <literal>10</literal>,
	  or <literal>5</literal> and reducing
	  <varname>net.inet.tcp.inflight.min</varname> to a value such
	  as <literal>3500</literal> to get the desired effect.
	  Reducing these parameters should be done as a last resort
	  only.</para>
      </sect3>
    </sect2>

    <sect2>
      <title>虛擬記憶體</title>

      <sect3>
	<title xml:lang="en"><varname>kern.maxvnodes</varname></title>

	<para xml:lang="en">A vnode is the internal representation of a file or
	  directory.  Increasing the number of vnodes available to
	  the operating system reduces disk I/O.  Normally, this is
	  handled by the operating system and does not need to be
	  changed.  In some cases where disk I/O is a bottleneck and
	  the system is running out of vnodes, this setting needs
	  to be increased.  The amount of inactive and free
	  <acronym>RAM</acronym> will need to be taken into
	  account.</para>

	<para xml:lang="en">To see the current number of vnodes in use:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl vfs.numvnodes</userinput>
vfs.numvnodes: 91349</screen>

	<para xml:lang="en">To see the maximum vnodes:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl kern.maxvnodes</userinput>
kern.maxvnodes: 100000</screen>

	<para xml:lang="en">If the current vnode usage is near the maximum, try
	  increasing <varname>kern.maxvnodes</varname> by a value of
	  <literal>1000</literal>.  Keep an eye on the number of
	  <varname>vfs.numvnodes</varname>.  If it climbs up to the
	  maximum again, <varname>kern.maxvnodes</varname> will need
	  to be increased further.  Otherwise, a shift in memory
	  usage as reported by <citerefentry><refentrytitle>top</refentrytitle><manvolnum>1</manvolnum></citerefentry> should be visible and
	  more memory should be active.</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="adding-swap-space">
    <title>增加交換空間</title>

    <para>有時系統會需要更多的交換 (Swap) 空間，本章節會介紹兩種增加交換空間的方式：一種是在既有的分割區或新的硬碟增加交換空間，另一種則是在既有的分割區中建立一個交換檔。</para>

    <para>要取得更多有關如何加密交換空間的資訊、有那些可用的選項以及為何要做加密，可參考 <xref linkend="swap-encrypting"/>。</para>

    <sect2 xml:id="new-drive-swap">
      <title>使用新硬碟或既有分割區增加交換空間</title>

      <para>在新的磁碟上增加交換空間比起使用既有硬碟上的分割區會有較佳的效率。設定分割區與硬碟在 <xref linkend="disks-adding"/> 中有說明，另外 <xref linkend="configtuning-initial"/> 會討論到分割區的配置與交換分割區大小需考量的事項。</para>

      <para>使用 <command>swapon</command> 來增加交換分割區到系統，例：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>swapon <replaceable>/dev/ada1s1b</replaceable></userinput></screen>

      <warning>
	<para>可以使用任何尚未掛載過、甚至已經有內含資料的分割區做為交換空間，但在含有資料的分割區上使用 <command>swapon</command> 會覆寫並清除該分割區上所有的資料，請在執行 <command>swapon</command> 之前確認真的要使用該分割區增加交換空間。</para>
      </warning>

      <para>要在開機時自動加入此交換分割區，可加入以下項目到 <filename>/etc/fstab</filename>：</para>

      <programlisting xml:lang="en"><replaceable>/dev/ada1s1b</replaceable>	none	swap	sw	0	0</programlisting>

      <para>請參考 <citerefentry><refentrytitle>fstab</refentrytitle><manvolnum>5</manvolnum></citerefentry> 來取得在 <filename>/etc/fstab</filename> 中項目的說明。更多有關 <command>swapon</command> 的資訊 可以在 <citerefentry><refentrytitle>swapon</refentrytitle><manvolnum>8</manvolnum></citerefentry> 找到。</para>
    </sect2>

    <sect2 xml:id="create-swapfile">
      <title>建立交換檔</title>

      <para>以下例子會建立一個 64M 的交換檔於 <filename>/usr/swap0</filename> 來替代使用分割區建立交換空間。</para>

      <para>使用交換檔開啟交換空間前需要在核心編譯或載入 <citerefentry><refentrytitle>md</refentrytitle><manvolnum>4</manvolnum></citerefentry> 所需的模組，請參考 <xref linkend="kernelconfig"/> 了解有關編譯自訂核心的資訊。</para>

      <example xml:id="swapfile-10-and-later">
	<title>建立交換檔於 FreeBSD 10.<replaceable>X</replaceable> 及以後版本</title>

	<procedure>
	  <step>
	    <para>建立交換檔：</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>dd if=/dev/zero of=<replaceable>/usr/swap0</replaceable> bs=1m count=<replaceable>64</replaceable></userinput></screen>
	  </step>

	  <step>
	    <para>在新檔案設定適當的權限：</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>chmod 0600 <replaceable>/usr/swap0</replaceable></userinput></screen>
	  </step>

	  <step>
	    <para>加入行到 <filename>/etc/fstab</filename> 以讓系統知道交換檔的資訊：</para>

	    <programlisting xml:lang="en">md99	none	swap	sw,file=/usr/swap0,late	0	0</programlisting>

	    <para>已使用 <citerefentry><refentrytitle>md</refentrytitle><manvolnum>4</manvolnum></citerefentry> 裝置的 <filename>md99</filename>，保留較低的裝置編號供互動操作時使用。</para>
	  </step>

	  <step>
	    <para>交換空間會於系統啟動時增加。若要立即增加交換空間，請參考 <citerefentry><refentrytitle>swapon</refentrytitle><manvolnum>8</manvolnum></citerefentry>：</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>swapon -aL</userinput></screen>
	  </step>
	</procedure>
      </example>

      <example xml:id="swapfile-9-and-earlier">
	<title>建立交換檔於 FreeBSD 9.<replaceable>X</replaceable> 及先前版本</title>

	<procedure>
	  <step>
	    <para>建立交換檔 <filename>/usr/swap0</filename>：</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>dd if=/dev/zero of=<replaceable>/usr/swap0</replaceable> bs=1m count=<replaceable>64</replaceable></userinput></screen>
	  </step>

	  <step>
	    <para>設定適當的權限於 <filename>/usr/swap0</filename>：</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>chmod 0600 <replaceable>/usr/swap0</replaceable></userinput></screen>
	  </step>

	  <step>
	    <para>在 <filename>/etc/rc.conf</filename> 開啟交換檔：</para>

	    <programlisting xml:lang="en">swapfile="<replaceable>/usr/swap0</replaceable>"   # Set to name of swap file</programlisting>
	  </step>

	  <step>
	    <para>交換空間會於系統啟動時增加。若要立即增加交換空間，可指定一個未使用的記憶體裝置。請參考 <xref linkend="disks-virtual"/> 取得更多有關記憶體裝置的資訊。</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>mdconfig -a -t vnode -f <replaceable>/usr/swap0</replaceable> -u <replaceable>0</replaceable> &amp;&amp; swapon /dev/md<replaceable>0</replaceable></userinput></screen>
	  </step>
	</procedure>
      </example>
    </sect2>
  </sect1>

  <sect1 xml:id="acpi-overview">
    <info>
      <title>電源與資源管理</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Hiten</firstname>
	    <surname>Pandya</surname>
	  </personname>
	  <contrib>Written by </contrib>
	</author>

	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	</author>
      </authorgroup>
    </info>

    <para>以有效率的方式運用硬體資源是很重要的，電源與資源管理讓作業系統可以監控系統的限制，並且在系統溫度意外升高時能夠發出警報。早期提供電源管理的規範是進階電源管理 (Advanced Power Management, <acronym>APM</acronym>)，<acronym>APM</acronym> 可根據系統的使用狀況來來控制電源用量。然而，使用 <acronym>APM</acronym> 要作業系統來管理系統的電源用量和溫度屬性是困難且沒有彈性的，因為硬體是由 <acronym>BIOS</acronym> 所管理，使用者對電源管理設定只有有限的設定性與可見性，且 <acronym>APM</acronym> <acronym>BIOS</acronym> 是由供應商提供且特定於某些硬體平台，而作業系統中必透過 <acronym>APM</acronym> 驅動程式做為中介存取 <acronym>APM</acronym> 軟體介面才能夠管理電源等級。</para>

    <para>在 <acronym>APM</acronym> 有四個主要的問題。第一，電源管理是由供應商特定的 <acronym>BIOS</acronym> 來完成，與作業系統是分開的。例如，使用者可在 <acronym>APM</acronym> <acronym>BIOS</acronym> 設定硬碟的閒置時間值，在超過時間時 <acronym>BIOS</acronym> 可在未徵得作業系統的同意下降低硬碟的轉速。第二，<acronym>APM</acronym> 的邏輯是內嵌在 <acronym>BIOS</acronym> 當中的，並且在作業系統範圍之外運作，這代表使用者只能夠透過燒錄新的韌體到 <acronym>ROM</acronym> 來修正 <acronym>APM</acronym> <acronym>BIOS</acronym> 中的問題，而這樣的程序是危險的，若失敗，可能會讓系統進入無法復原的狀態。第三，<acronym>APM</acronym> 是供應商特定的技術，這代表有許多重複的工作，在一個供應商的 <acronym>BIOS</acronym> 找到的問題在其他的供應商卻沒有解決。最後一點，<acronym>APM</acronym> <acronym>BIOS</acronym> 並沒有足夠的空間來實作複雜的電源管理政策或可良好適應主機用途的程式。</para>

    <para>Plug and Play <acronym>BIOS</acronym> (<acronym>PNPBIOS</acronym>) 在很多情況下並不可靠，<acronym>PNPBIOS</acronym> 是 16 位元的技術，所以作業系統必須模擬 16 位元才能存取 <acronym>PNPBIOS</acronym>。FreeBSD 提供了一個 <acronym>APM</acronym> 驅動程式來做 <acronym>APM</acronym>，應可用在 2000 年之前所製造的系統，該驅動程式的說明於 <citerefentry><refentrytitle>apm</refentrytitle><manvolnum>4</manvolnum></citerefentry>。</para>

    <indexterm xml:lang="en">
      <primary>ACPI</primary>
    </indexterm>

    <indexterm xml:lang="en">
      <primary>APM</primary>
    </indexterm>

    <para><acronym>APM</acronym> 的後繼者是進階設置與電源介面 (Advanced Configuration and Power Interface, <acronym>ACPI</acronym>)。<acronym>ACPI</acronym> 是一套由供應商聯盟所搛寫出的標準，提供了硬體資源與電源管理的介面，它是 <emphasis>作業系統直接設置與電源管理 (Operating System-directed configuration and Power Management)</emphasis> 關鍵的要素，提供了作業系統更多的控制方式與彈性。</para>

    <para>本章節將示範如何在 FreeBSD 設定 <acronym>ACPI</acronym>，然後提供一些如何對 <acronym>ACPI</acronym> 除錯的提示以及如何提交包含除錯資訊的問題回報，讓開發人員能夠診斷並修正 <acronym>ACPI</acronym> 的問題。</para>

    <sect2 xml:id="acpi-config">
      <title>設定 <acronym>ACPI</acronym></title>

      <para>在 FreeBSD <citerefentry><refentrytitle>acpi</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式預設會在系統開始時載入，且<emphasis>不</emphasis>應被編譯到核心當中。這個驅動程式在開機之後無法被卸載，因為系統匯流排會使用它做各種硬體互動。雖然如此，若系統遇到問題，<acronym>ACPI</acronym> 還是可以被關閉，在 <filename>/boot/loader.conf</filename> 中設定 <literal>hint.acpi.0.disabled="1"</literal> 之後重新開機或在載入程式提示時設定這個變數，如 <xref linkend="boot-loader"/> 中的說明。</para>

      <note>
	<para><acronym>ACPI</acronym> 與 <acronym>APM</acronym> 不能同時存在且應分開使用，若有偵測到有另一個正在執行，要載入的後者將會中斷。</para>
      </note>

      <para><acronym>ACPI</acronym> 可以用來讓系統進入睡眠模式，使用 <command>acpiconf</command> 與 <option>-s</option> 旗標再加上由 <literal>1</literal> 到 <literal>5</literal> 的數字。大多數使用者只需使用 <literal>1</literal> (快速待命到 <acronym>RAM</acronym>) 或 <literal>3</literal> (待命到 <acronym>RAM</acronym>)，選項 <literal>5</literal> 會執行軟關機 (Soft-off)，如同執行 <command>halt -p</command> 一樣。</para>

      <para>其他的選項可使用 <command>sysctl</command> 來設定，請參考 <citerefentry><refentrytitle>acpi</refentrytitle><manvolnum>4</manvolnum></citerefentry> 以及 <citerefentry vendor="current"><refentrytitle>acpiconf</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以取得更多資訊。</para>
    </sect2>

    <sect2 xml:id="ACPI-comprob">
      <title>常見問題</title>

      <indexterm xml:lang="en">
	<primary><acronym>ACPI</acronym></primary>
      </indexterm>

      <para xml:lang="en"><acronym>ACPI</acronym> is present in all modern computers
	that conform to the ia32 (x86), ia64 (Itanium), and amd64
	(<acronym>AMD</acronym>) architectures.  The full standard has
	many features including <acronym>CPU</acronym> performance
	management, power planes control, thermal zones, various
	battery systems, embedded controllers, and bus enumeration.
	Most systems implement less than the full standard.  For
	instance, a desktop system usually only implements bus
	enumeration while a laptop might have cooling and battery
	management support as well.  Laptops also have suspend and
	resume, with their own associated complexity.</para>

      <para xml:lang="en">An <acronym>ACPI</acronym>-compliant system has various
	components.  The <acronym>BIOS</acronym> and chipset vendors
	provide various fixed tables, such as <acronym>FADT</acronym>,
	in memory that specify things like the <acronym>APIC</acronym>
	map (used for <acronym>SMP</acronym>), config registers, and
	simple configuration values.  Additionally, a bytecode table,
	the Differentiated System Description Table
	<acronym>DSDT</acronym>, specifies a tree-like name space of
	devices and methods.</para>

      <para xml:lang="en">The <acronym>ACPI</acronym> driver must parse the fixed
	tables, implement an interpreter for the bytecode, and modify
	device drivers and the kernel to accept information from the
	<acronym>ACPI</acronym> subsystem.  For FreeBSD, <trademark class="registered">Intel</trademark> has
	provided an interpreter (<acronym>ACPI-CA</acronym>) that is
	shared with <trademark class="registered">Linux</trademark> and NetBSD.  The path to the
	<acronym>ACPI-CA</acronym> source code is
	<filename>src/sys/contrib/dev/acpica</filename>.  The glue
	code that allows <acronym>ACPI-CA</acronym> to work on FreeBSD is
	in <filename>src/sys/dev/acpica/Osd</filename>.  Finally,
	drivers that implement various <acronym>ACPI</acronym> devices
	are found in <filename>src/sys/dev/acpica</filename>.</para>

      <indexterm xml:lang="en">
	<primary>ACPI</primary>
	<secondary>problems</secondary>
      </indexterm>

      <para xml:lang="en">For <acronym>ACPI</acronym> to work correctly, all the
	parts have to work correctly.  Here are some common problems,
	in order of frequency of appearance, and some possible
	workarounds or fixes.  If a fix does not resolve the issue,
	refer to <xref linkend="ACPI-submitdebug"/> for instructions
	on how to submit a bug report.</para>

      <sect3>
	<title>滑鼠問題</title>

	<para xml:lang="en">In some cases, resuming from a suspend operation will
	  cause the mouse to fail.  A known work around is to add
	  <literal>hint.psm.0.flags="0x3000"</literal> to
	  <filename>/boot/loader.conf</filename>.</para>
      </sect3>

      <sect3>
	<title>待機/喚醒</title>

	<para xml:lang="en"><acronym>ACPI</acronym> has three suspend to
	  <acronym>RAM</acronym> (<acronym>STR</acronym>) states,
	  <literal>S1</literal>-<literal>S3</literal>, and one suspend
	  to disk state (<acronym>STD</acronym>), called
	  <literal>S4</literal>.  <acronym>STD</acronym> can be
	  implemented in two separate ways.  The
	  <literal>S4</literal><acronym>BIOS</acronym> is a
	  <acronym>BIOS</acronym>-assisted suspend to disk and
	  <literal>S4</literal><acronym>OS</acronym> is implemented
	  entirely by the operating system.  The normal state the
	  system is in when plugged in but not powered up is
	  <quote>soft off</quote> (<literal>S5</literal>).</para>

	<para xml:lang="en">Use <command>sysctl hw.acpi</command> to check for the
	  suspend-related items.  These example results are from a
	  Thinkpad:</para>

	<screen xml:lang="en">hw.acpi.supported_sleep_state: S3 S4 S5
hw.acpi.s4bios: 0</screen>

	<para xml:lang="en">Use <command>acpiconf -s</command> to test
	  <literal>S3</literal>, <literal>S4</literal>, and
	  <literal>S5</literal>.  An <option>s4bios</option> of one
	  (<literal>1</literal>) indicates
	  <literal>S4</literal><acronym>BIOS</acronym> support instead
	  of <literal>S4</literal> operating system support.</para>

	<para xml:lang="en">When testing suspend/resume, start with
	  <literal>S1</literal>, if supported.  This state is most
	  likely to work since it does not require much driver
	  support.  No one has implemented <literal>S2</literal>,
	  which is similar to <literal>S1</literal>.  Next, try
	  <literal>S3</literal>.  This is the deepest
	  <acronym>STR</acronym> state and requires a lot of driver
	  support to properly reinitialize the hardware.</para>

	<para xml:lang="en">A common problem with suspend/resume is that many device
	  drivers do not save, restore, or reinitialize their
	  firmware, registers, or device memory properly.  As a first
	  attempt at debugging the problem, try:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl debug.bootverbose=1</userinput>
<prompt>#</prompt> <userinput>sysctl debug.acpi.suspend_bounce=1</userinput>
<prompt>#</prompt> <userinput>acpiconf -s 3</userinput></screen>

	<para xml:lang="en">This test emulates the suspend/resume cycle of all
	  device drivers without actually going into
	  <literal>S3</literal> state.  In some cases, problems such
	  as losing firmware state, device watchdog time out, and
	  retrying forever, can be captured with this method.  Note
	  that the system will not really enter <literal>S3</literal>
	  state, which means devices may not lose power, and many
	  will work fine even if suspend/resume methods are totally
	  missing, unlike real <literal>S3</literal> state.</para>

	<para xml:lang="en">Harder cases require additional hardware, such as a
	  serial port and cable for debugging through a serial
	  console, a Firewire port and cable for using <citerefentry><refentrytitle>dcons</refentrytitle><manvolnum>4</manvolnum></citerefentry>,
	  and kernel debugging skills.</para>

	<para xml:lang="en">To help isolate the problem, unload as many drivers as
	  possible.  If it works, narrow down which driver is the
	  problem by loading drivers until it fails again.  Typically,
	  binary drivers like <filename>nvidia.ko</filename>, display
	  drivers, and <acronym>USB</acronym> will have the most
	  problems while Ethernet interfaces usually work fine.  If
	  drivers can be properly loaded and unloaded, automate this
	  by putting the appropriate commands in
	  <filename>/etc/rc.suspend</filename> and
	  <filename>/etc/rc.resume</filename>.  Try setting
	  <option>hw.acpi.reset_video</option> to <literal>1</literal>
	  if the display is messed up after resume.  Try setting
	  longer or shorter values for
	  <option>hw.acpi.sleep_delay</option> to see if that
	  helps.</para>

	<para xml:lang="en">Try loading a recent <trademark class="registered">Linux</trademark> distribution to see if
	  suspend/resume works on the same hardware.  If it works on
	  <trademark class="registered">Linux</trademark>, it is likely a FreeBSD driver problem.  Narrowing down
	  which driver causes the problem will assist developers in
	  fixing the problem.  Since the <acronym>ACPI</acronym>
	  maintainers rarely maintain other drivers, such as sound
	  or <acronym>ATA</acronym>, any driver problems should also
	  be posted to the <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-current">freebsd-current</link> list and mailed to the
	  driver maintainer.  Advanced users can include debugging
	  <citerefentry><refentrytitle>printf</refentrytitle><manvolnum>3</manvolnum></citerefentry>s in a problematic driver to track down where
	  in its resume function it hangs.</para>

	<para xml:lang="en">Finally, try disabling <acronym>ACPI</acronym> and
	  enabling <acronym>APM</acronym> instead.  If suspend/resume
	  works with <acronym>APM</acronym>, stick with
	  <acronym>APM</acronym>, especially on older hardware
	  (pre-2000).  It took vendors a while to get
	  <acronym>ACPI</acronym> support correct and older hardware
	  is more likely to have <acronym>BIOS</acronym> problems with
	  <acronym>ACPI</acronym>.</para>
      </sect3>

      <sect3>
	<title>系統無回應</title>

	<para xml:lang="en">Most system hangs are a result of lost interrupts or an
	  interrupt storm.  Chipsets may have problems based on boot,
	  how the <acronym>BIOS</acronym> configures interrupts before
	  correctness of the <acronym>APIC</acronym>
	  (<acronym>MADT</acronym>) table, and routing of the System
	  Control Interrupt (<acronym>SCI</acronym>).</para>

	<indexterm xml:lang="en">
	  <primary>interrupt storms</primary>
	</indexterm>

	<para xml:lang="en">Interrupt storms can be distinguished from lost
	  interrupts by checking the output of
	  <command>vmstat -i</command> and looking at the line that
	  has <literal>acpi0</literal>.  If the counter is increasing
	  at more than a couple per second, there is an interrupt
	  storm.  If the system appears hung, try breaking to
	  <acronym>DDB</acronym> (<keycombo action="simul">
	    <keycap>CTRL</keycap>
	    <keycap>ALT</keycap>
	    <keycap>ESC</keycap>
	  </keycombo> on console) and type
	  <literal>show interrupts</literal>.</para>

	<indexterm xml:lang="en">
	  <primary>APIC</primary>
	  <secondary>disabling</secondary>
	</indexterm>

	<para xml:lang="en">When dealing with interrupt problems, try disabling
	  <acronym>APIC</acronym> support with
	  <literal>hint.apic.0.disabled="1"</literal> in
	  <filename>/boot/loader.conf</filename>.</para>
      </sect3>

      <sect3>
	<title>當機</title>

	<para xml:lang="en">Panics are relatively rare for <acronym>ACPI</acronym>
	  and are the top priority to be fixed.  The first step is to
	  isolate the steps to reproduce the panic, if possible, and
	  get a backtrace.  Follow the advice for enabling
	  <literal>options DDB</literal> and setting up a serial
	  console in <xref linkend="serialconsole-ddb"/> or setting
	  up a dump partition.  To get a backtrace in
	  <acronym>DDB</acronym>, use <literal>tr</literal>.  When
	  handwriting the backtrace, get at least the last five and
	  the top five lines in the trace.</para>

	<para xml:lang="en">Then, try to isolate the problem by booting with
	  <acronym>ACPI</acronym> disabled.  If that works, isolate
	  the <acronym>ACPI</acronym> subsystem by using various
	  values of <option>debug.acpi.disable</option>.  See
	  <citerefentry><refentrytitle>acpi</refentrytitle><manvolnum>4</manvolnum></citerefentry> for some examples.</para>
      </sect3>

      <sect3>
	<title>系統在待機或關機後仍開機</title>

	<para xml:lang="en">First, try setting
	  <literal>hw.acpi.disable_on_poweroff="0"</literal> in
	  <filename>/boot/loader.conf</filename>.  This keeps
	  <acronym>ACPI</acronym> from disabling various events during
	  the shutdown process.  Some systems need this value set to
	  <literal>1</literal> (the default) for the same reason.
	  This usually fixes the problem of a system powering up
	  spontaneously after a suspend or poweroff.</para>
      </sect3>

      <sect3 xml:id="ACPI-aslanddump">
	<title>BIOS 含有有問題的 Bytecode</title>

	<indexterm xml:lang="en">
	  <primary><acronym>ACPI</acronym></primary>
	  <secondary><acronym>ASL</acronym></secondary>
	</indexterm>

	<para xml:lang="en">Some <acronym>BIOS</acronym> vendors provide incorrect
	  or buggy bytecode.  This is usually manifested by kernel
	  console messages like this:</para>

	<screen xml:lang="en">ACPI-1287: *** Error: Method execution failed [\\_SB_.PCI0.LPC0.FIGD._STA] \\
(Node 0xc3f6d160), AE_NOT_FOUND</screen>

	<para xml:lang="en">Often, these problems may be resolved by updating the
	  <acronym>BIOS</acronym> to the latest revision.  Most
	  console messages are harmless, but if there are other
	  problems, like the battery status is not working, these
	  messages are a good place to start looking for
	  problems.</para>
      </sect3>
    </sect2>

    <sect2>
      <title>覆蓋預設的 <acronym>AML</acronym></title>

      <para xml:lang="en">The <acronym>BIOS</acronym> bytecode, known as
	<acronym>ACPI</acronym> Machine Language
	(<acronym>AML</acronym>), is compiled from a source language
	called <acronym>ACPI</acronym> Source Language
	(<acronym>ASL</acronym>).  The <acronym>AML</acronym> is
	found in the table known as the Differentiated System
	Description Table (<acronym>DSDT</acronym>).</para>
      <indexterm xml:lang="en">
	<primary><acronym>ACPI</acronym></primary>
	<secondary><acronym>ASL</acronym></secondary>
      </indexterm>

      <para xml:lang="en">The goal of FreeBSD is for everyone to have working
	<acronym>ACPI</acronym> without any user intervention.
	Workarounds are still being developed for common mistakes made
	by <acronym>BIOS</acronym>  vendors.  The <trademark class="registered">Microsoft</trademark>
	interpreter (<filename>acpi.sys</filename> and
	<filename>acpiec.sys</filename>) does not strictly check for
	adherence to the standard, and thus many
	<acronym>BIOS</acronym> vendors who only test
	<acronym>ACPI</acronym> under <trademark class="registered">Windows</trademark> never fix their
	<acronym>ASL</acronym>.  FreeBSD developers continue to identify
	and document which non-standard behavior is allowed by
	<trademark class="registered">Microsoft</trademark>'s interpreter and replicate it so that FreeBSD can
	work without forcing users to fix the
	<acronym>ASL</acronym>.</para>

      <para xml:lang="en">To help identify buggy behavior and possibly fix it
	manually, a copy can be made of the system's
	<acronym>ASL</acronym>.  To copy the system's
	<acronym>ASL</acronym> to a specified file name, use
	<command>acpidump</command> with <option>-t</option>, to show
	the contents of the fixed tables, and <option>-d</option>, to
	disassemble the <acronym>AML</acronym>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>acpidump -td &gt; <replaceable>my.asl</replaceable></userinput></screen>

      <para xml:lang="en">Some <acronym>AML</acronym> versions assume the user is
	running <trademark class="registered">Windows</trademark>.  To override this, set
	<literal>hw.acpi.osname=<replaceable>"Windows
	  2009"</replaceable></literal> in
	<filename>/boot/loader.conf</filename>, using the most recent
	<trademark class="registered">Windows</trademark> version listed in the <acronym>ASL</acronym>.</para>

      <para xml:lang="en">Other workarounds may require <filename>my.asl</filename>
	to be customized.  If this file is edited, compile the new
	<acronym>ASL</acronym> using the following command.  Warnings
	can usually be ignored, but errors are bugs that will usually
	prevent <acronym>ACPI</acronym> from working correctly.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>iasl -f <replaceable>my.asl</replaceable></userinput></screen>

      <para xml:lang="en">Including <option>-f</option> forces creation of the
	<acronym>AML</acronym>, even if there are errors during
	compilation.  Some errors, such as missing return statements,
	are automatically worked around by the FreeBSD
	interpreter.</para>

      <para xml:lang="en">The default output filename for <command>iasl</command> is
	<filename>DSDT.aml</filename>.  Load this file instead of the
	<acronym>BIOS</acronym>'s buggy copy, which is still present
	in flash memory, by editing
	<filename>/boot/loader.conf</filename> as follows:</para>

      <programlisting xml:lang="en">acpi_dsdt_load="YES"
acpi_dsdt_name="/boot/DSDT.aml"</programlisting>

      <para xml:lang="en">Be sure to copy <filename>DSDT.aml</filename> to
	<filename>/boot</filename>, then reboot the system.  If this
	fixes the problem, send a <citerefentry><refentrytitle>diff</refentrytitle><manvolnum>1</manvolnum></citerefentry> of the old and new
	<acronym>ASL</acronym> to <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-acpi">freebsd-acpi</link> so that developers can
	work around the buggy behavior in
	<filename>acpica</filename>.</para>
    </sect2>

    <sect2 xml:id="ACPI-submitdebug">
      <info>
	<title>取得與回報除錯資訊</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Nate</firstname>
	      <surname>Lawson</surname>
	    </personname>
	    <contrib>Written by </contrib>
	  </author>
	</authorgroup>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Peter</firstname>
	      <surname>Schultz</surname>
	    </personname>
	    <contrib>With contributions from </contrib>
	  </author>

	  <author xml:lang="en">
	    <personname>
	      <firstname>Tom</firstname>
	      <surname>Rhodes</surname>
	    </personname>
	  </author>
	</authorgroup>
      </info>

      <indexterm xml:lang="en">
	<primary>ACPI</primary>
	<secondary>problems</secondary>
      </indexterm>

      <indexterm xml:lang="en">
	<primary>ACPI</primary>
	<secondary>debugging</secondary>
      </indexterm>

      <para xml:lang="en">The <acronym>ACPI</acronym> driver has a flexible
	debugging facility.  A set of subsystems and the level of
	verbosity can be specified.  The subsystems to debug are
	specified as layers and are broken down into components
	(<literal>ACPI_ALL_COMPONENTS</literal>) and
	<acronym>ACPI</acronym> hardware support
	(<literal>ACPI_ALL_DRIVERS</literal>).  The verbosity of
	debugging output is specified as the level and ranges from
	just report errors (<literal>ACPI_LV_ERROR</literal>) to
	everything (<literal>ACPI_LV_VERBOSE</literal>).  The level is
	a bitmask so multiple options can be set at once, separated by
	spaces.  In practice, a serial console should be used to log
	the output so it is not lost as the console message buffer
	flushes.  A full list of the individual layers and levels is
	found in <citerefentry><refentrytitle>acpi</refentrytitle><manvolnum>4</manvolnum></citerefentry>.</para>

      <para xml:lang="en">Debugging output is not enabled by default.  To enable it,
	add <literal>options ACPI_DEBUG</literal> to the custom kernel
	configuration file if <acronym>ACPI</acronym> is compiled into
	the kernel.  Add <literal>ACPI_DEBUG=1</literal> to
	<filename>/etc/make.conf</filename> to enable it globally.  If
	a module is used instead of a custom kernel, recompile just
	the <filename>acpi.ko</filename> module as follows:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /sys/modules/acpi/acpi &amp;&amp; make clean &amp;&amp; make ACPI_DEBUG=1</userinput></screen>

      <para xml:lang="en">Copy the compiled <filename>acpi.ko</filename> to
	<filename>/boot/kernel</filename> and add the desired level
	and layer to <filename>/boot/loader.conf</filename>.  The
	entries in this example enable debug messages for all
	<acronym>ACPI</acronym> components and hardware drivers and
	output error messages at the least verbose level:</para>

      <programlisting xml:lang="en">debug.acpi.layer="ACPI_ALL_COMPONENTS ACPI_ALL_DRIVERS"
debug.acpi.level="ACPI_LV_ERROR"</programlisting>

      <para xml:lang="en">If the required information is triggered by a specific
	event, such as a suspend and then resume, do not modify
	<filename>/boot/loader.conf</filename>.  Instead, use
	<command>sysctl</command> to specify the layer and level after
	booting and preparing the system for the specific event.  The
	variables which can be set using <command>sysctl</command> are
	named the same as the tunables in
	<filename>/boot/loader.conf</filename>.</para>

      <indexterm xml:lang="en">
	<primary>ACPI</primary>
	<secondary>problems</secondary>
      </indexterm>

      <para xml:lang="en">Once the debugging information is gathered, it can be sent
	to <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-acpi">freebsd-acpi</link> so that it can be used by the FreeBSD
	<acronym>ACPI</acronym> maintainers to identify the root cause
	of the problem and to develop a solution.</para>

      <note>
	<para xml:lang="en">Before submitting debugging information to this mailing
	  list, ensure the latest <acronym>BIOS</acronym> version is
	  installed and, if available, the embedded controller
	  firmware version.</para>
      </note>

      <para xml:lang="en">When submitting a problem report, include the following
	information:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Description of the buggy behavior, including system
	    type, model, and anything that causes the bug to appear.
	    Note as accurately as possible when the bug began
	    occurring if it is new.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The output of <command>dmesg</command> after running
	    <command>boot -v</command>, including any error messages
	    generated by the bug.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <command>dmesg</command> output from <command>boot
	      -v</command> with <acronym>ACPI</acronym> disabled,
	    if disabling <acronym>ACPI</acronym> helps to fix the
	    problem.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Output from <command>sysctl hw.acpi</command>.  This
	    lists which features the system offers.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <acronym>URL</acronym> to a pasted version of the
	    system's <acronym>ASL</acronym>.  Do
	    <emphasis>not</emphasis> send the <acronym>ASL</acronym>
	    directly to the list as it can be very large.  Generate a
	    copy of the <acronym>ASL</acronym> by running this
	    command:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>acpidump -dt &gt; <replaceable>name</replaceable>-<replaceable>system</replaceable>.asl</userinput></screen>

	  <para xml:lang="en">Substitute the login name for
	    <replaceable>name</replaceable> and manufacturer/model for
	    <replaceable>system</replaceable>.  For example, use
	    <filename>njl-FooCo6000.asl</filename>.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">Most FreeBSD developers watch the <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-current">FreeBSD-CURRENT mailing list</link>, but one should
	submit problems to <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-acpi">freebsd-acpi</link> to be sure it is seen.  Be
	patient when waiting for a response.  If the bug is not
	immediately apparent, submit a bug report.
	When entering a <acronym>PR</acronym>,
	include the same information as requested above.  This helps
	developers to track the problem and resolve it.  Do not send a
	<acronym>PR</acronym> without emailing <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-acpi">freebsd-acpi</link> first as
	it is likely that the problem has been reported before.</para>
    </sect2>

    <sect2 xml:id="ACPI-References">
      <title>參考文獻</title>

      <para xml:lang="en">More information about <acronym>ACPI</acronym> may be
	found in the following locations:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">The FreeBSD <acronym>ACPI</acronym> Mailing List Archives
	    (<uri xlink:href="https://lists.freebsd.org/pipermail/freebsd-acpi/">https://lists.freebsd.org/pipermail/freebsd-acpi/</uri>)</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <acronym>ACPI</acronym> 2.0 Specification (<uri xlink:href="http://acpi.info/spec.htm">http://acpi.info/spec.htm</uri>)</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><citerefentry><refentrytitle>acpi</refentrytitle><manvolnum>4</manvolnum></citerefentry>, <citerefentry><refentrytitle>acpi_thermal</refentrytitle><manvolnum>4</manvolnum></citerefentry>, <citerefentry><refentrytitle>acpidump</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
	    <citerefentry><refentrytitle>iasl</refentrytitle><manvolnum>8</manvolnum></citerefentry>, and <citerefentry><refentrytitle>acpidb</refentrytitle><manvolnum>8</manvolnum></citerefentry></para>
	</listitem>
      </itemizedlist>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->

<chapter version="5.0" xml:id="boot">

  <title>FreeBSD 開機程序</title>

  <sect1 xml:id="boot-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en"><primary>booting</primary></indexterm>
    <indexterm xml:lang="en"><primary>bootstrap</primary></indexterm>

    <para>從開啟電腦到載入作業系統的這段流程稱為 <quote>開機程序</quote> (Bootstrap process) 或 <quote>開機</quote> (Booting)。FreeBSD 的開機程序提供大量的客製化彈性，包含可選擇安裝在同電腦的其他的作業系統、不同版本的作業系統或不同核心的作業系統的功能。</para>

    <para>本章會詳細說明可以設定的選項。示範如何自訂 FreeBSD 開機流程，包含其中所有會發生的事，直到啟動 FreeBSD 核心、偵測裝置及啟動 <citerefentry><refentrytitle>init</refentrytitle><manvolnum>8</manvolnum></citerefentry>。這些事會發生在開機訊息的文字顏色會從亮白變成灰色之間。</para>

    <para>在閱讀本章之後，您會了解：</para>

    <itemizedlist>
      <listitem>
	<para>FreeBSD 開機系統的元件以及它們如何互動。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 開機程式中各元件可使用的選項，用來控制開機程序。</para>
      </listitem>

      <listitem>
	<para>如何設定自訂的開機啟動畫面 (Splash screen)。</para>
      </listitem>

      <listitem>
	<para>設定 Device Hints 的基礎。</para>
      </listitem>

      <listitem>
	<para>如何開機進入單人及多人模式以及如何正確關閉 FreeBSD 系統。</para>
      </listitem>
    </itemizedlist>

    <note>
      <para>本章僅說明 FreeBSD 在 x86 及 amd64 系統上執行的開機流程。</para>
    </note>
  </sect1>

  <sect1 xml:id="boot-introduction">
    <title>FreeBSD 開機程序</title>

    <para>打開電腦並啟動作業系統的這個動作呈現了一個有趣的困境。照道理，電腦在啟動作業系統之前並不知道要如何做任何事情，這些事情之中包括從磁碟執行程式。如果電腦無法在沒有作業系統的情況下執行程式，而作業系統的程式本身又在磁碟上，那麼作業系統要如何啟動呢?</para>

    <para>這個問題如同 <citetitle>The Adventures of Baron Munchausen</citetitle> 一書中的一個角色掉進了洞裡，他抓住了靴子上的拔靴帶 (Bootstrap) 才把自己拉了出來，因此在早期電腦領域用 <firstterm>bootstrap</firstterm> 一詞來指載入作業系統的機制，後來被縮短為 <quote>booting</quote>。</para>

    <indexterm xml:lang="en"><primary><acronym>BIOS</acronym></primary></indexterm>

    <indexterm xml:lang="en"><primary>Basic Input/Output
	System</primary><see><acronym>BIOS</acronym></see></indexterm>

    <para>在 x86 硬體上，基本輸入/輸出系統 (Basic Input/Output System, <acronym>BIOS</acronym>) 負責載入作業系統。 <acronym>BIOS</acronym> 會找到硬碟上的主開機記錄區 (Master Boot Record, <acronym>MBR</acronym>)，該記錄區必須位於磁碟上的特定位置。<acronym>BIOS</acronym> 有足夠的知識可以載入並執行這個 <acronym>MBR</acronym>，並且假設這個 <acronym>MBR</acronym> 在 <acronym>BIOS</acronym> 的協助下可以完成接下來載入作業系統的工作。</para>

    <note>
      <para>FreeBSD 在較舊的 <acronym>MBR</acronym> 標準與較新的 GUID 分割區表 (GUID Partition Table, <acronym>GPT</acronym>) 上都能夠開機 (Booting)。<acronym>GPT</acronym> 磁碟分割通常會在有支援統一可延伸韌體介面 (Unified Extensible Firmware Interface, <acronym>UEFI</acronym>) 的電腦上找到。不論如何，FreeBSD 即使在只有傳統 <acronym>BIOS</acronym> 的機器上，也可以使用 <citerefentry><refentrytitle>gptboot</refentrytitle><manvolnum>8</manvolnum></citerefentry> 由 <acronym>GPT</acronym> 分割區開機。直接使用 <acronym>UEFI</acronym> 開機的開發工作正在進行中。</para>
    </note>

    <indexterm xml:lang="en"><primary>Master Boot Record
	(<acronym>MBR</acronym>)</primary></indexterm>

    <indexterm xml:lang="en"><primary>Boot Manager</primary></indexterm>

    <indexterm xml:lang="en"><primary>Boot Loader</primary></indexterm>

    <para>在 <acronym>MBR</acronym> 中的程式通常會稱作開機管理程式 (<emphasis>Boot manager</emphasis>)，特別是那些會與使用者互動的程式。開機管理程式通常會另一部份的程式會存放於磁碟的第一個磁軌或檔案系統。開機管理程式的例子有標準 FreeBSD 開機管理程式 <application>boot0</application> 又稱 <application>Boot Easy</application> 以及 <application>Grub</application> 常用於各種 <trademark class="registered">Linux</trademark> 發行版。</para>

    <para>若只有安裝一個作業系統，<acronym>MBR</acronym> 會搜尋磁碟上第一個可開機的 (使用中) 切割區 (Slice)，然後執行在該切割區上的程式來載入剩下的作業系統。當有多個作業系統存在時，可以安裝可顯示作業系統清單的開機管理程式，以讓使用者可以選擇要啟動的作業系統。</para>

    <para>剩餘的 FreeBSD 開機系統分成三個階段，第一個階段只知道如何讓電腦進入特定狀態並執行第二階段，第二個階段在執行第三階段之前會做的事比較多一點，第三個階段會完成載入作業系統的工作。把工作分成三個階段的原因是 <acronym>MBR</acronym> 有限制在階段一與階段二能夠執行程式的大小。將這些工作連結在一起讓 FreeBSD 能夠提供更有彈性的載入程式。</para>

    <indexterm xml:lang="en"><primary>kernel</primary></indexterm>
    <indexterm xml:lang="en"><primary><citerefentry><refentrytitle>init</refentrytitle><manvolnum>8</manvolnum></citerefentry></primary></indexterm>

    <para>核心會接著開始偵測裝置並初始化這些裝置供使用。核心開機程序完成之後，核心便會傳送控制權給使用者程序 <citerefentry><refentrytitle>init</refentrytitle><manvolnum>8</manvolnum></citerefentry>，這個程序會確保磁碟在可以使用的狀態，然後啟動使用者層級的資源設置來掛載檔案系統、設定網路卡以能夠連線網路、啟動那些被設定在開機時要啟動的程序。</para>

    <para>本章節將更詳細介紹這些階段並示範如何與 FreeBSD 開機程序互動。</para>

    <sect2 xml:id="boot-boot0">
      <title>開機管理程式</title>

      <indexterm xml:lang="en"><primary>Boot Manager</primary></indexterm>

      <indexterm xml:lang="en"><primary>Master Boot Record
	(<acronym>MBR</acronym>)</primary></indexterm>

      <para>有時會稱在 <acronym>MBR</acronym> 中的開機管理程式為開機程序的 <emphasis>第零階段 (Stage zero)</emphasis>，FreeBSD 預設會使用 <application>boot0</application> 開機管理程式。</para>

      <para>由 FreeBSD 安裝程式所安裝的 <acronym>MBR</acronym> 便是以 <filename>/boot/boot0</filename> 為基礎。<application>boot0</application> 的大小與容量被限制在 446 個位元組是由於切割表與 <literal>0x55AA</literal> 識別碼位於 <acronym>MBR</acronym> 的最末端。若安裝多個作業系統使用 <application>boot0</application> ，則會在開機時顯示如下範例的訊息：</para>

      <example xml:id="boot-boot0-example">
	<title><filename>boot0</filename> 螢幕截圖</title>

	<screen xml:lang="en">F1 Win
F2 FreeBSD

Default: F2</screen>
      </example>

      <para>其作他作業統若在 FreeBSD 之後才安裝則會覆蓋現有的 <acronym>MBR</acronym>，若這件事發生了，或者要使用 FreeBSD <acronym>MBR</acronym> 取代現有的 <acronym>MBR</acronym> 可使用以下指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>fdisk -B -b /boot/boot0 <replaceable>device</replaceable></userinput></screen>

      <para>其中 <replaceable>device</replaceable> 開機磁碟，例如第一個 <acronym>IDE</acronym> 磁碟為 <filename>ad0</filename>，第二個 <acronym>IDE</acronym> 控制器的第一個 <acronym>IDE</acronym>磁碟為 <filename>ad2</filename>，第一個 <acronym>SCSI</acronym> 磁碟為 <filename>da0</filename>。要建立自訂的 <acronym>MBR</acronym> 設定請參考 <citerefentry><refentrytitle>boot0cfg</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</para>
    </sect2>

    <sect2 xml:id="boot-boot1">
      <title>階段一與階段二</title>

      <para>概念上，第一與第二個階段均為磁碟上同一個區域上同一個程式的一部份，由於空間上的限制，它們被分成兩部份，但是會一併安裝。它們會由 FreeBSD 安裝程式或 <command>bsdlabel</command> 從 <filename>/boot/boot</filename> 複製而來。</para>

      <para>這兩個階段均位於檔案系統之外，在開機切割區的第一個磁軌，從第一個磁碟扇區 (Sector) 開始，這個位置便是 <application>boot0</application> 或其他開機管理程式所會儲存的地方，並會尋找可以執行的程式以繼續開機程序。</para>

      <para>第一個階段的 <filename>boot1</filename> 非常的簡單，因為它只能有 512 位元組的大小。它只能認得儲存切割區資訊的 FreeBSD <firstterm>bsdlabel</firstterm> 以及尋找並執行 <filename>boot2</filename>。</para>

      <para>階段二 <filename>boot2</filename> 稍微複雜一點，能夠理解 FreeBSD 檔案系統來搜尋檔案。它可以提供一個簡單的介面來選擇要執行的核心或載入程式。它所執行的載入程式 (<application>loader</application>) 更複雜並能讀取開機設定檔。若開機程序在階段二中斷，則會顯示以下的互動畫面：</para>

      <example xml:id="boot-boot2-example">
	<title><filename>boot2</filename> 螢幕截圖</title>

	<screen xml:lang="en">&gt;&gt; FreeBSD/i386 BOOT
Default: 0:ad(0,a)/boot/loader
boot:</screen>
      </example>

      <para>要更換已安裝的 <filename>boot1</filename> 與 <filename>boot2</filename> 可使用 <command>bsdlabel</command>，其中 <replaceable>diskslice</replaceable> 是要開機的磁碟與切割區，例如 <filename>ad0s1</filename> 代表第一個 <acronym>IDE</acronym> 磁碟的第一個切割區：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>bsdlabel -B <replaceable>diskslice</replaceable></userinput></screen>

      <warning>
	<para>若只使用磁碟名稱，如 <filename>ad0</filename>，<command>bsdlabel</command> 便會以 <quote>危險專用的模式</quote> 來建立磁碟，而不會建立任何分割區。這個可能與預期的動作不同，所以在按下 <keycap>Return</keycap> 鍵之前請再次確認 <replaceable>diskslice</replaceable>。</para>
      </warning>
    </sect2>

    <sect2 xml:id="boot-loader">
      <title>階段三</title>

      <indexterm xml:lang="en"><primary>boot-loader</primary></indexterm>

      <para><application>loader</application> 是三階段開機程多的最後一個階段，載入程式位於檔案系統之中，通常在 <filename>/boot/loader</filename>。</para>

      <para><application>loader</application> 主要目地是利用擁有更複雜指令集的強大直譯器做為基礎的內建指令集提供一個互動的方式來做設定。</para>

      <para>在初始化的過程中，<application>loader</application> 會偵測 Console 與磁碟，並找出可以用來開機的磁碟。在由 Script 或互動輸入使用者指令的地方會設定相對的變數並啟動直譯器。</para>

      <indexterm xml:lang="en"><primary>loader</primary></indexterm>
      <indexterm xml:lang="en"><primary>loader configuration</primary></indexterm>

      <para><application>loader</application> 接著會讀取 <filename>/boot/loader.rc</filename>，這個程式預設又會讀取 <filename>/boot/defaults/loader.conf</filename> 來設定合理的變數預設值以及讀取 <filename>/boot/loader.conf</filename> 來對這些變數做本地的更改。<filename>loader.rc</filename> 接著會依這些變數來運作，讀取選擇模組與核心。</para>

      <para>最後，預設情況下 <application>loader</application> 會待候鍵盤輸入 10 秒鐘，若沒有被中斷的話會接著啟動核心。若被使用者中斷，則會向使用者顯示提示字元，此時使用可以使用指令集來調整變數、卸載所有模組、載入模組，然後最後開機或重新開機。<xref linkend="boot-loader-commands"/> 中列出了最常使用的 <application>loader</application> 指令。要完整了解所有可用的指令，請參考 <citerefentry><refentrytitle>loader</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</para>

      <table xml:id="boot-loader-commands" frame="none" pgwide="1">
	<title>載入程式內建指令</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>變數</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">autoboot
		<replaceable>seconds</replaceable></entry>
	      <entry>若在指定時間 (秒) 內沒有中斷，會繼續啟動核心。此指令會顯示倒數，預設的時間為 10 秒鐘。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">boot
		<optional><replaceable>-options</replaceable></optional>
		<optional><replaceable>kernelname</replaceable></optional></entry>
	      <entry>使用任何指定的選項或核心名稱立即啟動核心，要由指令列指定核心名稱必須先執行 <command>unload</command>，否則會使用先前載入過的核心。若 <emphasis>kernelname</emphasis> 不是完整的路徑則會搜尋 <emphasis>/boot/kernel</emphasis> 及 <emphasis>/boot/modules</emphasis> 底下。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">boot-conf</entry>
	      <entry>依據指定的變數及最常用的 <envar>kernel</envar> 再做一次相同的自動模組設置。這只有在執行 <command>unload</command> 之後，尚未變更變數之前方可使用。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">help
		<optional><replaceable>topic</replaceable></optional></entry>
	      <entry>顯示自 <filename>/boot/loader.help</filename> 取得的說明訊息。若指定的主題為 <literal>index</literal> 則會顯示所有可用的主題。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">include <replaceable>filename</replaceable>
		…</entry>
	      <entry>讀取指定的檔案並直譯每一行。若有錯誤則會立即中止 <command>include</command>。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">load <optional>-t
		  <replaceable>type</replaceable></optional>
		<replaceable>filename</replaceable></entry>
	      <entry>由指定的檔案名稱載入核心、核心模組或指定類型的檔案。任何於 <replaceable>filename</replaceable> 之後的參數都會被傳遞到該檔案。若 <emphasis>filename</emphasis> 不是絕對位置則會搜尋 <emphasis>/boot/kernel</emphasis> 及 <emphasis>/boot/modules</emphasis> 底下。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">ls <optional>-l</optional>
		<optional><replaceable>path</replaceable></optional></entry>
	      <entry>顯示指定路徑中的檔案，若未指定路徑則會顯示根目錄中的檔案。若有指定 <option>-l</option>，則會連檔案大小一同顯示。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">lsdev <optional>-v</optional></entry>
	      <entry>列出所有的裝置，這些裝置可能可以用來載入模組。若有指定 <option>-v</option> 則會顯示更詳細的資訊。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">lsmod <optional>-v</optional></entry>
	      <entry>顯示已載入的模組。若有指定 <option>-v</option> 則會顯示更詳細的資訊。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">more <replaceable>filename</replaceable></entry>
	      <entry>顯示指定的檔案，並於每 <varname>LINES</varname> 行顯示後會暫停。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">reboot</entry>
	      <entry>立即重新啟動系統。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">set <replaceable>variable</replaceable>, set
		<replaceable>variable</replaceable>=<replaceable>value</replaceable></entry>
	      <entry>設定指定的環境變數。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">unload</entry>
	      <entry>移除所有已載入的模組。</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>這裡有一些 loader 用法的實務範例。要使用一般的核心開機進入單使用者模式 (Single-user mode<indexterm><primary>single-user
	  mode</primary></indexterm>) 可：</para>

      <screen xml:lang="en"><userinput>boot -s</userinput></screen>

      <para>要卸載一般的核心與模組，然後載入先前或另一個指定的核心可：</para>

      <screen xml:lang="en"><userinput>unload</userinput>
<userinput>load <replaceable>kernel.old</replaceable></userinput></screen>

      <para>使用 <filename>kernel.GENERIC</filename> 來代表安裝程式使用的預設核心，或 <filename>kernel.old</filename> 來代表在系統升級之前或設定自訂核心前安裝的核心。</para>

      <para>使用以下指令來使用另一個核心載入一般的模組：</para>

      <screen xml:lang="en"><userinput>unload</userinput>
<userinput>set kernel="<replaceable>kernel.old</replaceable>"</userinput>
<userinput>boot-conf</userinput></screen>

      <para>要載入一個已自動化的核心設置 Script 可：</para>

      <screen xml:lang="en"><userinput>load -t userconfig_script <replaceable>/boot/kernel.conf</replaceable></userinput></screen>

      <indexterm xml:lang="en">
	<primary>kernel</primary>
	<secondary>boot interaction</secondary>
      </indexterm>
    </sect2>

    <sect2 xml:id="boot-init">
      <title>最終階段</title>

      <indexterm xml:lang="en">
	<primary><citerefentry><refentrytitle>init</refentrytitle><manvolnum>8</manvolnum></citerefentry></primary>
      </indexterm>

      <para>由 <application>loader</application> 或由會繞開 <application>loader</application> 的 <application>boot2</application> 載入核心之後，載入程式便會檢查是不有使用任何開機旗標，並根據需要調整開機的方式。<xref linkend="boot-kernel"/> 列出了常用的開機旗標，請參考 <citerefentry><refentrytitle>boot</refentrytitle><manvolnum>8</manvolnum></citerefentry> 取得更多其他開機旗標的資訊。</para>

      <indexterm xml:lang="en">
	<primary>kernel</primary>
	<secondary>bootflags</secondary>
      </indexterm>

      <table xml:id="boot-kernel" frame="none" pgwide="1">
	<title>開機時核心互動參數</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>項目</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><option>-a</option></entry>
	      <entry>核心初始化時，會詢問要掛載為根檔案系統的裝置。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><option>-C</option></entry>
	      <entry>由 <acronym>CDROM</acronym> 做為根檔案系統開機。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><option>-s</option></entry>
	      <entry>開機進入單使用者模式。</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><option>-v</option></entry>
	      <entry>核心啟動時提供更多詳細資訊。</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>一旦核心完成開機程序後，便會傳送控制權給使用者程序 <citerefentry><refentrytitle>init</refentrytitle><manvolnum>8</manvolnum></citerefentry>，該程序位於 <filename>/sbin/init</filename> 或在 <command>loader</command> 中的 <envar>init_path</envar> 變數所指的程式路徑。這是開機程序的最後一個階段。</para>

      <para>開機程序會確保系統上的檔案系統的一致性 (Consistency)，若 <acronym>UFS</acronym> 檔案系統不一致且 <command>fsck</command> 無法修時，<application>init</application> 會讓系統進入單使用者模式，以讓系統管理者能夠直接解決問題，否則系統會開機進入多使用者模式。</para>

      <sect3 xml:id="boot-singleuser">
	<title>單使用者模式</title>

	<indexterm xml:lang="en"><primary>single-user mode</primary></indexterm>
	<indexterm xml:lang="en"><primary>console</primary></indexterm>

	<para>使用者可以在開機時指定 <option>-s</option> 或在 <application>loader</application> 設定 <envar>boot_single</envar> 變數進入這個模式。也可以透過在多使用者模式執行 <command>shutdown now</command> 進入此模式。進入單使用者模式時會出現此訊息：</para>

	<programlisting xml:lang="en">Enter full pathname of shell or RETURN for /bin/sh:</programlisting>

	<para>若使用者按下 <keycap>Enter</keycap>，系統便會進入預設的 Bourne shell。要指定使用其他的 Shell 則輸入該 Shell 的完整路徑。</para>

	<para>單使用者模式通常用來修復因檔案系統不一致或開機設定檔發生錯誤造成的無法開機，也可以用來重設遺忘的 <systemitem class="username">root</systemitem> 的密碼，因為在單使用者模式會給予對本地系統及設定檔完整的存取權。在這個模式下沒有網路功能。</para>

	<para>雖然單使用者模式對修復系統很有幫助，但若系統放在不安全的場所便會有安全上的風險。預設，開機進入單使用者模式後，任何能夠存取實體主機的使用者便擁有系統的完整控制權。</para>

	<para>若在 <filename>/etc/ttys</filename> 系統 <literal>console</literal> 更改為 <literal>insecure</literal>，系統便會在初始化單使用者模式前先詢問 <systemitem class="username">root</systemitem> 的密碼。這可增加一定程度的安全性，但便無法在忘記 <systemitem class="username">root</systemitem> 密碼時重設密碼。</para>

	<example xml:id="boot-insecure-console">
	  <title>在 <filename>/etc/ttys</filename> 設定不安全的 Console</title>

	  <programlisting xml:lang="en"># name  getty                           type    status          comments
#
# If console is marked "insecure", then init will ask for the root password
# when going to single-user mode.
console none                            unknown off <replaceable>insecure</replaceable></programlisting>
	</example>

	<para>不安全 (<literal>insecure</literal>) console  代表對 Console 的實體安全性評估為不安全 (insecure)，所以只有知道 <systemitem class="username">root</systemitem> 密碼的人可以使用單使用者模式。</para>
      </sect3>

      <sect3 xml:id="boot-multiuser">
	<title>多使用者模式</title>

	<indexterm xml:lang="en"><primary>multi-user mode</primary></indexterm>

	<para>若 <application>init</application> 正常找到檔案系統或在單使用者模式的使用者完成了操作並輸入 <command>exit</command> 離開單使用者模式，系統便會進入多使用者模式，在這個模式便會開始系統的資源設置。</para>

	<indexterm xml:lang="en"><primary>rc files</primary></indexterm>

	<para>資源設置系統 (Resource configuration system) 會從 <filename>/etc/defaults/rc.conf</filename> 讀取設定預設值以及從 <filename>/etc/rc.conf</filename> 讀取系統特定的設定，接著會繼續掛載系統列於 <filename>/etc/fstab</filename> 的檔案系統，也會啟動網路服務、其他的系統 Daemon，然後執行本地已安裝套件的啟動 Script。</para>

	<para>要了解更多有關資源設置系統，請參考 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以及查看位於 <filename>/etc/rc.d</filename> 的 Script。</para>
      </sect3>
    </sect2>
  </sect1>
  <!--
  <sect2 id="boot-kernel-userconfig">
      <title>UserConfig: the Boot-time Kernel Configurator</title>

      <para> </para>
  </sect2> -->

  <sect1 xml:id="boot-splash">
    <info>
      <title>設定開機啟動畫面</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Joseph J.</firstname>
	    <surname>Barbish</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <para>正常 FreeBSD 系統開機會在 Console 顯示以一系列訊息來表示開機進度。開機啟動畫面 (Boot splash screen) 是另一種可以把所有開機偵測與服務啟動訊息隱藏的開機畫面，但即使開啟了啟動畫面，仍有有少數的開機載入程式的訊息，如：開機選項選單以及倒數時間的提示，仍會在開機時顯示。在開機程序時可以按下鍵盤上的按鍵來關閉顯示中的啟動畫面。</para>

    <para>FreeBSD 有兩種基本的環境可以使用，一種是預設的傳統虛擬 Console 指令列環境，在系統完成開機之後，便會顯示 Console 登入提示。另一種環境則是設定好的圖型化環境，請參考 <xref linkend="x11"/> 以取得更多有關如何安裝與設定圖型化顯示管理程式與圖型化登入管理程式的資訊。</para>

    <para>系統開機之後，啟動畫面預設會作為螢幕保護程式，一段時間未使用便會顯示啟動畫面，並且會循環更改影像的亮度，從明亮到非常暗，然後再繼續循環。啟動螢幕保護程式的設定可在 <filename>/etc/rc.conf</filename> 增加一行 <literal>saver=</literal> 來更改。有許多內建的螢幕保護程式可用，在 <citerefentry><refentrytitle>splash</refentrytitle><manvolnum>4</manvolnum></citerefentry> 中有說明。<literal>saver=</literal> 的選項只會套用至虛擬 Console，對圖型化顯示管理程式並不會有任何影響。</para>

    <para>透過安裝 <package>sysutils/bsd-splash-changer</package> 套件或 Port，可在開機時顯示隨機挑選的啟動畫面。啟動畫面功能支援 256 色的點陣圖 (<filename>.bmp</filename>)、ZSoft <acronym>PCX</acronym> (<filename>.pcx</filename>) 或 TheDraw (<filename>.bin</filename>) 格式。<filename>.bmp</filename>, <filename>.pcx</filename> 或 <filename>.bin</filename> 圖片必須放在根分割區，例如於 <filename>/boot</filename>。啟動圖片檔必須使用 320x200 像素或更低的解析度以能夠在標準 <acronym>VGA</acronym> 介面卡上運作，要在預設 256 色、320x200 像素或更低的解析度設定開機啟動圖片，可加入下行到 <filename>/boot/loader.conf</filename>，並替換 <replaceable>splash.bmp</replaceable> 為實際要使用的點陣圖檔：</para>

    <programlisting xml:lang="en">splash_bmp_load="YES"
bitmap_load="YES"
bitmap_name="/boot/<replaceable>splash.bmp</replaceable>"</programlisting>

    <para>要使用 <acronym>PCX</acronym> 檔則可替換點陣圖檔：</para>

    <programlisting xml:lang="en">splash_pcx_load="YES"
bitmap_load="YES"
bitmap_name="/boot/<replaceable>splash.pcx</replaceable>"</programlisting>

    <para>若要改使用 <link xlink:href="https://en.wikipedia.org/wiki/TheDraw">https://en.wikipedia.org/wiki/TheDraw</link> 格式的 ASCII 圖可：</para>

    <programlisting xml:lang="en">splash_txt="YES"
bitmap_load="YES"
bitmap_name="/boot/<replaceable>splash.bin</replaceable>"</programlisting>

    <para>要使用較大的圖片來填滿整個顯示畫面支援的解析度最大可至 1024x768 像素，<acronym>VESA</acronym> 模組也必須在系統開機時載入。若使用自訂的核心，請確定自訂核心設定檔中有含有 <literal>VESA</literal> 核心設定選項。要載入 <acronym>VESA</acronym> 模組來顯示啟動畫面可在 <filename>/boot/loader.conf</filename> 上述例子中提到的三行之前加入下行：</para>

    <programlisting xml:lang="en">vesa_load="YES"</programlisting>

    <para>其他有用的 <filename>loader.conf</filename> 選項還有：</para>

    <variablelist>
      <varlistentry><term xml:lang="en"><literal>beastie_disable="YES"</literal></term>

	<listitem>
	  <para>這個會關閉開機選項選單的顯示，但倒數計時提示仍會在。即使關閉了開機選項選單，在倒數計時提示時輸入選擇的選項還是會啟動對應的開機選項。</para>
	</listitem>
      </varlistentry>

      <varlistentry><term xml:lang="en"><literal>loader_logo="beastie"</literal></term>

	<listitem>
	  <para>這個選項會替換預設與上色的小惡魔圖示一起顯示於開機選項選單右側的 <quote>FreeBSD</quote> 文字。</para>
	</listitem>
      </varlistentry>
    </variablelist>

    <para>要取得更多資訊，請參考 <citerefentry><refentrytitle>splash</refentrytitle><manvolnum>4</manvolnum></citerefentry>, <citerefentry><refentrytitle>loader.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>vga</refentrytitle><manvolnum>4</manvolnum></citerefentry>。</para>
  </sect1>

  <sect1 xml:id="device-hints">
    <info>
      <title>裝置提示</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>device.hints</primary>
    </indexterm>

    <para>在一開始系統啟動時，開機 <citerefentry><refentrytitle>loader</refentrytitle><manvolnum>8</manvolnum></citerefentry> 會讀取 <citerefentry vendor="current"><refentrytitle>device.hints</refentrytitle><manvolnum>5</manvolnum></citerefentry>，這個檔中儲存了核心開機資訊，即變數，有時我們又會稱其為 <quote>裝置提示 (Device hints)</quote>。這些 <quote>裝置提示 (Device hints)</quote> 會傳送給裝置驅動程式做裝置的設置使用。</para>

    <para>裝置提示也可在階段 3 開機載入程式提示時指定，如 <xref linkend="boot-loader"/> 中的示範，其變數也可以使用 <command>set</command> 增加、使用 <command>unset</command> 移除、使用 <command>show</command> 檢視，也可覆蓋設定在 <filename>/boot/device.hints</filename> 的變數，但在開機載入程式輸入的裝置提示並不是永久有效的，在下一次重新開機久後便會失效。</para>

    <para>一旦系統開機後，便可使用 <citerefentry><refentrytitle>kenv</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來列出所有的變數。</para>

    <para><filename>/boot/device.hints</filename> 的語法為一個變數一行，使用井字號 <quote>#</quote> 做為註解符號，每一行的結構如下：</para>

    <screen xml:lang="en"><userinput>hint.driver.unit.keyword="<replaceable>value</replaceable>"</userinput></screen>

    <para>在階段 3 開機載入程式的語法則為：</para>

    <screen xml:lang="en"><userinput>set hint.driver.unit.keyword=<replaceable>value</replaceable></userinput></screen>

    <para>其中 <literal>driver</literal> 為裝置驅動程式名稱、<literal>unit</literal> 為裝置驅動程式單位編號及 <literal>keyword</literal> 為提示關鍵字，關鍵字由以下選項所組成：</para>

    <itemizedlist>
      <listitem>
	<para><literal>at</literal>: 指定裝置所連結的匯流排 (Bus)。</para>
      </listitem>

      <listitem>
	<para><literal>port</literal>: 指定要使用的 <acronym>I/O</acronym> 開始位置。</para>
      </listitem>

      <listitem>
	<para><literal>irq</literal>: 指定要使用的中斷請求編號。</para>
      </listitem>

      <listitem>
	<para><literal>drq</literal>: 指定 DMA 頻道編號。</para>
      </listitem>

      <listitem>
	<para><literal>maddr</literal>: 指定裝置所使用的實體記憶體位置。</para>
      </listitem>

      <listitem>
	<para><literal>flags</literal>: 設定提供給裝置的各種旗標位元。</para>
      </listitem>

      <listitem>
	<para><literal>disabled</literal>: 若設為 <literal>1</literal> 則可關閉該裝置。</para>
      </listitem>
    </itemizedlist>

    <para>由於裝置驅動程式可能會接受或請求更多未列於此處的提示，建議先閱讀驅動程式的操作手冊。要取得更多資訊請參考 <citerefentry vendor="current"><refentrytitle>device.hints</refentrytitle><manvolnum>5</manvolnum></citerefentry>, <citerefentry><refentrytitle>kenv</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <citerefentry><refentrytitle>loader.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>loader</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</para>
  </sect1>

  <sect1 xml:id="boot-shutdown">
    <title>關機程序</title>

    <indexterm xml:lang="en">
      <primary><citerefentry><refentrytitle>shutdown</refentrytitle><manvolnum>8</manvolnum></citerefentry></primary>
    </indexterm>

    <para>在使用 <citerefentry><refentrytitle>shutdown</refentrytitle><manvolnum>8</manvolnum></citerefentry> 控制關閉時，<citerefentry><refentrytitle>init</refentrytitle><manvolnum>8</manvolnum></citerefentry> 會嘗試執行 <filename>/etc/rc.shutdown</filename> Script 接著傳送 <literal>TERM</literal> 信號給所有的程序，然後傳送 <literal>KILL</literal> 信號給未在時間內中止的程序。</para>

    <para>要在支援電源管理的架構與系統關閉 FreeBSD 主機電源，可使用 <command>shutdown -p now</command> 來立即關閉電源，要重新啟動 FreeBSD 系統可使用 <command>shutdown -r now</command>。操作人必須為 <systemitem class="username">root</systemitem> 或為 <systemitem class="groupname">operator</systemitem> 的成員才可執行 <citerefentry><refentrytitle>shutdown</refentrytitle><manvolnum>8</manvolnum></citerefentry>，擁有這些身份的人也可使用 <citerefentry><refentrytitle>halt</refentrytitle><manvolnum>8</manvolnum></citerefentry> 與 <citerefentry><refentrytitle>reboot</refentrytitle><manvolnum>8</manvolnum></citerefentry>，參考這些指令與 <citerefentry><refentrytitle>shutdown</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的操作手冊來取得更多資訊。</para>

    <para>要修改群組成員可參考 <xref linkend="users-synopsis"/>。</para>

    <note>
      <para>電源管理需要以載入 <citerefentry><refentrytitle>acpi</refentrytitle><manvolnum>4</manvolnum></citerefentry> 模組或將其靜態編譯至自訂核心中。</para>
    </note>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="security">

  <info>
    <title>安全性</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	</personname>
	<contrib>Rewritten by </contrib>
      </author>
    </authorgroup>
  </info>

  <indexterm xml:lang="en"><primary>security</primary></indexterm>

  <sect1 xml:id="security-synopsis">
    <title>概述</title>

    <para>不論實體或虛擬，安全性這個主題大到有整個產業圍繞著它，上百個標準案例已經被用來搛寫如何確保系統與網路的安全性。身為 FreeBSD 必須了解如何避免攻擊與入侵。</para>

    <para>在此章會討論幾個基本原理及技術。FreeBSD 系統的安全性有許多層面，且有許多第三方工具可以用來增加安全性。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>基礎 FreeBSD 系統安全概念。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 中的幾種加密 (Crypt) 機制。</para>
      </listitem>

      <listitem>
	<para>如何設定一次性密碼認證。</para>
      </listitem>

      <listitem>
	<para>如何設定 <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 中的 <application>TCP Wrapper</application>。</para>
      </listitem>

      <listitem>
	<para>如何在 FreeBSD 設定 <application>Kerberos</application>。</para>
      </listitem>

      <listitem>
	<para>如何設定 <acronym>IPsec</acronym> 並且建立 <acronym>VPN</acronym>。</para>
      </listitem>

      <listitem>
	<para>如何在 FreeBSD 設定並使用 <application>OpenSSH</application>。</para>
      </listitem>

      <listitem>
	<para>如何使用檔案系統 <acronym>ACL</acronym>。</para>
      </listitem>

      <listitem>
	<para>如何使用 <application>pkg</application> 來稽查從 Port 套件集安裝的第三方軟體套件。</para>
      </listitem>

      <listitem>
	<para>如何利用 FreeBSD 安全報告。</para>
      </listitem>

      <listitem>
	<para>什麼是程序追蹤 (Process Accounting) 以及如何在 FreeBSD 開啟。</para>
      </listitem>

      <listitem>
	<para>如何使用登入類別或資源限制資料庫控制使用者資源。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>了解 FreeBSD 基礎及網路概念。</para>
      </listitem>
    </itemizedlist>

    <para>其他的安全性議題會在本操作手冊的其他處說明。例如 強制存取控制 (Mandatory Access Control, MAC) 會在 <xref linkend="mac"/> 討論及網路防火牆會在 <xref linkend="firewalls"/> 討論。</para>
  </sect1>

  <sect1 xml:id="security-intro">
    <title>簡介</title>

    <para>保安是每個人的責任，任何系統中的弱點都可讓入侵者取得對關鍵資訊的存取權並導致整個網路的浩劫。資訊安全的其中一個核心原則便是 <acronym>CIA</acronym> 三字訣，代表著資訊系統的機密性 (Confidentiality)、完整性 (Integrity) 以及可用性 (Availability)。</para>

    <para><acronym>CIA</acronym> 三字訣是電腦安全的基石，就如同客戶與使用者期望他們的資料得到保護一樣重要。例如，一個客戶會期望他們的信用卡資訊被安全的保存 (機密性)、他們的訂單不會在私底下被竄改 (完整性) 以及他們隨時可以存取他們的訂單資訊 (可用性)。</para>

    <para>要提供 <acronym>CIA</acronym>，安全專家會應用防禦深度的策略。防禦深度的概念是增加數個保全階層來避免單一階層失效便導致整個安全系統瓦解。例如，系統管理者不能直接打開防火牆與評估網路或系統的安全性，還要同時稽查帳號、檢查 Binary 的完整性與確保未被安裝惡意工具。要執行有效的保安策略，必須了解威脅以及如何抵禦威脅。</para>

    <para>什麼威脅影響到電腦安全性? 威脅並不僅限於在遠端嘗試未經授權存取系統的遠端攻擊者，威脅也包含員工、惡意軟體、未經許可的網路裝置、天然災害、安全性漏洞甚至是公司競爭對手。</para>

    <para>系統與網路可以被未經授權存取，有時是因為意外，或是因遠端攻擊者，或在某些案例中，是因商業間諜或者前員工。做為使用者，重要的是做好防範準備以及當有失誤造成安全漏洞能夠承認並回報可能的問題給安全團隊。做為管理者，重要的是了解威脅並準備在發生時能夠減緩威脅。</para>

    <para>當要應用保安到系統上時，建議由基本帳號以及系統設定開始保全，接著確保網路層，使其遵守系統政策以及組織的安全程序。許多組織已經有涵蓋科技裝置設置的安全性政策，該政策應包含工作站、桌上型電腦、行動裝置、手機、上線伺服器、開發伺服器的安全設置。在大多數案例中，也都已經有標準操作程序 (<acronym>SOP</acronym>)，當有疑慮時，請向安全團隊諮詢。</para>

    <para>簡介接下來的部份將說明如何在 FreeBSD 系統上執行這些基礎的安全設置。本章接下來的部份將介紹在 FreeBSD 系統執行安全性政策時會用到的特定工具。</para>

    <sect2 xml:id="security-accounts">
      <title>防止登入</title>

      <para>要確保一個系統的安全最好的起點便是做好帳號的稽查，確保 <systemitem class="username">root</systemitem> 使用了一個強而有力的密碼，並這個密碼未在其他地方使用過，然後關閉任何無須登入存取權的帳號。</para>

      <para>要防止登入存取帳號有兩種方法，第一種是鎖定帳號，以下範例會鎖定 <systemitem class="username">toor</systemitem> 帳號：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pw lock <replaceable>toor</replaceable></userinput></screen>

      <para>第二種防止登入存取的方式是狀 Shell 更改為 <filename>/usr/sbin/nologin</filename>，只有超級使用者可以更改其他使用者的 Shell：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>chsh -s /usr/sbin/nologin <replaceable>toor</replaceable></userinput></screen>

      <para><filename>/usr/sbin/nologin</filename> shell 可以避免系統分配 Shell 給嘗試登入的使用者。</para>
    </sect2>

    <sect2 xml:id="security-accountmgmt">
      <title>帳號升級授權</title>

      <para>在有一些案例，需要與其他使用者共用系統管理權限，FreeBSD 有兩種方式可以處理這種情況。第一種，也是較不建議的方式，是與 <systemitem class="groupname">wheel</systemitem> 群組的成員共用 root 的密碼，這種方式使用者可以在需要超級使用者的存取權時輸入 <command>su</command> 然後輸入 <systemitem class="groupname">wheel</systemitem> 的密碼，在完成需要管理存取權的指令之後，使用應輸入 <command>exit</command> 離開。要加入使用者到這個群組，可編輯 <filename>/etc/group</filename> 然後加入該使用者到 <literal>wheel</literal> 項目的最後，使用者必須以逗號字元分隔並不可有空白。</para>

      <para>第二種方式，也是較建議的方式，安裝 <package>security/sudo</package> 套件或 Port 來提升權限。這個軟體提供了額外的稽查、更細微的使用者控制，然後可以設定鎖定使用者只能執行特定需權限的指令。</para>

      <para>在安裝之後，使用 <command>visudo</command> 來編輯 <filename>/usr/local/etc/sudoers</filename>。這個範例會建立新 <systemitem class="groupname">webadmin</systemitem> 群組，並加入 <systemitem class="username">trhodes</systemitem> 帳號到該群組，然後設定該群組可重新啟動 <package>apache24</package> 的存取權：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupadd webadmin -M trhodes -g 6000</userinput>
<prompt>#</prompt> <userinput>visudo</userinput>
%webadmin ALL=(ALL) /usr/sbin/service apache24 *</screen>
    </sect2>

    <sect2 xml:id="security-passwords">
      <title>密碼編碼方式</title>

      <para>密碼是資訊科技的必要之惡，當必須使用密碼時，應要有複雜且強大的雜湊機制來加密儲存在密碼資料庫中的密碼。FreeBSD 支援 <acronym>DES</acronym>, <acronym>MD5</acronym>, <acronym>SHA256</acronym>, <acronym>SHA512</acronym> 以及 Blowfish 雜湊演算法於其 <function>crypt()</function> 程式庫。預設使用 <acronym>SHA512</acronym>，不建議改成更不安全的雜湊演算法，但可改成更安全的 Blowfish 演算法。</para>

      <note>
	<para>Blowfish 不是 <acronym>AES</acronym> 的一部份且不符合任何聯邦資訊處理標準 (Federal Information Processing Standards, <acronym>FIPS</acronym>)，在某些環境可能不會允許使用這種加密方式。</para>
      </note>

      <para>要知道目前用何種雜湊演算法來加密某位使用者密碼，超級使用者可以檢視在 FreeBSD 密碼資料庫中該使用者的雜湊，每個雜湊的一開始便會以符號標示其用來加密密碼所使用的雜湊機制。若使用 <acronym>DES</acronym> 則開始不會有任何符號，而 <acronym>MD5</acronym> 的符號則是 <literal>$</literal>，<acronym>SHA256</acronym> 及 <acronym>SHA512</acronym> 的符號是 <literal>$6$</literal>，Blowfish 的符號是 <literal>$2a$</literal>。在以下例子中 <systemitem class="username">dru</systemitem> 的密碼使以預設的 <acronym>SHA512</acronym> 演算法加密，因為其雜湊的開始為 <literal>$6$</literal>。注意，該加密過的雜湊，不是原來的密碼，會儲存於密碼資料庫中：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>grep dru /etc/master.passwd</userinput>
dru:$6$pzIjSvCAn.PBYQBA$PXpSeWPx3g5kscj3IMiM7tUEUSPmGexxta.8Lt9TGSi2lNQqYGKszsBPuGME0:1001:1001::0:0:dru:/usr/home/dru:/bin/csh</screen>

      <para>雜湊機制是設定在該使用者的登入類別 (Login class)，以此為例，該使用者屬於 <literal>default</literal> 登入類別，且雜湊演算法是以下行設定在 <filename>/etc/login.conf</filename>：</para>

      <programlisting xml:lang="en">        :passwd_format=sha512:\</programlisting>

      <para>要更改演算法為 Blowfish，可修改該行如下：</para>

      <programlisting xml:lang="en">        :passwd_format=blf:\</programlisting>

      <para>然後依 <xref linkend="users-limiting"/> 中所描述的方式執行 <command>cap_mkdb /etc/login.conf</command>。注意，這個動作不會影響任何已存在的密碼雜湊，但這代表必須要求所有使用者執行 <command>passwd</command> 來更改其密碼才有辦法重新加密所有密碼。</para>

      <para>針對遠端登入，應使用雙重認證 (Two-factor authentication)，舉例來說您同時要 <quote>有某樣東西</quote>，如：鑰匙，以及 <quote>知道某個資訊</quote>，如：密碼。自從 <application>OpenSSH</application> 是 FreeBSD 基礎系統的一部份，所有來算網路的登入應透過加密過的連線且使用以金鑰為基礎的認証來替代密碼。要了解更多資訊請參考 <xref linkend="openssh"/>。Kerberos 的使用者可能會需要多做一些額外的更改才能在其網路上使用 <application>OpenSSH</application>，這些更改在 <xref linkend="kerberos5"/> 中會有說明。</para>
    </sect2>

    <sect2 xml:id="security-pwpolicy">
      <title>強制密碼政策</title>

      <para>強制在本地帳號使用高強度密碼的政策是系統安全的基礎之一。在 FreeBSD 密碼長度、密碼強度以及密碼複雜性可使用內建的可插拔認証模組 (Pluggable Authentication Modules, <acronym>PAM</acronym>) 來執行。</para>

      <para>本節將示範如何設定密碼長度下限與上限以及使用 <filename>pam_passwdqc.so</filename> 來強制使用混合字元的密碼，此模組可在使用者更改其密碼時強制要求。</para>

      <para>要設定此模組，需要先成為超級使用者，然後取消註解在 <filename>/etc/pam.d/passwd</filename> 中含有 <literal>pam_passwdqc.so</literal> 的行。然後編輯該行來配合密碼政策：</para>

      <programlisting xml:lang="en">password        requisite       pam_passwdqc.so         <replaceable>min=disabled,disabled,disabled,12,10 similar=deny retry=3</replaceable> enforce=users</programlisting>

      <para>這個例子會設定新密碼所需符合的需求。<literal>min</literal> 設定可以控制密碼長度下限，它有五個值因為這個模組根據密碼的複雜度定義了五種類型。而複雜度是由必須在密碼中存在的字元類型來定義，例如：文字、數字、符號以及大小寫，這些密碼類型在 <citerefentry><refentrytitle>pam_passwdqc</refentrytitle><manvolnum>8</manvolnum></citerefentry> 有詳細的說明。在這個例子，密碼類型的前三項為關閉的，代表不會接受只滿足這些複雜度的密碼，不論長度為何。<literal>12</literal> 設定密碼政策可接受滿足三種字元類型複雜度且至少 12 個字元的密碼，<literal>10</literal> 設定密碼政策接受滿足四種字元類型複雜度且至少 10 個字元的密碼。</para>

      <para><literal>similar</literal> 設定則會拒絕以使用者前一次類似的密碼。<literal>retry</literal> 設定會提供使用者三次輸入新密碼的機會。</para>

      <para>一這個檔案儲存之後，更改密碼的使用者將會看到如下的訊息：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>passwd</userinput>
Changing local password for trhodes
Old Password:

You can now choose the new password.
A valid password should be a mix of upper and lower case letters,
digits and other characters.  You can use a 12 character long
password with characters from at least 3 of these 4 classes, or
a 10 character long password containing characters from all the
classes.  Characters that form a common pattern are discarded by
the check.
Alternatively, if no one else can see your terminal now, you can
pick this as your password: "trait-useful&amp;knob".
Enter new password:</screen>

      <para>若輸入了一個不符何密碼政策的密碼，則會被拒絕並顯示警告，然後使用者會有機會再重試，直到超過設定的允許重試次數。</para>

      <para>大多數密碼政策會讓密碼在多日過後過期。要在 FreeBSD 設定密碼年齡日期，可在 <filename>/etc/login.conf</filename> 中該使用者的登入類別設定 <option>passwordtime</option>。在 <literal>default</literal> 登入類別已有設定範例：</para>

      <programlisting xml:lang="en">#       :passwordtime=90d:\</programlisting>

      <para>因此，要設定此登入類別的密碼在 90 天之後過期只需要移除註解符號 (<literal>#</literal>)，然後儲存編輯結果並執行 <command>cap_mkdb /etc/login.conf</command>。</para>

      <para>要在個別使用者設定期限，可將有效日期或到期的天數與使用者名稱傳給 <command>pw</command>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pw usermod -p <replaceable>30-apr-2015</replaceable> -n <replaceable>trhodes</replaceable></userinput></screen>

      <para>如這個例子，有效日期的格式為天、月以及年。要取得更多資訊可參考 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</para>
    </sect2>

    <sect2 xml:id="security-rkhunter">
      <title>偵測 Root 工具 (Rootkit)</title>

      <para><firstterm>rootkit</firstterm> 指的是嘗試未經授權取得系統 <systemitem class="username">root</systemitem> 存取權的軟體。一旦安裝之後，這個惡意軟體將可以光明正大的開啟給另一個給攻擊者進入的大門。現實上，一但系統已被 rootkit 滲透且執行了搜索動作之後，該系統就應該從頭重新安裝，因為即使非常謹真的資安或系統工程式也可能會遺漏攻擊者留下的動西。</para>

      <para>rootkit 對管理者而言唯一有幫助的是：一但偵測到，便代表某處已經被滲透，但這類型的應用程式躲藏的非常好，本節將會示範一個可以用來偵測 rootkit 的工具，<package>security/rkhunter</package>。</para>

      <para>安裝此套件或 Port 之後，系統便可使用以下指令檢查。該指令提供許多資訊且會需要手動按下 <keycap>ENTER</keycap> 確認：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>rkhunter -c</userinput></screen>

      <para>該程序完成之後，目前狀態的訊息便會顯示在畫面上。這個訊息包含了已檢查過多少檔案、可疑的檔案、可能的 rootkit 以及其他更多資訊。在檢查的過程中，可能會產生一些有關隱藏檔案、<application>OpenSSH</application> 通訊協定選擇及已安裝軟體已知漏洞版本的通用的安全性警告、這些問題可以立即處理或在更詳細的分析之後再處理。</para>

      <para>每位管理者應了解在系統上執行了那些程式以及這些程式的用途。第三方工具如 <application>rkhunter</application> 與 <package>sysutils/lsof</package> 以及原生指令如 <command>netstat</command> 與 <command>ps</command> 可以系統上大量的資訊，記錄下那一些是正常的，當有不適當的程式出現時提出疑問，然後找出答案。雖然理想要避免滲透，但也必須偵測是否已被滲透了。</para>
    </sect2>

    <sect2 xml:id="security-ids">
      <title>Binary 檢驗</title>

      <para>檢驗系統檔案與 Binary 是很重要的，因為它可以提供系統管理者與資安團隊有關系統變更的資訊，能夠監視系統變更的軟體應用程式稱為入侵偵測系統 (Intrusion Detection System, <acronym>IDS</acronym>)。</para>

      <para>FreeBSD 原生提供了基礎的 <acronym>IDS</acronym> 系統，雖然每天晚上會有安全性的信件會通知管理者相關的變更，但這些資訊是儲存在本地的，這讓惡意的使用者有機會能夠修改這些資訊來隱藏其對系統的變更。也因此，會建議建立一個獨立的 Binary 簽名並將這些簽名儲存在唯度、root 擁有的目錄或在可移除的 <acronym>USB</acronym> 磁碟或遠端 <application>rsync</application> 伺服器更好。</para>

      <para>內建 <command>mtree</command> 工具可以對一個目錄中的內容產生一個規格檔，產生規格檔會用到一個種子碼 (Seed) 或常數，然後在檢查規格是否有更改過時會也會需要使用這個種子碼或常數。這讓檢查一個檔案或 Binary 是否被修改變成可能的一件事。由於攻擊者並不知道種子碼，要仿冒或檢查檔案的校驗碼 (Checksum) 數值是幾乎不可能的。以下例子會產生一組 <acronym>SHA256</acronym> 雜湊，每一個在 <filename>/bin</filename> 的系統  Binary 都會有一個，並姐會將這些值以隱藏黨儲存在 <systemitem class="username">root</systemitem> 的家目錄，<filename>/root/.bin_chksum_mtree</filename>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mtree -s <replaceable>3483151339707503</replaceable> -c -K cksum,sha256digest -p <replaceable>/bin</replaceable> &gt; <replaceable>/root/.bin_chksum_mtree</replaceable></userinput>
<prompt>#</prompt> mtree: /bin checksum: 3427012225</screen>

      <para><replaceable>3483151339707503</replaceable> 代表種子碼，這個值應要記錄下來且不可給其它人看。</para>

      <para>檢視 <filename>/root/.bin_cksum_mtree</filename> 應會產生類似以下的輸出結果：</para>

      <programlisting xml:lang="en">#          user: root
#       machine: dreadnaught
#          tree: /bin
#          date: Mon Feb  3 10:19:53 2014

# .
/set type=file uid=0 gid=0 mode=0555 nlink=1 flags=none
.               type=dir mode=0755 nlink=2 size=1024 \
                time=1380277977.000000000
    \133        nlink=2 size=11704 time=1380277977.000000000 \
                cksum=484492447 \
                sha256digest=6207490fbdb5ed1904441fbfa941279055c3e24d3a4049aeb45094596400662a
    cat         size=12096 time=1380277975.000000000 cksum=3909216944 \
                sha256digest=65ea347b9418760b247ab10244f47a7ca2a569c9836d77f074e7a306900c1e69
    chflags     size=8168 time=1380277975.000000000 cksum=3949425175 \
                sha256digest=c99eb6fc1c92cac335c08be004a0a5b4c24a0c0ef3712017b12c89a978b2dac3
    chio        size=18520 time=1380277975.000000000 cksum=2208263309 \
                sha256digest=ddf7c8cb92a58750a675328345560d8cc7fe14fb3ccd3690c34954cbe69fc964
    chmod       size=8640 time=1380277975.000000000 cksum=2214429708 \
                sha256digest=a435972263bf814ad8df082c0752aa2a7bdd8b74ff01431ccbd52ed1e490bbe7</programlisting>

      <para>機器的主機名稱、建立規格檔的日期與時間、以及建立此規格檔的使用者名稱皆會記錄在此報告當中，報告當中還會有在目錄中每個 Binary 的校驗碼、大小、時間以及 <acronym>SHA</acronym>256 編碼。</para>

      <para>要檢驗 Binary 簽名是否有被變更過，可使用先前產生的規格檔比對目前目錄的內容，然後儲存結果到檔案。這個指令需要當初產生原規格檔所使用的種子碼：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mtree -s <replaceable>3483151339707503</replaceable> -p <replaceable>/bin</replaceable> &lt; <replaceable>/root/.bin_chksum_mtree</replaceable> &gt;&gt; <replaceable>/root/.bin_chksum_output</replaceable></userinput>
<prompt>#</prompt> mtree: /bin checksum: 3427012225</screen>

      <para>這個動作應會產生與上次建立 <filename>/bin</filename> 規格檔時產生的校驗碼相同，若在此目錄的 Binary 沒有被變更過，那麼 <filename>/root/.bin_chksum_output</filename> 這個輸出檔將會是空的。要模擬變更，可以使用 <command>touch</command> 更改 <filename>/root/.bin_chksum_output</filename> 的日期然後再執行檢驗指令一次：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>touch /bin/cat</userinput>
<prompt>#</prompt> <userinput>mtree -s <replaceable>3483151339707503</replaceable> -p <replaceable>/bin</replaceable> &lt; <replaceable>/root/.bin_chksum_mtree</replaceable> &gt;&gt; <replaceable>/root/.bin_chksum_output</replaceable></userinput>
<prompt>#</prompt> <userinput>more /root/.bin_chksum_output</userinput>
cat changed
	modification time expected Fri Sep 27 06:32:55 2013 found Mon Feb  3 10:28:43 2014</screen>

      <para>建議對含有 Binary 以及設定檔的目錄建立規格檔，對含有敏感資料的目錄也是。通常會為 <filename>/bin</filename>, <filename>/sbin</filename>, <filename>/usr/bin</filename>, <filename>/usr/sbin</filename>, <filename>/usr/local/bin</filename>, <filename>/etc</filename> 及 <filename>/usr/local/etc</filename> 建立規格檔。</para>

      <para>也有更進階的 <acronym>IDS</acronym> 系統，例如 <package>security/aide</package>。大多數情況 <command>mtree</command> 已可提供管理者所需的功能。將種子碼與校驗碼結果保存在惡意使用者無法存取的地方是非常重要的一件事。更多有關 <command>mtree</command> 的資訊可在 <citerefentry><refentrytitle>mtree</refentrytitle><manvolnum>8</manvolnum></citerefentry> 找到。</para>
    </sect2>

    <sect2 xml:id="security-tuning">
      <title>系統安全性調校</title>

      <para>在 FreeBSD，有許多系統功能可以使用 <command>sysctl</command> 調校，本節會涵蓋少數可以調校來避免阻斷服務 (Denial of Service, <acronym>DoS</acronym>) 攻擊的安全性功能。更多有關使用 <command>sysctl</command> 的資訊包含：如何暫時更改數值及如何在測試之後做永久更改可在 <xref linkend="configtuning-sysctl"/> 找到。</para>

      <note>
	<para>任何時間使用 <xref linkend="configtuning-sysctl"/> 做的設定變更都會讓造成不想要的傷害的可能性上升，影響到系統的可用性。因此應要對所有的變更做監視，若可能的話，先在測試系統上實驗，再到上線的系統上使用。</para>
      </note>

      <para>預設 FreeBSD 核心會使用安全性層級 <literal>-1</literal> 來開機，這又稱作<quote>不安全模式</quote>，因為不可變 (Immutable) 檔案旗標可以被關閉且可以讀取或寫入所有的裝置。除非有使用 <command>sysctl</command> 或在啟動 Script 設定修改該值，否則安全性層級將會在 <literal>-1</literal>。安全性層級可以在系統啟動時透過在 <filename>/etc/rc.conf</filename> 設定 <varname>kern_securelevel_enable</varname> 為 <literal>YES</literal> 以及 設定 <varname>kern_securelevel</varname> 的值為想要的安全層級來提升。請參考 <citerefentry><refentrytitle>security</refentrytitle><manvolnum>7</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>init</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以取得更多與這些設定及可用的安全性層級相關的資訊。</para>

      <warning>
	<para>提高 <varname>securelevel</varname> 會導致 <application>Xorg</application> 無法執行以及造成其他問題，請做好除錯的準備。</para>
      </warning>

      <para><varname>net.inet.tcp.blackhole</varname> 以及 <varname>net.inet.udp.blackhole</varname> 設定可以用來丟棄在已關閉連接埠 (Port) 收到的 <acronym>SYN</acronym> 封包且不會回傳 <acronym>RST</acronym> 回應，預設的動作是會回傳 <acronym>RST</acronym> 來表示該連接埠已被關閉，更改預設的動作可對連接埠掃描 (用在查看在系統上執行的應用程式) 提供一定程度的保護，要這麼做可設定 <varname>net.inet.tcp.blackhole</varname> 為 <literal>2</literal> 及 <varname>net.inet.udp.blackhole</varname> 為 <literal>1</literal>。請參考 <citerefentry><refentrytitle>blackhole</refentrytitle><manvolnum>4</manvolnum></citerefentry> 以取得更多有關這些設定的資訊。</para>

      <para><varname>net.inet.icmp.drop_redirect</varname> 以及 <varname>net.inet.ip.redirect</varname> 設定可以幫助避免 <firstterm>重新導向攻擊 (Redirect attacks)</firstterm>，重新導向攻擊是 <acronym>DoS</acronym> 的一種，會傳送大量 <acronym>ICMP</acronym> 類型 5 的封包，由於這些封包並不是必要的，設定 <varname>net.inet.icmp.drop_redirect</varname> 為 <literal>1</literal> 以及設定 <varname>net.inet.ip.redirect</varname> 為 <literal>0</literal> 可丟棄這些封包。</para>

      <para>來源路由 (Source routing) 是一種偵測與存取在內部網路中不可路由位址的方法，由於不可路由位址通常是固故讓它不可路由的，因此可以關閉這個功能。要關閉這個功能可設定 <varname>net.inet.ip.sourceroute</varname> 以及 <varname>net.inet.ip.accept_sourceroute</varname> 為 <literal>0</literal>。</para>

      <para>當一台在網路上的機器需要傳送訊息給所有在子網路上的主機時，會發送 <acronym>ICMP</acronym> 回應請求訊息到廣播位址。然而，外部的主機是沒有理由可以執行這個動作的。要拒絕所有來自外部的廣播請求可設定 <varname>net.inet.icmp.bmcastecho</varname> 為 <literal>0</literal>。</para>

      <para>還有一些額外的設定在 <citerefentry><refentrytitle>security</refentrytitle><manvolnum>7</manvolnum></citerefentry> 有說明。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="one-time-passwords">
    <title>一次性密碼</title>

    <indexterm xml:lang="en"><primary>one-time passwords</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>security</primary>
      <secondary>one-time passwords</secondary>
    </indexterm>

    <para>預設 FreeBSD 已內建一次性密碼 (One-time Passwords In Everything, <acronym>OPIE</acronym>)。<acronym>OPIE</acronym> 設計用來避免重送攻擊 (Replay attack)，重送攻擊指的是攻擊者發現了某位使用者的密碼，然後使用該密碼來存取系統。由於在 <acronym>OPIE</acronym> 的環境下，一組密碼只能被使用一次，被發現的密碼對攻擊者而言便沒有什麼作用。<acronym>OPIE</acronym> 使用了安全的加密方式與詰問/回應系統 (Challenge/response system) 來管理密碼。FreeBSD 在實作上預設採用 <acronym>MD5</acronym> 加密。</para>

    <para><acronym>OPIE</acronym> 使用了三種不同類型的密碼，第一種是一般的 <trademark class="registered">UNIX</trademark> 或 Kerberos 密碼，第二種是由 <command>opiekey</command> 所產生的一次性密碼，第三種是用來生一次性密碼的 <quote>秘密密碼 (Secret password)</quote>，秘密密碼與 <trademark class="registered">UNIX</trademark> 密碼無關且不應相同。</para>

    <para>對 <acronym>OPIE</acronym> 來說還有另外兩個部份的資料很重要。其中一個是<quote>種子碼 (Seed)</quote> 或稱<quote>金鑰 (Key)</quote>，由兩個字母與五個數字組成。另一個則是<quote>疊代次數 (Iteration count)</quote>，是一個介於 1 到 100 間的數字。<acronym>OPIE</acronym> 會將種子碼與秘密密碼串連後，套用 <acronym>MD5</acronym> 加密數次後 (根據疊代次數)，再將結果轉換成六個簡短的英文單字來產生一次性密碼。認証系統會持續追蹤最後使用的一次性密碼，若使用者提供的密碼加密後與前一次的密碼相同則可通過認証。由於採用了單向的加密方式，若使用過的密碼被成功擷取也無法拿來產生之後的一次性密碼。疊代次數會在每一次登入成功之後減少，來保持使用者與登入程式間的同步。當疊代次數減少至 <literal>1</literal> 時，<acronym>OPIE</acronym> 便要重新初始化。</para>

    <para>這個整個程序會牽涉到幾個程式。傳送疊代次數、種子碼與秘密密碼來產生一組一次性密碼或數個一次性密碼的 <citerefentry><refentrytitle>opiekey</refentrytitle><manvolnum>1</manvolnum></citerefentry>。除了初始化 <acronym>OPIE</acronym> 之外，用來更改密碼、疊代次數或種子碼的 <citerefentry><refentrytitle>opiepasswd</refentrytitle><manvolnum>1</manvolnum></citerefentry>。會讀取放在 <filename>/etc/opiekeys</filename> 的相關憑証檔來列出使用者目前的疊代次數與種子碼的 <citerefentry><refentrytitle>opieinfo</refentrytitle><manvolnum>1</manvolnum></citerefentry>。</para>

    <para>本章節將介紹四種不同的操作，第一是如何在安全連線下做第一次的一次性密碼設定，第二是如何使用在不安全的連線下使用 <command>opiepasswd</command>，第三是如何在不安全的連線下登入系統，第四是如何產生數個可以被記錄或列印下來在不安全的場所使的金鑰。</para>

    <sect2>
      <title>初始化 <acronym>OPIE</acronym></title>

      <para>第一次要初始化 <acronym>OPIE</acronym>，要在安全的場所執行以下指令：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>opiepasswd -c</userinput>
Adding unfurl:
Only use this method from the console; NEVER from remote. If you are using
telnet, xterm, or a dial-in, type ^C now or exit with no password.
Then run opiepasswd without the -c parameter.
Using MD5 to compute responses.
Enter new secret pass phrase:
Again new secret pass phrase:

ID unfurl OTP key is 499 to4268
MOS MALL GOAT ARM AVID COED</screen>

      <para><option>-c</option> 會設定採用假設指令在安全場所執行的 Console 模式，如在使用者掌控之中的電腦或者透過 <acronym>SSH</acronym> 連線到一台在使用者掌控之中的電腦。</para>

      <para>提示出現後，輸入用來產生一次性登入金鑰的秘密密碼，應使用一個不容易被猜出來的密碼，且應與使用者登入帳號所使用的密碼不同，密碼必須介於 10 到 127 個字元長度之間，然後請記住這個密碼。</para>

      <para><literal>ID</literal> 行會列出登入名稱 (<literal>unfurl</literal>)、預設的疊代次數 (<literal>499</literal>) 以及預設的種子碼 (<literal>to4268</literal>)。在進行登入時，系統會記住這些參數並且顯示出來，這也代表不需要另外記錄這些資訊。最後一行會列出根據這些參數與秘密密碼所產生出來的一次性密碼，在下一次登入時便要使用這個一次性密碼。</para>
    </sect2>

    <sect2>
      <title>在不安全連線下做初始化</title>

      <para>要在不安全的系統上初始化或更改秘密密碼會需要某個可使用安全的連線的地方執行 <command>opiekey</command>，這可能是在某一台信任的主機上的 Shell。初始化需要設定疊代次數，100 可能是不錯的數字，種子碼可以自行指定或隨機產生，在不安全連線下要被初始化主機須使用 <citerefentry><refentrytitle>opiepasswd</refentrytitle><manvolnum>1</manvolnum></citerefentry>：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>opiepasswd</userinput>

Updating unfurl:
You need the response from an OTP generator.
Old secret pass phrase:
	otp-md5 498 to4268 ext
	Response: GAME GAG WELT OUT DOWN CHAT
New secret pass phrase:
	otp-md5 499 to4269
	Response: LINE PAP MILK NELL BUOY TROY

ID mark OTP key is 499 gr4269
LINE PAP MILK NELL BUOY TROY</screen>

      <para>要採用預設的種子碼，可直接按下 <keycap>Return</keycap> 做初始化。接著在輸入回應之前移到安全的連線然後給予相同的加密參數產生密碼：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>opiekey 498 to4268</userinput>
Using the MD5 algorithm to compute response.
Reminder: Do not use opiekey from telnet or dial-in sessions.
Enter secret pass phrase:
GAME GAG WELT OUT DOWN CHAT</screen>

      <para>切換回不安全的連線，然後複製產生的一次性密碼貼上。</para>
    </sect2>

    <sect2>
      <title>產生單組一次性密碼</title>

      <para>在初始化 <acronym>OPIE</acronym> 之後進行登入會顯示如下的提示訊息：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>telnet example.com</userinput>
Trying 10.0.0.1...
Connected to example.com
Escape character is '^]'.

FreeBSD/i386 (example.com) (ttypa)

login: <userinput>&lt;username&gt;</userinput>
otp-md5 498 gr4269 ext
Password: </screen>

      <para><acronym>OPIE</acronym> 的提示提供了一個很有用的功能，若在密碼提示時按下 <keycap>Return</keycap>，便會開啟回應功能並顯示輸入的內容，這個功能在嘗試手工輸入列印出來的密碼時很有用。</para>

      <indexterm xml:lang="en"><primary>MS-DOS</primary></indexterm>
      <indexterm xml:lang="en"><primary>Windows</primary></indexterm>
      <indexterm xml:lang="en"><primary>MacOS</primary></indexterm>

      <para>此時，要產生一次性密碼來回應登入時的提示，這必須在受信任且可安全執行 <citerefentry><refentrytitle>opiekey</refentrytitle><manvolnum>1</manvolnum></citerefentry> 的系統上完成。這個指令有提供 <trademark class="registered">Windows</trademark>, <trademark class="registered">Mac OS</trademark> 與 FreeBSD 版本，使用時需要疊代次數與種子碼做為在指令列的參數，剪下在要登入主機在登入時所提示的訊息。</para>

      <para>在信任的系統上執行：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>opiekey 498 to4268</userinput>
Using the MD5 algorithm to compute response.
Reminder: Do not use opiekey from telnet or dial-in sessions.
Enter secret pass phrase:
GAME GAG WELT OUT DOWN CHAT</screen>

      <para>在產生一次性密碼後，回到登入畫面繼續登入。</para>
    </sect2>

    <sect2>
      <title>產生多組一次性密碼</title>

      <para>有時會無法存取信任的主機或沒有安全的連線，在這種情況下，可以使用 <citerefentry><refentrytitle>opiekey</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來預先產生多個一次性密碼，例如：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>opiekey -n 5 30 zz99999</userinput>
Using the MD5 algorithm to compute response.
Reminder: Do not use opiekey from telnet or dial-in sessions.
Enter secret pass phrase: <userinput>&lt;secret password&gt;</userinput>
26: JOAN BORE FOSS DES NAY QUIT
27: LATE BIAS SLAY FOLK MUCH TRIG
28: SALT TIN ANTI LOON NEAL USE
29: RIO ODIN GO BYE FURY TIC
30: GREW JIVE SAN GIRD BOIL PHI</screen>

      <para><option>-n 5</option> 會請求產生連續五個金鑰，而 <option>30</option> 則是指定最後一個疊代的編號。注意這些列印出的結果的順序與使用的順序<emphasis>相反</emphasis>。十足的偏執狂可能會想要用手寫下結果，否則就列印出清單。每一行會同時顯示疊代次數及一次性密碼，在密碼使用過後便可劃掉。</para>
    </sect2>

    <sect2>
      <title>限制使用 <trademark class="registered">UNIX</trademark> 密碼</title>

      <para><acronym>OPIE</acronym> 可以根據登入階段的 IP 位置限制使用 <trademark class="registered">UNIX</trademark> 密碼，相關的檔案為 <filename>/etc/opieaccess</filename>，這個檔案預設便存在。請參考 <citerefentry><refentrytitle>opieaccess</refentrytitle><manvolnum>5</manvolnum></citerefentry> 來取得更多有關此檔案的資訊以及當使用時要考量的安全性問題。</para>

      <para>這裡有一個範本 <filename>opieaccess</filename>：</para>

      <programlisting xml:lang="en">permit 192.168.0.0 255.255.0.0</programlisting>

      <para>這一行允許來源 IP 位址 (容易受到詐騙的位址) 符合指定值與遮罩的使用者在任何時間可使用 <trademark class="registered">UNIX</trademark> 密碼登入。</para>

      <para>若在 <filename>opieaccess</filename> 中沒有符合的規則，預設會拒絕非 <acronym>OPIE</acronym> 的登入。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="tcpwrappers">
    <info>
      <title xml:lang="en">TCP Wrapper</title>

      <authorgroup>
	<author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Written
	  by </contrib></author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en"><primary>TCP Wrapper</primary></indexterm>

    <para xml:lang="en"><application>TCP Wrapper</application> is a host-based
      access control system which extends the abilities of <xref linkend="network-inetd"/>.  It can be configured to provide
      logging support, return messages, and connection restrictions
      for the server daemons under the control of
      <application>inetd</application>.  Refer to <citerefentry><refentrytitle>tcpd</refentrytitle><manvolnum>8</manvolnum></citerefentry> for
      more information about
      <application>TCP Wrapper</application> and its features.</para>

    <para xml:lang="en"><application>TCP Wrapper</application> should not be
      considered a replacement for a properly configured firewall.
      Instead, <application>TCP Wrapper</application> should be used
      in conjunction with a firewall and other security enhancements
      in order to provide another layer of protection in the
      implementation of a security policy.</para>

    <sect2>
      <title>初始設定</title>

      <para xml:lang="en">To enable <application>TCP Wrapper</application> in FreeBSD,
	add the following lines to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">inetd_enable="YES"
inetd_flags="-Ww"</programlisting>

      <para xml:lang="en">Then, properly configure
	<filename>/etc/hosts.allow</filename>.</para>

      <note>
	<para xml:lang="en">Unlike other implementations of
	  <application>TCP Wrapper</application>, the use of
	  <filename>hosts.deny</filename> is deprecated in FreeBSD.  All
	  configuration options should be placed in
	  <filename>/etc/hosts.allow</filename>.</para>
      </note>

      <para xml:lang="en">In the simplest configuration, daemon connection policies
	are set to either permit or block, depending on the options in
	<filename>/etc/hosts.allow</filename>.  The default
	configuration in FreeBSD is to allow all connections to the
	daemons started with <application>inetd</application>.</para>

      <para xml:lang="en">Basic configuration usually takes the form of
	<literal>daemon : address : action</literal>, where
	<literal>daemon</literal> is the daemon which
	<application>inetd</application> started,
	<literal>address</literal> is a valid hostname,
	<acronym>IP</acronym> address, or an IPv6 address enclosed in
	brackets ([ ]), and <literal>action</literal> is either
	<literal>allow</literal> or <literal>deny</literal>.
	<application>TCP Wrapper</application> uses a first rule match
	semantic, meaning that the configuration file is scanned from
	the beginning for a matching rule.  When a match is found, the
	rule is applied and the search process stops.</para>

      <para xml:lang="en">For example, to allow <acronym>POP</acronym>3 connections
	via the <package>mail/qpopper</package> daemon, the following
	lines should be appended to
	<filename>hosts.allow</filename>:</para>

      <programlisting xml:lang="en"># This line is required for POP3 connections:
qpopper : ALL : allow</programlisting>

      <para xml:lang="en">Whenever this file is edited, restart
	<application>inetd</application>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service inetd restart</userinput></screen>
    </sect2>

    <sect2>
      <title>進階設定</title>

      <para xml:lang="en"><application>TCP Wrapper</application> provides advanced
	options to allow more control over the way connections are
	handled.  In some cases, it may be appropriate to return a
	comment to certain hosts or daemon connections.  In other
	cases, a log entry should be recorded or an email sent to the
	administrator.  Other situations may require the use of a
	service for local connections only.  This is all possible
	through the use of configuration options known as wildcards,
	expansion characters, and external command execution.</para>

      <para xml:lang="en">Suppose that a situation occurs where a connection should
	be denied yet a reason should be sent to the host who
	attempted to establish that connection.  That action is
	possible with <option>twist</option>.  When a connection
	attempt is made, <option>twist</option> executes a shell
	command or script.  An example exists in
	<filename>hosts.allow</filename>:</para>

      <programlisting xml:lang="en"># The rest of the daemons are protected.
ALL : ALL \
	: severity auth.info \
	: twist /bin/echo "You are not welcome to use %d from %h."</programlisting>

      <para xml:lang="en">In this example, the message <quote>You are not allowed to
	  use <replaceable>daemon name</replaceable> from
	  <replaceable>hostname</replaceable>.</quote> will be
	returned for any daemon not configured in
	<filename>hosts.allow</filename>.  This is useful for sending
	a reply back to the connection initiator right after the
	established connection is dropped.  Any message returned
	<emphasis>must</emphasis> be wrapped in quote
	(<literal>"</literal>) characters.</para>

      <warning>
	<para xml:lang="en">It may be possible to launch a denial of service attack
	  on the server if an attacker floods these daemons with
	  connection requests.</para>
      </warning>

      <para xml:lang="en">Another possibility is to use <option>spawn</option>.
	Like <option>twist</option>, <option>spawn</option> implicitly
	denies the connection and may be used to run external shell
	commands or scripts.  Unlike <option>twist</option>,
	<option>spawn</option> will not send a reply back to the host
	who established the connection.  For example, consider the
	following configuration:</para>

      <programlisting xml:lang="en"># We do not allow connections from example.com:
ALL : .example.com \
	: spawn (/bin/echo %a from %h attempted to access %d &gt;&gt; \
	  /var/log/connections.log) \
	: deny</programlisting>

      <para xml:lang="en">This will deny all connection attempts from <systemitem class="fqdomainname">*.example.com</systemitem> and log the
	hostname, <acronym>IP</acronym> address, and the daemon to
	which access was attempted to
	<filename>/var/log/connections.log</filename>.  This example
	uses the substitution characters <literal>%a</literal> and
	<literal>%h</literal>.  Refer to <citerefentry><refentrytitle>hosts_access</refentrytitle><manvolnum>5</manvolnum></citerefentry> for the
	complete list.</para>

      <para xml:lang="en">To match every instance of a daemon, domain, or
	<acronym>IP</acronym> address, use <literal>ALL</literal>.
	Another wildcard is <literal>PARANOID</literal> which may be
	used to match any host which provides an <acronym>IP</acronym>
	address that may be forged because the <acronym>IP</acronym>
	address differs from its resolved hostname.  In this example,
	all connection requests to <application>Sendmail</application>
	which have an <acronym>IP</acronym> address that varies from
	its hostname will be denied:</para>

      <programlisting xml:lang="en"># Block possibly spoofed requests to sendmail:
sendmail : PARANOID : deny</programlisting>

      <caution>
	<para xml:lang="en">Using the <literal>PARANOID</literal> wildcard will
	  result in denied connections if the client or server has a
	  broken <acronym>DNS</acronym> setup.</para>
      </caution>

      <para xml:lang="en">To learn more about wildcards and their associated
	functionality, refer to <citerefentry><refentrytitle>hosts_access</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

      <note>
	<para xml:lang="en">When adding new configuration lines, make sure that any
	  unneeded entries for that daemon are commented out in
	  <filename>hosts.allow</filename>.</para>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="kerberos5">
    <info>
      <title xml:lang="en"><application>Kerberos</application></title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tillman</firstname>
	    <surname>Hodgson</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Mark</firstname>
	    <surname>Murray</surname>
	  </personname>
	  <contrib>Based on a contribution by </contrib>
	</author>
      </authorgroup>
    </info>

    <para xml:lang="en"><application>Kerberos</application> is a network
      authentication protocol which was originally created by the
      Massachusetts Institute of Technology (<acronym>MIT</acronym>)
      as a way to securely provide authentication across a potentially
      hostile network.  The <application>Kerberos</application>
      protocol uses strong cryptography so that both a client and
      server can prove their identity without sending any unencrypted
      secrets over the network.  <application>Kerberos</application>
      can be described as an identity-verifying proxy system and as a
      trusted third-party authentication system.  After a user
      authenticates with <application>Kerberos</application>, their
      communications can be encrypted to assure privacy and data
      integrity.</para>

    <para xml:lang="en">The only function of <application>Kerberos</application> is
      to provide the secure authentication of users and servers on the
      network.  It does not provide authorization or auditing
      functions.  It is recommended that
      <application>Kerberos</application> be used with other security
      methods which provide authorization and audit services.</para>

    <para xml:lang="en">The current version of the protocol is version 5, described
      in <acronym>RFC</acronym> 4120.  Several free
      implementations of this protocol are available, covering a wide
      range of operating systems.  <acronym>MIT</acronym> continues to
      develop their <application>Kerberos</application> package.  It
      is commonly used in the <acronym>US</acronym> as a cryptography
      product, and has historically been subject to
      <acronym>US</acronym> export regulations.  In FreeBSD,
      <acronym>MIT</acronym> <application>Kerberos</application> is
      available as the <package>security/krb5</package> package or
      port.  The Heimdal <application>Kerberos</application>
      implementation was explicitly developed outside of the
      <acronym>US</acronym> to avoid export regulations.  The Heimdal
      <application>Kerberos</application> distribution is included in
      the base FreeBSD installation, and another distribution with more
      configurable options is available as
      <package>security/heimdal</package> in the Ports
      Collection.</para>

    <para xml:lang="en">In <application>Kerberos</application> users and services
      are identified as <quote>principals</quote> which are contained
      within an administrative grouping, called a
      <quote>realm</quote>.  A typical user principal would be of the
      form
      <literal><replaceable>user</replaceable>@<replaceable>REALM</replaceable></literal>
      (realms are traditionally uppercase).</para>

    <para xml:lang="en">This section provides a guide on how to set up
      <application>Kerberos</application> using the Heimdal
      distribution included in FreeBSD.</para>

    <para xml:lang="en">For purposes of demonstrating a
      <application>Kerberos</application> installation, the name
      spaces will be as follows:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">The <acronym>DNS</acronym> domain (zone) will be
	  <systemitem class="fqdomainname">example.org</systemitem>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The <application>Kerberos</application> realm will be
	  <literal>EXAMPLE.ORG</literal>.</para>
      </listitem>
    </itemizedlist>

    <note>
      <para xml:lang="en">Use real domain names when setting up
	<application>Kerberos</application>, even if it will run
	internally.  This avoids <acronym>DNS</acronym> problems and
	assures inter-operation with other
	<application>Kerberos</application> realms.</para>
    </note>

    <sect2>
      <title>設定 Heimdal <acronym>KDC</acronym></title>

      <indexterm xml:lang="en">
	<primary>Kerberos5</primary>
	<secondary>Key Distribution Center</secondary>
      </indexterm>

      <para xml:lang="en">The Key Distribution Center (<acronym>KDC</acronym>) is
	the centralized authentication service that
	<application>Kerberos</application> provides, the
	<quote>trusted third party</quote> of the system.  It is the
	computer that issues <application>Kerberos</application>
	tickets, which are used for clients to authenticate to
	servers.  Because the <acronym>KDC</acronym> is considered
	trusted by all other computers in the
	<application>Kerberos</application> realm, it has heightened
	security concerns.  Direct access to the KDC should be
	limited.</para>

      <para xml:lang="en">While running a <acronym>KDC</acronym> requires few
	computing resources, a dedicated machine acting only as a
	<acronym>KDC</acronym> is recommended for security
	reasons.</para>

      <para xml:lang="en">To begin setting up a <acronym>KDC</acronym>, add these
	lines to <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">kdc_enable="YES"
kadmind_enable="YES"</programlisting>

      <para xml:lang="en">Next, edit <filename>/etc/krb5.conf</filename> as
	follows:</para>

      <programlisting xml:lang="en">[libdefaults]
    default_realm = <replaceable>EXAMPLE.ORG</replaceable>
[realms]
    <replaceable>EXAMPLE.ORG</replaceable> = {
	kdc = <replaceable>kerberos.example.org</replaceable>
	admin_server = <replaceable>kerberos.example.org</replaceable>
    }
[domain_realm]
    <replaceable>.example.org</replaceable> = <replaceable>EXAMPLE.ORG</replaceable></programlisting>

      <para xml:lang="en">In this example, the <acronym>KDC</acronym> will use the
	fully-qualified hostname <systemitem class="fqdomainname">kerberos.example.org</systemitem>.  The
	hostname of the KDC must be resolvable in the
	<acronym>DNS</acronym>.</para>

      <para xml:lang="en"><application>Kerberos</application> can also use the
	<acronym>DNS</acronym> to locate KDCs, instead of a
	<literal>[realms]</literal> section in
	<filename>/etc/krb5.conf</filename>.  For large organizations
	that have their own <acronym>DNS</acronym> servers, the above
	example could be trimmed to:</para>

      <programlisting xml:lang="en">[libdefaults]
      default_realm = <replaceable>EXAMPLE.ORG</replaceable>
[domain_realm]
    <replaceable>.example.org</replaceable> = <replaceable>EXAMPLE.ORG</replaceable></programlisting>

      <para xml:lang="en">With the following lines being included in the
	<systemitem class="fqdomainname">example.org</systemitem> zone
	file:</para>

      <programlisting xml:lang="en">_kerberos._udp      IN  SRV     01 00 88 <replaceable>kerberos.example.org</replaceable>.
_kerberos._tcp      IN  SRV     01 00 88 <replaceable>kerberos.example.org</replaceable>.
_kpasswd._udp       IN  SRV     01 00 464 <replaceable>kerberos.example.org</replaceable>.
_kerberos-adm._tcp  IN  SRV     01 00 749 <replaceable>kerberos.example.org</replaceable>.
_kerberos           IN  TXT     <replaceable>EXAMPLE.ORG</replaceable></programlisting>

      <note>
	<para xml:lang="en">In order for clients to be able to find the
	  <application>Kerberos</application> services, they
	  <emphasis>must</emphasis> have either
	  a fully configured <filename>/etc/krb5.conf</filename> or a
	  minimally configured <filename>/etc/krb5.conf</filename>
	  <emphasis>and</emphasis> a properly configured
	  <acronym>DNS</acronym> server.</para>
      </note>

      <para xml:lang="en">Next, create the <application>Kerberos</application>
	database which contains the keys of all principals (users and
	hosts) encrypted with a master password.  It is not required
	to remember this password as it will be stored in
	<filename>/var/heimdal/m-key</filename>; it would be
	reasonable to use a 45-character random password for this
	purpose.  To create the master key, run
	<command>kstash</command> and enter a password:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kstash</userinput>
Master key: <userinput><replaceable>xxxxxxxxxxxxxxxxxxxxxxx</replaceable></userinput>
Verifying password - Master key: <userinput><replaceable>xxxxxxxxxxxxxxxxxxxxxxx</replaceable></userinput></screen>

      <para xml:lang="en">Once the master key has been created, the database should
	be initialized.  The <application>Kerberos</application>
	administrative tool <citerefentry><refentrytitle>kadmin</refentrytitle><manvolnum>8</manvolnum></citerefentry> can be used on the KDC in a
	mode that operates directly on the database, without using the
	<citerefentry><refentrytitle>kadmind</refentrytitle><manvolnum>8</manvolnum></citerefentry> network service, as
	<command>kadmin -l</command>.  This resolves the
	chicken-and-egg problem of trying to connect to the database
	before it is created.  At the <command>kadmin</command>
	prompt, use <command>init</command> to create the realm's
	initial database:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kadmin -l</userinput>
kadmin&gt; <userinput>init <replaceable>EXAMPLE.ORG</replaceable></userinput>
Realm max ticket life [unlimited]:</screen>

      <para xml:lang="en">Lastly, while still in <command>kadmin</command>, create
	the first principal using <command>add</command>.  Stick to
	the default options for the principal for now, as these can be
	changed later with <command>modify</command>.  Type
	<literal>?</literal> at the prompt to see the available
	options.</para>

      <screen xml:lang="en">kadmin&gt; <userinput>add <replaceable>tillman</replaceable></userinput>
Max ticket life [unlimited]:
Max renewable life [unlimited]:
Attributes []:
Password: <userinput><replaceable>xxxxxxxx</replaceable></userinput>
Verifying password - Password: <userinput><replaceable>xxxxxxxx</replaceable></userinput></screen>

      <para xml:lang="en">Next, start the <acronym>KDC</acronym> services by running
	<command>service kdc start</command> and
	<command>service kadmind start</command>.  While there will
	not be any kerberized daemons running at this point, it is
	possible to confirm that the <acronym>KDC</acronym> is
	functioning by obtaining a ticket for the
	principal that was just created:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>kinit <replaceable>tillman</replaceable></userinput>
tillman@EXAMPLE.ORG's Password:</screen>

      <para xml:lang="en">Confirm that a ticket was successfully obtained using
	<command>klist</command>:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>klist</userinput>
Credentials cache: FILE:/tmp/krb5cc_1001
	Principal: tillman@EXAMPLE.ORG

  Issued                Expires               Principal
Aug 27 15:37:58 2013  Aug 28 01:37:58 2013  krbtgt/EXAMPLE.ORG@EXAMPLE.ORG</screen>

      <para xml:lang="en">The temporary ticket can be destroyed when the test is
	finished:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>kdestroy</userinput></screen>
    </sect2>

    <sect2>
      <title>設定伺服器使用 <application>Kerberos</application></title>

      <indexterm xml:lang="en">
	<primary>Kerberos5</primary>
	<secondary>enabling services</secondary>
      </indexterm>

      <para xml:lang="en">The first step in configuring a server to use
	<application>Kerberos</application> authentication is to
	ensure that it has the correct configuration in
	<filename>/etc/krb5.conf</filename>.  The version from the
	<acronym>KDC</acronym> can be used as-is, or it can be
	regenerated on the new system.</para>

      <para xml:lang="en">Next, create <filename>/etc/krb5.keytab</filename> on the
	server.  This is the main part of <quote>Kerberizing</quote> a
	service — it corresponds to generating a secret shared
	between the service and the <acronym>KDC</acronym>.  The
	secret is a cryptographic key, stored in a
	<quote>keytab</quote>.  The keytab contains the server's host
	key, which allows it and the <acronym>KDC</acronym> to verify
	each others' identity.  It must be transmitted to the server
	in a secure fashion, as the security of the server can be
	broken if the key is made public.  Typically, the
	<filename>keytab</filename> is generated on an administrator's
	trusted machine using <command>kadmin</command>, then securely
	transferred to the server, e.g., with <citerefentry><refentrytitle>scp</refentrytitle><manvolnum>1</manvolnum></citerefentry>; it can also
	be created directly on the server if that is consistent with
	the desired security policy.  It is very important that the
	keytab is transmitted to the server in a secure fashion: if
	the key is known by some other party, that party can
	impersonate any user to the server!  Using
	<command>kadmin</command> on the server directly is
	convenient, because the entry for the host principal in the
	<acronym>KDC</acronym> database is also created using
	<command>kadmin</command>.</para>

      <para xml:lang="en">Of course, <command>kadmin</command> is a kerberized
	service; a <application>Kerberos</application> ticket is
	needed to authenticate to the network service, but to ensure
	that the user running <command>kadmin</command> is actually
	present (and their session has not been hijacked),
	<command>kadmin</command> will prompt for the password to get
	a fresh ticket.  The principal authenticating to the kadmin
	service must be permitted to use the <command>kadmin</command>
	interface, as specified in <filename>kadmind.acl</filename>.
	See the section titled <quote>Remote administration</quote> in
	<command>info heimdal</command> for details on designing
	access control lists.  Instead of enabling remote
	<command>kadmin</command> access, the administrator could
	securely connect to the <acronym>KDC</acronym> via the local
	console or <citerefentry><refentrytitle>ssh</refentrytitle><manvolnum>1</manvolnum></citerefentry>, and perform administration locally
	using <command>kadmin -l</command>.</para>

      <para xml:lang="en">After installing <filename>/etc/krb5.conf</filename>,
	use <command>add --random-key</command> in
	<command>kadmin</command>.  This adds the server's host
	principal to the database, but does not extract a copy of the
	host principal key to a keytab.  To generate the keytab, use
	<command>ext</command> to extract the server's host principal
	key to its own keytab:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kadmin</userinput>
kadmin&gt;<userinput> add --random-key host/myserver.example.org</userinput>
Max ticket life [unlimited]:
Max renewable life [unlimited]:
Principal expiration time [never]:
Password expiration time [never]:
Attributes []:
kadmin&gt;<userinput> ext_keytab <replaceable>host/myserver.example.org</replaceable></userinput>
kadmin&gt;<userinput> exit</userinput></screen>

      <para xml:lang="en">Note that <command>ext_keytab</command> stores the
	extracted key in <filename>/etc/krb5.keytab</filename> by
	default.  This is good when being run on the server being
	kerberized, but the <command>--keytab
	  <replaceable>path/to/file</replaceable></command> argument
	should be used when the keytab is being extracted
	elsewhere:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kadmin</userinput>
kadmin&gt;<userinput> ext_keytab --keytab=/tmp/example.keytab <replaceable>host/myserver.example.org</replaceable></userinput>
kadmin&gt;<userinput> exit</userinput></screen>

      <para xml:lang="en">The keytab can then be securely copied to the server
	using <citerefentry><refentrytitle>scp</refentrytitle><manvolnum>1</manvolnum></citerefentry> or a removable media.  Be sure to specify a
	non-default keytab name to avoid inserting unneeded keys into
	the system's keytab.</para>

      <para xml:lang="en">At this point, the server can read encrypted messages from
	the <acronym>KDC</acronym> using its shared key, stored in
	<filename>krb5.keytab</filename>.  It is now ready for the
	<application>Kerberos</application>-using services to be
	enabled.  One of the most common such services is
	<citerefentry><refentrytitle>sshd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, which supports
	<application>Kerberos</application> via the
	<acronym>GSS-API</acronym>.  In
	<filename>/etc/ssh/sshd_config</filename>, add the
	line:</para>

      <programlisting xml:lang="en">GSSAPIAuthentication yes</programlisting>

      <para>做完了這個變更之後，必須重新啟動 <citerefentry><refentrytitle>sshd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來使新的設定值生效：<command>service sshd restart</command>。</para>
    </sect2>

    <sect2>
      <title>設定客戶端使用 <application>Kerberos</application></title>

      <indexterm xml:lang="en">
	<primary>Kerberos5</primary>
	<secondary>configure clients</secondary>
      </indexterm>

      <para xml:lang="en">As it was for the server, the client requires
	configuration in <filename>/etc/krb5.conf</filename>.  Copy
	the file in place (securely) or re-enter it as needed.</para>

      <para xml:lang="en">Test the client by using <command>kinit</command>,
	<command>klist</command>, and <command>kdestroy</command> from
	the client to obtain, show, and then delete a ticket for an
	existing principal.  <application>Kerberos</application>
	applications should also be able to connect to
	<application>Kerberos</application> enabled servers.  If that
	does not work but obtaining a ticket does, the problem is
	likely with the server and not with the client or the
	<acronym>KDC</acronym>.  In the case of kerberized
	<citerefentry><refentrytitle>ssh</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <acronym>GSS-API</acronym> is disabled by
	default, so test using <command>ssh -o
	  GSSAPIAuthentication=yes
	  <replaceable>hostname</replaceable></command>.</para>

      <para xml:lang="en">When testing a Kerberized application, try using a packet
	sniffer such as <command>tcpdump</command> to confirm that no
	sensitive information is sent in the clear.</para>

      <para xml:lang="en">Various <application>Kerberos</application> client
	applications are available.  With the advent of a bridge so
	that applications using <acronym>SASL</acronym> for
	authentication can use <acronym>GSS-API</acronym> mechanisms
	as well, large classes of client applications can use
	<application>Kerberos</application> for authentication, from
	Jabber clients to <acronym>IMAP</acronym> clients.</para>

      <indexterm xml:lang="en">
	<primary><filename>.k5login</filename></primary>
      </indexterm>

      <indexterm xml:lang="en">
	<primary><filename>.k5users</filename></primary>
      </indexterm>

      <para xml:lang="en">Users within a realm typically have their
	<application>Kerberos</application> principal mapped to a
	local user account.  Occasionally, one needs to grant access
	to a local user account to someone who does not have a
	matching <application>Kerberos</application> principal.  For
	example, <systemitem class="username">tillman@EXAMPLE.ORG</systemitem> may need
	access to the local user account <systemitem class="username">webdevelopers</systemitem>.  Other
	principals may also need access to that local account.</para>

      <para xml:lang="en">The <filename>.k5login</filename> and
	<filename>.k5users</filename> files, placed in a user's home
	directory, can be used to solve this problem.  For example, if
	the following <filename>.k5login</filename> is placed in the
	home directory of <systemitem class="username">webdevelopers</systemitem>, both principals
	listed will have access to that account without requiring a
	shared password:</para>

      <programlisting xml:lang="en">tillman@example.org
jdoe@example.org</programlisting>

      <para xml:lang="en">Refer to <citerefentry><refentrytitle>ksu</refentrytitle><manvolnum>1</manvolnum></citerefentry> for more information about
	<filename>.k5users</filename>.</para>
    </sect2>

    <sect2>
      <title>與 <acronym>MIT</acronym> 的差異</title>

      <para xml:lang="en">The major difference between the <acronym>MIT</acronym>
	and Heimdal implementations is that <command>kadmin</command>
	has a different, but equivalent, set of commands and uses a
	different protocol.  If the <acronym>KDC</acronym> is
	<acronym>MIT</acronym>, the Heimdal version of
	<command>kadmin</command> cannot be used to administer the
	<acronym>KDC</acronym> remotely, and vice versa.</para>

      <para xml:lang="en">Client applications may also use slightly different
	command line options to accomplish the same tasks.  Following
	the instructions at <link xlink:href="http://web.mit.edu/Kerberos/www/">http://web.mit.edu/Kerberos/www/</link>
	is recommended.  Be careful of path issues: the
	<acronym>MIT</acronym> port installs into
	<filename>/usr/local/</filename> by default, and the FreeBSD
	system applications run instead of the
	<acronym>MIT</acronym> versions if <envar>PATH</envar> lists
	the system directories first.</para>

      <para xml:lang="en">When using MIT Kerberos as a <acronym>KDC</acronym> on
	FreeBSD, the following edits should also be made to
	<filename>rc.conf</filename>:</para>

      <programlisting xml:lang="en">kerberos5_server="/usr/local/sbin/krb5kdc"
kadmind5_server="/usr/local/sbin/kadmind"
kerberos5_server_flags=""
kerberos5_server_enable="YES"
kadmind5_server_enable="YES"</programlisting>
    </sect2>

    <sect2>
      <title><application>Kerberos</application> 提示、技巧與疑難排解</title>

      <para xml:lang="en">When configuring and troubleshooting
	<application>Kerberos</application>, keep the following points
	in mind:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">When using either Heimdal or <acronym>MIT</acronym>
	    <application>Kerberos</application> from ports, ensure
	    that the <envar>PATH</envar> lists the port's versions of
	    the client applications before the system versions.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">If all the computers in the realm do not have
	    synchronized time settings, authentication may fail.
	    <xref linkend="network-ntp"/> describes how to synchronize
	    clocks using <acronym>NTP</acronym>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">If the hostname is changed, the <systemitem class="username">host/</systemitem> principal must be
	    changed and the keytab updated.  This also applies to
	    special keytab entries like the <systemitem class="username">HTTP/</systemitem> principal used for
	    Apache's <package>www/mod_auth_kerb</package>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">All hosts in the realm must be both forward and
	    reverse resolvable in <acronym>DNS</acronym> or, at a
	    minimum, exist in <filename>/etc/hosts</filename>.  CNAMEs
	    will work, but the A and PTR records must be correct and
	    in place.  The error message for unresolvable hosts is not
	    intuitive: <errorname>Kerberos5 refuses authentication
	      because Read req failed: Key table entry not
	      found</errorname>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Some operating systems that act as clients to the
	    <acronym>KDC</acronym> do not set the permissions for
	    <command>ksu</command> to be setuid <systemitem class="username">root</systemitem>.  This means that
	    <command>ksu</command> does not work.  This is a
	    permissions problem, not a <acronym>KDC</acronym>
	    error.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">With <acronym>MIT</acronym>
	    <application>Kerberos</application>, to allow a principal
	    to have a ticket life longer than the default lifetime of
	    ten hours, use <command>modify_principal</command> at the
	    <citerefentry><refentrytitle>kadmin</refentrytitle><manvolnum>8</manvolnum></citerefentry> prompt to change the
	    <literal>maxlife</literal> of both the principal in
	    question and the
	    <systemitem class="username">krbtgt</systemitem>
	    principal.  The principal can then use
	    <command>kinit -l</command> to request a ticket with a
	    longer lifetime.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">When running a packet sniffer on the
	    <acronym>KDC</acronym> to aid in troubleshooting while
	    running <command>kinit</command> from a workstation, the
	    Ticket Granting Ticket (<acronym>TGT</acronym>) is sent
	    immediately, even before the password is typed.  This is
	    because the <application>Kerberos</application> server
	    freely transmits a <acronym>TGT</acronym> to any
	    unauthorized request.  However, every
	    <acronym>TGT</acronym> is encrypted in a key derived from
	    the user's password.  When a user types their password, it
	    is not sent to the <acronym>KDC</acronym>, it is instead
	    used to decrypt the <acronym>TGT</acronym> that
	    <command>kinit</command> already obtained.  If the
	    decryption process results in a valid ticket with a valid
	    time stamp, the user has valid
	    <application>Kerberos</application> credentials.  These
	    credentials include a session key for establishing secure
	    communications with the
	    <application>Kerberos</application> server in the future,
	    as well as the actual <acronym>TGT</acronym>, which is
	    encrypted with the <application>Kerberos</application>
	    server's own key.  This second layer of encryption allows
	    the <application>Kerberos</application> server to verify
	    the authenticity of each <acronym>TGT</acronym>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Host principals can have a longer ticket lifetime.  If
	    the user principal has a lifetime of a week but the host
	    being connected to has a lifetime of nine hours, the user
	    cache will have an expired host principal and the ticket
	    cache will not work as expected.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">When setting up <filename>krb5.dict</filename> to
	    prevent specific bad passwords from being used as
	    described in <citerefentry><refentrytitle>kadmind</refentrytitle><manvolnum>8</manvolnum></citerefentry>, remember that it only
	    applies to principals that have a password policy assigned
	    to them.  The format used in
	    <filename>krb5.dict</filename> is one string per line.
	    Creating a symbolic link to
	    <filename>/usr/share/dict/words</filename> might be
	    useful.</para>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2>
      <title>減輕 <application>Kerberos</application> 的限制</title>

      <indexterm xml:lang="en">
	<primary>Kerberos5</primary>
	<secondary>limitations and shortcomings</secondary>
      </indexterm>

      <para xml:lang="en">Since <application>Kerberos</application> is an all or
	nothing approach, every service enabled on the network must
	either be modified to work with
	<application>Kerberos</application> or be otherwise secured
	against network attacks.  This is to prevent user credentials
	from being stolen and re-used.  An example is when
	<application>Kerberos</application> is enabled on all remote
	shells but the non-Kerberized <acronym>POP3</acronym> mail
	server sends passwords in plain text.</para>

      <para xml:lang="en">The <acronym>KDC</acronym> is a single point of failure.
	By design, the <acronym>KDC</acronym> must be as secure as its
	master password database.  The <acronym>KDC</acronym> should
	have absolutely no other services running on it and should be
	physically secure.  The danger is high because
	<application>Kerberos</application> stores all passwords
	encrypted with the same master key which is stored as a file
	on the <acronym>KDC</acronym>.</para>

      <para xml:lang="en">A compromised master key is not quite as bad as one might
	fear.  The master key is only used to encrypt the
	<application>Kerberos</application> database and as a seed for
	the random number generator.  As long as access to the
	<acronym>KDC</acronym> is secure, an attacker cannot do much
	with the master key.</para>

      <para xml:lang="en">If the <acronym>KDC</acronym> is unavailable, network
	services are unusable as authentication cannot be performed.
	This can be alleviated with a single master
	<acronym>KDC</acronym> and one or more slaves, and with
	careful implementation of secondary or fall-back
	authentication using <acronym>PAM</acronym>.</para>

      <para xml:lang="en"><application>Kerberos</application> allows users, hosts
	and services to authenticate between themselves.  It does not
	have a mechanism to authenticate the
	<acronym>KDC</acronym> to the users, hosts, or services.  This
	means that a trojanned <command>kinit</command> could record
	all user names and passwords.  File system integrity checking
	tools like <package>security/tripwire</package> can
	alleviate this.</para>
    </sect2>

    <sect2>
      <title>相關資源與延伸資訊</title>

      <indexterm xml:lang="en">
	<primary>Kerberos5</primary>
	<secondary>external resources</secondary>
      </indexterm>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><link xlink:href="http://www.faqs.org/faqs/Kerberos-faq/general/preamble.html">
	      The <application>Kerberos</application>
	      FAQ</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="http://web.mit.edu/Kerberos/www/dialogue.html">Designing
	      an Authentication System: a Dialog in Four
	      Scenes</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="https://www.ietf.org/rfc/rfc4120.txt">RFC
	      4120, The <application>Kerberos</application> Network
	      Authentication Service (V5)</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="http://web.mit.edu/Kerberos/www/"><acronym>MIT</acronym>
	      <application>Kerberos</application> home
	      page</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="https://www.h5l.org/">Heimdal
	      <application>Kerberos</application> home
	      page</link></para>
	</listitem>
      </itemizedlist>
    </sect2>
  </sect1>

  <sect1 xml:id="openssl">
    <info>
      <title xml:lang="en">OpenSSL</title>

      <authorgroup>
	<author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Written
	  by </contrib></author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>security</primary>
      <secondary>OpenSSL</secondary>
    </indexterm>

    <para xml:lang="en"><application>OpenSSL</application> is an open source
      implementation of the <acronym>SSL</acronym> and
      <acronym>TLS</acronym> protocols.  It provides an encryption
      transport layer on top of the normal communications layer,
      allowing it to be intertwined with many network applications and
      services.</para>

    <para xml:lang="en">The version of <application>OpenSSL</application> included
      in FreeBSD supports the Secure Sockets Layer 3.0 (SSLv3)
      and Transport Layer Security 1.0/1.1/1.2 (TLSv1/TLSv1.1/TLSv1.2)
      network security
      protocols and can be used as a general cryptographic
      library.  In FreeBSD 12.0-RELEASE and above, OpenSSL also supports
      Transport Layer Security 1.3 (TLSv1.3).</para>

    <para xml:lang="en"><application>OpenSSL</application> is often used to encrypt
      authentication of mail clients and to secure web based
      transactions such as credit card payments.  Some ports, such as
      <package>www/apache24</package> and
      <package>databases/postgresql11-server</package>, include a
      compile option for building with
      <application>OpenSSL</application>.  If selected, the port will
      add support using <application>OpenSSL</application> from the
      base system.  To instead have the port compile against
      <application>OpenSSL</application> from the
      <package>security/openssl</package> port, add the following to
      <filename>/etc/make.conf</filename>:</para>

    <programlisting xml:lang="en">DEFAULT_VERSIONS+= ssl=openssl</programlisting>

    <para xml:lang="en">Another common use of <application>OpenSSL</application> is
      to provide certificates for use with software applications.
      Certificates can be used to verify the credentials of a company
      or individual.  If a certificate has not been signed by an
      external <firstterm>Certificate Authority</firstterm>
      (<acronym>CA</acronym>), such as <link xlink:href="http://www.verisign.com">http://www.verisign.com</link>,
      the application that uses the certificate will produce a
      warning.  There is a cost associated with obtaining a signed
      certificate and using a signed certificate is not mandatory as
      certificates can be self-signed.  However, using an external
      authority will prevent warnings and can put users at
      ease.</para>

    <para xml:lang="en">This section demonstrates how to create and use certificates
      on a FreeBSD system.  Refer to <xref linkend="ldap-config"/> for an
      example of how to create a <acronym>CA</acronym> for signing
      one's own certificates.</para>

    <para xml:lang="en">For more information about <acronym>SSL</acronym>, read the
      free <link xlink:href="https://www.feistyduck.com/books/openssl-cookbook/">OpenSSL
	Cookbook</link>.</para>

    <sect2>
      <title>產生憑証</title>

      <indexterm xml:lang="en">
	<primary>OpenSSL</primary>
	<secondary>certificate generation</secondary>
      </indexterm>

      <para xml:lang="en">To generate a certificate that will be signed by an
	external <acronym>CA</acronym>, issue the following command
	and input the information requested at the prompts.  This
	input information will be written to the certificate.  At the
	<literal>Common Name</literal> prompt, input the fully
	qualified name for the system that will use the certificate.
	If this name does not match the server, the application
	verifying the certificate will issue a warning to the user,
	rendering the verification provided by the certificate as
	useless.</para>
      <screen xml:lang="en"><prompt>#</prompt> <userinput>openssl req -new -nodes -out req.pem -keyout cert.key -sha256 -newkey rsa:2048</userinput>
Generating a 2048 bit RSA private key
..................+++
.............................................................+++
writing new private key to 'cert.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:<userinput><replaceable>US</replaceable></userinput>
State or Province Name (full name) [Some-State]:<userinput><replaceable>PA</replaceable></userinput>
Locality Name (eg, city) []:<userinput><replaceable>Pittsburgh</replaceable></userinput>
Organization Name (eg, company) [Internet Widgits Pty Ltd]:<userinput><replaceable>My Company</replaceable></userinput>
Organizational Unit Name (eg, section) []:<userinput><replaceable>Systems Administrator</replaceable></userinput>
Common Name (eg, YOUR name) []:<userinput><replaceable>localhost.example.org</replaceable></userinput>
Email Address []:<userinput><replaceable>trhodes@FreeBSD.org</replaceable></userinput>

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:<userinput><replaceable>Another Name</replaceable></userinput></screen>

      <para xml:lang="en">Other options, such as the expire time and alternate
	encryption algorithms, are available when creating a
	certificate.  A complete list of options is described in
	<citerefentry><refentrytitle>openssl</refentrytitle><manvolnum>1</manvolnum></citerefentry>.</para>

      <para xml:lang="en">This command will create two files in the current
	directory.  The certificate request,
	<filename>req.pem</filename>, can be sent to a
	<acronym>CA</acronym> who will validate the entered
	credentials, sign the request, and return the signed
	certificate.  The second file,
	<filename>cert.key</filename>, is the private key for the
	certificate and should be stored in a secure location.  If
	this falls in the hands of others, it can be used to
	impersonate the user or the server.</para>

      <para xml:lang="en">Alternately, if a signature from a <acronym>CA</acronym>
	is not required, a self-signed certificate can be created.
	First, generate the <acronym>RSA</acronym> key:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>openssl genrsa -rand -genkey -out cert.key 2048</userinput>
0 semi-random bytes loaded
Generating RSA private key, 2048 bit long modulus
.............................................+++
.................................................................................................................+++
e is 65537 (0x10001)</screen>

      <para xml:lang="en">Use this key to create a self-signed certificate.
	Follow the usual prompts for creating a certificate:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>openssl req -new -x509 -days 365 -key cert.key -out cert.crt -sha256</userinput>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:<userinput><replaceable>US</replaceable></userinput>
State or Province Name (full name) [Some-State]:<userinput><replaceable>PA</replaceable></userinput>
Locality Name (eg, city) []:<userinput><replaceable>Pittsburgh</replaceable></userinput>
Organization Name (eg, company) [Internet Widgits Pty Ltd]:<userinput><replaceable>My Company</replaceable></userinput>
Organizational Unit Name (eg, section) []:<userinput><replaceable>Systems Administrator</replaceable></userinput>
Common Name (e.g. server FQDN or YOUR name) []:<userinput><replaceable>localhost.example.org</replaceable></userinput>
Email Address []:<userinput><replaceable>trhodes@FreeBSD.org</replaceable></userinput></screen>

      <para xml:lang="en">This will create two new files in the current directory: a
	private key file
	<filename>cert.key</filename>, and the certificate itself,
	<filename>cert.crt</filename>.  These should be placed in a
	directory, preferably under <filename>/etc/ssl/</filename>,
	which is readable only by <systemitem class="username">root</systemitem>.  Permissions of
	<literal>0700</literal> are appropriate for these files and
	can be set using <command>chmod</command>.</para>
    </sect2>

    <sect2>
      <title>使用憑證</title>

      <para xml:lang="en">One use for a certificate is to encrypt connections to the
	<application>Sendmail</application> mail server in order to
	prevent the use of clear text authentication.</para>

      <note>
	<para xml:lang="en">Some mail clients will display an error if the user has
	  not installed a local copy of the certificate.  Refer to the
	  documentation included with the software for more
	  information on certificate installation.</para>
      </note>

      <para xml:lang="en">In FreeBSD 10.0-RELEASE and above, it is possible to create a
	self-signed certificate for
	<application>Sendmail</application> automatically.  To enable
	this, add the following lines to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">sendmail_enable="YES"
sendmail_cert_create="YES"
sendmail_cert_cn="<replaceable>localhost.example.org</replaceable>"</programlisting>

      <para xml:lang="en">This will automatically create a self-signed certificate,
	<filename>/etc/mail/certs/host.cert</filename>, a signing key,
	<filename>/etc/mail/certs/host.key</filename>, and a
	<acronym>CA</acronym> certificate,
	<filename>/etc/mail/certs/cacert.pem</filename>.  The
	certificate will use the <literal>Common Name</literal>
	specified in <option>sendmail_cert_cn</option>.  After saving
	the edits, restart <application>Sendmail</application>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service sendmail restart</userinput></screen>

      <para xml:lang="en">If all went well, there will be no error messages in
	<filename>/var/log/maillog</filename>.  For a simple test,
	connect to the mail server's listening port using
	<command>telnet</command>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>telnet <replaceable>example.com</replaceable> 25</userinput>
Trying 192.0.34.166...
Connected to example.com.
Escape character is '^]'.
220 example.com ESMTP Sendmail 8.14.7/8.14.7; Fri, 18 Apr 2014 11:50:32 -0400 (EDT)
<userinput>ehlo <replaceable>example.com</replaceable></userinput>
250-example.com Hello example.com [192.0.34.166], pleased to meet you
250-ENHANCEDSTATUSCODES
250-PIPELINING
250-8BITMIME
250-SIZE
250-DSN
250-ETRN
250-AUTH LOGIN PLAIN
250-STARTTLS
250-DELIVERBY
250 HELP
<userinput>quit</userinput>
221 2.0.0 example.com closing connection
Connection closed by foreign host.</screen>

      <para xml:lang="en">If the <literal>STARTTLS</literal> line appears in the
	output, everything is working correctly.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="ipsec">
    <info>
      <title xml:lang="en"><acronym>VPN</acronym> over
	<acronym>IPsec</acronym></title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Nik</firstname>
	    <surname>Clayton</surname>
	  </personname>
	  <affiliation>
	    <address xml:lang="en">
	      <email>nik@FreeBSD.org</email>
	    </address>
	  </affiliation>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Hiten M.</firstname>
	    <surname>Pandya</surname>
	  </personname>
	  <affiliation>
	    <address xml:lang="en">
	      <email>hmp@FreeBSD.org</email>
	    </address>
	  </affiliation>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary><acronym>IPsec</acronym></primary>
    </indexterm>

    <para xml:lang="en">Internet Protocol Security (<acronym>IPsec</acronym>) is a
      set of protocols which sit on top of the Internet Protocol
      (<acronym>IP</acronym>) layer.  It allows two or more hosts to
      communicate in a secure manner by authenticating and encrypting
      each <acronym>IP</acronym> packet of a communication session.
      The FreeBSD <acronym>IPsec</acronym> network stack is based on the
      <link xlink:href="http://www.kame.net/">http://www.kame.net/</link>
      implementation and supports both <acronym>IPv4</acronym> and
      <acronym>IPv6</acronym> sessions.</para>

    <indexterm xml:lang="en">
      <primary><acronym>IPsec</acronym></primary>
      <secondary>ESP</secondary>
    </indexterm>

    <indexterm xml:lang="en">
      <primary><acronym>IPsec</acronym></primary>
      <secondary>AH</secondary>
    </indexterm>

    <para xml:lang="en"><acronym>IPsec</acronym> is comprised of the following
      sub-protocols:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en"><emphasis>Encapsulated Security Payload
	    (<acronym>ESP</acronym>)</emphasis>: this protocol
	  protects the <acronym>IP</acronym> packet data from third
	  party interference by encrypting the contents using
	  symmetric cryptography algorithms such as Blowfish and
	  <acronym>3DES</acronym>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>Authentication Header
	    (<acronym>AH</acronym>)</emphasis>: this protocol
	  protects the <acronym>IP</acronym> packet header from third
	  party interference and spoofing by computing a cryptographic
	  checksum and hashing the <acronym>IP </acronym> packet
	  header fields with a secure hashing function.  This is then
	  followed by an additional header that contains the hash, to
	  allow the information in the packet to be
	  authenticated.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>IP Payload Compression Protocol
	    (<acronym>IPComp</acronym></emphasis>): this protocol
	  tries to increase communication performance by compressing
	  the <acronym>IP </acronym> payload in order to reduce the
	  amount of data sent.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">These protocols can either be used together or separately,
      depending on the environment.</para>

    <indexterm xml:lang="en">
      <primary><acronym>VPN</acronym></primary>
    </indexterm>

    <indexterm xml:lang="en">
      <primary>virtual private network</primary>
      <see>VPN</see>
    </indexterm>

    <para xml:lang="en"><acronym>IPsec</acronym> supports two modes of operation.
      The first mode, <firstterm>Transport Mode</firstterm>, protects
      communications between two hosts.  The second mode,
      <firstterm>Tunnel Mode</firstterm>, is used to build virtual
      tunnels, commonly known as Virtual Private Networks
      (<acronym>VPN</acronym>s).  Consult <citerefentry><refentrytitle>ipsec</refentrytitle><manvolnum>4</manvolnum></citerefentry> for detailed
      information on the <acronym>IPsec</acronym> subsystem in
      FreeBSD.</para>

    <para>在 FreeBSD 11 與之後的版本預設會開啟 <acronym>IPsec</acronym> 功能，先前版本的 FreeBSD 可在自訂核心設定檔中加入以下選項然後依 <xref linkend="kernelconfig"/> 的指示來重新編譯核心：</para>

    <indexterm><primary>核心選項</primary> <secondary>IPSEC</secondary></indexterm>

    <screen xml:lang="en">options   IPSEC        #IP security
device    crypto</screen>

    <indexterm><primary>核心選項</primary> <secondary>IPSEC_DEBUG</secondary></indexterm>

    <para xml:lang="en">If <acronym>IPsec</acronym> debugging support is desired,
      the following kernel option should also be added:</para>

    <screen xml:lang="en">options   IPSEC_DEBUG  #debug for IP security</screen>

    <para xml:lang="en">This rest of this chapter demonstrates the process of
      setting up an <acronym>IPsec</acronym> <acronym>VPN</acronym>
      between a home network and a corporate network.  In the example
      scenario:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Both sites are connected to the Internet through a
	  gateway that is running FreeBSD.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The gateway on each network has at least one external
	  <acronym>IP</acronym> address.  In this example, the
	  corporate <acronym>LAN</acronym>'s external
	  <acronym>IP</acronym> address is <systemitem class="ipaddress">172.16.5.4</systemitem> and the home
	  <acronym>LAN</acronym>'s external <acronym>IP</acronym>
	  address is <systemitem class="ipaddress">192.168.1.12</systemitem>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The internal addresses of the two networks can be either
	  public or private <acronym>IP</acronym> addresses.  However,
	  the address space must not collide.  For example, both
	  networks cannot use <systemitem class="ipaddress">192.168.1.x</systemitem>.  In this
	  example, the corporate <acronym>LAN</acronym>'s internal
	  <acronym>IP</acronym> address is <systemitem class="ipaddress">10.246.38.1</systemitem> and the home
	  <acronym>LAN</acronym>'s internal <acronym>IP</acronym>
	  address is <systemitem class="ipaddress">10.0.0.5</systemitem>.</para>
      </listitem>
    </itemizedlist>

    <sect2>
      <info>
	<title>在 FreeBSD 上設定 <acronym>VPN</acronym></title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Tom</firstname>
	      <surname>Rhodes</surname>
	    </personname>
	    <affiliation>
	      <address xml:lang="en">
		<email>trhodes@FreeBSD.org</email>
	      </address>
	    </affiliation>
	    <contrib>Written by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para xml:lang="en">To begin, <package>security/ipsec-tools</package> must be
	installed from the Ports Collection.  This software provides a
	number of applications which support the configuration.</para>

      <para xml:lang="en">The next requirement is to create two <citerefentry><refentrytitle>gif</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	pseudo-devices which will be used to tunnel packets and allow
	both networks to communicate properly.  As <systemitem class="username">root</systemitem>, run the following
	commands, replacing <replaceable>internal</replaceable> and
	<replaceable>external</replaceable> with the real IP
	addresses of the internal and external interfaces of the two
	gateways:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig gif0 create</userinput>
<prompt>#</prompt> <userinput>ifconfig gif0 <replaceable>internal1 internal2</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig gif0 tunnel <replaceable>external1 external2</replaceable></userinput></screen>

      <para xml:lang="en">Verify the setup on each gateway, using
	<command>ifconfig</command>.  Here is the output from Gateway
	1:</para>

      <programlisting xml:lang="en">gif0: flags=8051 mtu 1280
tunnel inet 172.16.5.4 --&gt; 192.168.1.12
inet6 fe80::2e0:81ff:fe02:5881%gif0 prefixlen 64 scopeid 0x6
inet 10.246.38.1 --&gt; 10.0.0.5 netmask 0xffffff00</programlisting>

      <para xml:lang="en">Here is the output from Gateway 2:</para>

      <programlisting xml:lang="en">gif0: flags=8051 mtu 1280
tunnel inet 192.168.1.12 --&gt; 172.16.5.4
inet 10.0.0.5 --&gt; 10.246.38.1 netmask 0xffffff00
inet6 fe80::250:bfff:fe3a:c1f%gif0 prefixlen 64 scopeid 0x4</programlisting>

      <para xml:lang="en">Once complete, both internal <acronym>IP</acronym>
	addresses should be reachable using <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

      <programlisting xml:lang="en">priv-net# ping 10.0.0.5
PING 10.0.0.5 (10.0.0.5): 56 data bytes
64 bytes from 10.0.0.5: icmp_seq=0 ttl=64 time=42.786 ms
64 bytes from 10.0.0.5: icmp_seq=1 ttl=64 time=19.255 ms
64 bytes from 10.0.0.5: icmp_seq=2 ttl=64 time=20.440 ms
64 bytes from 10.0.0.5: icmp_seq=3 ttl=64 time=21.036 ms
--- 10.0.0.5 ping statistics ---
4 packets transmitted, 4 packets received, 0% packet loss
round-trip min/avg/max/stddev = 19.255/25.879/42.786/9.782 ms

corp-net# ping 10.246.38.1
PING 10.246.38.1 (10.246.38.1): 56 data bytes
64 bytes from 10.246.38.1: icmp_seq=0 ttl=64 time=28.106 ms
64 bytes from 10.246.38.1: icmp_seq=1 ttl=64 time=42.917 ms
64 bytes from 10.246.38.1: icmp_seq=2 ttl=64 time=127.525 ms
64 bytes from 10.246.38.1: icmp_seq=3 ttl=64 time=119.896 ms
64 bytes from 10.246.38.1: icmp_seq=4 ttl=64 time=154.524 ms
--- 10.246.38.1 ping statistics ---
5 packets transmitted, 5 packets received, 0% packet loss
round-trip min/avg/max/stddev = 28.106/94.594/154.524/49.814 ms</programlisting>

      <para xml:lang="en">As expected, both sides have the ability to send and
	receive <acronym>ICMP</acronym> packets from the privately
	configured addresses.  Next, both gateways must be told how to
	route packets in order to correctly send traffic from either
	network.  The following commands will achieve this
	goal:</para>

      <screen xml:lang="en">corp-net<prompt>#</prompt> <userinput>route add <replaceable>10.0.0.0 10.0.0.5 255.255.255.0</replaceable></userinput>
corp-net<prompt>#</prompt> <userinput>route add net <replaceable>10.0.0.0: gateway 10.0.0.5</replaceable></userinput>
priv-net<prompt>#</prompt> <userinput>route add <replaceable>10.246.38.0 10.246.38.1 255.255.255.0</replaceable></userinput>
priv-net<prompt>#</prompt> <userinput>route add host <replaceable>10.246.38.0: gateway 10.246.38.1</replaceable></userinput></screen>

      <para xml:lang="en">At this point, internal machines should be reachable from
	each gateway as well as from machines behind the gateways.
	Again, use <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry> to confirm:</para>

      <programlisting xml:lang="en">corp-net# ping 10.0.0.8
PING 10.0.0.8 (10.0.0.8): 56 data bytes
64 bytes from 10.0.0.8: icmp_seq=0 ttl=63 time=92.391 ms
64 bytes from 10.0.0.8: icmp_seq=1 ttl=63 time=21.870 ms
64 bytes from 10.0.0.8: icmp_seq=2 ttl=63 time=198.022 ms
64 bytes from 10.0.0.8: icmp_seq=3 ttl=63 time=22.241 ms
64 bytes from 10.0.0.8: icmp_seq=4 ttl=63 time=174.705 ms
--- 10.0.0.8 ping statistics ---
5 packets transmitted, 5 packets received, 0% packet loss
round-trip min/avg/max/stddev = 21.870/101.846/198.022/74.001 ms

priv-net# ping 10.246.38.107
PING 10.246.38.1 (10.246.38.107): 56 data bytes
64 bytes from 10.246.38.107: icmp_seq=0 ttl=64 time=53.491 ms
64 bytes from 10.246.38.107: icmp_seq=1 ttl=64 time=23.395 ms
64 bytes from 10.246.38.107: icmp_seq=2 ttl=64 time=23.865 ms
64 bytes from 10.246.38.107: icmp_seq=3 ttl=64 time=21.145 ms
64 bytes from 10.246.38.107: icmp_seq=4 ttl=64 time=36.708 ms
--- 10.246.38.107 ping statistics ---
5 packets transmitted, 5 packets received, 0% packet loss
round-trip min/avg/max/stddev = 21.145/31.721/53.491/12.179 ms</programlisting>

      <para xml:lang="en">Setting up the tunnels is the easy part.  Configuring a
	secure link is a more in depth process.  The following
	configuration uses pre-shared (<acronym>PSK</acronym>)
	<acronym>RSA</acronym> keys.  Other than the
	<acronym>IP</acronym> addresses, the
	<filename>/usr/local/etc/racoon/racoon.conf</filename> on both
	gateways will be identical and look similar to:</para>

      <programlisting xml:lang="en">path    pre_shared_key  "/usr/local/etc/racoon/psk.txt"; #location of pre-shared key file
log     debug;	#log verbosity setting: set to 'notify' when testing and debugging is complete

padding	# options are not to be changed
{
        maximum_length  20;
        randomize       off;
        strict_check    off;
        exclusive_tail  off;
}

timer	# timing options. change as needed
{
        counter         5;
        interval        20 sec;
        persend         1;
#       natt_keepalive  15 sec;
        phase1          30 sec;
        phase2          15 sec;
}

listen	# address [port] that racoon will listen on
{
        isakmp          172.16.5.4 [500];
        isakmp_natt     172.16.5.4 [4500];
}

remote  192.168.1.12 [500]
{
        exchange_mode   main,aggressive;
        doi             ipsec_doi;
        situation       identity_only;
        my_identifier   address 172.16.5.4;
        peers_identifier        address 192.168.1.12;
        lifetime        time 8 hour;
        passive         off;
        proposal_check  obey;
#       nat_traversal   off;
        generate_policy off;

                        proposal {
                                encryption_algorithm    blowfish;
                                hash_algorithm          md5;
                                authentication_method   pre_shared_key;
                                lifetime time           30 sec;
                                dh_group                1;
                        }
}

sainfo  (address 10.246.38.0/24 any address 10.0.0.0/24 any)	# address $network/$netmask $type address $network/$netmask $type ( $type being any or esp)
{								# $network must be the two internal networks you are joining.
        pfs_group       1;
        lifetime        time    36000 sec;
        encryption_algorithm    blowfish,3des;
        authentication_algorithm        hmac_md5,hmac_sha1;
        compression_algorithm   deflate;
}</programlisting>

      <para xml:lang="en">For descriptions of each available option, refer to the
	manual page for <filename>racoon.conf</filename>.</para>

      <para xml:lang="en">The Security Policy Database (<acronym>SPD</acronym>)
	needs to be configured so that FreeBSD and
	<application>racoon</application> are able to encrypt and
	decrypt network traffic between the hosts.</para>

      <para xml:lang="en">This can be achieved with a shell script, similar to the
	following, on the corporate gateway.  This file will be used
	during system initialization and should be saved as
	<filename>/usr/local/etc/racoon/setkey.conf</filename>.</para>

      <programlisting xml:lang="en">flush;
spdflush;
# To the home network
spdadd 10.246.38.0/24 10.0.0.0/24 any -P out ipsec esp/tunnel/172.16.5.4-192.168.1.12/use;
spdadd 10.0.0.0/24 10.246.38.0/24 any -P in ipsec esp/tunnel/192.168.1.12-172.16.5.4/use;</programlisting>

      <para xml:lang="en">Once in place, <application>racoon</application> may be
	started on both gateways using the following command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>/usr/local/sbin/racoon -F -f /usr/local/etc/racoon/racoon.conf -l /var/log/racoon.log</userinput></screen>

      <para xml:lang="en">The output should be similar to the following:</para>

      <programlisting xml:lang="en">corp-net# /usr/local/sbin/racoon -F -f /usr/local/etc/racoon/racoon.conf
Foreground mode.
2006-01-30 01:35:47: INFO: begin Identity Protection mode.
2006-01-30 01:35:48: INFO: received Vendor ID: KAME/racoon
2006-01-30 01:35:55: INFO: received Vendor ID: KAME/racoon
2006-01-30 01:36:04: INFO: ISAKMP-SA established 172.16.5.4[500]-192.168.1.12[500] spi:623b9b3bd2492452:7deab82d54ff704a
2006-01-30 01:36:05: INFO: initiate new phase 2 negotiation: 172.16.5.4[0]192.168.1.12[0]
2006-01-30 01:36:09: INFO: IPsec-SA established: ESP/Tunnel 192.168.1.12[0]-&gt;172.16.5.4[0] spi=28496098(0x1b2d0e2)
2006-01-30 01:36:09: INFO: IPsec-SA established: ESP/Tunnel 172.16.5.4[0]-&gt;192.168.1.12[0] spi=47784998(0x2d92426)
2006-01-30 01:36:13: INFO: respond new phase 2 negotiation: 172.16.5.4[0]192.168.1.12[0]
2006-01-30 01:36:18: INFO: IPsec-SA established: ESP/Tunnel 192.168.1.12[0]-&gt;172.16.5.4[0] spi=124397467(0x76a279b)
2006-01-30 01:36:18: INFO: IPsec-SA established: ESP/Tunnel 172.16.5.4[0]-&gt;192.168.1.12[0] spi=175852902(0xa7b4d66)</programlisting>

      <para xml:lang="en">To ensure the tunnel is working properly, switch to
	another console and use <citerefentry><refentrytitle>tcpdump</refentrytitle><manvolnum>1</manvolnum></citerefentry> to view network
	traffic using the following command.  Replace
	<literal>em0</literal> with the network interface card as
	required:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>tcpdump -i em0 host <replaceable>172.16.5.4 and dst 192.168.1.12</replaceable></userinput></screen>

      <para xml:lang="en">Data similar to the following should appear on the
	console.  If not, there is an issue and debugging the
	returned data will be required.</para>

      <programlisting xml:lang="en">01:47:32.021683 IP corporatenetwork.com &gt; 192.168.1.12.privatenetwork.com: ESP(spi=0x02acbf9f,seq=0xa)
01:47:33.022442 IP corporatenetwork.com &gt; 192.168.1.12.privatenetwork.com: ESP(spi=0x02acbf9f,seq=0xb)
01:47:34.024218 IP corporatenetwork.com &gt; 192.168.1.12.privatenetwork.com: ESP(spi=0x02acbf9f,seq=0xc)</programlisting>

      <para xml:lang="en">At this point, both networks should be available and seem
	to be part of the same network.  Most likely both networks are
	protected by a firewall.  To allow traffic to flow between
	them, rules need to be added to pass packets.  For the
	<citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry> firewall, add the following lines to the firewall
	configuration file:</para>

      <programlisting xml:lang="en">ipfw add 00201 allow log esp from any to any
ipfw add 00202 allow log ah from any to any
ipfw add 00203 allow log ipencap from any to any
ipfw add 00204 allow log udp from any 500 to any</programlisting>

      <note>
	<para xml:lang="en">The rule numbers may need to be altered depending on the
	  current host configuration.</para>
      </note>

      <para xml:lang="en">For users of <citerefentry><refentrytitle>pf</refentrytitle><manvolnum>4</manvolnum></citerefentry> or <citerefentry><refentrytitle>ipf</refentrytitle><manvolnum>8</manvolnum></citerefentry>, the following
	rules should do the trick:</para>

      <programlisting xml:lang="en">pass in quick proto esp from any to any
pass in quick proto ah from any to any
pass in quick proto ipencap from any to any
pass in quick proto udp from any port = 500 to any port = 500
pass in quick on gif0 from any to any
pass out quick proto esp from any to any
pass out quick proto ah from any to any
pass out quick proto ipencap from any to any
pass out quick proto udp from any port = 500 to any port = 500
pass out quick on gif0 from any to any</programlisting>

      <para xml:lang="en">Finally, to allow the machine to start support for the
	<acronym>VPN</acronym> during system initialization, add the
	following lines to <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">ipsec_enable="YES"
ipsec_program="/usr/local/sbin/setkey"
ipsec_file="/usr/local/etc/racoon/setkey.conf" # allows setting up spd policies on boot
racoon_enable="yes"</programlisting>
    </sect2>
  </sect1>

  <sect1 xml:id="openssh">
    <info>
      <title xml:lang="en">OpenSSH</title>

      <authorgroup>
	<author xml:lang="en"><personname><firstname>Chern</firstname><surname>Lee</surname></personname><contrib>Contributed
	  by </contrib></author>
	<!-- 21 April 2001 -->
      </authorgroup>
    </info>

    <indexterm xml:lang="en"><primary>OpenSSH</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>security</primary>
      <secondary>OpenSSH</secondary>
    </indexterm>

    <para><application>OpenSSH</application> 是一套網路連線工具，可安全的存取遠端的主機，此外，透過 <acronym>SSH</acronym> 連線可以建立 <acronym>TCP/IP</acronym> 連線通道或安全的轉送 <acronym>TCP/IP</acronym> 的封包。<application>OpenSSH</application> 會對所有傳輸的資料做加密，可有效的避免竊聽 (Eavesdropping)、或連線劫持 (Connection hijacking) 與其他網路層的攻擊。</para>

    <para><application>OpenSSH</application> 由 OpenBSD 專案所維護且在 FreeBSD 預設會安裝，它可同時相容 <acronym>SSH</acronym> 版本 1 與 2 通訊協定。</para>

    <para>當以未加密的方式在網路上傳送資料時，任何在客戶端與伺服器之間的網路竊聽程式 (Network sniffer) 皆可竊取使用者/密碼資訊或者在連線階段傳送的資料，<application>OpenSSH</application> 提供了數種認証與加密方式來避免這種事情發生。更多有關 <application>OpenSSH</application> 的資訊可於 <link xlink:href="http://www.openssh.com/">http://www.openssh.com/</link> 取得。</para>

    <para>本節會簡單介紹如何使用內建的客戶端工具安全的存取其他系統及安全的傳輸檔案到 FreeBSD 系統，然後會說明如何設定在 FreeBSD 系統上的 <acronym>SSH</acronym> 伺服器。更多的資訊可於本章節所提及的操作手冊 (Man page) 取得。</para>

    <sect2>
      <title>使用 SSH 客戶端工具</title>

      <indexterm xml:lang="en">
	<primary>OpenSSH</primary>
	<secondary>client</secondary>
      </indexterm>

      <para>要登入一台 <acronym>SSH</acronym> 伺服器，可使用 <command>ssh</command> 然後指定在伺服器上存在的使用者名稱與 <acronym>IP</acronym> 位址或伺服器的主機名稱。若這是第一次連線到指定的伺服器，會提示該使用者伺服器的指紋做第一次檢驗：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ssh <replaceable>user@example.com</replaceable></userinput>
The authenticity of host 'example.com (10.0.0.1)' can't be established.
ECDSA key fingerprint is 25:cc:73:b5:b3:96:75:3d:56:19:49:d2:5c:1f:91:3b.
Are you sure you want to continue connecting (yes/no)? <userinput>yes</userinput>
Permanently added 'example.com' (ECDSA) to the list of known hosts.
Password for user@example.com: <userinput><replaceable>user_password</replaceable></userinput></screen>

      <para><acronym>SSH</acronym> 會在客戶端連線時利用金鑰指紋 (Key fingerprint) 系統來驗證伺服器的真偽，當使用者在第一次連線時輸入 <literal>yes</literal> 接受了這個金鑰指紋，便會將該金鑰的複本儲存到使用者家目錄的 <filename>.ssh/known_hosts</filename>，未來嘗試登入時便會以這個存好的金鑰來驗證，若伺服器的金鑰與儲存的金鑰不同將會顯示警告訊息。若出現這個警告時，使用者應在繼續連線之前檢查金鑰變動的原因。</para>

      <para>最近版本的 <application>OpenSSH</application> 預設只會接受 <acronym>SSH</acronym>v2 的連線。客戶端預設會盡可能使用版本 2 的通訊協定，若伺服器不支援版本 2 的通訊協定便會向下相容版本 1 的協定。要強制 <command>ssh</command> 只能使用指定的通訊協定，可使用 <option>-1</option> 或 <option>-2</option>，其他的選項在 <citerefentry><refentrytitle>ssh</refentrytitle><manvolnum>1</manvolnum></citerefentry> 中有說明。</para>

      <indexterm xml:lang="en">
	<primary>OpenSSH</primary>
	<secondary>secure copy</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><citerefentry><refentrytitle>scp</refentrytitle><manvolnum>1</manvolnum></citerefentry></primary>
      </indexterm>

      <para>使用 <citerefentry><refentrytitle>scp</refentrytitle><manvolnum>1</manvolnum></citerefentry> 可從遠端主機安全的複製一個檔案，以下範例會複製在遠端主機的 <filename>COPYRIGHT</filename> 到本地主機的目前目錄：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>scp <replaceable>user@example.com:/COPYRIGHT COPYRIGHT</replaceable></userinput>
Password for user@example.com: <userinput><replaceable>*******</replaceable></userinput>
COPYRIGHT            100% |*****************************|  4735
00:00
<prompt>#</prompt></screen>

      <para>由於這個主機的指紋已驗證過，在提示用者輸入密碼之前伺服器的金鑰已自動檢查。</para>

      <para>傳給 <command>scp</command> 的參數與傳給 <command>cp</command> 的參數相似。第一個參數是要複製的檔案，第二個參數是目地，由於檔案是透過網路取得，檔案參數需要使用 <option>user@host:&lt;path_to_remote_file&gt;</option> 格式。注意，在 <command>scp</command> 要遞迴複製目錄是使用 <option>-r</option>，如同 <command>cp</command> 使用 <option>-R</option>。</para>

      <para>要開啟可互動的連線來複製檔案可使用 <command>sftp</command>，請參考 <citerefentry><refentrytitle>sftp</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來取得在 <command>sftp</command> 連線時可用的指令清單。</para>

      <sect3 xml:id="security-ssh-keygen">
	<title>以金鑰為基礎的認證</title>

	<para>除了使用密碼之外，客戶端可以設定成使用金鑰來連線到遠端的主機。要產生 <acronym>RSA</acronym> 認証金鑰可使用 <command>ssh-keygen</command>。要產生成對的公鑰與私鑰，可指定金鑰的類型並依提示操作。建議使用容易記住但較難猜出的密碼來保護這個金鑰。</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>ssh-keygen -t rsa</userinput>
Generating public/private rsa key pair.
Enter file in which to save the key (/home/user/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):  <co xml:id="co-ssh-keygen-passphrase1"/>
Enter same passphrase again:                 <co xml:id="co-ssh-keygen-passphrase2"/>
Your identification has been saved in /home/user/.ssh/id_rsa.
Your public key has been saved in /home/user/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:54Xm9Uvtv6H4NOo6yjP/YCfODryvUU7yWHzMqeXwhq8 user@host.example.com
The key's randomart image is:
+---[RSA 2048]----+
|                 |
|                 |
|                 |
|        . o..    |
|       .S*+*o    |
|      . O=Oo . . |
|       = Oo= oo..|
|      .oB.* +.oo.|
|       =OE**.o..=|
+----[SHA256]-----+</screen>

	<calloutlist>
	  <callout arearefs="co-ssh-keygen-passphrase1">
	    <para>在此輸入密碼，密碼不可含有空白或符號。</para>
	  </callout>

	  <callout arearefs="co-ssh-keygen-passphrase2">
	    <para>再輸入一次密碼驗證。</para>
	  </callout>
	</calloutlist>


	<para>私鑰會儲存於 <filename>~/.ssh/id_rsa</filename> 而公鑰會儲存於 <filename>~/.ssh/id_rsa.pub</filename>。<emphasis>公鑰</emphasis>必須複製到遠端主機的<filename>~/.ssh/authorized_keys</filename> 來讓以金鑰為基礎的認証可以運作。</para>

	<warning>
	  <para>許多使用者認為金鑰的設計是安全的並在產生金鑰時未使用密碼，這樣的行為其實很<emphasis>危險</emphasis>。管理者可以手動查看私鑰來檢查金鑰對是否受密碼保護，如果私鑰檔案中包含 <literal>ENCRYPTED</literal> 字詞，則代表金鑰的擁有者有使用密碼。此外，要更進一步保護最終使用者的安全，可在公鑰檔案中放入 <literal>from</literal>，例如，在 <literal>ssh-rsa</literal> 前加上 <literal>from="192.168.10.5"</literal> 將只允許指定的使用者由該 IP 位址登入。</para>
	</warning>

	<para>不同版本 <application>OpenSSH</application> 的選項與檔案會不同，要避免發生問題請參考 <citerefentry><refentrytitle>ssh-keygen</refentrytitle><manvolnum>1</manvolnum></citerefentry>。</para>

	<para>若使用了密碼，在每次連線到伺服器時都會提示使用者輸入密碼。要將 <acronym>SSH</acronym> 金鑰載入到記憶體並讓每次連線時不必再輸入密碼，可使用 <citerefentry><refentrytitle>ssh-agent</refentrytitle><manvolnum>1</manvolnum></citerefentry> 與 <citerefentry><refentrytitle>ssh-add</refentrytitle><manvolnum>1</manvolnum></citerefentry>。</para>

	<para>認証可用 <command>ssh-agent</command> 來管理，只要將私鑰載入，<command>ssh-agent</command> 可用在執行其他應用程式，如 Shell 或視窗管理程式。</para>

	<para>要在 Shell 使用 <command>ssh-agent</command>，使用 Shell 做為參數來啟動 <command>ssh-agent</command>。執行 <command>ssh-add</command> 來加入識別碼，然後輸入私鑰的密碼。使用者將可使用 <command>ssh</command> 連線到任何有安裝對應公鑰的主機，例如：</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>ssh-agent <replaceable>csh</replaceable></userinput>
<prompt>%</prompt> <userinput>ssh-add</userinput>
Enter passphrase for key '/usr/home/user/.ssh/id_rsa':  <co xml:id="co-ssh-agent-passphrase"/>
Identity added: /usr/home/user/.ssh/id_rsa (/usr/home/user/.ssh/id_rsa)
<prompt>%</prompt></screen>

	<calloutlist>
	  <callout arearefs="co-ssh-agent-passphrase">
	    <para>輸入金鑰的密碼。</para>
	  </callout>
	</calloutlist>

	<para>要在 <application>Xorg</application> 使用 <command>ssh-agent</command> 可在 <filename>~/.xinitrc</filename> 加入一個設定項目，這可讓 <command>ssh-agent</command> 對所有在 <application>Xorg</application> 中執行的程式提供服務。<filename>~/.xinitrc</filename> 範例如下：</para>

	<programlisting xml:lang="en">exec ssh-agent <replaceable>startxfce4</replaceable></programlisting>

	<para>這會在每次啟動 <application>Xorg</application> 時，反過來先執行 <command>ssh-agent</command> 再由執行 <application>XFCE</application>，一但 <application>Xorg</application> 被重新啟動，要讓所有變更生效需執行 <command>ssh-add</command> 來載入所有的 <acronym>SSH</acronym> 金鑰。</para>
      </sect3>

      <sect3 xml:id="security-ssh-tunneling">
	<title><acronym>SSH</acronym> 通道</title>

	<indexterm xml:lang="en">
	  <primary>OpenSSH</primary>
	  <secondary>tunneling</secondary>
	</indexterm>

	<para><application>OpenSSH</application> 可以建立一個通道 (Tunnel) 來封裝其他通訊協定到一個加密的連線。</para>

	<para>以下指令會告訴 <command>ssh</command> 建立一個供 <application>telnet</application> 使用的通道：</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>ssh -2 -N -f -L <replaceable>5023:localhost:23 user@foo.example.com</replaceable></userinput>
<prompt>%</prompt></screen>

	<para>這個例子使用了以下選項：</para>

	<variablelist>
	  <varlistentry>
	    <term xml:lang="en"><option>-2</option></term>

	    <listitem>
	      <para>強制 <command>ssh</command> 使用版本 2 的通訊協定連線到伺服器。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term xml:lang="en"><option>-N</option></term>

	    <listitem>
	      <para>代表不需下指令、只建立通道。若省略這個選項 <command>ssh</command> 會初始化一個正常的連線。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term xml:lang="en"><option>-f</option></term>

	    <listitem>
	      <para>強制 <command>ssh</command> 在背景執行。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term xml:lang="en"><option>-L</option></term>

	    <listitem>
	      <para>代表這是一個本地通道，使用 <replaceable>localport:remotehost:remoteport</replaceable> 格式。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term xml:lang="en"><option>user@foo.example.com</option></term>

	    <listitem>
	      <para>在指定的遠端 <acronym>SSH</acronym> 伺服器要使用的登入名稱。</para>
	    </listitem>
	  </varlistentry>
	</variablelist>

	<para>SSH 通道會建立一個傾聽 <systemitem>localhost</systemitem> 指定 <literal>localport</literal> 的 Socket ，然後會透過 <acronym>SSH</acronym>  連線轉送任何在 <literal>localport</literal> 接收的連線。以這個例子來說在客戶端的 Port <literal>5023</literal> 會被轉送到遠端主機的 Port <literal>23</literal>，由於 Port 23 是由 <application>telnet</application> 使用，所以這會透過 <acronym>SSH</acronym> 通道建立一個加密的 <application>telnet</application> 連線。</para>

	<para>這個方法可用來包裝許多不安全的 <acronym>TCP</acronym> 通訊協定，例如 <acronym>SMTP</acronym>, <acronym>POP3</acronym> 以及 <acronym>FTP</acronym>，如下例所示。</para>

	<example>
	  <title>建立供 <acronym>SMTP</acronym> 使用的安全通道</title>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>ssh -2 -N -f -L <replaceable>5025:localhost:25 user@mailserver.example.com</replaceable></userinput>
user@mailserver.example.com's password: <userinput>*****</userinput>
<prompt>%</prompt> <userinput>telnet localhost 5025</userinput>
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
220 mailserver.example.com ESMTP</screen>

	  <para>這可配合 <command>ssh-keygen</command> 與另一個使用者帳號與來建立一個更無縫的 <acronym>SSH</acronym> 通道環境，可使用金鑰來代替手動輸入密碼，然後該通道便可以另一個使用者執行。</para>
	</example>

	<example>
	  <title>安全存取 <acronym>POP3</acronym> 伺服器</title>

	  <para>在這個例子中有一個 <acronym>SSH</acronym> 伺服器會接受來自外部的連線，在同個網段下有一個郵件伺服器執行 <acronym>POP3</acronym> 伺服器。要使用較安全的方式檢查有沒有新郵件可建立一個 <acronym>SSH</acronym> 連線到 <acronym>SSH</acronym> 伺服器然後透過通道連線到郵件伺服器：</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>ssh -2 -N -f -L <replaceable>2110:mail.example.com:110 user@ssh-server.example.com</replaceable></userinput>
user@ssh-server.example.com's password: <userinput>******</userinput></screen>

	  <para>一但通道啟動並執行後，指定郵件客戶端將 <acronym>POP3</acronym> 請求傳送到 <systemitem>localhost</systemitem> 的 Port 2110，這個連線將會被安全的透過通道轉送到 <systemitem>mail.example.com</systemitem>。</para>
	</example>

	<example>
	  <title>跳過防火牆</title>

	  <para>有些防火牆會同時過濾傳入與傳出的連線。例如，防火牆很可能會限制來自遠端主機只能存取 Port 22 與 80 來只讓 <acronym>SSH</acronym> 與網頁瀏覽器連線，這會使得 Port 使用 22 或 80 以外的服務無法存取。</para>

	  <para>這問題的解決方法是建立一個 <acronym>SSH</acronym> 連線到在防火牆防護之外主機然後使用該連線的通道連到想要使用的服務：</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>ssh -2 -N -f -L <replaceable>8888:music.example.com:8000 user@unfirewalled-system.example.org</replaceable></userinput>
user@unfirewalled-system.example.org's password: <userinput>*******</userinput></screen>

	  <para>在這個例子中，串流 Ogg Vorbis 客戶端現在可以指向 <systemitem>localhost</systemitem> Port 8888，連線將會被轉送到 <systemitem>music.example.com</systemitem> 於 Port 8000，成功的跳過防火牆。</para>
	</example>
      </sect3>
    </sect2>

    <sect2>
      <title>開啟 SSH 伺服器</title>

      <indexterm xml:lang="en">
	<primary>OpenSSH</primary>
	<secondary>enabling</secondary>
      </indexterm>

      <para>除了提供內建的 <acronym>SSH</acronym> 客戶端工具外，還可以設定 FreeBSD 系統為一個 <acronym>SSH</acronym> 伺服器，以接受來自其他 <acronym>SSH</acronym> 客戶端的連線。</para>

      <para>要查看 <application>sshd</application> 是否正在運作，可使用 <citerefentry><refentrytitle>service</refentrytitle><manvolnum>8</manvolnum></citerefentry> 指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service sshd status</userinput></screen>

      <para>若服務未執行，請加入下行到 <filename>/etc/rc.conf</filename>。</para>

      <programlisting xml:lang="en">sshd_enable="YES"</programlisting>

      <para>這會讓下次系統開機時啟動 <application>OpenSSH</application> 的 Daemon 程式 <application>sshd</application>。若要立即啟動：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service sshd start</userinput></screen>

      <para>在 FreeBSD 系統第一次啟動 <application>sshd</application> 時便會自動產生系統的主機金鑰且會顯示指紋在  Console 上，這個指紋可供使用者在第一次連線到伺服器時驗證用。</para>

      <para>請參考 <citerefentry><refentrytitle>sshd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 可取得在啟動 <application>sshd</application> 時可用選項的清單以及更多完整有關認証、登入程序與各種設定檔的資訊。</para>

      <para>現在，<application>sshd</application> 應可供所有在系統上有使用者名稱及密碼的使用者使用。</para>
    </sect2>

    <sect2>
      <title>SSH 伺服器安全性</title>

      <para>在 FreeBSD 廣泛使用 <application>sshd</application> 做為遠端管理基礎設施的同時，所有暴露在公有網路上的系統也會時常受到暴力攻擊 (Brute force attack) 與路過攻擊 (Drive by attack)。在本節會介紹一些可用來避免這些攻擊的參數。</para>

      <para>使用在 <application>OpenSSH</application> 伺服器設定檔的 <literal>AllowUsers</literal> 關鍵字限制可以登入到 <acronym>SSH</acronym> 伺服器的使用者及來源是一個不錯的方式。例如要只允許來自 <systemitem class="ipaddress">192.168.1.32</systemitem> 的 <systemitem class="username">root</systemitem> 登入，可加入下行到 <filename>/etc/ssh/sshd_config</filename>：</para>

      <programlisting xml:lang="en">AllowUsers root@192.168.1.32</programlisting>

      <para>要允許來自任何地方的 <systemitem class="username">admin</systemitem> 登入，可只列出使用者名稱，不指定 <acronym>IP</acronym> 位址：</para>

      <programlisting xml:lang="en">AllowUsers admin</programlisting>

      <para>有多位使用者也應列在同一行，例如：</para>

      <programlisting xml:lang="en">AllowUsers root@192.168.1.32 admin</programlisting>

      <para>在對 <filename>/etc/ssh/sshd_config</filename> 做完變更後，執行以下指令告訴 <application>sshd</application> 重新載入設定檔：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service sshd reload</userinput></screen>

      <note>
	<para>在使用了這個關鍵字時，列出每一位需要登入此主機的使用者很重要，任何未被在該行指定的使用者將無法登入。同時，在 <application>OpenSSH</application> 伺服器設定檔使用的關鍵字是區分大小寫的，若關鍵字未正確的拼寫 (含其大小寫)，則將會被忽略，永遠要記得測試對這個檔案所做的更改來確保伺服器有如預期的方式運作。請參考 <citerefentry><refentrytitle>sshd_config</refentrytitle><manvolnum>5</manvolnum></citerefentry> 來檢查拼寫以及可用的關鍵字。</para>
      </note>

      <para>此外，使用者可能被強制要透過公鑰與私鑰使用雙重認證 (Two factor authentication)。當需要時，使用者可以透過使用 <citerefentry><refentrytitle>ssh-keygen</refentrytitle><manvolnum>1</manvolnum></citerefentry> 產生一堆金鑰然後將公鑰傳送給管理者，這個金鑰檔會如以上在客戶端章節所述的被放在 <filename>authorized_keys</filename>。要強制使用者只能使用這個金鑰，可能需要設定以下選項：</para>

      <programlisting xml:lang="en">AuthenticationMethods publickey</programlisting>

      <tip>
	<para>請不要將 <filename>/etc/ssh/sshd_config</filename> 以及 <filename>/etc/ssh/ssh_config</filename> 搞混 (注意在第一節檔名有多出個 <literal>d</literal>)，第一個檔案用來設定伺服器，而第二個檔案用來設定客戶端。請參考 <citerefentry><refentrytitle>ssh_config</refentrytitle><manvolnum>5</manvolnum></citerefentry> 來取得可用的客戶端設定清單。</para>
      </tip>
    </sect2>
  </sect1>

  <sect1 xml:id="fs-acl">
    <info>
      <title>存取控制清單</title>

      <authorgroup>
	<author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Contributed
	  by </contrib></author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>ACL</primary>
    </indexterm>

    <para xml:lang="en">Access Control Lists (<acronym>ACL</acronym>s) extend the
      standard <trademark class="registered">UNIX</trademark> permission model in a <trademark class="registered">POSIX</trademark>.1e compatible way.
      This permits an administrator to take advantage of a more
      fine-grained permissions model.</para>

    <para xml:lang="en">The FreeBSD <filename>GENERIC</filename> kernel provides
      <acronym>ACL</acronym> support for <acronym>UFS</acronym> file
      systems.  Users who prefer to compile a custom kernel must
      include the following option in their custom kernel
      configuration file:</para>

    <programlisting xml:lang="en">options UFS_ACL</programlisting>

    <para xml:lang="en">If this option is not compiled in, a warning message will be
      displayed when attempting to mount a file system with
      <acronym>ACL</acronym> support.  <acronym>ACL</acronym>s rely on
      extended attributes which are natively supported in
      <acronym>UFS2</acronym>.</para>

    <para xml:lang="en">This chapter describes how to enable
      <acronym>ACL</acronym> support and provides some usage
      examples.</para>

    <sect2>
      <title>開啟 <acronym>ACL</acronym> 支援</title>

      <para xml:lang="en"><acronym>ACL</acronym>s are enabled by the mount-time
	administrative flag, <option>acls</option>, which may be added
	to <filename>/etc/fstab</filename>.  The mount-time flag can
	also be automatically set in a persistent manner using
	<citerefentry><refentrytitle>tunefs</refentrytitle><manvolnum>8</manvolnum></citerefentry> to modify a superblock <acronym>ACL</acronym>s
	flag in the file system header.  In general, it is preferred
	to use the superblock flag for several reasons:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">The superblock flag cannot be changed by a remount
	    using <option>mount -u</option> as it requires a complete
	    <command>umount</command> and fresh
	    <command>mount</command>.  This means that
	    <acronym>ACL</acronym>s cannot be enabled on the root file
	    system after boot.  It also means that
	    <acronym>ACL</acronym> support on a file system cannot be
	    changed while the system is in use.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Setting the superblock flag causes the file system to
	    always be mounted with <acronym>ACL</acronym>s enabled,
	    even if there is not an <filename>fstab</filename> entry
	    or if the devices re-order.  This prevents accidental
	    mounting of the file system without <acronym>ACL</acronym>
	    support.</para>
	</listitem>
      </itemizedlist>

      <note>
	<para xml:lang="en">It is desirable to discourage accidental mounting
	  without <acronym>ACL</acronym>s enabled because nasty things
	  can happen if <acronym>ACL</acronym>s are enabled, then
	  disabled, then re-enabled without flushing the extended
	  attributes.  In general, once <acronym>ACL</acronym>s are
	  enabled on a file system, they should not be disabled, as
	  the resulting file protections may not be compatible with
	  those intended by the users of the system, and re-enabling
	  <acronym>ACL</acronym>s may re-attach the previous
	  <acronym>ACL</acronym>s to files that have since had their
	  permissions changed, resulting in unpredictable
	  behavior.</para>
      </note>

      <para xml:lang="en">File systems with <acronym>ACL</acronym>s enabled will
	show a plus (<literal>+</literal>) sign in their permission
	settings:</para>

      <programlisting xml:lang="en">drwx------  2 robert  robert  512 Dec 27 11:54 private
drwxrwx---+ 2 robert  robert  512 Dec 23 10:57 directory1
drwxrwx---+ 2 robert  robert  512 Dec 22 10:20 directory2
drwxrwx---+ 2 robert  robert  512 Dec 27 11:57 directory3
drwxr-xr-x  2 robert  robert  512 Nov 10 11:54 public_html</programlisting>

      <para xml:lang="en">In this example, <filename>directory1</filename>,
	<filename>directory2</filename>, and
	<filename>directory3</filename> are all taking advantage of
	<acronym>ACL</acronym>s, whereas
	<filename>public_html</filename> is not.</para>
    </sect2>

    <sect2>
      <title>使用 <acronym>ACL</acronym></title>

      <para xml:lang="en">File system <acronym>ACL</acronym>s can be viewed using
	<command>getfacl</command>.  For instance, to view the
	<acronym>ACL</acronym> settings on
	<filename>test</filename>:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>getfacl test</userinput>
	#file:test
	#owner:1001
	#group:1001
	user::rw-
	group::r--
	other::r--</screen>

      <para xml:lang="en">To change the <acronym>ACL</acronym> settings on this
	file, use <command>setfacl</command>.  To remove all of the
	currently defined <acronym>ACL</acronym>s from a file or file
	system, include <option>-k</option>.  However, the preferred
	method is to use <option>-b</option> as it leaves the basic
	fields required for <acronym>ACL</acronym>s to work.</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>setfacl -k test</userinput></screen>

      <para xml:lang="en">To modify the default <acronym>ACL</acronym> entries, use
	<option>-m</option>:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>setfacl -m u:trhodes:rwx,group:web:r--,o::--- test</userinput></screen>

      <para xml:lang="en">In this example, there were no pre-defined entries, as
	they were removed by the previous command.  This command
	restores the default options and assigns the options listed.
	If a user or group is added which does not exist on the
	system, an <errorname>Invalid argument</errorname> error will
	be displayed.</para>

      <para xml:lang="en">Refer to <citerefentry><refentrytitle>getfacl</refentrytitle><manvolnum>1</manvolnum></citerefentry> and <citerefentry><refentrytitle>setfacl</refentrytitle><manvolnum>1</manvolnum></citerefentry> for more
	information about the options available for these
	commands.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="security-pkg">
    <info>
      <title>監視第三方安全性問題</title>

      <authorgroup>
	<author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Contributed
	  by </contrib></author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>pkg</primary>
    </indexterm>

    <para xml:lang="en">In recent years, the security world has made many
      improvements to how vulnerability assessment is handled.  The
      threat of system intrusion increases as third party utilities
      are installed and configured for virtually any operating
      system available today.</para>

    <para xml:lang="en">Vulnerability assessment is a key factor in security.
      While FreeBSD releases advisories for the base system, doing so
      for every third party utility is beyond the FreeBSD Project's
      capability.  There is a way to mitigate third party
      vulnerabilities and warn administrators of known security
      issues.  A FreeBSD add on utility known as
      <application>pkg</application> includes options explicitly for
      this purpose.</para>

    <para xml:lang="en"><application>pkg</application> polls a database for security
      issues.  The database is updated and maintained by the FreeBSD
      Security Team and ports developers.</para>

    <para xml:lang="en">Please refer to <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/books/handbook/pkgng-intro.html">instructions</link>
      for installing
      <application>pkg</application>.</para>

    <para xml:lang="en">Installation provides <citerefentry><refentrytitle>periodic</refentrytitle><manvolnum>8</manvolnum></citerefentry> configuration files
      for maintaining the <application>pkg</application> audit
      database, and provides a programmatic method of keeping it
      updated.  This functionality is enabled if
      <literal>daily_status_security_pkgaudit_enable</literal>
      is set to <literal>YES</literal> in <citerefentry><refentrytitle>periodic.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.
      Ensure that daily security run emails, which are sent to
      <systemitem class="username">root</systemitem>'s email account,
      are being read.</para>

    <para xml:lang="en">After installation, and to audit third party utilities as
      part of the Ports Collection at any time, an administrator may
      choose to update the database and view known vulnerabilities
      of installed packages by invoking:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg audit -F</userinput></screen>

    <para xml:lang="en"><application>pkg</application> displays messages
      any published vulnerabilities in installed packages:</para>

    <programlisting xml:lang="en">Affected package: cups-base-1.1.22.0_1
Type of problem: cups-base -- HPGL buffer overflow vulnerability.
Reference: &lt;https://www.FreeBSD.org/ports/portaudit/40a3bca2-6809-11d9-a9e7-0001020eed82.html&gt;

1 problem(s) in your installed packages found.

You are advised to update or deinstall the affected package(s) immediately.</programlisting>

    <para xml:lang="en">By pointing a web browser to the displayed
      <acronym>URL</acronym>, an administrator may obtain more
      information about the vulnerability.  This will include the
      versions affected, by FreeBSD port version, along with other web
      sites which may contain security advisories.</para>

    <para xml:lang="en"><application>pkg</application> is a powerful utility
      and is extremely useful when coupled with
      <package>ports-mgmt/portmaster</package>.</para>
  </sect1>

  <sect1 xml:id="security-advisories">
    <info>
      <title>FreeBSD 安全報告</title>

      <authorgroup>
	<author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Contributed
	  by </contrib></author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>FreeBSD Security Advisories</primary>
    </indexterm>

    <para xml:lang="en">Like many producers of quality operating systems, the FreeBSD
      Project has a security team which is responsible for
      determining the End-of-Life (<acronym>EoL</acronym>) date for
      each FreeBSD release and to provide security updates for supported
      releases which have not yet reached their
      <acronym>EoL</acronym>.  More information about the FreeBSD
      security team and the supported releases is available on the
      <link xlink:href="@@URL_RELPREFIX@@/security">FreeBSD security
	page</link>.</para>

    <para xml:lang="en">One task of the security team is to respond to reported
      security vulnerabilities in the FreeBSD operating system.  Once a
      vulnerability is confirmed, the security team verifies the steps
      necessary to fix the vulnerability and updates the source code
      with the fix.  It then publishes the details as a
      <quote>Security Advisory</quote>.  Security
      advisories are published on the <link xlink:href="@@URL_RELPREFIX@@/security/advisories.html">FreeBSD
	website</link> and mailed to the
      <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-security-notifications">freebsd-security-notifications</link>, <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-security">freebsd-security</link>, and
      <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-announce">freebsd-announce</link> mailing lists.</para>

    <para xml:lang="en">This section describes the format of a FreeBSD security
      advisory.</para>

    <sect2>
      <title>安全報告的格式</title>

      <para xml:lang="en">Here is an example of a FreeBSD security advisory:</para>

      <programlisting xml:lang="en">=============================================================================
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

=============================================================================
FreeBSD-SA-14:04.bind                                       Security Advisory
                                                          The FreeBSD Project

Topic:          BIND remote denial of service vulnerability

Category:       contrib
Module:         bind
Announced:      2014-01-14
Credits:        ISC
Affects:        FreeBSD 8.x and FreeBSD 9.x
Corrected:      2014-01-14 19:38:37 UTC (stable/9, 9.2-STABLE)
                2014-01-14 19:42:28 UTC (releng/9.2, 9.2-RELEASE-p3)
                2014-01-14 19:42:28 UTC (releng/9.1, 9.1-RELEASE-p10)
                2014-01-14 19:38:37 UTC (stable/8, 8.4-STABLE)
                2014-01-14 19:42:28 UTC (releng/8.4, 8.4-RELEASE-p7)
                2014-01-14 19:42:28 UTC (releng/8.3, 8.3-RELEASE-p14)
CVE Name:       CVE-2014-0591

For general information regarding FreeBSD Security Advisories,
including descriptions of the fields above, security branches, and the
following sections, please visit &lt;URL:http://security.FreeBSD.org/&gt;.

I.   Background

BIND 9 is an implementation of the Domain Name System (DNS) protocols.
The named(8) daemon is an Internet Domain Name Server.

II.  Problem Description

Because of a defect in handling queries for NSEC3-signed zones, BIND can
crash with an "INSIST" failure in name.c when processing queries possessing
certain properties.  This issue only affects authoritative nameservers with
at least one NSEC3-signed zone.  Recursive-only servers are not at risk.

III. Impact

An attacker who can send a specially crafted query could cause named(8)
to crash, resulting in a denial of service.

IV.  Workaround

No workaround is available, but systems not running authoritative DNS service
with at least one NSEC3-signed zone using named(8) are not vulnerable.

V.   Solution

Perform one of the following:

1) Upgrade your vulnerable system to a supported FreeBSD stable or
release / security branch (releng) dated after the correction date.

2) To update your vulnerable system via a source code patch:

The following patches have been verified to apply to the applicable
FreeBSD release branches.

a) Download the relevant patch from the location below, and verify the
detached PGP signature using your PGP utility.

[FreeBSD 8.3, 8.4, 9.1, 9.2-RELEASE and 8.4-STABLE]
# fetch http://security.FreeBSD.org/patches/SA-14:04/bind-release.patch
# fetch http://security.FreeBSD.org/patches/SA-14:04/bind-release.patch.asc
# gpg --verify bind-release.patch.asc

[FreeBSD 9.2-STABLE]
# fetch http://security.FreeBSD.org/patches/SA-14:04/bind-stable-9.patch
# fetch http://security.FreeBSD.org/patches/SA-14:04/bind-stable-9.patch.asc
# gpg --verify bind-stable-9.patch.asc

b) Execute the following commands as root:

# cd /usr/src
# patch &lt; /path/to/patch

Recompile the operating system using buildworld and installworld as
described in &lt;URL:https://www.FreeBSD.org/handbook/makeworld.html&gt;.

Restart the applicable daemons, or reboot the system.

3) To update your vulnerable system via a binary patch:

Systems running a RELEASE version of FreeBSD on the i386 or amd64
platforms can be updated via the freebsd-update(8) utility:

# freebsd-update fetch
# freebsd-update install

VI.  Correction details

The following list contains the correction revision numbers for each
affected branch.

Branch/path                                                      Revision
- -------------------------------------------------------------------------
stable/8/                                                         r260646
releng/8.3/                                                       r260647
releng/8.4/                                                       r260647
stable/9/                                                         r260646
releng/9.1/                                                       r260647
releng/9.2/                                                       r260647
- -------------------------------------------------------------------------

To see which files were modified by a particular revision, run the
following command, replacing NNNNNN with the revision number, on a
machine with Subversion installed:

# svn diff -cNNNNNN --summarize svn://svn.freebsd.org/base

Or visit the following URL, replacing NNNNNN with the revision number:

&lt;URL:https://svnweb.freebsd.org/base?view=revision&amp;revision=NNNNNN&gt;

VII. References

&lt;URL:https://kb.isc.org/article/AA-01078&gt;

&lt;URL:http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0591&gt;

The latest revision of this advisory is available at
&lt;URL:http://security.FreeBSD.org/advisories/FreeBSD-SA-14:04.bind.asc&gt;
-----BEGIN PGP SIGNATURE-----

iQIcBAEBCgAGBQJS1ZTYAAoJEO1n7NZdz2rnOvQP/2/68/s9Cu35PmqNtSZVVxVG
ZSQP5EGWx/lramNf9566iKxOrLRMq/h3XWcC4goVd+gZFrvITJSVOWSa7ntDQ7TO
XcinfRZ/iyiJbs/Rg2wLHc/t5oVSyeouyccqODYFbOwOlk35JjOTMUG1YcX+Zasg
ax8RV+7Zt1QSBkMlOz/myBLXUjlTZ3Xg2FXVsfFQW5/g2CjuHpRSFx1bVNX6ysoG
9DT58EQcYxIS8WfkHRbbXKh9I1nSfZ7/Hky/kTafRdRMrjAgbqFgHkYTYsBZeav5
fYWKGQRJulYfeZQ90yMTvlpF42DjCC3uJYamJnwDIu8OhS1WRBI8fQfr9DRzmRua
OK3BK9hUiScDZOJB6OqeVzUTfe7MAA4/UwrDtTYQ+PqAenv1PK8DZqwXyxA9ThHb
zKO3OwuKOVHJnKvpOcr+eNwo7jbnHlis0oBksj/mrq2P9m2ueF9gzCiq5Ri5Syag
Wssb1HUoMGwqU0roS8+pRpNC8YgsWpsttvUWSZ8u6Vj/FLeHpiV3mYXPVMaKRhVm
067BA2uj4Th1JKtGleox+Em0R7OFbCc/9aWC67wiqI6KRyit9pYiF3npph+7D5Eq
7zPsUdDd+qc+UTiLp3liCRp5w6484wWdhZO6wRtmUgxGjNkxFoNnX8CitzF8AaqO
UWWemqWuz3lAZuORQ9KX
=OQzQ
-----END PGP SIGNATURE-----</programlisting>

      <para xml:lang="en">Every security advisory uses the following format:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Each security advisory is signed by the
	    <acronym>PGP</acronym> key of the Security Officer.  The
	    public key for the Security Officer can be verified at
	    <xref linkend="pgpkeys"/>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The name of the security advisory always begins with
	    <literal>FreeBSD-SA-</literal> (for FreeBSD Security
	    Advisory), followed by the year in two digit format
	    (<literal>14:</literal>), followed by the advisory number
	    for that year (<literal>04.</literal>), followed by the
	    name of the affected application or subsystem
	    (<literal>bind</literal>).  The advisory shown here is the
	    fourth advisory for 2014 and it affects
	    <application>BIND</application>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Topic</literal> field summarizes the
	    vulnerability.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Category</literal> refers to the
	    affected part of the system which may be one of
	    <literal>core</literal>, <literal>contrib</literal>, or
	    <literal>ports</literal>.  The <literal>core</literal>
	    category means that the vulnerability affects a core
	    component of the FreeBSD operating system.  The
	    <literal>contrib</literal> category means that the
	    vulnerability affects software included with  FreeBSD,
	    such as <application>BIND</application>.  The
	    <literal>ports</literal> category indicates that the
	    vulnerability affects software available through the Ports
	    Collection.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Module</literal> field refers to the
	    component location.  In this example, the
	    <literal>bind</literal> module is affected; therefore,
	    this vulnerability affects an application installed with
	    the operating system.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Announced</literal> field reflects the
	    date the security advisory was published.  This means
	    that the security team has verified that the problem
	    exists and that a patch has been committed to the FreeBSD
	    source code repository.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Credits</literal> field gives credit to
	    the individual or organization who noticed the
	    vulnerability and reported it.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Affects</literal> field explains which
	    releases of FreeBSD are affected by this
	    vulnerability.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Corrected</literal> field indicates the
	    date, time, time offset, and releases that were
	    corrected.  The section in parentheses shows each branch
	    for which the fix has been merged, and the version number
	    of the corresponding release from that branch.  The
	    release identifier itself includes the version number
	    and, if appropriate, the patch level.  The patch level is
	    the letter <literal>p</literal> followed by a number,
	    indicating the sequence number of the patch, allowing
	    users to track which patches have already been applied to
	    the system.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>CVE Name</literal> field lists the
	    advisory number, if one exists, in the public <link xlink:href="http://cve.mitre.org">cve.mitre.org</link>
	    security vulnerabilities database.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Background</literal> field provides a
	    description of the affected module.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Problem Description</literal> field
	    explains the vulnerability.  This can include
	    information about the flawed code and how the utility
	    could be maliciously used.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Impact</literal> field describes what
	    type of impact the problem could have on a system.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Workaround</literal> field indicates if
	    a workaround is available to system administrators who
	    cannot immediately patch the system .</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Solution</literal> field provides the
	    instructions for patching the affected system.  This is a
	    step by step tested and verified method for getting a
	    system patched and working securely.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>Correction Details</literal> field
	    displays each affected Subversion branch with the revision
	    number that contains the corrected code.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <literal>References</literal> field offers sources
	    of additional information regarding the
	    vulnerability.</para>
	</listitem>
      </itemizedlist>
    </sect2>
  </sect1>

  <sect1 xml:id="security-accounting">
    <info>
      <title>程序追蹤</title>

      <authorgroup>
	<author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Contributed
	  by </contrib></author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>Process Accounting</primary>
    </indexterm>

    <para xml:lang="en">Process accounting is a security method in which an
      administrator may keep track of system resources used and
      their allocation among users, provide for system monitoring,
      and minimally track a user's commands.</para>

    <para xml:lang="en">Process accounting has both positive and negative points.
      One of the positives is that an intrusion may be narrowed down
      to the point of entry.  A negative is the amount of logs
      generated by process accounting, and the disk space they may
      require.  This section walks an administrator through the basics
      of process accounting.</para>

    <note>
      <para xml:lang="en">If more fine-grained accounting is needed, refer to
	<xref linkend="audit"/>.</para>
    </note>

    <sect2>
      <title>開啟並使用程序追蹤</title>

      <para xml:lang="en">Before using process accounting, it must be enabled using
	the following commands:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc accounting_enable=yes</userinput>
<prompt>#</prompt> <userinput>service accounting start</userinput></screen>

      <para xml:lang="en">The accounting information is stored in files located in
	<filename>/var/account</filename>, which is automatically created,
	if necessary, the first time the accounting service starts.
	These files contain sensitive information, including all the
	commands issued by all users.  Write access to the files is
	limited to <systemitem class="username">root</systemitem>,
	and read access is limited to <systemitem class="username">root</systemitem> and members of the
	<systemitem class="groupname">wheel</systemitem> group.
	To also prevent	members of <systemitem class="groupname">wheel</systemitem> from reading the files,
	change the mode of the <filename>/var/account</filename>
	directory to allow access only by <systemitem class="username">root</systemitem>.</para>

      <para xml:lang="en">Once enabled, accounting will begin to track information
	such as <acronym>CPU</acronym> statistics and executed
	commands.  All accounting logs are in a non-human readable
	format which can be viewed using <command>sa</command>.  If
	issued without any options, <command>sa</command> prints
	information relating to the number of per-user calls, the
	total elapsed time in minutes, total <acronym>CPU</acronym>
	and user time in minutes, and the average number of
	<acronym>I/O</acronym> operations.  Refer to <citerefentry><refentrytitle>sa</refentrytitle><manvolnum>8</manvolnum></citerefentry> for
	the list of available options which control the output.</para>

      <para xml:lang="en">To display the commands issued by users, use
	<command>lastcomm</command>.  For example, this command
	prints out all usage of <command>ls</command> by <systemitem class="username">trhodes</systemitem> on the
	<literal>ttyp1</literal> terminal:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>lastcomm ls trhodes ttyp1</userinput></screen>

      <para xml:lang="en">Many other useful options exist and are explained in
	<citerefentry><refentrytitle>lastcomm</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <citerefentry><refentrytitle>acct</refentrytitle><manvolnum>5</manvolnum></citerefentry>, and <citerefentry><refentrytitle>sa</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="security-resourcelimits">
    <info>
      <title>限制資源</title>

      <authorgroup>
	<author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Contributed
	  by </contrib></author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>Resource limits</primary>
    </indexterm>

      <para xml:lang="en">FreeBSD provides several methods for an administrator to
	limit the amount of system resources an individual may use.
	Disk quotas limit the amount of disk space available to users.
	Quotas are discussed in <xref linkend="quotas"/>.</para>

      <indexterm xml:lang="en">
	<primary>quotas</primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>limiting users</primary>
	<secondary>quotas</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>disk quotas</primary>
      </indexterm>

    <para xml:lang="en">Limits to other resources, such as <acronym>CPU</acronym>
      and memory, can be set using either a flat file or a command to
      configure a resource limits database.  The traditional method
      defines login classes by editing
      <filename>/etc/login.conf</filename>.  While this method is
      still supported, any changes require a multi-step process of
      editing this file, rebuilding the resource database, making
      necessary changes to <filename>/etc/master.passwd</filename>,
      and rebuilding the password database.  This can become time
      consuming, depending upon the number of users to
      configure.</para>

    <para xml:lang="en"><command>rctl</command> can be used to provide a more
      fine-grained method for controlling resource limits.  This
      command supports more than user limits as it can also be used to
      set resource constraints on processes and jails.</para>

    <para xml:lang="en">This section demonstrates both methods for controlling
      resources, beginning with the traditional method.</para>

    <sect2 xml:id="users-limiting">
      <title>設定登入類別</title>

      <indexterm xml:lang="en">
	<primary>limiting users</primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>accounts</primary>
	<secondary>limiting</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><filename>/etc/login.conf</filename></primary>
      </indexterm>

      <para xml:lang="en">In the traditional method, login classes and the resource
	limits to apply to a login class are defined in
	<filename>/etc/login.conf</filename>.   Each user account can
	be assigned to a login class, where <literal>default</literal>
	is the default login class.  Each login class has a set of
	login capabilities associated with it.  A login capability is
	a
	<literal><replaceable>name</replaceable>=<replaceable>value</replaceable></literal>
	pair, where <replaceable>name</replaceable> is a well-known
	identifier and <replaceable>value</replaceable> is an
	arbitrary string which is processed accordingly depending on
	the <replaceable>name</replaceable>.</para>

      <note>
	<para xml:lang="en">Whenever <filename>/etc/login.conf</filename> is edited,
	  the <filename>/etc/login.conf.db</filename> must be updated
	  by executing the following command:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cap_mkdb /etc/login.conf</userinput></screen>
      </note>

      <para xml:lang="en">Resource limits differ from the default login capabilities
	in two ways.  First, for every limit, there is a
	<firstterm>soft</firstterm> and <firstterm>hard</firstterm>
	limit.  A soft limit may be adjusted by the user or
	application, but may not be set higher than the hard limit.
	The hard limit may be lowered by the user, but can only be
	raised by the superuser.  Second, most resource limits apply
	per process to a specific user.</para>

      <para xml:lang="en"><xref linkend="resource-limits"/> lists the most commonly
	used resource limits.  All of the available resource limits
	and capabilities are described in detail in
	<citerefentry><refentrytitle>login.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

      <indexterm xml:lang="en">
	<primary>limiting users</primary>
	<secondary>coredumpsize</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>limiting users</primary>
	<secondary>cputime</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>limiting users</primary>
	<secondary>filesize</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>limiting users</primary>
	<secondary>maxproc</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>limiting users</primary>
	<secondary>memorylocked</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>limiting users</primary>
	<secondary>memoryuse</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>limiting users</primary>
	<secondary>openfiles</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>limiting users</primary>
	<secondary>sbsize</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>limiting users</primary>
	<secondary>stacksize</secondary>
      </indexterm>

      <table xml:id="resource-limits" frame="none" pgwide="1">
	<title>登入類別限制資源類型</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>限制資源</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">coredumpsize</entry>
	      <entry xml:lang="en">The limit on the size of a core file generated by
		a program is subordinate to other limits on disk
		usage, such as <literal>filesize</literal> or disk
		quotas.  This limit is often used as a less severe
		method of controlling disk space consumption.  Since
		users do not generate core files and often do not
		delete them, this setting may save them from running
		out of disk space should a large program
		crash.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">cputime</entry>
	      <entry xml:lang="en">The maximum amount of <acronym>CPU</acronym> time
		a user's process may consume.  Offending processes
		will be killed by the kernel.  This is a limit on
		<acronym>CPU</acronym> <emphasis>time</emphasis>
		consumed, not the percentage of the
		<acronym>CPU</acronym> as displayed in some of the
		fields generated by <command>top</command> and
		<command>ps</command>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">filesize</entry>
	      <entry xml:lang="en">The maximum size of a file the user may own.
		Unlike disk quotas (<xref linkend="quotas"/>), this
		limit is enforced on individual files, not the set of
		all files a user owns.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">maxproc</entry>
	      <entry xml:lang="en">The maximum number of foreground and background
		processes a user can run.  This limit may not be
		larger than the system limit specified by
		<varname>kern.maxproc</varname>.  Setting this limit
		too small may hinder a user's productivity as some
		tasks, such as compiling a large program, start lots
		of processes.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">memorylocked</entry>
	      <entry xml:lang="en">The maximum amount of memory a process may
		request to be locked into main memory using
		<citerefentry><refentrytitle>mlock</refentrytitle><manvolnum>2</manvolnum></citerefentry>.  Some system-critical programs, such as
		<citerefentry><refentrytitle>amd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, lock into main memory so that if the
		system begins to swap, they do not contribute to disk
		thrashing.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">memoryuse</entry>
	      <entry xml:lang="en">The maximum amount of memory a process may
		consume at any given time.  It includes both core
		memory and swap usage.  This is not a catch-all limit
		for restricting memory consumption, but is a good
		start.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">openfiles</entry>
	      <entry xml:lang="en">The maximum number of files a process may have
		open.  In FreeBSD, files are used to represent sockets
		and <acronym>IPC</acronym> channels, so be careful not
		to set this too low.  The system-wide limit for this
		is defined by
		<varname>kern.maxfiles</varname>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">sbsize</entry>
	      <entry xml:lang="en">The limit on the amount of network memory a user
		may consume.  This can be generally used to limit
		network communications.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">stacksize</entry>
	      <entry xml:lang="en">The maximum size of a process stack.  This alone
		is not sufficient to limit the amount of memory a
		program may use, so it should be used in conjunction
		with other limits.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para xml:lang="en">There are a few other things to remember when setting
	resource limits:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Processes started at system startup by
	    <filename>/etc/rc</filename> are assigned to the
	    <literal>daemon</literal> login class.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Although the default
	    <filename>/etc/login.conf</filename> is a good source of
	    reasonable values for most limits, they may not be
	    appropriate for every system.  Setting a limit too high
	    may open the system up to abuse, while setting it too low
	    may put a strain on productivity.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><application>Xorg</application> takes a lot of
	    resources and encourages users to run more programs
	    simultaneously.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Many limits apply to individual processes, not the
	    user as a whole.  For example, setting
	    <varname>openfiles</varname> to <literal>50</literal>
	    means that each process the user runs may open up to
	    <literal>50</literal> files.  The total amount of files a
	    user may open is the value of <literal>openfiles</literal>
	    multiplied by the value of <literal>maxproc</literal>.
	    This also applies to memory consumption.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">For further information on resource limits and login
	classes and capabilities in general, refer to
	<citerefentry><refentrytitle>cap_mkdb</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <citerefentry><refentrytitle>getrlimit</refentrytitle><manvolnum>2</manvolnum></citerefentry>, and
	<citerefentry><refentrytitle>login.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>
    </sect2>

    <sect2>
      <title>開啟並設定資源限制</title>

      <para xml:lang="en">The <varname>kern.racct.enable</varname> tunable must be
	set to a non-zero value.  Custom kernels require specific
	configuration:</para>

      <programlisting xml:lang="en">options         RACCT
options         RCTL</programlisting>

      <para xml:lang="en">Once the system has rebooted into the new kernel,
	<command>rctl</command> may be used to set rules for the
	system.</para>

      <para xml:lang="en">Rule syntax is controlled through the use of a subject,
	subject-id, resource, and action, as seen in this example
	rule:</para>

      <programlisting xml:lang="en">user:trhodes:maxproc:deny=10/user</programlisting>

      <para xml:lang="en">In this rule, the subject is <literal>user</literal>, the
	subject-id is <literal>trhodes</literal>, the resource,
	<literal>maxproc</literal>, is the maximum number of
	processes, and the action is <literal>deny</literal>, which
	blocks any new processes from being created.  This means that
	the user, <literal>trhodes</literal>, will be constrained to
	no greater than <literal>10</literal> processes.  Other
	possible actions include logging to the console, passing a
	notification to <citerefentry><refentrytitle>devd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, or sending a sigterm to the
	process.</para>

      <para xml:lang="en">Some care must be taken when adding rules.  Since this
	user is constrained to <literal>10</literal> processes, this
	example will prevent the user from performing other tasks
	after logging in and executing a
	<command>screen</command> session.  Once a resource limit has
	been hit, an error will be printed, as in this example:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>man test</userinput>
    /usr/bin/man: Cannot fork: Resource temporarily unavailable
eval: Cannot fork: Resource temporarily unavailable</screen>

      <para xml:lang="en">As another example, a jail can be prevented from exceeding
	a memory limit.  This rule could be written as:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>rctl -a jail:httpd:memoryuse:deny=2G/jail</userinput></screen>

      <para xml:lang="en">Rules will persist across reboots if they have been added
	to <filename>/etc/rctl.conf</filename>.  The format is a rule,
	without the preceding command.  For example, the previous rule
	could be added as:</para>

      <programlisting xml:lang="en"># Block jail from using more than 2G memory:
jail:httpd:memoryuse:deny=2G/jail</programlisting>

      <para xml:lang="en">To remove a rule, use <command>rctl</command> to remove it
	from the list:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>rctl -r user:trhodes:maxproc:deny=10/user</userinput></screen>

      <para xml:lang="en">A method for removing all rules is documented in
	<citerefentry><refentrytitle>rctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  However, if removing all rules for a single
	user is required, this command may be issued:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>rctl -r user:trhodes</userinput></screen>

      <para xml:lang="en">Many other resources exist which can be used to exert
	additional control over various <literal>subjects</literal>.
	See <citerefentry><refentrytitle>rctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> to learn about them.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="security-sudo">
    <info>
      <title>使用 Sudo 分享管理權限</title>

      <authorgroup>
	<author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Contributed
	  by </contrib></author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>Security</primary>
      <secondary>Sudo</secondary>
    </indexterm>

    <para>系統管理者通常會要能夠授予額外的權限給其他使用者，以讓這些使用者可以執行需權限的工作。要讓團隊成員可以存取 FreeBSD 系統來完成其特定的工作對所有管理者都會帶來挑戰，這些團隊成員通常只需要比一般使用者多出一些存取權限便可作業，但他們總是會告訴管理者若沒有超級使用者的存取權便無法完成其工作。幸好，有工具可以管理這類的需求，這樣便不需提供這麼大的權限給一般使用者。</para>

    <para>到目前為止，安全性章節已說明了如何允許已授權的使用者存取以及嘗試防止未經授權的存取，而現在有另一個問題，是由已授權的使用者擁有權限存取系統資源造成的。在很多的情況，使用者會需要存取應用程式啟動 Script 的權限或是管理者團隊需要維護系統，以往會使用標準的使用者與群組、檔案權限、甚至是 <citerefentry><refentrytitle>su</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令來管理存取權，但當應用程式需要更多存取權，更多使用者需要使用系統資源時，便需要更好的解決方案，目前最常用來解決此問題的應用程式便是 <application>Sudo</application>。</para>

    <para><application>Sudo</application> 讓管理者可以對系統指令的存取設下更嚴格的限制並提供進階的記錄功能。如同其他工具，它可自 Port 套件集取得，於其中的 <package role="port">security/sudo</package>，或使用 <citerefentry><refentrytitle>pkg</refentrytitle><manvolnum>8</manvolnum></citerefentry> 工具取得，若要使用 <citerefentry><refentrytitle>pkg</refentrytitle><manvolnum>8</manvolnum></citerefentry> 工具可：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install sudo</userinput></screen>

    <para>安裝完成之後，可用安裝的 <command>visudo</command> 以文字編輯器開啟設定檔，強烈建議使用 <command>visudo</command> 來編輯設定檔，由於它有內建的語法檢查程式可在檔案儲存之前檢驗是否有誤。</para>

    <para>設定檔由個小節所組成，透過這些小節可做常廣泛的設定，在以下的範例中，網站應用程式維護人員 user1 需要啟動、停止與重新啟動名稱為 <replaceable>webservice</replaceable> 的網站應用程式 。要授權此使用者執行這些工作的權限，可加入此行到 <filename>/usr/local/etc/sudoers</filename> 的最後：</para>

    <programlisting xml:lang="en">user1   ALL=(ALL)       /usr/sbin/service webservice *</programlisting>

    <para>現在使用者可使用此指令來啟動 <replaceable>webservice</replaceable>：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>sudo /usr/sbin/service <replaceable>webservice</replaceable> start</userinput></screen>

    <para>雖然這項設定可以讓一位使用者存取 <application>webservice</application> 服務，但在大部份組織中會有一整個網站小組負責管理該服務，因此也可以一行來授予整個群組存取權，以下步驟會建立一個網站群組、加入使用者到這個群組，然後讓該群組中的所有成員能夠管理服務：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupadd -g 6001 -n webteam</userinput></screen>

    <para>同樣使用 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 指令來加入該使用到 webteam 群組：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupmod -m user1 -n webteam</userinput></screen>

    <para>最後，在 <filename>/usr/local/etc/sudoers</filename> 中的這行設定可以讓 webteam 群組的所有成員可以管理 <replaceable>webservice</replaceable>：</para>

    <programlisting xml:lang="en">%webteam   ALL=(ALL)       /usr/sbin/service webservice *</programlisting>

    <para>與 <citerefentry><refentrytitle>su</refentrytitle><manvolnum>1</manvolnum></citerefentry> 不同的是 <application>Sudo</application> 只需要一般使用者的密碼，這有一個使用者不需要共用密碼的優點，在大多數安全稽查都會發現共用密碼的問題且這種情況只有壞處可言。</para>

    <para>使用 <application>Sudo</application> 允許使用者執行應用程式只需要輸入使用者自己的密碼，這更安全且提供比 <citerefentry><refentrytitle>su</refentrytitle><manvolnum>1</manvolnum></citerefentry> 更佳的控制權，因為 <citerefentry><refentrytitle>su</refentrytitle><manvolnum>1</manvolnum></citerefentry> 只要輸入 <systemitem class="username">root</systemitem> 密碼之後該使用者便可取得所有的 <systemitem class="username">root</systemitem> 權限。</para>

    <tip>
      <para>大多數組織已正在導入或已導入雙重認証 (Two factor authentication)，在這個情境下使用者可以不用輸入密碼，<application>Sudo</application> 提供了 <literal>NOPASSWD</literal> 變數來供這個情境使用，可將該設定加入到上述的設定將可允許所有 <replaceable>webteam</replaceable> 群組的成員不需要輸入密碼便可管理該服務：</para>

      <programlisting xml:lang="en">%webteam   ALL=(ALL)       NOPASSWD: /usr/sbin/service webservice *</programlisting>
    </tip>

    <sect2 xml:id="security-sudo-loggin">
      <title>記錄輸出</title>

      <para>採用 <application>Sudo</application> 的另一個優點是能夠開啟連線階段的記錄。使用內建立記錄機制與內含的 <application>sudoreplay</application> 指令，所有透過 <application>Sudo</application> 初始化的指令會被記錄下來供往後檢驗用。要開啟這個功能要加入預設記錄目錄的項目，在以下範例中使用了使用者變數來做目錄名稱，也還有許多其他記錄檔名稱慣例，可參考 <application>sudoreplay</application> 的操作手冊來取得進一步資訊。</para>

      <programlisting xml:lang="en">Defaults iolog_dir=/var/log/sudo-io/%{user}</programlisting>

      <tip>
	<para>這個目錄會在記錄功能設定之後自動建立，最好讓系統以預設的權限來建立目錄比較保險，除此之外，這個設定項目也會記錄使用 <application>sudoreplay</application> 指令的管理者，要更改設定請閱讀並取消在 <filename>sudoers</filename> 中記錄選項的註解。</para>
      </tip>

      <para>一旦這個設定加入至 <filename>sudoers</filename> 檔案之後，所有的使用者設定項目便可加上記錄存取動作的項目，在 <replaceable>webteam</replaceable> 項目加入額外設定之後的範例如下：</para>

      <programlisting xml:lang="en">%webteam ALL=(ALL) NOPASSWD: LOG_INPUT: LOG_OUTPUT: /usr/sbin/service webservice *</programlisting>

      <para>從此之後，所有 <replaceable>webteam</replaceable> 修改 <replaceable>webservice</replaceable> 應用程式狀態的成員將會被記錄下來。要列出先前與目前連線階段的記錄可：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sudoreplay -l</userinput></screen>

      <para>在輸出結果中要重播指定連線階段的記錄可搜尋 <literal>TSID=</literal> 項目，然後傳送給 <application>sudoreplay</application> 且不加其他選項便可以一般速度重播連線階段，例如：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sudoreplay user1/00/00/02</userinput></screen>

      <warning>
	<para>雖然所有連線階段都會被記錄，但任何管理者都可以移除連線階段，使得沒人知道它們做了什麼事，所以非常值得在入侵偵測系統 (<acronym>IDS</acronym>) 或類似的軟體加入每日檢查，以便在有人為修改時通知其他管理人員。</para>
      </warning>

      <para><command>sudoreplay</command> 的擴充空間非常大，請參考說明文件來取得更多資訊。</para>
    </sect2>
  </sect1>
</chapter>

    
<!--
    The FreeBSD Documentation Project

    $FreeBSD$
-->
<chapter version="5.0" xml:id="jails">
  <info>
    <title>Jail</title>

    <authorgroup>
      <author xml:lang="en"><personname><firstname>Matteo</firstname><surname>Riondato</surname></personname><contrib>Contributed
	by </contrib></author>
    </authorgroup>
  </info>

  <indexterm xml:lang="en"><primary>jails</primary></indexterm>

  <sect1 xml:id="jails-synopsis">
    <title>概述</title>

    <para>由於系統管理是一項困難的工作，許多工具開發來讓系統管理者能夠更輕鬆。這些工具通常可以強化系統安裝、設定以及維護的方式。這些工具之可以用來強化 FreeBSD 系統的安全性之一的就是 <firstterm>Jail</firstterm>。Jail 早在 FreeBSD 4.X 便可使用並持續強化它的功能、效率、穩定性以及安全性。</para>

    <para>Jail 建立在 <citerefentry><refentrytitle>chroot</refentrytitle><manvolnum>2</manvolnum></citerefentry> 概念之上，會更改一系列程序的根目錄。這可以創造一個安全的環境，將程序與系統的其他部份分隔。在 chroot 的環境所建立的程序不能存取該環境以外的檔案或資源。也因此，滲透一個在 chroot 的環境執行的服務並不會讓整個系統被攻擊者滲透。但 chroot 有許多限制，只適合用在簡單的工作，不需要許多彈性或複雜性、進階功能的工作。隨著時間推移，許多可以逃離 chroot 的環境的方法已經被找到，讓這個方法不再是確保服務安全的理想方案。</para>

    <para>Jail 用許多方式改進了傳統 chroot 環境的概念。在傳統 chroot 環境，程序僅限制在一部份檔案系統可存取的地方。其餘的系統資源、系統使用者、執行的程序以及網路子系統被 chroot 的程序及主機系統的程序所共享。Jail 透過虛擬化存取檔案系統、使用者及網路子系統來擴展這個模型，可使用更多細微的控制參數來調校 Jail 的環境存取方式，Jail 可算是一種作業系統層級的虛擬化。</para>

    <para>Jail 的四個要素：</para>

    <itemizedlist>
      <listitem>
	<para>一個子樹狀目錄：進入 Jail 的起點目錄，一但在 Jail 中，程序便沒有權限離開此目錄之外。</para>
      </listitem>

      <listitem>
	<para>一個主機名稱：將會由 Jail 所使用。</para>
      </listitem>

      <listitem>
	<para>一個 <acronym>IP</acronym> 位址：用來分配給 Jail。Jail 的 <acronym>IP</acronym> 位址通常是現有網路介面的別名位址。</para>
      </listitem>

      <listitem>
	<para>一個指令：要在 Jail 中可執行的執行檔路徑名稱。該路徑是 Jail 環境根目錄的相對路徑。</para>
      </listitem>
    </itemizedlist>

    <para>Jail 有自己使用者及自己的 <systemitem class="username">root</systemitem> 帳號，皆受到 Jail 環境的限制。Jail 中的 <systemitem class="username">root</systemitem> 帳號不允許對指定 Jail 環境之外的系統執行操作。</para>

    <para>本章將提供 FreeBSD Jail 術語及管理指令的概述，Jail 對系統管理者及進階的使用者來二者來說皆是強大的工具。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>Jail 是什麼及它在 FreeBSD 中提供的目的。</para>
      </listitem>

      <listitem>
	<para>如何建立、啟動及停止 Jail。</para>
      </listitem>

      <listitem>
	<para>Jail 管理基礎，不論從內部或外部。</para>
      </listitem>
    </itemizedlist>

    <important>
      <para>Jail 是強大的工具，但它不是安全性問題的萬靈丹。雖然 Jail 的程序不可能自己獨自打破規則，但有許多方法可以讓在 Jail 之外無權限的使用者與在 Jail 之內有權限的使用者串通來取得主機環境的更高權限。</para>

      <para>大多數這類型的攻擊者可以由確保 Jail 根目錄不會被無權限使用者存取來減少。基本上，不受信任的使用者有 Jail 的存取權限並不會讓其可存取主機環境。</para>
    </important>
  </sect1>

  <sect1 xml:id="jails-terms">
    <title>Jail 相關術語</title>

    <para>為協助更容易理解 FreeBSD 系統有關 Jail 部份， 以及它們與 FreeBSD 其他部分的相互作用關係， 以下列出本章將使用的術語：</para>

    <variablelist>
      <varlistentry>
	<term><citerefentry><refentrytitle>chroot</refentrytitle><manvolnum>8</manvolnum></citerefentry> (指令)</term>
	<listitem>
	  <para>工具，用來使用 <citerefentry><refentrytitle>chroot</refentrytitle><manvolnum>2</manvolnum></citerefentry> FreeBSD 系統呼叫 (System call) 來更改程予及其衍伸程序的根目錄。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><citerefentry><refentrytitle>chroot</refentrytitle><manvolnum>2</manvolnum></citerefentry> (環境)</term>
	<listitem>
	  <para>指程序在 <quote>chroot</quote> 中執行的環境。包含的資源如：一部份可見的檔案系統、可用的使用者及群組 ID、網路介面及其他 IPC 機制等。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><citerefentry><refentrytitle>jail</refentrytitle><manvolnum>8</manvolnum></citerefentry> (指令)</term>
	<listitem>
	  <para>允許在 Jail 環境下執行程序的系統管理工具。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>主機 (系統、程序、使用者等)</term>
	<listitem>
	  <para>Jail 環境的控制系統。 主機系統可以存取所有可用的硬體資源，並能控制 Jail 環境內外的程序。主機系統與 Jail 最大的差別在於：在主機系統中的超級使用者程序並不像在 Jail 環境那樣受到限制。</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>託管 (主機、程序、使用者等)</term>
	<listitem>
	  <para>存取資源受到 FreeBSD Jail 限制的託管程序、使用者或其他實體。</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </sect1>

  <sect1 xml:id="jails-build">
    <title>建立和控制 Jail</title>

    <para>部份管理者將 Jail 分成兩種類型：<quote>完整的</quote> Jail，它像一個真正的 FreeBSD 系統以及 <quote>服務的</quote> Jail，專門用於某個應用程式或服務，可能使用管理權限執行。但這些只是概念上的區分，建立 Jail 的程序並不受這個概念的影響。當要建立一個 <quote>完整的</quote> Jail，Userland 有兩個來源選項：使用預先編譯的 Binary (如安裝媒體上提供的 Binary) 或從原始碼編譯。</para>

    <para>要從安裝媒體安裝 Userland，需要先建立根目錄供 Jail 使用。這個動作可以透過設定 <varname>DESTDIR</varname> 來到適當的位置來完成。</para>

    <para>啟動 Shell 並定義 <varname>DESTDIR</varname>：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>sh</userinput>
<prompt>#</prompt> <userinput>export DESTDIR=<replaceable>/here/is/the/jail</replaceable></userinput></screen>

    <para>當使用安裝 ISO 時，可依 <citerefentry><refentrytitle>mdconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> 中的說明掛載安裝媒體：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>mount -t cd9660 /dev/`mdconfig -f cdimage.iso` /mnt</userinput>
<prompt>#</prompt> <userinput>cd /mnt/usr/freebsd-dist/</userinput></screen>

    <para>或者自鏡像站下載 Tarball 壓縮檔：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>sh</userinput>
<prompt>#</prompt> <userinput>export DESTRELEASE=<replaceable>12.0-RELEASE</replaceable></userinput>
<prompt>#</prompt> <userinput>export DESTARCH=<replaceable>`uname -m`</replaceable></userinput>
<prompt>#</prompt> <userinput>export SOURCEURL=<replaceable>http://ftp.freebsd.org/pub/</replaceable>FreeBSD/releases/$DESTARCH/$DESTRELEASE/</userinput>
<prompt>#</prompt> <userinput>for set in base ports; do fetch $SOURCEURL/$set.txz ; done</userinput></screen>

    <para>從安裝媒體上的 Tarball 中取出 Binary 並放到宣告的位置，至少需要取出 Base set 的部份，若需要也可完整安裝。</para>

    <para>只安裝基礎系統 (Base system)：</para>

    <screen><prompt>#</prompt> <userinput>tar -xf base.txz -C $DESTDIR</userinput></screen>

    <para>安裝全部不含核心：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>for set in base ports; do tar -xf $set.txz -C $DESTDIR ; done</userinput></screen>

    <para>依 <citerefentry><refentrytitle>jail</refentrytitle><manvolnum>8</manvolnum></citerefentry> 操作手冊說明的程序建置 Jail：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>setenv D <replaceable>/here/is/the/jail</replaceable></userinput>
<prompt>#</prompt> <userinput>mkdir -p $D</userinput>      <co xml:id="jailpath"/>
<prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make buildworld</userinput>  <co xml:id="jailbuildworld"/>
<prompt>#</prompt> <userinput>make installworld DESTDIR=$D</userinput>  <co xml:id="jailinstallworld"/>
<prompt>#</prompt> <userinput>make distribution DESTDIR=$D</userinput>  <co xml:id="jaildistrib"/>
<prompt>#</prompt> <userinput>mount -t devfs devfs $D/dev</userinput>   <co xml:id="jaildevfs"/></screen>

    <calloutlist>
      <callout arearefs="jailpath">
	<para>選擇 Jail 的位置是建置 Jail 最好的起點，這是在 Jail 主機上儲存 Jail 的實體位置。較好的選擇是 <filename>/usr/jail/<replaceable>jailname</replaceable></filename>，其中 <replaceable>jailname</replaceable> 是用來辦識 Jail 的主機名稱。通常在 <filename>/usr/</filename> 會有足夠的空間供 Jail 檔案系統使用，對 <quote>完整的</quote> Jail 來說，便是複製 FreeBSD 基礎系統預設安裝的每一個檔案。</para>
      </callout>

      <callout arearefs="jailbuildworld">
	<para>若您已經使用 <command>make world</command> 或 <command>make buildworld</command> 重新編譯您的 Userland，您可以跳過這個步驟並安裝您已存在的 Userland 到新的 Jail。</para>
      </callout>

      <callout arearefs="jailinstallworld">
	<para>這個指令將會在檔案系統中 Jail 所在的實體位置產生樹狀目錄及必要的 Binary、程式庫、操作手冊與相關檔案。</para>
      </callout>

      <callout arearefs="jaildistrib">
	<para><application>make</application> 的 <buildtarget>distribution</buildtarget> 目標會安裝所有需要的設定檔。簡單來說，它會安裝所有 <filename>/usr/src/etc/</filename> 中可安裝的檔案到 Jail 環境的 <filename>/etc</filename>目錄：<filename>$D/etc/</filename>。</para>
      </callout>

      <callout arearefs="jaildevfs">
	<para>在 Jail 中掛載 <citerefentry><refentrytitle>devfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> 檔案系統並非必要的動作。從另一個角度來說，任何或大部份的應用程式會依該程式的目的會需要存取至少一個裝置，在 Jail 中控制存取的裝置非常重要，不恰當的設定可能會讓攻擊者可以在 Jail 中做不軌的事。對 <citerefentry><refentrytitle>devfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的控制是透過  Ruleset，在 <citerefentry><refentrytitle>devfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> 及 <citerefentry><refentrytitle>devfs.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 操作手冊中有詳細說明。</para>
      </callout>
    </calloutlist>

    <para>Jail 安裝完成之後，便可使用 <citerefentry><refentrytitle>jail</refentrytitle><manvolnum>8</manvolnum></citerefentry> 工具來啟動。<citerefentry><refentrytitle>jail</refentrytitle><manvolnum>8</manvolnum></citerefentry> 工具需要四個必要參數，在 <xref linkend="jails-synopsis"/> 有說明。其他參數也可能需要指定，例如要使用特定使用者的身份來執行要 Jail 的程序。<option><replaceable>command</replaceable></option> 參數依 Jail 的類型所需而定，對一個 <emphasis>虛擬系統</emphasis> 來說，<filename>/etc/rc</filename> 是不錯的選擇，因為該檔案可以模仿真實 FreeBSD 的啟動順序。對於 <emphasis>服務型</emphasis> 的 Jail 來說，則看在 Jail 中要執行的服務或應用程式來決定。</para>

    <para>Jail 通常會需要隨著開機執行，使用 FreeBSD <filename>rc</filename> 機制可讓以簡單的達成這件事。</para>

    <procedure>
      <step>
	<para>在 <filename>jail.conf</filename> 中設定 jail 參數：</para>
	<programlisting xml:lang="en"><replaceable>www</replaceable> {
    host.hostname = <replaceable>www.example.org</replaceable>;           # Hostname
    ip4.addr = <replaceable>192.168.0.10</replaceable>;                   # IP address of the jail
    path ="<replaceable>/usr/jail/www</replaceable>";                     # Path to the jail
    devfs_ruleset = "<replaceable>www_ruleset</replaceable>";             # devfs ruleset
    mount.devfs;                               # Mount devfs inside the jail
    exec.start = "/bin/sh /etc/rc";            # Start command
    exec.stop = "/bin/sh /etc/rc.shutdown";    # Stop command
}</programlisting>

	<para>在 <filename>rc.conf</filename> 中設定開機時啟動 Jail：</para>

	<programlisting xml:lang="en">jail_enable="YES"   # Set to NO to disable starting of any jails</programlisting>

	<para>預設要啟動的 Jail 可在 <citerefentry><refentrytitle>jail.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 設定，會把 Jail 當作是一個完全虛擬的系統，然後執行 Jail 中的 <filename>/etc/rc</filename> Script。針對服務型的 Jail 則需透過設定 <varname>exec.start</varname> 選項來適當更改 Jail 的預設啟動指令。</para>

	<note>
	  <para>要取得完整可用選項的清單，請參考 <citerefentry><refentrytitle>jail.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>操作手冊。</para>
	</note>
      </step>
    </procedure>

    <para>若 Jail 項目已經在 <filename>jail.conf</filename> 中設定好，可以手動用 <citerefentry><refentrytitle>service</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來啟動或停止某個 Jail 項目：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>service jail start <replaceable>www</replaceable></userinput>
<prompt>#</prompt> <userinput>service jail stop <replaceable>www</replaceable></userinput></screen>

    <para>Jail 可以使用 <citerefentry><refentrytitle>jexec</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來關機。先使用 <citerefentry><refentrytitle>jls</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來辦識 Jail 的 <varname>JID</varname>，然後使用 <citerefentry><refentrytitle>jexec</refentrytitle><manvolnum>8</manvolnum></citerefentry> 在該 Jail 中執行關機 Script。</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>jls</userinput>
   JID  IP Address      Hostname                      Path
     3  192.168.0.10    www                           /usr/jail/www
<prompt>#</prompt> <userinput>jexec <replaceable>3</replaceable> /etc/rc.shutdown</userinput></screen>

    <para>更多有關 Jail 的資訊可在 <citerefentry><refentrytitle>jail</refentrytitle><manvolnum>8</manvolnum></citerefentry> 操作手冊取得。</para>
  </sect1>

  <sect1 xml:id="jails-tuning">
    <title>調校與管理</title>

    <para>還有許多選項可以對所有 Jail 做設定，以及各種可讓 Jail 與主機 FreeBSD 系統結合的方法來提供更高層級的應用程式使用。 本節將介紹：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Some of the options available for tuning the behavior
	  and security restrictions implemented by a jail
	  installation.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Some of the high-level applications for jail management,
	  which are available through the FreeBSD Ports Collection, and
	  can be used to implement overall jail-based
	  solutions.</para>
      </listitem>
    </itemizedlist>

    <sect2 xml:id="jails-tuning-utilities">
      <title>在 FreeBSD 中調校 Jail 的系統工具</title>

      <para xml:lang="en">Fine tuning of a jail's configuration is mostly done by
	setting <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> variables.  A special subtree of sysctl
	exists as a basis for organizing all the relevant options: the
	<varname>security.jail.*</varname> hierarchy of FreeBSD kernel
	options.  Here is a list of the main jail-related sysctls,
	complete with their default value.  Names should be
	self-explanatory, but for more information about them, please
	refer to the <citerefentry><refentrytitle>jail</refentrytitle><manvolnum>8</manvolnum></citerefentry> and <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> manual
	pages.</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><varname>security.jail.set_hostname_allowed:
	      1</varname></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.jail.socket_unixiproute_only:
	      1</varname></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.jail.sysvipc_allowed:
	      0</varname></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.jail.enforce_statfs:
	      2</varname></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.jail.allow_raw_sockets:
	      0</varname></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.jail.chflags_allowed:
	      0</varname></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.jail.jailed: 0</varname></para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">These variables can be used by the system administrator of
	the <emphasis>host system</emphasis> to add or remove some of
	the limitations imposed by default on the <systemitem class="username">root</systemitem> user.  Note that there
	are some limitations which cannot be removed.  The
	<systemitem class="username">root</systemitem> user is not
	allowed to mount or unmount file systems from within a
	<citerefentry><refentrytitle>jail</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  The <systemitem class="username">root</systemitem> inside a jail may not
	load or unload <citerefentry><refentrytitle>devfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> rulesets, set firewall rules, or
	do many other administrative tasks which require modifications
	of in-kernel data, such as setting the
	<varname>securelevel</varname> of the kernel.</para>

      <para xml:lang="en">The base system of FreeBSD contains a basic set of tools for
	viewing information about the active jails, and attaching to a
	jail to run administrative commands.  The <citerefentry><refentrytitle>jls</refentrytitle><manvolnum>8</manvolnum></citerefentry> and
	<citerefentry><refentrytitle>jexec</refentrytitle><manvolnum>8</manvolnum></citerefentry> commands are part of the base FreeBSD system, and
	can be used to perform the following simple tasks:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Print a list of active jails and their corresponding
	    jail identifier (<acronym>JID</acronym>),
	    <acronym>IP</acronym> address, hostname and path.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Attach to a running jail, from its host system, and
	    run a command inside the jail or perform administrative
	    tasks inside the jail itself.  This is especially useful
	    when the <systemitem class="username">root</systemitem>
	    user wants to cleanly shut down a jail.  The <citerefentry><refentrytitle>jexec</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	    utility can also be used to start a shell in a jail to do
	    administration in it; for example:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>jexec <replaceable>1</replaceable> tcsh</userinput></screen>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="jails-tuning-admintools">
      <title>在 FreeBSD Port 套件集中的高層級管理工具</title>

      <para xml:lang="en">Among the many third-party utilities for jail
	administration, one of the most complete and useful is
	<package>sysutils/ezjail</package>.  It is a set of scripts
	that contribute to <citerefentry><refentrytitle>jail</refentrytitle><manvolnum>8</manvolnum></citerefentry> management.  Please refer to
	<link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/books/handbook/jails-ezjail.html">the
	  handbook section on <application>ezjail</application></link>
	for more information.</para>
    </sect2>

    <sect2 xml:id="jails-updating">
      <title>持續 Jail 的修補與更新</title>

      <para xml:lang="en">Jails should be kept up to date from the host operating
	system as attempting to patch userland from within the jail
	may likely fail as the default behavior in FreeBSD is to
	disallow the use of <citerefentry><refentrytitle>chflags</refentrytitle><manvolnum>1</manvolnum></citerefentry> in a jail which prevents
	the replacement of some files.  It is possible to change this
	behavior but it is recommended to use <citerefentry><refentrytitle>freebsd-update</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	to maintain jails instead.  Use <option>-b</option> to specify
	the path of the jail to be updated.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>freebsd-update -b <replaceable>/here/is/the/jail</replaceable> fetch</userinput>
<prompt>#</prompt> <userinput>freebsd-update -b <replaceable>/here/is/the/jail</replaceable> install</userinput></screen>
    </sect2>
  </sect1>

  <sect1 xml:id="jails-application">
    <info>
      <title>更新多個 Jail</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Daniel</firstname>
	    <surname>Gerzo</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Simon</firstname>
	    <surname>L. B. Nielsen</surname>
	  </personname>
	  <contrib>Based upon an idea presented by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Ken</firstname>
	    <surname>Tom</surname>
	  </personname>
	  <contrib>And an article written by </contrib>
	</author>
      </authorgroup>
    </info>

    <para xml:lang="en">The management of multiple jails can become problematic
      because every jail has to be rebuilt from scratch whenever it is
      upgraded.  This can be time consuming and tedious if a lot of
      jails are created and manually updated.</para>

    <para xml:lang="en">This section demonstrates one method to resolve this issue
      by safely sharing as much as is possible between jails using
      read-only <citerefentry><refentrytitle>mount_nullfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> mounts, so that updating is
      simpler.  This makes it more attractive to put single services,
      such as <acronym>HTTP</acronym>, <acronym>DNS</acronym>, and
      <acronym>SMTP</acronym>, into individual jails.  Additionally,
      it provides a simple way to add, remove, and upgrade
      jails.</para>

    <note>
      <para xml:lang="en">Simpler solutions exist, such as
	<application>ezjail</application>, which provides an easier
	method of administering FreeBSD jails but is less versatile than
	this setup.  <application>ezjail</application> is covered in
	more detail in <xref linkend="jails-ezjail"/>.</para>
    </note>

    <para xml:lang="en">The goals of the setup described in this section are:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Create a simple and easy to understand jail structure
	  that does not require running a full installworld on each
	  and every jail.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Make it easy to add new jails or remove existing
	  ones.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Make it easy to update or upgrade existing jails.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Make it possible to run a customized FreeBSD branch.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Be paranoid about security, reducing as much as
	  possible the possibility of compromise.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Save space and inodes, as much as possible.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">This design relies on a single, read-only master template
      which is mounted into each jail and one read-write device per
      jail.  A device can be a separate physical disc, a partition, or
      a vnode backed memory device.  This example uses read-write
      <application>nullfs</application> mounts.</para>

    <para xml:lang="en">The file system layout is as follows:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">The jails are based under the
	  <filename>/home</filename> partition.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Each jail will be mounted under the
	  <filename>/home/j</filename> directory.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The template for each jail and the read-only partition
	  for  all of the jails is
	  <filename>/home/j/mroot</filename>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">A blank directory will be created for each jail under
	  the <filename>/home/j</filename> directory.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Each jail will have a <filename>/s</filename> directory
	  that will be linked to the read-write portion of the
	  system.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Each jail will have its own read-write system that is
	  based upon <filename>/home/j/skel</filename>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The read-write portion of each jail will be created in
	  <filename>/home/js</filename>.</para>
      </listitem>
    </itemizedlist>

	<!-- Insert an image or drawing here to illustrate the example. -->

    <sect2 xml:id="jails-service-jails-template">
      <title>建立範本</title>

      <para xml:lang="en">This section describes the steps needed to create the
	master template.</para>

      <para xml:lang="en">It is recommended to first update the host FreeBSD system to
	the latest -RELEASE branch using the instructions in <xref linkend="makeworld"/>.  Additionally, this template uses the
	<package>sysutils/cpdup</package> package or port and
	<application>portsnap</application> will be used to download
	the FreeBSD Ports Collection.</para>

      <procedure>
	<step>
	  <para xml:lang="en">First, create a directory structure for the read-only
	    file system which will contain the FreeBSD binaries for the
	    jails.  Then, change directory to the FreeBSD source tree and
	    install the read-only file system to the jail
	    template:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /home/j /home/j/mroot</userinput>
<prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make installworld DESTDIR=/home/j/mroot</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Next, prepare a FreeBSD Ports Collection for the jails as
	    well as a FreeBSD source tree, which is required for
	    <application>mergemaster</application>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /home/j/mroot</userinput>
<prompt>#</prompt> <userinput>mkdir usr/ports</userinput>
<prompt>#</prompt> <userinput>portsnap -p /home/j/mroot/usr/ports fetch extract</userinput>
<prompt>#</prompt> <userinput>cpdup /usr/src /home/j/mroot/usr/src</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Create a skeleton for the read-write portion of the
	    system:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /home/j/skel /home/j/skel/home /home/j/skel/usr-X11R6 /home/j/skel/distfiles</userinput>
<prompt>#</prompt> <userinput>mv etc /home/j/skel</userinput>
<prompt>#</prompt> <userinput>mv usr/local /home/j/skel/usr-local</userinput>
<prompt>#</prompt> <userinput>mv tmp /home/j/skel</userinput>
<prompt>#</prompt> <userinput>mv var /home/j/skel</userinput>
<prompt>#</prompt> <userinput>mv root /home/j/skel</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Use <application>mergemaster</application> to install
	    missing configuration files.  Then, remove the extra
	    directories that <application>mergemaster</application>
	    creates:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mergemaster -t /home/j/skel/var/tmp/temproot -D /home/j/skel -i</userinput>
<prompt>#</prompt> <userinput>cd /home/j/skel</userinput>
<prompt>#</prompt> <userinput>rm -R bin boot lib libexec mnt proc rescue sbin sys usr dev</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Now, symlink the read-write file system to the
	    read-only file system.  Ensure that the symlinks are
	    created in the correct <filename>s/</filename> locations
	    as the creation of directories in the wrong locations will
	    cause the installation to fail.</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /home/j/mroot</userinput>
<prompt>#</prompt> <userinput>mkdir s</userinput>
<prompt>#</prompt> <userinput>ln -s s/etc etc</userinput>
<prompt>#</prompt> <userinput>ln -s s/home home</userinput>
<prompt>#</prompt> <userinput>ln -s s/root root</userinput>
<prompt>#</prompt> <userinput>ln -s ../s/usr-local usr/local</userinput>
<prompt>#</prompt> <userinput>ln -s ../s/usr-X11R6 usr/X11R6</userinput>
<prompt>#</prompt> <userinput>ln -s ../../s/distfiles usr/ports/distfiles</userinput>
<prompt>#</prompt> <userinput>ln -s s/tmp tmp</userinput>
<prompt>#</prompt> <userinput>ln -s s/var var</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">As a last step, create a generic
	    <filename>/home/j/skel/etc/make.conf</filename> containing
	    this line:</para>

	  <programlisting xml:lang="en">WRKDIRPREFIX?=  /s/portbuild</programlisting>

	  <para xml:lang="en">This makes it possible to compile FreeBSD ports inside
	    each jail.  Remember that the ports directory is part of
	    the read-only system.  The custom path for
	    <literal>WRKDIRPREFIX</literal> allows builds to be done
	    in the read-write portion of every jail.</para>
	</step>
      </procedure>
    </sect2>

    <sect2 xml:id="jails-service-jails-creating">
      <title>建立 Jail</title>

      <para xml:lang="en">The jail template can now be used to setup and configure
	the jails in <filename>/etc/rc.conf</filename>.  This example
	demonstrates the creation of 3 jails: <literal>NS</literal>,
	<literal>MAIL</literal> and <literal>WWW</literal>.</para>

      <procedure>
	<step>
	  <para xml:lang="en">Add the following lines to
	    <filename>/etc/fstab</filename>, so that the read-only
	    template for the jails and the read-write space will be
	    available in the respective jails:</para>

	  <programlisting xml:lang="en">/home/j/mroot   /home/j/ns     nullfs  ro  0   0
/home/j/mroot   /home/j/mail   nullfs  ro  0   0
/home/j/mroot   /home/j/www    nullfs  ro  0   0
/home/js/ns     /home/j/ns/s   nullfs  rw  0   0
/home/js/mail   /home/j/mail/s nullfs  rw  0   0
/home/js/www    /home/j/www/s  nullfs  rw  0   0</programlisting>

	  <para xml:lang="en">To prevent
	    <application>fsck</application> from checking
	    <application>nullfs</application> mounts during boot and
	    <application>dump</application> from backing up the
	    read-only nullfs mounts of the jails, the last two
	    columns are both set to <literal>0</literal>.</para>
	</step>

	<step>
	  <para xml:lang="en">Configure the jails in
	    <filename>/etc/rc.conf</filename>:</para>

	  <programlisting xml:lang="en">jail_enable="YES"
jail_set_hostname_allow="NO"
jail_list="ns mail www"
jail_ns_hostname="ns.example.org"
jail_ns_ip="192.168.3.17"
jail_ns_rootdir="/usr/home/j/ns"
jail_ns_devfs_enable="YES"
jail_mail_hostname="mail.example.org"
jail_mail_ip="192.168.3.18"
jail_mail_rootdir="/usr/home/j/mail"
jail_mail_devfs_enable="YES"
jail_www_hostname="www.example.org"
jail_www_ip="62.123.43.14"
jail_www_rootdir="/usr/home/j/www"
jail_www_devfs_enable="YES"</programlisting>

	  <para xml:lang="en">The
	    <varname>jail_<replaceable>name</replaceable>_rootdir</varname>
	    variable is set to
	    <filename>/usr/home</filename> instead
	    of <filename>/home</filename> because
	    the physical path of <filename>/home</filename> on a default FreeBSD
	    installation is <filename>/usr/home</filename>.  The
	    <varname>jail_<replaceable>name</replaceable>_rootdir</varname>
	    variable must <emphasis>not</emphasis> be set to a path
	    which includes a symbolic link, otherwise the jails will
	    refuse to start.</para>
	</step>

	<step>
	  <para xml:lang="en">Create the required mount points for the read-only
	    file system of each jail:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /home/j/ns /home/j/mail /home/j/www</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Install the read-write template into each jail using
	    <package>sysutils/cpdup</package>:</para>
	    <!-- keramida: Why is cpdup required here?  Doesn't cpio(1)
	     already include adequate functionality for performing this
	     job *and* have the advantage of being part of the base
	     system of FreeBSD? -->

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /home/js</userinput>
<prompt>#</prompt> <userinput>cpdup /home/j/skel /home/js/ns</userinput>
<prompt>#</prompt> <userinput>cpdup /home/j/skel /home/js/mail</userinput>
<prompt>#</prompt> <userinput>cpdup /home/j/skel /home/js/www</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">In this phase, the jails are built and prepared to
	    run.  First, mount the required file systems for each
	    jail, and then start them:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mount -a</userinput>
<prompt>#</prompt> <userinput>service jail start</userinput></screen>
	</step>
      </procedure>

      <para xml:lang="en">The jails should be running now.  To check if they have
	started correctly, use <command>jls</command>.  Its output
	should be similar to the following:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>jls</userinput>
   JID  IP Address      Hostname                      Path
     3  192.168.3.17    ns.example.org                /home/j/ns
     2  192.168.3.18    mail.example.org              /home/j/mail
     1  62.123.43.14    www.example.org               /home/j/www</screen>

      <para xml:lang="en">At this point, it should be possible to log onto each
	jail, add new users, or configure daemons.  The
	<literal>JID</literal> column indicates the jail
	identification number of each running jail.  Use the following
	command to perform administrative tasks in the jail whose
	<acronym>JID</acronym> is <literal>3</literal>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>jexec 3 tcsh</userinput></screen>
    </sect2>

    <sect2 xml:id="jails-service-jails-upgrading">
      <title>升級</title>

      <para xml:lang="en">The design of this setup provides an easy way to upgrade
	existing jails while minimizing their downtime.  Also, it
	provides a way to roll back to the older version should a
	problem occur.</para>

      <procedure>
	<step>
	  <para xml:lang="en">The first step is to upgrade the host system.  Then,
	    create a new temporary read-only template in
	    <filename>/home/j/mroot2</filename>.</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /home/j/mroot2</userinput>
<prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make installworld DESTDIR=/home/j/mroot2</userinput>
<prompt>#</prompt> <userinput>cd /home/j/mroot2</userinput>
<prompt>#</prompt> <userinput>cpdup /usr/src usr/src</userinput>
<prompt>#</prompt> <userinput>mkdir s</userinput></screen>

	  <para xml:lang="en">The <buildtarget xml:lang="en">installworld</buildtarget> creates a
	    few unnecessary directories, which should be
	    removed:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>chflags -R 0 var</userinput>
<prompt>#</prompt> <userinput>rm -R etc var root usr/local tmp</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Recreate the read-write symlinks for the master file
	    system:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ln -s s/etc etc</userinput>
<prompt>#</prompt> <userinput>ln -s s/root root</userinput>
<prompt>#</prompt> <userinput>ln -s s/home home</userinput>
<prompt>#</prompt> <userinput>ln -s ../s/usr-local usr/local</userinput>
<prompt>#</prompt> <userinput>ln -s ../s/usr-X11R6 usr/X11R6</userinput>
<prompt>#</prompt> <userinput>ln -s s/tmp tmp</userinput>
<prompt>#</prompt> <userinput>ln -s s/var var</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Next, stop the jails:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>service jail stop</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Unmount the original file systems as the read-write
	    systems are attached to the read-only system
	    (<filename>/s</filename>):</para>
	    <!-- keramida: Shouldn't we suggest a short script-based
	     loop here, instead of tediously copying the same commands
	     multiple times? -->

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>umount /home/j/ns/s</userinput>
<prompt>#</prompt> <userinput>umount /home/j/ns</userinput>
<prompt>#</prompt> <userinput>umount /home/j/mail/s</userinput>
<prompt>#</prompt> <userinput>umount /home/j/mail</userinput>
<prompt>#</prompt> <userinput>umount /home/j/www/s</userinput>
<prompt>#</prompt> <userinput>umount /home/j/www</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Move the old read-only file system and replace it with
	    the new one.  This will serve as a backup and archive of
	    the old read-only file system should something go wrong.
	    The naming convention used here corresponds to when a new
	    read-only file system has been created.  Move the original
	    FreeBSD Ports Collection over to the new file system to save
	    some space and inodes:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /home/j</userinput>
<prompt>#</prompt> <userinput>mv mroot mroot.20060601</userinput>
<prompt>#</prompt> <userinput>mv mroot2 mroot</userinput>
<prompt>#</prompt> <userinput>mv mroot.20060601/usr/ports mroot/usr</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">At this point the new read-only template is ready, so
	    the only remaining task is to remount the file systems and
	    start the jails:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mount -a</userinput>
<prompt>#</prompt> <userinput>service jail start</userinput></screen>
	</step>
      </procedure>

      <para xml:lang="en">Use <command>jls</command> to check if the jails started
	correctly.  Run <command>mergemaster</command> in each jail to
	update the configuration files.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="jails-ezjail">
    <info>
      <title>使用 <application>ezjail</application> 管理 Jail</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Warren</firstname>
	    <surname>Block</surname>
	  </personname><contrib>Originally contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <para xml:lang="en">Creating and managing multiple jails can quickly become
      tedious and error-prone.  Dirk Engling's
      <application>ezjail</application> automates and greatly
      simplifies many jail tasks.  A <emphasis>basejail</emphasis> is
      created as a template.  Additional jails use
      <citerefentry><refentrytitle>mount_nullfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> to share many of the basejail directories
      without using additional disk space.  Each additional jail takes
      only a few megabytes of disk space before applications are
      installed.  Upgrading the copy of the userland in the basejail
      automatically upgrades all of the other jails.</para>

    <para xml:lang="en">Additional benefits and features are described in detail on
      the <application>ezjail</application> web site, <link xlink:href="https://erdgeist.org/arts/software/ezjail/"/>.</para>

    <sect2 xml:id="jails-ezjail-install">
      <title>安裝 <application>ezjail</application></title>

      <para xml:lang="en">Installing <application>ezjail</application> consists of
	adding a loopback interface for use in jails, installing the
	port or package, and enabling the service.</para>

      <procedure xml:id="jails-ezjail-install-procedure">
	<step>
	  <para xml:lang="en">To keep jail loopback traffic off the host's loopback
	    network interface <literal>lo0</literal>, a second
	    loopback interface is created by adding an entry to
	    <filename>/etc/rc.conf</filename>:</para>

	  <programlisting xml:lang="en">cloned_interfaces="lo1"</programlisting>

	  <para xml:lang="en">The second loopback interface <literal>lo1</literal>
	    will be created when the system starts.  It can also be
	    created manually without a restart:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>service netif cloneup</userinput>
Created clone interfaces: lo1.</screen>

	  <para xml:lang="en">Jails can be allowed to use aliases of this secondary
	    loopback interface without interfering with the
	    host.</para>

	  <para xml:lang="en">Inside a jail, access to the loopback address
	    <systemitem class="ipaddress">127.0.0.1</systemitem> is
	    redirected to the first <acronym>IP</acronym> address
	    assigned to the jail.  To make the jail loopback
	    correspond with the new <literal>lo1</literal> interface,
	    that interface must be specified first in the list of
	    interfaces and <acronym>IP</acronym> addresses given when
	    creating a new jail.</para>

	  <para xml:lang="en">Give each jail a unique loopback address in the
	    <systemitem class="ipaddress">127.0.0.0</systemitem><systemitem class="netmask">/8</systemitem> netblock.</para>
	</step>

	<step>
	  <para xml:lang="en">Install
	    <package role="port">sysutils/ezjail</package>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/sysutils/ezjail</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Enable <application>ezjail</application> by adding
	    this line to <filename>/etc/rc.conf</filename>:</para>

	  <programlisting xml:lang="en">ezjail_enable="YES"</programlisting>
	</step>

	<step>
	  <para xml:lang="en">The service will automatically start on system boot.
	    It can be started immediately for the current
	    session:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>service ezjail start</userinput></screen>
	</step>
      </procedure>
    </sect2>

    <sect2 xml:id="jails-ezjail-initialsetup">
      <title>初始設定</title>

      <para xml:lang="en">With <application>ezjail</application> installed, the
	basejail directory structure can be created and populated.
	This step is only needed once on the jail host
	computer.</para>

      <para xml:lang="en">In both of these examples, <option>-p</option> causes the
	ports tree to be retrieved with <citerefentry><refentrytitle>portsnap</refentrytitle><manvolnum>8</manvolnum></citerefentry> into the
	basejail.  That single copy of the ports directory will be
	shared by all the jails.  Using a separate copy of the ports
	directory for jails isolates them from the host.  The
	<application>ezjail</application> <acronym>FAQ</acronym>
	explains in more detail: <link xlink:href="http://erdgeist.org/arts/software/ezjail/#FAQ"/>.</para>

      <procedure xml:id="jails-ezjail-initialsetup-procedure">
	<step>
	  <stepalternatives>
	    <step>
	      <title xml:lang="en">To Populate the Jail with FreeBSD-RELEASE</title>

	      <para xml:lang="en">For a basejail based on the FreeBSD RELEASE matching
		that of the host computer, use
		<command>install</command>.  For example, on a host
		computer running FreeBSD 10-STABLE, the latest
		RELEASE version of FreeBSD -10 will be installed in
		the jail):</para>

	      <screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin install -p</userinput></screen>
	    </step>

	    <step>
	      <title xml:lang="en">To Populate the Jail with
		<command>installworld</command></title>

	      <para xml:lang="en">The basejail can be installed from binaries
		created by <buildtarget xml:lang="en">buildworld</buildtarget> on
		the host with
		<command>ezjail-admin update</command>.</para>

	      <para xml:lang="en">In this example, FreeBSD 10-STABLE has been
		built from source.  The jail directories are created.
		Then <buildtarget xml:lang="en">installworld</buildtarget> is
		executed, installing the host's
		<filename>/usr/obj</filename> into the
		basejail.</para>

	      <screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin update -i -p</userinput></screen>

	      <para xml:lang="en">The host's <filename>/usr/src</filename> is used
		by default.  A different source directory on the host
		can be specified with <option>-s</option> and a path,
		or set with <varname>ezjail_sourcetree</varname> in
		<filename>/usr/local/etc/ezjail.conf</filename>.</para>
	    </step>
	  </stepalternatives>
	</step>
      </procedure>

      <tip>
	<para xml:lang="en">The basejail's ports tree is shared by other jails.
	  However, downloaded distfiles are stored in the jail that
	  downloaded them.  By default, these files are stored in
	  <filename>/var/ports/distfiles</filename> within each
	  jail.  <filename>/var/ports</filename> inside each jail is
	  also used as a work directory when building ports.</para>
      </tip>

      <tip>
	<para xml:lang="en">The <acronym>FTP</acronym> protocol is used by default
	  to download packages for the installation of the basejail.
	  Firewall or proxy configurations can prevent or interfere
	  with <acronym>FTP</acronym> transfers.  The
	  <acronym>HTTP</acronym> protocol works differently and
	  avoids these problems.  It can be chosen by specifying a
	  full <acronym>URL</acronym> for a particular download mirror
	  in <filename>/usr/local/etc/ezjail.conf</filename>:</para>

	<programlisting xml:lang="en">ezjail_ftphost=http://<replaceable>ftp.FreeBSD.org</replaceable></programlisting>

	<para xml:lang="en">See <xref linkend="mirrors-ftp"/> for a list of
	  sites.</para>
      </tip>
    </sect2>

    <sect2 xml:id="jails-ezjail-create">
      <title>建立並啟動新的 Jail</title>

      <para xml:lang="en">New jails are created with
	<command>ezjail-admin create</command>.  In these examples,
	the <literal>lo1</literal> loopback interface is used as
	described above.</para>

      <procedure xml:id="jails-ezjail-create-steps">
	<title xml:lang="en">Create and Start a New Jail</title>

	<step>
	  <para xml:lang="en">Create the jail, specifying a name and the loopback
	    and network interfaces to use, along with their
	    <acronym>IP</acronym> addresses.  In this example, the
	    jail is named <literal>dnsjail</literal>.</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin create <replaceable>dnsjail</replaceable> '<replaceable>lo1|127.0.1.1</replaceable>,<replaceable>em0</replaceable>|<replaceable>192.168.1.50</replaceable>'</userinput></screen>

	  <tip xml:id="jails-ezjail-raw-network-sockets">
	    <para xml:lang="en">Most network services run in jails without
	      problems.  A few network services, most notably
	      <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry>, use
	      <emphasis>raw network sockets</emphasis>.  In jails, raw
	      network sockets are disabled by default for security.
	      Services that require them will not work.</para>

	    <para xml:lang="en">Occasionally, a jail genuinely needs raw sockets.
	      For example, network monitoring applications often use
	      <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry> to check the availability of other
	      computers.  When raw network sockets are actually needed
	      in a jail, they can be enabled by editing the
	      <application>ezjail</application>
	      configuration file for the individual jail,
	      <filename>/usr/local/etc/ezjail/<replaceable>jailname</replaceable></filename>.
	      Modify the <literal>parameters</literal>
	      entry:</para>

	    <programlisting xml:lang="en">export jail_<replaceable>jailname</replaceable>_parameters="allow.raw_sockets=1"</programlisting>

	    <para xml:lang="en">Do not enable raw network sockets unless services in
	      the jail actually require them.</para>
	  </tip>
	</step>

	<step>
	  <para xml:lang="en">Start the jail:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin start <replaceable>dnsjail</replaceable></userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Use a console on the jail:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin console <replaceable>dnsjail</replaceable></userinput></screen>
	</step>
      </procedure>

      <para xml:lang="en">The jail is operating and additional configuration can be
	completed.  Typical settings added at this point
	include:</para>

      <procedure>
	<step>
	  <title xml:lang="en">Set the
	    <systemitem class="username">root</systemitem>
	    Password</title>

	  <para xml:lang="en">Connect to the jail and set the
	    <systemitem class="username">root</systemitem> user's
	    password:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin console <replaceable>dnsjail</replaceable></userinput>
<prompt>#</prompt> <userinput>passwd</userinput>
Changing local password for root
New Password:
Retype New Password:</screen>
	</step>

	<step>
	  <title xml:lang="en">Time Zone Configuration</title>

	  <para xml:lang="en">The jail's time zone can be set with <citerefentry><refentrytitle>tzsetup</refentrytitle><manvolnum>8</manvolnum></citerefentry>.
	    To avoid spurious error messages, the <citerefentry><refentrytitle>adjkerntz</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	    entry in <filename>/etc/crontab</filename> can be
	    commented or removed.  This job attempts to update the
	    computer's hardware clock with time zone changes, but
	    jails are not allowed to access that hardware.</para>
	</step>

	<step>
	  <title xml:lang="en"><acronym>DNS</acronym> Servers</title>

	  <para xml:lang="en">Enter domain name server lines in
	    <filename>/etc/resolv.conf</filename> so
	    <acronym>DNS</acronym> works in the jail.</para>
	</step>

	<step>
	  <title xml:lang="en">Edit <filename>/etc/hosts</filename></title>

	  <para xml:lang="en">Change the address and add the jail name to the
	    <literal>localhost</literal> entries in
	    <filename>/etc/hosts</filename>.</para>
	</step>

	<step>
	  <title xml:lang="en">Configure <filename>/etc/rc.conf</filename></title>

	  <para xml:lang="en">Enter configuration settings in
	    <filename>/etc/rc.conf</filename>.  This is much like
	    configuring a full computer.  The host name and
	    <acronym>IP</acronym> address are not set here.  Those
	    values are already provided by the jail
	    configuration.</para>
	</step>
      </procedure>

      <para xml:lang="en">With the jail configured, the applications for which the
	jail was created can be installed.</para>

      <tip>
	<para xml:lang="en">Some ports must be built with special options to be used
	  in a jail.  For example, both of the network monitoring
	  plugin packages
	  <package role="port">net-mgmt/nagios-plugins</package> and
	  <package role="port">net-mgmt/monitoring-plugins</package>
	  have a <literal>JAIL</literal> option which must be enabled
	  for them to work correctly inside a jail.</para>
      </tip>
    </sect2>

    <sect2 xml:id="jails-ezjail-update">
      <title>更新 Jail</title>

      <sect3 xml:id="jails-ezjail-update-os">
	<title>更新作業系統</title>

	<para xml:lang="en">Because the basejail's copy of the userland is shared by
	  the other jails, updating the basejail automatically updates
	  all of the other jails.  Either source or binary updates can
	  be used.</para>

	<para xml:lang="en">To build the world from source on the host, then
	  install it in the basejail, use:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin update -b</userinput></screen>

	<para xml:lang="en">If the world has already been compiled on the host,
	  install it in the basejail with:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin update -i</userinput></screen>

	<para xml:lang="en">Binary updates use <citerefentry><refentrytitle>freebsd-update</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  These
	  updates have the same limitations as if
	  <citerefentry><refentrytitle>freebsd-update</refentrytitle><manvolnum>8</manvolnum></citerefentry> were being run directly.  The most
	  important one is that only -RELEASE versions of FreeBSD are
	  available with this method.</para>

	<para xml:lang="en">Update the basejail to the latest patched release of
	  the version of FreeBSD on the host.  For example, updating from
	  RELEASE-p1 to RELEASE-p2.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin update -u</userinput></screen>

	<para xml:lang="en">To upgrade the basejail to a new version, first
	  upgrade the host system as described in <xref linkend="freebsdupdate-upgrade"/>.  Once the host has
	  been upgraded and rebooted, the basejail can then be
	  upgraded.  <citerefentry><refentrytitle>freebsd-update</refentrytitle><manvolnum>8</manvolnum></citerefentry> has no way of determining
	  which version is currently installed in the basejail, so the
	  original version must be specified.  Use <citerefentry><refentrytitle>file</refentrytitle><manvolnum>1</manvolnum></citerefentry> to
	  determine the original version in the basejail:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>file /usr/jails/basejail/bin/sh</userinput>
/usr/jails/basejail/bin/sh: ELF 64-bit LSB executable, x86-64, version 1 (FreeBSD), dynamically linked (uses shared libs), for FreeBSD 9.3, stripped</screen>

	<para xml:lang="en">Now use this information to perform the upgrade from
	  <literal>9.3-RELEASE</literal> to the current version of
	  the host system:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin update -U -s <replaceable>9.3-RELEASE</replaceable></userinput></screen>

	<para xml:lang="en">After updating the basejail, <citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry> must
	  be run to update each jail's configuration files.</para>

	<para xml:lang="en">How to use <citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry> depends on the purpose
	  and trustworthiness of a jail.  If a jail's services or
	  users are not trusted, then <citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry> should only
	  be run from within that jail:</para>

	<example xml:id="jails-ezjail-update-mergemaster-untrusted">
	  <title>在不信任的 Jail 做 <citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry></title>

	  <para xml:lang="en">Delete the link from the jail's
	    <filename>/usr/src</filename> into the basejail and
	    create a new <filename>/usr/src</filename> in the jail
	    as a mountpoint.  Mount the host computer's
	    <filename>/usr/src</filename> read-only on the jail's
	    new <filename>/usr/src</filename> mountpoint:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>rm /usr/jails/<replaceable>jailname</replaceable>/usr/src</userinput>
<prompt>#</prompt> <userinput>mkdir /usr/jails/<replaceable>jailname</replaceable>/usr/src</userinput>
<prompt>#</prompt> <userinput>mount -t nullfs -o ro /usr/src /usr/jails/<replaceable>jailname</replaceable>/usr/src</userinput></screen>

	  <para xml:lang="en">Get a console in the jail:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin console <replaceable>jailname</replaceable></userinput></screen>

	  <para xml:lang="en">Inside the jail, run <command>mergemaster</command>.
	    Then exit the jail console:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>mergemaster -U</userinput>
<prompt>#</prompt> <userinput>exit</userinput></screen>

	  <para xml:lang="en">Finally, unmount the jail's
	    <filename>/usr/src</filename>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>umount /usr/jails/<replaceable>jailname</replaceable>/usr/src</userinput></screen>
	</example>

	<example xml:id="jails-ezjail-update-mergemaster-trusted">

	  <title>在信任的 Jail 做 <citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry></title>

	  <para xml:lang="en">If the users and services in a jail are trusted,
	    <citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry> can be run from the host:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mergemaster -U -D /usr/jails/<replaceable>jailname</replaceable></userinput></screen>
	</example>
      </sect3>

      <sect3 xml:id="jails-ezjail-update-ports">
	<title>更新 Port</title>

	<para xml:lang="en">The ports tree in the basejail is shared by the other
	  jails.  Updating that copy of the ports tree gives the other
	  jails the updated version also.</para>

	<para xml:lang="en">The basejail ports tree is updated with
	  <citerefentry><refentrytitle>portsnap</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin update -P</userinput></screen>
      </sect3>
    </sect2>

    <sect2 xml:id="jails-ezjail-control">
      <title>控制 Jail</title>

      <sect3 xml:id="jails-ezjail-control-stop-start">
	<title>停止與啟動 Jail</title>

	<para xml:lang="en"><application>ezjail</application> automatically starts
	  jails when the computer is started.  Jails can be manually
	  stopped and restarted with <command>stop</command> and
	  <command>start</command>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin stop <replaceable>sambajail</replaceable></userinput>
Stopping jails: sambajail.</screen>

	<para xml:lang="en">By default, jails are started automatically when the
	  host computer starts.  Autostarting can be disabled
	  with <command>config</command>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin config -r norun <replaceable>seldomjail</replaceable></userinput></screen>

	<para xml:lang="en">This takes effect the next time the host computer is
	  started.  A jail that is already running will not be
	  stopped.</para>

	<para xml:lang="en">Enabling autostart is very similar:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin config -r run <replaceable>oftenjail</replaceable></userinput></screen>
      </sect3>

      <sect3 xml:id="jails-ezjail-control-backup">
	<title>封存與還原 Jail</title>

	<para xml:lang="en">Use <command>archive</command> to create a
	  <filename>.tar.gz</filename> archive of a jail.  The file
	  name is composed from the name of the jail and the current
	  date.  Archive files are written to the archive directory,
	  <filename>/usr/jails/ezjail_archives</filename>.  A
	  different archive directory can be chosen by setting
	  <varname>ezjail_archivedir</varname> in the configuration
	  file.</para>

	<para xml:lang="en">The archive file can be copied elsewhere as a backup, or
	  an existing jail can be restored from it with
	  <command>restore</command>.  A new jail can be created from
	  the archive, providing a convenient way to clone existing
	  jails.</para>

	<para xml:lang="en">Stop and archive a jail named
	  <literal>wwwserver</literal>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin stop <replaceable>wwwserver</replaceable></userinput>
Stopping jails: wwwserver.
<prompt>#</prompt> <userinput>ezjail-admin archive <replaceable>wwwserver</replaceable></userinput>
<prompt>#</prompt> <userinput>ls /usr/jails/ezjail-archives/</userinput>
wwwserver-201407271153.13.tar.gz</screen>

	<para xml:lang="en">Create a new jail named
	  <literal>wwwserver-clone</literal> from the archive created
	  in the previous step.  Use the <filename>em1</filename>
	  interface and assign a new <acronym>IP</acronym> address to
	  avoid conflict with the original:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin create -a /usr/jails/ezjail_archives/wwwserver-201407271153.13.tar.gz <replaceable>wwwserver-clone</replaceable> 'lo1|127.0.3.1,em1|192.168.1.51'</userinput></screen>
      </sect3>
    </sect2>

    <sect2 xml:id="jails-ezjail-example-bind">
      <title>完整範例：在 Jail 中安裝 <application>BIND</application></title>

      <para xml:lang="en">Putting the <application>BIND</application>
	<acronym>DNS</acronym> server in a jail improves security by
	isolating it.  This example creates a simple caching-only name
	server.</para>

      <itemizedlist xml:id="jails-ezjail-example-bind-assumptions">
	<listitem>
	  <para xml:lang="en">The jail will be called
	    <literal>dns1</literal>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The jail will use <acronym>IP</acronym> address
	    <literal>192.168.1.240</literal> on the host's
	    <literal>re0</literal> interface.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The upstream <acronym>ISP</acronym>'s DNS servers are
	    at <literal>10.0.0.62</literal> and
	    <literal>10.0.0.61</literal>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The basejail has already been created and a ports tree
	    installed as shown in
	    <xref linkend="jails-ezjail-initialsetup"/>.</para>
	</listitem>
      </itemizedlist>

      <example xml:id="jails-ezjail-example-bind-steps">
	<title>在 Jail 中執行 BIND</title>

	<para xml:lang="en">Create a cloned loopback interface by adding a line to
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">cloned_interfaces="lo1"</programlisting>

	<para xml:lang="en">Immediately create the new loopback interface:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service netif cloneup</userinput>
Created clone interfaces: lo1.</screen>

	<para xml:lang="en">Create the jail:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin create dns1 'lo1|127.0.2.1,re0|192.168.1.240'</userinput></screen>

	<para xml:lang="en">Start the jail, connect to a console running on it, and
	  perform some basic configuration:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ezjail-admin start dns1</userinput>
<prompt>#</prompt> <userinput>ezjail-admin console dns1</userinput>
<prompt>#</prompt> <userinput>passwd</userinput>
Changing local password for root
New Password:
Retype New Password:
<prompt>#</prompt> <userinput>tzsetup</userinput>
<prompt>#</prompt> <userinput>sed -i .bak -e '/adjkerntz/ s/^/#/' /etc/crontab</userinput>
<prompt>#</prompt> <userinput>sed -i .bak -e 's/127.0.0.1/127.0.2.1/g; s/localhost.my.domain/dns1.my.domain dns1/' /etc/hosts</userinput></screen>

	<para xml:lang="en">Temporarily set the upstream <acronym>DNS</acronym>
	  servers in <filename>/etc/resolv.conf</filename> so ports
	  can be downloaded:</para>

	<programlisting xml:lang="en">nameserver 10.0.0.62
nameserver 10.0.0.61</programlisting>

	<para xml:lang="en">Still using the jail console, install
	  <package role="port">dns/bind99</package>.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make -C /usr/ports/dns/bind99 install clean</userinput></screen>

	<para xml:lang="en">Configure the name server by editing
	  <filename>/usr/local/etc/namedb/named.conf</filename>.</para>

	<para xml:lang="en">Create an Access Control List (<acronym>ACL</acronym>)
	  of addresses and networks that are permitted to send
	  <acronym>DNS</acronym> queries to this name server.  This
	  section is added just before the <literal>options</literal>
	  section already in the file:</para>

	<programlisting xml:lang="en">...
// or cause huge amounts of useless Internet traffic.

acl "trusted" {
	192.168.1.0/24;
	localhost;
	localnets;
};

options {
...</programlisting>

	<para xml:lang="en">Use the jail <acronym>IP</acronym> address in the
	  <literal>listen-on</literal> setting to accept
	  <acronym>DNS</acronym> queries from other computers on the
	  network:</para>

	<programlisting xml:lang="en">	listen-on	{ 192.168.1.240; };</programlisting>

	<para xml:lang="en">A simple caching-only <acronym>DNS</acronym> name server
	  is created by changing the <literal>forwarders</literal>
	  section.  The original file contains:</para>

	<programlisting xml:lang="en">/*
	forwarders {
		127.0.0.1;
	};
*/</programlisting>

	<para xml:lang="en">Uncomment the section by removing the
	  <literal>/*</literal> and <literal>*/</literal> lines.
	  Enter the <acronym>IP</acronym> addresses of the upstream
	  <acronym>DNS</acronym> servers.  Immediately after the
	  <literal>forwarders</literal> section, add references to the
	  <literal>trusted</literal> <acronym>ACL</acronym> defined
	  earlier:</para>

	<programlisting xml:lang="en">	forwarders {
		10.0.0.62;
		10.0.0.61;
	};

	allow-query       { any; };
	allow-recursion   { trusted; };
	allow-query-cache { trusted; };</programlisting>

	<para xml:lang="en">Enable the service in
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">named_enable="YES"</programlisting>

	<para xml:lang="en">Start and test the name server:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service named start</userinput>
wrote key file "/usr/local/etc/namedb/rndc.key"
Starting named.
<prompt>#</prompt> <userinput>/usr/local/bin/dig @192.168.1.240 freebsd.org</userinput></screen>

	<para xml:lang="en">A response that includes</para>

	<screen xml:lang="en">;; Got answer;</screen>

	<para xml:lang="en">shows that the new <acronym>DNS</acronym> server is
	  working.  A long delay followed by a response
	  including</para>

	<screen xml:lang="en">;; connection timed out; no servers could be reached</screen>

	<para xml:lang="en">shows a problem.  Check the configuration settings and
	  make sure any local firewalls allow the new
	  <acronym>DNS</acronym> access to the upstream
	  <acronym>DNS</acronym> servers.</para>

	<para xml:lang="en">The new <acronym>DNS</acronym> server can use itself for
	  local name resolution, just like other local computers.  Set
	  the address of the <acronym>DNS</acronym> server in the
	  client computer's
	  <filename>/etc/resolv.conf</filename>:</para>

	<programlisting xml:lang="en">nameserver 192.168.1.240</programlisting>

	<para xml:lang="en">A local <acronym>DHCP</acronym> server can be configured
	  to provide this address for a local <acronym>DNS</acronym>
	  server, providing automatic configuration on
	  <acronym>DHCP</acronym> clients.</para>
      </example>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project
     $FreeBSD$
-->
<chapter version="5.0" xml:id="mac">
  <info>
    <title>強制存取控制 (MAC)</title>

    <authorgroup>
      <author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Written
	by </contrib></author>
    </authorgroup>
  </info>

  <sect1 xml:id="mac-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en"><primary>MAC</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>Mandatory Access Control</primary>
      <see>MAC</see>
    </indexterm>

    <para xml:lang="en">FreeBSD supports security extensions  based on the
      <trademark class="registered">POSIX</trademark>.1e draft.  These security mechanisms include file system
      Access Control Lists (<xref linkend="fs-acl"/>) and Mandatory
      Access Control (<acronym>MAC</acronym>).  <acronym>MAC</acronym>
      allows access control modules to be loaded in order to implement
      security policies.  Some modules provide protections for a
      narrow subset of the system, hardening a particular service.
      Others provide comprehensive labeled security across all
      subjects and objects.  The mandatory part of the definition
      indicates that enforcement of controls is performed by
      administrators and the operating system.  This is in contrast to
      the default security mechanism of Discretionary Access Control
      (<acronym>DAC</acronym>) where enforcement is left to the
      discretion of users.</para>

    <para xml:lang="en">This chapter focuses on the <acronym>MAC</acronym> framework
      and the set of pluggable security policy modules FreeBSD provides
      for enabling various security mechanisms.</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">The terminology associated with the
	  <acronym>MAC</acronym> framework.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The capabilities of <acronym>MAC</acronym> security
	  policy modules as well as the difference between a labeled
	  and non-labeled policy.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The considerations to take into account before
	  configuring a system to use the
	  <acronym>MAC</acronym> framework.</para>
      </listitem>
      <listitem>
	<para xml:lang="en">Which <acronym>MAC</acronym> security policy modules
	  are included in FreeBSD and how to configure them.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to implement a more secure environment using the
	  <acronym>MAC</acronym> framework.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to test the <acronym>MAC</acronym> configuration
	  to ensure the framework has been properly
	  implemented.</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>了解 <trademark class="registered">UNIX</trademark> 及 FreeBSD 基礎 (<xref linkend="basics"/>)。</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Have some familiarity with security and how it pertains
	  to FreeBSD (<xref linkend="security"/>).</para>
      </listitem>
    </itemizedlist>

    <warning>
      <para xml:lang="en">Improper <acronym>MAC</acronym> configuration may cause
	loss of system access, aggravation of users, or inability to
	access the features provided by
	<application>Xorg</application>.  More importantly,
	<acronym>MAC</acronym> should not be relied upon to completely
	secure a system.  The <acronym>MAC</acronym> framework only
	augments an existing security policy.  Without sound security
	practices and regular security checks, the system will never
	be completely secure.</para>

      <para xml:lang="en">The examples contained within this chapter are for
	demonstration purposes and the example settings should
	<emphasis>not</emphasis> be implemented on a production
	system.  Implementing any security policy takes a good deal of
	understanding, proper design, and thorough testing.</para>
    </warning>

    <para xml:lang="en">While this chapter covers a broad range of security issues
      relating to the <acronym>MAC</acronym> framework, the
      development of new <acronym>MAC</acronym> security policy
      modules will not be covered.  A number of security policy
      modules included with the <acronym>MAC</acronym> framework have
      specific characteristics which are provided for both testing and
      new module development.  Refer to <citerefentry><refentrytitle>mac_test</refentrytitle><manvolnum>4</manvolnum></citerefentry>,
      <citerefentry><refentrytitle>mac_stub</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>mac_none</refentrytitle><manvolnum>4</manvolnum></citerefentry> for more information on
      these security policy modules and the various mechanisms they
      provide.</para>
  </sect1>

  <sect1 xml:id="mac-inline-glossary">
    <title>關鍵詞</title>

    <para xml:lang="en">The following key terms are used when referring to the
      <acronym>MAC</acronym> framework:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en"><emphasis>compartment</emphasis>: a set of programs and
	  data to be partitioned or separated, where users are given
	  explicit access to specific component of a system.  A
	  compartment represents a grouping, such as a work group,
	  department, project, or topic.  Compartments make it
	  possible to implement a need-to-know-basis security
	  policy.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>integrity</emphasis>: the level of trust which
	  can be placed on data.  As the integrity of the data is
	  elevated, so does the ability to trust that data.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>level</emphasis>: the increased or decreased
	  setting of a security attribute.  As the level increases,
	  its security is considered to elevate as well.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>label</emphasis>: a security attribute which
	  can be applied to files, directories, or other items in the
	  system.  It could be considered a confidentiality stamp.
	  When a label is placed on a file, it describes the security
	  properties of that file and will only permit access by
	  files, users, and resources with a similar security setting.
	  The meaning and interpretation of label values depends on
	  the policy configuration.  Some policies treat a label as
	  representing the integrity or secrecy of an object while
	  other policies might use labels to hold rules for
	  access.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>multilabel</emphasis>: this property is a file
	  system option which can be set in single-user mode using
	  <citerefentry><refentrytitle>tunefs</refentrytitle><manvolnum>8</manvolnum></citerefentry>, during boot using <citerefentry><refentrytitle>fstab</refentrytitle><manvolnum>5</manvolnum></citerefentry>, or during
	  the creation of a new file system.  This option permits
	  an administrator to apply different <acronym>MAC</acronym>
	  labels on different objects.  This option only applies to
	  security policy modules which support labeling.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>single label</emphasis>: a policy where the
	  entire file system uses one label to enforce access control
	  over the flow of data.  Whenever <option>multilabel</option>
	  is not set, all files will conform to the same label
	  setting.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>object</emphasis>: an entity through which
	  information flows under the direction of a
	  <emphasis>subject</emphasis>.  This includes directories,
	  files, fields, screens, keyboards, memory, magnetic storage,
	  printers or any other data storage or moving device.  An
	  object is a data container or a system resource.  Access to
	  an object effectively means access to its data.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>subject</emphasis>: any active entity that
	  causes information to flow between
	  <emphasis>objects</emphasis> such as a user, user process,
	  or system process.  On FreeBSD, this is almost always a
	  thread acting in a process on behalf of a user.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>policy</emphasis>: a collection of rules
	  which defines how objectives are to be achieved.  A policy
	  usually documents how certain items are to be handled.  This
	  chapter considers a policy to be a collection of rules which
	  controls the flow of data and information and defines who
	  has access to that data and information.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>high-watermark</emphasis>: this type of
	  policy permits the raising of security levels for the
	  purpose of accessing higher level information.  In most
	  cases, the original level is restored after the process is
	  complete.  Currently, the FreeBSD <acronym>MAC</acronym>
	  framework does not include this type of policy.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>low-watermark</emphasis>: this type of policy
	  permits lowering security levels for the purpose of
	  accessing information which is less secure.  In most cases,
	  the original security level of the user is restored after
	  the process is complete.  The only security policy module in
	  FreeBSD to use this is <citerefentry><refentrytitle>mac_lomac</refentrytitle><manvolnum>4</manvolnum></citerefentry>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>sensitivity</emphasis>: usually used when
	  discussing Multilevel Security (<acronym>MLS</acronym>).  A
	  sensitivity level describes how important or secret the data
	  should be.  As the sensitivity level increases, so does the
	  importance of the secrecy, or confidentiality, of the
	  data.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="mac-understandlabel">
    <title>了解 MAC 標籤</title>

    <para xml:lang="en">A <acronym>MAC</acronym> label is a security attribute
      which may be applied to subjects and objects throughout the
      system.  When setting a label, the administrator must
      understand its implications in order to prevent unexpected or
      undesired behavior of the system.  The attributes available on
      an object depend on the loaded policy module, as policy modules
      interpret their attributes in different ways.</para>

    <para xml:lang="en">The security label on an object is used as a part of a
      security access control decision by a policy.  With some
      policies, the label contains all of the information necessary
      to make a decision.  In other policies, the labels may be
      processed as part of a larger rule set.</para>

    <para xml:lang="en">There are two types of label policies: single label and
      multi label.  By default, the system will use single label.  The
      administrator should be aware of the pros and cons of each in
      order to implement policies which meet the requirements of the
      system's security model.</para>

    <para xml:lang="en">A single label security policy only permits one label to be
      used for every subject or object.  Since a single label policy
      enforces one set of access permissions across the entire system,
      it provides lower administration overhead, but decreases the
      flexibility of policies which support labeling.  However, in
      many environments, a single label policy may be all that is
      required.</para>

    <para xml:lang="en">A single label policy is somewhat similar to
      <acronym>DAC</acronym> as <systemitem class="username">root</systemitem> configures the policies so
      that users are placed in the appropriate categories and access
      levels.  A notable difference is that many policy modules can
      also restrict <systemitem class="username">root</systemitem>.
      Basic control over objects will then be released to the group,
      but <systemitem class="username">root</systemitem> may revoke or
      modify the settings at any time.</para>

    <para xml:lang="en">When appropriate, a multi label policy can be set on a
      <acronym>UFS</acronym> file system by passing
      <option>multilabel</option> to <citerefentry><refentrytitle>tunefs</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  A multi label
      policy permits each subject or object to have its own
      independent <acronym>MAC</acronym> label.  The decision to use a
      multi label or single label policy is only required for policies
      which implement the labeling feature, such as
      <literal>biba</literal>, <literal>lomac</literal>, and
      <literal>mls</literal>.  Some policies, such as
      <literal>seeotheruids</literal>, <literal>portacl</literal> and
      <literal>partition</literal>, do not use labels at all.</para>

    <para xml:lang="en">Using a multi label policy on a partition and establishing a
      multi label security model can increase administrative overhead
      as everything in that file system has a label.  This includes
      directories, files, and even device nodes.</para>

    <para xml:lang="en">The following command will set <option>multilabel</option>
      on the specified <acronym>UFS</acronym> file system.  This may
      only be done in single-user mode and is not a requirement for
      the swap file system:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>tunefs -l enable /</userinput></screen>

    <note>
      <para xml:lang="en">Some users have experienced problems with setting the
	<option>multilabel</option> flag on the root partition.  If
	this is the case, please review <xref linkend="mac-troubleshoot"/>.</para>
    </note>

    <para xml:lang="en">Since the multi label policy is set on a per-file system
      basis, a multi label policy may not be needed if the file system
      layout is well designed.  Consider an example security
      <acronym>MAC</acronym> model for a FreeBSD web server.  This
      machine uses the single label, <literal>biba/high</literal>, for
      everything in the default file systems.  If the web server needs
      to run at <literal>biba/low</literal> to prevent write up
      capabilities, it could be installed to a separate
      <acronym>UFS</acronym> <filename>/usr/local</filename> file
      system set at <literal>biba/low</literal>.</para>

    <sect2>
      <title>標籤設定</title>

      <para xml:lang="en">Virtually all aspects of label policy module configuration
	will be performed using the base system utilities.  These
	commands provide a simple interface for object or subject
	configuration or the manipulation and verification of
	the configuration.</para>

      <para xml:lang="en">All configuration may be done using
	<command>setfmac</command>, which is used to set
	<acronym>MAC</acronym> labels on system objects, and
	<command>setpmac</command>, which is used to set the labels on
	system subjects.  For example, to set the
	<literal>biba</literal> <acronym>MAC</acronym> label to
	<literal>high</literal> on <filename>test</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>setfmac biba/high test</userinput></screen>

      <para xml:lang="en">If the configuration is successful, the prompt will be
	returned without error.  A common error is
	<errorname>Permission denied</errorname> which usually occurs
	when the label is being set or modified on a restricted
	object.  Other conditions may produce different failures.  For
	instance, the file may not be owned by the user attempting to
	relabel the object, the object may not exist, or the object
	may be read-only.  A mandatory policy will not allow the
	process to relabel the file, maybe because of a property of
	the file, a property of the process, or a property of the
	proposed new label value.  For example, if a user running at
	low integrity tries to change the label of a high integrity
	file, or a user running at low integrity tries to change the
	label of a low integrity file to a high integrity label, these
	operations will fail.</para>

      <para xml:lang="en">The system administrator may use
	<command>setpmac</command> to override the policy module's
	settings by assigning a different label to the invoked
	process:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>setfmac biba/high test</userinput>
<errorname>Permission denied</errorname>
<prompt>#</prompt> <userinput>setpmac biba/low setfmac biba/high test</userinput>
<prompt>#</prompt> <userinput>getfmac test</userinput>
test: biba/high</screen>

      <para xml:lang="en">For currently running processes, such as
	<application>sendmail</application>,
	<command>getpmac</command> is usually used instead.  This
	command takes a process ID (<acronym>PID</acronym>) in place
	of a command name.  If users attempt to manipulate a file not
	in their access, subject to the rules of the loaded policy
	modules, the <errorname>Operation not permitted</errorname>
	error will be displayed.</para>
    </sect2>

    <sect2>
      <title>預先定義的標籤</title>

      <para xml:lang="en">A few FreeBSD policy modules which support the labeling
	feature offer three predefined labels: <literal>low</literal>,
	<literal>equal</literal>, and <literal>high</literal>,
	where:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><literal>low</literal> is considered the lowest label
	    setting an object or subject may have.  Setting this on
	    objects or subjects blocks their access to objects or
	    subjects marked high.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><literal>equal</literal> sets the subject or object to
	    be disabled or unaffected and should only be placed on
	    objects considered to be exempt from the policy.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><literal>high</literal> grants an object or subject
	    the highest setting available in the Biba and
	    <acronym>MLS</acronym> policy modules.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">Such policy modules include <citerefentry><refentrytitle>mac_biba</refentrytitle><manvolnum>4</manvolnum></citerefentry>,
	<citerefentry><refentrytitle>mac_mls</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>mac_lomac</refentrytitle><manvolnum>4</manvolnum></citerefentry>.  Each of the predefined
	labels establishes a different information flow directive.
	Refer to the manual page of the module to determine the traits
	of the generic label configurations.</para>
    </sect2>

    <sect2>
      <title>數值標籤</title>

      <para xml:lang="en">The Biba and <acronym>MLS</acronym> policy modules support
	a numeric label which may be set to indicate the precise level
	of hierarchical control.  This numeric level is used to
	partition or sort information into different groups of
	classification, only permitting access to that group or a
	higher group level.  For example:</para>

      <programlisting xml:lang="en">biba/10:2+3+6(5:2+3-20:2+3+4+5+6)</programlisting>

      <para xml:lang="en">may be interpreted as <quote>Biba Policy Label/Grade
	  10:Compartments 2, 3 and 6: (grade 5 ...</quote>)</para>

      <para xml:lang="en">In this example, the first grade would be considered the
	effective grade with effective compartments, the second grade
	is the low grade, and the last one is the high grade.  In most
	configurations, such fine-grained settings are not needed as
	they are considered to be advanced configurations.</para>

      <para xml:lang="en">System objects only have a current grade and compartment.
	System subjects reflect the range of available rights in the
	system, and network interfaces, where they are used for access
	control.</para>

      <para xml:lang="en">The grade and compartments in a subject and object pair
	are used to construct a relationship known as
	<firstterm>dominance</firstterm>, in which a subject dominates
	an object, the object dominates the subject, neither dominates
	the other, or both dominate each other.  The <quote>both
	  dominate</quote> case occurs when the two labels are equal.
	Due to the information flow nature of Biba, a user has rights
	to a set of compartments that might correspond to projects,
	but objects also have a set of compartments.  Users may have
	to subset their rights using <command>su</command> or
	<command>setpmac</command> in order to access objects in a
	compartment from which they are not restricted.</para>
    </sect2>

    <sect2>
      <title>使用者標籤</title>

      <para xml:lang="en">Users are required to have labels so that their files and
	processes properly interact with the security policy defined
	on the system.  This is configured in
	<filename>/etc/login.conf</filename> using login classes.
	Every policy module that uses labels will implement the user
	class setting.</para>

      <para xml:lang="en">To set the user class default label which will be enforced
	by <acronym>MAC</acronym>, add a <option>label</option> entry.
	An example <option>label</option> entry containing every
	policy module is displayed below.  Note that in a real
	configuration, the administrator would never enable every
	policy module.  It is recommended that the rest of this
	chapter be reviewed before any configuration is
	implemented.</para>

      <programlisting xml:lang="en">default:\
	:copyright=/etc/COPYRIGHT:\
	:welcome=/etc/motd:\
	:setenv=MAIL=/var/mail/$,BLOCKSIZE=K:\
	:path=~/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:\
	:manpath=/usr/share/man /usr/local/man:\
	:nologin=/usr/sbin/nologin:\
	:cputime=1h30m:\
	:datasize=8M:\
	:vmemoryuse=100M:\
	:stacksize=2M:\
	:memorylocked=4M:\
	:memoryuse=8M:\
	:filesize=8M:\
	:coredumpsize=8M:\
	:openfiles=24:\
	:maxproc=32:\
	:priority=0:\
	:requirehome:\
	:passwordtime=91d:\
	:umask=022:\
	:ignoretime@:\
	:label=partition/13,mls/5,biba/10(5-15),lomac/10[2]:</programlisting>

      <para xml:lang="en">While users can not modify the default value, they may
	change their label after they login, subject to the
	constraints of the policy.  The example above tells the Biba
	policy that a process's minimum integrity is
	<literal>5</literal>, its maximum is <literal>15</literal>,
	and the default effective label is <literal>10</literal>.  The
	process will run at <literal>10</literal> until it chooses to
	change label, perhaps due to the user using
	<command>setpmac</command>, which will be constrained by Biba
	to the configured range.</para>

      <para xml:lang="en">After any change to <filename>login.conf</filename>, the
	login class capability database must be rebuilt using
	<command>cap_mkdb</command>.</para>

      <para xml:lang="en">Many sites have a large number of users requiring
	several different user classes.  In depth planning is
	required as this can become difficult to manage.</para>
    </sect2>

    <sect2>
      <title>網路介面標籤</title>

      <para xml:lang="en">Labels may be set on network interfaces to help control
	the flow of data across the network.  Policies using network
	interface labels function in the same way that policies
	function with respect to objects.  Users at high settings in
	Biba, for example, will not be permitted to access network
	interfaces with a label of <literal>low</literal>.</para>

      <para xml:lang="en">When setting the <acronym>MAC</acronym> label on network
	interfaces, <option>maclabel</option> may be passed to
	<command>ifconfig</command>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig bge0 maclabel biba/equal</userinput></screen>

      <para xml:lang="en">This example will set the <acronym>MAC</acronym> label of
	<literal>biba/equal</literal> on the <literal>bge0</literal>
	interface.  When using a setting similar to
	<literal>biba/high(low-high)</literal>, the entire label
	should be quoted to prevent an error from being
	returned.</para>

      <para xml:lang="en">Each policy module which supports labeling has a tunable
	which may be used to disable the <acronym>MAC</acronym> label
	on network interfaces.  Setting the label to
	<option>equal</option> will have a similar effect.  Review
	the output of <command>sysctl</command>, the policy manual
	pages, and the information in the rest of this chapter for
	more information on those tunables.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="mac-planning">
    <title>規劃安全架構</title>

    <para xml:lang="en">Before implementing any <acronym>MAC</acronym> policies, a
      planning phase is recommended.  During the planning stages, an
      administrator should consider the implementation requirements
      and goals, such as:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">How to classify information and resources available on
	  the target systems.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Which information or resources to restrict access to
	  along with the type of restrictions that should be
	  applied.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Which <acronym>MAC</acronym> modules will be required to
	  achieve this goal.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">A trial run of the trusted system and its configuration
      should occur <emphasis>before</emphasis> a
      <acronym>MAC</acronym> implementation is used on production
      systems.  Since different environments have different needs and
      requirements, establishing a complete security profile will
      decrease the need of changes once the system goes live.</para>

    <para xml:lang="en">Consider how the <acronym>MAC</acronym> framework augments
      the security of the system as a whole.  The various security
      policy modules provided by the <acronym>MAC</acronym> framework
      could be used to protect the network and file systems or to
      block users from accessing certain ports and sockets.  Perhaps
      the best use of the policy modules is to load several security
      policy modules at a time in order to provide a
      <acronym>MLS</acronym> environment.  This approach differs from
      a hardening policy, which typically hardens elements of a system
      which are used only for specific purposes.  The downside to
      <acronym>MLS</acronym> is increased administrative
      overhead.</para>

    <para xml:lang="en">The overhead is minimal when compared to the lasting effect
      of a framework which provides the ability to pick and choose
      which policies are required for a specific configuration and
      which keeps performance overhead down.  The reduction of support
      for unneeded policies can increase the overall performance of
      the system as well as offer flexibility of choice.  A good
      implementation would consider the overall security requirements
      and effectively implement the various security policy modules
      offered by the framework.</para>

    <para xml:lang="en">A system utilizing <acronym>MAC</acronym> guarantees that a
      user will not be permitted to change security attributes at
      will.  All user utilities, programs, and scripts must work
      within the constraints of the access rules provided by the
      selected security policy modules and control of the
      <acronym>MAC</acronym> access rules is in the hands of the
      system administrator.</para>

    <para xml:lang="en">It is the duty of the system administrator to carefully
      select the correct security policy modules.  For an environment
      that needs to limit access control over the network, the
      <citerefentry><refentrytitle>mac_portacl</refentrytitle><manvolnum>4</manvolnum></citerefentry>, <citerefentry><refentrytitle>mac_ifoff</refentrytitle><manvolnum>4</manvolnum></citerefentry>, and <citerefentry><refentrytitle>mac_biba</refentrytitle><manvolnum>4</manvolnum></citerefentry>
      policy modules make good starting points.  For an environment
      where strict confidentiality of file system objects is required,
      consider the <citerefentry><refentrytitle>mac_bsdextended</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>mac_mls</refentrytitle><manvolnum>4</manvolnum></citerefentry> policy
      modules.</para>

    <para xml:lang="en">Policy decisions could be made based on network
      configuration.  If only certain users should be permitted
      access to <citerefentry><refentrytitle>ssh</refentrytitle><manvolnum>1</manvolnum></citerefentry>, the <citerefentry><refentrytitle>mac_portacl</refentrytitle><manvolnum>4</manvolnum></citerefentry> policy module is
      a good choice.  In the case of file systems, access to objects
      might be considered confidential to some users, but not to
      others.  As an example, a large development team might be
      broken off into smaller projects where  developers in project A
      might not be permitted to access objects written by developers
      in project B.  Yet both projects might need to access objects
      created by developers in project C.  Using the different
      security policy modules provided by the <acronym>MAC</acronym>
      framework, users could be divided into these groups and then
      given access to the appropriate objects.</para>

    <para xml:lang="en">Each security policy module has a unique way of dealing with
      the overall security of a system.  Module selection should be
      based on a well thought out security policy which may require
      revision and reimplementation.  Understanding the different
      security policy modules offered by the <acronym>MAC</acronym>
      framework will help administrators choose the best policies
      for their situations.</para>

    <para xml:lang="en">  The rest of this chapter covers the available modules,
      describes their use and configuration, and in some cases,
      provides insight on applicable situations.</para>

    <caution>
      <para xml:lang="en">Implementing <acronym>MAC</acronym> is much like
	implementing a firewall since care must be taken to prevent
	being completely locked out of the system.  The ability to
	revert back to a previous configuration should be considered
	and the implementation of <acronym>MAC</acronym> over a remote
	connection should be done with extreme caution.</para>
    </caution>
  </sect1>

  <sect1 xml:id="mac-policies">
    <title>可用的 MAC 管理政策</title>

    <para xml:lang="en">The default FreeBSD kernel
      includes <literal>options MAC</literal>.  This means that every
      module included with the <acronym>MAC</acronym> framework can be
      loaded with <command>kldload</command> as a run-time kernel
      module.  After testing the module, add the module name to
      <filename>/boot/loader.conf</filename> so that it will load
      during boot.  Each module also provides a kernel option for
      those administrators who choose to compile their own custom
      kernel.</para>

    <para xml:lang="en">FreeBSD includes a group of policies that will cover most
      security requirements.  Each policy is summarized below.  The
      last three policies support integer settings in place of the
      three default labels.</para>

    <sect2 xml:id="mac-seeotheruids">
      <title>MAC See Other UIDs 政策</title>

      <indexterm xml:lang="en">
	<primary>MAC See Other UIDs Policy</primary>
      </indexterm>
      <para xml:lang="en">Module name:
	<filename>mac_seeotheruids.ko</filename></para>

      <para xml:lang="en">Kernel configuration line:
	<literal>options MAC_SEEOTHERUIDS</literal></para>

      <para xml:lang="en">Boot option:
	<literal>mac_seeotheruids_load="YES"</literal></para>

      <para xml:lang="en">The <citerefentry><refentrytitle>mac_seeotheruids</refentrytitle><manvolnum>4</manvolnum></citerefentry> module extends the
	<varname>security.bsd.see_other_uids</varname> and
	<varname>security.bsd.see_other_gids</varname>
	<command>sysctl</command> tunables.  This option does not
	require any labels to be set before configuration and can
	operate transparently with other modules.</para>

      <para xml:lang="en">After loading the module, the following
	<command>sysctl</command> tunables may be used to control its
	features:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><varname>security.mac.seeotheruids.enabled</varname>
	    enables the module and implements the default settings
	    which deny users the ability to view processes and sockets
	    owned by other users.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">
	    <varname>security.mac.seeotheruids.specificgid_enabled</varname>
	    allows specified groups to be exempt from this policy.  To
	    exempt specific groups, use the
	    <varname>security.mac.seeotheruids.specificgid=<replaceable>XXX</replaceable></varname>
	    <command>sysctl</command> tunable, replacing
	    <replaceable>XXX</replaceable> with the numeric group ID
	    to be exempted.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">
	    <varname>security.mac.seeotheruids.primarygroup_enabled</varname>
	    is used to exempt specific primary groups from this
	    policy.  When using this tunable,
	    <varname>security.mac.seeotheruids.specificgid_enabled</varname>
	    may not be set.</para>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="mac-bsdextended">
      <title>MAC BSD Extended 政策</title>

      <indexterm xml:lang="en">
	<primary>MAC</primary>
	  <secondary>File System Firewall Policy</secondary>
      </indexterm>
      <para xml:lang="en">Module name:
	<filename>mac_bsdextended.ko</filename></para>

      <para xml:lang="en">Kernel configuration line:
	<literal>options MAC_BSDEXTENDED</literal></para>

      <para xml:lang="en">Boot option:
	<literal>mac_bsdextended_load="YES"</literal></para>

      <para xml:lang="en">The <citerefentry><refentrytitle>mac_bsdextended</refentrytitle><manvolnum>4</manvolnum></citerefentry> module enforces a file system
	firewall.  It provides an extension to the standard file
	system permissions model, permitting an administrator to
	create a firewall-like ruleset to protect files, utilities,
	and directories in the file system hierarchy.  When access to
	a file system object is attempted, the list of rules is
	iterated until either a matching rule is located or the end is
	reached.  This behavior may be changed using
	<varname>security.mac.bsdextended.firstmatch_enabled</varname>.
	Similar to other firewall modules in FreeBSD, a file containing
	the access control rules can be created and read by the system
	at boot time using an <citerefentry><refentrytitle>rc.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> variable.</para>

      <para xml:lang="en">The rule list may be entered using <citerefentry><refentrytitle>ugidfw</refentrytitle><manvolnum>8</manvolnum></citerefentry> which
	has a syntax similar to <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  More tools can be
	written by using the functions in the <citerefentry><refentrytitle>libugidfw</refentrytitle><manvolnum>3</manvolnum></citerefentry>
	library.</para>

      <para xml:lang="en">After the <citerefentry><refentrytitle>mac_bsdextended</refentrytitle><manvolnum>4</manvolnum></citerefentry> module has been loaded,
	the following command may be used to list the current rule
	configuration:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ugidfw list</userinput>
0 slots, 0 rules</screen>

      <para xml:lang="en">By default, no rules are defined and everything is
	completely accessible.  To create a rule which blocks all
	access by users but leaves <systemitem class="username">root</systemitem> unaffected:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ugidfw add subject not uid root new object not uid root mode n</userinput></screen>

      <para xml:lang="en">While this rule is simple to implement, it is a very bad
	idea as it blocks all users from issuing any commands.  A
	more realistic example blocks <systemitem class="username">user1</systemitem> all access, including
	directory listings, to <systemitem class="username"><replaceable>user2</replaceable></systemitem>'s
	home directory:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ugidfw set 2 subject uid <replaceable>user1</replaceable> object uid <replaceable>user2</replaceable> mode n</userinput>
<prompt>#</prompt> <userinput>ugidfw set 3 subject uid <replaceable>user1</replaceable> object gid <replaceable>user2</replaceable> mode n</userinput></screen>

      <para xml:lang="en">Instead of <systemitem class="username">user1</systemitem>, <option>not
	  uid <replaceable>user2</replaceable></option> could be used
	in order to enforce the same access restrictions for all
	users.  However, the <systemitem class="username">root</systemitem> user is unaffected by
	these rules.</para>

      <note>
	<para xml:lang="en">Extreme caution should be taken when working with this
	  module as incorrect use could block access to certain
	  parts of the file system.</para>
      </note>
    </sect2>

    <sect2 xml:id="mac-ifoff">
      <title>MAC Interface Silencing 政策</title>

      <indexterm xml:lang="en">
	<primary>MAC Interface Silencing Policy</primary>
      </indexterm>
      <para xml:lang="en">Module name: <filename>mac_ifoff.ko</filename></para>

      <para xml:lang="en">Kernel configuration line: <literal>options
	  MAC_IFOFF</literal></para>

      <para xml:lang="en">Boot option:
	<literal>mac_ifoff_load="YES"</literal></para>

      <para xml:lang="en">The <citerefentry><refentrytitle>mac_ifoff</refentrytitle><manvolnum>4</manvolnum></citerefentry> module is used to disable network
	interfaces on the fly and to keep network interfaces from
	being brought up during system boot.  It does not use labels
	and does not depend on any other
	<acronym>MAC</acronym> modules.</para>

      <para xml:lang="en">Most of this module's control is performed through these
	<command>sysctl</command> tunables:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><varname>security.mac.ifoff.lo_enabled</varname>
	    enables or disables all traffic on the loopback,
	    <citerefentry><refentrytitle>lo</refentrytitle><manvolnum>4</manvolnum></citerefentry>, interface.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.mac.ifoff.bpfrecv_enabled</varname>
	    enables or disables all traffic on the Berkeley Packet
	    Filter interface, <citerefentry><refentrytitle>bpf</refentrytitle><manvolnum>4</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.mac.ifoff.other_enabled</varname>
	    enables or disables traffic on all other
	    interfaces.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">One of the most common uses of <citerefentry><refentrytitle>mac_ifoff</refentrytitle><manvolnum>4</manvolnum></citerefentry> is
	network monitoring in an environment where network traffic
	should not be permitted during the boot sequence.  Another
	use would be to write a script which uses an application such
	as <package>security/aide</package> to automatically block
	network traffic if it finds new or altered files in protected
	directories.</para>
    </sect2>

    <sect2 xml:id="mac-portacl">
      <title>MAC Port Access Control 政策</title>

      <indexterm xml:lang="en">
	<primary>MAC Port Access Control List Policy</primary>
      </indexterm>
      <para xml:lang="en">Module name: <filename>mac_portacl.ko</filename></para>

      <para xml:lang="en">Kernel configuration line:
	<literal>MAC_PORTACL</literal></para>

      <para xml:lang="en">Boot option:
	<literal>mac_portacl_load="YES"</literal></para>

      <para xml:lang="en">The <citerefentry><refentrytitle>mac_portacl</refentrytitle><manvolnum>4</manvolnum></citerefentry> module is used to limit binding to
	local <acronym>TCP</acronym> and <acronym>UDP</acronym> ports,
	making it possible to allow non-<systemitem class="username">root</systemitem> users to bind to
	specified privileged ports below 1024.</para>

      <para xml:lang="en">Once loaded, this module enables the
	<acronym>MAC</acronym> policy on all sockets.  The following
	tunables are available:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><varname>security.mac.portacl.enabled</varname>
	    enables or disables the policy completely.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.mac.portacl.port_high</varname>
	    sets the highest port number that <citerefentry><refentrytitle>mac_portacl</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	    protects.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.mac.portacl.suser_exempt</varname>,
	    when set to a non-zero value, exempts the <systemitem class="username">root</systemitem> user from this
	    policy.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.mac.portacl.rules</varname>
	    specifies the policy as a text string of the form
	    <literal>rule[,rule,...]</literal>, with as many rules as
	    needed, and where each rule is of the form
	    <literal>idtype:id:protocol:port</literal>.  The
	    <parameter>idtype</parameter> is either
	    <literal>uid</literal> or <literal>gid</literal>.  The
	    <parameter>protocol</parameter> parameter can be
	    <literal>tcp</literal> or <literal>udp</literal>.  The
	    <parameter>port</parameter> parameter is the port number
	    to allow the specified user or group to bind to.  Only
	    numeric values can be used for the user ID, group ID,
	    and port parameters.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">By default, ports below 1024 can only be used by
	privileged processes which run as <systemitem class="username">root</systemitem>.  For <citerefentry><refentrytitle>mac_portacl</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	to allow non-privileged processes to bind to ports below 1024,
	set the following tunables as
	follows:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl security.mac.portacl.port_high=1023</userinput>
<prompt>#</prompt> <userinput>sysctl net.inet.ip.portrange.reservedlow=0</userinput>
<prompt>#</prompt> <userinput>sysctl net.inet.ip.portrange.reservedhigh=0</userinput></screen>

      <para xml:lang="en">To prevent the <systemitem class="username">root</systemitem> user from being affected
	by this policy, set
	<varname>security.mac.portacl.suser_exempt</varname> to a
	non-zero value.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl security.mac.portacl.suser_exempt=1</userinput></screen>

      <para xml:lang="en">To allow the <systemitem class="username">www</systemitem>
	user with <acronym>UID</acronym> 80 to bind to port 80
	without ever needing <systemitem class="username">root</systemitem> privilege:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl security.mac.portacl.rules=uid:80:tcp:80</userinput></screen>

      <para xml:lang="en">This next example permits the user with the
	<acronym>UID</acronym> of 1001 to bind to
	<acronym>TCP</acronym> ports 110 (POP3) and 995
	(POP3s):</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl security.mac.portacl.rules=uid:1001:tcp:110,uid:1001:tcp:995</userinput></screen>
    </sect2>

    <sect2 xml:id="mac-partition">
      <title>MAC Partition 政策</title>

      <indexterm xml:lang="en">
	<primary>MAC Process Partition Policy</primary>
      </indexterm>
      <para xml:lang="en">Module name: <filename>mac_partition.ko</filename></para>

      <para xml:lang="en">Kernel configuration line:
	<literal>options MAC_PARTITION</literal></para>

      <para xml:lang="en">Boot option:
	<literal>mac_partition_load="YES"</literal></para>

      <para xml:lang="en">The <citerefentry><refentrytitle>mac_partition</refentrytitle><manvolnum>4</manvolnum></citerefentry> policy drops processes into
	specific <quote>partitions</quote> based on their
	<acronym>MAC</acronym> label.  Most configuration for this
	policy is done using <citerefentry><refentrytitle>setpmac</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  One
	<command>sysctl</command> tunable is available for this
	policy:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><varname>security.mac.partition.enabled</varname>
	    enables the enforcement of <acronym>MAC</acronym> process
	    partitions.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">When this policy is enabled, users will only be permitted
	to see their processes, and any others within their partition,
	but will not be permitted to work with utilities outside the
	scope of this partition.  For instance, a user in the
	<literal>insecure</literal> class will not be permitted to
	access <command>top</command> as well as many other commands
	that must spawn a process.</para>

      <para xml:lang="en">This example adds <command>top</command> to the label set
	on users in the <literal>insecure</literal> class.  All
	processes spawned by users in the <literal>insecure</literal>
	class will stay in the <literal>partition/13</literal>
	label.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>setpmac partition/13 top</userinput></screen>

      <para xml:lang="en">This command displays the partition label and the process
	list:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ps Zax</userinput></screen>

      <para xml:lang="en">This command displays another user's process partition
	label and that user's currently running processes:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ps -ZU trhodes</userinput></screen>

      <note>
	<para xml:lang="en">Users can see processes in <systemitem class="username">root</systemitem>'s label unless the
	  <citerefentry><refentrytitle>mac_seeotheruids</refentrytitle><manvolnum>4</manvolnum></citerefentry> policy is loaded.</para>
      </note>
    </sect2>

    <sect2 xml:id="mac-mls">
      <title>MAC Multi-Level Security 模組</title>

      <indexterm xml:lang="en">
	<primary>MAC Multi-Level Security Policy</primary>
      </indexterm>
      <para xml:lang="en">Module name: <filename>mac_mls.ko</filename></para>

      <para xml:lang="en">Kernel configuration line:
	<literal>options MAC_MLS</literal></para>

      <para xml:lang="en">Boot option: <literal>mac_mls_load="YES"</literal></para>

      <para xml:lang="en">The <citerefentry><refentrytitle>mac_mls</refentrytitle><manvolnum>4</manvolnum></citerefentry> policy controls access between
	subjects and objects in the system by enforcing a strict
	information flow policy.</para>

      <para xml:lang="en">In <acronym>MLS</acronym> environments, a
	<quote>clearance</quote> level is set in the label of each
	subject or object, along with compartments.  Since these
	clearance levels can reach numbers greater than several
	thousand, it would be a daunting task to thoroughly configure
	every subject or object.  To ease this administrative
	overhead, three labels are included in this policy:
	<literal>mls/low</literal>, <literal>mls/equal</literal>, and
	<literal>mls/high</literal>, where:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Anything labeled with <literal>mls/low</literal> will
	    have a low clearance level and not be permitted to access
	    information of a higher level.  This label also prevents
	    objects of a higher clearance level from writing or
	    passing information to a lower level.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><literal>mls/equal</literal> should be placed on
	    objects which should be exempt from the policy.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><literal>mls/high</literal> is the highest level of
	    clearance possible.  Objects assigned this label will hold
	    dominance over all other objects in the system; however,
	    they will not permit the leaking of information to objects
	    of a lower class.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en"><acronym>MLS</acronym> provides:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">A hierarchical security level with a set of
	    non-hierarchical categories.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Fixed rules of <literal>no read up, no write
	      down</literal>.  This means that a subject can have read
	    access to objects on its own level or below, but not
	    above.  Similarly, a subject can have write access to
	    objects on its own level or above, but not beneath.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Secrecy, or the prevention of inappropriate disclosure
	    of data.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">A basis for the design of systems that concurrently
	    handle data at multiple sensitivity levels without leaking
	    information between secret and confidential.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">The following <command>sysctl</command> tunables are
	available:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><varname>security.mac.mls.enabled</varname> is used to
	    enable or disable the <acronym>MLS</acronym>
	    policy.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.mac.mls.ptys_equal</varname>
	    labels all <citerefentry><refentrytitle>pty</refentrytitle><manvolnum>4</manvolnum></citerefentry> devices as
	    <literal>mls/equal</literal> during creation.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.mac.mls.revocation_enabled</varname>
	    revokes access to objects after their label changes to a
	    label of a lower grade.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.mac.mls.max_compartments</varname>
	    sets the maximum number of compartment levels allowed on a
	    system.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">To manipulate <acronym>MLS</acronym> labels, use
	<citerefentry><refentrytitle>setfmac</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  To assign a label to an object:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>setfmac mls/5 test</userinput></screen>

      <para xml:lang="en">To get the <acronym>MLS</acronym> label for the file
	<filename>test</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>getfmac test</userinput></screen>

      <para xml:lang="en">Another approach is to create a master policy file in
	<filename>/etc/</filename> which specifies the
	<acronym>MLS</acronym> policy information and to feed that
	file to <command>setfmac</command>.</para>

      <para xml:lang="en">When using the <acronym>MLS</acronym> policy module, an
	administrator plans to control the flow of sensitive
	information.  The default <literal>block read up block write
	  down</literal> sets everything to a low state.  Everything
	is accessible and an administrator slowly augments the
	confidentiality of the information.</para>

      <para xml:lang="en">Beyond the three basic label options, an administrator
	may group users and groups as required to block the
	information flow between them.  It might be easier to look at
	the information in clearance levels using descriptive words,
	such as classifications of <literal>Confidential</literal>,
	<literal>Secret</literal>, and <literal>Top Secret</literal>.
	Some administrators instead create different groups based on
	project levels.  Regardless of the classification method, a
	well thought out plan must exist before implementing a
	restrictive policy.</para>

      <para xml:lang="en">Some example situations for the <acronym>MLS</acronym>
	policy module include an e-commerce web server, a file server
	holding critical company information, and financial
	institution environments.</para>
    </sect2>

    <sect2 xml:id="mac-biba">
      <title>MAC Biba 模組</title>

      <indexterm xml:lang="en">
	<primary>MAC Biba Integrity Policy</primary>
      </indexterm>
      <para xml:lang="en">Module name: <filename>mac_biba.ko</filename></para>

      <para xml:lang="en">Kernel configuration line: <literal>options
	  MAC_BIBA</literal></para>

      <para xml:lang="en">Boot option: <literal>mac_biba_load="YES"</literal></para>

      <para xml:lang="en">The <citerefentry><refentrytitle>mac_biba</refentrytitle><manvolnum>4</manvolnum></citerefentry> module loads the
	<acronym>MAC</acronym> Biba policy.  This policy is similar to
	the <acronym>MLS</acronym> policy with the exception that the
	rules for information flow are slightly reversed.  This is to
	prevent the downward flow of sensitive information whereas the
	<acronym>MLS</acronym> policy prevents the upward flow of
	sensitive information.</para>

      <para xml:lang="en">In Biba environments, an <quote>integrity</quote> label is
	set on each subject or object.  These labels are made up of
	hierarchical grades and non-hierarchical components.  As a
	grade ascends, so does its integrity.</para>

      <para xml:lang="en">Supported labels are <literal>biba/low</literal>,
	<literal>biba/equal</literal>, and
	<literal>biba/high</literal>, where:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><literal>biba/low</literal> is considered the lowest
	    integrity an object or subject may have.  Setting this on
	    objects or subjects blocks their write access to objects
	    or subjects marked as <literal>biba/high</literal>, but
	    will not prevent read access.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><literal>biba/equal</literal> should only be placed on
	    objects considered to be exempt from the policy.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><literal>biba/high</literal> permits writing to
	    objects set at a lower label, but does not permit reading
	    that object.  It is recommended that this label be
	    placed on objects that affect the integrity of the entire
	    system.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">Biba provides:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Hierarchical integrity levels with a set of
	    non-hierarchical integrity categories.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Fixed rules are <literal>no write up, no read
	      down</literal>, the opposite of
	    <acronym>MLS</acronym>.  A subject can have write access
	    to objects on its own level or below, but not above.
	    Similarly, a subject can have read access to objects on
	    its own level or above, but not below.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Integrity by preventing inappropriate modification of
	    data.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Integrity levels instead of <acronym>MLS</acronym>
	    sensitivity levels.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">The following tunables can be used to manipulate the Biba
	policy:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><varname>security.mac.biba.enabled</varname> is used
	    to enable or disable enforcement of the Biba policy on the
	    target machine.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.mac.biba.ptys_equal</varname> is
	    used to disable the Biba policy on <citerefentry><refentrytitle>pty</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	    devices.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><varname>security.mac.biba.revocation_enabled</varname>
	    forces the revocation of access to objects if the label is
	    changed to dominate the subject.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">To access the Biba policy setting on system objects, use
	<command>setfmac</command> and
	<command>getfmac</command>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>setfmac biba/low test</userinput>
<prompt>#</prompt> <userinput>getfmac test</userinput>
test: biba/low</screen>

      <para xml:lang="en">Integrity, which is different from sensitivity, is used to
	guarantee that information is not manipulated by untrusted
	parties.  This includes information passed between subjects
	and objects.  It ensures that users will only be able to
	modify or access information they have been given explicit
	access to.  The <citerefentry><refentrytitle>mac_biba</refentrytitle><manvolnum>4</manvolnum></citerefentry> security policy module
	permits an administrator to configure which files and programs
	a user may see and invoke while assuring that the programs and
	files are trusted by the system for that user.</para>

      <para xml:lang="en">During the initial planning phase, an administrator must
	be prepared to partition users into grades, levels, and areas.
	The system will default to a high label once this policy
	module is enabled, and it is up to the administrator to
	configure the different grades and levels for users.  Instead
	of using clearance levels, a good planning method could
	include topics.  For instance, only allow developers
	modification access to the source code repository, source
	code compiler, and other development utilities.  Other users
	would be grouped into other categories such as testers,
	designers, or end users and would only be permitted read
	access.</para>

      <para xml:lang="en">A lower integrity subject is unable to write to a higher
	integrity subject and a higher integrity subject cannot list
	or read a lower integrity object.  Setting a label at the
	lowest possible grade could make it inaccessible to subjects.
	Some prospective environments for this security policy module
	would include a constrained web server, a development and test
	machine, and a source code repository.  A less useful
	implementation would be a personal workstation, a machine used
	as a router, or a network firewall.</para>
    </sect2>

    <sect2 xml:id="mac-lomac">
      <title>MAC Low-watermark 模組</title>

      <indexterm xml:lang="en">
	<primary>MAC LOMAC</primary>
      </indexterm>
      <para xml:lang="en">Module name: <filename>mac_lomac.ko</filename></para>

      <para xml:lang="en">Kernel configuration line: <literal>options
	  MAC_LOMAC</literal></para>

      <para xml:lang="en">Boot option:
	<literal>mac_lomac_load="YES"</literal></para>

      <para xml:lang="en">Unlike the <acronym>MAC</acronym> Biba policy, the
	<citerefentry><refentrytitle>mac_lomac</refentrytitle><manvolnum>4</manvolnum></citerefentry> policy permits access to lower integrity
	objects only after decreasing the integrity level to not
	disrupt any integrity rules.</para>

      <para xml:lang="en">The Low-watermark integrity policy works almost
	identically to Biba, with the exception of using floating
	labels to support subject demotion via an auxiliary grade
	compartment.  This secondary compartment takes the form
	<literal>[auxgrade]</literal>.  When assigning a policy with
	an auxiliary grade, use the syntax
	<literal>lomac/10[2]</literal>, where
	<literal>2</literal> is the auxiliary grade.</para>

      <para xml:lang="en">This policy relies on the ubiquitous labeling of all
	system objects with integrity labels, permitting subjects to
	read from low integrity objects and then downgrading the label
	on the subject to prevent future writes to high integrity
	objects using <literal>[auxgrade]</literal>.  The policy may
	provide greater compatibility and require less initial
	configuration than Biba.</para>

      <para xml:lang="en">Like the Biba and <acronym>MLS</acronym> policies,
	<command>setfmac</command> and <command>setpmac</command>
	are used to place labels on system objects:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>setfmac /usr/home/trhodes lomac/high[low]</userinput>
<prompt>#</prompt> <userinput>getfmac /usr/home/trhodes lomac/high[low]</userinput></screen>

      <para xml:lang="en">The auxiliary grade <literal>low</literal> is a feature
	provided only by the <acronym>MAC</acronym>
	<acronym>LOMAC</acronym> policy.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="mac-userlocked">
    <title xml:lang="en">User Lock Down</title>

    <para xml:lang="en">This example considers a relatively small storage system
      with fewer than fifty users.  Users will have login
      capabilities and are permitted to store data and access
      resources.</para>

    <para xml:lang="en">For this scenario, the <citerefentry><refentrytitle>mac_bsdextended</refentrytitle><manvolnum>4</manvolnum></citerefentry> and
      <citerefentry><refentrytitle>mac_seeotheruids</refentrytitle><manvolnum>4</manvolnum></citerefentry> policy modules could co-exist and block
      access to system objects while hiding user processes.</para>

    <para xml:lang="en">Begin by adding the following line to
      <filename>/boot/loader.conf</filename>:</para>

    <programlisting xml:lang="en">mac_seeotheruids_load="YES"</programlisting>

    <para xml:lang="en">The <citerefentry><refentrytitle>mac_bsdextended</refentrytitle><manvolnum>4</manvolnum></citerefentry> security policy module may be
      activated by adding this line to
      <filename>/etc/rc.conf</filename>:</para>

    <programlisting xml:lang="en">ugidfw_enable="YES"</programlisting>

    <para xml:lang="en">Default rules stored in
      <filename>/etc/rc.bsdextended</filename> will be loaded at
      system initialization.  However, the default entries may need
      modification.  Since this machine is expected only to service
      users, everything may be left commented out except the last
      two lines in order to force the loading of user owned system
      objects by default.</para>

    <para xml:lang="en">Add the required users to this machine and reboot.  For
      testing purposes, try logging in as a different user across
      two consoles.  Run <command>ps aux</command> to see if processes
      of other users are visible.  Verify that running <citerefentry><refentrytitle>ls</refentrytitle><manvolnum>1</manvolnum></citerefentry> on
      another user's home directory fails.</para>

    <para xml:lang="en">Do not try to test with the <systemitem class="username">root</systemitem> user unless the specific
      <command>sysctl</command>s have been modified to block super
      user access.</para>

    <note>
      <para xml:lang="en">When a new user is added, their <citerefentry><refentrytitle>mac_bsdextended</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	rule will not be in the ruleset list.  To update the ruleset
	quickly, unload the security policy module and reload it again
	using <citerefentry><refentrytitle>kldunload</refentrytitle><manvolnum>8</manvolnum></citerefentry> and <citerefentry><refentrytitle>kldload</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
    </note>
  </sect1>

  <sect1 xml:id="mac-implementing">
    <title>在 MAC Jail 中使用 Nagios</title>

    <indexterm xml:lang="en">
      <primary>Nagios in a MAC Jail</primary>
    </indexterm>

    <para xml:lang="en">This section demonstrates the steps that are needed to
      implement the <application>Nagios</application> network
      monitoring system in a <acronym>MAC</acronym> environment.  This
      is meant as an example which still requires the administrator to
      test that the implemented policy meets the security requirements
      of the network before using in a production environment.</para>

    <para xml:lang="en">This example requires <option>multilabel</option> to be set
      on each file system.  It also assumes that
      <package>net-mgmt/nagios-plugins</package>,
      <package>net-mgmt/nagios</package>, and
      <package>www/apache22</package> are all installed, configured,
      and working correctly before attempting the integration into the
      <acronym>MAC</acronym> framework.</para>

    <sect2>
      <title>建立不安全的使用者類別</title>

      <para xml:lang="en">Begin the procedure by adding the following user class
	to <filename>/etc/login.conf</filename>:</para>

      <programlisting xml:lang="en">insecure:\
:copyright=/etc/COPYRIGHT:\
:welcome=/etc/motd:\
:setenv=MAIL=/var/mail/$,BLOCKSIZE=K:\
:path=~/bin:/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin
:manpath=/usr/share/man /usr/local/man:\
:nologin=/usr/sbin/nologin:\
:cputime=1h30m:\
:datasize=8M:\
:vmemoryuse=100M:\
:stacksize=2M:\
:memorylocked=4M:\
:memoryuse=8M:\
:filesize=8M:\
:coredumpsize=8M:\
:openfiles=24:\
:maxproc=32:\
:priority=0:\
:requirehome:\
:passwordtime=91d:\
:umask=022:\
:ignoretime@:\
:label=biba/10(10-10):</programlisting>

      <para xml:lang="en">Then, add the following line to the default user class
	section:</para>

      <programlisting xml:lang="en">:label=biba/high:</programlisting>

      <para xml:lang="en">Save the edits and issue the following command to rebuild
	the database:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cap_mkdb /etc/login.conf</userinput></screen>
    </sect2>

    <sect2>
      <title>設定使用者</title>

      <para xml:lang="en">Set the <systemitem class="username">root</systemitem>
	user to the default class using:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pw usermod root -L default</userinput></screen>

      <para xml:lang="en">All user accounts that are not <systemitem class="username">root</systemitem> will now require a login
	class.  The login class is required, otherwise users will be
	refused access to common commands.  The following
	<command>sh</command> script should do the trick:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>for x in `awk -F: '($3 &gt;= 1001) &amp;&amp; ($3 != 65534) { print $1 }' \</userinput>
	<userinput>/etc/passwd`; do pw usermod $x -L default; done;</userinput></screen>

      <para xml:lang="en">Next, drop the <systemitem class="username">nagios</systemitem> and <systemitem class="username">www</systemitem> accounts into the insecure
	class:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pw usermod nagios -L insecure</userinput>
<prompt>#</prompt> <userinput>pw usermod www -L insecure</userinput></screen>
      </sect2>

      <sect2>
	<title>建立關聯檔 (Context File)</title>

	<para xml:lang="en">A contexts file should now be created as
	  <filename>/etc/policy.contexts</filename>:</para>

	<programlisting xml:lang="en"># This is the default BIBA policy for this system.

# System:
/var/run(/.*)?			biba/equal

/dev/(/.*)?			biba/equal

/var				biba/equal
/var/spool(/.*)?		biba/equal

/var/log(/.*)?			biba/equal

/tmp(/.*)?			biba/equal
/var/tmp(/.*)?			biba/equal

/var/spool/mqueue		biba/equal
/var/spool/clientmqueue		biba/equal

# For Nagios:
/usr/local/etc/nagios(/.*)?	biba/10

/var/spool/nagios(/.*)?		biba/10

# For apache
/usr/local/etc/apache(/.*)?	biba/10</programlisting>

      <para xml:lang="en">This policy enforces security by setting restrictions on
	the flow of information.  In this specific configuration,
	users, including <systemitem class="username">root</systemitem>, should never be
	allowed to access <application>Nagios</application>.
	Configuration files and processes that are a part of
	<application>Nagios</application> will be completely self
	contained or jailed.</para>

      <para xml:lang="en">This file will be read after running
	<command>setfsmac</command> on every file system.  This
	example sets the policy on the root file system:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>setfsmac -ef /etc/policy.contexts /</userinput></screen>

      <para xml:lang="en">Next, add these edits to the main section of
	<filename>/etc/mac.conf</filename>:</para>

      <programlisting xml:lang="en">default_labels file ?biba
default_labels ifnet ?biba
default_labels process ?biba
default_labels socket ?biba</programlisting>
    </sect2>

    <sect2>
      <title>載入程式設定</title>

      <para xml:lang="en">To finish the configuration, add the following lines to
	<filename>/boot/loader.conf</filename>:</para>

      <programlisting xml:lang="en">mac_biba_load="YES"
mac_seeotheruids_load="YES"
security.mac.biba.trust_all_interfaces=1</programlisting>

      <para xml:lang="en">And the following line to the network card configuration
	stored in <filename>/etc/rc.conf</filename>.  If the primary
	network configuration is done via <acronym>DHCP</acronym>,
	this may need to be configured manually after every system
	boot:</para>

      <programlisting xml:lang="en">maclabel biba/equal</programlisting>
    </sect2>

    <sect2>
      <title>測試設定</title>

      <indexterm xml:lang="en">
	<primary>MAC Configuration Testing</primary>
      </indexterm>

      <para xml:lang="en">First, ensure that the web server and
	<application>Nagios</application> will not be started on
	system initialization and reboot.  Ensure that <systemitem class="username">root</systemitem> cannot access any of the
	files in the <application>Nagios</application> configuration
	directory.  If <systemitem class="username">root</systemitem>
	can list the contents of
	<filename>/var/spool/nagios</filename>, something is wrong.
	Instead, a <quote>permission denied</quote> error should be
	returned.</para>

      <para xml:lang="en">If all seems well, <application>Nagios</application>,
	<application>Apache</application>, and
	<application>Sendmail</application> can now be started:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /etc/mail &amp;&amp; make stop &amp;&amp; \
setpmac biba/equal make start &amp;&amp; setpmac biba/10\(10-10\) apachectl start &amp;&amp; \
setpmac biba/10\(10-10\) /usr/local/etc/rc.d/nagios.sh forcestart</userinput></screen>

      <para xml:lang="en">Double check to ensure that everything is working
	properly.  If not, check the log files for error messages.  If
	needed, use <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> to disable the <citerefentry><refentrytitle>mac_biba</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	security policy module and try starting everything again as
	usual.</para>

      <note>
	<para xml:lang="en">The <systemitem class="username">root</systemitem> user
	  can still change the security enforcement and edit its
	  configuration files.  The following command will permit the
	  degradation of the security policy to a lower grade for a
	  newly spawned shell:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>setpmac biba/10 csh</userinput></screen>

	<para xml:lang="en">To block this from happening, force the user into a
	  range using <citerefentry><refentrytitle>login.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.  If <citerefentry><refentrytitle>setpmac</refentrytitle><manvolnum>8</manvolnum></citerefentry> attempts
	  to run a command outside of the compartment's range, an
	  error will be returned and the command will not be executed.
	  In this case, set root to
	  <literal>biba/high(high-high)</literal>.</para>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="mac-troubleshoot">
    <title>MAC 架構疑難排解</title>

    <indexterm xml:lang="en">
      <primary>MAC Troubleshooting</primary>
    </indexterm>

    <para xml:lang="en">This section discusses common configuration errors and how
      to resolve them.</para>

    <variablelist>
      <varlistentry>
	<term xml:lang="en">The <option>multilabel</option> flag does not stay
	  enabled on the root (<filename>/</filename>)
	  partition:</term>

	<listitem>
	  <para xml:lang="en">The following steps may resolve this transient
	    error:</para>

	  <procedure>
	    <step>
	      <para xml:lang="en">Edit <filename>/etc/fstab</filename> and set the
		root partition to <option>ro</option> for
		read-only.</para>
	    </step>

	    <step>
	      <para xml:lang="en">Reboot into single user mode.</para>
	    </step>

	    <step>
	      <para xml:lang="en">Run <command>tunefs</command> <option>-l
		  enable</option> on <filename>/</filename>.</para>
	    </step>

	    <step>
	      <para xml:lang="en">Reboot the system.</para>
	    </step>

	    <step>
	      <para xml:lang="en">Run <command>mount</command> <option>-urw</option>
		<filename>/</filename> and change the
		<option>ro</option> back to <option>rw</option> in
		<filename>/etc/fstab</filename> and reboot the system
		again.</para>
	    </step>

	    <step>
	      <para xml:lang="en">Double-check the output from
		<command>mount</command> to ensure that
		<option>multilabel</option> has been properly set on
		the root file system.</para>
	    </step>
	  </procedure>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">After establishing a secure environment with
	  <acronym>MAC</acronym>, <application>Xorg</application> no
	  longer starts:</term>
	<listitem>
	  <para xml:lang="en">This could be caused by the <acronym>MAC</acronym>
	    <literal>partition</literal> policy or by a mislabeling
	    in one of the <acronym>MAC</acronym> labeling policies.
	    To debug, try the following:</para>

	  <procedure>
	    <step>
	      <para xml:lang="en">Check the error message.  If the user is in the
		<literal>insecure</literal> class, the
		<literal>partition</literal> policy may be the
		culprit.  Try setting the user's class back to the
		<literal>default</literal> class and rebuild the
		database with <command>cap_mkdb</command>.  If this
		does not alleviate the problem, go to step two.</para>
	    </step>

	    <step>
	      <para xml:lang="en">Double-check that the label policies are set
		correctly for the user,
		<application>Xorg</application>, and the
		<filename>/dev</filename> entries.</para>
	    </step>

	    <step>
	      <para xml:lang="en">If neither of these resolve the problem, send the
		error message and a description of the environment to
		the <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-questions">FreeBSD general questions mailing list</link>.</para>
	    </step>
	  </procedure>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">The <errorname>_secure_path: unable to stat
	    .login_conf</errorname> error appears:</term>
	<listitem>
	  <para xml:lang="en">This error can appear when a user attempts to switch
	    from the <systemitem class="username">root</systemitem>
	    user to another user in the system.  This message
	    usually occurs when the user has a higher label setting
	    than that of the user they are attempting to become.
	    For instance, if <systemitem class="username">joe</systemitem> has a default label
	    of <option>biba/low</option> and <systemitem class="username">root</systemitem> has a label of
	    <option>biba/high</option>, <systemitem class="username">root</systemitem> cannot view
	    <systemitem class="username">joe</systemitem>'s home
	    directory.  This will happen whether or not <systemitem class="username">root</systemitem> has used
	    <command>su</command> to become <systemitem class="username">joe</systemitem> as the Biba
	    integrity model will not permit <systemitem class="username">root</systemitem> to view objects set
	    at a lower integrity level.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">The system no longer recognizes <systemitem class="username">root</systemitem>:</term>
	<listitem>
	  <para xml:lang="en">When this occurs, <command>whoami</command> returns
	    <literal>0</literal> and <command>su</command> returns
	    <errorname>who are you?</errorname>.</para>

	  <para xml:lang="en">This can happen if a labeling policy has been
	    disabled by <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> or the policy module was
	    unloaded.  If the policy is disabled, the login
	    capabilities database needs to be reconfigured.  Double
	    check <filename>/etc/login.conf</filename> to ensure
	    that all <option>label</option> options have been
	    removed and rebuild the database with
	    <command>cap_mkdb</command>.</para>

	  <para xml:lang="en">This may also happen if a policy restricts access to
	    <filename>master.passwd</filename>.  This is usually
	    caused by an administrator altering the file under a
	    label which conflicts with the general policy being used
	    by the system.  In these cases, the user information
	    would be read by the system and access would be blocked
	    as the file has inherited the new label.  Disable the
	    policy using <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> and everything should return
	    to normal.</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project
     $FreeBSD$
-->
<!-- Need more documentation on praudit, auditreduce, etc.  Plus more info
on the triggers from the kernel (log rotation, out of space, etc).
And the /dev/audit special file if we choose to support that.  Could use
some coverage of integrating MAC with Event auditing and perhaps discussion
on how some companies or organizations handle auditing and auditing
requirements. -->

<chapter version="5.0" xml:id="audit">

  <info>
    <title>安全事件稽查</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	</personname>
	<contrib>Written by </contrib>
      </author>

      <author xml:lang="en">
	<personname>
	  <firstname>Robert</firstname>
	  <surname>Watson</surname>
	</personname>
      </author>
    </authorgroup>
  </info>

  <sect1 xml:id="audit-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en"><primary>AUDIT</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>Security Event Auditing</primary>
      <see>MAC</see>
    </indexterm>

    <para xml:lang="en">The FreeBSD operating system includes support for security
      event auditing.  Event auditing supports reliable, fine-grained,
      and configurable logging of a variety of security-relevant
      system events, including logins, configuration changes, and file
      and network access.  These log records can be invaluable for
      live system monitoring, intrusion detection, and postmortem
      analysis.  FreeBSD implements <trademark>Sun</trademark>'s published Basic Security
      Module (<acronym>BSM</acronym>) Application Programming
      Interface (<acronym>API</acronym>) and file format, and is
      interoperable with the <trademark>Solaris</trademark> and <trademark class="registered">Mac OS</trademark> X audit
      implementations.</para>

    <para xml:lang="en">This chapter focuses on the installation and configuration
      of event auditing.  It explains audit policies and provides an
      example audit configuration.</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">What event auditing is and how it works.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to configure event auditing on FreeBSD for users and
	  processes.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to review the audit trail using the audit reduction
	  and review tools.</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>了解 <trademark class="registered">UNIX</trademark> 及 FreeBSD 基礎 (<xref linkend="basics"/>)。</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Be familiar with the basics of kernel
	  configuration/compilation (<xref linkend="kernelconfig"/>).</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Have some familiarity with security and how it pertains
	  to FreeBSD (<xref linkend="security"/>).</para>
      </listitem>
    </itemizedlist>

    <warning>
      <para xml:lang="en">The audit facility has some known limitations.  Not all
	security-relevant system events are auditable and some login
	mechanisms, such as <application>Xorg</application>-based
	display managers and third-party daemons, do not properly
	configure auditing for user login sessions.</para>

      <para xml:lang="en">The security event auditing facility is able to generate
	very detailed logs of system activity.  On a busy system,
	trail file data can be very large when configured for high
	detail, exceeding gigabytes a week in some configurations.
	Administrators should take into account the disk space
	requirements associated with high volume audit configurations.
	For example, it may be desirable to dedicate a file system to
	<filename>/var/audit</filename> so that other file systems are
	not affected if the audit file system becomes full.</para>
    </warning>
  </sect1>

  <sect1 xml:id="audit-inline-glossary">
    <title>關鍵詞</title>

    <para xml:lang="en">The following terms are related to security event
      auditing:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en"><emphasis>event</emphasis>: an auditable event is any
	  event that can be logged using the audit subsystem.
	  Examples of security-relevant events include the creation of
	  a file, the building of a network connection, or a user
	  logging in.  Events are either <quote>attributable</quote>,
	  meaning that they can be traced to an authenticated user, or
	  <quote>non-attributable</quote>.  Examples of
	  non-attributable events are any events that occur before
	  authentication in the login process, such as bad password
	  attempts.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>class</emphasis>: a named set of related
	  events which are used in selection expressions.  Commonly
	  used classes of events include <quote>file creation</quote>
	  (fc), <quote>exec</quote> (ex), and
	  <quote>login_logout</quote> (lo).</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>record</emphasis>: an audit log entry
	  describing a security event.  Records contain a record
	  event type, information on the subject (user) performing the
	  action, date and time information, information on any
	  objects or arguments, and a success or failure
	  condition.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>trail</emphasis>: a log file consisting of a
	  series of audit records describing security events.  Trails
	  are in roughly chronological order with respect to the time
	  events completed.  Only authorized processes are allowed to
	  commit records to the audit trail.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>selection expression</emphasis>: a string
	  containing a list of prefixes and audit event class names
	  used to match events.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>preselection</emphasis>: the process by which
	  the system identifies which events are of interest to the
	  administrator.  The preselection configuration uses a series
	  of selection expressions to identify which classes of events
	  to audit for which users, as well as global settings that
	  apply to both authenticated and unauthenticated
	  processes.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>reduction</emphasis>: the process by which
	  records from existing audit trails are selected for
	  preservation, printing, or analysis.  Likewise, the process
	  by which undesired audit records are removed from the audit
	  trail.  Using reduction, administrators can implement
	  policies for the preservation of audit data.  For example,
	  detailed audit trails might be kept for one month, but after
	  that, trails might be reduced in order to preserve only
	  login information for archival purposes.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="audit-config">
    <title>稽查設定</title>

    <para xml:lang="en">User space support for event auditing is installed as part
      of the base FreeBSD operating system.  Kernel support is available
      in the <filename>GENERIC</filename> kernel by default,
      and <citerefentry><refentrytitle>auditd</refentrytitle><manvolnum>8</manvolnum></citerefentry> can be enabled
      by adding the following line to
      <filename>/etc/rc.conf</filename>:</para>

    <programlisting xml:lang="en">auditd_enable="YES"</programlisting>

    <para xml:lang="en">Then, start the audit daemon:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>service auditd start</userinput></screen>

    <para xml:lang="en">Users who prefer to compile a custom kernel must include the
      following line in their custom kernel configuration file:</para>

    <programlisting xml:lang="en">options	AUDIT</programlisting>

    <sect2>
      <title>事件選擇表示法</title>

      <para xml:lang="en">Selection expressions are used in a number of places in
	the audit configuration to determine which events should be
	audited.  Expressions contain a list of event classes to
	match.  Selection expressions are evaluated from left to
	right, and two expressions are combined by appending one onto
	the other.</para>

      <para xml:lang="en"><xref linkend="event-selection"/> summarizes the default
	audit event classes:</para>

      <table xml:id="event-selection" frame="none" pgwide="1">
	<title>預設稽查事件類別</title>

	<tgroup cols="3">
	  <thead>
	    <row>
	      <entry>類別名稱</entry>
	      <entry>說明</entry>
	      <entry>動作</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">all</entry>
	      <entry xml:lang="en">all</entry>
	      <entry xml:lang="en">Match all event classes.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">aa</entry>
	      <entry xml:lang="en">authentication and authorization</entry>
	      <entry/>
	    </row>

	    <row>
	      <entry xml:lang="en">ad</entry>
	      <entry xml:lang="en">administrative</entry>
	      <entry xml:lang="en">Administrative actions performed on the system as
		a whole.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">ap</entry>
	      <entry xml:lang="en">application</entry>
	      <entry xml:lang="en">Application defined action.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">cl</entry>
	      <entry xml:lang="en">file close</entry>
	      <entry xml:lang="en">Audit calls to the
		<function>close</function> system call.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">ex</entry>
	      <entry xml:lang="en">exec</entry>
	      <entry xml:lang="en">Audit program execution.  Auditing of command
		line arguments and environmental variables is
		controlled via <citerefentry><refentrytitle>audit_control</refentrytitle><manvolnum>5</manvolnum></citerefentry> using the
		<literal>argv</literal> and <literal>envv</literal>
		parameters to the <literal>policy</literal>
		setting.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">fa</entry>
	      <entry xml:lang="en">file attribute access</entry>
	      <entry xml:lang="en">Audit the access of object attributes such as
		<citerefentry><refentrytitle>stat</refentrytitle><manvolnum>1</manvolnum></citerefentry> and <citerefentry><refentrytitle>pathconf</refentrytitle><manvolnum>2</manvolnum></citerefentry>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">fc</entry>
	      <entry xml:lang="en">file create</entry>
	      <entry xml:lang="en">Audit events where a file is created as a
		result.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">fd</entry>
	      <entry xml:lang="en">file delete</entry>
	      <entry xml:lang="en">Audit events where file deletion occurs.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">fm</entry>
	      <entry xml:lang="en">file attribute modify</entry>
	      <entry xml:lang="en">Audit events  where file attribute modification
		occurs, such as by <citerefentry><refentrytitle>chown</refentrytitle><manvolnum>8</manvolnum></citerefentry>, <citerefentry><refentrytitle>chflags</refentrytitle><manvolnum>1</manvolnum></citerefentry>, and
		<citerefentry><refentrytitle>flock</refentrytitle><manvolnum>2</manvolnum></citerefentry>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">fr</entry>
	      <entry xml:lang="en">file read</entry>
	      <entry xml:lang="en">Audit events in which data is read or files are
		opened for reading.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">fw</entry>
	      <entry xml:lang="en">file write</entry>
	      <entry xml:lang="en">Audit events in which data is written or files
		are written or modified.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">io</entry>
	      <entry xml:lang="en">ioctl</entry>
	      <entry xml:lang="en">Audit use of the <function>ioctl</function>
		system call.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">ip</entry>
	      <entry xml:lang="en">ipc</entry>
	      <entry xml:lang="en">Audit various forms of Inter-Process
		Communication, including POSIX pipes and System V
		<acronym>IPC</acronym> operations.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">lo</entry>
	      <entry xml:lang="en">login_logout</entry>
	      <entry xml:lang="en">Audit <citerefentry><refentrytitle>login</refentrytitle><manvolnum>1</manvolnum></citerefentry> and <citerefentry><refentrytitle>logout</refentrytitle><manvolnum>1</manvolnum></citerefentry>
		events.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">na</entry>
	      <entry xml:lang="en">non attributable</entry>
	      <entry xml:lang="en">Audit non-attributable events.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">no</entry>
	      <entry xml:lang="en">invalid class</entry>
	      <entry xml:lang="en">Match no audit events.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">nt</entry>
	      <entry xml:lang="en">network</entry>
	      <entry xml:lang="en">Audit events related to network actions such as
		<citerefentry><refentrytitle>connect</refentrytitle><manvolnum>2</manvolnum></citerefentry> and <citerefentry><refentrytitle>accept</refentrytitle><manvolnum>2</manvolnum></citerefentry>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">ot</entry>
	      <entry xml:lang="en">other</entry>
	      <entry xml:lang="en">Audit miscellaneous events.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">pc</entry>
	      <entry xml:lang="en">process</entry>
	      <entry xml:lang="en">Audit process operations such as <citerefentry><refentrytitle>exec</refentrytitle><manvolnum>3</manvolnum></citerefentry> and
		<citerefentry><refentrytitle>exit</refentrytitle><manvolnum>3</manvolnum></citerefentry>.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para xml:lang="en">These audit event classes may be customized by modifying
	the <filename>audit_class</filename> and
	<filename>audit_event</filename> configuration files.</para>

      <para xml:lang="en">Each audit event class may be combined with a prefix
	indicating whether successful/failed operations are matched,
	and whether the entry is adding or removing matching for the
	class and type.  <xref linkend="event-prefixes"/> summarizes
	the available prefixes:</para>

      <table xml:id="event-prefixes" frame="none" pgwide="1">
	<title>稽查事件類別字首</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>字首</entry>
	      <entry>動作</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">+</entry>
	      <entry xml:lang="en">Audit successful events in this class.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">-</entry>
	      <entry xml:lang="en">Audit failed events in this class.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">^</entry>
	      <entry xml:lang="en">Audit neither successful nor failed events in
		this class.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">^+</entry>
	      <entry xml:lang="en">Do not audit successful events in this
		class.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">^-</entry>
	      <entry xml:lang="en">Do not audit failed events in this class.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para xml:lang="en">If no prefix is present, both successful and failed
	instances of the event will be audited.</para>

      <para xml:lang="en">The following example selection string selects both
	successful and failed login/logout events, but only successful
	execution events:</para>

      <programlisting xml:lang="en">lo,+ex</programlisting>
    </sect2>

    <sect2>
      <title>設定檔</title>

      <para xml:lang="en">The following configuration files for security event
	auditing are found in
	<filename>/etc/security</filename>:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><filename>audit_class</filename>: contains the
	    definitions of the audit classes.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><filename>audit_control</filename>: controls aspects
	    of the audit subsystem, such as default audit classes,
	    minimum disk space to leave on the audit log volume, and
	    maximum audit trail size.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><filename>audit_event</filename>: textual names and
	    descriptions of system audit events and a list of which
	    classes each event is in.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><filename>audit_user</filename>: user-specific audit
	    requirements to be combined with the global defaults at
	    login.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><filename>audit_warn</filename>: a customizable shell
	    script used by <citerefentry><refentrytitle>auditd</refentrytitle><manvolnum>8</manvolnum></citerefentry> to generate warning messages
	    in exceptional situations, such as when space for audit
	    records is running low or when the audit trail file has
	    been rotated.</para>
	</listitem>
      </itemizedlist>

      <warning>
	<para xml:lang="en">Audit configuration files should be edited and
	  maintained carefully, as errors in configuration may result
	  in improper logging of events.</para>
      </warning>

      <para xml:lang="en">In most cases, administrators will only need to modify
	<filename>audit_control</filename> and
	<filename>audit_user</filename>.  The first file controls
	system-wide audit properties and policies and the second file
	may be used to fine-tune auditing by user.</para>

      <sect3 xml:id="audit-auditcontrol">
	<title xml:lang="en">The <filename>audit_control</filename> File</title>

	<para xml:lang="en">A number of defaults for the audit subsystem are
	  specified in <filename>audit_control</filename>:</para>

	<programlisting xml:lang="en">dir:/var/audit
dist:off
flags:lo,aa
minfree:5
naflags:lo,aa
policy:cnt,argv
filesz:2M
expire-after:10M</programlisting>

	<para xml:lang="en">The <option>dir</option> entry is used to set one or
	  more directories where audit logs will be stored.  If more
	  than one directory entry appears, they will be used in order
	  as they fill.  It is common to configure audit so that audit
	  logs are stored on a dedicated file system, in order to
	  prevent interference between the audit subsystem and other
	  subsystems if the file system fills.</para>

	<para xml:lang="en">If the <option>dist</option> field is set to
	  <literal>on</literal> or <literal>yes</literal>, hard links
	  will be created to all trail files in
	  <filename>/var/audit/dist</filename>.</para>

	<para xml:lang="en">The <option>flags</option> field sets the system-wide
	  default preselection mask for attributable events.  In the
	  example above, successful and failed login/logout events as
	  well as authentication and authorization are audited for all
	  users.</para>

	<para xml:lang="en">The <option>minfree</option> entry defines the minimum
	  percentage of free space for the file system where the audit
	  trail is stored.</para>

	<para xml:lang="en">The <option>naflags</option> entry specifies audit
	  classes to be audited for non-attributed events, such as the
	  login/logout process and authentication and
	  authorization.</para>

	<para xml:lang="en">The <option>policy</option> entry specifies a
	  comma-separated list of policy flags controlling various
	  aspects of audit behavior.  The <literal>cnt</literal>
	  indicates that the system should continue running despite an
	  auditing failure (this flag is highly recommended).  The
	  other flag, <literal>argv</literal>, causes command line
	  arguments to the <citerefentry><refentrytitle>execve</refentrytitle><manvolnum>2</manvolnum></citerefentry> system call to be audited as
	  part of command execution.</para>

	<para xml:lang="en">The <option>filesz</option> entry specifies the maximum
	  size for an audit trail before automatically terminating and
	  rotating the trail file.  A value of <literal>0</literal>
	  disables automatic log rotation.  If the requested file size
	  is below the minimum of 512k, it will be ignored and a log
	  message will be generated.</para>

	<para xml:lang="en">The <option>expire-after</option> field specifies when
	  audit log files will expire and be removed.</para>
      </sect3>

      <sect3 xml:id="audit-audituser">
	<title xml:lang="en">The <filename>audit_user</filename> File</title>

	<para xml:lang="en">The administrator can specify further audit requirements
	  for specific users in <filename>audit_user</filename>.
	  Each line configures auditing for a user via two fields:
	  the <literal>alwaysaudit</literal> field specifies a set of
	  events that should always be audited for the user, and the
	  <literal>neveraudit</literal> field specifies a set of
	  events that should never be audited for the user.</para>

	<para xml:lang="en">The following example entries audit login/logout events
	  and successful command execution for <systemitem class="username">root</systemitem> and file creation and
	  successful command execution for <systemitem class="username">www</systemitem>.  If used with the
	  default <filename>audit_control</filename>, the
	  <literal>lo</literal> entry for <systemitem class="username">root</systemitem> is redundant, and
	  login/logout events will also be audited for <systemitem class="username">www</systemitem>.</para>

	<programlisting xml:lang="en">root:lo,+ex:no
www:fc,+ex:no</programlisting>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="audit-administration">
    <title>查看稽查線索</title>

    <para xml:lang="en">Since audit trails are stored in the <acronym>BSM</acronym>
      binary format, several built-in tools are available to modify or
      convert these trails to text.  To convert trail files to a
      simple text format, use <command>praudit</command>.  To reduce
      the audit trail file for analysis, archiving, or printing
      purposes, use <command>auditreduce</command>.  This utility
      supports a variety of selection parameters, including event
      type, event class, user, date or time of the event, and the file
      path or object acted on.</para>

    <para xml:lang="en">For example, to dump the entire contents of a specified
      audit log in plain text:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>praudit /var/audit/<replaceable>AUDITFILE</replaceable></userinput></screen>

    <para xml:lang="en">Where <replaceable>AUDITFILE</replaceable> is the audit log
      to dump.</para>

    <para xml:lang="en">Audit trails consist of a series of audit records made up of
      tokens, which <command>praudit</command> prints sequentially,
      one per line.  Each token is of a specific type, such as
      <literal>header</literal> (an audit record header) or
      <literal>path</literal> (a file path from a name lookup).  The
      following is an example of an
      <literal>execve</literal> event:</para>

    <programlisting xml:lang="en">header,133,10,execve(2),0,Mon Sep 25 15:58:03 2006, + 384 msec
exec arg,finger,doug
path,/usr/bin/finger
attribute,555,root,wheel,90,24918,104944
subject,robert,root,wheel,root,wheel,38439,38032,42086,128.232.9.100
return,success,0
trailer,133</programlisting>

    <para xml:lang="en">This audit represents a successful
      <literal>execve</literal> call, in which the command
      <literal>finger doug</literal> has been run.  The
      <literal>exec arg</literal> token contains the processed command
      line presented by the shell to the kernel.  The
      <literal>path</literal> token holds the path to the executable
      as looked up by the kernel.  The <literal>attribute</literal>
      token describes the binary and includes the file mode.  The
      <literal>subject</literal> token stores the audit user ID,
      effective user ID and group ID, real user ID and group ID,
      process ID, session ID, port ID, and login address.  Notice that
      the audit user ID and real user ID differ as the user
      <systemitem class="username">robert</systemitem> switched to the
      <systemitem class="username">root</systemitem> account before
      running this command, but it is audited using the original
      authenticated user.  The <literal>return</literal> token
      indicates the successful execution and the
      <literal>trailer</literal> concludes the record.</para>

    <para xml:lang="en"><acronym>XML</acronym> output format is also supported and
      can be selected by including <option>-x</option>.</para>

    <para xml:lang="en">Since audit logs may be very large, a subset of records can
      be selected using <command>auditreduce</command>.  This example
      selects all audit records produced for the user
      <systemitem class="username">trhodes</systemitem> stored in
      <filename>AUDITFILE</filename>:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>auditreduce -u <replaceable>trhodes</replaceable> /var/audit/<replaceable>AUDITFILE</replaceable> | praudit</userinput></screen>

    <para xml:lang="en">Members of the <systemitem class="groupname">audit</systemitem> group have permission to
      read audit trails in <filename>/var/audit</filename>.  By
      default, this group is empty, so only the <systemitem class="username">root</systemitem> user can read audit trails.
      Users may be added to the <systemitem class="groupname">audit</systemitem> group in order to
      delegate audit review rights.  As the ability to track audit log
      contents provides significant insight into the behavior of users
      and processes, it is recommended that the delegation of audit
      review rights be performed with caution.</para>

    <sect2>
      <title>使用 Audit Pipes 即時監視</title>

      <para xml:lang="en">Audit pipes are cloning pseudo-devices which allow
	applications to tap the live audit record stream.  This is
	primarily of interest to authors of intrusion detection and
	system monitoring applications.  However, the audit pipe
	device is a convenient way for the administrator to allow live
	monitoring without running into problems with audit trail file
	ownership or log rotation interrupting the event stream.  To
	track the live audit event stream:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>praudit /dev/auditpipe</userinput></screen>

      <para xml:lang="en">By default, audit pipe device nodes are accessible only to
	the <systemitem class="username">root</systemitem> user.  To
	make them accessible to the members of the <systemitem class="groupname">audit</systemitem> group, add a
	<literal>devfs</literal> rule to
	<filename>/etc/devfs.rules</filename>:</para>

      <programlisting xml:lang="en">add path 'auditpipe*' mode 0440 group audit</programlisting>

      <para xml:lang="en">See <citerefentry><refentrytitle>devfs.rules</refentrytitle><manvolnum>5</manvolnum></citerefentry> for more information on
	configuring the devfs file system.</para>

      <warning>
	<para xml:lang="en">It is easy to produce audit event feedback cycles, in
	  which the viewing of each audit event results in the
	  generation of more audit events.  For example, if all
	  network <acronym>I/O</acronym> is audited, and
	  <command>praudit</command> is run from an
	  <acronym>SSH</acronym> session, a continuous stream of audit
	  events will be generated at a high rate, as each event being
	  printed will generate another event.  For this reason, it is
	  advisable to run <command>praudit</command> on an audit pipe
	  device from sessions without fine-grained
	  <acronym>I/O</acronym> auditing.</para>
      </warning>
    </sect2>

    <sect2>
      <title>翻轉與壓縮 Audit Trail 檔</title>

      <para xml:lang="en">Audit trails are written to by the kernel and
	managed by the audit daemon, <citerefentry><refentrytitle>auditd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.
	Administrators should not attempt to use
	<citerefentry><refentrytitle>newsyslog.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> or other tools to directly rotate
	audit logs.  Instead, <command>audit</command> should
	be used to shut down auditing, reconfigure the audit system,
	and perform log rotation.  The following command causes the
	audit daemon to create a new audit log and signal the kernel
	to switch to using the new log.  The old log will be
	terminated and renamed, at which point it may then be
	manipulated by the administrator:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>audit -n</userinput></screen>

      <para xml:lang="en">If <citerefentry><refentrytitle>auditd</refentrytitle><manvolnum>8</manvolnum></citerefentry> is not currently running, this command
	will fail and an error message will be produced.</para>

      <para xml:lang="en">Adding the following line to
	<filename>/etc/crontab</filename> will schedule this rotation
	every twelve hours:</para>

      <programlisting xml:lang="en">0     */12       *       *       *       root    /usr/sbin/audit -n</programlisting>

      <para xml:lang="en">The change will take effect once
	<filename>/etc/crontab</filename> is saved.</para>

      <para xml:lang="en">Automatic rotation of the audit trail file based on file
	size is possible using <option>filesz</option> in
	<filename>audit_control</filename> as described in <xref linkend="audit-auditcontrol"/>.</para>

      <para xml:lang="en">As audit trail files can become very large, it is often
	desirable to compress or otherwise archive trails once they
	have been closed by the audit daemon.  The
	<filename>audit_warn</filename> script can be used to perform
	customized operations for a variety of audit-related events,
	including the clean termination of audit trails when they are
	rotated.  For example, the following may be added to
	<filename>/etc/security/audit_warn</filename> to compress
	audit trails on close:</para>

      <programlisting xml:lang="en">#
# Compress audit trail files on close.
#
if [ "$1" = closefile ]; then
        gzip -9 $2
fi</programlisting>

      <para xml:lang="en">Other archiving activities might include copying trail
	files to a centralized server, deleting old trail files, or
	reducing the audit trail to remove unneeded records.  This
	script will be run only when audit trail files are cleanly
	terminated, so will not be run on trails left unterminated
	following an improper shutdown.</para>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->

<chapter version="5.0" xml:id="disks">

  <title>儲存設備</title>

  <sect1 xml:id="disks-synopsis">
    <title>概述</title>

    <para>本章涵蓋如何在 FreeBSD 下使用磁碟及儲存媒體，這包含 <acronym>SCSI</acronym> 及 <acronym>IDE</acronym> 磁碟、<acronym>CD</acronym> 及 <acronym>DVD</acronym> 媒體、記憶體磁碟及 <acronym>USB</acronym> 儲存裝置。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>如何在 FreeBSD 系統加入額外的硬碟。</para>
      </listitem>

      <listitem>
	<para>如何在 FreeBSD 擴增磁碟分割區的大小。</para>
      </listitem>

      <listitem>
	<para>如何設定 FreeBSD 使用 <acronym>USB</acronym> 儲存裝置。</para>
      </listitem>

      <listitem>
	<para>如何在 FreeBSD 系統使用 <acronym>CD</acronym> 及 <acronym>DVD</acronym> 媒體。</para>
      </listitem>

      <listitem>
	<para>如何使用在 FreeBSD 下可用的備份程式。</para>
      </listitem>

      <listitem>
	<para>如何設定記憶體磁碟。</para>
      </listitem>

      <listitem>
	<para>什麼是檔案系統快照 (Snapshot) 以及如何有效使用。</para>
      </listitem>

      <listitem>
	<para>如何使用配額 (Quota) 來限制磁碟空間使用量。</para>
      </listitem>

      <listitem>
	<para>如何加密磁碟及交換空間來防範攻擊者。</para>
      </listitem>

      <listitem>
	<para>如何設定高可用性 (Highly available) 的儲存網路。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>了解如何 <link linkend="kernelconfig">設定並安裝新的 FreeBSD 核心</link>。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="disks-adding">
    <info>
      <title>加入磁碟</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>David</firstname>
	    <surname>O'Brien</surname>
	  </personname>
	  <contrib>Originally contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>disks</primary>
      <secondary>adding</secondary>
    </indexterm>

    <para>本節將說明如何加入新的 <acronym>SATA</acronym> 磁碟到目前只有一個磁碟的機器上。 首先要關閉電腦並依照電腦、控制器及磁碟製造商的操作指南將磁碟安裝到電腦。重新啟動系統並登入 <systemitem class="username">root</systemitem>。</para>

    <para>查看 <filename>/var/run/dmesg.boot</filename> 來確認已經找到新的磁碟。在本例中，會以 <filename>ada1</filename> 代表新加入的 <acronym>SATA</acronym> 磁碟。</para>

    <indexterm xml:lang="en"><primary>partitions</primary></indexterm>
    <indexterm xml:lang="en">
      <primary><command>gpart</command></primary>
    </indexterm>

    <para>在本例中，會在新的磁碟上建立單一大型分割區，使用 <link xlink:href="http://en.wikipedia.org/wiki/GUID_Partition_Table"> <acronym>GPT</acronym></link> 分割表格式而非較舊與通用性較差的 <acronym>MBR</acronym> 結構。</para>

    <note>
      <para>若新加入的磁碟不是空白的，可以使用 <command>gpart delete</command> 來移除舊的分割區資訊。請參考 <citerefentry><refentrytitle>gpart</refentrytitle><manvolnum>8</manvolnum></citerefentry> 取得詳細資訊。</para>
    </note>

    <para>建立完分割表格式後接著加入一個分割區，要在新的磁碟增進效能可使用較大的硬體區塊大小 (Block size)，此分割區會對齊 1 MB 的邊界：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart create -s GPT ada1</userinput>
<prompt>#</prompt> <userinput>gpart add -t freebsd-ufs -a 1M ada1</userinput></screen>

    <para>依據使用情況，也可以使用較小的分割區。請參考 <citerefentry><refentrytitle>gpart</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來取得建立較小分割區的選項。</para>

    <para>磁碟分割區資訊可以使用 <command>gpart show</command> 檢視：</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>gpart show ada1</userinput>
=&gt;        34  1465146988  ada1  GPT  (699G)
          34        2014        - free -  (1.0M)
        2048  1465143296     1  freebsd-ufs  (699G)
  1465145344        1678        - free -  (839K)</screen>

    <para>在新磁碟的新分割區上建立檔案系統：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>newfs -U /dev/ada1p1</userinput></screen>

    <para>建立一個空的目錄做來做為<emphasis>掛載點 (mountpoint)</emphasis>，一個在原有磁碟的檔案系統上可用來掛載新磁碟的位置：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /newdisk</userinput></screen>

    <para>最後，將磁碟項目加入到 <filename>/etc/fstab</filename>，讓啟動時會自動掛載新的磁碟：</para>

    <programlisting xml:lang="en">/dev/ada1p1	/newdisk	ufs	rw	2	2</programlisting>

    <para>新的磁碟也可手動掛載，無須重新啟動系統：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>mount /newdisk</userinput></screen>
  </sect1>

  <sect1 xml:id="disks-growing">
    <info>
      <title>重設大小與擴增磁碟</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Allan</firstname>
	    <surname>Jude</surname>
	  </personname>
	  <contrib>Originally contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>disks</primary>
      <secondary>resizing</secondary>
    </indexterm>

    <para>磁碟的容量可以增加且不需要更動任何已存在的資料。這時常會用在虛擬機器，當虛擬磁碟太小且需要增加時。有時磁碟映像檔會被寫入到 <acronym>USB</acronym> 隨身碟，但卻沒有使用全部的容量。此節我們將說明如合重設大小或 <emphasis>擴增</emphasis> 磁碟內容來使用增加的容量。</para>

    <para>要取得要重設大小的磁碟的代號可以查看 <filename>/var/run/dmesg.boot</filename>。在本例中，在系統上只有一個 <acronym>SATA</acronym> 磁碟，該磁碟會以 <filename>ada0</filename> 表示。</para>

    <indexterm xml:lang="en"><primary>partitions</primary></indexterm>
    <indexterm xml:lang="en">
      <primary><command>gpart</command></primary>
    </indexterm>

    <para>列出在磁碟上的分割區來查看目前的設定：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart show <replaceable>ada0</replaceable></userinput>
=&gt;      34  83886013  ada0  GPT  (48G) [CORRUPT]
        34       128     1  freebsd-boot  (64k)
       162  79691648     2  freebsd-ufs  (38G)
  79691810   4194236     3  freebsd-swap  (2G)
  83886046         1        - free -  (512B)</screen>

    <note>
      <para>若磁碟已使用 <link xlink:href="http://en.wikipedia.org/wiki/GUID_Partition_Table"> <acronym>GPT</acronym></link> 分割表格式做格式化，可能會顯示為 <quote>已損壞 (corrupted)</quote> 因為 <acronym>GPT</acronym> 備份分割區已不存在於磁碟結尾。 使用 <command>gpart</command> 來修正備份分割區：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart recover <replaceable>ada0</replaceable></userinput>
ada0 recovered</screen>
    </note>

    <para>現在在磁碟上的額外空間已經可以被新的分割區使用，或者可以拿來擴充既有的分割區：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart show <replaceable>ada0</replaceable></userinput>
=&gt;       34  102399933  ada0  GPT  (48G)
         34        128     1  freebsd-boot  (64k)
        162   79691648     2  freebsd-ufs  (38G)
   79691810    4194236     3  freebsd-swap  (2G)
   83886046   18513921        - free -  (8.8G)</screen>

    <para>分割區只能在連續的未使用空間上重設大小。在這個例子中，磁碟上最後的分割區為交換 (Swap) 分割區，而第二個分割區才是需要重設大小的分割區。由於交換分割區中只會有暫存的資料，所以此時可以安全的卸載、刪除，然後在重設第二個分割區大小之後再重建最後一個分割區。</para>

    <para>停用交換分割區：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>swapoff <replaceable>/dev/ada0p3</replaceable></userinput></screen>

    <para>刪除 <replaceable>ada0</replaceable> 磁碟上的第三個分割區，可使用 <option>-i</option> 參數來指定分割區。</para>

    <screen xml:lang="en">
<prompt>#</prompt> <userinput>gpart delete -i <replaceable>3</replaceable> <replaceable>ada0</replaceable></userinput>
ada0p3 deleted
<prompt>#</prompt> <userinput>gpart show <replaceable>ada0</replaceable></userinput>
=&gt;       34  102399933  ada0  GPT  (48G)
         34        128     1  freebsd-boot  (64k)
        162   79691648     2  freebsd-ufs  (38G)
   79691810   22708157        - free -  (10G)</screen>

    <warning>
      <para>在掛載的檔案系統上修改分割區表可能會造成資料遺失。最好的方式是在未掛載檔案系統的情況下 (使用 Live <acronym>CD-ROM</acronym> 或 <acronym>USB</acronym> 裝置) 執行以下步驟。雖然如此，若仍要這樣做的話，在關閉 GEOM 安全性功能之後可以在掛載的檔案系統上修改分割區表：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl kern.geom.debugflags=16</userinput></screen>
    </warning>

    <para>重設分割區大小並保留要用來重建交換分割區的空間，要重設大小的分割區可以用 <option>-i</option> 來指定，而要重設的大小可用 <option>-s</option> 來指定，若要對齊分割區可以使用 <option>-a</option>。這個動作只會修改分割區大小，分割區中的檔案系統需在另一個步驟擴增。</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart resize -i <replaceable>2</replaceable> -s <replaceable>47G</replaceable> -a 4k <replaceable>ada0</replaceable></userinput>
ada0p2 resized
<prompt>#</prompt> <userinput>gpart show <replaceable>ada0</replaceable></userinput>
=&gt;       34  102399933  ada0  GPT  (48G)
         34        128     1  freebsd-boot  (64k)
        162   98566144     2  freebsd-ufs  (47G)
   98566306    3833661        - free -  (1.8G)</screen>

    <para>重建交換分割區並且啟動，若不使用 <option>-s</option> 指定大小則會使用所有剩餘的空間：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart add -t freebsd-swap -a 4k <replaceable>ada0</replaceable></userinput>
ada0p3 added
<prompt>#</prompt> <userinput>gpart show <replaceable>ada0</replaceable></userinput>
=&gt;       34  102399933  ada0  GPT  (48G)
         34        128     1  freebsd-boot  (64k)
        162   98566144     2  freebsd-ufs  (47G)
   98566306    3833661     3  freebsd-swap  (1.8G)
<prompt>#</prompt> <userinput>swapon <replaceable>/dev/ada0p3</replaceable></userinput></screen>

    <para>擴增 <acronym>UFS</acronym> 檔案系統來使用重設分割區大小之後的新容量：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>growfs <replaceable>/dev/ada0p2</replaceable></userinput>
Device is mounted read-write; resizing will result in temporary write suspension for /.
It's strongly recommended to make a backup before growing the file system.
OK to grow file system on /dev/ada0p2, mounted on /, from 38GB to 47GB? [Yes/No] <userinput>Yes</userinput>
super-block backups (for fsck -b #) at:
 80781312, 82063552, 83345792, 84628032, 85910272, 87192512, 88474752,
 89756992, 91039232, 92321472, 93603712, 94885952, 96168192, 97450432</screen>

    <para>若檔案系統使用 <acronym>ZFS</acronym>，重設大小需執行 <option>online</option> 子指令並使用 <option>-e</option> 來觸發動作：</para>

    <screen><prompt>#</prompt> <userinput>zpool online -e <replaceable>zroot</replaceable> <replaceable>/dev/ada0p2</replaceable></userinput></screen>

    <para>現在分割區與檔案系統已透過重設大小來使用新增加的磁碟空間。</para>
  </sect1>

  <sect1 xml:id="usb-disks">
    <info>
      <title><acronym>USB</acronym> 儲存裝置</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Fonvieille</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>USB</primary>
      <secondary>disks</secondary>
    </indexterm>

    <para>許多外部儲存裝置的解決方案，例如硬碟、<acronym>USB</acronym> 隨身碟及
<acronym>CD</acronym> 與 <acronym>DVD</acronym> 燒錄機皆使用通用序列匯流排 (Universal Serial Bus, <acronym>USB</acronym>)，FreeBSD 提供了對 <acronym>USB</acronym> 1.x, 2.0 及 3.0 裝置的支援。</para>

    <note>
      <para>部份硬體尚不相容 <acronym>USB</acronym> 3.0，包含 Haswell (Lynx point) 晶片組，若 FreeBSD 開機出現 <errorname>failed with error 19</errorname> 訊息，請在系統 <acronym>BIOS</acronym> 關閉 xHCI/USB3。</para>
    </note>

    <para>對 <acronym>USB</acronym> 儲存裝置的支援已內建於 <filename>GENERIC</filename> 核心，若為自訂的核心，請確定在核心設定檔中有下列幾行設定：</para>

    <programlisting xml:lang="en">device scbus	# SCSI bus (required for ATA/SCSI)
device da	# Direct Access (disks)
device pass	# Passthrough device (direct ATA/SCSI access)
device uhci	# provides USB 1.x support
device ohci	# provides USB 1.x support
device ehci	# provides USB 2.0 support
device xhci	# provides USB 3.0 support
device usb	# USB Bus (required)
device umass	# Disks/Mass storage - Requires scbus and da
device cd	# needed for CD and DVD burners</programlisting>

    <para>FreeBSD 使用 <citerefentry><refentrytitle>umass</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式透過 <acronym>SCSI</acronym> 子系統來存取 <acronym>USB</acronym> 儲存裝置，因此任何在系統的 <acronym>USB</acronym> 裝置都會以 <acronym>SCSI</acronym> 裝置呈現，若 <acronym>USB</acronym> 裝置是 <acronym>CD</acronym> 或 <acronym>DVD</acronym> 燒錄機，請<emphasis>不要</emphasis>在自訂核心設定檔中引用 <option>device atapicam</option>。</para>

    <para>本節後續的部份將示範如何檢查 FreeBSD 能夠辦識 <acronym>USB</acronym> 儲存裝置以及如何設定該裝置。</para>

    <sect2>
      <title>裝置設定</title>

      <para>要測試 <acronym>USB</acronym> 設定，請先插入 <acronym>USB</acronym> 裝置，然後使用 <command>dmesg</command> 來確認系統訊息緩衝區中有出現該磁碟機，該訊息如下：</para>

      <screen xml:lang="en">umass0: &lt;STECH Simple Drive, class 0/0, rev 2.00/1.04, addr 3&gt; on usbus0
umass0:  SCSI over Bulk-Only; quirks = 0x0100
umass0:4:0:-1: Attached to scbus4
da0 at umass-sim0 bus 0 scbus4 target 0 lun 0
da0: &lt;STECH Simple Drive 1.04&gt; Fixed Direct Access SCSI-4 device
da0: Serial Number WD-WXE508CAN263
da0: 40.000MB/s transfers
da0: 152627MB (312581808 512 byte sectors: 255H 63S/T 19457C)
da0: quirks=0x2&lt;NO_6_BYTE&gt;</screen>

      <para>不同的裝置會有不同的廠牌、裝置節點 (<filename>da0</filename>)、速度與大小。</para>

      <para>當 <acronym>USB</acronym> 裝置可以做為 <acronym>SCSI</acronym> 檢視時，便可使用 <command>camcontrol</command> 來列出連接到系統的 <acronym>USB</acronym> 儲存裝置：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>camcontrol devlist</userinput>
&lt;STECH Simple Drive 1.04&gt;          at scbus4 target 0 lun 0 (pass3,da0)</screen>

      <para>或者，可以使用 <command>usbconfig</command> 來列出裝置，請參考 <citerefentry vendor="current"><refentrytitle>usbconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來取得更多有關此指令的資訊。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>usbconfig</userinput>
ugen0.3: &lt;Simple Drive STECH&gt; at usbus0, cfg=0 md=HOST spd=HIGH (480Mbps) pwr=ON (2mA)</screen>

      <para>若該裝置尚未被格式化，請參考 <xref linkend="disks-adding"/> 中有關如何在 <acronym>USB</acronym> 磁碟格式化與建立分割區的說明。若磁碟中有檔案系統，可由 <systemitem class="username">root</systemitem> 依據 <xref linkend="mount-unmount"/> 中的說明掛載磁碟。</para>

      <warning>
	<para>要允許未被信任的使用者掛載任意媒體，可開啟 <varname>vfs.usermount</varname>，詳細說明如下。從安全性的角度來看這並不是安全的，大多的檔案系統並不會防範惡意裝置。</para>
      </warning>

      <para>要讓裝置可讓一般使用者掛載，其中一個解決方案便是使用 <citerefentry><refentrytitle>pw</refentrytitle><manvolnum>8</manvolnum></citerefentry> 讓所有裝置的使用者成為 <systemitem class="groupname">operator</systemitem> 群組的成員。接著，將下列幾行加入 <filename>/etc/devfs.rules</filename> 來確保 <systemitem class="groupname">operator</systemitem> 能夠讀取與寫入裝置：</para>

      <programlisting xml:lang="en">[localrules=5]
add path 'da*' mode 0660 group operator</programlisting>

      <note>
	<para>若系統也同時安裝了內建 <acronym>SCSI</acronym> 磁碟，請更改第二行如下：</para>

	<programlisting xml:lang="en">add path 'da[<replaceable>3</replaceable>-9]*' mode 0660 group operator</programlisting>

	<para>這會從 <systemitem class="groupname">operator</systemitem> 群組中排除前三個 <acronym>SCSI</acronym> 磁碟 (<filename>da0</filename> 到 <filename>da2</filename>)，接著取代 <replaceable>3</replaceable> 為內部 <acronym>SCSI</acronym> 磁碟的編號。請參考 <citerefentry><refentrytitle>devfs.rules</refentrytitle><manvolnum>5</manvolnum></citerefentry> 來取得更多有關此檔案的資訊。</para>
      </note>

      <para>接著，在 <filename>/etc/rc.conf</filename> 開啟規則：</para>

      <programlisting xml:lang="en">devfs_system_ruleset="localrules"</programlisting>

      <para>然後，加入以下行到 <filename>/etc/sysctl.conf</filename> 指示系統允許正常使用者掛載檔案系統：</para>

      <programlisting xml:lang="en">vfs.usermount=1</programlisting>

      <para>這樣只會在下次重新開機時生效，可使用 <command>sysctl</command> 來立即設定這個變數：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl vfs.usermount=1</userinput>
vfs.usermount: 0 -&gt; 1</screen>

      <para>最後一個步驟是建立要掛載檔案系統要的目錄，要掛載檔案系統的使用者需要擁有這個目錄。其中一個辦法是讓 <systemitem class="username">root</systemitem> 建立由該使用者擁有的子目錄 <filename>/mnt/<replaceable>username</replaceable></filename>。在下面的例子，將 <replaceable>username</replaceable> 替換為該使用者的登入名稱並將 <replaceable>usergroup</replaceable> 替換為該使用者的主要群組：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /mnt/<replaceable>username</replaceable></userinput>
<prompt>#</prompt> <userinput>chown <replaceable>username</replaceable>:<replaceable>usergroup</replaceable> /mnt/<replaceable>username</replaceable></userinput></screen>

      <para>假如已經插入 <acronym>USB</acronym> 隨身碟，且已出現 <filename>/dev/da0s1</filename> 裝置。若裝置使用 <acronym>FAT</acronym> 格式的檔案系統，則使用者可使用以下指令掛載該檔案系統：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>mount -t msdosfs -o -m=644,-M=755 /dev/da0s1 /mnt/<replaceable>username</replaceable></userinput></screen>

      <para>在裝置可以被拔除前，<emphasis>必須</emphasis>先卸載：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>umount /mnt/<replaceable>username</replaceable></userinput></screen>

      <para>裝置移除之後，系統訊息緩衝區會顯示如下的訊息：</para>

      <screen xml:lang="en">umass0: at uhub3, port 2, addr 3 (disconnected)
da0 at umass-sim0 bus 0 scbus4 target 0 lun 0
da0: &lt;STECH Simple Drive 1.04&gt; s/n WD-WXE508CAN263          detached
(da0:umass-sim0:0:0:0): Periph destroyed</screen>
    </sect2>

    <sect2>
      <title>自動掛載可移除的媒體</title>

      <para>可以取消註解在 <filename>/etc/auto_master</filename> 中的下行來自動掛載 <acronym>USB</acronym> 裝置：</para>

      <screen xml:lang="en">/media		-media		-nosuid</screen>

      <para>然後加入這些行到 <filename>/etc/devd.conf</filename>：</para>

      <screen xml:lang="en">notify 100 {
	match "system" "GEOM";
	match "subsystem" "DEV";
	action "/usr/sbin/automount -c";
};</screen>

      <para>若 <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>devd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 已經正在執行，則需重新載入設定：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service automount restart</userinput>
<prompt>#</prompt> <userinput>service devd restart</userinput></screen>

      <para>要設定讓 <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> 在開機時啟動可以加入此行到 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">autofs_enable="YES"</programlisting>

      <para><citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> 需要開啟 <citerefentry><refentrytitle>devd</refentrytitle><manvolnum>8</manvolnum></citerefentry>，預設已經開啟。</para>

      <para>立即啟動服務：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service automount start</userinput>
<prompt>#</prompt> <userinput>service automountd start</userinput>
<prompt>#</prompt> <userinput>service autounmountd start</userinput>
<prompt>#</prompt> <userinput>service devd start</userinput></screen>

      <para>可以被自動掛載的檔案系統會在 <filename>/media/</filename> 中以目錄呈現，會以檔案系統的標籤來命名目錄，若標籤遺失，則會以裝置節點命名。</para>

      <para>檔案系統會在第一次存取時自動掛載，並在一段時間未使用後自動卸載。自動掛載的磁碟也可手動卸載：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>automount -fu</userinput></screen>

      <para>這個機制一般會用在記憶卡與 <acronym>USB</acronym> 隨身碟，也可用在任何 Block 裝置，包含光碟機或 <acronym>iSCSI</acronym> <acronym>LUN</acronym>。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="creating-cds">
    <info>
      <title>建立與使用 <acronym>CD</acronym> 媒體</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Mike</firstname>
	    <surname>Meyer</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary><acronym>CD-ROM</acronym>s</primary>
      <secondary>creating</secondary>
    </indexterm>

    <para xml:lang="en">Compact Disc (<acronym>CD</acronym>) media provide a number
      of features that differentiate them from conventional disks.
      They are designed so that they can be read continuously without
      delays to move the head between tracks.  While
      <acronym>CD</acronym> media do have tracks, these refer to a
      section of data to be read continuously, and not a physical
      property of the disk.  The <acronym>ISO</acronym> 9660 file
      system was designed to deal with these differences.</para>

    <indexterm xml:lang="en"><primary><acronym>ISO</acronym>
      9660</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>file systems</primary>
      <secondary>ISO 9660</secondary>
    </indexterm>

    <indexterm xml:lang="en">
      <primary><acronym>CD</acronym> burner</primary>
      <secondary><acronym>ATAPI</acronym></secondary>
    </indexterm>

    <para xml:lang="en">The FreeBSD Ports Collection provides several utilities for
      burning and duplicating audio and data <acronym>CD</acronym>s.
      This chapter demonstrates the use of several command line
      utilities.  For <acronym>CD</acronym> burning software with a
      graphical utility, consider installing the
      <package>sysutils/xcdroast</package> or
      <package>sysutils/k3b</package> packages or ports.</para>

    <sect2 xml:id="atapicam">
      <info>
	<title>支援的裝置</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Marc</firstname>
	      <surname>Fonvieille</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <indexterm xml:lang="en">
	<primary><acronym>CD</acronym> burner</primary>
	<secondary>ATAPI/CAM driver</secondary>
      </indexterm>

      <para xml:lang="en">The <filename>GENERIC</filename> kernel provides support
	for <acronym>SCSI</acronym>,  <acronym>USB</acronym>, and
	<acronym>ATAPI</acronym> <acronym>CD</acronym> readers and
	burners.  If a custom kernel is used, the options that need to
	be present in the kernel configuration file vary by the type
	of device.</para>

      <para xml:lang="en">For a <acronym>SCSI</acronym> burner, make sure these
	options are present:</para>

      <programlisting xml:lang="en">device scbus	# SCSI bus (required for ATA/SCSI)
device da	# Direct Access (disks)
device pass	# Passthrough device (direct ATA/SCSI access)
device cd	# needed for CD and DVD burners</programlisting>

      <para xml:lang="en">For a <acronym>USB</acronym> burner, make sure these
	options are present:</para>

      <programlisting xml:lang="en">device scbus	# SCSI bus (required for ATA/SCSI)
device da	# Direct Access (disks)
device pass	# Passthrough device (direct ATA/SCSI access)
device cd	# needed for CD and DVD burners
device uhci	# provides USB 1.x support
device ohci	# provides USB 1.x support
device ehci	# provides USB 2.0 support
device xhci	# provides USB 3.0 support
device usb	# USB Bus (required)
device umass	# Disks/Mass storage - Requires scbus and da</programlisting>

      <para xml:lang="en">For an <acronym>ATAPI</acronym> burner, make sure these
	options are present:</para>

      <programlisting xml:lang="en">device ata	# Legacy ATA/SATA controllers
device scbus	# SCSI bus (required for ATA/SCSI)
device pass	# Passthrough device (direct ATA/SCSI access)
device cd	# needed for CD and DVD burners</programlisting>

      <note>
	<para xml:lang="en">On FreeBSD versions prior to 10.x, this line is also
	  needed in the kernel configuration file if the burner is an
	  <acronym>ATAPI</acronym> device:</para>

	<programlisting xml:lang="en">device atapicam</programlisting>

	<para xml:lang="en">Alternately, this driver can be loaded at boot time by
	  adding the following line to
	  <filename>/boot/loader.conf</filename>:</para>

	<programlisting xml:lang="en">atapicam_load="YES"</programlisting>

	<para xml:lang="en">This will require a reboot of the system as this driver
	  can only be loaded at boot time.</para>
      </note>

      <para xml:lang="en">To verify that FreeBSD recognizes the device, run
	<command>dmesg</command> and look for an entry for the device.
	On systems prior to 10.x, the device name in the first line of
	the output will be <filename>acd0</filename> instead of
	<filename>cd0</filename>.</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>dmesg | grep cd</userinput>
cd0 at ahcich1 bus 0 scbus1 target 0 lun 0
cd0: &lt;HL-DT-ST DVDRAM GU70N LT20&gt; Removable CD-ROM SCSI-0 device
cd0: Serial Number M3OD3S34152
cd0: 150.000MB/s transfers (SATA 1.x, UDMA6, ATAPI 12bytes, PIO 8192bytes)
cd0: Attempt to query device size failed: NOT READY, Medium not present - tray closed</screen>
    </sect2>

    <sect2 xml:id="cdrecord">
      <title>燒錄 <acronym>CD</acronym></title>

      <para xml:lang="en">In FreeBSD, <command>cdrecord</command> can be used to burn
	<acronym>CD</acronym>s.  This command is installed with the
	<package>sysutils/cdrtools</package> package or port.</para>

      <para xml:lang="en">While <command>cdrecord</command> has many options, basic
	usage is simple.  Specify the name of the
	<acronym>ISO</acronym> file to burn and, if the system has
	multiple burner devices, specify the name of the device to
	use:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cdrecord <replaceable>dev=device</replaceable> <replaceable>imagefile.iso</replaceable></userinput></screen>

      <para xml:lang="en">To determine the device name of the burner, use
	<option>-scanbus</option> which might produce results like
	this:</para>

      <indexterm xml:lang="en">
	<primary><acronym>CD-ROM</acronym>s</primary>
	<secondary>burning</secondary>
      </indexterm>
      <screen xml:lang="en"><prompt>#</prompt> <userinput>cdrecord -scanbus</userinput>
ProDVD-ProBD-Clone 3.00 (amd64-unknown-freebsd10.0) Copyright (C) 1995-2010 Jörg Schilling
Using libscg version 'schily-0.9'
scsibus0:
        0,0,0     0) 'SEAGATE ' 'ST39236LW       ' '0004' Disk
        0,1,0     1) 'SEAGATE ' 'ST39173W        ' '5958' Disk
        0,2,0     2) *
        0,3,0     3) 'iomega  ' 'jaz 1GB         ' 'J.86' Removable Disk
        0,4,0     4) 'NEC     ' 'CD-ROM DRIVE:466' '1.26' Removable CD-ROM
        0,5,0     5) *
        0,6,0     6) *
        0,7,0     7) *
scsibus1:
        1,0,0   100) *
        1,1,0   101) *
        1,2,0   102) *
        1,3,0   103) *
        1,4,0   104) *
        1,5,0   105) 'YAMAHA  ' 'CRW4260         ' '1.0q' Removable CD-ROM
        1,6,0   106) 'ARTEC   ' 'AM12S           ' '1.06' Scanner
        1,7,0   107) *</screen>

      <para xml:lang="en">Locate the entry for the <acronym>CD</acronym> burner and
	use the three numbers separated by commas as the value for
	<option>dev</option>.  In this case, the Yamaha burner device
	is <literal>1,5,0</literal>, so the appropriate input to
	specify that device is <option>dev=1,5,0</option>.  Refer to
	the manual page for <command>cdrecord</command> for other ways
	to specify this value and for information on writing audio
	tracks and controlling the write speed.</para>

      <para xml:lang="en">Alternately, run the following command to get the device
	address of the burner:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>camcontrol devlist</userinput>
&lt;MATSHITA CDRW/DVD UJDA740 1.00&gt;   at scbus1 target 0 lun 0 (cd0,pass0)</screen>

      <para xml:lang="en">Use the numeric values for <literal>scbus</literal>,
	<literal>target</literal>, and <literal>lun</literal>.  For
	this example, <literal>1,0,0</literal> is the device name to
	use.</para>
    </sect2>

    <sect2 xml:id="mkisofs">
      <title>寫入資料到一個 <acronym>ISO</acronym> 檔案系統</title>

      <para xml:lang="en">In order to produce a data <acronym>CD</acronym>, the data
	files that are going to make up the tracks on the
	<acronym>CD</acronym> must be prepared before they can be
	burned to the <acronym>CD</acronym>.  In FreeBSD,
	<package>sysutils/cdrtools</package> installs
	<command>mkisofs</command>, which can be used to produce an
	<acronym>ISO</acronym> 9660 file system that is an image of a
	directory tree within a <trademark class="registered">UNIX</trademark> file system.  The simplest
	usage is to specify the name of the <acronym>ISO</acronym>
	file to create and the path to the files to place into the
	<acronym>ISO</acronym> 9660 file system:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mkisofs -o <replaceable>imagefile.iso</replaceable> <replaceable>/path/to/tree</replaceable></userinput></screen>

      <indexterm xml:lang="en">
	<primary>file systems</primary>
	<secondary>ISO 9660</secondary>
      </indexterm>

      <para xml:lang="en">This command maps the file names in the specified path to
	names that fit the limitations of the standard
	<acronym>ISO</acronym> 9660 file system, and will exclude
	files that do not meet the standard for <acronym>ISO</acronym>
	file systems.</para>

      <indexterm xml:lang="en">
	<primary>file systems</primary>
	<secondary>Joliet</secondary>
      </indexterm>

      <para xml:lang="en">A number of options are available to overcome the
	restrictions imposed by the standard.  In particular,
	<option>-R</option> enables the Rock Ridge extensions common
	to <trademark class="registered">UNIX</trademark> systems and <option>-J</option> enables Joliet
	extensions used by <trademark class="registered">Microsoft</trademark> systems.</para>

      <para xml:lang="en">For <acronym>CD</acronym>s that are going to be used only
	on FreeBSD systems, <option>-U</option> can be used to disable
	all filename restrictions.  When used with
	<option>-R</option>, it produces a file system image that is
	identical to the specified FreeBSD tree, even if it violates the
	<acronym>ISO</acronym> 9660 standard.</para>

      <indexterm xml:lang="en">
	<primary><acronym>CD-ROM</acronym>s</primary>
	<secondary>creating bootable</secondary>
      </indexterm>

      <para xml:lang="en">The last option of general use is <option>-b</option>.
	This is used to specify the location of a boot image for use
	in producing an <quote>El Torito</quote> bootable
	<acronym>CD</acronym>.  This option takes an argument which is
	the path to a boot image from the top of the tree being
	written to the <acronym>CD</acronym>.  By default,
	<command>mkisofs</command> creates an <acronym>ISO</acronym>
	image in <quote>floppy disk emulation</quote> mode, and thus
	expects the boot image to be exactly 1200, 1440 or
	2880 KB in size.  Some boot loaders, like the one used by
	the FreeBSD distribution media, do not use emulation mode.  In
	this case, <option>-no-emul-boot</option> should be used.  So,
	if <filename>/tmp/myboot</filename> holds a bootable FreeBSD
	system with the boot image in
	<filename>/tmp/myboot/boot/cdboot</filename>, this command
	would produce
	<filename>/tmp/bootable.iso</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mkisofs -R -no-emul-boot -b boot/cdboot -o /tmp/bootable.iso /tmp/myboot</userinput></screen>

      <para xml:lang="en">The resulting <acronym>ISO</acronym> image can be mounted
	as a memory disk with:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mdconfig -a -t vnode -f /tmp/bootable.iso -u 0</userinput>
<prompt>#</prompt> <userinput>mount -t cd9660 /dev/md0 /mnt</userinput></screen>

      <para xml:lang="en">One can then verify that <filename>/mnt</filename> and
	<filename>/tmp/myboot</filename> are identical.</para>

      <para xml:lang="en">There are many other options available for
	<command>mkisofs</command> to fine-tune its behavior.  Refer
	to <citerefentry vendor="ports"><refentrytitle>mkisofs</refentrytitle><manvolnum>8</manvolnum></citerefentry> for details.</para>

      <note>
	<para xml:lang="en">It is possible to copy a data <acronym>CD</acronym> to
	  an image file that is functionally equivalent to the image
	  file created with <command>mkisofs</command>.  To do so, use
	  <filename>dd</filename> with the device name as the input
	  file and the name of the <acronym>ISO</acronym> to create as
	  the output file:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>dd if=/dev/<replaceable>cd0</replaceable> of=<replaceable>file.iso</replaceable> bs=2048</userinput></screen>

	<para xml:lang="en">The resulting image file can be burned to
	  <acronym>CD</acronym> as described in <xref linkend="cdrecord"/>.</para>
      </note>
    </sect2>

    <sect2 xml:id="mounting-cd">
      <title>使用資料 <acronym>CD</acronym></title>

      <para xml:lang="en">Once an <acronym>ISO</acronym> has been burned to a
	<acronym>CD</acronym>, it can be mounted by specifying the
	file system type, the name of the device containing the
	<acronym>CD</acronym>, and an existing mount point:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mount -t cd9660 <replaceable>/dev/cd0</replaceable> <replaceable>/mnt</replaceable></userinput></screen>

      <para xml:lang="en">Since <command>mount</command> assumes that a file system
	is of type <literal>ufs</literal>, a <errorname>Incorrect
	  super block</errorname> error will occur if <literal>-t
	  cd9660</literal> is not included when mounting a data
	<acronym>CD</acronym>.</para>

      <para xml:lang="en">While any data <acronym>CD</acronym> can be mounted this
	way, disks with certain <acronym>ISO</acronym> 9660 extensions
	might behave oddly.  For example, Joliet disks store all
	filenames in two-byte Unicode characters.  If some non-English
	characters show up as question marks, specify the local
	charset with <option>-C</option>.  For more information, refer
	to <citerefentry><refentrytitle>mount_cd9660</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

      <note>
	<para xml:lang="en">In order to do this character conversion with the help
	  of <option>-C</option>, the kernel requires the
	  <filename>cd9660_iconv.ko</filename> module to be loaded.
	  This can be done either by adding this line to
	  <filename>loader.conf</filename>:</para>

	<programlisting xml:lang="en">cd9660_iconv_load="YES"</programlisting>

	<para xml:lang="en">and then rebooting the machine, or by directly loading
	  the module with <command>kldload</command>.</para>
      </note>

      <para xml:lang="en">Occasionally, <errorname>Device not configured</errorname>
	will be displayed when trying to mount a data
	<acronym>CD</acronym>.  This usually means that the
	<acronym>CD</acronym> drive has not detected a disk in
	the tray, or that the drive is not visible on the bus.  It
	can take a couple of seconds for a <acronym>CD</acronym>
	drive to detect media, so be
	patient.</para>

      <para xml:lang="en">Sometimes, a <acronym>SCSI</acronym>
	<acronym>CD</acronym> drive may be missed because it did not
	have enough time to answer the bus reset.  To resolve this,
	a custom kernel can be created which increases the default
	<acronym>SCSI</acronym> delay.  Add the following option to
	the custom kernel configuration file and rebuild the kernel
	using the instructions in <xref linkend="kernelconfig-building"/>:</para>

      <programlisting xml:lang="en">options SCSI_DELAY=15000</programlisting>

      <para xml:lang="en">This tells the <acronym>SCSI</acronym> bus to pause 15
	seconds during boot, to give the <acronym>CD</acronym>
	drive every possible chance to answer the bus reset.</para>

      <note>
	<para xml:lang="en">It is possible to burn a file directly to
	  <acronym>CD</acronym>, without creating an
	  <acronym>ISO</acronym> 9660 file system.  This is known as
	  burning a raw data <acronym>CD</acronym> and some people do
	  this for backup purposes.</para>

	<para xml:lang="en">This type of disk can not be mounted as a normal data
	  <acronym>CD</acronym>.  In order to retrieve the data burned
	  to such a <acronym>CD</acronym>, the data must be read from
	  the raw device node.  For example, this command will extract
	  a compressed tar file located on the second
	  <acronym>CD</acronym> device into the current working
	  directory:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>tar xzvf /dev/<replaceable>cd1</replaceable></userinput></screen>

	<para xml:lang="en">  In order to mount a data <acronym>CD</acronym>, the
	  data must be written using
	  <command>mkisofs</command>.</para>
      </note>
    </sect2>

    <sect2 xml:id="duplicating-audiocds">
      <title>複製音樂 <acronym>CD</acronym></title>

      <para xml:lang="en">To duplicate an audio <acronym>CD</acronym>, extract the
	audio data from the <acronym>CD</acronym> to a series of
	files, then write these files to a blank
	<acronym>CD</acronym>.</para>

      <para xml:lang="en"><xref linkend="using-cdrecord"/> describes how to
	duplicate and burn an audio <acronym>CD</acronym>.  If the
	FreeBSD version is less than 10.0 and the device is
	<acronym>ATAPI</acronym>, the <option>atapicam</option> module
	must be first loaded using the instructions in <xref linkend="atapicam"/>.</para>

      <procedure xml:id="using-cdrecord">
	<title xml:lang="en">Duplicating an Audio <acronym>CD</acronym></title>

	<step>
	  <para xml:lang="en">The <package>sysutils/cdrtools</package> package or
	    port installs <command>cdda2wav</command>.  This command
	    can be used to extract all of the audio tracks, with each
	    track written to a separate <acronym>WAV</acronym> file in
	    the current working directory:</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>cdda2wav -vall -B -Owav</userinput></screen>

	  <para xml:lang="en">A device name does not need to be specified if there
	    is only one <acronym>CD</acronym> device on the system.
	    Refer to the <command>cdda2wav</command> manual page for
	    instructions on how to specify a device and to learn more
	    about the other options available for this command.</para>
	</step>

	<step>
	  <para xml:lang="en">Use <command>cdrecord</command> to write the
	    <filename>.wav</filename> files:</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>cdrecord -v dev=<replaceable>2,0</replaceable> -dao -useinfo  *.wav</userinput></screen>

	  <para xml:lang="en">Make sure that <replaceable>2,0</replaceable> is set
	    appropriately, as described in <xref linkend="cdrecord"/>.</para>
	</step>
      </procedure>
    </sect2>
  </sect1>

  <sect1 xml:id="creating-dvds">
    <info>
      <title>建立與使用 <acronym>DVD</acronym> 媒體</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Fonvieille</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Andy</firstname>
	    <surname>Polyakov</surname>
	  </personname>
	  <contrib>With inputs from </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary><acronym>DVD</acronym></primary>
      <secondary>burning</secondary>
    </indexterm>

    <para xml:lang="en">Compared to the <acronym>CD</acronym>, the
      <acronym>DVD</acronym> is the next generation of optical media
      storage technology.  The <acronym>DVD</acronym> can hold more
      data than any <acronym>CD</acronym> and is the standard for
      video publishing.</para>

    <para xml:lang="en">Five physical recordable formats can be defined for a
      recordable <acronym>DVD</acronym>:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">DVD-R: This was the first <acronym>DVD</acronym>
	  recordable format available.  The DVD-R standard is defined
	  by the <link xlink:href="http://www.dvdforum.org/forum.shtml"><acronym>DVD</acronym>
	    Forum</link>.  This format is write once.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><acronym>DVD-RW</acronym>: This is the rewritable
	  version of the DVD-R standard.  A
	  <acronym>DVD-RW</acronym> can be rewritten about 1000
	  times.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><acronym>DVD-RAM</acronym>: This is a rewritable format
	  which can be seen as a removable hard drive.  However, this
	  media is not compatible with most
	  <acronym>DVD-ROM</acronym> drives and DVD-Video players as
	  only a few <acronym>DVD</acronym> writers support the
	  <acronym>DVD-RAM</acronym> format.  Refer to <xref linkend="creating-dvd-ram"/> for more information on
	  <acronym>DVD-RAM</acronym> use.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><acronym>DVD+RW</acronym>: This is a rewritable format
	  defined by the <link xlink:href="https://en.wikipedia.org/wiki/DVD%2BRW_Alliance">
	    <acronym>DVD+RW</acronym> Alliance</link>.  A
	  <acronym>DVD+RW</acronym> can be rewritten about 1000
	    times.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">DVD+R: This format is the write once variation of the
	  <acronym>DVD+RW</acronym> format.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">A single layer recordable <acronym>DVD</acronym> can hold up
      to 4,700,000,000 bytes which is actually 4.38 GB or
      4485 MB as 1 kilobyte is 1024 bytes.</para>

    <note>
      <para xml:lang="en">A distinction must be made between the physical media and
	the application.  For example, a DVD-Video is a specific file
	layout that can be written on any recordable
	<acronym>DVD</acronym> physical media such as DVD-R, DVD+R, or
	<acronym>DVD-RW</acronym>.  Before choosing the type of media,
	ensure that both the burner and the DVD-Video player are
	compatible with the media under consideration.</para>
    </note>

    <sect2>
      <title>設定</title>

      <para xml:lang="en">To perform <acronym>DVD</acronym> recording, use
	<citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry>.  This command is part of the
	<package>sysutils/dvd+rw-tools</package> utilities which
	support all <acronym>DVD</acronym> media types.</para>

      <para xml:lang="en">These tools use the <acronym>SCSI</acronym> subsystem to
	access the devices, therefore <link linkend="atapicam">ATAPI/CAM support</link> must be loaded
	or statically compiled into the kernel.  This support is not
	needed if the burner uses the <acronym>USB</acronym>
	interface.  Refer to <xref linkend="usb-disks"/> for more
	details on <acronym>USB</acronym> device configuration.</para>

      <para xml:lang="en">DMA access must also be enabled for
	<acronym>ATAPI</acronym> devices, by adding the following line
	to <filename>/boot/loader.conf</filename>:</para>

      <programlisting xml:lang="en">hw.ata.atapi_dma="1"</programlisting>

      <para xml:lang="en">Before attempting to use
	<application>dvd+rw-tools</application>, consult the <link xlink:href="http://fy.chalmers.se/~appro/linux/DVD+RW/hcn.html">Hardware
	  Compatibility Notes</link>.</para>

      <note>
	<para xml:lang="en">For a graphical user interface, consider using
	  <package>sysutils/k3b</package> which provides a user
	  friendly interface to <citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry> and many other
	  burning tools.</para>
      </note>
    </sect2>

    <sect2>
      <title>燒錄資料 <acronym>DVD</acronym></title>

      <para xml:lang="en">Since <citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry> is a front-end to <link linkend="mkisofs">mkisofs</link>, it will invoke
	<citerefentry vendor="ports"><refentrytitle>mkisofs</refentrytitle><manvolnum>8</manvolnum></citerefentry> to create the file system layout and perform
	the write on the <acronym>DVD</acronym>.  This means that an
	image of the data does not need to be created before the
	burning process.</para>

      <para xml:lang="en">To burn to a DVD+R or a DVD-R the data in
	<filename>/path/to/data</filename>, use the following
	command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>growisofs -dvd-compat -Z <replaceable>/dev/cd0</replaceable> -J -R <replaceable>/path/to/data</replaceable></userinput></screen>

      <para xml:lang="en">In this example, <option>-J -R</option> is passed to
	<citerefentry vendor="ports"><refentrytitle>mkisofs</refentrytitle><manvolnum>8</manvolnum></citerefentry>  to create an ISO 9660 file system with Joliet
	and Rock Ridge extensions.  Refer to <citerefentry vendor="ports"><refentrytitle>mkisofs</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more
	details.</para>

      <para xml:lang="en">For the initial session recording, <option>-Z</option> is
	used for both single and multiple sessions.  Replace
	<replaceable>/dev/cd0</replaceable>, with the name of the
	<acronym>DVD</acronym> device.  Using
	<option>-dvd-compat</option> indicates that the disk will be
	closed and that the recording will be unappendable.  This
	should also provide better media compatibility with
	<acronym>DVD-ROM</acronym> drives.</para>

      <para xml:lang="en">To burn a pre-mastered image, such as
	<replaceable>imagefile.iso</replaceable>, use:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>growisofs -dvd-compat -Z <replaceable>/dev/cd0</replaceable>=<replaceable>imagefile.iso</replaceable></userinput></screen>

      <para xml:lang="en">The write speed should be detected and automatically set
	according to the media and the drive being used.  To force the
	write speed, use  <option>-speed=</option>.  Refer to
	<citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry> for example usage.</para>

      <note>
	<para xml:lang="en">In order to support working files larger than 4.38GB, an
	  UDF/ISO-9660 hybrid file system must be created by passing
	  <option>-udf -iso-level 3</option> to <citerefentry vendor="ports"><refentrytitle>mkisofs</refentrytitle><manvolnum>8</manvolnum></citerefentry> and
	  all related programs, such as <citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry>.  This is
	  required only when creating an ISO image file or when
	  writing files directly to a disk.  Since a disk created this
	  way must be mounted as an UDF file system with
	  <citerefentry><refentrytitle>mount_udf</refentrytitle><manvolnum>8</manvolnum></citerefentry>, it will be usable only on an UDF aware
	  operating system.  Otherwise it will look as if it contains
	  corrupted files.</para>

	<para xml:lang="en">To create this type of ISO file:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>mkisofs -R -J -udf -iso-level 3 -o <replaceable>imagefile.iso</replaceable> <replaceable>/path/to/data</replaceable></userinput></screen>

	<para xml:lang="en">To burn files directly to a disk:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>growisofs -dvd-compat -udf -iso-level 3 -Z <replaceable>/dev/cd0</replaceable> -J -R <replaceable>/path/to/data</replaceable></userinput></screen>

	<para xml:lang="en">When an ISO image already contains large files, no
	  additional options are required for <citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry> to
	  burn that image on a disk.</para>

	<para xml:lang="en">Be sure to use an up-to-date version of
	  <package>sysutils/cdrtools</package>, which contains
	  <citerefentry vendor="ports"><refentrytitle>mkisofs</refentrytitle><manvolnum>8</manvolnum></citerefentry>, as an older version may not contain large
	  files support.  If the latest version does not work, install
	  <package>sysutils/cdrtools-devel</package> and read its
	  <citerefentry vendor="ports"><refentrytitle>mkisofs</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
      </note>
    </sect2>

    <sect2>
      <title>燒錄 <acronym>DVD</acronym>-Video</title>

      <indexterm xml:lang="en">
	<primary><acronym>DVD</acronym></primary>
	<secondary>DVD-Video</secondary>
      </indexterm>

      <para xml:lang="en">A DVD-Video is a specific file layout based on the ISO
	9660 and micro-UDF (M-UDF) specifications.  Since DVD-Video
	presents a specific data structure hierarchy, a particular
	program such as <package>multimedia/dvdauthor</package> is
	needed to author the <acronym>DVD</acronym>.</para>

      <para xml:lang="en">If an image of the DVD-Video file system already exists,
	it can be burned in the same way as any other image.  If
	<command>dvdauthor</command> was used to make the
	<acronym>DVD</acronym> and the result is in
	<filename>/path/to/video</filename>, the following command
	should be used to burn the DVD-Video:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>growisofs -Z <replaceable>/dev/cd0</replaceable> -dvd-video <replaceable>/path/to/video</replaceable></userinput></screen>

      <para xml:lang="en"><option>-dvd-video</option> is passed to <citerefentry vendor="ports"><refentrytitle>mkisofs</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	to instruct it to create a DVD-Video file system layout.
	This option implies the <option>-dvd-compat</option>
	<citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry> option.</para>
    </sect2>

    <sect2>
      <title>使用 <acronym>DVD+RW</acronym></title>

      <indexterm xml:lang="en">
	<primary><acronym>DVD</acronym></primary>
	<secondary><acronym>DVD+RW</acronym></secondary>
      </indexterm>

      <para xml:lang="en">Unlike CD-RW, a virgin <acronym>DVD+RW</acronym> needs to
	be formatted before first use.  It is
	<emphasis>recommended</emphasis> to let <citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry> take
	care of this automatically whenever appropriate.  However, it
	is possible to use <command>dvd+rw-format</command> to format
	the <acronym>DVD+RW</acronym>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>dvd+rw-format <replaceable>/dev/cd0</replaceable></userinput></screen>

      <para xml:lang="en">Only perform this operation once and keep in mind that
	only virgin <acronym>DVD+RW</acronym> medias need to be
	formatted.  Once formatted, the <acronym>DVD+RW</acronym> can
	be burned as usual.</para>

      <para xml:lang="en">To burn a totally new file system and not just append some
	data onto a <acronym>DVD+RW</acronym>, the media does not need
	to be blanked first.  Instead, write over the previous
	recording like this:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>growisofs -Z <replaceable>/dev/cd0</replaceable> -J -R <replaceable>/path/to/newdata</replaceable></userinput></screen>

      <para xml:lang="en">The <acronym>DVD+RW</acronym> format supports appending
	data to a previous recording.  This operation consists of
	merging a new session to the existing one as it is not
	considered to be multi-session writing.  <citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry>
	will <emphasis>grow</emphasis> the ISO 9660 file system
	present on the media.</para>

      <para xml:lang="en">For example, to append data to a
	<acronym>DVD+RW</acronym>, use the following:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>growisofs -M <replaceable>/dev/cd0</replaceable> -J -R <replaceable>/path/to/nextdata</replaceable></userinput></screen>

      <para xml:lang="en">The same <citerefentry vendor="ports"><refentrytitle>mkisofs</refentrytitle><manvolnum>8</manvolnum></citerefentry> options used to burn the
	initial session should be used during next writes.</para>

      <note>
	<para xml:lang="en">Use <option>-dvd-compat</option> for better media
	  compatibility with <acronym>DVD-ROM</acronym> drives.  When
	  using <acronym>DVD+RW</acronym>, this option will not
	  prevent the addition of data.</para>
      </note>

      <para xml:lang="en">To blank the media, use:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>growisofs -Z <replaceable>/dev/cd0</replaceable>=<replaceable>/dev/zero</replaceable></userinput></screen>
    </sect2>

    <sect2>
      <title>使用 <acronym>DVD-RW</acronym></title>

      <indexterm xml:lang="en">
	<primary><acronym>DVD</acronym></primary>
	<secondary><acronym>DVD-RW</acronym></secondary>
      </indexterm>

      <para xml:lang="en">A <acronym>DVD-RW</acronym> accepts two disc formats:
	incremental sequential and restricted overwrite.  By default,
	<acronym>DVD-RW</acronym> discs are in sequential
	format.</para>

      <para xml:lang="en">A virgin <acronym>DVD-RW</acronym> can be directly written
	without being formatted.  However, a non-virgin
	<acronym>DVD-RW</acronym> in sequential format needs to be
	blanked before writing a new initial session.</para>

      <para xml:lang="en">To blank a <acronym>DVD-RW</acronym> in sequential
	mode:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>dvd+rw-format -blank=full <replaceable>/dev/cd0</replaceable></userinput></screen>

      <note>
	<para xml:lang="en">A full blanking using <option>-blank=full</option> will
	  take about one hour on a 1x media.  A fast blanking can be
	  performed using <option>-blank</option>, if the
	  <acronym>DVD-RW</acronym> will be recorded in Disk-At-Once
	  (DAO) mode.  To burn the <acronym>DVD-RW</acronym> in DAO
	  mode, use the command:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>growisofs -use-the-force-luke=dao -Z <replaceable>/dev/cd0</replaceable>=<replaceable>imagefile.iso</replaceable></userinput></screen>

	<para xml:lang="en">Since <citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry> automatically attempts to detect
	  fast blanked media and engage DAO write,
	  <option>-use-the-force-luke=dao</option> should not be
	  required.</para>

	<para xml:lang="en">One should instead use restricted overwrite mode with
	  any <acronym>DVD-RW</acronym> as this format is more
	  flexible than the default of incremental sequential.</para>
      </note>

      <para xml:lang="en">To write data on a sequential <acronym>DVD-RW</acronym>,
	use the same instructions as for the other
	<acronym>DVD</acronym> formats:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>growisofs -Z <replaceable>/dev/cd0</replaceable> -J -R <replaceable>/path/to/data</replaceable></userinput></screen>

      <para xml:lang="en">To append some data to a previous recording, use
	<option>-M</option> with <citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry>.  However, if data
	is appended on a <acronym>DVD-RW</acronym> in incremental
	sequential mode, a new session will be created on the disc and
	the result will be a multi-session disc.</para>

      <para xml:lang="en">A <acronym>DVD-RW</acronym> in restricted overwrite format
	does not need to be blanked before a new initial session.
	Instead, overwrite the disc with <option>-Z</option>.  It is
	also possible to grow an existing ISO 9660 file system written
	on the disc with <option>-M</option>.  The result will be a
	one-session <acronym>DVD</acronym>.</para>

      <para xml:lang="en">To put a <acronym>DVD-RW</acronym> in restricted overwrite
	format, the following command must be used:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>dvd+rw-format <replaceable>/dev/cd0</replaceable></userinput></screen>

      <para xml:lang="en">To change back to sequential format, use:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>dvd+rw-format -blank=full <replaceable>/dev/cd0</replaceable></userinput></screen>
    </sect2>

    <sect2>
      <title>多階段燒錄 (Multi-Session)</title>

      <para xml:lang="en">Few <acronym>DVD-ROM</acronym> drives support
	multi-session DVDs and most of the time only read the first
	session.  DVD+R, DVD-R and <acronym>DVD-RW</acronym> in
	sequential format can accept multiple sessions.  The notion
	of multiple sessions does not exist for the
	<acronym>DVD+RW</acronym> and the <acronym>DVD-RW</acronym>
	restricted overwrite formats.</para>

      <para xml:lang="en">Using the following command after an initial non-closed
	session on a DVD+R, DVD-R, or <acronym>DVD-RW</acronym> in
	sequential format, will add a new session to the disc:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>growisofs -M <replaceable>/dev/cd0</replaceable> -J -R <replaceable>/path/to/nextdata</replaceable></userinput></screen>

      <para xml:lang="en">Using this command with a <acronym>DVD+RW</acronym> or a
	<acronym>DVD-RW</acronym> in restricted overwrite mode will
	append data while merging the new session to the existing one.
	The result will be a single-session disc.  Use this method to
	add data after an initial write on these types of
	media.</para>

      <note>
	<para xml:lang="en">Since some space on the media is used between each
	  session to mark the end and start of sessions, one should
	  add sessions with a large amount of data to optimize media
	  space.  The number of sessions is limited to 154 for a
	  DVD+R, about 2000 for a DVD-R, and 127 for a DVD+R Double
	  Layer.</para>
      </note>
    </sect2>

    <sect2>
      <title>取得更多資訊</title>

      <para xml:lang="en">To obtain more information about a <acronym>DVD</acronym>,
	use <command>dvd+rw-mediainfo
	  <replaceable>/dev/cd0</replaceable></command> while the
	disc in the specified drive.</para>

      <para xml:lang="en">More information about
	<application>dvd+rw-tools</application> can be found in
	<citerefentry vendor="ports"><refentrytitle>growisofs</refentrytitle><manvolnum>1</manvolnum></citerefentry>, on the <link xlink:href="http://fy.chalmers.se/~appro/linux/DVD+RW/">dvd+rw-tools
	  web site</link>, and in the <link xlink:href="http://lists.debian.org/cdwrite/">cdwrite
	  mailing list</link> archives.</para>

      <note>
	<para xml:lang="en">When creating a problem report related to the use of
	  <application>dvd+rw-tools</application>, always include the
	  output of <command>dvd+rw-mediainfo</command>.</para>
      </note>
    </sect2>

    <sect2 xml:id="creating-dvd-ram">
      <title>使用 <acronym>DVD-RAM</acronym></title>

      <indexterm xml:lang="en">
	<primary><acronym>DVD</acronym></primary>
	<secondary><acronym>DVD-RAM</acronym></secondary>
      </indexterm>

      <para xml:lang="en"><acronym>DVD-RAM</acronym> writers can use either a
	<acronym>SCSI</acronym> or <acronym>ATAPI</acronym> interface.
	For <acronym>ATAPI</acronym> devices, DMA access has to be
	enabled by adding the following line to
	<filename>/boot/loader.conf</filename>:</para>

      <programlisting xml:lang="en">hw.ata.atapi_dma="1"</programlisting>

      <para xml:lang="en">A <acronym>DVD-RAM</acronym> can be seen as a removable
	hard drive.  Like any other hard drive, the
	<acronym>DVD-RAM</acronym> must be formatted before it can be
	used.  In this example, the whole disk space will be formatted
	with a standard UFS2 file system:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>dd if=/dev/zero of=<replaceable>/dev/acd0</replaceable> bs=2k count=1</userinput>
<prompt>#</prompt> <userinput>bsdlabel -Bw <replaceable>acd0</replaceable></userinput>
<prompt>#</prompt> <userinput>newfs <replaceable>/dev/acd0</replaceable></userinput></screen>

      <para xml:lang="en">The <acronym>DVD</acronym> device,
	<filename>acd0</filename>, must be changed according to the
	configuration.</para>

      <para xml:lang="en">Once the <acronym>DVD-RAM</acronym> has been formatted, it
	can be mounted as a normal hard drive:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mount <replaceable>/dev/acd0</replaceable> <replaceable>/mnt</replaceable></userinput></screen>

      <para xml:lang="en">Once mounted, the <acronym>DVD-RAM</acronym> will be both
	readable and writeable.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="floppies">
    <title>建立與使用軟碟</title>

<!--
      <authorgroup>
	<author>
	  <personname>
	    <firstname>Julio</firstname>
	    <surname>Merino</surname>
	  </personname>
	  <contrib>Original work by </contrib>
	</author>
      </authorgroup>

      <authorgroup>
	<author>
	  <personname>
	    <firstname>Martin</firstname>
	    <surname>Karlsson</surname>
	  </personname>
	  <contrib>Rewritten by </contrib>
	</author>
      </authorgroup>
      -->

    <para xml:lang="en">This section explains how to format a 3.5 inch floppy disk
      in FreeBSD.</para>

    <procedure>
      <title xml:lang="en">Steps to Format a Floppy</title>

      <para xml:lang="en">A floppy disk needs to be low-level formatted before it
	can be used.  This is usually done by the vendor, but
	formatting is a good way to check media integrity.  To
	low-level format the floppy disk on FreeBSD, use
	<citerefentry><refentrytitle>fdformat</refentrytitle><manvolnum>1</manvolnum></citerefentry>.  When using this utility, make note of any
	error messages, as these can help determine if the disk is
	good or bad.</para>

      <step>
	<para xml:lang="en">To format the floppy, insert a new 3.5 inch floppy disk
	  into the first floppy drive and issue:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>/usr/sbin/fdformat -f 1440 /dev/fd0</userinput></screen>
      </step>

      <step>
	<para xml:lang="en">After low-level formatting the disk, create a disk label
	  as it is needed by the system to determine the size of the
	  disk and its geometry.  The supported geometry values are
	  listed in <filename>/etc/disktab</filename>.</para>

	<para xml:lang="en">To write the disk label, use <citerefentry><refentrytitle>bsdlabel</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>/sbin/bsdlabel -B -w /dev/fd0 fd1440</userinput></screen>
      </step>

      <step>
	<para xml:lang="en">The floppy is now ready to be high-level formatted with
	  a file system.  The floppy's file system can be either UFS
	  or FAT, where FAT is generally a better choice for
	  floppies.</para>

	<para xml:lang="en">To format the floppy with FAT, issue:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>/sbin/newfs_msdos /dev/fd0</userinput></screen>
      </step>
    </procedure>

    <para xml:lang="en">The disk is now ready for use.  To use the floppy, mount it
      with <citerefentry><refentrytitle>mount_msdosfs</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  One can also install and use
      <package>emulators/mtools</package> from the Ports
      Collection.</para>
  </sect1>

  <sect1 xml:id="backup-basics">
    <title>備份基礎概念</title>

<!--
    <authorgroup>
	<author>
	  <personname>
	    <firstname>Lowell</firstname>
	    <surname>Gilbert</surname>
	  </personname>
	  <contrib>Original work by </contrib>
	</author>
      </authorgroup>
      -->

    <para>為了要能夠從磁碟故障、意外刪除文件、隨機文件損壞或完全機器毀壞，包含本地備份毀壞進行恢復，執行備份計劃是必要的。</para>

    <para>備份的類型與排程會依情況有所不同，取決於資料的重要性、檔案還原所需的程度以及可接受的停機時間。一些可用來備份的技術有：</para>

    <itemizedlist>
      <listitem>
	<para>封存整個檔案系統，備份至永久、異地媒體。這可在以上所列的所有問題發生時提供保護，但要還原會較慢且不方便，特別是對於沒有權限的使用者。</para>
      </listitem>

      <listitem>
	<para>檔案系統快照 (Snapshot)，對於還原已刪除的檔案或先前版本的檔案非常有用。</para>
      </listitem>

      <listitem>
	<para>整個檔案系統或磁碟的複本，使用排程的 <package>net/rsync</package> 來與網路上的另一個系統同步。</para>
      </listitem>

      <listitem>
	<para>硬體或軟體 <acronym>RAID</acronym>，來最小化或避免當磁碟故障時的停機時間。</para>
      </listitem>
    </itemizedlist>

    <para>通常會混合使用各種備份技術，例如，建立一個排程每週自動做儲存於異地的完整系統備份，並使用每小時的 ZFS 快照來輔助備份。此外，在對檔案做編輯或刪除前手動備份各別目錄或檔案。</para>

    <para>本章節會介紹一些可以用來在 FreeBSD 上建立與管理系統備份的工具。</para>

    <sect2>
      <title>檔案系統備份</title>

      <indexterm xml:lang="en">
	<primary>backup software</primary>
	<secondary>dump / restore</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><command>dump</command></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><command>restore</command></primary>
      </indexterm>

      <para>要備份一個檔案系統，會用到 <citerefentry><refentrytitle>dump</refentrytitle><manvolnum>8</manvolnum></citerefentry> 這個傳統 <trademark class="registered">UNIX</trademark> 程式來建立備份，並可使用 <citerefentry><refentrytitle>restore</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來還原備份。這兩個工具可在磁碟區塊的層級運作，這個層級比由檔案系統建立檔案、連結與目錄的抽象層級還要低，因此不像其他的備份軟體，<command>dump</command> 必須一次備份整個檔案系統，且無法只備份部份檔案系統或跨多個檔案系統的目錄樹，<command>dump</command> 會備份構成檔案與目錄的原始資料區塊，而非直接備份檔案與目錄。</para>

      <note>
	<para>在根目錄使用 <command>dump</command>，會無法備份 <filename>/home</filename>, <filename>/usr</filename> 或其他許多的目錄，由於這些目錄通常是其他檔案系統的掛載點或連結到其他檔案系統的符號連結。</para>
      </note>

      <para>還原資料時，<command>restore</command> 預設會儲存暫存檔案於 <filename>/tmp/</filename>，當使用一個 <filename>/tmp</filename> 較小的復原磁碟時，請設定 <envar>TMPDIR</envar> 到一個擁有較多可用空間的目錄以讓還原可以順利執行。</para>

      <para>當使用 <command>dump</command> 時，請小心最早自 AT&amp;T <trademark class="registered">UNIX</trademark>,circa 1975 的版本 6 仍有一些問題存在，預設的參數會假設備份到一個 9 軌的磁帶，這並非其他類型的媒體或現今可用的高密度磁帶，必須另外在指令列修改這個預設值。</para>

      <indexterm xml:lang="en">
	<primary><filename>.rhosts</filename></primary>
      </indexterm>
      <para>雖然可以使用 <citerefentry><refentrytitle>rdump</refentrytitle><manvolnum>8</manvolnum></citerefentry> 與 <citerefentry><refentrytitle>rrestore</refentrytitle><manvolnum>8</manvolnum></citerefentry> 工具可以跨網路備份一個檔案系統到另一個系統或備份到連結另一台電腦的磁帶機，但這使用兩個工具備份的安全性並不足夠。</para>

      <para>可改以在較安全的 <acronym>SSH</acronym> 連線上使用 <command>dump</command> 與 <command>restore</command>。以下例子會建立一個完整、壓縮的 <filename>/usr</filename> 備份並透過 <acronym>SSH</acronym> 連線傳送備份檔案到指定的主機。</para>

      <example>
	<title>在 <application>ssh</application> 使用 <command>dump</command></title>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>/sbin/dump -0uan -f - /usr | gzip -2 | ssh -c blowfish \
          targetuser@targetmachine.example.com dd of=/mybigfiles/dump-usr-l0.gz</userinput></screen>
      </example>

      <para>這個例子會設定 <envar>RSH</envar>，以便透過 <acronym>SSH</acronym> 連線寫入備份到遠端系統的磁帶機：</para>

      <example>
	<title>在 <application>ssh</application> 使用 <command>dump</command> 透過 <envar>RSH</envar> 設定</title>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>env RSH=/usr/bin/ssh /sbin/dump -0uan -f targetuser@targetmachine.example.com:/dev/sa0 /usr</userinput></screen>
      </example>
    </sect2>

    <sect2>
      <title>目錄備份</title>

      <indexterm xml:lang="en">
	<primary>backup software</primary>
	<secondary><command>tar</command></secondary>
      </indexterm>

      <para>系統已有內建數個工具可在需要時用來備份與還原指定的檔案與目錄。</para>

      <para>要備份一個目錄中的所有檔案最好的選擇是 <citerefentry><refentrytitle>tar</refentrytitle><manvolnum>1</manvolnum></citerefentry>，這個工具最早可以追朔自 AT&amp;T <trademark class="registered">UNIX</trademark> 版本 6 時，因此預設會做一個遞迴備份到一個磁帶機，可以使用參數來改指定備份檔案的名稱。</para>

      <indexterm xml:lang="en"><primary><command>tar</command></primary></indexterm>

      <para>這個例子會建立目前目錄的壓縮備份並儲存至 <filename>/tmp/mybackup.tgz</filename>，在建立備份檔案時，要確認備份檔案不要儲存到與目前備份目錄相同的目錄。</para>

      <example>
	<title>使用 <command>tar</command> 備份目前目錄</title>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>tar czvf <replaceable>/tmp/mybackup.tgz</replaceable> . </userinput></screen>
      </example>

      <para>要還原整個備份，先 <command>cd</command> 進入要放置還原檔的目錄並指定備份的名稱。注意，這個動作會覆寫任何在該還原目錄中任何較新版的檔案，當不確定時，可先還原到一個暫時的目錄或指定備份檔中的檔案做還原。</para>

      <example>
	<title>使用 <command>tar</command> 還原目前目錄</title>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>tar xzvf <replaceable>/tmp/mybackup.tgz</replaceable></userinput></screen>
      </example>

      <para>除此之外還有許多可用的參數在 <citerefentry><refentrytitle>tar</refentrytitle><manvolnum>1</manvolnum></citerefentry> 中會有說明。本工具也支援使用排除模式 (Exclude pattern) 來指定那些檔案應該在備份指定目錄或自備份還原檔案時排除。</para>

      <indexterm xml:lang="en">
	<primary>backup software</primary>
	<secondary><command>cpio</command></secondary>
      </indexterm>

      <para>要使用指定的檔案與目錄清單做備份使用 <citerefentry><refentrytitle>cpio</refentrytitle><manvolnum>1</manvolnum></citerefentry> 是不錯的選擇。它並不像 <command>tar</command>，<command>cpio</command> 並不知道如何走訪目錄樹，所以必須提供檔案的清單才能做備份。</para>

      <para>例如，檔案的清單可以使用 <command>ls</command> 或 <command>find</command> 來產生。以下例子會建立一個目前目錄的遞迴清單然後轉送 (Piped) 給 <command>cpio</command> 來建立名稱為 <filename>/tmp/mybackup.cpio</filename> 的備份檔。</para>

      <example>
	<title>使用 <command>ls</command> 與 <command>cpio</command> 來製作目前目錄的遞迴備份</title>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ls -R | cpio -ovF <replaceable>/tmp/mybackup.cpio</replaceable></userinput></screen>
      </example>

      <indexterm xml:lang="en">
	<primary>backup software</primary>
	<secondary><command>pax</command></secondary>
      </indexterm>
      <indexterm xml:lang="en"><primary><command>pax</command></primary></indexterm>
      <indexterm xml:lang="en"><primary>POSIX</primary></indexterm>
      <indexterm xml:lang="en"><primary>IEEE</primary></indexterm>

      <para>有一個備份工具嘗試整合 <command>tar</command> 與 <command>cpio</command> 所提供的功能，便是 <citerefentry><refentrytitle>pax</refentrytitle><manvolnum>1</manvolnum></citerefentry>。經歷數年，各種版本的 <command>tar</command> 與 <command>cpio</command> 變的有一些無法相容。<trademark class="registered">POSIX</trademark> 開發出 <command>pax</command>，嘗試讀取與寫入各種版本的 <command>cpio</command> and <command>tar</command> 格式並加入自己的新格式。</para>

      <para>以先前的例子改使用 <command>pax</command> 會是：</para>

      <example>
	<title>使用 <command>pax</command> 備份目前目錄</title>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pax -wf <replaceable>/tmp/mybackup.pax</replaceable> .</userinput></screen>
      </example>
    </sect2>

    <sect2 xml:id="backups-tapebackups">
      <title>使用資料磁帶備份</title>

      <indexterm xml:lang="en"><primary>tape media</primary></indexterm>

      <para>隨著磁帶的技術持續發展，當今的備份系統將異地備份與本地可移除媒體做了結合。FreeBSD 支援任何使用 <acronym>SCSI</acronym> 的磁帶機，如 <acronym>LTO</acronym> 或 <acronym>DAT</acronym>，並有限制的支援 <acronym>SATA</acronym> 與 <acronym>USB</acronym> 磁帶機。</para>

      <para><acronym>SCSI</acronym> 磁帶機在 FreeBSD 會使用 <citerefentry><refentrytitle>sa</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式以及 <filename>/dev/sa0</filename>, <filename>/dev/nsa0</filename> 與 <filename>/dev/esa0</filename> 裝置，實體裝置名稱為 <filename>/dev/sa0</filename>，當使用 <filename>/dev/nsa0</filename> 時，備份程式在寫入檔案之後不會倒帶，這可允許寫入超過一個檔案到磁帶，而使用 <filename>/dev/esa0</filename> 時，當關閉裝置後便會退出磁帶。</para>

      <para>在 FreeBSD 中會使用 <command>mt</command> 來做磁帶機的控制操作，例如在磁帶中搜尋檔案或寫入磁帶控制記號到磁帶。例如，要保留磁帶上的前三個檔案，可以在寫入新檔案前跳過這些檔案：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mt -f /dev/nsa0 fsf 3</userinput></screen>

      <para>這個工具尚支援許多操作，請參考 <citerefentry><refentrytitle>mt</refentrytitle><manvolnum>1</manvolnum></citerefentry> 了解詳情。</para>

      <para>要使用 <command>tar</command> 寫入單一檔案到磁帶，可指定磁帶裝置的名稱以及要備份的檔案：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>tar cvf /dev/sa0 <replaceable>file</replaceable></userinput></screen>

      <para>要從磁帶上的 <command>tar</command> 封存檔還原檔案到目前的目錄可：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>tar xvf /dev/sa0</userinput></screen>

      <para>要備份一個 <acronym>UFS</acronym> 檔案系統可使用 <command>dump</command>。以下例子會備份 <filename>/usr</filename> 並在完成時不做倒帶：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>dump -0aL -b64 -f /dev/nsa0 /usr</userinput></screen>

      <para>要以互動的方式從磁帶上的 <command>dump</command> 檔案還原到目前目錄：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>restore -i -f /dev/nsa0</userinput></screen>
    </sect2>

    <sect2 xml:id="backups-programs-amanda">
      <title>第三方備份工具</title>

      <indexterm xml:lang="en">
	<primary>backup software</primary>
      </indexterm>

      <para>FreeBSD Port 套件集提供了許多第三方工具可用於排程建立備份，簡化磁帶備份並讓備份更簡單方便。許多這類的應用程式是以客戶端/伺服器為基礎，可用來自動化單一系統或網路上所有電腦的備份。</para>

      <para>較熱門的工具包含 <application>Amanda</application>, <application>Bacula</application>, <application>rsync</application> 以及 <application>duplicity</application>。</para>
    </sect2>

    <sect2>
      <title>緊急還原</title>

      <para>除了正常的備份外，建議將下以步驟做為緊急準備計劃的一部份。</para>

      <indexterm xml:lang="en">
	<primary><command>bsdlabel</command></primary></indexterm>

      <para>替以下指令的輸出建立一份可列印的複本：</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><command>gpart show</command></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><command>more /etc/fstab</command></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><command>dmesg</command></para>
	</listitem>
      </itemizedlist>

      <indexterm xml:lang="en"><primary>livefs
	  <acronym>CD</acronym></primary></indexterm>

      <para>在安全的地方保存這份列印結果與安裝媒體的複本，在緊急還原時可能會需要，接著開機進入安裝媒體並選擇 <literal>Live CD</literal> 以存取救援 Shell (Rescue shell)，這個救援模式可以用來檢視目前系統的狀態，若有需要，可重新格式化磁碟然後自備份還原資料。</para>

      <note>
	<para>FreeBSD/i386 11.2-RELEASE 的安裝媒體未內含救援 Shell，針對該版本，可改自 <uri xlink:href="ftp://ftp.FreeBSD.org/pub/FreeBSD/releases/i386/ISO-IMAGES/11.2/FreeBSD-11.2-RELEASE-i386-livefs.iso">ftp://ftp.FreeBSD.org/pub/FreeBSD/releases/i386/ISO-IMAGES/11.2/FreeBSD-11.2-RELEASE-i386-livefs.iso</uri> 下載 Livefs <acronym>CD</acronym> 映像檔並燒錄。</para>
      </note>

      <para>然後，測試救援 Shell 下的備份。記錄下整個程序，將這份記錄隨媒體、列印結果、備份檔一併保存，這份記錄可以避免在緊張壓力下做緊急還原時因不慎造成備份的毀壞。</para>

      <para>要再安全性一點，則可將最新的備份儲存在與實體電腦與磁碟機有一段明顯距離的遠端位置。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="disks-virtual">
    <info>
      <title>記憶體磁碟</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Fonvieille</surname>
	  </personname>
	  <contrib>Reorganized and enhanced by </contrib>
	</author>
      </authorgroup>
    </info>

    <para xml:lang="en">In addition to physical disks, FreeBSD also supports the
      creation and use of memory disks.  One possible use for a
      memory disk is to access the contents of an
      <acronym>ISO</acronym> file system without the overhead of first
      burning it to a <acronym>CD</acronym> or <acronym>DVD</acronym>,
      then mounting the <acronym>CD/DVD</acronym> media.</para>

    <para xml:lang="en">In FreeBSD, the  <citerefentry><refentrytitle>md</refentrytitle><manvolnum>4</manvolnum></citerefentry> driver is used to provide support
      for memory disks.  The <filename>GENERIC</filename> kernel
      includes this driver.  When using a custom kernel configuration
      file, ensure it includes this line:</para>

    <programlisting xml:lang="en">device md</programlisting>

    <sect2 xml:id="disks-mdconfig">
      <title>連接與解除連接既有的映象檔</title>

      <indexterm xml:lang="en">
	<primary>disks</primary>
	<secondary>memory</secondary>
      </indexterm>

      <para xml:lang="en">To mount an existing file system image, use
	<command>mdconfig</command> to specify the name of the
	<acronym>ISO</acronym> file and a free unit number.  Then,
	refer to that unit number to mount it on an existing mount
	point.  Once mounted, the files in the <acronym>ISO</acronym>
	will appear in the mount point.  This example attaches
	<replaceable>diskimage.iso</replaceable> to the memory device
	<filename>/dev/md0</filename> then mounts that memory device
	on <filename>/mnt</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mdconfig -f <replaceable>diskimage.iso</replaceable> -u <replaceable>0</replaceable></userinput>
<prompt>#</prompt> <userinput>mount -t cd9660 /dev/md<replaceable>0</replaceable> <replaceable>/mnt</replaceable></userinput></screen>

      <para xml:lang="en">Notice that <option>-t cd9660</option> was used to mount
	an ISO format.  If a unit number is not specified with
	<option>-u</option>, <command>mdconfig</command> will
	automatically allocate an unused memory device and output
	the name of the allocated unit, such as
	<filename>md4</filename>.  Refer to <citerefentry><refentrytitle>mdconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more
	details about this command and its options.</para>

      <indexterm xml:lang="en">
	<primary>disks</primary>
	<secondary>detaching a memory disk</secondary>
      </indexterm>

      <para xml:lang="en">When a memory disk is no longer in use, its resources
	should be released back to the system.  First, unmount the
	file system, then use <command>mdconfig</command> to detach
	the disk from the system and release its resources.  To
	continue this example:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>umount /mnt</userinput>
<prompt>#</prompt> <userinput>mdconfig -d -u <replaceable>0</replaceable></userinput></screen>

      <para xml:lang="en">To determine if any memory disks are still attached to the
	system, type <command>mdconfig -l</command>.</para>
    </sect2>

    <sect2 xml:id="disks-md-freebsd5">
      <title>建立以檔案或記憶體為基底的磁碟</title>

      <indexterm xml:lang="en">
	<primary>disks</primary>
	<secondary>memory file system</secondary>
      </indexterm>
      <para xml:lang="en">FreeBSD also supports memory disks where the storage to use
	is allocated from either a hard disk or an area of memory.
	The first method is commonly referred to as a file-backed file
	system and the second method as a memory-backed file system.
	Both types can be created using
	<command>mdconfig</command>.</para>

      <para xml:lang="en">To create a new memory-backed file system, specify a type
	of <literal>swap</literal> and the size of the memory disk to
	create.  Then, format the memory disk with a file system and
	mount as usual.  This example creates a 5M memory disk on unit
	<literal>1</literal>.  That memory disk is then formatted with
	the <acronym>UFS</acronym> file system before it is
	mounted:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mdconfig -a -t swap -s <replaceable>5</replaceable>m -u <replaceable>1</replaceable></userinput>
<prompt>#</prompt> <userinput>newfs -U md<replaceable>1</replaceable></userinput>
/dev/md1: 5.0MB (10240 sectors) block size 16384, fragment size 2048
        using 4 cylinder groups of 1.27MB, 81 blks, 192 inodes.
        with soft updates
super-block backups (for fsck -b #) at:
 160, 2752, 5344, 7936
<prompt>#</prompt> <userinput>mount /dev/md<replaceable>1</replaceable> <replaceable>/mnt</replaceable></userinput>
<prompt>#</prompt> <userinput>df <replaceable>/mnt</replaceable></userinput>
Filesystem 1K-blocks Used Avail Capacity  Mounted on
/dev/md1        4718    4  4338     0%    /mnt</screen>

      <para xml:lang="en">To create a new file-backed memory disk, first allocate an
	area of disk to use.  This example creates an empty 5MB file
	named <filename>newimage</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>dd if=/dev/zero of=<replaceable>newimage</replaceable> bs=1k count=<replaceable>5</replaceable>k</userinput>
5120+0 records in
5120+0 records out</screen>

      <para xml:lang="en">Next, attach that file to a memory disk, label the memory
	disk and format it with the <acronym>UFS</acronym> file
	system, mount the memory disk, and verify the size of the
	file-backed disk:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mdconfig -f <replaceable>newimage</replaceable> -u <replaceable>0</replaceable></userinput>
<prompt>#</prompt> <userinput>bsdlabel -w md<replaceable>0</replaceable> auto</userinput>
<prompt>#</prompt> <userinput>newfs -U md<replaceable>0</replaceable>a</userinput>
/dev/md0a: 5.0MB (10224 sectors) block size 16384, fragment size 2048
        using 4 cylinder groups of 1.25MB, 80 blks, 192 inodes.
super-block backups (for fsck -b #) at:
 160, 2720, 5280, 7840
<prompt>#</prompt> <userinput>mount /dev/md<replaceable>0</replaceable>a <replaceable>/mnt</replaceable></userinput>
<prompt>#</prompt> <userinput>df <replaceable>/mnt</replaceable></userinput>
Filesystem 1K-blocks Used Avail Capacity  Mounted on
/dev/md0a       4710    4  4330     0%    /mnt</screen>

      <para xml:lang="en">It takes several commands to create a file- or
	memory-backed file system using <command>mdconfig</command>.
	FreeBSD also comes with <command>mdmfs</command> which
	automatically configures a memory disk, formats it with the
	<acronym>UFS</acronym> file system, and mounts it.  For
	example, after creating <replaceable>newimage</replaceable>
	with <command>dd</command>, this one command is equivalent to
	running the <command>bsdlabel</command>,
	<command>newfs</command>, and <command>mount</command>
	commands shown above:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mdmfs -F <replaceable>newimage</replaceable> -s <replaceable>5</replaceable>m md<replaceable>0</replaceable> <replaceable>/mnt</replaceable></userinput></screen>

      <para xml:lang="en">To instead create a new memory-based memory disk with
	<command>mdmfs</command>, use this one command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mdmfs -s <replaceable>5</replaceable>m md<replaceable>1</replaceable> <replaceable>/mnt</replaceable></userinput></screen>

      <para xml:lang="en">If the unit number is not specified,
	<command>mdmfs</command> will automatically select an unused
	memory device.  For more details about
	<command>mdmfs</command>, refer to <citerefentry><refentrytitle>mdmfs</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="snapshots">
    <info>
      <title>檔案系統快照</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>file systems</primary>
      <secondary>snapshots</secondary>
    </indexterm>

    <para xml:lang="en">FreeBSD offers a feature in conjunction with
      <link linkend="soft-updates">Soft Updates</link>: file system
      snapshots.</para>

    <para xml:lang="en">UFS snapshots allow a user to create images of specified
      file systems, and treat them as a file.  Snapshot files must be
      created in the file system that the action is performed on, and
      a user may create no more than 20 snapshots per file system.
      Active snapshots are recorded in the superblock so they are
      persistent across unmount and remount operations along with
      system reboots.  When a snapshot is no longer required, it can
      be removed using <citerefentry><refentrytitle>rm</refentrytitle><manvolnum>1</manvolnum></citerefentry>.  While snapshots may be removed in
      any order, all the used space may not be acquired because
      another snapshot will possibly claim some of the released
      blocks.</para>

    <para xml:lang="en">The un-alterable <option>snapshot</option> file flag is set
      by <citerefentry><refentrytitle>mksnap_ffs</refentrytitle><manvolnum>8</manvolnum></citerefentry> after initial creation of a snapshot file.
      <citerefentry><refentrytitle>unlink</refentrytitle><manvolnum>1</manvolnum></citerefentry> makes an exception for snapshot files since it
      allows them to be removed.</para>

    <para xml:lang="en">Snapshots are created using <citerefentry><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  To place a
      snapshot of <filename>/var</filename> in the
      file <filename>/var/snapshot/snap</filename>, use the following
      command:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>mount -u -o snapshot /var/snapshot/snap /var</userinput></screen>

    <para xml:lang="en">Alternatively, use <citerefentry><refentrytitle>mksnap_ffs</refentrytitle><manvolnum>8</manvolnum></citerefentry> to create the
      snapshot:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>mksnap_ffs /var /var/snapshot/snap</userinput></screen>

    <para xml:lang="en">One can find snapshot files on a file system, such as
      <filename>/var</filename>, using
      <citerefentry><refentrytitle>find</refentrytitle><manvolnum>1</manvolnum></citerefentry>:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>find /var -flags snapshot</userinput></screen>

    <para xml:lang="en">Once a snapshot has been created, it has several
      uses:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Some administrators will use a snapshot file for backup
	  purposes, because the snapshot can be transferred to
	  <acronym>CD</acronym>s or tape.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The file system integrity checker, <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry>, may be
	  run on the snapshot.  Assuming that the file system was
	  clean when it was mounted, this should always provide a
	  clean and unchanging result.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Running <citerefentry><refentrytitle>dump</refentrytitle><manvolnum>8</manvolnum></citerefentry> on the snapshot will produce a dump
	  file that is consistent with the file system and the
	  timestamp of the snapshot.  <citerefentry><refentrytitle>dump</refentrytitle><manvolnum>8</manvolnum></citerefentry> can also take a
	  snapshot, create a dump image, and then remove the snapshot
	  in one command by using <option>-L</option>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The snapshot can be mounted as a frozen image of the
	  file system.  To <citerefentry><refentrytitle>mount</refentrytitle><manvolnum>8</manvolnum></citerefentry> the snapshot
	  <filename>/var/snapshot/snap</filename> run:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mdconfig -a -t vnode -o readonly -f /var/snapshot/snap -u 4</userinput>
<prompt>#</prompt> <userinput>mount -r /dev/md4 /mnt</userinput></screen>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">The frozen <filename>/var</filename> is now available
      through <filename>/mnt</filename>.  Everything will initially be
      in the same state it was during the snapshot creation time.  The
      only exception is that any earlier snapshots will appear as zero
      length files.  To unmount the snapshot, use:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>umount /mnt</userinput>
<prompt>#</prompt> <userinput>mdconfig -d -u 4</userinput></screen>

    <para xml:lang="en">For more information about <option>softupdates</option> and
      file system snapshots, including technical papers, visit
      Marshall Kirk McKusick's website at <uri xlink:href="http://www.mckusick.com/">http://www.mckusick.com/</uri>.</para>
  </sect1>

  <sect1 xml:id="quotas">
    <title>磁碟配額</title>

    <indexterm xml:lang="en">
      <primary>accounting</primary>
      <secondary>disk space</secondary>
    </indexterm>
    <indexterm xml:lang="en"><primary>disk quotas</primary></indexterm>

    <para>磁碟配額可以用來限制使用者或群組成員能夠在各別檔案系統上使用的磁碟空間量或檔案數量。這個可避免一個使用者或群組成員耗盡所有磁碟的可用空間。</para>

    <para>本節將說明如何設定 <acronym>UFS</acronym> 檔案系統的磁碟配額。要在 <acronym>ZFS</acronym> 檔案系統上設定配額，請參考 <xref linkend="zfs-zfs-quota"/></para>

    <sect2>
      <title>開啟磁碟配額</title>

      <para>查看 FreeBSD 核心是否支援磁碟配額：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>sysctl kern.features.ufs_quota</userinput>
kern.features.ufs_quota: 1</screen>

      <para>在本例中，數值 <literal>1</literal> 代表支援磁碟配額，若為 <literal>0</literal>，則需加入下列設定到自訂核心設定檔然後依照 <xref linkend="kernelconfig"/> 的指示重新編譯核心：</para>

      <programlisting xml:lang="en">options QUOTA</programlisting>

      <para>接著，在 <filename>/etc/rc.conf</filename> 開啟磁碟配額：</para>

      <programlisting xml:lang="en">quota_enable="YES"</programlisting>

      <indexterm xml:lang="en">
	<primary>disk quotas</primary>
	<secondary>checking</secondary>
      </indexterm>
      <para>正常在開機時，會使用 <citerefentry><refentrytitle>quotacheck</refentrytitle><manvolnum>8</manvolnum></citerefentry> 檢查每個檔案系統的配額完整性，這個程式會確保在配額資料庫中的資料正確的反映了檔案系統上的資料。這是一個耗費時間的程序，會明顯的影響系統開機的時間，要跳過這個步驟可以加入此變數到 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">check_quotas="NO"</programlisting>

      <para>最後，編輯 <filename>/etc/fstab</filename> 來開啟在各個檔案系統上的磁碟配額。要開啟在檔案系統上對每個使用者的配額要加入 <option>userquota</option> 選項到  <filename>/etc/fstab</filename> 要開啟配額的檔案系統的項目中。例如：</para>

      <programlisting xml:lang="en">/dev/da1s2g   /home    ufs rw,userquota 1 2</programlisting>

      <para>要開啟群組配額，則使用 <option>groupquota</option>。要同時開啟使用者及群組配額，可使用逗號隔開選項：</para>

      <programlisting xml:lang="en">/dev/da1s2g    /home    ufs rw,userquota,groupquota 1 2</programlisting>

      <para>預設配額檔案會儲存在檔案系統的根目錄的 <filename>quota.user</filename> 及 <filename>quota.group</filename>，請參考 <citerefentry><refentrytitle>fstab</refentrytitle><manvolnum>5</manvolnum></citerefentry> 來取得更多資訊，較不建議指定其他位置來儲存配額檔案。</para>

      <para>設定完成之後，重新啟動系統，<filename>/etc/rc</filename> 會自動執行適當的指令對所有在 <filename>/etc/fstab</filename> 中開啟配磁的檔案系統建立初始的配額檔。</para>

      <para>在一般的操作中，並不需要手動執行 <citerefentry><refentrytitle>quotacheck</refentrytitle><manvolnum>8</manvolnum></citerefentry>, <citerefentry><refentrytitle>quotaon</refentrytitle><manvolnum>8</manvolnum></citerefentry> 或是 <citerefentry><refentrytitle>quotaoff</refentrytitle><manvolnum>8</manvolnum></citerefentry>，雖然如此，仍應閱讀這些指令的操作手冊來熟悉這些指令的操作。</para>
    </sect2>

    <sect2>
      <title>設定配額限制</title>

      <indexterm xml:lang="en">
	<primary>disk quotas</primary>
	<secondary>limits</secondary>
      </indexterm>

      <para>要確認配額已經開啟，可執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>quota -v</userinput></screen>

      <para>每個有開啟配額的檔案系統應該會有一行磁碟用量及目前配額限制的摘要。</para>

      <para>現在系統已準備好可以使用 <command>edquota</command> 分配配額限制。</para>

      <para>有數個選項可以強制限制使用者或群組對磁碟空間的使用量以及可以建立多少檔案。可以用磁碟空間 (block 配額)，檔案數量 (inode 配額) 或同時使用來分配。每種限制又可進一步細分為兩個類型：硬性 (Hard) 及軟性 (Soft) 限制。</para>

      <indexterm xml:lang="en"><primary>hard limit</primary></indexterm>
      <para>硬性限制無法被超額使用。一旦使用者超出了硬性限制，該使用者在該檔案系統將無法再使用任何空間。舉例來說，若一個使用者在一個檔案系統上有 500 KB 的硬性限制，且目前已經使用了  490 KB，該使用者只能再使用 10 KB 的空間，若嘗試使用 11 KB 的空間將會失敗。</para>

      <indexterm xml:lang="en"><primary>soft limit</primary></indexterm>
      <para>軟性限制在有限的時間內可以被超額使用，即為寬限期 (Grace period)，預設為一週。若一個使用者超出限制並超過寬限期，則軟性限制將轉為硬性限制並且將不允許再使用空間。當使用者使用的空間回到低於軟性限制內，寬限期就會被重置。</para>

      <para>在下面的例子中，會編輯 <systemitem class="username">test</systemitem> 的配額。當執行 <command>edquota</command> 時，將會使用 <envar>EDITOR</envar> 指定的編輯器來編輯配額限制。預設的編輯器為 <application>vi</application>。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>edquota -u test</userinput>
Quotas for user test:
/usr: kbytes in use: 65, limits (soft = 50, hard = 75)
        inodes in use: 7, limits (soft = 50, hard = 60)
/usr/var: kbytes in use: 0, limits (soft = 50, hard = 75)
        inodes in use: 0, limits (soft = 50, hard = 60)</screen>

      <para>正常每個開啟配額的檔案系統會有兩行需要設定，一行代表區塊限制 (Block limit) 而另一行代表節點限制 (inode limit)，更改行內的值來修改配額限制。舉例來說，要在 <filename>/usr</filename> 提高區塊的軟性限制到 <literal>500</literal> 以及硬性限制到 <literal>600</literal>，可更改行內的值如下：</para>

      <programlisting xml:lang="en">/usr: kbytes in use: 65, limits (soft = 500, hard = 600)</programlisting>

      <para>新的配額限制將在離開編輯器後生效。</para>

      <para>有時會想要針對一群使用者設定配額限，這時可以透過指定想要的配額給第一個使用者，若然後使用 <option>-p</option> 來複製配額到指定範圍的使用者 ID  (<acronym>UID</acronym>)。以下指定將複製配額限制給 <acronym>UID</acronym> <literal>10,000</literal> 到 <literal>19,999</literal> 的使用者：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>edquota -p test 10000-19999</userinput></screen>

      <para>要取得更多資訊，請參考 <citerefentry><refentrytitle>edquota</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</para>
    </sect2>

    <sect2>
      <title>檢查配額限制與磁碟使用狀況</title>

      <indexterm xml:lang="en">
	<primary>disk quotas</primary>
	<secondary>checking</secondary>
      </indexterm>

      <para>要檢查各別使用者或群組的配額與磁碟用量可使用 <citerefentry><refentrytitle>quota</refentrytitle><manvolnum>1</manvolnum></citerefentry>。使用者僅可查看自己的配額以及所屬群組的配額，只有使超級使用者可以檢視所有使用者及群組的配額。要取得某個有開啟配額的檔案系統的所有配額及磁碟用量摘要，可使用 <citerefentry><refentrytitle>repquota</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</para>

      <para>正常情況，使用者未使用任何磁碟空間的檔案系統並不會顯示在 <command>quota</command> 的輸出結果中，即使該使用者有在該檔案系統設定配額限制，使用 <option>-v</option> 可以顯示這些檔案系統。以下是使用使用 <command>quota -v</command> 查詢某個使用者在兩個檔案系統上的配額限制的範例輸出。</para>

      <programlisting xml:lang="en">Disk quotas for user test (uid 1002):
     Filesystem  usage    quota   limit   grace   files   quota   limit   grace
           /usr      65*     50      75   5days       7      50      60
       /usr/var       0      50      75               0      50      60</programlisting>

      <indexterm xml:lang="en"><primary>grace period</primary></indexterm>

      <para>在這個例子當中，使用者在 <filename>/usr</filename> 的軟性限制 50 KB 已經超出了 15 KB 並已經過了 5 天寬限期。星號 <literal>*</literal> 代表該使用者目前已超出配額限制。</para>
    </sect2>

    <sect2>
      <title>NFS 上的配額</title>

      <indexterm xml:lang="en"><primary>NFS</primary></indexterm>

      <para>在 <acronym>NFS</acronym> 伺服器上，配額會由配額子系統強制執行，<citerefentry><refentrytitle>rpc.rquotad</refentrytitle><manvolnum>8</manvolnum></citerefentry> Daemon 會提供配額資訊給 <acronym>NFS</acronym> 客戶端的 <command>quota</command>，讓在那些主機的使用者可以查看它們的配額統計資訊。</para>

      <para>在 <acronym>NFS</acronym> 伺服器上將 <filename>/etc/inetd.conf</filename> 中 <command>rpc.rquotad</command> 行前的 <literal>#</literal> 移除來開啟：</para>

      <programlisting xml:lang="en">rquotad/1      dgram rpc/udp wait root /usr/libexec/rpc.rquotad rpc.rquotad</programlisting>

      <para>然後重新啟動 <command>inetd</command>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service inetd restart</userinput></screen>
    </sect2>
  </sect1>

  <sect1 xml:id="disks-encrypting">
    <info>
      <title>磁碟分割區加密</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Lucky</firstname>
	    <surname>Green</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	  <affiliation>
	    <address xml:lang="en">
	      <email>shamrock@cypherpunks.to</email>
	    </address>
	  </affiliation>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>disks</primary>
      <secondary>encrypting</secondary>
    </indexterm>

    <para xml:lang="en">FreeBSD offers excellent online protections against
      unauthorized data access.  File permissions and <link linkend="mac">Mandatory Access Control</link> (MAC) help
      prevent unauthorized users from accessing data while the
      operating system is active and the computer is powered up.
      However, the permissions enforced by the operating system are
      irrelevant if an attacker has physical access to a computer and
      can move the computer's hard drive to another system to copy and
      analyze the data.</para>

    <para xml:lang="en">Regardless of how an attacker may have come into possession
      of a hard drive or powered-down computer, the
      <acronym>GEOM</acronym>-based cryptographic subsystems built
      into FreeBSD are able to protect the data on the computer's file
      systems against even highly-motivated attackers with significant
      resources.  Unlike encryption methods that encrypt individual
      files, the built-in <command>gbde</command> and
      <command>geli</command> utilities can be used to transparently
      encrypt entire file systems.  No cleartext ever touches the hard
      drive's platter.</para>

    <para xml:lang="en">This chapter demonstrates how to create an encrypted file
      system on FreeBSD.  It first demonstrates the process using
      <command>gbde</command> and then demonstrates the same example
      using <command>geli</command>.</para>

    <sect2>
      <title>使用 <application>gbde</application> 做磁碟加密</title>

      <para xml:lang="en">The objective of the <citerefentry><refentrytitle>gbde</refentrytitle><manvolnum>4</manvolnum></citerefentry> facility is to provide a
	formidable challenge for an attacker to gain access to the
	contents of a <emphasis>cold</emphasis> storage device.
	However, if the computer is compromised while up and running
	and the storage device is actively attached, or the attacker
	has access to a valid passphrase, it offers no protection to
	the contents of the storage device.  Thus, it is important to
	provide physical security while the system is running and to
	protect the passphrase used by the encryption
	mechanism.</para>

      <para xml:lang="en">This facility provides several barriers to protect the
	data stored in each disk sector.  It encrypts the contents of
	a disk sector using 128-bit <acronym>AES</acronym> in
	<acronym>CBC</acronym> mode.  Each sector on the disk is
	encrypted with a different <acronym>AES</acronym> key.  For
	more information on the cryptographic design, including how
	the sector keys are derived from the user-supplied passphrase,
	refer to <citerefentry><refentrytitle>gbde</refentrytitle><manvolnum>4</manvolnum></citerefentry>.</para>

      <para xml:lang="en">FreeBSD provides a kernel module for
	<application>gbde</application> which can be loaded with this
	command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload geom_bde</userinput></screen>

      <para xml:lang="en">If using a custom kernel configuration file, ensure it
	contains this line:</para>

      <para xml:lang="en"><literal>options GEOM_BDE</literal></para>

      <para xml:lang="en">The following example demonstrates adding a new hard drive
	to a system that will hold a single encrypted partition that
	will be mounted as <filename>/private</filename>.</para>

      <procedure>
	<title xml:lang="en">Encrypting a Partition with
	  <application>gbde</application></title>

	<step>
	  <title xml:lang="en">Add the New Hard Drive</title>

	  <para xml:lang="en">Install the new drive to the system as explained in
	    <xref linkend="disks-adding"/>.  For the purposes of this
	    example, a new hard drive partition has been added as
	    <filename>/dev/ad4s1c</filename> and
	    <filename>/dev/ad0s1<replaceable>*</replaceable></filename>
	    represents the existing standard FreeBSD partitions.</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ls /dev/ad*</userinput>
/dev/ad0        /dev/ad0s1b     /dev/ad0s1e     /dev/ad4s1
/dev/ad0s1      /dev/ad0s1c     /dev/ad0s1f     /dev/ad4s1c
/dev/ad0s1a     /dev/ad0s1d     /dev/ad4</screen>
	</step>

	<step>
	  <title xml:lang="en">Create a Directory to Hold <command>gbde</command>
	    Lock Files</title>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /etc/gbde</userinput></screen>

	  <para xml:lang="en">The <application>gbde</application> lock file
	    contains information that <application>gbde</application>
	    requires to access encrypted partitions.  Without access
	    to the lock file, <application>gbde</application> will not
	    be able to decrypt the data contained in the encrypted
	    partition without significant manual intervention which is
	    not supported by the software.  Each encrypted partition
	    uses a separate lock file.</para>
	</step>

	<step>
	  <title xml:lang="en">Initialize the <command>gbde</command>
	    Partition</title>

	  <para xml:lang="en">A <application>gbde</application> partition must be
	    initialized before it can be used.  This initialization
	    needs to be performed only once.  This command will open
	    the default editor, in order to set various configuration
	    options in a template.  For use with the
	    <acronym>UFS</acronym> file system, set the sector_size to
	    2048:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>gbde init /dev/ad4s1c -i -L /etc/gbde/ad4s1c.lock</userinput>
# <phrase its:translate="no">$FreeBSD$</phrase>
#
# Sector size is the smallest unit of data which can be read or written.
# Making it too small decreases performance and decreases available space.
# Making it too large may prevent filesystems from working.  512 is the
# minimum and always safe.  For UFS, use the fragment size
#
sector_size	=	2048
[...]</screen>

	  <para xml:lang="en">Once the edit is saved, the user will be asked twice
	    to type the passphrase used to secure the data.  The
	    passphrase must be the same both times.  The ability of
	    <application>gbde</application> to protect data depends
	    entirely on the quality of the passphrase.  For tips on
	    how to select a secure passphrase that is easy to
	    remember, see <link xlink:href="http://world.std.com/~reinhold/diceware.html">http://world.std.com/~reinhold/diceware.htm</link>.</para>

	  <para xml:lang="en">This initialization creates a lock file for the
	    <application>gbde</application> partition.  In this
	    example, it is stored as
	    <filename>/etc/gbde/ad4s1c.lock</filename>.  Lock files
	    must end in <quote>.lock</quote> in order to be correctly
	    detected by the <filename>/etc/rc.d/gbde</filename> start
	    up script.</para>

	  <caution>
	    <para xml:lang="en">Lock files <emphasis>must</emphasis> be backed up
	      together with the contents of any encrypted partitions.
	      Without the lock file, the legitimate owner will be
	      unable to access the data on the encrypted
	      partition.</para>
	  </caution>
	</step>

	<step>
	  <title xml:lang="en">Attach the Encrypted Partition to the
	    Kernel</title>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>gbde attach /dev/ad4s1c -l /etc/gbde/ad4s1c.lock</userinput></screen>

	  <para xml:lang="en">This command will prompt to input the passphrase that
	    was selected during the initialization of the encrypted
	    partition.  The new encrypted device will appear in
	    <filename>/dev</filename> as
	    <filename>/dev/device_name.bde</filename>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ls /dev/ad*</userinput>
/dev/ad0        /dev/ad0s1b     /dev/ad0s1e     /dev/ad4s1
/dev/ad0s1      /dev/ad0s1c     /dev/ad0s1f     /dev/ad4s1c
/dev/ad0s1a     /dev/ad0s1d     /dev/ad4        /dev/ad4s1c.bde</screen>
	</step>

	<step>
	  <title xml:lang="en">Create a File System on the Encrypted
	    Device</title>

	  <para xml:lang="en">Once the encrypted device has been attached to the
	    kernel, a file system can be created on the device.  This
	    example creates a <acronym>UFS</acronym> file system with
	    soft updates enabled.  Be sure to specify the partition
	    which has a
	    <filename><replaceable>*</replaceable>.bde</filename>
	    extension:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>newfs -U /dev/ad4s1c.bde</userinput></screen>
	</step>

	<step>
	  <title xml:lang="en">Mount the Encrypted Partition</title>

	  <para xml:lang="en">Create a mount point and mount the encrypted file
	    system:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /private</userinput>
<prompt>#</prompt> <userinput>mount /dev/ad4s1c.bde /private</userinput></screen>
	</step>

	<step>
	  <title xml:lang="en">Verify That the Encrypted File System is
	    Available</title>

	  <para xml:lang="en">The encrypted file system should now be visible and
	    available for use:</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>df -H</userinput>
Filesystem        Size   Used  Avail Capacity  Mounted on
/dev/ad0s1a      1037M    72M   883M     8%    /
/devfs            1.0K   1.0K     0B   100%    /dev
/dev/ad0s1f       8.1G    55K   7.5G     0%    /home
/dev/ad0s1e      1037M   1.1M   953M     0%    /tmp
/dev/ad0s1d       6.1G   1.9G   3.7G    35%    /usr
/dev/ad4s1c.bde   150G   4.1K   138G     0%    /private</screen>
	</step>
      </procedure>

      <para xml:lang="en">After each boot, any encrypted file systems must be
	manually re-attached to the kernel, checked for errors, and
	mounted, before the file systems can be used.  To configure
	these steps, add the following lines to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">gbde_autoattach_all="YES"
gbde_devices="<replaceable>ad4s1c</replaceable>"
gbde_lockdir="/etc/gbde"</programlisting>

      <para xml:lang="en">This requires that the passphrase be entered at the
	console at boot time.  After typing the correct passphrase,
	the encrypted partition will be mounted automatically.
	Additional <application>gbde</application> boot options are
	available and listed in <citerefentry><refentrytitle>rc.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

<!--
What about bsdinstall?
-->
      <note>
	<para xml:lang="en"><application>sysinstall</application> is incompatible
	  with <application>gbde</application>-encrypted devices.  All
	  <filename>*.bde</filename> devices must be detached from the
	  kernel before starting <application>sysinstall</application>
	  or it will crash during its initial probing for devices.  To
	  detach the encrypted device used in the example, use the
	  following command:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>gbde detach /dev/<replaceable>ad4s1c</replaceable></userinput></screen>
      </note>
    </sect2>

    <sect2 xml:id="disks-encrypting-geli">
      <info>
	<title>使用 <command>geli</command> 做磁碟加密</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Daniel</firstname>
	      <surname>Gerzo</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para xml:lang="en">An alternative cryptographic <acronym>GEOM</acronym> class
	is available using <command>geli</command>.  This control
	utility adds some features and uses a different scheme for
	doing cryptographic work.  It provides the following
	features:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Utilizes the <citerefentry><refentrytitle>crypto</refentrytitle><manvolnum>9</manvolnum></citerefentry> framework and
	    automatically uses cryptographic hardware when it is
	    available.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Supports multiple cryptographic algorithms such as
	    <acronym>AES</acronym>, Blowfish, and
	    <acronym>3DES</acronym>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Allows the root partition to be encrypted.  The
	    passphrase used to access the encrypted root partition
	    will be requested during system boot.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Allows the use of two independent keys.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">It is fast as it performs simple sector-to-sector
	    encryption.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Allows backup and restore of master keys.  If a user
	    destroys their keys, it is still possible to get access to
	    the data by restoring keys from the backup.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Allows a disk to attach with a random, one-time key
	    which is useful for swap partitions and temporary file
	    systems.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">More features and usage examples can be found in
	<citerefentry><refentrytitle>geli</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

      <para xml:lang="en">The following example describes how to generate a key file
	which will be used as part of the master key for the encrypted
	provider mounted under <filename>/private</filename>.  The key
	file will provide some random data used to encrypt the master
	key.  The master key will also be protected by a passphrase.
	The provider's sector size will be 4kB.  The example describes
	how to attach to the <command>geli</command> provider, create
	a file system on it, mount it, work with it, and finally, how
	to detach it.</para>

      <procedure>
	<title xml:lang="en">Encrypting a Partition with
	  <command>geli</command></title>

	<step>
	  <title xml:lang="en">Load <command>geli</command> Support</title>

	  <para xml:lang="en">Support for <command>geli</command> is available as a
	    loadable kernel module.  To configure the system to
	    automatically load the module at boot time, add the
	    following line to
	    <filename>/boot/loader.conf</filename>:</para>

	  <programlisting xml:lang="en">geom_eli_load="YES"</programlisting>

	  <para xml:lang="en">To load the kernel module now:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload geom_eli</userinput></screen>

	  <para xml:lang="en">For a custom kernel, ensure the kernel configuration
	    file contains these lines:</para>

	  <programlisting xml:lang="en">options GEOM_ELI
device crypto</programlisting>
	</step>

	<step>
	  <title xml:lang="en">Generate the Master Key</title>

	  <para xml:lang="en">The following commands generate a master key
	    (<filename>/root/da2.key</filename>) that is protected
	    with a passphrase.  The data source for the key file is
	    <filename>/dev/random</filename> and the sector size of
	    the provider (<filename>/dev/da2.eli</filename>) is 4kB as
	    a bigger sector size provides better performance:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>dd if=/dev/random of=/root/da2.key bs=64 count=1</userinput>
<prompt>#</prompt> <userinput>geli init -s 4096 -K /root/da2.key /dev/da2</userinput>
Enter new passphrase:
Reenter new passphrase:</screen>

	  <para xml:lang="en">It is not mandatory to use both a passphrase and a key
	    file as either method of securing the master key can be
	    used in isolation.</para>

	  <para xml:lang="en">If the key file is given as <quote>-</quote>, standard
	    input will be used.  For example, this command generates
	    three key files:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>cat keyfile1 keyfile2 keyfile3 | geli init -K - /dev/da2</userinput></screen>
	</step>

	<step>
	  <title xml:lang="en">Attach the Provider with the Generated Key</title>

	  <para xml:lang="en">To attach the provider, specify the key file, the name
	    of the disk, and the passphrase:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>geli attach -k /root/da2.key /dev/da2</userinput>
Enter passphrase:</screen>

	  <para xml:lang="en">This creates a new device with an
	    <filename>.eli</filename> extension:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ls /dev/da2*</userinput>
/dev/da2  /dev/da2.eli</screen>
	</step>

	<step>
	  <title xml:lang="en">Create the New File System</title>

	  <para xml:lang="en">Next, format the device with the
	    <acronym>UFS</acronym> file system and mount it on an
	    existing mount point:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>dd if=/dev/random of=/dev/da2.eli bs=1m</userinput>
<prompt>#</prompt> <userinput>newfs /dev/da2.eli</userinput>
<prompt>#</prompt> <userinput>mount /dev/da2.eli <replaceable>/private</replaceable></userinput></screen>

	  <para xml:lang="en">The encrypted file system should now be available for
	    use:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>df -H</userinput>
Filesystem     Size   Used  Avail Capacity  Mounted on
/dev/ad0s1a    248M    89M   139M    38%    /
/devfs         1.0K   1.0K     0B   100%    /dev
/dev/ad0s1f    7.7G   2.3G   4.9G    32%    /usr
/dev/ad0s1d    989M   1.5M   909M     0%    /tmp
/dev/ad0s1e    3.9G   1.3G   2.3G    35%    /var
/dev/da2.eli   150G   4.1K   138G     0%    /private</screen>
	</step>
      </procedure>

      <para xml:lang="en">Once the work on the encrypted partition is done, and the
	<filename>/private</filename> partition is no longer needed,
	it is prudent to put the device into cold storage by
	unmounting and detaching the <command>geli</command> encrypted
	partition from the kernel:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>umount /private</userinput>
<prompt>#</prompt> <userinput>geli detach da2.eli</userinput></screen>

      <para xml:lang="en">A <filename>rc.d</filename> script is provided to
	simplify the mounting of <command>geli</command>-encrypted
	devices at boot time.  For this example, add these lines to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">geli_devices="<replaceable>da2</replaceable>"
geli_da2_flags="-k /root/<replaceable>da2.key</replaceable>"</programlisting>

      <para xml:lang="en">This configures <filename>/dev/da2</filename> as a
	<command>geli</command> provider with a master key of
	<filename>/root/da2.key</filename>.  The system will
	automatically detach the provider from the kernel before the
	system shuts down.  During the startup process, the script
	will prompt for the passphrase before attaching the provider.
	Other kernel messages might be shown before and after the
	password prompt.  If the boot process seems to stall, look
	carefully for the password prompt among the other messages.
	Once the correct passphrase is entered, the provider is
	attached.  The file system is then mounted, typically by an
	entry in <filename>/etc/fstab</filename>.  Refer to <xref linkend="mount-unmount"/> for instructions on how to
	configure a file system to mount at boot time.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="swap-encrypting">
    <info>
      <title>交換空間加密</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Christian</firstname>
	    <surname>Brueffer</surname>
	  </personname>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>swap</primary>
      <secondary>encrypting</secondary>
    </indexterm>

    <para xml:lang="en">Like the encryption of disk partitions, encryption of swap
      space is used to protect sensitive information.  Consider an
      application that deals with passwords.  As long as these
      passwords stay in physical memory, they are not written to disk
      and will be cleared after a reboot.  However, if FreeBSD starts
      swapping out memory pages to free space, the passwords may be
      written to the disk unencrypted.  Encrypting swap space can be a
      solution for this scenario.</para>

    <para xml:lang="en">This section demonstrates how to configure an encrypted
      swap partition using <citerefentry><refentrytitle>gbde</refentrytitle><manvolnum>8</manvolnum></citerefentry> or <citerefentry><refentrytitle>geli</refentrytitle><manvolnum>8</manvolnum></citerefentry> encryption.
      It assumes that
      <filename>/dev/ada0s1b</filename> is the swap partition.</para>

    <sect2>
      <title>設定已加密的交換空間</title>

      <para xml:lang="en">Swap partitions are not encrypted by default and should be
	cleared of any sensitive data before continuing.  To overwrite
	the current swap partition with random garbage, execute the
	following command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>dd if=/dev/random of=/dev/<replaceable>ada0s1b</replaceable> bs=1m</userinput></screen>

      <para xml:lang="en">To encrypt the swap partition using <citerefentry><refentrytitle>gbde</refentrytitle><manvolnum>8</manvolnum></citerefentry>, add the
	<literal>.bde</literal> suffix to the swap line in
	<filename>/etc/fstab</filename>:</para>

      <programlisting xml:lang="en"># Device		Mountpoint	FStype	Options		Dump	Pass#
/dev/ada0s1b.bde	none		swap	sw		0	0</programlisting>

      <para xml:lang="en">To instead encrypt the swap partition using <citerefentry><refentrytitle>geli</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
	use the
	<literal>.eli</literal> suffix:</para>

      <programlisting xml:lang="en"># Device		Mountpoint	FStype	Options		Dump	Pass#
/dev/ada0s1b.eli	none		swap	sw		0	0</programlisting>

      <para xml:lang="en">By default, <citerefentry><refentrytitle>geli</refentrytitle><manvolnum>8</manvolnum></citerefentry> uses the <acronym>AES</acronym>
	algorithm with a key length of 128 bits.  Normally the default
	settings will suffice.  If desired, these defaults can be
	altered in the options field in
	<filename>/etc/fstab</filename>.  The possible flags
	are:</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">aalgo</term>
	  <listitem>
	    <para xml:lang="en">Data integrity verification algorithm used to ensure
	      that the encrypted data has not been tampered with.  See
	      <citerefentry><refentrytitle>geli</refentrytitle><manvolnum>8</manvolnum></citerefentry> for a list of supported algorithms.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">ealgo</term>
	  <listitem>
	    <para xml:lang="en">Encryption algorithm used to protect the data.  See
	      <citerefentry><refentrytitle>geli</refentrytitle><manvolnum>8</manvolnum></citerefentry> for a list of supported algorithms.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">keylen</term>
	  <listitem>
	    <para xml:lang="en">The length of the key used for the encryption
	      algorithm.  See <citerefentry><refentrytitle>geli</refentrytitle><manvolnum>8</manvolnum></citerefentry> for the key lengths that
	      are supported by each encryption algorithm.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">sectorsize</term>
	  <listitem>
	    <para xml:lang="en">The size of the blocks data is broken into before
	      it is encrypted.  Larger sector sizes increase
	      performance at the cost of higher storage
	      overhead.  The recommended size is 4096 bytes.</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para xml:lang="en">This example configures an encrypted swap partition using
	the Blowfish algorithm with a key length of 128 bits and a
	sectorsize of 4 kilobytes:</para>

      <programlisting xml:lang="en"># Device		Mountpoint	FStype	Options				Dump	Pass#
/dev/ada0s1b.eli	none		swap	sw,ealgo=blowfish,keylen=128,sectorsize=4096	0	0</programlisting>

    </sect2>

    <sect2>
      <title>加密的交換空間檢驗</title>

      <para xml:lang="en">Once the system has rebooted, proper operation of the
	encrypted swap can be verified using
	<command>swapinfo</command>.</para>

      <para xml:lang="en">If <citerefentry><refentrytitle>gbde</refentrytitle><manvolnum>8</manvolnum></citerefentry> is being used:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>swapinfo</userinput>
Device          1K-blocks     Used    Avail Capacity
/dev/ada0s1b.bde   542720        0   542720     0%</screen>

      <para xml:lang="en">If <citerefentry><refentrytitle>geli</refentrytitle><manvolnum>8</manvolnum></citerefentry> is being used:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>swapinfo</userinput>
Device          1K-blocks     Used    Avail Capacity
/dev/ada0s1b.eli   542720        0   542720     0%</screen>
    </sect2>
  </sect1>

  <sect1 xml:id="disks-hast">
    <info>
      <title>高可用存儲空間 (<acronym>HAST</acronym>)</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Daniel</firstname>
	    <surname>Gerzo</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Freddie</firstname>
	    <surname>Cash</surname>
	  </personname>
	  <contrib>With inputs from </contrib>
	</author>

	<author xml:lang="en">
	  <personname>
	    <firstname>Pawel Jakub</firstname>
	    <surname>Dawidek</surname>
	  </personname>
	</author>

	<author xml:lang="en">
	  <personname>
	    <firstname>Michael W.</firstname>
	    <surname>Lucas</surname>
	  </personname>
	</author>

	<author xml:lang="en">
	  <personname>
	    <firstname>Viktor</firstname>
	    <surname>Petersson</surname>
	  </personname>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>HAST</primary>
      <secondary>high availability</secondary>
    </indexterm>

    <para xml:lang="en">High availability is one of the main requirements in
      serious business applications and highly-available storage is a
      key component in such environments.  In FreeBSD, the Highly
      Available STorage (<acronym>HAST</acronym>) framework allows
      transparent storage of the same data across several physically
      separated machines connected by a <acronym>TCP/IP</acronym>
      network.  <acronym>HAST</acronym> can be understood as a
      network-based RAID1 (mirror), and is similar to the DRBD®
      storage system used in the GNU/<trademark class="registered">Linux</trademark> platform.  In combination
      with other high-availability features of FreeBSD like
      <acronym>CARP</acronym>, <acronym>HAST</acronym> makes it
      possible to build a highly-available storage cluster that is
      resistant to hardware failures.</para>

    <para xml:lang="en">The following are the main features of
      <acronym>HAST</acronym>:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Can be used to mask <acronym>I/O</acronym> errors on
	  local hard drives.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">File system agnostic as it works with any file system
	  supported by FreeBSD.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Efficient and quick resynchronization as only the blocks
	  that were modified during the downtime of a node are
	  synchronized.</para>
      </listitem>

      <!--
      <listitem>
	<para>Has several synchronization modes to allow for fast
	  failover.</para>
      </listitem>
      -->

      <listitem>
	<para xml:lang="en">Can be used in an already deployed environment to add
	  additional redundancy.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Together with <acronym>CARP</acronym>,
	  <application>Heartbeat</application>, or other tools, it can
	  be used to build a robust and durable storage system.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">After reading this section, you will know:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">What <acronym>HAST</acronym> is, how it works, and
	  which features it provides.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to set up and use <acronym>HAST</acronym> on
	  FreeBSD.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to integrate <acronym>CARP</acronym> and
	  <citerefentry><refentrytitle>devd</refentrytitle><manvolnum>8</manvolnum></citerefentry> to build a robust storage system.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">Before reading this section, you should:</para>

    <itemizedlist>
      <listitem>
	<para>了解 <trademark class="registered">UNIX</trademark> 及 FreeBSD 基礎 (<xref linkend="basics"/>)。</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Know how to configure network
	  interfaces and other core FreeBSD subsystems (<xref linkend="config-tuning"/>).</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Have a good understanding of FreeBSD
	  networking (<xref linkend="network-communication"/>).</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">The <acronym>HAST</acronym> project was sponsored by The
      FreeBSD Foundation with support from <link xlink:href="http://www.omc.net/">http://www.omc.net/</link>
      and <link xlink:href="http://www.transip.nl/">http://www.transip.nl/</link>.</para>

    <sect2>
      <title>HAST 運作模式</title>

      <para xml:lang="en"><acronym>HAST</acronym> provides synchronous block-level
	replication between two physical machines: the
	<emphasis>primary</emphasis>, also known as the
	<emphasis>master</emphasis> node, and the
	<emphasis>secondary</emphasis>, or <emphasis>slave</emphasis>
	node.  These two machines together are referred to as a
	cluster.</para>

      <para xml:lang="en">Since <acronym>HAST</acronym> works in a primary-secondary
	configuration, it allows only one of the cluster nodes to be
	active at any given time.  The primary node, also called
	<emphasis>active</emphasis>, is the one which will handle all
	the <acronym>I/O</acronym> requests to
	<acronym>HAST</acronym>-managed devices.  The secondary node
	is automatically synchronized from the primary node.</para>

      <para xml:lang="en">The physical components of the <acronym>HAST</acronym>
	system are the local disk on primary node, and the disk on the
	remote, secondary node.</para>

      <para xml:lang="en"><acronym>HAST</acronym> operates synchronously on a block
	level, making it transparent to file systems and applications.
	<acronym>HAST</acronym> provides regular GEOM providers in
	<filename>/dev/hast/</filename> for use by other tools or
	applications.  There is no difference between using
	<acronym>HAST</acronym>-provided devices and raw disks or
	partitions.</para>

      <para xml:lang="en">Each write, delete, or flush operation is sent to both the
	local disk and to the remote disk over
	<acronym>TCP/IP</acronym>.  Each read operation is served from
	the local disk, unless the local disk is not up-to-date or an
	<acronym>I/O</acronym> error occurs.  In such cases, the read
	operation is sent to the secondary node.</para>

      <para xml:lang="en"><acronym>HAST</acronym> tries to provide fast failure
	recovery.  For this reason, it is important to reduce
	synchronization time after a node's outage.  To provide fast
	synchronization, <acronym>HAST</acronym> manages an on-disk
	bitmap of dirty extents and only synchronizes those during a
	regular synchronization, with an exception of the initial
	sync.</para>

      <para xml:lang="en">There are many ways to handle synchronization.
	<acronym>HAST</acronym> implements several replication modes
	to handle different synchronization methods:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><emphasis>memsync</emphasis>: This mode reports a
	    write operation as completed when the local write
	    operation is finished and when the remote node
	    acknowledges data arrival, but before actually storing the
	    data.  The data on the remote node will be stored directly
	    after sending the acknowledgement.  This mode is intended
	    to reduce latency, but still provides good reliability.
	    This mode is the default.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><emphasis>fullsync</emphasis>: This mode reports a
	    write operation as completed when both the local write and
	    the remote write complete.  This is the safest and the
	    slowest replication mode.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><emphasis>async</emphasis>: This mode reports a write
	    operation as completed when the local write completes.
	    This is the fastest and the most dangerous replication
	    mode.  It should only be used when replicating to a
	    distant node where latency is too high for other
	    modes.</para>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2>
      <title>HAST 設定</title>

      <para xml:lang="en">The <acronym>HAST</acronym> framework consists of several
	components:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">The <citerefentry><refentrytitle>hastd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon which provides data
	    synchronization.  When this daemon is started, it will
	    automatically load <varname>geom_gate.ko</varname>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The userland management utility,
	    <citerefentry><refentrytitle>hastctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <citerefentry><refentrytitle>hast.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> configuration file.  This file
	    must exist before starting
	    <application>hastd</application>.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">Users who prefer to statically build
	<literal>GEOM_GATE</literal> support into the kernel should
	add this line to the custom kernel configuration file, then
	rebuild the kernel using the instructions in <xref linkend="kernelconfig"/>:</para>

      <programlisting xml:lang="en">options	GEOM_GATE</programlisting>

      <para xml:lang="en">The following example describes how to configure two nodes
	in master-slave/primary-secondary operation using
	<acronym>HAST</acronym> to replicate the data between the two.
	The nodes will be called <literal>hasta</literal>, with an
	<acronym>IP</acronym> address of
	<literal>172.16.0.1</literal>, and <literal>hastb</literal>,
	with an <acronym>IP</acronym> address of
	<literal>172.16.0.2</literal>.  Both nodes will have a
	dedicated hard drive <filename>/dev/ad6</filename> of the same
	size for <acronym>HAST</acronym> operation.  The
	<acronym>HAST</acronym> pool, sometimes referred to as a
	resource or the <acronym>GEOM</acronym> provider in <filename>/dev/hast/</filename>, will be called
	<literal>test</literal>.</para>

      <para xml:lang="en">Configuration of <acronym>HAST</acronym> is done using
	<filename>/etc/hast.conf</filename>.  This file should be
	identical on both nodes.  The simplest configuration
	is:</para>

      <programlisting xml:lang="en">resource <replaceable>test</replaceable> {
	on <replaceable>hasta</replaceable> {
		local <replaceable>/dev/ad6</replaceable>
		remote <replaceable>172.16.0.2</replaceable>
	}
	on <replaceable>hastb</replaceable> {
		local <replaceable>/dev/ad6</replaceable>
		remote <replaceable>172.16.0.1</replaceable>
	}
}</programlisting>

      <para xml:lang="en">For more advanced configuration, refer to
	<citerefentry><refentrytitle>hast.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

      <tip>
	<para xml:lang="en">It is also possible to use host names in the
	  <literal>remote</literal> statements if the hosts are
	  resolvable and defined either in
	  <filename>/etc/hosts</filename> or in the local
	  <acronym>DNS</acronym>.</para>
      </tip>

      <para xml:lang="en">Once the configuration exists on both nodes, the
	<acronym>HAST</acronym> pool can be created.  Run these
	commands on both nodes to place the initial metadata onto the
	local disk and to start <citerefentry><refentrytitle>hastd</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>hastctl create <replaceable>test</replaceable></userinput>
<prompt>#</prompt> <userinput>service hastd onestart</userinput></screen>

      <note>
	<para xml:lang="en">It is <emphasis>not</emphasis> possible to use
	  <acronym>GEOM</acronym>
	  providers with an existing file system or to convert an
	  existing storage to a <acronym>HAST</acronym>-managed pool.
	  This procedure needs to store some metadata on the provider
	  and there will not be enough required space available on an
	  existing provider.</para>
      </note>

      <para xml:lang="en">A HAST node's <literal>primary</literal> or
	<literal>secondary</literal> role is selected by an
	administrator, or software like
	<application>Heartbeat</application>, using <citerefentry><refentrytitle>hastctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.
	On the primary node, <literal>hasta</literal>, issue this
	command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>hastctl role primary <replaceable>test</replaceable></userinput></screen>

      <para xml:lang="en">Run this command on the secondary node,
	<literal>hastb</literal>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>hastctl role secondary <replaceable>test</replaceable></userinput></screen>

      <para xml:lang="en">Verify the result by running <command>hastctl</command> on
	each node:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>hastctl status <replaceable>test</replaceable></userinput></screen>

      <para xml:lang="en">Check the <literal>status</literal> line in the output.
	If it says <literal>degraded</literal>, something is wrong
	with the configuration file.  It should say
	<literal>complete</literal> on each node, meaning that the
	synchronization between the nodes has started.  The
	synchronization completes when <command>hastctl
	  status</command> reports 0 bytes of <literal>dirty</literal>
	extents.</para>

      <para xml:lang="en">The next step is to create a file system on the
	<acronym>GEOM</acronym> provider and mount it.  This must be
	done on the <literal>primary</literal> node.  Creating the
	file system can take a few minutes, depending on the size of
	the hard drive.  This example creates a <acronym>UFS</acronym>
	file system on <filename>/dev/hast/test</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>newfs -U /dev/hast/<replaceable>test</replaceable></userinput>
<prompt>#</prompt> <userinput>mkdir /hast/<replaceable>test</replaceable></userinput>
<prompt>#</prompt> <userinput>mount /dev/hast/<replaceable>test</replaceable> <replaceable>/hast/test</replaceable></userinput></screen>

      <para xml:lang="en">Once the <acronym>HAST</acronym> framework is configured
	properly, the final step is to make sure that
	<acronym>HAST</acronym> is started automatically during
	system boot.  Add this line to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">hastd_enable="YES"</programlisting>

      <sect3>
	<title>容錯移轉設定</title>

	<para xml:lang="en">The goal of this example is to build a robust storage
	  system which is resistant to the failure of any given node.
	  If the primary node fails, the secondary node is there to
	  take over seamlessly, check and mount the file system, and
	  continue to work without missing a single bit of
	  data.</para>

	<para xml:lang="en">To accomplish this task, the Common Address Redundancy
	  Protocol (<acronym>CARP</acronym>) is used to provide for
	  automatic failover at the <acronym>IP</acronym> layer.
	  <acronym>CARP</acronym> allows multiple hosts on the same
	  network segment to share an <acronym>IP</acronym> address.
	  Set up <acronym>CARP</acronym> on both nodes of the cluster
	  according to the documentation available in <xref linkend="carp"/>.  In this example, each node will have
	  its own management <acronym>IP</acronym> address and a
	  shared <acronym>IP</acronym> address of
	  <replaceable>172.16.0.254</replaceable>.  The primary
	  <acronym>HAST</acronym> node of the cluster must be the
	  master <acronym>CARP</acronym> node.</para>

	<para xml:lang="en">The <acronym>HAST</acronym> pool created in the previous
	  section is now ready to be exported to the other hosts on
	  the network.  This can be accomplished by exporting it
	  through <acronym>NFS</acronym> or
	  <application>Samba</application>, using the shared
	  <acronym>IP</acronym> address
	  <replaceable>172.16.0.254</replaceable>.  The only problem
	  which remains unresolved is an automatic failover should the
	  primary node fail.</para>

	<para xml:lang="en">In the event of <acronym>CARP</acronym> interfaces going
	  up or down, the FreeBSD operating system generates a
	  <citerefentry><refentrytitle>devd</refentrytitle><manvolnum>8</manvolnum></citerefentry> event, making it possible to watch for state
	  changes on the <acronym>CARP</acronym> interfaces.  A state
	  change on the <acronym>CARP</acronym> interface is an
	  indication that one of the nodes failed or came back online.
	  These state change events make it possible to run a script
	  which will automatically handle the HAST failover.</para>

	<para xml:lang="en">To catch state changes on the
	  <acronym>CARP</acronym> interfaces, add this configuration
	  to <filename>/etc/devd.conf</filename> on each node:</para>

	<programlisting xml:lang="en">notify 30 {
	match "system" "IFNET";
	match "subsystem" "carp0";
	match "type" "LINK_UP";
	action "/usr/local/sbin/carp-hast-switch master";
};

notify 30 {
	match "system" "IFNET";
	match "subsystem" "carp0";
	match "type" "LINK_DOWN";
	action "/usr/local/sbin/carp-hast-switch slave";
};</programlisting>

	<note>
	  <para xml:lang="en">If the systems are running FreeBSD 10 or higher,
	    replace <filename>carp0</filename> with the name of the
	    <acronym>CARP</acronym>-configured interface.</para>
	</note>

	<para xml:lang="en">Restart <citerefentry><refentrytitle>devd</refentrytitle><manvolnum>8</manvolnum></citerefentry> on both nodes to put the new
	  configuration into effect:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service devd restart</userinput></screen>

	<para xml:lang="en">When the specified interface state changes by going up
	  or down , the system generates a notification, allowing the
	  <citerefentry><refentrytitle>devd</refentrytitle><manvolnum>8</manvolnum></citerefentry> subsystem to run the specified automatic
	  failover script,
	  <filename>/usr/local/sbin/carp-hast-switch</filename>.
	  For further clarification about this configuration, refer to
	  <citerefentry><refentrytitle>devd.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

	<para xml:lang="en">Here is an example of an automated failover
	  script:</para>

	<programlisting xml:lang="en">#!/bin/sh

# Original script by Freddie Cash &lt;fjwcash@gmail.com&gt;
# Modified by Michael W. Lucas &lt;mwlucas@BlackHelicopters.org&gt;
# and Viktor Petersson &lt;vpetersson@wireload.net&gt;

# The names of the HAST resources, as listed in /etc/hast.conf
resources="<replaceable>test</replaceable>"

# delay in mounting HAST resource after becoming master
# make your best guess
delay=3

# logging
log="local0.debug"
name="carp-hast"

# end of user configurable stuff

case "$1" in
	master)
		logger -p $log -t $name "Switching to primary provider for ${resources}."
		sleep ${delay}

		# Wait for any "hastd secondary" processes to stop
		for disk in ${resources}; do
			while $( pgrep -lf "hastd: ${disk} \(secondary\)" &gt; /dev/null 2&gt;&amp;1 ); do
				sleep 1
			done

			# Switch role for each disk
			hastctl role primary ${disk}
			if [ $? -ne 0 ]; then
				logger -p $log -t $name "Unable to change role to primary for resource ${disk}."
				exit 1
			fi
		done

		# Wait for the /dev/hast/* devices to appear
		for disk in ${resources}; do
			for I in $( jot 60 ); do
				[ -c "/dev/hast/${disk}" ] &amp;&amp; break
				sleep 0.5
			done

			if [ ! -c "/dev/hast/${disk}" ]; then
				logger -p $log -t $name "GEOM provider /dev/hast/${disk} did not appear."
				exit 1
			fi
		done

		logger -p $log -t $name "Role for HAST resources ${resources} switched to primary."


		logger -p $log -t $name "Mounting disks."
		for disk in ${resources}; do
			mkdir -p /hast/${disk}
			fsck -p -y -t ufs /dev/hast/${disk}
			mount /dev/hast/${disk} /hast/${disk}
		done

	;;

	slave)
		logger -p $log -t $name "Switching to secondary provider for ${resources}."

		# Switch roles for the HAST resources
		for disk in ${resources}; do
			if ! mount | grep -q "^/dev/hast/${disk} on "
			then
			else
				umount -f /hast/${disk}
			fi
			sleep $delay
			hastctl role secondary ${disk} 2&gt;&amp;1
			if [ $? -ne 0 ]; then
				logger -p $log -t $name "Unable to switch role to secondary for resource ${disk}."
				exit 1
			fi
			logger -p $log -t $name "Role switched to secondary for resource ${disk}."
		done
	;;
esac</programlisting>

	<para xml:lang="en">In a nutshell, the script takes these actions when a
	  node becomes master:</para>

	<itemizedlist>
	  <listitem>
	    <para xml:lang="en">Promotes the <acronym>HAST</acronym> pool to
	      primary on the other node.</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">Checks the file system under the
	      <acronym>HAST</acronym> pool.</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">Mounts the pool.</para>
	  </listitem>
	</itemizedlist>

	<para xml:lang="en">When a node becomes secondary:</para>

	<itemizedlist>
	  <listitem>
	    <para xml:lang="en">Unmounts the <acronym>HAST</acronym> pool.</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">Degrades the <acronym>HAST</acronym> pool to
	      secondary.</para>
	  </listitem>
	</itemizedlist>

	<caution>
	  <para xml:lang="en">This is just an example script which serves as a proof
	    of concept.  It does not handle all the possible scenarios
	    and can be extended or altered in any way, for example, to
	    start or stop required services.</para>
	</caution>

	<tip>
	  <para xml:lang="en">For this example, a standard <acronym>UFS</acronym>
	    file system was used.  To reduce the time needed for
	    recovery, a journal-enabled <acronym>UFS</acronym> or
	    <acronym>ZFS</acronym> file system can be used
	    instead.</para>
	</tip>

	<para xml:lang="en">More detailed information with additional examples can
	  be found at <link xlink:href="http://wiki.FreeBSD.org/HAST">http://wiki.FreeBSD.org/HAST</link>.</para>
      </sect3>
    </sect2>

    <sect2>
      <title>疑難排解</title>

      <para xml:lang="en"><acronym>HAST</acronym> should generally work without
	issues.  However, as with any other software product, there
	may be times when it does not work as supposed.  The sources
	of the problems may be different, but the rule of thumb is to
	ensure that the time is synchronized between the nodes of the
	cluster.</para>

      <para xml:lang="en">When troubleshooting <acronym>HAST</acronym>, the
	debugging level of <citerefentry><refentrytitle>hastd</refentrytitle><manvolnum>8</manvolnum></citerefentry> should be increased by
	starting <command>hastd</command> with <literal>-d</literal>.
	This argument may be specified multiple times to further
	increase the debugging level.  Consider also using
	<literal>-F</literal>, which starts <command>hastd</command>
	in the foreground.</para>

      <sect3 xml:id="disks-hast-sb">
	<title>自 Split-brain 情況復原</title>

	<para xml:lang="en"><firstterm>Split-brain</firstterm> occurs when the nodes
	  of the cluster are unable to communicate with each other,
	  and both are configured as primary.  This is a dangerous
	  condition because it allows both nodes to make incompatible
	  changes to the data.  This problem must be corrected
	  manually by the system administrator.</para>

	<para xml:lang="en">The administrator must either decide which node has more
	  important changes, or perform the merge manually.  Then, let
	  <acronym>HAST</acronym> perform full synchronization of the
	  node which has the broken data.  To do this, issue these
	  commands on the node which needs to be
	  resynchronized:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>hastctl role init <replaceable>test</replaceable></userinput>
<prompt>#</prompt> <userinput>hastctl create <replaceable>test</replaceable></userinput>
<prompt>#</prompt> <userinput>hastctl role secondary <replaceable>test</replaceable></userinput></screen>
      </sect3>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project
     $FreeBSD$

-->
<chapter version="5.0" xml:id="geom">

  <info>
    <title>GEOM: 模組化磁碟轉換框架</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	</personname>
	<contrib>Written by </contrib>
      </author>
    </authorgroup>
  </info>

  <sect1 xml:id="geom-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en">
      <primary><acronym>GEOM</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><acronym>GEOM</acronym> Disk Framework</primary>
      <see><acronym>GEOM</acronym></see>
    </indexterm>

    <para>在 FreeBSD 中，<acronym>GEOM</acronym> 可允許對類別做存取與控制，例如：主開機記錄 (Master Boot Record) 與 <acronym>BSD</acronym> 標籤，透過利用提供者，或在 <filename>/dev</filename> 中的磁碟裝置。透過支援各種 <acronym>RAID</acronym> 的配置，<acronym>GEOM</acronym> 透明的提供了對作業系統與作業系統工具的存取。</para>

    <para xml:lang="en">This chapter covers the use of disks under the
      <acronym>GEOM</acronym> framework in FreeBSD.  This includes the
      major <acronym>RAID</acronym> control utilities which use the
      framework for configuration.  This chapter is not a definitive
      guide to <acronym>RAID</acronym> configurations and only
      <acronym>GEOM</acronym>-supported <acronym>RAID</acronym>
      classifications are discussed.</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">What type of <acronym>RAID</acronym> support is
	  available through <acronym>GEOM</acronym>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to use the base utilities to configure, maintain,
	  and manipulate the various <acronym>RAID</acronym>
	  levels.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to mirror, stripe, encrypt, and remotely connect
	  disk devices through <acronym>GEOM</acronym>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to troubleshoot disks attached to the
	  <acronym>GEOM</acronym> framework.</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Understand how FreeBSD treats disk devices (<xref linkend="disks"/>).</para>
      </listitem>

      <listitem>
	<para>了解如何設定並安裝新的核心 (<xref linkend="kernelconfig"/>)。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="geom-striping">
    <info>
      <title>RAID0 - 串連 (Striping)</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Written by </contrib>
	</author>

	<author xml:lang="en">
	  <personname>
	    <firstname>Murray</firstname>
	    <surname>Stokely</surname>
	  </personname>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary><acronym>GEOM</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>Striping</primary>
    </indexterm>

    <para>串連會合併數個磁碟成單一個磁碟區 (Volume)，可以透過使用硬體 <acronym>RAID</acronym> 控制器來做到串連。<acronym>GEOM</acronym> 磁碟子系統提供了軟體支援的磁碟串連，也就是所謂的 <acronym>RAID0</acronym>，而不需要 <acronym>RAID</acronym> 磁碟控制器。</para>

    <para>在 <acronym>RAID0</acronym> 中，資料會被切割成數個資料區塊 (Block) 寫入到磁碟陣列中的每一個磁碟機。如下圖所示，取代以往等候系統寫入 256k 到一個磁碟的時間， <acronym>RAID0</acronym> 可以同時寫入 64k 到磁碟陣列中四個磁碟的每個磁碟，這可提供優異的 <acronym>I/O</acronym> 效能，若使用多個磁碟控制器可增加更多的效能。</para>

    <mediaobject xml:lang="en">
      <imageobject>
	<imagedata fileref="geom/striping" align="center"/>
      </imageobject>

      <textobject>
	<phrase>Disk Striping Illustration</phrase>
      </textobject>
    </mediaobject>

    <para>在 <acronym>RAID0</acronym> 串連中的每個磁碟必須要相同大小，因為 <acronym>I/O</acronym> 的請求是平行交錯讀取或寫入到多個磁碟的。</para>

    <note>
      <para><acronym>RAID0</acronym> 並<emphasis>不</emphasis>提供任何備援 (Redundancy) 功能。這意謂著若磁碟陣列中的其中一個磁碟故障，所有在該磁碟上的資料便會遺失。若資料很重要，請規畫備份策略，定期儲存備份到遠端系統或裝置。</para>
    </note>

    <para xml:lang="en">The process for creating a software,
      <acronym>GEOM</acronym>-based <acronym>RAID0</acronym> on a FreeBSD
      system using commodity disks is as follows.  Once the stripe is
      created, refer to <citerefentry><refentrytitle>gstripe</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more information on how
      to control an existing stripe.</para>

    <procedure>
      <title xml:lang="en">Creating a Stripe of Unformatted <acronym>ATA</acronym>
	Disks</title>

      <step>
	<para xml:lang="en">Load the <filename>geom_stripe.ko</filename>
	  module:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>kldload geom_stripe</userinput></screen>
      </step>

      <step>
	<para xml:lang="en">Ensure that a suitable mount point exists.  If this
	  volume will become a root partition, then temporarily use
	  another mount point such as
	  <filename>/mnt</filename>.</para>
      </step>

      <step>
	<para xml:lang="en">Determine the device names for the disks which will
	  be striped, and create the new stripe device.  For example,
	  to stripe two unused and unpartitioned
	  <acronym>ATA</acronym> disks with device names of
	  <filename>/dev/ad2</filename> and
	  <filename>/dev/ad3</filename>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>gstripe label -v st0 /dev/ad2 /dev/ad3</userinput>
Metadata value stored on /dev/ad2.
Metadata value stored on /dev/ad3.
Done.</screen>
      </step>

      <step>
	<para xml:lang="en">Write a standard label, also known as a partition table,
	  on the new volume and install the default bootstrap
	  code:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>bsdlabel -wB /dev/stripe/st0</userinput></screen>
      </step>

      <step>
	<para xml:lang="en">This process should create two other devices in
	  <filename>/dev/stripe</filename> in addition to
	  <filename>st0</filename>.  Those include
	  <filename>st0a</filename> and <filename>st0c</filename>.  At
	  this point, a <acronym>UFS</acronym> file system can be
	  created on <filename>st0a</filename> using
	  <command>newfs</command>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>newfs -U /dev/stripe/st0a</userinput></screen>

	<para xml:lang="en">Many numbers will glide across the screen, and after a
	  few seconds, the process will be complete.  The volume has
	  been created and is ready to be mounted.</para>
      </step>

      <step>
	<para xml:lang="en">To manually mount the created disk stripe:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mount /dev/stripe/st0a /mnt</userinput></screen>
      </step>

      <step>
	<para xml:lang="en">To mount this striped file system automatically during
	  the boot process, place the volume information in
	  <filename>/etc/fstab</filename>.  In this example, a
	  permanent mount point, named <filename>stripe</filename>, is
	  created:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /stripe</userinput>
<prompt>#</prompt> <userinput>echo "/dev/stripe/st0a /stripe ufs rw 2 2" \</userinput>
<userinput>&gt;&gt; /etc/fstab</userinput></screen>
      </step>

      <step>
	<para xml:lang="en">The <filename>geom_stripe.ko</filename> module must also
	  be automatically loaded during system initialization, by
	  adding a line to
	  <filename>/boot/loader.conf</filename>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc -f /boot/loader.conf geom_stripe_load=YES</userinput></screen>
      </step>
    </procedure>
  </sect1>

  <sect1 xml:id="geom-mirror">
    <title>RAID1 - 鏡像 (Mirroring)</title>

    <indexterm xml:lang="en">
      <primary><acronym>GEOM</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>Disk Mirroring</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>RAID1</primary>
    </indexterm>

    <para><acronym>RAID1</acronym> 或<emphasis>鏡像</emphasis>是一項寫入相同資料到超過一個磁碟機的技術。鏡像通常用來保護資料因磁碟機故障導致的損失，每個在鏡像中的磁碟機會擁有完全相同的資料，當各別磁碟機故障時，鏡像會繼續運作，由還可運作的磁碟機提供資料。電腦會繼續執行，等到管理者有時間更換故障的硬碟，而不會被使用者中斷運作。</para>

    <para xml:lang="en">Two common situations are illustrated in these examples.
      The first creates a mirror out of two new drives and uses it as
      a replacement for an existing single drive.  The second example
      creates a mirror on a single new drive, copies the old drive's
      data to it, then inserts the old drive into the mirror.  While
      this procedure is slightly more complicated, it only requires
      one new drive.</para>

    <para xml:lang="en">Traditionally, the two drives in a mirror are identical in
      model and capacity, but <citerefentry><refentrytitle>gmirror</refentrytitle><manvolnum>8</manvolnum></citerefentry> does not require that.
      Mirrors created with dissimilar drives will have a capacity
      equal to that of the smallest drive in the mirror.  Extra space
      on larger drives will be unused.  Drives inserted into the
      mirror later must have at least as much capacity as the smallest
      drive already in the mirror.</para>

    <warning>
      <para xml:lang="en">The mirroring procedures shown here are non-destructive,
	but as with any major disk operation, make a full backup
	first.</para>
    </warning>

    <warning>
      <para xml:lang="en">While <citerefentry><refentrytitle>dump</refentrytitle><manvolnum>8</manvolnum></citerefentry> is used in these procedures
	to copy file systems, it does not work on file systems with
	soft updates journaling.  See <citerefentry><refentrytitle>tunefs</refentrytitle><manvolnum>8</manvolnum></citerefentry> for information
	on detecting and disabling soft updates journaling.</para>
    </warning>

    <sect2 xml:id="geom-mirror-metadata">
      <title>Metadata 問題</title>

      <para xml:lang="en">Many disk systems store metadata at the end of each disk.
	Old metadata should be erased before reusing the disk for a
	mirror.  Most problems are caused by two particular types of
	leftover metadata: <acronym>GPT</acronym> partition tables and
	old metadata from a previous mirror.</para>

      <para xml:lang="en"><acronym>GPT</acronym> metadata can be erased with
	<citerefentry><refentrytitle>gpart</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  This example erases both primary and backup
	<acronym>GPT</acronym> partition tables from disk
	<filename>ada8</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart destroy -F ada8</userinput></screen>

      <para xml:lang="en">A disk can be removed from an active mirror and the
	metadata erased in one step using <citerefentry><refentrytitle>gmirror</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  Here, the
	example disk <filename>ada8</filename> is removed from the
	active mirror <filename>gm4</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gmirror remove gm4 ada8</userinput></screen>

      <para xml:lang="en">If the mirror is not running, but old mirror metadata is
	still on the disk, use <command>gmirror clear</command> to
	remove it:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gmirror clear ada8</userinput></screen>

      <para xml:lang="en"><citerefentry><refentrytitle>gmirror</refentrytitle><manvolnum>8</manvolnum></citerefentry> stores one block of metadata at the end of
	the disk.  Because <acronym>GPT</acronym> partition schemes
	also store metadata at the end of the disk, mirroring entire
	<acronym>GPT</acronym> disks with <citerefentry><refentrytitle>gmirror</refentrytitle><manvolnum>8</manvolnum></citerefentry> is not
	recommended.  <acronym>MBR</acronym> partitioning is used here
	because it only stores a partition table at the start of the
	disk and does not conflict with the mirror metadata.</para>
    </sect2>

    <sect2 xml:id="geom-mirror-two-new-disks">
      <title>使用兩個新磁碟建立鏡像</title>

      <para xml:lang="en">In this example, FreeBSD has already been installed on a
	single disk, <filename>ada0</filename>.  Two new disks,
	<filename>ada1</filename> and <filename>ada2</filename>, have
	been connected to the system.  A new mirror will be created on
	these two disks and used to replace the old single
	disk.</para>

      <para xml:lang="en">The <filename>geom_mirror.ko</filename> kernel module must
	either be built into the kernel or loaded at boot- or
	run-time.  Manually load the kernel module now:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gmirror load</userinput></screen>

      <para xml:lang="en">Create the mirror with the two new drives:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gmirror label -v gm0 /dev/ada1 /dev/ada2</userinput></screen>

      <para xml:lang="en"><filename>gm0</filename> is a user-chosen device name
	assigned to the new mirror.  After the mirror has been
	started, this device name appears in
	<filename>/dev/mirror/</filename>.</para>

      <para xml:lang="en"><acronym>MBR</acronym> and
	<application>bsdlabel</application> partition tables can now
	be created on the mirror with <citerefentry><refentrytitle>gpart</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  This example
	uses a traditional file system layout, with partitions for
	<filename>/</filename>, swap, <filename>/var</filename>,
	<filename>/tmp</filename>, and <filename>/usr</filename>.  A
	single <filename>/</filename> and a swap partition
	will also work.</para>

      <para xml:lang="en">Partitions on the mirror do not have to be the same size
	as those on the existing disk, but they must be large enough
	to hold all the data already present on
	<filename>ada0</filename>.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart create -s MBR mirror/gm0</userinput>
<prompt>#</prompt> <userinput>gpart add -t freebsd -a 4k mirror/gm0</userinput>
<prompt>#</prompt> <userinput>gpart show mirror/gm0</userinput>
=&gt;       63  156301423  mirror/gm0  MBR  (74G)
         63         63                    - free -  (31k)
        126  156301299                 1  freebsd  (74G)
  156301425         61                    - free -  (30k)</screen>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart create -s BSD mirror/gm0s1</userinput>
<prompt>#</prompt> <userinput>gpart add -t freebsd-ufs  -a 4k -s 2g mirror/gm0s1</userinput>
<prompt>#</prompt> <userinput>gpart add -t freebsd-swap -a 4k -s 4g mirror/gm0s1</userinput>
<prompt>#</prompt> <userinput>gpart add -t freebsd-ufs  -a 4k -s 2g mirror/gm0s1</userinput>
<prompt>#</prompt> <userinput>gpart add -t freebsd-ufs  -a 4k -s 1g mirror/gm0s1</userinput>
<prompt>#</prompt> <userinput>gpart add -t freebsd-ufs  -a 4k       mirror/gm0s1</userinput>
<prompt>#</prompt> <userinput>gpart show mirror/gm0s1</userinput>
=&gt;        0  156301299  mirror/gm0s1  BSD  (74G)
          0          2                      - free -  (1.0k)
          2    4194304                   1  freebsd-ufs  (2.0G)
    4194306    8388608                   2  freebsd-swap  (4.0G)
   12582914    4194304                   4  freebsd-ufs  (2.0G)
   16777218    2097152                   5  freebsd-ufs  (1.0G)
   18874370  137426928                   6  freebsd-ufs  (65G)
  156301298          1                      - free -  (512B)</screen>

      <para xml:lang="en">Make the mirror bootable by installing bootcode in the
	<acronym>MBR</acronym> and bsdlabel and setting the active
	slice:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart bootcode -b /boot/mbr mirror/gm0</userinput>
<prompt>#</prompt> <userinput>gpart set -a active -i 1 mirror/gm0</userinput>
<prompt>#</prompt> <userinput>gpart bootcode -b /boot/boot mirror/gm0s1</userinput></screen>

      <para xml:lang="en">Format the file systems on the new mirror, enabling
	soft-updates.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>newfs -U /dev/mirror/gm0s1a</userinput>
<prompt>#</prompt> <userinput>newfs -U /dev/mirror/gm0s1d</userinput>
<prompt>#</prompt> <userinput>newfs -U /dev/mirror/gm0s1e</userinput>
<prompt>#</prompt> <userinput>newfs -U /dev/mirror/gm0s1f</userinput></screen>

      <para xml:lang="en">File systems from the original <filename>ada0</filename>
	disk can now be copied onto the mirror with <citerefentry><refentrytitle>dump</refentrytitle><manvolnum>8</manvolnum></citerefentry> and
	<citerefentry><refentrytitle>restore</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mount /dev/mirror/gm0s1a /mnt</userinput>
<prompt>#</prompt> <userinput>dump -C16 -b64 -0aL -f - / | (cd /mnt &amp;&amp; restore -rf -)</userinput>
<prompt>#</prompt> <userinput>mount /dev/mirror/gm0s1d /mnt/var</userinput>
<prompt>#</prompt> <userinput>mount /dev/mirror/gm0s1e /mnt/tmp</userinput>
<prompt>#</prompt> <userinput>mount /dev/mirror/gm0s1f /mnt/usr</userinput>
<prompt>#</prompt> <userinput>dump -C16 -b64 -0aL -f - /var | (cd /mnt/var &amp;&amp; restore -rf -)</userinput>
<prompt>#</prompt> <userinput>dump -C16 -b64 -0aL -f - /tmp | (cd /mnt/tmp &amp;&amp; restore -rf -)</userinput>
<prompt>#</prompt> <userinput>dump -C16 -b64 -0aL -f - /usr | (cd /mnt/usr &amp;&amp; restore -rf -)</userinput></screen>

      <para xml:lang="en">Edit <filename>/mnt/etc/fstab</filename> to point to
	the new mirror file systems:</para>

      <programlisting xml:lang="en"># Device		Mountpoint	FStype	Options	Dump	Pass#
/dev/mirror/gm0s1a	/		ufs	rw	1	1
/dev/mirror/gm0s1b	none		swap	sw	0	0
/dev/mirror/gm0s1d	/var		ufs	rw	2	2
/dev/mirror/gm0s1e	/tmp		ufs	rw	2	2
/dev/mirror/gm0s1f	/usr		ufs	rw	2	2</programlisting>

      <para xml:lang="en">If the <filename>geom_mirror.ko</filename> kernel module
	has not been built into the kernel,
	<filename>/mnt/boot/loader.conf</filename> is edited to load
	the module at boot:</para>

      <programlisting xml:lang="en">geom_mirror_load="YES"</programlisting>

      <para xml:lang="en">Reboot the system to test the new mirror and verify that
	all data has been copied.  The <acronym>BIOS</acronym> will
	see the mirror as two individual drives rather than a mirror.
	Because the drives are identical, it does not matter which is
	selected to boot.</para>

      <para xml:lang="en">See <xref linkend="gmirror-troubleshooting"/> if there are
	problems booting.  Powering down and disconnecting the
	original <filename>ada0</filename> disk will allow it to be
	kept as an offline backup.</para>

      <para xml:lang="en">In use, the mirror will behave just like the original
	single drive.</para>
    </sect2>

    <sect2 xml:id="geom-mirror-existing-drive">
      <title>使用既有磁碟建立鏡像</title>

      <para xml:lang="en">In this example, FreeBSD has already been installed on a
	single disk, <filename>ada0</filename>.  A new disk,
	<filename>ada1</filename>, has been connected to the system.
	A one-disk mirror will be created on the new disk, the
	existing system copied onto it, and then the old disk will be
	inserted into the mirror.  This slightly complex procedure is
	required because <command>gmirror</command> needs to put a
	512-byte block of metadata at the end of each disk, and the
	existing <filename>ada0</filename> has usually had all of its
	space already allocated.</para>

      <para xml:lang="en">Load the <filename>geom_mirror.ko</filename> kernel
	module:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gmirror load</userinput></screen>

      <para xml:lang="en">Check the media size of the original disk with
	<command>diskinfo</command>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>diskinfo -v ada0 | head -n3</userinput>
/dev/ada0
	512             # sectorsize
	1000204821504   # mediasize in bytes (931G)</screen>

      <para xml:lang="en">Create a mirror on the new disk.  To make certain that the
	mirror capacity is not any larger than the original
	<filename>ada0</filename> drive, <citerefentry><refentrytitle>gnop</refentrytitle><manvolnum>8</manvolnum></citerefentry> is used to
	create a fake drive of the exact same size.  This drive does
	not store any data, but is used only to limit the size of the
	mirror.  When <citerefentry><refentrytitle>gmirror</refentrytitle><manvolnum>8</manvolnum></citerefentry> creates the mirror, it will
	restrict the capacity to the size of
	<filename>gzero.nop</filename>, even if the new
	<filename>ada1</filename> drive has more space.  Note that the
	<replaceable>1000204821504</replaceable> in the second line is
	equal to <filename>ada0</filename>'s media size as shown by
	<command>diskinfo</command> above.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>geom zero load</userinput>
<prompt>#</prompt> <userinput>gnop create -s 1000204821504 gzero</userinput>
<prompt>#</prompt> <userinput>gmirror label -v gm0 gzero.nop ada1</userinput>
<prompt>#</prompt> <userinput>gmirror forget gm0</userinput></screen>

      <para xml:lang="en">Since <filename>gzero.nop</filename> does not store any
	data, the mirror does not see it as connected.  The mirror is
	told to <quote>forget</quote> unconnected components, removing
	references to <filename>gzero.nop</filename>.  The result is a
	mirror device containing only a single disk,
	<filename>ada1</filename>.</para>

      <para xml:lang="en">After creating <filename>gm0</filename>, view the
	partition table on <filename>ada0</filename>.  This output is
	from a 1 TB drive.  If there is some unallocated space at
	the end of the drive, the contents may be copied directly from
	<filename>ada0</filename> to the new mirror.</para>

      <para xml:lang="en">However, if the output shows that all of the space on the
	disk is allocated, as in the following listing, there is no
	space available for the 512-byte mirror metadata at the end of
	the disk.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart show ada0</userinput>
=&gt;        63  1953525105        ada0  MBR  (931G)
          63  1953525105           1  freebsd  [active]  (931G)</screen>

      <para xml:lang="en">In this case, the partition table must be edited to reduce
	the capacity by one sector on <filename>mirror/gm0</filename>.
	The procedure will be explained later.</para>

      <para xml:lang="en">In either case, partition tables on the primary disk
	should be first copied using <command>gpart backup</command>
	and <command>gpart restore</command>.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart backup ada0 &gt; table.ada0</userinput>
<prompt>#</prompt> <userinput>gpart backup ada0s1 &gt; table.ada0s1</userinput></screen>

      <para xml:lang="en">These commands create two files,
	<filename>table.ada0</filename> and
	<filename>table.ada0s1</filename>.  This example is from a
	1 TB drive:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cat table.ada0</userinput>
MBR 4
1 freebsd         63 1953525105   [active]</screen>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cat table.ada0s1</userinput>
BSD 8
1  freebsd-ufs          0    4194304
2 freebsd-swap    4194304   33554432
4  freebsd-ufs   37748736   50331648
5  freebsd-ufs   88080384   41943040
6  freebsd-ufs  130023424  838860800
7  freebsd-ufs  968884224  984640881</screen>

      <para xml:lang="en">If no free space is shown at the end of the disk, the size
	of both the slice and the last partition must be reduced by
	one sector.  Edit the two files, reducing the size of both the
	slice and last partition by one.  These are the last numbers
	in each listing.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cat table.ada0</userinput>
MBR 4
1 freebsd         63 <emphasis>1953525104</emphasis>   [active]</screen>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cat table.ada0s1</userinput>
BSD 8
1  freebsd-ufs          0    4194304
2 freebsd-swap    4194304   33554432
4  freebsd-ufs   37748736   50331648
5  freebsd-ufs   88080384   41943040
6  freebsd-ufs  130023424  838860800
7  freebsd-ufs  968884224  <emphasis>984640880</emphasis></screen>

      <para xml:lang="en">If at least one sector was unallocated at the end of the
	disk, these two files can be used without modification.</para>

      <para xml:lang="en">Now restore the partition table into
	<filename>mirror/gm0</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart restore mirror/gm0 &lt; table.ada0</userinput>
<prompt>#</prompt> <userinput>gpart restore mirror/gm0s1 &lt; table.ada0s1</userinput></screen>

      <para xml:lang="en">Check the partition table with
	<command>gpart show</command>.  This example has
	<filename>gm0s1a</filename> for <filename>/</filename>,
	<filename>gm0s1d</filename> for <filename>/var</filename>,
	<filename>gm0s1e</filename> for <filename>/usr</filename>,
	<filename>gm0s1f</filename> for <filename>/data1</filename>,
	and <filename>gm0s1g</filename> for
	<filename>/data2</filename>.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart show mirror/gm0</userinput>
=&gt;        63  1953525104  mirror/gm0  MBR  (931G)
          63  1953525042           1  freebsd  [active]  (931G)
  1953525105          62              - free -  (31k)

<prompt>#</prompt> <userinput>gpart show mirror/gm0s1</userinput>
=&gt;         0  1953525042  mirror/gm0s1  BSD  (931G)
           0     2097152             1  freebsd-ufs  (1.0G)
     2097152    16777216             2  freebsd-swap  (8.0G)
    18874368    41943040             4  freebsd-ufs  (20G)
    60817408    20971520             5  freebsd-ufs  (10G)
    81788928   629145600             6  freebsd-ufs  (300G)
   710934528  1242590514             7  freebsd-ufs  (592G)
  1953525042          63                - free -  (31k)</screen>

      <para xml:lang="en">Both the slice and the last partition must have at least
	one free block at the end of the disk.</para>

      <para xml:lang="en">Create file systems on these new partitions.  The number
	of partitions will vary to match the original disk,
	<filename>ada0</filename>.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>newfs -U /dev/mirror/gm0s1a</userinput>
<prompt>#</prompt> <userinput>newfs -U /dev/mirror/gm0s1d</userinput>
<prompt>#</prompt> <userinput>newfs -U /dev/mirror/gm0s1e</userinput>
<prompt>#</prompt> <userinput>newfs -U /dev/mirror/gm0s1f</userinput>
<prompt>#</prompt> <userinput>newfs -U /dev/mirror/gm0s1g</userinput></screen>

      <para xml:lang="en">Make the mirror bootable by installing bootcode in the
	<acronym>MBR</acronym> and bsdlabel and setting the active
	slice:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart bootcode -b /boot/mbr mirror/gm0</userinput>
<prompt>#</prompt> <userinput>gpart set -a active -i 1 mirror/gm0</userinput>
<prompt>#</prompt> <userinput>gpart bootcode -b /boot/boot mirror/gm0s1</userinput></screen>

      <para xml:lang="en">Adjust <filename>/etc/fstab</filename> to use the new
	partitions on the mirror.  Back up this file first by copying
	it to <filename>/etc/fstab.orig</filename>.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cp /etc/fstab /etc/fstab.orig</userinput></screen>

      <para xml:lang="en">Edit <filename>/etc/fstab</filename>, replacing
	<filename>/dev/ada0</filename> with
	<filename>mirror/gm0</filename>.</para>

      <programlisting xml:lang="en"># Device		Mountpoint	FStype	Options	Dump	Pass#
/dev/mirror/gm0s1a	/		ufs	rw	1	1
/dev/mirror/gm0s1b	none		swap	sw	0	0
/dev/mirror/gm0s1d	/var		ufs	rw	2	2
/dev/mirror/gm0s1e	/usr		ufs	rw	2	2
/dev/mirror/gm0s1f	/data1		ufs	rw	2	2
/dev/mirror/gm0s1g	/data2		ufs	rw	2	2</programlisting>

      <para xml:lang="en">If the <filename>geom_mirror.ko</filename> kernel module
	has not been built into the kernel, edit
	<filename>/boot/loader.conf</filename> to load it at
	boot:</para>

      <programlisting xml:lang="en">geom_mirror_load="YES"</programlisting>

      <para xml:lang="en">File systems from the original disk can now be copied onto
	the mirror with <citerefentry><refentrytitle>dump</refentrytitle><manvolnum>8</manvolnum></citerefentry> and <citerefentry><refentrytitle>restore</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  Each file
	system dumped with <command>dump -L</command> will create a
	snapshot first, which can take some time.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mount /dev/mirror/gm0s1a /mnt</userinput>
<prompt>#</prompt> <userinput>dump -C16 -b64 -0aL -f - /    | (cd /mnt &amp;&amp; restore -rf -)</userinput>
<prompt>#</prompt> <userinput>mount /dev/mirror/gm0s1d /mnt/var</userinput>
<prompt>#</prompt> <userinput>mount /dev/mirror/gm0s1e /mnt/usr</userinput>
<prompt>#</prompt> <userinput>mount /dev/mirror/gm0s1f /mnt/data1</userinput>
<prompt>#</prompt> <userinput>mount /dev/mirror/gm0s1g /mnt/data2</userinput>
<prompt>#</prompt> <userinput>dump -C16 -b64 -0aL -f - /usr | (cd /mnt/usr &amp;&amp; restore -rf -)</userinput>
<prompt>#</prompt> <userinput>dump -C16 -b64 -0aL -f - /var | (cd /mnt/var &amp;&amp; restore -rf -)</userinput>
<prompt>#</prompt> <userinput>dump -C16 -b64 -0aL -f - /data1 | (cd /mnt/data1 &amp;&amp; restore -rf -)</userinput>
<prompt>#</prompt> <userinput>dump -C16 -b64 -0aL -f - /data2 | (cd /mnt/data2 &amp;&amp; restore -rf -)</userinput></screen>

      <para xml:lang="en">Restart the system, booting from
	<filename>ada1</filename>.  If everything is working, the
	system will boot from <filename>mirror/gm0</filename>, which
	now contains the same data as <filename>ada0</filename> had
	previously.  See <xref linkend="gmirror-troubleshooting"/> if
	there are problems booting.</para>

      <para xml:lang="en">At this point, the mirror still consists of only the
	single <filename>ada1</filename> disk.</para>

      <para xml:lang="en">After booting from <filename>mirror/gm0</filename>
	successfully, the final step is inserting
	<filename>ada0</filename> into the mirror.</para>

      <important>
	<para xml:lang="en">When <filename>ada0</filename> is inserted into the
	  mirror, its former contents will be overwritten by data from
	  the mirror.  Make certain that
	  <filename>mirror/gm0</filename> has the same contents as
	  <filename>ada0</filename> before adding
	  <filename>ada0</filename> to the mirror.  If the contents
	  previously copied by <citerefentry><refentrytitle>dump</refentrytitle><manvolnum>8</manvolnum></citerefentry> and <citerefentry><refentrytitle>restore</refentrytitle><manvolnum>8</manvolnum></citerefentry> are
	  not identical to what was on <filename>ada0</filename>,
	  revert <filename>/etc/fstab</filename> to mount the file
	  systems on <filename>ada0</filename>, reboot, and start the
	  whole procedure again.</para>
      </important>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gmirror insert gm0 ada0</userinput>
GEOM_MIRROR: Device gm0: rebuilding provider ada0</screen>

      <para xml:lang="en">Synchronization between the two disks will start
	immediately.  Use <command>gmirror status</command> to view
	the progress.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gmirror status</userinput>
      Name    Status  Components
mirror/gm0  DEGRADED  ada1 (ACTIVE)
                      ada0 (SYNCHRONIZING, 64%)</screen>

      <para xml:lang="en">After a while, synchronization will finish.</para>

      <screen xml:lang="en">GEOM_MIRROR: Device gm0: rebuilding provider ada0 finished.
<prompt>#</prompt> <userinput>gmirror status</userinput>
      Name    Status  Components
mirror/gm0  COMPLETE  ada1 (ACTIVE)
                      ada0 (ACTIVE)</screen>

      <para xml:lang="en"><filename>mirror/gm0</filename> now consists
	of the two disks <filename>ada0</filename> and
	<filename>ada1</filename>, and the contents are automatically
	synchronized with each other.  In use,
	<filename>mirror/gm0</filename> will behave just like the
	original single drive.</para>
    </sect2>

    <sect2 xml:id="gmirror-troubleshooting">
      <title>疑難排解</title>

      <para xml:lang="en">If the system no longer boots, <acronym>BIOS</acronym>
	settings may have to be changed to boot from one of the new
	mirrored drives.  Either mirror drive can be used for booting,
	as they contain identical data.</para>

      <para xml:lang="en">If the boot stops with this message, something is wrong
	with the mirror device:</para>

      <screen xml:lang="en">Mounting from ufs:/dev/mirror/gm0s1a failed with error 19.

Loader variables:
  vfs.root.mountfrom=ufs:/dev/mirror/gm0s1a
  vfs.root.mountfrom.options=rw

Manual root filesystem specification:
  &lt;fstype&gt;:&lt;device&gt; [options]
      Mount &lt;device&gt; using filesystem &lt;fstype&gt;
      and with the specified (optional) option list.

    eg. ufs:/dev/da0s1a
        zfs:tank
        cd9660:/dev/acd0 ro
          (which is equivalent to: mount -t cd9660 -o ro /dev/acd0 /)

  ?               List valid disk boot devices
  .               Yield 1 second (for background tasks)
  &lt;empty line&gt;    Abort manual input

mountroot&gt;</screen>

      <para xml:lang="en">Forgetting to load the <filename>geom_mirror.ko</filename>
	module in <filename>/boot/loader.conf</filename> can cause
	this problem.  To fix it, boot from a FreeBSD
	installation media and choose <literal>Shell</literal> at the
	first prompt.  Then load the mirror module and mount the
	mirror device:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gmirror load</userinput>
<prompt>#</prompt> <userinput>mount /dev/mirror/gm0s1a /mnt</userinput></screen>

      <para xml:lang="en">Edit <filename>/mnt/boot/loader.conf</filename>, adding a
	line to load the mirror module:</para>

      <programlisting xml:lang="en">geom_mirror_load="YES"</programlisting>

      <para xml:lang="en">Save the file and reboot.</para>

      <para xml:lang="en">Other problems that cause <errorname>error 19</errorname>
	require more effort to fix.  Although the system should boot
	from <filename>ada0</filename>, another prompt to select a
	shell will appear if <filename>/etc/fstab</filename> is
	incorrect.  Enter <literal>ufs:/dev/ada0s1a</literal> at the
	boot loader prompt and press <keycap>Enter</keycap>.  Undo the
	edits in <filename>/etc/fstab</filename> then mount the file
	systems from the original disk (<filename>ada0</filename>)
	instead of the mirror.  Reboot the system and try the
	procedure again.</para>

      <screen xml:lang="en">Enter full pathname of shell or RETURN for /bin/sh:
<prompt>#</prompt> <userinput>cp /etc/fstab.orig /etc/fstab</userinput>
<prompt>#</prompt> <userinput>reboot</userinput></screen>
    </sect2>

    <sect2>
      <title>自磁碟故障復原</title>

      <para xml:lang="en">The benefit of disk mirroring is that an individual disk
	can fail without causing the mirror to lose any data.  In the
	above example, if <filename>ada0</filename> fails, the mirror
	will continue to work, providing data from the remaining
	working drive, <filename>ada1</filename>.</para>

      <para xml:lang="en">To replace the failed drive, shut down the system and
	physically replace the failed drive with a new drive of equal
	or greater capacity.  Manufacturers use somewhat arbitrary
	values when rating drives in gigabytes, and the only way to
	really be sure is to compare the total count of sectors shown
	by <command>diskinfo -v</command>.  A drive with larger
	capacity than the mirror will work, although the extra space
	on the new drive will not be used.</para>

      <para xml:lang="en">After the computer is powered back up, the mirror will be
	running in a <quote>degraded</quote> mode with only one drive.
	The mirror is told to forget drives that are not currently
	connected:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gmirror forget gm0</userinput></screen>

      <para xml:lang="en">Any old metadata should be cleared from the replacement
	disk using the instructions in
	<xref linkend="geom-mirror-metadata"/>.  Then the replacement
	disk, <filename>ada4</filename> for this example, is inserted
	into the mirror:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>gmirror insert gm0 /dev/ada4</userinput></screen>

      <para xml:lang="en">Resynchronization begins when the new drive is inserted
	into the mirror.  This process of copying mirror data to a new
	drive can take a while.  Performance of the mirror will be
	greatly reduced during the copy, so inserting new drives is
	best done when there is low demand on the computer.</para>

      <para xml:lang="en">Progress can be monitored with <command>gmirror
	  status</command>, which shows drives that are being
	synchronized and the percentage of completion.  During
	resynchronization, the status will be
	<computeroutput>DEGRADED</computeroutput>, changing to
	<computeroutput>COMPLETE</computeroutput> when the process is
	finished.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="geom-raid3">
    <info>

      <title><acronym>RAID</acronym>3 - 位元級串連與獨立奇偶校驗</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Mark</firstname>
	    <surname>Gladman</surname>
	  </personname>
	  <contrib>Written by </contrib>
	</author>

	<author xml:lang="en">
	  <personname>
	    <firstname>Daniel</firstname>
	    <surname>Gerzo</surname>
	  </personname>
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Based on documentation by </contrib>
	</author>

	<author xml:lang="en">
	  <personname>
	    <firstname>Murray</firstname>
	    <surname>Stokely</surname>
	  </personname>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary><acronym>GEOM</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>RAID3</primary>
    </indexterm>

    <para xml:lang="en"><acronym>RAID</acronym>3 is a method used to combine several
      disk drives into a single volume with a dedicated parity disk.
      In a <acronym>RAID</acronym>3 system, data is split up into a
      number of bytes that are written across all the drives in the
      array except for one disk which acts as a dedicated parity disk.
      This means that disk reads from a <acronym>RAID</acronym>3
      implementation access all disks in the array.  Performance can
      be enhanced by using multiple disk controllers.  The
      <acronym>RAID</acronym>3 array provides a fault tolerance of 1
      drive, while providing a capacity of 1 - 1/n times the total
      capacity of all drives in the array, where n is the number of
      hard drives in the array.  Such a configuration is mostly
      suitable for storing data of larger sizes such as multimedia
      files.</para>

    <para xml:lang="en">At least 3 physical hard drives are required to build a
      <acronym>RAID</acronym>3 array.  Each disk must be of the same
      size, since <acronym>I/O</acronym> requests are interleaved to
      read or write to multiple disks in parallel.  Also, due to the
      nature of <acronym>RAID</acronym>3, the number of drives must be
      equal to 3, 5, 9, 17, and so on, or 2^n + 1.</para>

    <para xml:lang="en">This section demonstrates how to create a software
      <acronym>RAID</acronym>3 on a FreeBSD system.</para>

    <note>
      <para xml:lang="en">While it is theoretically possible to boot from a
	<acronym>RAID</acronym>3 array on FreeBSD, that configuration is
	uncommon and is not advised.</para>
    </note>

    <sect2>
      <title>建立 Dedicated <acronym>RAID</acronym>3 陣列</title>

      <para xml:lang="en">In FreeBSD, support for <acronym>RAID</acronym>3 is
	implemented by the <citerefentry><refentrytitle>graid3</refentrytitle><manvolnum>8</manvolnum></citerefentry> <acronym>GEOM</acronym>
	class.  Creating a dedicated <acronym>RAID</acronym>3 array on
	FreeBSD requires the following steps.</para>

      <procedure>
	<step>
	  <para xml:lang="en">First, load the <filename>geom_raid3.ko</filename>
	    kernel module by issuing one of the following
	    commands:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>graid3 load</userinput></screen>

	  <para xml:lang="en">or:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload geom_raid3</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Ensure that a suitable mount point exists.  This
	    command creates a new directory to use as the mount
	    point:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir <replaceable>/multimedia</replaceable></userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Determine the device names for the disks which will be
	    added to the array, and create the new
	    <acronym>RAID</acronym>3 device.  The final device listed
	    will act as the dedicated parity disk.  This example uses
	    three unpartitioned <acronym>ATA</acronym> drives:
	    <filename><replaceable>ada1</replaceable></filename> and
	    <filename><replaceable>ada2</replaceable></filename> for
	    data, and
	    <filename><replaceable>ada3</replaceable></filename> for
	    parity.</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>graid3 label -v gr0 /dev/ada1 /dev/ada2 /dev/ada3</userinput>
Metadata value stored on /dev/ada1.
Metadata value stored on /dev/ada2.
Metadata value stored on /dev/ada3.
Done.</screen>
	</step>

	<step>
	  <para xml:lang="en">Partition the newly created <filename>gr0</filename>
	    device and put a <acronym>UFS</acronym> file system on
	    it:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>gpart create -s GPT /dev/raid3/gr0</userinput>
<prompt>#</prompt> <userinput>gpart add -t freebsd-ufs /dev/raid3/gr0</userinput>
<prompt>#</prompt> <userinput>newfs -j /dev/raid3/gr0p1</userinput></screen>

	  <para xml:lang="en">Many numbers will glide across the screen, and after a
	    bit of time, the process will be complete.  The volume has
	    been created and is ready to be mounted:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mount /dev/raid3/gr0p1 /multimedia/</userinput></screen>

	  <para xml:lang="en">The <acronym>RAID</acronym>3 array is now ready to
	    use.</para>
	</step>
      </procedure>

      <para xml:lang="en">Additional configuration is needed to retain this setup
	across system reboots.</para>

      <procedure>
	<step>
	  <para xml:lang="en">The <filename>geom_raid3.ko</filename> module must be
	    loaded before the array can be mounted.  To automatically
	    load the kernel module during system initialization, add
	    the following line to
	    <filename>/boot/loader.conf</filename>:</para>

	  <programlisting xml:lang="en">geom_raid3_load="YES"</programlisting>
	</step>

	<step>
	  <para xml:lang="en">The following volume information must be added to
	    <filename>/etc/fstab</filename> in order to
	    automatically mount the array's file system during the
	    system boot process:</para>

	  <programlisting xml:lang="en">/dev/raid3/gr0p1	/multimedia	ufs	rw	2	2</programlisting>
	</step>
      </procedure>
    </sect2>
  </sect1>

  <sect1 xml:id="geom-graid">
    <info>
      <title>軟體 <acronym>RAID</acronym> 裝置</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Warren</firstname>
	    <surname>Block</surname>
	  </personname>
	  <contrib>Originally contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary><acronym>GEOM</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>Software RAID Devices</primary>
      <secondary>Hardware-assisted RAID</secondary>
    </indexterm>

    <para xml:lang="en">Some motherboards and expansion cards add some simple
      hardware, usually just a <acronym>ROM</acronym>, that allows the
      computer to boot from a <acronym>RAID</acronym> array.  After
      booting, access to the <acronym>RAID</acronym> array is handled
      by software running on the computer's main processor.  This
      <quote>hardware-assisted software
	<acronym>RAID</acronym></quote> gives <acronym>RAID</acronym>
      arrays that are not dependent on any particular operating
      system, and which are functional even before an operating system
      is loaded.</para>

    <para xml:lang="en">Several levels of <acronym>RAID</acronym> are supported,
      depending on the hardware in use.  See <citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> for a
      complete list.</para>

    <para xml:lang="en"><citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> requires the <filename>geom_raid.ko</filename>
      kernel module, which is included in the
      <filename>GENERIC</filename> kernel starting with FreeBSD 9.1.
      If needed, it can be loaded manually with
      <command>graid load</command>.</para>

    <sect2 xml:id="geom-graid-creating">
      <title>建立陣列</title>

      <para xml:lang="en">Software <acronym>RAID</acronym> devices often have a menu
	that can be entered by pressing special keys when the computer
	is booting.  The menu can be used to create and delete
	<acronym>RAID</acronym> arrays.  <citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> can also create
	arrays directly from the command line.</para>

      <para xml:lang="en"><command>graid label</command> is used to create a new
	array.  The motherboard used for this example has an Intel
	software <acronym>RAID</acronym> chipset, so the Intel
	metadata format is specified.  The new array is given a label
	of <filename>gm0</filename>, it is a mirror
	(<acronym>RAID1</acronym>), and uses drives
	<filename>ada0</filename> and
	<filename>ada1</filename>.</para>

      <caution>
	<para xml:lang="en">Some space on the drives will be overwritten when they
	  are made into a new array.  Back up existing data
	  first!</para>
      </caution>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid label Intel gm0 RAID1 ada0 ada1</userinput>
GEOM_RAID: Intel-a29ea104: Array Intel-a29ea104 created.
GEOM_RAID: Intel-a29ea104: Disk ada0 state changed from NONE to ACTIVE.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:0-ada0 state changed from NONE to ACTIVE.
GEOM_RAID: Intel-a29ea104: Disk ada1 state changed from NONE to ACTIVE.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:1-ada1 state changed from NONE to ACTIVE.
GEOM_RAID: Intel-a29ea104: Array started.
GEOM_RAID: Intel-a29ea104: Volume gm0 state changed from STARTING to OPTIMAL.
Intel-a29ea104 created
GEOM_RAID: Intel-a29ea104: Provider raid/r0 for volume gm0 created.</screen>

      <para xml:lang="en">A status check shows the new mirror is ready for
	use:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid status</userinput>
   Name   Status  Components
raid/r0  OPTIMAL  ada0 (ACTIVE (ACTIVE))
                  ada1 (ACTIVE (ACTIVE))</screen>

      <para xml:lang="en">The array device appears in
	<filename>/dev/raid/</filename>.  The first array is called
	<filename>r0</filename>.  Additional arrays, if present, will
	be <filename>r1</filename>, <filename>r2</filename>, and so
	on.</para>

      <para xml:lang="en">The <acronym>BIOS</acronym> menu on some of these devices
	can create arrays with special characters in their names.  To
	avoid problems with those special characters, arrays are given
	simple numbered names like <filename>r0</filename>.  To show
	the actual labels, like <filename>gm0</filename> in the
	example above, use <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl kern.geom.raid.name_format=1</userinput></screen>
    </sect2>

    <sect2 xml:id="geom-graid-volumes">
      <title>多磁碟區</title>

      <para xml:lang="en">Some software <acronym>RAID</acronym> devices support
	more than one <emphasis>volume</emphasis> on an array.
	Volumes work like partitions, allowing space on the physical
	drives to be split and used in different ways.  For example,
	Intel software <acronym>RAID</acronym> devices support two
	volumes.  This example creates a 40 G mirror for safely
	storing the operating system, followed by a 20 G
	<acronym>RAID0</acronym> (stripe) volume for fast temporary
	storage:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid label -S 40G Intel gm0 RAID1 ada0 ada1</userinput>
<prompt>#</prompt> <userinput>graid add -S 20G gm0 RAID0</userinput></screen>

      <para xml:lang="en">Volumes appear as additional
	<filename>r<replaceable>X</replaceable></filename> entries
	in <filename>/dev/raid/</filename>.  An array with two volumes
	will show <filename>r0</filename> and
	<filename>r1</filename>.</para>

      <para xml:lang="en">See <citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> for the number of volumes supported by
	different software <acronym>RAID</acronym> devices.</para>
    </sect2>

    <sect2 xml:id="geom-graid-converting">
      <title>轉換單一磁碟為鏡像</title>

      <para xml:lang="en">Under certain specific conditions, it is possible to
	convert an existing single drive to a <citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> array
	without reformatting.  To avoid data loss during the
	conversion, the existing drive must meet these minimum
	requirements:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">The drive must be partitioned with the
	    <acronym>MBR</acronym> partitioning scheme.
	    <acronym>GPT</acronym> or other partitioning schemes with
	    metadata at the end of the drive will be overwritten and
	    corrupted by the <citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> metadata.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">There must be enough unpartitioned and unused space at
	    the end of the drive to hold the <citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> metadata.
	    This metadata varies in size, but the largest occupies
	    64 M, so at least that much free space is
	    recommended.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">If the drive meets these requirements, start by making a
	full backup.  Then create a single-drive mirror with that
	drive:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid label Intel gm0 RAID1 ada0 NONE</userinput></screen>

      <para xml:lang="en"><citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> metadata was written to the end of the drive
	in the unused space.  A second drive can now be inserted into
	the mirror:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid insert raid/r0 ada1</userinput></screen>

      <para xml:lang="en">Data from the original drive will immediately begin to be
	copied to the second drive.  The mirror will operate in
	degraded status until the copy is complete.</para>
    </sect2>

    <sect2 xml:id="geom-graid-inserting">
      <title>插入新磁碟到陣列</title>

      <para xml:lang="en">Drives can be inserted into an array as replacements for
	drives that have failed or are missing.  If there are no
	failed or missing drives, the new drive becomes a spare.  For
	example, inserting a new drive into a working two-drive mirror
	results in a two-drive mirror with one spare drive, not a
	three-drive mirror.</para>

      <para xml:lang="en">In the example mirror array, data immediately begins to be
	copied to the newly-inserted drive.  Any existing information
	on the new drive will be overwritten.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid insert raid/r0 ada1</userinput>
GEOM_RAID: Intel-a29ea104: Disk ada1 state changed from NONE to ACTIVE.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:1-ada1 state changed from NONE to NEW.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:1-ada1 state changed from NEW to REBUILD.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:1-ada1 rebuild start at 0.</screen>
    </sect2>

    <sect2 xml:id="geom-graid-removing">
      <title>從陣列移除磁碟</title>

      <para xml:lang="en">Individual drives can be permanently removed from a
	from an array and their metadata erased:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid remove raid/r0 ada1</userinput>
GEOM_RAID: Intel-a29ea104: Disk ada1 state changed from ACTIVE to OFFLINE.
GEOM_RAID: Intel-a29ea104: Subdisk gm0:1-[unknown] state changed from ACTIVE to NONE.
GEOM_RAID: Intel-a29ea104: Volume gm0 state changed from OPTIMAL to DEGRADED.</screen>
    </sect2>

    <sect2 xml:id="geom-graid-stopping">
      <title>停止陣列</title>

      <para xml:lang="en">An array can be stopped without removing metadata from the
	drives.  The array will be restarted when the system is
	booted.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid stop raid/r0</userinput></screen>
    </sect2>

    <sect2 xml:id="geom-graid-status">
      <title>檢查陣列狀態</title>

      <para xml:lang="en">Array status can be checked at any time.  After a drive
	was added to the mirror in the example above, data is being
	copied from the original drive to the new drive:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid status</userinput>
   Name    Status  Components
raid/r0  DEGRADED  ada0 (ACTIVE (ACTIVE))
                   ada1 (ACTIVE (REBUILD 28%))</screen>

      <para xml:lang="en">Some types of arrays, like <literal>RAID0</literal> or
	<literal>CONCAT</literal>, may not be shown in the status
	report if disks have failed.  To see these partially-failed
	arrays, add <option>-ga</option>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid status -ga</userinput>
          Name  Status  Components
Intel-e2d07d9a  BROKEN  ada6 (ACTIVE (ACTIVE))</screen>
    </sect2>

    <sect2 xml:id="geom-graid-deleting">
      <title>刪除陣列</title>

      <para xml:lang="en">Arrays are destroyed by deleting all of the volumes from
	them.  When the last volume present is deleted, the array is
	stopped and metadata is removed from the drives:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>graid delete raid/r0</userinput></screen>
    </sect2>

    <sect2 xml:id="geom-graid-unexpected">
      <title>刪除預期之外的陣列</title>

      <para xml:lang="en">Drives may unexpectedly contain <citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> metadata,
	either from previous use or manufacturer testing.
	<citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> will detect these drives and create an array,
	interfering with access to the individual drive.  To remove
	the unwanted metadata:</para>

      <procedure>
	<step>
	  <para xml:lang="en">Boot the system.  At the boot menu, select
	    <literal>2</literal> for the loader prompt.  Enter:</para>

	  <screen xml:lang="en">OK <userinput>set kern.geom.raid.enable=0</userinput>
OK <userinput>boot</userinput></screen>

	  <para xml:lang="en">The system will boot with <citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	    disabled.</para>
	</step>

	<step>
	  <para xml:lang="en">Back up all data on the affected drive.</para>
	</step>

	<step>
	  <para xml:lang="en">As a workaround, <citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> array detection
	    can be disabled by adding</para>

	  <programlisting xml:lang="en">kern.geom.raid.enable=0</programlisting>

	  <para xml:lang="en">to <filename>/boot/loader.conf</filename>.</para>

	  <para xml:lang="en">To permanently remove the <citerefentry><refentrytitle>graid</refentrytitle><manvolnum>8</manvolnum></citerefentry> metadata
	    from the affected drive, boot a FreeBSD installation
	    <acronym>CD-ROM</acronym> or memory stick, and select
	    <literal>Shell</literal>.  Use <command>status</command>
	    to find the name of the array, typically
	    <literal>raid/r0</literal>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>graid status</userinput>
   Name   Status  Components
raid/r0  OPTIMAL  ada0 (ACTIVE (ACTIVE))
                  ada1 (ACTIVE (ACTIVE))</screen>

	  <para xml:lang="en">Delete the volume by name:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>graid delete raid/r0</userinput></screen>

	  <para xml:lang="en">If there is more than one volume shown, repeat the
	    process for each volume.  After the last array has been
	    deleted, the volume will be destroyed.</para>

	  <para xml:lang="en">Reboot and verify data, restoring from backup if
	    necessary.  After the metadata has been removed, the
	    <literal>kern.geom.raid.enable=0</literal> entry in
	    <filename>/boot/loader.conf</filename> can also be
	    removed.</para>
	</step>
      </procedure>
    </sect2>
  </sect1>

  <sect1 xml:id="geom-ggate">
    <title xml:lang="en"><acronym>GEOM</acronym> Gate Network</title>

    <para xml:lang="en"><acronym>GEOM</acronym> provides a simple mechanism for
      providing remote access to devices such as disks,
      <acronym>CD</acronym>s, and file systems through the use of the
      <acronym>GEOM</acronym> Gate network daemon,
      <application>ggated</application>.  The system with the device
      runs the server daemon which handles requests made by clients
      using <application>ggatec</application>.  The devices should not
      contain any sensitive data as the connection between the client
      and the server is not encrypted.</para>

    <para xml:lang="en">Similar to <acronym>NFS</acronym>, which is discussed in
      <xref linkend="network-nfs"/>, <application>ggated</application>
      is configured using an exports file.  This file specifies which
      systems are permitted to access the exported resources and what
      level of access they are offered.  For example, to give the
      client <systemitem class="ipaddress">192.168.1.5</systemitem>
      read and write access to the fourth slice on the first
      <acronym>SCSI</acronym> disk, create
      <filename>/etc/gg.exports</filename> with this line:</para>

    <programlisting xml:lang="en">192.168.1.5 RW /dev/da0s4d</programlisting>

    <para xml:lang="en">Before exporting the device, ensure it is not currently
      mounted.  Then, start <application>ggated</application>:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>ggated</userinput></screen>

    <para xml:lang="en">Several options are available for specifying an alternate
      listening port or changing the default location of the exports
      file.  Refer to <citerefentry><refentrytitle>ggated</refentrytitle><manvolnum>8</manvolnum></citerefentry> for details.</para>

    <para xml:lang="en">To access the exported device on the client machine, first
      use <command>ggatec</command> to specify the
      <acronym>IP</acronym> address of the server and the device name
      of the exported device.  If successful, this command will
      display a <literal>ggate</literal> device name to mount.  Mount
      that specified device name on a free mount point.  This example
      connects to the <filename>/dev/da0s4d</filename> partition on
      <literal>192.168.1.1</literal>, then mounts
      <filename>/dev/ggate0</filename> on
      <filename>/mnt</filename>:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>ggatec create -o rw 192.168.1.1 /dev/da0s4d</userinput>
ggate0
<prompt>#</prompt> <userinput>mount /dev/ggate0 /mnt</userinput></screen>

    <para xml:lang="en">The device on the server may now be accessed through
      <filename>/mnt</filename> on the client.  For more details about
      <command>ggatec</command> and a few usage examples, refer to
      <citerefentry><refentrytitle>ggatec</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

    <note>
      <para xml:lang="en">The mount will fail if the device is currently mounted on
	either the server or any other client on the network.  If
	simultaneous access is needed to network resources, use
	<acronym>NFS</acronym> instead.</para>
    </note>

    <para xml:lang="en">When the device is no longer needed, unmount it with
      <command>umount</command> so that the resource is available to
      other clients.</para>
  </sect1>

  <sect1 xml:id="geom-glabel">
    <title>磁碟裝置標籤</title>

    <indexterm xml:lang="en">
      <primary><acronym>GEOM</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>Disk Labels</primary>
    </indexterm>

    <para xml:lang="en">During system initialization, the FreeBSD kernel creates
      device nodes as devices are found.  This method of probing for
      devices raises some issues.  For instance, what if a new disk
      device is added via <acronym>USB</acronym>?  It is likely that
      a flash device may be handed the device name of
      <filename>da0</filename> and the original
      <filename>da0</filename> shifted to
      <filename>da1</filename>.  This will cause issues mounting
      file systems if they are listed in
      <filename>/etc/fstab</filename> which may also prevent the
      system from booting.</para>

    <para xml:lang="en">One solution is to chain <acronym>SCSI</acronym> devices
      in order so a new device added to the <acronym>SCSI</acronym>
      card will be issued unused device numbers.  But what about
      <acronym>USB</acronym> devices which may replace the primary
      <acronym>SCSI</acronym> disk?  This happens because
      <acronym>USB</acronym> devices are usually probed before the
      <acronym>SCSI</acronym> card.  One solution is to only insert
      these devices after the system has been booted.  Another method
      is to use only a single <acronym>ATA</acronym> drive and never
      list the <acronym>SCSI</acronym> devices in
      <filename>/etc/fstab</filename>.</para>

    <para xml:lang="en">A better solution is to use <command>glabel</command> to
      label the disk devices and use the labels in
      <filename>/etc/fstab</filename>.  Because
      <command>glabel</command> stores the label in the last sector of
      a given provider, the label will remain persistent across
      reboots.  By using this label as a device, the file system may
      always be mounted regardless of what device node it is accessed
      through.</para>

    <note>
      <para xml:lang="en"><command>glabel</command> can create both transient and
	permanent labels.  Only permanent labels are consistent across
	reboots.  Refer to <citerefentry><refentrytitle>glabel</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more information on the
	differences between labels.</para>
    </note>

    <sect2>
      <title>標籤類型與範例</title>

      <para xml:lang="en">Permanent labels can be a generic or a file system label.
	Permanent file system labels can be created with
	<citerefentry><refentrytitle>tunefs</refentrytitle><manvolnum>8</manvolnum></citerefentry> or <citerefentry><refentrytitle>newfs</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  These types of labels are
	created in a sub-directory of <filename>/dev</filename>, and
	will be named according to the file system type.  For example,
	<acronym>UFS</acronym>2 file system labels will be created in
	<filename>/dev/ufs</filename>.  Generic permanent labels can
	be created with <command>glabel label</command>.  These are
	not file system specific and will be created in
	<filename>/dev/label</filename>.</para>

      <para xml:lang="en">Temporary labels are destroyed at the next reboot.  These
	labels are created in <filename>/dev/label</filename> and are
	suited to experimentation.  A temporary label can be created
	using <command>glabel create</command>.</para>

<!-- XXXTR: How do you create a file system label without running newfs
	    or when there is no newfs (e.g.: cd9660)? -->

      <para xml:lang="en">To create a permanent label for a
	<acronym>UFS</acronym>2 file system without destroying any
	data, issue the following command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>tunefs -L <replaceable>home</replaceable> <replaceable>/dev/da3</replaceable></userinput></screen>

      <para xml:lang="en">A label should now exist in <filename>/dev/ufs</filename>
	which may be added to <filename>/etc/fstab</filename>:</para>

      <programlisting xml:lang="en">/dev/ufs/home		/home            ufs     rw              2      2</programlisting>

      <note>
	<para xml:lang="en">The file system must not be mounted while attempting
	  to run <command>tunefs</command>.</para>
      </note>

      <para xml:lang="en">Now the file system may be mounted:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mount /home</userinput></screen>

      <para xml:lang="en">From this point on, so long as the
	<filename>geom_label.ko</filename> kernel module is loaded at
	boot with <filename>/boot/loader.conf</filename> or the
	<literal>GEOM_LABEL</literal> kernel option is present,
	the device node may change without any ill effect on the
	system.</para>

      <para xml:lang="en">File systems may also be created with a default label
	by using the <option>-L</option> flag with
	<command>newfs</command>.  Refer to <citerefentry><refentrytitle>newfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> for
	more information.</para>

      <para xml:lang="en">The following command can be used to destroy the
	label:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>glabel destroy home</userinput></screen>

      <para xml:lang="en">The following example shows how to label the partitions of
	a boot disk.</para>

      <example>
	<title>在開機磁碟標記分割區標籤</title>

	<para xml:lang="en">By permanently labeling the partitions on the boot disk,
	  the system should be able to continue to boot normally, even
	  if the disk is moved to another controller or transferred to
	  a different system.  For this example, it is assumed that a
	  single <acronym>ATA</acronym> disk is used, which is
	  currently recognized by the system as
	  <filename>ad0</filename>.  It is also assumed that the
	  standard FreeBSD partition scheme is used, with
	  <filename>/</filename>,
	  <filename>/var</filename>,
	  <filename>/usr</filename> and
	  <filename>/tmp</filename>, as
	  well as a swap partition.</para>

	<para xml:lang="en">Reboot the system, and at the <citerefentry><refentrytitle>loader</refentrytitle><manvolnum>8</manvolnum></citerefentry> prompt,
	  press <keycap>4</keycap> to boot into single user mode.
	  Then enter the following commands:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>glabel label rootfs /dev/ad0s1a</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1a is label/rootfs
<prompt>#</prompt> <userinput>glabel label var /dev/ad0s1d</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1d is label/var
<prompt>#</prompt> <userinput>glabel label usr /dev/ad0s1f</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1f is label/usr
<prompt>#</prompt> <userinput>glabel label tmp /dev/ad0s1e</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1e is label/tmp
<prompt>#</prompt> <userinput>glabel label swap /dev/ad0s1b</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1b is label/swap
<prompt>#</prompt> <userinput>exit</userinput></screen>

	<para xml:lang="en">The system will continue with multi-user boot.  After
	  the boot completes, edit <filename>/etc/fstab</filename> and
	  replace the conventional device names, with their respective
	  labels.  The final <filename>/etc/fstab</filename> will
	  look like this:</para>

	<programlisting xml:lang="en"># Device                Mountpoint      FStype  Options         Dump    Pass#
/dev/label/swap         none            swap    sw              0       0
/dev/label/rootfs       /               ufs     rw              1       1
/dev/label/tmp          /tmp            ufs     rw              2       2
/dev/label/usr          /usr            ufs     rw              2       2
/dev/label/var          /var            ufs     rw              2       2</programlisting>

	<para xml:lang="en">The system can now be rebooted.  If everything went
	  well, it will come up normally and <command>mount</command>
	  will show:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mount</userinput>
/dev/label/rootfs on / (ufs, local)
devfs on /dev (devfs, local)
/dev/label/tmp on /tmp (ufs, local, soft-updates)
/dev/label/usr on /usr (ufs, local, soft-updates)
/dev/label/var on /var (ufs, local, soft-updates)</screen>
      </example>

      <para xml:lang="en">The <citerefentry><refentrytitle>glabel</refentrytitle><manvolnum>8</manvolnum></citerefentry> class
	supports a label type for <acronym>UFS</acronym> file
	systems, based on the unique file system id,
	<literal>ufsid</literal>.  These labels may be found in
	<filename>/dev/ufsid</filename> and are
	created automatically during system startup.  It is possible
	to use <literal>ufsid</literal> labels to mount partitions
	using <filename>/etc/fstab</filename>.  Use <command>glabel
	  status</command> to receive a list of file systems and their
	corresponding <literal>ufsid</literal> labels:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>glabel status</userinput>
                  Name  Status  Components
ufsid/486b6fc38d330916     N/A  ad4s1d
ufsid/486b6fc16926168e     N/A  ad4s1f</screen>

      <para xml:lang="en">In the above example, <filename>ad4s1d</filename>
	represents <filename>/var</filename>,
	while <filename>ad4s1f</filename> represents
	<filename>/usr</filename>.
	Using the <literal>ufsid</literal> values shown, these
	partitions may now be mounted with the following entries in
	<filename>/etc/fstab</filename>:</para>

      <programlisting xml:lang="en">/dev/ufsid/486b6fc38d330916        /var        ufs        rw        2      2
/dev/ufsid/486b6fc16926168e        /usr        ufs        rw        2      2</programlisting>

      <para xml:lang="en">Any partitions with <literal>ufsid</literal> labels can be
	mounted in this way, eliminating the need to manually create
	permanent labels, while still enjoying the benefits of device
	name independent mounting.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="geom-gjournal">
    <title>UFS Journaling 透過 <acronym>GEOM</acronym></title>

    <indexterm xml:lang="en">
      <primary><acronym>GEOM</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>Journaling</primary>
    </indexterm>

    <para xml:lang="en">Support for journals on
      <acronym>UFS</acronym> file systems is available on FreeBSD.  The
      implementation is provided through the <acronym>GEOM</acronym>
      subsystem and is configured using <command>gjournal</command>.
      Unlike other file system journaling implementations, the
      <command>gjournal</command> method is block based and not
      implemented as part of the file system.  It is a
      <acronym>GEOM</acronym> extension.</para>

    <para xml:lang="en">Journaling stores a log of file system transactions, such as
      changes that make up a complete disk write operation, before
      meta-data and file writes are committed to the disk.  This
      transaction log can later be replayed to redo file system
      transactions, preventing file system inconsistencies.</para>

    <para xml:lang="en">This method provides another mechanism to protect against
      data loss and inconsistencies of the file system.  Unlike Soft
      Updates, which tracks and enforces meta-data updates, and
      snapshots, which create an image of the file system, a log is
      stored in disk space specifically for this task.  For better
      performance, the journal may be stored on another disk.  In this
      configuration, the journal provider or storage device should be
      listed after the device to enable journaling on.</para>

    <para xml:lang="en">The <filename>GENERIC</filename> kernel provides support for
      <command>gjournal</command>.  To automatically load the
      <filename>geom_journal.ko</filename> kernel module at boot time,
      add the following line to
      <filename>/boot/loader.conf</filename>:</para>

    <programlisting xml:lang="en">geom_journal_load="YES"</programlisting>

    <para xml:lang="en">If a custom kernel is used, ensure the following line is in
      the kernel configuration file:</para>

    <programlisting xml:lang="en">options	GEOM_JOURNAL</programlisting>

    <para xml:lang="en">Once the module is loaded, a journal can be created on a new
      file system using the following steps.  In this example,
      <filename>da4</filename> is a new <acronym>SCSI</acronym>
      disk:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>gjournal load</userinput>
<prompt>#</prompt> <userinput>gjournal label /dev/<replaceable>da4</replaceable></userinput></screen>

    <para xml:lang="en">This will load the module and create a
      <filename>/dev/da4.journal</filename> device node on
      <filename>/dev/da4</filename>.</para>

    <para xml:lang="en">A <acronym>UFS</acronym> file system may now be created on
      the journaled device, then mounted on an existing mount
      point:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>newfs -O 2 -J /dev/<replaceable>da4</replaceable>.journal</userinput>
<prompt>#</prompt> <userinput>mount /dev/<replaceable>da4</replaceable>.journal <replaceable>/mnt</replaceable></userinput></screen>

    <note>
      <para xml:lang="en">In the case of several slices, a journal will be created
	for each individual slice.  For instance, if
	<filename>ad4s1</filename> and <filename>ad4s2</filename> are
	both slices, then <command>gjournal</command> will create
	<filename>ad4s1.journal</filename> and
	<filename>ad4s2.journal</filename>.</para>
    </note>

    <para xml:lang="en">Journaling may also be enabled on current file systems by
      using <command>tunefs</command>.  However,
      <emphasis>always</emphasis> make a backup before attempting to
      alter an existing file system.  In most cases,
      <command>gjournal</command> will fail if it is unable to create
      the journal, but this does not protect against data loss
      incurred as a result of misusing <command>tunefs</command>.
      Refer to <citerefentry><refentrytitle>gjournal</refentrytitle><manvolnum>8</manvolnum></citerefentry> and <citerefentry><refentrytitle>tunefs</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more
      information about these commands.</para>

    <para xml:lang="en">It is possible to journal the boot disk of a FreeBSD system.
      Refer to the article <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/gjournal-desktop">Implementing UFS
	Journaling on a Desktop PC</link> for detailed
      instructions.</para>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project
     $FreeBSD$
-->

<chapter version="5.0" xml:id="zfs">

  <info>
    <title>Z 檔案系統 (<acronym>ZFS</acronym>)</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	</personname>
	<contrib>Written by </contrib>
      </author>
      <author xml:lang="en">
	<personname>
	  <firstname>Allan</firstname>
	  <surname>Jude</surname>
	</personname>
	<contrib>Written by </contrib>
      </author>
      <author xml:lang="en">
	<personname>
	  <firstname>Benedict</firstname>
	  <surname>Reuschling</surname>
	</personname>
	<contrib>Written by </contrib>
      </author>
      <author xml:lang="en">
	<personname>
	  <firstname>Warren</firstname>
	  <surname>Block</surname>
	</personname>
	<contrib>Written by </contrib>
      </author>
    </authorgroup>
  </info>

  <para><emphasis>Z 檔案系統</emphasis> 或 <acronym>ZFS</acronym> 是設計來克服許多在以往設計中發現的主要問題的一個先進的檔案系統。</para>

  <para>最初由 <trademark>Sun</trademark> 所開發，後來的開放源始碼 <acronym>ZFS</acronym> 開發已移到 <link xlink:href="http://open-zfs.org">OpenZFS 計劃</link>。</para>

  <para><acronym>ZFS</acronym> 的設計目標主要有三個：</para>

  <itemizedlist>
    <listitem>
      <para>資料完整性：所有資料都會有一個資料的校驗碼 (<link linkend="zfs-term-checksum">checksum</link>)，資料寫入時會計算校驗碼然後一併寫入，往後讀取資料時會再計算一次校驗碼，若校驗碼與當初寫入時不相符，便可偵測到資料錯誤，此時若有可用的資料備援 (Data redundancy)，<acronym>ZFS</acronym> 會嘗試自動修正錯誤。</para>
    </listitem>

    <listitem>
      <para>儲存池：實體的儲存裝置都會先被加入到一個儲存池 (Pool)，這個共用的儲存池可用來配置儲存空間，儲存池的空間可被所有的檔案系統使用且透過加入新的儲存裝置來增加空間。</para>
    </listitem>

    <listitem>
      <para>效能：提供多個快取機制來增加效能。先進、以記憶體為基礎的讀取快取可使用 <link linkend="zfs-term-arc">ARC</link>。第二層以磁碟為基礎的讀取快取可使用 <link linkend="zfs-term-l2arc">L2ARC</link>，以磁碟為基礎的同步寫入快取則可使用 <link linkend="zfs-term-zil">ZIL</link>。</para>
    </listitem>
  </itemizedlist>

  <para>完整的功能清單與術語在 <xref linkend="zfs-term"/> 中有詳述。</para>

  <sect1 xml:id="zfs-differences">
    <title>什麼使 <acronym>ZFS</acronym> 與眾不同</title>

    <para><acronym>ZFS</acronym> 與以往任何的檔案系統有顯著的不同，因為它不只是一個檔案系統，<acronym>ZFS</acronym> 的獨特優點來自結合了以往被分開的磁碟區管理程式 (Volume Manager) 及檔案系統兩個角色，讓檔案系統也能夠察覺磁碟底層結構的變動。傳統在一個磁碟上只能建立一個檔案系統，若有兩個磁碟則會需要建立兩個分開的檔案系統，在傳統要解決這個問題要使用硬體 <acronym>RAID</acronym> 來製作一個空間實際上由數顆實體磁碟所組成的單一的邏輯磁碟給作業系統，作業系統便可在這個邏輯磁碟上放置檔案系統，即使是在那些使用 <acronym>GEOM</acronym> 提供的軟體 <acronym>RAID</acronym> 解決方案也是一樣，把 <acronym>UFS</acronym> 檔案系統放在 <acronym>RAID</acronym> Transform 上面當做是一個單一的裝置。<acronym>ZFS</acronym> 結合了磁碟區管理程式 (Volume Manager) 與檔案系統來解決這個問題並讓建立多個檔案系統可以共用一個儲存池 (Pool)。<acronym>ZFS</acronym> 最大的優點是可以察覺實體磁碟配置的變動，當有額外的磁碟加入到儲存池時可以自動擴增現有的檔案系統，所有的檔案系統便可使用這個新的空間。<acronym>ZFS</acronym> 也有數個不同的屬性可以套用到各別檔案系統上，比起單一檔案系統，對建立數個不同檔案系統與資料集 (Dataset) 時有許多的好處。</para>
  </sect1>

  <sect1 xml:id="zfs-quickstart">
    <title>快速入門指南</title>

    <para>這裡有一個啟動機制，可讓 FreeBSD 在系統初始化時掛載 <acronym>ZFS</acronym> 儲存池。要開啟這個功能，可加入此行到 <filename>/etc/rc.conf</filename>：</para>

    <programlisting xml:lang="en">zfs_enable="YES"</programlisting>

    <para>然後啟動服務：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>service zfs start</userinput></screen>

    <para>本節的例子會假設有三個 <acronym>SCSI</acronym> 磁碟，名稱分別為 <filename><replaceable>da0</replaceable></filename>, <filename><replaceable>da1</replaceable></filename> 及 <filename><replaceable>da2</replaceable></filename>。<acronym>SATA</acronym> 硬體的使用者裝置名稱改為 <filename><replaceable>ada</replaceable></filename> 。</para>

    <sect2 xml:id="zfs-quickstart-single-disk-pool">
      <title>單磁碟儲存池</title>

      <para>要使用一個磁碟裝置建立一個簡單、無備援的儲存池可：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool create <replaceable>example</replaceable> <replaceable>/dev/da0</replaceable></userinput></screen>

      <para>要檢視這個新的儲存池，可查看 <command>df</command> 的輸出結果：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>df</userinput>
Filesystem  1K-blocks    Used    Avail Capacity  Mounted on
/dev/ad0s1a   2026030  235230  1628718    13%    /
devfs               1       1        0   100%    /dev
/dev/ad0s1d  54098308 1032846 48737598     2%    /usr
example      17547136       0 17547136     0%    /example</screen>

      <para>這個輸出結果說明 <literal>example</literal> 儲存池已建立且被掛載，現在已經可以作為檔案系統存取，可以在上面建立檔案且使用者可以瀏覽：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /example</userinput>
<prompt>#</prompt> <userinput>ls</userinput>
<prompt>#</prompt> <userinput>touch testfile</userinput>
<prompt>#</prompt> <userinput>ls -al</userinput>
total 4
drwxr-xr-x   2 root  wheel    3 Aug 29 23:15 .
drwxr-xr-x  21 root  wheel  512 Aug 29 23:12 ..
-rw-r--r--   1 root  wheel    0 Aug 29 23:15 testfile</screen>

      <para>但是，這個儲存池並未運用到任何 <acronym>ZFS</acronym> 功能，若要在這個儲存池上建立一個有開啟壓縮功能的資料集：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs create example/compressed</userinput>
<prompt>#</prompt> <userinput>zfs set compression=gzip example/compressed</userinput></screen>

      <para><literal>example/compressed</literal> 資料集現在是一個 <acronym>ZFS</acronym> 壓縮的檔案系統，可以試著複製較大的檔案到 <filename>/example/compressed</filename>。</para>

      <para>壓縮功能也可以使用以下指令關閉：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set compression=off example/compressed</userinput></screen>

      <para>要卸載檔案系統，使用 <command>zfs umount</command> 然後再使用 <command>df</command> 確認：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs umount example/compressed</userinput>
<prompt>#</prompt> <userinput>df</userinput>
Filesystem  1K-blocks    Used    Avail Capacity  Mounted on
/dev/ad0s1a   2026030  235232  1628716    13%    /
devfs               1       1        0   100%    /dev
/dev/ad0s1d  54098308 1032864 48737580     2%    /usr
example      17547008       0 17547008     0%    /example</screen>

      <para>要重新掛載檔案系統以便再次使用，使用 <command>zfs mount</command> 然後以 <command>df</command> 檢查：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs mount example/compressed</userinput>
<prompt>#</prompt> <userinput>df</userinput>
Filesystem         1K-blocks    Used    Avail Capacity  Mounted on
/dev/ad0s1a          2026030  235234  1628714    13%    /
devfs                      1       1        0   100%    /dev
/dev/ad0s1d         54098308 1032864 48737580     2%    /usr
example             17547008       0 17547008     0%    /example
example/compressed  17547008       0 17547008     0%    /example/compressed</screen>

      <para>儲存池與檔案系統也可以從 <command>mount</command> 的結果查詢到：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mount</userinput>
/dev/ad0s1a on / (ufs, local)
devfs on /dev (devfs, local)
/dev/ad0s1d on /usr (ufs, local, soft-updates)
example on /example (zfs, local)
example/compressed on /example/compressed (zfs, local)</screen>

      <para>在建立之後，<acronym>ZFS</acronym> 的資料集可如同其他檔案系統一般使用，且有許多額外功能可在每個資料集上設定。例如，建立一個預計存放重要的資料的新檔案系統 <literal>data</literal>，要設定每個資料區塊 (Data block) 要保留兩份備份：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs create example/data</userinput>
<prompt>#</prompt> <userinput>zfs set copies=2 example/data</userinput></screen>

      <para>現在，可以使用 <command>df</command> 指令來查看資料與空間的使用率：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>df</userinput>
Filesystem         1K-blocks    Used    Avail Capacity  Mounted on
/dev/ad0s1a          2026030  235234  1628714    13%    /
devfs                      1       1        0   100%    /dev
/dev/ad0s1d         54098308 1032864 48737580     2%    /usr
example             17547008       0 17547008     0%    /example
example/compressed  17547008       0 17547008     0%    /example/compressed
example/data        17547008       0 17547008     0%    /example/data</screen>

      <para>注意，從這個可以發現每個在儲存池上的檔案系統都擁有相同的可用空間，這是為什麼要在這些範例使用 <command>df</command> 的原因，為了要顯示檔案系統只會用它們所需要使用到的空間，且均取自同一個儲存池。<acronym>ZFS</acronym> 淘汰了磁碟區 (Volume) 與分割區 (Partition) 的概念，且允許多個檔案系統共用相同的儲存池。</para>

      <para>不需要使用時可摧毀檔案系統後再摧毀儲存池：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs destroy example/compressed</userinput>
<prompt>#</prompt> <userinput>zfs destroy example/data</userinput>
<prompt>#</prompt> <userinput>zpool destroy example</userinput></screen>
    </sect2>

    <sect2 xml:id="zfs-quickstart-raid-z">
      <title xml:lang="en">RAID-Z</title>

      <para>磁碟損壞時，要避免資料因磁碟故障造成遺失便是使用 <acronym>RAID</acronym>。<acronym>ZFS</acronym> 在它的儲存池設計中支援了這項功能。<acronym>RAID-Z</acronym>  儲存池需要使用三個或更多的磁碟，但可以提供比鏡像 (Mirror) 儲存池更多的可用空間。</para>

      <para>這個例子會建立一個 <acronym>RAID-Z</acronym> 儲存池，並指定要加入這個儲存池的磁碟：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool create storage raidz da0 da1 da2</userinput></screen>

      <note>
	<para><trademark>Sun</trademark> 建議用在 <acronym>RAID</acronym>-Z 設定的裝置數在三到九個之間。若需要由 10 個或更多磁碟組成單一儲存池的環境，可考慮分成較小的 <acronym>RAID-Z</acronym> 群組。若只有兩個可用的磁碟且需要做備援 (Redundancy)，可考慮使用 <acronym>ZFS</acronym> 鏡像 (Mirror)。請參考 <citerefentry><refentrytitle>zpool</refentrytitle><manvolnum>8</manvolnum></citerefentry> 取得更多詳細資訊。</para>
      </note>

      <para>先前的例子已經建立了 <literal>storage</literal> 儲存池 (zpool)，現在這個例子會在該儲存池中建立一個新的檔案系統，名稱為 <literal>home</literal>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs create storage/home</userinput></screen>

      <para>可以設定開啟壓縮及保留目錄及檔案額外備份的功能：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set copies=2 storage/home</userinput>
<prompt>#</prompt> <userinput>zfs set compression=gzip storage/home</userinput></screen>

      <para>要讓這個空間作為使用者的新家目錄位置，需複製使用者資料到這個目錄並建立適合的符號連結 (Symbolic link)：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cp -rp /home/* /storage/home</userinput>
<prompt>#</prompt> <userinput>rm -rf /home /usr/home</userinput>
<prompt>#</prompt> <userinput>ln -s /storage/home /home</userinput>
<prompt>#</prompt> <userinput>ln -s /storage/home /usr/home</userinput></screen>

      <para>現在使用者的資料會儲存在新建立的 <filename>/storage/home</filename>，可以加入新使用者並登入該使用者來測試。</para>

      <para>試著建立檔案系統快照 (Snapshot)，稍後可用來還原 (Rollback)：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs snapshot storage/home@08-30-08</userinput></screen>

      <para>快照只可以使用整個檔案系統製作，無法使用各別目錄或檔案。</para>

      <para><literal>@</literal> 字元用來區隔檔案系統名稱 (File system) 或磁碟區 (Volume) 名稱，若有重要的目錄意外被刪除，檔案系統可以備份然後還原到先前目錄還存在時的快照 (Snapshot)：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs rollback storage/home@08-30-08</userinput></screen>

      <para>要列出所有可用的快照，可在檔案系統的 <filename>.zfs/snapshot</filename> 目錄執行 <command>ls</command>，舉例來說，要查看先前已做的快照：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ls /storage/home/.zfs/snapshot</userinput></screen>

      <para>也可以寫一個 Script 來對使用者資料做例行性的快照，但隨著時間快照可能消耗大量的磁碟空間。先前的快照可以使用指令移除：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs destroy storage/home@08-30-08</userinput></screen>

      <para>在測試之後，便可讓 <filename>/storage/home</filename> 成為真正的 <filename>/home</filename> 使用此指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set mountpoint=/home storage/home</userinput></screen>

      <para>執行 <command>df</command> 興 <command>mount</command> 來確認系統現在是否以把檔案系統做為真正的 <filename>/home</filename>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mount</userinput>
/dev/ad0s1a on / (ufs, local)
devfs on /dev (devfs, local)
/dev/ad0s1d on /usr (ufs, local, soft-updates)
storage on /storage (zfs, local)
storage/home on /home (zfs, local)
<prompt>#</prompt> <userinput>df</userinput>
Filesystem   1K-blocks    Used    Avail Capacity  Mounted on
/dev/ad0s1a    2026030  235240  1628708    13%    /
devfs                1       1        0   100%    /dev
/dev/ad0s1d   54098308 1032826 48737618     2%    /usr
storage       26320512       0 26320512     0%    /storage
storage/home  26320512       0 26320512     0%    /home</screen>

      <para>這個動作完成 <acronym>RAID-Z</acronym> 最後的設定，有關已建立的檔案系統每日狀態更新可以做為 <citerefentry><refentrytitle>periodic</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的一部份在每天晚上執行。加入此行到 <filename>/etc/periodic.conf</filename>：</para>

      <programlisting xml:lang="en">daily_status_zfs_enable="YES"</programlisting>
    </sect2>

    <sect2 xml:id="zfs-quickstart-recovering-raid-z">
      <title>復原 <acronym>RAID-Z</acronym></title>

      <para>每個軟體 <acronym>RAID</acronym> 都有監控其狀態 (<literal>state</literal>) 的方式，而 <acronym>RAID-Z</acronym> 裝置的狀態可以使用這個指令來查看：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status -x</userinput></screen>

      <para>如果所有儲存池為上線 (<link linkend="zfs-term-online">Online</link>) 且正常，則訊息會顯示：</para>

      <screen xml:lang="en">all pools are healthy</screen>

      <para>如果有發生問題，可能磁碟會呈現離線 (<link linkend="zfs-term-offline">Offline</link>) 的狀態，此時儲存池的狀態會是：</para>

      <screen xml:lang="en">  pool: storage
 state: DEGRADED
status: One or more devices has been taken offline by the administrator.
	Sufficient replicas exist for the pool to continue functioning in a
	degraded state.
action: Online the device using 'zpool online' or replace the device with
	'zpool replace'.
 scrub: none requested
config:

	NAME        STATE     READ WRITE CKSUM
	storage     DEGRADED     0     0     0
	  raidz1    DEGRADED     0     0     0
	    da0     ONLINE       0     0     0
	    da1     OFFLINE      0     0     0
	    da2     ONLINE       0     0     0

errors: No known data errors</screen>

      <para>這代表著裝置在之前被管理者使用此指令拿下線：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool offline storage da1</userinput></screen>

      <para>現在系統可以關機然後更換 <filename>da1</filename>，當系統恢復上線，則可以替換掉儲存池中故障的磁碟：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool replace storage da1</userinput></screen>

      <para>到這裡，可以再檢查狀態一次，這時不需使用 <option>-x</option> 參數來顯示所有的儲存池：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status storage</userinput>
 pool: storage
 state: ONLINE
 scrub: resilver completed with 0 errors on Sat Aug 30 19:44:11 2008
config:

	NAME        STATE     READ WRITE CKSUM
	storage     ONLINE       0     0     0
	  raidz1    ONLINE       0     0     0
	    da0     ONLINE       0     0     0
	    da1     ONLINE       0     0     0
	    da2     ONLINE       0     0     0

errors: No known data errors</screen>

      <para>在這個例子中，所有的磁碟均已正常運作。</para>
    </sect2>

    <sect2 xml:id="zfs-quickstart-data-verification">
      <title>資料檢驗</title>

      <para><acronym>ZFS</acronym> 使用校驗碼 (Checksum) 來檢驗資料的完整性 (Integrity)，會在建立檔案系統時便自動開啟。</para>

      <warning>
	<para>校驗碼 (Checksum) 可以關閉，但並<emphasis>不</emphasis>建議！校驗碼只會使用非常少的儲存空間來確保資料的完整性。若關閉校驗碼會使許多 <acronym>ZFS</acronym> 功能無法正常運作，且關閉校驗碼對並不會明顯的改善效能。</para>
      </warning>

      <para>檢驗校驗碼這個動作即所謂的<emphasis>清潔 (Scrub)</emphasis>，可以使用以下指令來檢驗 <literal>storage</literal> 儲存池的資料完整性：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool scrub storage</userinput></screen>

      <para>清潔所需要的時間依儲存的資料量而定，較大的資料量相對會需要花費較長的時間來檢驗。清潔會對 <acronym>I/O</acronym> 有非常密集的操作且一次只能進行一個清潔動作。在清潔完成之後，可以使用 <command>status</command> 來查看狀態：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status storage</userinput>
 pool: storage
 state: ONLINE
 scrub: scrub completed with 0 errors on Sat Jan 26 19:57:37 2013
config:

	NAME        STATE     READ WRITE CKSUM
	storage     ONLINE       0     0     0
	  raidz1    ONLINE       0     0     0
	    da0     ONLINE       0     0     0
	    da1     ONLINE       0     0     0
	    da2     ONLINE       0     0     0

errors: No known data errors</screen>

      <para>查詢結果會顯示上次完成清潔的時間來協助追蹤是否要再做清潔。定期清潔可以協助保護資料不會默默損壞且確保儲存池的完整性。</para>

      <para>請參考 <citerefentry><refentrytitle>zfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> 及 <citerefentry><refentrytitle>zpool</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來取得其他 <acronym>ZFS</acronym> 選項。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="zfs-zpool">
    <title><command>zpool</command> 管理</title>

    <para><acronym>ZFS</acronym> 管理分成兩個主要的工具。<command>zpool</command> 工具用來控制儲存池的運作並可處理磁碟的新增、移除、更換與管理。<link linkend="zfs-zfs"><command>zfs</command></link> 工具用來建立、摧毀與管理檔案系統 (<link linkend="zfs-term-filesystem">File system</link>) 與磁碟區 (<link linkend="zfs-term-volume">Volume</link>) 的資料集。</para>

    <sect2 xml:id="zfs-zpool-create">
      <title>建立與摧毀儲存池</title>

      <para>建立 <acronym>ZFS</acronym> 儲存池 (<emphasis>zpool</emphasis>) 要做幾個涉及長遠規劃的決定，因為建立儲存池之後便無法再更改儲存池的結構。最重要的決定是要使用那一種型態的 vdev 來將實體磁碟設為同一群組。請參考 <link linkend="zfs-term-vdev">vdev 型態</link> 的清單來取得有關可用選項的詳細資訊。大部份的 vdev 型態不允許在建立儲存池之後再加入額外的磁碟，鏡像 (Mirror) 是可以允許加入額外的磁碟到 vdev 的其中一個例外，另一個則是串連 (Stripe)，可以加入額外的磁碟到 vdev 來升級為鏡像。雖然可以加入額外的 vdev 來擴充儲存池，但儲存池的配置在建立之後便無法更改，若要要更改，則必須先備份資料，把儲存池摧毀後再重新建立。</para>

      <para>建立一個簡單的鏡像儲存池：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool create <replaceable>mypool</replaceable> mirror <replaceable>/dev/ada1</replaceable> <replaceable>/dev/ada2</replaceable></userinput>
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada1    ONLINE       0     0     0
            ada2    ONLINE       0     0     0

errors: No known data errors</screen>

      <para>可以一次建立數個 vdev，磁碟群組間使用 vdev 型態關鍵字來區隔，在這個例子使用 <literal>mirror</literal>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool create <replaceable>mypool</replaceable> mirror <replaceable>/dev/ada1</replaceable> <replaceable>/dev/ada2</replaceable> mirror <replaceable>/dev/ada3</replaceable> <replaceable>/dev/ada4</replaceable></userinput>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada1    ONLINE       0     0     0
            ada2    ONLINE       0     0     0
          mirror-1  ONLINE       0     0     0
            ada3    ONLINE       0     0     0
            ada4    ONLINE       0     0     0

errors: No known data errors</screen>

      <para>儲存池也可以不使用整個磁碟而改使用分割區 (Partition) 來建立。把 <acronym>ZFS</acronym> 放到不同的分割區可讓同一個磁碟有其他的分割區可做其他用途，尤其是有 Bootcode 與檔案系統要用來開機的分割區，這讓磁碟可以用來開機也同樣可以做為儲存池的一部份。在 FreeBSD 用分割區來替代整個磁碟並不會對效能有影響。使用分割區也讓管理者可以對磁碟容量做 <emphasis>少算的預備</emphasis>，使用比完整容量少的容量，未來若要替換的磁碟號稱與原磁碟相同，但實際上卻比較小時，也可符合這個較小的分割區容量，以使用替換的磁碟。</para>

      <para>使用分割區建立一個 <link linkend="zfs-term-vdev-raidz">RAID-Z2</link> 儲存池：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool create <replaceable>mypool</replaceable> raidz2 <replaceable>/dev/ada0p3</replaceable> <replaceable>/dev/ada1p3</replaceable> <replaceable>/dev/ada2p3</replaceable> <replaceable>/dev/ada3p3</replaceable> <replaceable>/dev/ada4p3</replaceable> <replaceable>/dev/ada5p3</replaceable></userinput>
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          raidz2-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0
            ada3p3  ONLINE       0     0     0
            ada4p3  ONLINE       0     0     0
            ada5p3  ONLINE       0     0     0

errors: No known data errors</screen>

      <para>不需使用的儲存池可以摧毀，來讓磁碟可以再次使用。摧毀一個儲存池要先卸載所有該儲存池的資料集。若資料集在使用中，卸載的操作會失敗且儲存池不會被摧毀。儲存池的摧毀可以使用 <option>-f</option> 來強制執行，但這可能造成那些有開啟這些資料集之中檔案的應用程式無法辨識的行為。</para>
    </sect2>

    <sect2 xml:id="zfs-zpool-attach">
      <title>加入與移除裝置</title>

      <para>加入磁碟到儲存池 (zpool) 會有兩種情形：使用 <command>zpool attach</command> 加入一個磁碟到既有的 vdev，或使用 <command>zpool add</command> 加入 vdev 到儲存池。只有部份 <link linkend="zfs-term-vdev">vdev 型態</link> 允許在 vdev 建立之後加入磁碟。</para>

      <para>由單一磁碟所建立的儲存池缺乏備援 (Redundancy) 功能，可以偵測到資料的損壞但無法修復，因為資料沒有其他備份可用。備份數 (<link linkend="zfs-term-copies">Copies</link>) 屬性可以讓您從較小的故障中復原，如磁碟壞軌 (Bad sector)，但無法提供與鏡像或 <acronym>RAID-Z</acronym> 同樣層級的保護。由單一磁碟所建立的儲存池可以使用 <command>zpool attach</command> 來加入額外的磁碟到 vdev，來建立鏡像。<command>zpool attach</command> 也可用來加入額外的磁碟到鏡像群組，來增加備援與讀取效率。若使用的磁碟已有分割區，可以複製該磁碟的分割區配置到另一個，使用 <command>gpart backup</command> 與 <command>gpart restore</command> 可讓這件事變的很簡單。</para>

      <para>加入 <replaceable>ada1p3</replaceable> 來升級單一磁碟串連 (stripe) vdev <replaceable>ada0p3</replaceable> 採用鏡像型態 (mirror)：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          ada0p3    ONLINE       0     0     0

errors: No known data errors
<prompt>#</prompt> <userinput>zpool attach <replaceable>mypool</replaceable> <replaceable>ada0p3</replaceable> <replaceable>ada1p3</replaceable></userinput>
Make sure to wait until resilver is done before rebooting.

If you boot from pool 'mypool', you may need to update
boot code on newly attached disk 'ada1p3'.

Assuming you use GPT partitioning and 'da0' is your new boot disk
you may use the following command:

        gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 da0
<prompt>#</prompt> <userinput>gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 <replaceable>ada1</replaceable></userinput>
bootcode written to ada1
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
status: One or more devices is currently being resilvered.  The pool will
        continue to function, possibly in a degraded state.
action: Wait for the resilver to complete.
  scan: resilver in progress since Fri May 30 08:19:19 2014
        527M scanned out of 781M at 47.9M/s, 0h0m to go
        527M resilvered, 67.53% done
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0  (resilvering)

errors: No known data errors
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with 0 errors on Fri May 30 08:15:58 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors</screen>

      <para>若不想選擇加入磁碟到既有的 vdev ，對 <acronym>RAID-Z</acronym> 來說，可選擇另一種方式，便是加入另一個 vdev 到儲存池。額外的 vdev 可以提供更高的效能，分散寫入資料到 vdev 之間，每個 vdev 會負責自己的備援。也可以混合使用不同的 vdev 型態，但並不建議，例如混合使用 <literal>mirror</literal> 與 <literal>RAID-Z</literal>，加入一個無備援的 vdev 到一個含有 mirror 或 <acronym>RAID-Z</acronym> vdev 的儲存池會讓資料損壞的風險擴大整個儲存池，由於會分散寫入資料，若在無備援的磁碟上發生故障的結果便是遺失大半寫到儲存池的資料區塊。</para>

      <para>在每個 vdev 間的資料是串連的，例如，有兩個 mirror vdev，便跟 <acronym>RAID</acronym> 10 一樣在兩個 mirror 間分散寫入資料，且會做空間的分配，因此 vdev 會在同時達到全滿 100% 的用量。若 vdev 間的可用空間量不同則會影響到效能，因為資料量會不成比例的寫入到使用量較少的 vdev。</para>

      <para>當連接額外的裝置到一個可以開機的儲存池，要記得更新 Bootcode。</para>

      <para>連接第二個 mirror 群組 (<filename>ada2p3</filename> 及 <filename>ada3p3</filename>) 到既有的 mirror：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with 0 errors on Fri May 30 08:19:35 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors
<prompt>#</prompt> <userinput>zpool add <replaceable>mypool</replaceable> mirror <replaceable>ada2p3</replaceable> <replaceable>ada3p3</replaceable></userinput>
<prompt>#</prompt> <userinput>gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 <replaceable>ada2</replaceable></userinput>
bootcode written to ada2
<prompt>#</prompt> <userinput>gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 <replaceable>ada3</replaceable></userinput>
bootcode written to ada3
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
          mirror-1  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0
            ada3p3  ONLINE       0     0     0

errors: No known data errors</screen>

      <para>現在已無法從儲存池上移除 vdev，且磁碟只能夠在有足夠備援空間的情況下從 mirror 移除，若在 mirror 群組中只剩下一個磁碟，便會取消 mirror 然後還原為 stripe，若剩下的那個磁碟故障，便會影響到整個儲存池。</para>

      <para>從一個三方 mirror 群組移除一個磁碟：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0

errors: No known data errors
<prompt>#</prompt> <userinput>zpool detach <replaceable>mypool</replaceable> <replaceable>ada2p3</replaceable></userinput>
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 in 0h0m with 0 errors on Fri May 30 08:29:51 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors</screen>
    </sect2>

    <sect2 xml:id="zfs-zpool-status">
      <title>檢查儲存池狀態</title>

      <para>儲存池的狀態很重要，若有磁碟機離線或偵測到讀取、寫入或校驗碼 (Checksum) 錯誤，對應的錯誤計數便會增加。<command>status</command> 會顯示儲存池中每一個磁碟機的設定與狀態及整個儲存池的狀態。需要處置的方式與有關最近清潔 (<link linkend="zfs-zpool-scrub"><command>Scrub</command></link>) 的詳細資訊也會一併顯示。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: scrub repaired 0 in 2h25m with 0 errors on Sat Sep 14 04:25:50 2013
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          raidz2-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0
            ada3p3  ONLINE       0     0     0
            ada4p3  ONLINE       0     0     0
            ada5p3  ONLINE       0     0     0

errors: No known data errors</screen>
    </sect2>

    <sect2 xml:id="zfs-zpool-clear">
      <title>清除錯誤</title>

      <para>當偵測到錯誤發生，讀取、寫入或校驗碼 (Checksum) 的計數便會增加。使用 <command>zpool clear <replaceable>mypool</replaceable></command> 可以清除錯誤訊息及重置計數。清空錯誤狀態對當儲存池發生錯誤要使用自動化 Script 通知的管理者來說會很重要，因在舊的錯誤尚未清除前不會回報後續的錯誤。</para>
    </sect2>

    <sect2 xml:id="zfs-zpool-replace">
      <title>更換運作中的裝置</title>

      <para>可能有一些情況會需要更換磁碟為另一個磁碟，當要更換運作中的磁碟，此程序會維持舊有的磁碟在更換的過程為上線的狀態，儲存池不會進入降級 (<link linkend="zfs-term-degraded">Degraded</link>) 的狀態，來減少資料遺失的風險。<command>zpool replace</command> 會複製所有舊磁碟的資料到新磁碟，操作完成之後舊磁碟便會與 vdev 中斷連線。若新磁碟容量較舊磁碟大，也可以會增加儲存池來使用新的空間，請參考 <link linkend="zfs-zpool-online">擴增儲存池</link>。</para>

      <para>更換儲存池中正在運作的狀置：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0

errors: No known data errors
<prompt>#</prompt> <userinput>zpool replace <replaceable>mypool</replaceable> <replaceable>ada1p3</replaceable> <replaceable>ada2p3</replaceable></userinput>
Make sure to wait until resilver is done before rebooting.

If you boot from pool 'zroot', you may need to update
boot code on newly attached disk 'ada2p3'.

Assuming you use GPT partitioning and 'da0' is your new boot disk
you may use the following command:

        gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 da0
<prompt>#</prompt> <userinput>gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i 1 <replaceable>ada2</replaceable></userinput>
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
status: One or more devices is currently being resilvered.  The pool will
        continue to function, possibly in a degraded state.
action: Wait for the resilver to complete.
  scan: resilver in progress since Mon Jun  2 14:21:35 2014
        604M scanned out of 781M at 46.5M/s, 0h0m to go
        604M resilvered, 77.39% done
config:

        NAME             STATE     READ WRITE CKSUM
        mypool           ONLINE       0     0     0
          mirror-0       ONLINE       0     0     0
            ada0p3       ONLINE       0     0     0
            replacing-1  ONLINE       0     0     0
              ada1p3     ONLINE       0     0     0
              ada2p3     ONLINE       0     0     0  (resilvering)

errors: No known data errors
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with 0 errors on Mon Jun  2 14:21:52 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0

errors: No known data errors</screen>
    </sect2>

    <sect2 xml:id="zfs-zpool-resilver">
      <title>處理故障裝置</title>

      <para>當儲存池中的磁碟故障，該故障硬碟所屬的 vdev 便會進入降級 (<link linkend="zfs-term-degraded">Degraded</link>) 狀態，所有的資料仍可使用，但效能可能會降低，因為遺失的資料必須從可用的備援資料計算才能取得。要將 vdev 恢復完整運作的狀態必須更換故障的實體裝置。然後 <acronym>ZFS</acronym> 便會開始修復 (<link linkend="zfs-term-resilver">Resilver</link>，古代鏡子的修復稱 Resilver) 作業，會從可用的備援資料計算出故障磁碟中的資料並寫入到替換的裝置上。完成後 vdev 便會重新返回上線 (<link linkend="zfs-term-online">Online</link>) 的狀態。</para>

      <para>若 vdev 沒有任何備援資料或有多個裝置故障，沒有足夠的備援資料可以補償，儲存池便會進入故障 (<link linkend="zfs-term-faulted">Faulted</link>) 的狀態。</para>

      <para>更換故障的磁碟時，故障磁碟的名稱會更換為裝置的 <acronym>GUID</acronym>，若替換裝置要使用相同的裝置名稱，則在 <command>zpool replace</command> 不須加上新裝置名稱參數。</para>

      <para>使用 <command>zpool replace</command> 更換故障的磁碟：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: DEGRADED
status: One or more devices could not be opened.  Sufficient replicas exist for
        the pool to continue functioning in a degraded state.
action: Attach the missing device and online it using 'zpool online'.
   see: http://illumos.org/msg/ZFS-8000-2Q
  scan: none requested
config:

        NAME                    STATE     READ WRITE CKSUM
        mypool                  DEGRADED     0     0     0
          mirror-0              DEGRADED     0     0     0
            ada0p3              ONLINE       0     0     0
            316502962686821739  UNAVAIL      0     0     0  was /dev/ada1p3

errors: No known data errors
<prompt>#</prompt> <userinput>zpool replace <replaceable>mypool</replaceable> <replaceable>316502962686821739</replaceable> <replaceable>ada2p3</replaceable></userinput>
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: DEGRADED
status: One or more devices is currently being resilvered.  The pool will
        continue to function, possibly in a degraded state.
action: Wait for the resilver to complete.
  scan: resilver in progress since Mon Jun  2 14:52:21 2014
        641M scanned out of 781M at 49.3M/s, 0h0m to go
        640M resilvered, 82.04% done
config:

        NAME                        STATE     READ WRITE CKSUM
        mypool                      DEGRADED     0     0     0
          mirror-0                  DEGRADED     0     0     0
            ada0p3                  ONLINE       0     0     0
            replacing-1             UNAVAIL      0     0     0
              15732067398082357289  UNAVAIL      0     0     0  was /dev/ada1p3/old
              ada2p3                ONLINE       0     0     0  (resilvering)

errors: No known data errors
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: resilvered 781M in 0h0m with 0 errors on Mon Jun  2 14:52:38 2014
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0

errors: No known data errors</screen>
    </sect2>

    <sect2 xml:id="zfs-zpool-scrub">
      <title>清潔儲存池</title>

      <para>建議儲存池要定期清潔 (<link linkend="zfs-term-scrub">Scrub</link>)，最好是每一個月清潔一次。 <command>scrub</command> 作業對磁碟操作非常的密集，在執行時會降低磁碟的效能。在排程 <command>scrub</command> 時避免在使用高峰的時期，或使用 <link linkend="zfs-advanced-tuning-scrub_delay"><varname>vfs.zfs.scrub_delay</varname></link> 來調整 <command>scrub</command> 的相對優先權來避免影響其他的工作。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool scrub <replaceable>mypool</replaceable></userinput>
<prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
  scan: scrub in progress since Wed Feb 19 20:52:54 2014
        116G scanned out of 8.60T at 649M/s, 3h48m to go
        0 repaired, 1.32% done
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          raidz2-0  ONLINE       0     0     0
            ada0p3  ONLINE       0     0     0
            ada1p3  ONLINE       0     0     0
            ada2p3  ONLINE       0     0     0
            ada3p3  ONLINE       0     0     0
            ada4p3  ONLINE       0     0     0
            ada5p3  ONLINE       0     0     0

errors: No known data errors</screen>

      <para>若發生需要取消清潔作業的事，可以下 <command>zpool scrub -s <replaceable>mypool</replaceable></command>。</para>
    </sect2>

    <sect2 xml:id="zfs-zpool-selfheal">
      <title>自我修復</title>

      <para>校驗碼 (Checksum) 會隨資料區塊一併儲存，這使得檔案系統可以做到<emphasis>自我修復</emphasis>。這個功能可以在校驗碼與儲存池中的另一個裝置不同時自動修復資料。舉例來說，有兩個磁碟做鏡像 (Mirror)，其中一個磁碟機開始失常並無法正常儲存資料，甚至是資料放在長期封存的儲存裝置上，已經很久沒有被存取。傳統的檔案系統需要執行演算法來檢查並修復資料如 <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry>，這些指令耗費時間，且在嚴重時需要管理者手動決定要做那一種修復操作。當 <acronym>ZFS</acronym> 偵測到資料區塊的校驗碼不對時，它除了把資料交給需要的應用程式外，也會修正在磁碟上錯誤的資料。這件事不需要與系統管理者作任何互動便會在一般的儲存池操作時完成。</para>

      <para>接下來的例子會示範自我修復會如何運作。建立一個使用磁碟 <filename>/dev/ada0</filename> 及 <filename>/dev/ada1</filename> 做鏡像的儲存池。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool create <replaceable>healer</replaceable> mirror <replaceable>/dev/ada0</replaceable> <replaceable>/dev/ada1</replaceable></userinput>
<prompt>#</prompt> <userinput>zpool status <replaceable>healer</replaceable></userinput>
  pool: healer
 state: ONLINE
  scan: none requested
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       0     0     0
      mirror-0  ONLINE       0     0     0
       ada0     ONLINE       0     0     0
       ada1     ONLINE       0     0     0

errors: No known data errors
<prompt>#</prompt> <userinput>zpool list</userinput>
NAME     SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
healer   960M  92.5K   960M         -         -     0%    0%  1.00x  ONLINE  -</screen>

      <para>將部份需要使用自我修復功能來保護的重要資料複製到該儲存池，建立一個儲存池的校驗碼供稍後做比較時使用。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cp /some/important/data /healer</userinput>
<prompt>#</prompt> <userinput>zfs list</userinput>
NAME     SIZE  ALLOC   FREE    CAP  DEDUP  HEALTH  ALTROOT
healer   960M  67.7M   892M     7%  1.00x  ONLINE  -
<prompt>#</prompt> <userinput>sha1 /healer &gt; checksum.txt</userinput>
<prompt>#</prompt> <userinput>cat checksum.txt</userinput>
SHA1 (/healer) = 2753eff56d77d9a536ece6694bf0a82740344d1f</screen>

      <para>寫入隨機的資料到鏡像的第一個磁碟來模擬資料損毀的情況。要避免 <acronym>ZFS</acronym> 偵測到錯誤時馬上做修復，接著要將儲存池匯出，待模擬資料損毀之後再匯入。</para>

      <warning>
	<para>這是一個危險的操作，會破壞重要的資料。在這裡使用僅為了示範用，不應在儲存池正常運作時嘗試使用，也不應將這個故意損壞資料的例子用在任何其他的檔案系統上，所以請勿使用任何不屬於該儲存池的其他磁碟裝置名稱並確定在執行指令前已對儲存池做正確的備份！</para>
      </warning>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool export <replaceable>healer</replaceable></userinput>
<prompt>#</prompt> <userinput>dd if=/dev/random of=/dev/ada1 bs=1m count=200</userinput>
200+0 records in
200+0 records out
209715200 bytes transferred in 62.992162 secs (3329227 bytes/sec)
<prompt>#</prompt> <userinput>zpool import healer</userinput></screen>

      <para>儲存池的狀態顯示有一個裝置發生了錯誤。注意，應用程式從儲存池讀取的資料中並沒有任何的錯誤資料，<acronym>ZFS</acronym> 會自 <filename>ada0</filename> 裝置提供有正確校驗碼的資料。結果裡面 <literal>CKSUM</literal> 欄位含有非零值便是有錯誤校驗碼的裝置。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status <replaceable>healer</replaceable></userinput>
    pool: healer
   state: ONLINE
  status: One or more devices has experienced an unrecoverable error.  An
          attempt was made to correct the error.  Applications are unaffected.
  action: Determine if the device needs to be replaced, and clear the errors
          using 'zpool clear' or replace the device with 'zpool replace'.
     see: http://illumos.org/msg/ZFS-8000-4J
    scan: none requested
  config:

      NAME        STATE     READ WRITE CKSUM
      healer      ONLINE       0     0     0
        mirror-0  ONLINE       0     0     0
         ada0     ONLINE       0     0     0
         ada1     ONLINE       0     0     1

errors: No known data errors</screen>

      <para>錯誤已經被偵測到並且由未被影響的 <filename>ada0</filename> 鏡像磁碟上的備援提供資料。可與原來的校驗碼做比較來看儲存池是否已修復為一致。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sha1 /healer &gt;&gt; checksum.txt</userinput>
<prompt>#</prompt> <userinput>cat checksum.txt</userinput>
SHA1 (/healer) = 2753eff56d77d9a536ece6694bf0a82740344d1f
SHA1 (/healer) = 2753eff56d77d9a536ece6694bf0a82740344d1f</screen>

      <para>儲存池在故意竄改資料前與後的兩個校驗碼仍相符顯示了 <acronym>ZFS</acronym> 在校驗碼不同時偵測與自動修正錯誤的能力。注意，這只在當儲存池中有足夠的備援時才可做到，由單一裝置組成的儲存池並沒有自我修復的能力。這也是為什麼在 <acronym>ZFS</acronym> 中校驗碼如此重要，任何原因都不該關閉。不需要 <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry> 或類似的檔案系統一致性檢查程式便能夠偵測與修正問題，且儲存儲存池在發生問題時仍可正常運作。接著需要做清潔作業來覆蓋在 <filename>ada1</filename> 上的錯誤資料。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool scrub <replaceable>healer</replaceable></userinput>
<prompt>#</prompt> <userinput>zpool status <replaceable>healer</replaceable></userinput>
  pool: healer
 state: ONLINE
status: One or more devices has experienced an unrecoverable error.  An
            attempt was made to correct the error.  Applications are unaffected.
action: Determine if the device needs to be replaced, and clear the errors
            using 'zpool clear' or replace the device with 'zpool replace'.
   see: http://illumos.org/msg/ZFS-8000-4J
  scan: scrub in progress since Mon Dec 10 12:23:30 2012
        10.4M scanned out of 67.0M at 267K/s, 0h3m to go
        9.63M repaired, 15.56% done
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       0     0     0
      mirror-0  ONLINE       0     0     0
       ada0     ONLINE       0     0     0
       ada1     ONLINE       0     0   627  (repairing)

errors: No known data errors</screen>

      <para>清潔作業會從 <filename>ada0</filename> 讀取資料並重新寫入任何在 <filename>ada1</filename> 上有錯誤校驗碼的資料。這個操作可以由 <command>zpool status</command> 的輸出中呈現修復中 <literal>(repairing)</literal> 的項目來辨識。這個作業完成後，儲存池的狀態會更改為：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status <replaceable>healer</replaceable></userinput>
  pool: healer
 state: ONLINE
status: One or more devices has experienced an unrecoverable error.  An
        attempt was made to correct the error.  Applications are unaffected.
action: Determine if the device needs to be replaced, and clear the errors
             using 'zpool clear' or replace the device with 'zpool replace'.
   see: http://illumos.org/msg/ZFS-8000-4J
  scan: scrub repaired 66.5M in 0h2m with 0 errors on Mon Dec 10 12:26:25 2012
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       0     0     0
      mirror-0  ONLINE       0     0     0
       ada0     ONLINE       0     0     0
       ada1     ONLINE       0     0 2.72K

errors: No known data errors</screen>

      <para>清潔操作完成便同步了 <filename>ada0</filename> 到 <filename>ada1</filename> 間的所有資料。執行 <command>zpool clear</command> 可以清除 (<link linkend="zfs-zpool-clear">Clear</link>) 儲存池狀態的錯誤訊息。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool clear <replaceable>healer</replaceable></userinput>
<prompt>#</prompt> <userinput>zpool status <replaceable>healer</replaceable></userinput>
  pool: healer
 state: ONLINE
  scan: scrub repaired 66.5M in 0h2m with 0 errors on Mon Dec 10 12:26:25 2012
config:

    NAME        STATE     READ WRITE CKSUM
    healer      ONLINE       0     0     0
      mirror-0  ONLINE       0     0     0
       ada0     ONLINE       0     0     0
       ada1     ONLINE       0     0     0

errors: No known data errors</screen>

      <para>儲存池現在恢復完整運作的狀態且清除所有的錯誤了。</para>
    </sect2>

    <sect2 xml:id="zfs-zpool-online">
      <title>擴增儲存池</title>

      <para>可用的備援儲存池大小會受到每個 vdev 中容量最小的裝置限制。最小的裝置可以替換成較大的裝置，在更換 (<link linkend="zfs-zpool-replace">Replace</link>) 或修復 (<link linkend="zfs-term-resilver">Resilver</link>) 作業後，儲存池可以成長到該新裝置的可用容量。例如，要做一個 1 TB 磁碟機與一個 2 TB 磁碟機的鏡像，可用的空間會是 1 TB，當 1 TB 磁碟機備更換成另一個 2 TB 的磁碟機時，修復程序會複製既有的資料到新的磁碟機，由於現在兩個裝置都有 2 TB 的容量，所以鏡像的可用空間便會成長到 2 TB。</para>

      <para>可以在每個裝置用 <command>zpool online -e</command> 來觸發擴充的動作，在擴充完所有裝置後，儲存池便可使用額外的空間。</para>
    </sect2>

    <sect2 xml:id="zfs-zpool-import">
      <title>匯入與匯出儲存池</title>

      <para>儲存池在移動到其他系統之前需要做匯出 (<emphasis>Export</emphasis>)，會卸載所有的資料集，然後標記每個裝置為已匯出，為了避免被其他磁碟子系統存取，因此仍會鎖定這些裝置。這個動作讓儲存池可以在支援 <acronym>ZFS</acronym> 的其他機器、其他作業系統做匯入 (<emphasis>Import</emphasis>)，甚至是不同的硬體架構 (有一些注意事項，請參考 <citerefentry><refentrytitle>zpool</refentrytitle><manvolnum>8</manvolnum></citerefentry>)。當資料集有被開啟的檔案，可使用 <command>zpool export -f</command> 來強制匯出儲存池，使用這個指令需要小心，資料集是被強制卸載的，因此有可能造成在該資料集開啟檔案的應用程式發生無法預期的結果。</para>

      <para>匯出未使用的儲存池：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool export mypool</userinput></screen>

      <para>匯入儲存池會自動掛載資料集，若不想自動掛載，可以使用 <command>zpool import -N</command>。<command>zpool import -o</command> 可以設定在匯入時暫時使用的屬性。<command>zpool import altroot=</command> 允許匯入時指定基礎掛載點 (Base mount point) 來替換檔案系統根目錄。若儲存池先前用在不同的系統且不正常匯出，可能會需要使用 <command>zpool import -f</command> 來強制匯入。<command>zpool import -a</command> 會匯入所有沒有被其他系統使用的儲存池。</para>

      <para>列出所有可以匯入的儲存池：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool import</userinput>
   pool: mypool
     id: 9930174748043525076
  state: ONLINE
 action: The pool can be imported using its name or numeric identifier.
 config:

        mypool      ONLINE
          ada2p3    ONLINE</screen>

      <para>使用替代的根目錄匯入儲存池：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool import -o altroot=<replaceable>/mnt</replaceable> <replaceable>mypool</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs list</userinput>
zfs list
NAME                 USED  AVAIL  REFER  MOUNTPOINT
mypool               110K  47.0G    31K  /mnt/mypool</screen>
    </sect2>

    <sect2 xml:id="zfs-zpool-upgrade">
      <title>升級儲存儲存池</title>

      <para>在升級 FreeBSD 之後或儲存池是由其他使用舊版 <acronym>ZFS</acronym> 的系統匯入，儲存池可以手動升級到最新版本的 <acronym>ZFS</acronym> 來支援新的功能。在升級前請評估儲存池是否還要在舊的系統做匯入，由於升級是一個單向的程序，舊的儲存池可以升級，但有新功能的儲存池無法降級。</para>

      <para>升級一個 v28 的儲存以支援功能旗標 (<literal>Feature Flags</literal>)：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
status: The pool is formatted using a legacy on-disk format.  The pool can
        still be used, but some features are unavailable.
action: Upgrade the pool using 'zpool upgrade'.  Once this is done, the
        pool will no longer be accessible on software that does not support feat
        flags.
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
	    ada0    ONLINE       0     0     0
	    ada1    ONLINE       0     0     0

errors: No known data errors
<prompt>#</prompt> <userinput>zpool upgrade</userinput>
This system supports ZFS pool feature flags.

The following pools are formatted with legacy version numbers and can
be upgraded to use feature flags.  After being upgraded, these pools
will no longer be accessible by software that does not support feature
flags.

VER  POOL
---  ------------
28   mypool

Use 'zpool upgrade -v' for a list of available legacy versions.
Every feature flags pool has all supported features enabled.
<prompt>#</prompt> <userinput>zpool upgrade mypool</userinput>
This system supports ZFS pool feature flags.

Successfully upgraded 'mypool' from version 28 to feature flags.
Enabled the following features on 'mypool':
  async_destroy
  empty_bpobj
  lz4_compress
  multi_vdev_crash_dump</screen>

      <para><acronym>ZFS</acronym> 的新功能在 <command>zpool upgrade</command> 尚未完成之前無法使用。可以用 <command>zpool upgrade -v</command> 來查看升級後有那些新功能，也同時會列出已經支援那些功能。</para>

      <para>升級儲存池支援新版的功能旗標 (Feature flags)：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool status</userinput>
  pool: mypool
 state: ONLINE
status: Some supported features are not enabled on the pool. The pool can
        still be used, but some features are unavailable.
action: Enable all features using 'zpool upgrade'. Once this is done,
        the pool may no longer be accessible by software that does not support
        the features. See zpool-features(7) for details.
  scan: none requested
config:

        NAME        STATE     READ WRITE CKSUM
        mypool      ONLINE       0     0     0
          mirror-0  ONLINE       0     0     0
	    ada0    ONLINE       0     0     0
	    ada1    ONLINE       0     0     0

errors: No known data errors
<prompt>#</prompt> <userinput>zpool upgrade</userinput>
This system supports ZFS pool feature flags.

All pools are formatted using feature flags.


Some supported features are not enabled on the following pools. Once a
feature is enabled the pool may become incompatible with software
that does not support the feature. See zpool-features(7) for details.

POOL  FEATURE
---------------
zstore
      multi_vdev_crash_dump
      spacemap_histogram
      enabled_txg
      hole_birth
      extensible_dataset
      bookmarks
      filesystem_limits
<prompt>#</prompt> <userinput>zpool upgrade mypool</userinput>
This system supports ZFS pool feature flags.

Enabled the following features on 'mypool':
  spacemap_histogram
  enabled_txg
  hole_birth
  extensible_dataset
  bookmarks
  filesystem_limits</screen>

      <warning>
	<para>在使用儲存池來開機的系統上的 Boot code 也必須一併更新來支援新的儲存池版本，可在含有 Boot code 的分割區使用 <command>gpart bootcode</command> 來更新。目前有兩種 Boot code 可使用，需視系統開機的方式使用：<acronym>GPT</acronym> (最常用的選項) 以及 <acronym>EFI</acronym> (較新的系統)。</para>

	<para>針對傳統使用 GPT 開機的系統，可以使用以下指令：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>gpart bootcode -b /boot/pmbr -p /boot/gptzfsboot -i <replaceable>1</replaceable> <replaceable>ada1</replaceable></userinput></screen>

	<para>針對使用 EFI 開機的系統可以執行以下指令：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>gpart bootcode -p /boot/boot1.efifat -i <replaceable>1</replaceable> <replaceable>ada1</replaceable></userinput></screen>

	<para>套用 Boot code 到所有儲存池中可開機的磁碟。請參考 <citerefentry><refentrytitle>gpart</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以取得更多資訊。</para>
      </warning>
    </sect2>

    <sect2 xml:id="zfs-zpool-history">
      <title>顯示已記錄的儲存池歷史日誌</title>

      <para>修改儲存池的指令會被記錄下來，會記錄的動作包含資料集的建立，屬性更改或更換磁碟。這個歷史記錄用來查看儲存池是如何建立、由誰執行、什麼動作及何時。歷史記錄並非儲存在日誌檔 (Log file)，而是儲存在儲存池。查看這個歷史記錄的指令名稱為 <command>zpool history</command>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool history</userinput>
History for 'tank':
2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1
2013-02-27.18:50:58 zfs set atime=off tank
2013-02-27.18:51:09 zfs set checksum=fletcher4 tank
2013-02-27.18:51:18 zfs create tank/backup</screen>

      <para>輸出結果顯示曾在該儲存池上執行的 <command>zpool</command> 與 <command>zfs</command> 指令以及時間戳記。只有會修改儲存池或類似的指令會被記錄下來，像是 <command>zfs list</command> 這種指令並不會被記錄。當不指定儲存池名稱時，會列出所有儲存池的歷史記錄。</para>

      <para>在提供選項 <option>-i</option> 或 <option>-l</option> 時 <command>zpool history</command> 可以顯更多詳細資訊。<option>-i</option> 會顯示使用者觸發的事件外，也會顯示內部記錄的  <acronym>ZFS</acronym> 事件。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool history -i</userinput>
History for 'tank':
2013-02-26.23:02:35 [internal pool create txg:5] pool spa 28; zfs spa 28; zpl 5;uts  9.1-RELEASE 901000 amd64
2013-02-27.18:50:53 [internal property set txg:50] atime=0 dataset = 21
2013-02-27.18:50:58 zfs set atime=off tank
2013-02-27.18:51:04 [internal property set txg:53] checksum=7 dataset = 21
2013-02-27.18:51:09 zfs set checksum=fletcher4 tank
2013-02-27.18:51:13 [internal create txg:55] dataset = 39
2013-02-27.18:51:18 zfs create tank/backup</screen>

      <para>更多詳細的資訊可加上 <option>-l</option> 來取得，歷史記錄會以較長的格式顯示，包含的資訊有執行指令的使用者名稱、主機名稱以及更改的項目。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool history -l</userinput>
History for 'tank':
2013-02-26.23:02:35 zpool create tank mirror /dev/ada0 /dev/ada1 [user 0 (root) on :global]
2013-02-27.18:50:58 zfs set atime=off tank [user 0 (root) on myzfsbox:global]
2013-02-27.18:51:09 zfs set checksum=fletcher4 tank [user 0 (root) on myzfsbox:global]
2013-02-27.18:51:18 zfs create tank/backup [user 0 (root) on myzfsbox:global]</screen>

      <para>輸出結果顯示 <systemitem class="username">root</systemitem> 使用者使用 <filename>/dev/ada0</filename> 及 <filename>/dev/ada1</filename> 建立鏡像的儲存池。主機名稱 <systemitem class="systemname">myzfsbox</systemitem> 在建立完儲存池後也同樣會顯示。由於儲存池可以從一個系統匯出再匯入到另一個系統，因此主機名稱也很重要，這樣一來可以清楚的辦識在其他系統上執行的每一個指令的主機名稱。</para>

      <para>兩個 <command>zpool history</command> 選項可以合併使用來取得最完整的儲存池詳細資訊。儲存池歷史記錄在追蹤執行什麼動作或要取得除錯所需的輸出結果提供了非常有用的資訊。</para>
    </sect2>

    <sect2 xml:id="zfs-zpool-iostat">
      <title>監視效能</title>

      <para>內建的監視系統可以即時顯示儲存池的 <acronym>I/O</acronym> 統計資訊。它會顯示儲存池剩餘的空間與使用的空間，每秒執行了多少讀取與寫入的操作，有多少 <acronym>I/O</acronym> 頻寬被使用。預設會監視所有在系統中的儲存池都並顯示出來，可以提供儲存池名稱來只顯示該儲存池的監視資訊。舉一個簡單的例子：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool iostat</userinput>
               capacity     operations    bandwidth
pool        alloc   free   read  write   read  write
----------  -----  -----  -----  -----  -----  -----
data         288G  1.53T      2     11  11.3K  57.1K</screen>

      <para>要持續監視 <acronym>I/O</acronym> 的活動可以在最後的參數指定一個數字，這個數字代表每次更新資訊所間隔的秒數。在每次經過間隔的時間後會列出新一行的統計資訊，按下 <keycombo action="simul"> <keycap>Ctrl</keycap> <keycap>C</keycap> </keycombo> 可以中止監視。或者在指令列的間隔時間之後再指定一個數字，代表總共要顯示的統計資訊筆數。</para>

      <para>使用 <option>-v</option> 可以顯示更詳細的 <acronym>I/O</acronym> 統計資訊。每個在儲存池中的裝置會以一行統計資訊顯示。這可以幫助了解每一個裝置做了多少讀取與寫入的操作，並可協助確認是否有各別裝置拖慢了整個儲存池的速度。以下範例會顯示有兩個裝置的鏡像儲存池：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool iostat -v </userinput>
                            capacity     operations    bandwidth
pool                     alloc   free   read  write   read  write
-----------------------  -----  -----  -----  -----  -----  -----
data                      288G  1.53T      2     12  9.23K  61.5K
  mirror                  288G  1.53T      2     12  9.23K  61.5K
    ada1                     -      -      0      4  5.61K  61.7K
    ada2                     -      -      1      4  5.04K  61.7K
-----------------------  -----  -----  -----  -----  -----  -----</screen>
    </sect2>

    <sect2 xml:id="zfs-zpool-split">
      <title>分割儲存儲存池</title>

      <para>由一個或多個鏡像 vdev 所組成的儲存池可以切分開成兩個儲存池。除非有另外指定，否則每個鏡像的最後一個成員會被分離來然用來建立一個含有相同資料的新儲存池。在做這個操作的第一次應先使用 <option>-n</option>，會顯示預計會做的操作而不會真的執行，這可以協助確認操作是否與使用者所要的相同。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="zfs-zfs">
    <title><command>zfs</command> 管理</title>

    <para><command>zfs</command> 工具負責建立、摧毀與管理在一個儲存池中所有的 <acronym>ZFS</acronym> 資料集。儲存池使用 <link linkend="zfs-zpool"><command>zpool</command></link> 來管理。</para>

    <sect2 xml:id="zfs-zfs-create">
      <title>建立與摧毀資料集</title>

      <para>不同於傳統的磁碟與磁碟區管理程式 (Volume manager) ，在 <acronym>ZFS</acronym> 中的空間並<emphasis>不</emphasis>會預先分配。傳統的檔案系統在分割與分配空間完後，若沒有增加新的磁碟便無法再增加額外的檔案系統。在 <acronym>ZFS</acronym>，可以隨時建立新的檔案系統，每個資料集 (<link linkend="zfs-term-dataset"><emphasis>Dataset</emphasis></link>) 都有自己的屬性，包含壓縮 (Compression)、去重複 (Deduplication)、快取 (Caching) 與配額 (Quota) 功能以及其他有用的屬性如唯讀 (Readonly)、區分大小寫 (Case sensitivity)、網路檔案分享 (Network file sharing) 以及掛載點 (Mount point)。資料集可以存在於其他資料集中，且子資料集會繼承其父資料集的屬性。每個資料集都可以作為一個單位來管理、委託 (<link linkend="zfs-zfs-allow">Delegate</link>)、備份 (<link linkend="zfs-zfs-send">Replicate</link>)、快照 (<link linkend="zfs-zfs-snapshot">Snapshot</link>)、監禁 (<link linkend="zfs-zfs-jail">Jail</link>) 與摧毀 (Destroy)，替每種不同類型或集合的檔案建立各別的資料集還有許多的好處。唯一的缺點是在當有非常大數量的資料集時，部份指令例如 <command>zfs list</command> 會變的較緩慢，且掛載上百個或其至上千個資料集可能會使 FreeBSD 的開機程序變慢。</para>

      <para>建立一個新資料集並開啟 <link linkend="zfs-term-compression-lz4">LZ4 壓縮</link>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs list</userinput>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                781M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.20M  93.2G   608K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/tmp        152K  93.2G   152K  /var/tmp
<prompt>#</prompt> <userinput>zfs create -o compress=lz4 <replaceable>mypool/usr/mydataset</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs list</userinput>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 781M  93.2G   144K  none
mypool/ROOT            777M  93.2G   144K  none
mypool/ROOT/default    777M  93.2G   777M  /
mypool/tmp             176K  93.2G   176K  /tmp
mypool/usr             704K  93.2G   144K  /usr
mypool/usr/home        184K  93.2G   184K  /usr/home
mypool/usr/mydataset  87.5K  93.2G  87.5K  /usr/mydataset
mypool/usr/ports       144K  93.2G   144K  /usr/ports
mypool/usr/src         144K  93.2G   144K  /usr/src
mypool/var            1.20M  93.2G   610K  /var
mypool/var/crash       148K  93.2G   148K  /var/crash
mypool/var/log         178K  93.2G   178K  /var/log
mypool/var/mail        144K  93.2G   144K  /var/mail
mypool/var/tmp         152K  93.2G   152K  /var/tmp</screen>

      <para>摧毀資料集會比刪除所有在資料集上所殘留的檔案來的快，由於摧毀資料集並不會掃描所有檔案並更新所有相關的 Metadata。</para>

      <para>摧毀先前建立的資料集：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs list</userinput>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 880M  93.1G   144K  none
mypool/ROOT            777M  93.1G   144K  none
mypool/ROOT/default    777M  93.1G   777M  /
mypool/tmp             176K  93.1G   176K  /tmp
mypool/usr             101M  93.1G   144K  /usr
mypool/usr/home        184K  93.1G   184K  /usr/home
mypool/usr/mydataset   100M  93.1G   100M  /usr/mydataset
mypool/usr/ports       144K  93.1G   144K  /usr/ports
mypool/usr/src         144K  93.1G   144K  /usr/src
mypool/var            1.20M  93.1G   610K  /var
mypool/var/crash       148K  93.1G   148K  /var/crash
mypool/var/log         178K  93.1G   178K  /var/log
mypool/var/mail        144K  93.1G   144K  /var/mail
mypool/var/tmp         152K  93.1G   152K  /var/tmp
<prompt>#</prompt> <userinput>zfs destroy <replaceable>mypool/usr/mydataset</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs list</userinput>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                781M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.21M  93.2G   612K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/tmp        152K  93.2G   152K  /var/tmp</screen>

      <para>在最近版本的 <acronym>ZFS</acronym>，<command>zfs destroy</command> 是非同步的，且釋放出的空間會許要花費數分鐘才會出現在儲存池上，可使用 <command>zpool get freeing <replaceable>poolname</replaceable></command> 來查看 <literal>freeing</literal> 屬性，這個屬性會指出資料集在背景已經釋放多少資料區塊了。若有子資料集，如快照 (<link linkend="zfs-term-snapshot">Snapshot</link>) 或其他資料集存在的話，則會無法摧毀父資料集。要摧毀一個資料集及其所有子資料集，可使用 <option>-r</option> 來做遞迴摧毀資料集及其所有子資料集，可用 <option>-n</option> <option>-v</option> 來列出會被這個操作所摧毀的資料集及快照，而不會真的摧毀，因摧毀快照所釋放出的空間也會同時顯示。</para>
    </sect2>

    <sect2 xml:id="zfs-zfs-volume">
      <title>建立與摧毀磁碟區</title>

      <para>磁碟區 (Volume) 是特殊類型的資料集，不會被掛載成一個檔案系統，而是會被當做儲存區塊裝置出現在 <filename>/dev/zvol/<replaceable>poolname</replaceable>/<replaceable>dataset</replaceable></filename> 下。這讓磁碟區可供其他檔案系統使用、拿來備份虛擬機器的磁碟或是使用 <acronym>iSCSI</acronym> 或 <acronym>HAST</acronym> 通訊協定匯出。</para>

      <para>磁碟區可以被格式化成任何檔案系統，或不使用檔案系統來儲存原始資料。對一般使用者，磁碟區就像是一般的磁碟，可以放置一般的檔案系統在這些 <emphasis>zvols</emphasis> 上，並提供一般磁碟或檔案系統一般所沒有的功能。例如，使用壓縮屬性在一個 250 MB 的磁碟區可建立一個壓縮的 <acronym>FAT</acronym> 檔案系統。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs create -V 250m -o compression=on tank/fat32</userinput>
<prompt>#</prompt> <userinput>zfs list tank</userinput>
NAME USED AVAIL REFER MOUNTPOINT
tank 258M  670M   31K /tank
<prompt>#</prompt> <userinput>newfs_msdos -F32 /dev/zvol/tank/fat32</userinput>
<prompt>#</prompt> <userinput>mount -t msdosfs /dev/zvol/tank/fat32 /mnt</userinput>
<prompt>#</prompt> <userinput>df -h /mnt | grep fat32</userinput>
Filesystem           Size Used Avail Capacity Mounted on
/dev/zvol/tank/fat32 249M  24k  249M     0%   /mnt
<prompt>#</prompt> <userinput>mount | grep fat32</userinput>
/dev/zvol/tank/fat32 on /mnt (msdosfs, local)</screen>

      <para>摧毀一個磁碟區與摧毀一個一般的檔案系統資料集差不多。操作上幾乎是即時的，但在背景會需要花費數分鐘來讓釋放空間再次可用。</para>
    </sect2>

    <sect2 xml:id="zfs-zfs-rename">
      <title>重新命名資料集</title>

      <para>資料集的名稱可以使用 <command>zfs rename</command> 更改。父資料集也同樣可以使用這個指令來更改名稱。重新命名一個資料集到另一個父資料集也會更改自父資料集繼承的屬性值。重新命名資料集後，會被卸載然後重新掛載到新的位置 (依繼承的新父資料集而定)，可使用 <option>-u</option> 來避免重新掛載。</para>

      <para>重新命名一個資料集並移動該資料集到另一個父資料集：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs list</userinput>
NAME                   USED  AVAIL  REFER  MOUNTPOINT
mypool                 780M  93.2G   144K  none
mypool/ROOT            777M  93.2G   144K  none
mypool/ROOT/default    777M  93.2G   777M  /
mypool/tmp             176K  93.2G   176K  /tmp
mypool/usr             704K  93.2G   144K  /usr
mypool/usr/home        184K  93.2G   184K  /usr/home
mypool/usr/mydataset  87.5K  93.2G  87.5K  /usr/mydataset
mypool/usr/ports       144K  93.2G   144K  /usr/ports
mypool/usr/src         144K  93.2G   144K  /usr/src
mypool/var            1.21M  93.2G   614K  /var
mypool/var/crash       148K  93.2G   148K  /var/crash
mypool/var/log         178K  93.2G   178K  /var/log
mypool/var/mail        144K  93.2G   144K  /var/mail
mypool/var/tmp         152K  93.2G   152K  /var/tmp
<prompt>#</prompt> <userinput>zfs rename <replaceable>mypool/usr/mydataset</replaceable> <replaceable>mypool/var/newname</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs list</userinput>
NAME                  USED  AVAIL  REFER  MOUNTPOINT
mypool                780M  93.2G   144K  none
mypool/ROOT           777M  93.2G   144K  none
mypool/ROOT/default   777M  93.2G   777M  /
mypool/tmp            176K  93.2G   176K  /tmp
mypool/usr            616K  93.2G   144K  /usr
mypool/usr/home       184K  93.2G   184K  /usr/home
mypool/usr/ports      144K  93.2G   144K  /usr/ports
mypool/usr/src        144K  93.2G   144K  /usr/src
mypool/var           1.29M  93.2G   614K  /var
mypool/var/crash      148K  93.2G   148K  /var/crash
mypool/var/log        178K  93.2G   178K  /var/log
mypool/var/mail       144K  93.2G   144K  /var/mail
mypool/var/newname   87.5K  93.2G  87.5K  /var/newname
mypool/var/tmp        152K  93.2G   152K  /var/tmp</screen>

      <para>快照也可以像這樣重新命名，由於快照的本質使其無法被重新命名到另一個父資料集。要遞迴重新命名快照可指定 <option>-r</option>，然後在子資料集中所有同名的快照也會一併被重新命名。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs list -t snapshot</userinput>
NAME                                USED  AVAIL  REFER  MOUNTPOINT
mypool/var/newname@first_snapshot      0      -  87.5K  -
<prompt>#</prompt> <userinput>zfs rename <replaceable>mypool/var/newname@first_snapshot</replaceable> <replaceable>new_snapshot_name</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs list -t snapshot</userinput>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/newname@new_snapshot_name      0      -  87.5K  -</screen>
    </sect2>

    <sect2 xml:id="zfs-zfs-set">
      <title>設定資料集屬性</title>

      <para>每個 <acronym>ZFS</acronym> 資料集有數個屬性可以用來控制其行為。大部份的屬性會自動繼承自其父資料集，但可以被自己覆蓋。設定資料集上的屬性可使用 <command>zfs set <replaceable>property</replaceable>=<replaceable>value</replaceable> <replaceable>dataset</replaceable></command>。大部份屬性有限制可用的值，<command>zfs get</command> 會顯示每個可以使用的屬性及其可用的值。大部份可以使用 <command>zfs inherit</command> 還原成其繼承的值。</para>

      <para>也可設定使用者自訂的屬性。這些屬性也會成為資料集設定的一部份，且可以被用來提供資料集或其內容的額外資訊。要別分自訂屬性與 <acronym>ZFS</acronym> 提供的屬性，會使用冒號 (<literal>:</literal>) 建立一個自訂命名空間供自訂屬性使用。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set <replaceable>custom</replaceable>:<replaceable>costcenter</replaceable>=<replaceable>1234</replaceable> <replaceable>tank</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs get <replaceable>custom</replaceable>:<replaceable>costcenter</replaceable> <replaceable>tank</replaceable></userinput>
NAME PROPERTY           VALUE SOURCE
tank custom:costcenter  1234  local</screen>

      <para>要移除自訂屬性，可用 <command>zfs inherit</command> 加上 <option>-r</option>。若父資料集未定義任何自訂屬性，將會將該屬性完全移除 (更改動作仍會記錄於儲存池的歷史記錄)。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs inherit -r <replaceable>custom</replaceable>:<replaceable>costcenter</replaceable> <replaceable>tank</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs get <replaceable>custom</replaceable>:<replaceable>costcenter</replaceable> <replaceable>tank</replaceable></userinput>
NAME    PROPERTY           VALUE              SOURCE
tank    custom:costcenter  -                  -
<prompt>#</prompt> <userinput>zfs get all <replaceable>tank</replaceable> | grep <replaceable>custom</replaceable>:<replaceable>costcenter</replaceable></userinput>
<prompt>#</prompt></screen>

    <sect3 xml:id="zfs-zfs-set-share">
      <title>取得與設定共享屬性</title>

      <para xml:lang="en">Two commonly used and useful dataset properties are the
	<acronym>NFS</acronym> and <acronym>SMB</acronym> share
	options.  Setting these define if and how
	<acronym>ZFS</acronym> datasets may be shared on the network.
	At present, only setting sharing via <acronym>NFS</acronym> is
	supported on FreeBSD.  To get the current status of
	a share, enter:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs get sharenfs <replaceable>mypool/usr/home</replaceable></userinput>
NAME             PROPERTY  VALUE    SOURCE
mypool/usr/home  sharenfs  on       local
<prompt>#</prompt> <userinput>zfs get sharesmb <replaceable>mypool/usr/home</replaceable></userinput>
NAME             PROPERTY  VALUE    SOURCE
mypool/usr/home  sharesmb  off      local</screen>

      <para xml:lang="en">To enable sharing of a dataset, enter:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput> zfs set sharenfs=on <replaceable>mypool/usr/home</replaceable></userinput></screen>

      <para xml:lang="en">It is also possible to set additional options for sharing
      datasets through <acronym>NFS</acronym>, such as
      <option>-alldirs</option>, <option>-maproot</option> and
      <option>-network</option>.  To set additional options to a
      dataset shared through NFS, enter:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput> zfs set sharenfs="-alldirs,-maproot=<replaceable>root</replaceable>,-network=<replaceable>192.168.1.0/24</replaceable>" <replaceable>mypool/usr/home</replaceable></userinput></screen>
      </sect3>
    </sect2>

    <sect2 xml:id="zfs-zfs-snapshot">
      <title>管理快照 (Snapshot)</title>

      <para>快照 (<link linkend="zfs-term-snapshot">Snapshot</link>) 是 <acronym>ZFS</acronym> 最強大的功能之一。快照提供了資料集唯讀、單一時間點 (Point-in-Time) 的複製功能，使用了寫入時複製 (Copy-On-Write, <acronym>COW</acronym>) 的技術，可以透過保存在磁碟上的舊版資料快速的建立快照。若沒有快照存在，在資料被覆蓋或刪除時，便回收空間供未來使用。由於只記錄前一個版本與目前資料集的差異，因此快照可節省磁碟空間。快照只允許在整個資料集上使用，無法在各別檔案或目錄。當建立了一個資料集的快照時，便備份了所有內含的資料，這包含了檔案系統屬性、檔案、目錄、權限等等。第一次建立快照時只會使用到更改參照到資料區塊的空間，不會用到其他額外的空間。使用 <option>-r</option> 可以對使用同名的資料集及其所有子資料集的建立一個遞迴快照，提供一致且即時 (Moment-in-time) 的完整檔案系統快照功能，這對於那些彼此有相關或相依檔案存放在不同資料集的應用程式非常重要。不使用快照所備份的資料其實是分散不同時間點的。</para>

      <para><acronym>ZFS</acronym> 中的快照提供了多種功能，即使是在其他缺乏快照功能的檔案系統上。一個使用快照的典型例子是在安裝軟體或執行系統升級這種有風險的動作時，能有一個快速的方式可以備份檔案系統目前的狀態，若動作失敗，可以使用快照還原 (Roll back) 到與快照建立時相同的系統狀態，若升級成功，便可刪除快照來釋放空間。若沒有快照功能，升級失敗通常會需要使用備份來恢復 (Restore) 系統，而這個動作非常繁瑣、耗時且可能會需要停機一段時間系統無法使用。使用快照可以快速的還原，即使系統正在執行一般的運作，只而要短暫或甚至不需停機。能夠節省大量在有數 TB 的儲存系統上從備份複製所需資料的時間。快照並非要用來取代儲存池的完整備份，但可以用在快速且簡單的保存某個特定時間點的資料集。</para>

      <sect3 xml:id="zfs-zfs-snapshot-creation">
	<title>建立快照</title>

	<para>快照可以使用 <command>zfs snapshot <replaceable>dataset</replaceable>@<replaceable>snapshotname</replaceable></command> 來建立。加入 <option>-r</option> 可以遞迴對所有同名的子資料集建立快照。</para>

	<para>建立一個整個儲存池的遞迴快照：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>zfs list -t all</userinput>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool                                 780M  93.2G   144K  none
mypool/ROOT                            777M  93.2G   144K  none
mypool/ROOT/default                    777M  93.2G   777M  /
mypool/tmp                             176K  93.2G   176K  /tmp
mypool/usr                             616K  93.2G   144K  /usr
mypool/usr/home                        184K  93.2G   184K  /usr/home
mypool/usr/ports                       144K  93.2G   144K  /usr/ports
mypool/usr/src                         144K  93.2G   144K  /usr/src
mypool/var                            1.29M  93.2G   616K  /var
mypool/var/crash                       148K  93.2G   148K  /var/crash
mypool/var/log                         178K  93.2G   178K  /var/log
mypool/var/mail                        144K  93.2G   144K  /var/mail
mypool/var/newname                    87.5K  93.2G  87.5K  /var/newname
mypool/var/newname@new_snapshot_name      0      -  87.5K  -
mypool/var/tmp                         152K  93.2G   152K  /var/tmp
<prompt>#</prompt> <userinput>zfs snapshot -r <replaceable>mypool@my_recursive_snapshot</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs list -t snapshot</userinput>
NAME                                        USED  AVAIL  REFER  MOUNTPOINT
mypool@my_recursive_snapshot                   0      -   144K  -
mypool/ROOT@my_recursive_snapshot              0      -   144K  -
mypool/ROOT/default@my_recursive_snapshot      0      -   777M  -
mypool/tmp@my_recursive_snapshot               0      -   176K  -
mypool/usr@my_recursive_snapshot               0      -   144K  -
mypool/usr/home@my_recursive_snapshot          0      -   184K  -
mypool/usr/ports@my_recursive_snapshot         0      -   144K  -
mypool/usr/src@my_recursive_snapshot           0      -   144K  -
mypool/var@my_recursive_snapshot               0      -   616K  -
mypool/var/crash@my_recursive_snapshot         0      -   148K  -
mypool/var/log@my_recursive_snapshot           0      -   178K  -
mypool/var/mail@my_recursive_snapshot          0      -   144K  -
mypool/var/newname@new_snapshot_name           0      -  87.5K  -
mypool/var/newname@my_recursive_snapshot       0      -  87.5K  -
mypool/var/tmp@my_recursive_snapshot           0      -   152K  -</screen>

	<para>建立的快照不會顯示在一般的 <command>zfs list</command> 操作結果，要列出快照需在 <command>zfs list</command> 後加上 <option>-t snapshot</option>，使用 <option>-t all</option> 可以同時列出檔案系統的內容及快照。</para>

	<para>快照並不會直接掛載，因此 <literal>MOUNTPOINT</literal> 欄位的路徑如此顯示。在 <literal>AVAIL</literal> 欄位不會有可用的磁碟空間，因為快照建立之後便無法再寫入。比較快照與其原來建立時的資料集：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>zfs list -rt all <replaceable>mypool/usr/home</replaceable></userinput>
NAME                                    USED  AVAIL  REFER  MOUNTPOINT
mypool/usr/home                         184K  93.2G   184K  /usr/home
mypool/usr/home@my_recursive_snapshot      0      -   184K  -</screen>

	<para>同時顯示資料集與快照可以了解快照如何使用 <link linkend="zfs-term-cow">COW</link> 技術來運作。快照只會保存有更動 (<emphasis>差異</emphasis>) 的資料，並非整個檔案系統的內容，這個意思是說，快照只會在有做更動時使用一小部份的空間，複製一個檔案到該資料集，可以讓空間使用量變的更明顯，然後再做第二個快照：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cp <replaceable>/etc/passwd</replaceable> <replaceable>/var/tmp</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs snapshot <replaceable>mypool/var/tmp</replaceable>@<replaceable>after_cp</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs list -rt all <replaceable>mypool/var/tmp</replaceable></userinput>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         206K  93.2G   118K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp                   0      -   118K  -</screen>

	<para>第二快照只會包含了資料集做了複製動作後的更動，這樣的機制可以節省大量的空間。注意在複製之後快照 <replaceable>mypool/var/tmp@my_recursive_snapshot</replaceable> 於 <literal>USED</literal> 欄位中的大小也更改了，這說明了這個更動在前次快照與之後快照間的關係。</para>
      </sect3>

      <sect3 xml:id="zfs-zfs-snapshot-diff">
	<title>比對快照</title>

	<para>ZFS 提供了內建指令可以用來比對兩個快照 (Snapshot) 之間的差異，在使用者想要查看一段時間之間檔案系統所的變更時非常有用。例如 <command>zfs diff</command> 可以讓使用者在最後一次快照中找到意外刪除的檔案。對前面一節所做的兩個快照使用這個指令會產生以下結果：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>zfs list -rt all <replaceable>mypool/var/tmp</replaceable></userinput>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         206K  93.2G   118K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp                   0      -   118K  -
<prompt>#</prompt> <userinput>zfs diff <replaceable>mypool/var/tmp@my_recursive_snapshot</replaceable></userinput>
M       /var/tmp/
+       /var/tmp/passwd</screen>

	<para>指令會列出指定快照 (在這個例子中為 <literal><replaceable>mypool/var/tmp@my_recursive_snapshot</replaceable></literal>) 與目前檔案系統間的更改。第一個欄位是更改的類型：</para>

	<informaltable pgwide="1">
	  <tgroup cols="2">
	    <tbody valign="top">
	      <row>
		<entry xml:lang="en">+</entry>
		<entry>加入了該路徑或檔案。</entry>
	      </row>

	      <row>
		<entry xml:lang="en">-</entry>
		<entry>刪除了該路徑或檔案。</entry>
	      </row>

	      <row>
		<entry xml:lang="en">M</entry>
		<entry>修改了該路徑或檔案。</entry>
	      </row>

	      <row>
		<entry xml:lang="en">R</entry>
		<entry>重新命名了該路徑或檔案。</entry>
	      </row>
	    </tbody>
	  </tgroup>
	</informaltable>

	<para>對照這個表格來看輸出的結果，可以明顯的看到 <filename><replaceable>passwd</replaceable></filename> 是在快照 <literal><replaceable>mypool/var/tmp@my_recursive_snapshot</replaceable></literal> 建立之後才加入的，結果也同樣看的到掛載到 <literal><replaceable>/var/tmp</replaceable></literal> 的父目錄已經做過修改。</para>

	<para>在使用 <acronym>ZFS</acronym> 備份功能來傳輸一個資料集到另一個主機備份時比對兩個快照也同樣很有用。</para>

	<para>比對兩個快照需要提供兩個資料集的完整資料集名稱與快照名稱：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cp /var/tmp/passwd /var/tmp/passwd.copy</userinput>
<prompt>#</prompt> <userinput>zfs snapshot <replaceable>mypool/var/tmp@diff_snapshot</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs diff <replaceable>mypool/var/tmp@my_recursive_snapshot</replaceable> <replaceable>mypool/var/tmp@diff_snapshot</replaceable></userinput>
M       /var/tmp/
+       /var/tmp/passwd
+       /var/tmp/passwd.copy
<prompt>#</prompt> <userinput>zfs diff <replaceable>mypool/var/tmp@my_recursive_snapshot</replaceable> <replaceable>mypool/var/tmp@after_cp</replaceable></userinput>
M       /var/tmp/
+       /var/tmp/passwd</screen>

	<para>備份管理者可以比對兩個自傳送主機所接收到的兩個快照並查看實際在資料集中的變更。請參考 <link linkend="zfs-zfs-send">備份</link> 一節來取得更多資訊。</para>
      </sect3>

      <sect3 xml:id="zfs-zfs-snapshot-rollback">
	<title>使用快照還原</title>

	<para>只要至少有一個可用的快照便可以隨時還原。大多數在已不需要目前資料集，想要改用較舊版的資料的情況，例如，本地開發的測試發生錯誤、不良的系統更新破壞了系統的整體功能或需要還原意外刪除檔案或目錄 ... 等，都是非常常見的情形。幸運的，要還原到某個快照只需要簡單輸入 <command>zfs rollback <replaceable>snapshotname</replaceable></command>。會依快照所做的變更數量來決定處理的時間，還原的操作會在一段時間後完成。在這段時間中，資料集會一直保持一致的狀態，類似一個符合 ACID 原則的資料庫在做還原。還原可在資料集處於上線及可存取的情況下完成，不需要停機。還原到快照之後，資料集便回到當初執行快照時相同的狀態，所有沒有在快照中的其他資料便會被丟棄，因此往後若還有可能需要部份資料時，建議在還原到前一個快照之前先對目前的資料集做快照，這樣一來，使用者便可以在快照之間來回快換，而不會遺失重要的資料。</para>

	<para>在第一個範例中，因為 <command>rm</command> 操作不小心移除了預期外的資料，要還原到快照。</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>zfs list -rt all <replaceable>mypool/var/tmp</replaceable></userinput>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp                         262K  93.2G   120K  /var/tmp
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp               53.5K      -   118K  -
mypool/var/tmp@diff_snapshot              0      -   120K  -
<prompt>#</prompt> <userinput>ls /var/tmp</userinput>
passwd          passwd.copy     vi.recover
<prompt>#</prompt> <userinput>rm /var/tmp/passwd*</userinput>
<prompt>#</prompt> <userinput>ls /var/tmp</userinput>
vi.recover</screen>

	<para>在此時，使用者發現到刪除了太多檔案並希望能夠還原。<acronym>ZFS</acronym> 提供了簡單的方可以取回檔案，便是使用還原 (Rollback)，但這只在有定期對重要的資料使用快照時可用。要拿回檔案並從最後一次快照重新開始，可執行以下指令：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>zfs rollback <replaceable>mypool/var/tmp@diff_snapshot</replaceable></userinput>
<prompt>#</prompt> <userinput>ls /var/tmp</userinput>
passwd          passwd.copy     vi.recover</screen>

	<para>還原操作會將資料集還原為最後一次快照的狀態。這也可以還原到更早之前，有其他在其之後建立的快照。要這麼做時，<acronym>ZFS</acronym> 會發出這個警告：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>zfs list -rt snapshot <replaceable>mypool/var/tmp</replaceable></userinput>
AME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp@my_recursive_snapshot    88K      -   152K  -
mypool/var/tmp@after_cp               53.5K      -   118K  -
mypool/var/tmp@diff_snapshot              0      -   120K  -
<prompt>#</prompt> <userinput>zfs rollback <replaceable>mypool/var/tmp@my_recursive_snapshot</replaceable></userinput>
cannot rollback to 'mypool/var/tmp@my_recursive_snapshot': more recent snapshots exist
use '-r' to force deletion of the following snapshots:
mypool/var/tmp@after_cp
mypool/var/tmp@diff_snapshot</screen>

	<para>這個警告是因在該快照與資料集的目前狀態之間有其他快照存在，然而使用者想要還原到該快照。要完成這樣的還原動作，必須刪除在這之間的快照，因為 <acronym>ZFS</acronym> 無法追蹤不同資料集狀態間的變更。在使用者未指定 <option>-r</option> 來確認這個動作前，<acronym>ZFS</acronym> 不會刪除受影響的快照。若確定要這麼做，那麼必須要知道會遺失所有在這之間的快照，然後可執行以下指令：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>zfs rollback -r <replaceable>mypool/var/tmp@my_recursive_snapshot</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs list -rt snapshot <replaceable>mypool/var/tmp</replaceable></userinput>
NAME                                   USED  AVAIL  REFER  MOUNTPOINT
mypool/var/tmp@my_recursive_snapshot     8K      -   152K  -
<prompt>#</prompt> <userinput>ls /var/tmp</userinput>
vi.recover</screen>

	<para>可從 <command>zfs list -t snapshot</command> 的結果來確認 <command>zfs rollback -r</command> 會移除的快照。</para>
      </sect3>

      <sect3 xml:id="zfs-zfs-snapshot-snapdir">
	<title>從快照還原個別檔案</title>

	<para>快照會掛載在父資料集下的隱藏目錄：<filename>.zfs/snapshots/<replaceable>snapshotname</replaceable></filename>。預設不會顯示這些目錄，即使是用 <command>ls -a</command> 指令。雖然該目錄不會顯示，但該目錄實際存在，而且可以像一般的目錄一樣存取。一個名稱為 <literal>snapdir</literal> 的屬性可以控制是否在目錄清單中顯示這些隱藏目錄，設定該屬性為可見 (<literal>visible</literal>) 可以讓這些目錄出現在 <command>ls</command> 以及其他處理目錄內容的指令中。</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>zfs get snapdir <replaceable>mypool/var/tmp</replaceable></userinput>
NAME            PROPERTY  VALUE    SOURCE
mypool/var/tmp  snapdir   hidden   default
<prompt>#</prompt> <userinput>ls -a /var/tmp</userinput>
.               ..              passwd          vi.recover
<prompt>#</prompt> <userinput>zfs set snapdir=visible <replaceable>mypool/var/tmp</replaceable></userinput>
<prompt>#</prompt> <userinput>ls -a /var/tmp</userinput>
.               ..              .zfs            passwd          vi.recover</screen>

	<para>要還原個別檔案到先前的狀態非常簡單，只要從快照中複製檔案到父資料集。在 <filename>.zfs/snapshot</filename> 目錄結構下有一個與先前所做的快照名稱相同的目錄，可以很容易的找到。在下個範例中，我們會示範從隱藏的 <filename>.zfs</filename> 目錄還原一個檔案，透過從含有該檔案的最新版快照複製：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>rm /var/tmp/passwd</userinput>
<prompt>#</prompt> <userinput>ls -a /var/tmp</userinput>
.               ..              .zfs            vi.recover
<prompt>#</prompt> <userinput>ls /var/tmp/.zfs/snapshot</userinput>
after_cp                my_recursive_snapshot
<prompt>#</prompt> <userinput>ls /var/tmp/.zfs/snapshot/<replaceable>after_cp</replaceable></userinput>
passwd          vi.recover
<prompt>#</prompt> <userinput>cp /var/tmp/.zfs/snapshot/<replaceable>after_cp/passwd</replaceable> <replaceable>/var/tmp</replaceable></userinput></screen>

	<para>執行 <command>ls .zfs/snapshot</command> 時，雖然 <literal>snapdir</literal> 可能已經設為隱藏，但仍可能可以顯示該目錄中的內容，這取決於管理者是否要顯示這些目錄，可以只顯示特定的資料集，而其他的則不顯示。從這個隱藏的 <filename>.zfs/snapshot</filename> 複製檔案或目錄非常簡單，除此之外，嘗試其他的動作則會出現以下錯誤：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cp <replaceable>/etc/rc.conf</replaceable> /var/tmp/.zfs/snapshot/<replaceable>after_cp/</replaceable></userinput>
cp: /var/tmp/.zfs/snapshot/after_cp/rc.conf: Read-only file system</screen>

	<para>這個錯誤用來提醒使用者快照是唯讀的，在建立之後不能更改。無法複製檔案進去或從該快照目錄中移除，因為這會變更該資料集所代表的狀態。</para>

	<para>快照所消耗的空間是依據自快照之後父檔案系統做了多少變更來決定，快照的 <literal>written</literal> 屬性可以用來追蹤有多少空間被快照所使用。</para>

	<para>使用 <command>zfs destroy <replaceable>dataset</replaceable>@<replaceable>snapshot</replaceable></command> 可以摧毀快照並回收空間。加上 <option>-r</option> 可以遞迴移除所有在父資料集下使用同名的快照。加入 <option>-n -v</option> 來顯示將要移除的快照清單以及估計回收的空間，而不會實際執行摧毀的操作。</para>
      </sect3>
    </sect2>

    <sect2 xml:id="zfs-zfs-clones">
      <title>管理複本 (Clone)</title>

      <para>複本 (Clone) 是快照的複製，但更像是一般的資料集，與快照不同的是，複本是非唯讀的 (可寫)，且可掛載，可以有自己的屬性。使用 <command>zfs clone</command> 建立複本之後，便無法再摧毀用來建立複本的快照。複本與快照的父/子關係可以使用 <command>zfs promote</command> 來對換。提升複本之後 ，快照便會成為複本的子資料集，而不是原來的父資料集，這個動作會改變空間計算的方式，但並不會實際改變空間的使用量。複本可以被掛載到 <acronym>ZFS</acronym> 檔案系統階層中的任何一點，並非只能位於原來快照的位置底下。</para>

      <para>要示範複本功能會用到這個範例資料集：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs list -rt all <replaceable>camino/home/joe</replaceable></userinput>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
camino/home/joe         108K   1.3G    87K  /usr/home/joe
camino/home/joe@plans    21K      -  85.5K  -
camino/home/joe@backup    0K      -    87K  -</screen>

      <para>會使用到複本一般是要在可以保留快照以便出錯時可還原的情況下使用指定的資料集做實驗，由於快照並無法做更改，所以會建立一個可以讀/寫的快照複本。當在複本中做完想要執行的動作後，便可以提升複本成資料集，然後移除舊的檔案系統。嚴格來說這並非必要，因為複本與資料集可同時存在，不會有任何問題。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs clone <replaceable>camino/home/joe</replaceable>@<replaceable>backup</replaceable> <replaceable>camino/home/joenew</replaceable></userinput>
<prompt>#</prompt> <userinput>ls /usr/home/joe*</userinput>
/usr/home/joe:
backup.txz     plans.txt

/usr/home/joenew:
backup.txz     plans.txt
<prompt>#</prompt> <userinput>df -h /usr/home</userinput>
Filesystem          Size    Used   Avail Capacity  Mounted on
usr/home/joe        1.3G     31k    1.3G     0%    /usr/home/joe
usr/home/joenew     1.3G     31k    1.3G     0%    /usr/home/joenew</screen>

      <para>建立完的複本便有與建立快照時狀態相同的資料集，現在複本可以獨立於原來的資料集來做更改。剩下唯一與資料集之間的關係便是快照，<acronym>ZFS</acronym> 會在屬性 <literal>origin</literal> 記錄這個關係，一旦在快照與複本之間的相依關係因為使用 <command>zfs promote</command> 提升而移除時，複本的 <literal>origin</literal> 也會因為成為一個完全獨立的資料集而移除。以下範例會示範這個動作：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs get origin <replaceable>camino/home/joenew</replaceable></userinput>
NAME                  PROPERTY  VALUE                     SOURCE
camino/home/joenew    origin    camino/home/joe@backup    -
<prompt>#</prompt> <userinput>zfs promote <replaceable>camino/home/joenew</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs get origin <replaceable>camino/home/joenew</replaceable></userinput>
NAME                  PROPERTY  VALUE   SOURCE
camino/home/joenew    origin    -       -</screen>

      <para>做為部份更改之後，例如複製 <filename>loader.conf</filename> 到提升後的複本，這個例子中的舊目錄便無須保留，取而代之的是提升後的複本，這個動作可以用兩個連續的指令來完成：在舊資料集上執行 <command>zfs destroy</command> 並在與舊資料相似名稱 (也可能用完全不同的名稱) 的複本上執行 <command>zfs rename</command>。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cp <replaceable>/boot/defaults/loader.conf</replaceable> <replaceable>/usr/home/joenew</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs destroy -f <replaceable>camino/home/joe</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs rename <replaceable>camino/home/joenew</replaceable> <replaceable>camino/home/joe</replaceable></userinput>
<prompt>#</prompt> <userinput>ls /usr/home/joe</userinput>
backup.txz     loader.conf     plans.txt
<prompt>#</prompt> <userinput>df -h <replaceable>/usr/home</replaceable></userinput>
Filesystem          Size    Used   Avail Capacity  Mounted on
usr/home/joe        1.3G    128k    1.3G     0%    /usr/home/joe</screen>

      <para>快照的複本現在可以如同一般資料集一樣使用，它的內容包含了所有來自原始快照的資料以及後來加入的檔案，例如 <filename>loader.conf</filename>。複本可以在許多不同的情境下使用提供 ZFS 的使用者有用的功能，例如，Jail 可以透過含有已安裝了各種應用程式集的快照來提供，使用者可以複製這些快照然後加入自己想要嘗試的應用程式，一但更改可以滿足需求，便可提升複本為完整的資料集然後提供給終端使用者，讓終端使用者可以如同實際擁有資料集一般的使用，這個以節省提供這些 Jail 的時間與管理成本。</para>
    </sect2>

    <sect2 xml:id="zfs-zfs-send">
      <title>備份 (Replication)</title>

      <para>將資料保存在單一地點的單一儲存池上會讓資料暴露在盜竊、自然或人為的風險之下，定期備份整個儲存池非常重要，<acronym>ZFS</acronym> 提供了內建的序列化 (Serialization) 功能可以將資料以串流傳送到標準輸出。使用這項技術，不僅可以將資料儲存到另一個已連結到本地系統的儲存池，也可以透過網路將資料傳送到另一個系統，這種備份方式以快照為基礎 (請參考章節 <link linkend="zfs-zfs-snapshot"><acronym>ZFS</acronym> 快照(Snapshot)</link>)。用來備份資料的指令為 <command>zfs send</command> 及 <command>zfs receive</command>。</para>

      <para>以下例子將示範使用兩個儲存池來做 <acronym>ZFS</acronym> 備份：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool list</userinput>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
backup  960M    77K   896M         -         -     0%    0%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%    4%  1.00x  ONLINE  -</screen>

      <para>名為 <replaceable>mypool</replaceable> 的儲存池為主要的儲存池，資料會定期寫入與讀取的位置。第二個儲存池 <replaceable>backup</replaceable> 用來待命 (Standby)，萬一主要儲存池無法使用時可替換。注意，<acronym>ZFS</acronym> 並不會自動做容錯移轉 (Fail-over)，必須要由系統管理者在需要的時候手動完成。快照會用來提供一個與檔系統一致的版本來做備份，<replaceable>mypool</replaceable> 的快照建立之後，便可以複製到 <replaceable>backup</replaceable> 儲存池，只有快照可以做備份，最近一次快照之後所做的變更不會含在內容裡面。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs snapshot <replaceable>mypool</replaceable>@<replaceable>backup1</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs list -t snapshot</userinput>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
mypool@backup1             0      -  43.6M  -</screen>

      <para>快照存在以後，便可以使用 <command>zfs send</command> 來建立一個代表快照內容的串流，這個串流可以儲存成檔案或由其他儲存池接收。串流會寫入到標準輸出，但是必須要重新導向到一個檔案或轉接到其他地方，否則會錯誤：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs send <replaceable>mypool</replaceable>@<replaceable>backup1</replaceable></userinput>
Error: Stream can not be written to a terminal.
You must redirect standard output.</screen>

      <para>要使用 <command>zfs send</command> 備份一個資料集，可重新導向到一個位於在已掛載到備份儲存池上的檔案。確定該儲存池有足夠的空間容納要傳送的快照，這裡指的是該快照中內含的所有資料，並非只有上次快照到該快照間的變更。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs send <replaceable>mypool</replaceable>@<replaceable>backup1</replaceable> &gt; <replaceable>/backup/backup1</replaceable></userinput>
<prompt>#</prompt> <userinput>zpool list</userinput>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT
backup  960M  63.7M   896M         -         -     0%     6%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%     4%  1.00x  ONLINE  -</screen>

      <para><command>zfs send</command> 會傳輸在快照 <replaceable>backup1</replaceable> 中所有的資料到儲存池 <replaceable>backup</replaceable>。可以使用 <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> 排程來自動完成建立與傳送快照的動作。</para>

      <para>若不想將備份以封存檔案儲存，<acronym>ZFS</acronym> 可用實際的檔案系統來接收資料，讓備份的資料可以直接被存取。要取得實際包含在串流中的資料可以用 <command>zfs receive</command> 將串流轉換回檔案與目錄。以下例子會以管線符號連接 <command>zfs send</command> 及 <command>zfs receive</command>，將資料從一個儲存池複製到另一個，傳輸完成後可以直接使用接收儲存池上的資料。一個資料集只可以被複製到另一個空的資料集。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs snapshot <replaceable>mypool</replaceable>@<replaceable>replica1</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs send -v <replaceable>mypool</replaceable>@<replaceable>replica1</replaceable> | zfs receive <replaceable>backup/mypool</replaceable></userinput>
send from @ to mypool@replica1 estimated size is 50.1M
total estimated size is 50.1M
TIME        SENT   SNAPSHOT

<prompt>#</prompt> <userinput>zpool list</userinput>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT
backup  960M  63.7M   896M         -         -     0%     6%  1.00x  ONLINE  -
mypool  984M  43.7M   940M         -         -     0%     4%  1.00x  ONLINE  -</screen>

      <sect3 xml:id="zfs-send-incremental">
	<title>漸進式備份</title>

	<para><command>zfs send</command> 也可以比較兩個快照之間的差異，並且只傳送兩者之間的差異，這麼做可以節省磁碟空間及傳輸時間。例如：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>zfs snapshot <replaceable>mypool</replaceable>@<replaceable>replica2</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs list -t snapshot</userinput>
NAME                    USED  AVAIL  REFER  MOUNTPOINT
mypool@replica1         5.72M      -  43.6M  -
mypool@replica2             0      -  44.1M  -
<prompt>#</prompt> <userinput>zpool list</userinput>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG   CAP  DEDUP  HEALTH  ALTROOT
backup  960M  61.7M   898M         -         -     0%    6%  1.00x  ONLINE  -
mypool  960M  50.2M   910M         -         -     0%    5%  1.00x  ONLINE  -</screen>

	<para>會建立一個名為 <replaceable>replica2</replaceable> 的第二個快照，這個快照只中只會含有目前與前次快照 <replaceable>replica1</replaceable> 之間檔案系統所做的變更。使用 <command>zfs send -i</command> 並指定要用來產生漸進備份串流的快照，串流中只會含有做過更改的資料。這個動作只在接收端已經有初始快照時才可用。</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>zfs send -v -i <replaceable>mypool</replaceable>@<replaceable>replica1</replaceable> <replaceable>mypool</replaceable>@<replaceable>replica2</replaceable> | zfs receive <replaceable>/backup/mypool</replaceable></userinput>
send from @replica1 to mypool@replica2 estimated size is 5.02M
total estimated size is 5.02M
TIME        SENT   SNAPSHOT

<prompt>#</prompt> <userinput>zpool list</userinput>
NAME    SIZE  ALLOC   FREE   CKPOINT  EXPANDSZ   FRAG  CAP  DEDUP  HEALTH  ALTROOT
backup  960M  80.8M   879M         -         -     0%   8%  1.00x  ONLINE  -
mypool  960M  50.2M   910M         -         -     0%   5%  1.00x  ONLINE  -

<prompt>#</prompt> <userinput>zfs list</userinput>
NAME                         USED  AVAIL  REFER  MOUNTPOINT
backup                      55.4M   240G   152K  /backup
backup/mypool               55.3M   240G  55.2M  /backup/mypool
mypool                      55.6M  11.6G  55.0M  /mypool

<prompt>#</prompt> <userinput>zfs list -t snapshot</userinput>
NAME                                         USED  AVAIL  REFER  MOUNTPOINT
backup/mypool@replica1                       104K      -  50.2M  -
backup/mypool@replica2                          0      -  55.2M  -
mypool@replica1                             29.9K      -  50.0M  -
mypool@replica2                                 0      -  55.0M  -</screen>

	<para>如此一來，便成功傳輸漸進式的串流，只有做過更改的資料會被備份，不會傳送完整的 <replaceable>replica1</replaceable>。由於不會備份完整的儲存池，只傳送差異的部份，所以可以減少傳輸的時間並節省磁碟空間，特別是在網路緩慢或需要考量每位元傳輸成本時非常有用。</para>

	<para>從儲存池 <replaceable>mypool</replaceable> 複製所有檔案與資料的新檔案系統 <replaceable>backup/mypool</replaceable> 便可以使用。若指定 <option>-P</option>，會一併複製資料集的屬性，這包含壓縮 (Compression) 設定，配額 (Quota) 及掛載點 (Mount point)。若指定 <option>-R</option>，會複製所有指定資料集的子資料集，及這些子資料集的所有屬性。可將傳送與接收自動化來定期使用第二個儲存池做備份。</para>
      </sect3>

      <sect3 xml:id="zfs-send-ssh">
	<title>透過 <application>SSH</application> 傳送加密的備份</title>

	<para>透過網路來傳送串流是一個做遠端備份不錯的方式，但是也有一些缺點，透過網路連線傳送的資料沒有加密，這會讓任何人都可以在未告知傳送方的情況下攔截並轉換串流回資料，這是我們所不想見到的情況，特別是在使用網際網路傳送串流到遠端的主機時。<application>SSH</application> 可用來加密要透過網路連線傳送的資料，在 <acronym>ZFS</acronym> 只需要將串流重新導向到標準輸出，如此一來便可簡單的轉接到 <application>SSH</application>。若要讓檔案系統內容在傳送或在遠端系統中也維持在加密的狀態可考慮使用 <link xlink:href="https://wiki.freebsd.org/PEFS">PEFS</link>。</para>

	<para>有一些設定以及安全性注意事項必須先完成，只有對 <command>zfs send</command> 操作必要的步驟才會在此說明，要取得更多有關 <application>SSH</application> 的資訊請參考 <xref linkend="openssh"/>。</para>

	<para>必要的環境設定：</para>

	<itemizedlist>
	  <listitem>
	    <para>使用 <application>SSH</application> 金鑰設定傳送端與接收端間無密碼的 <application>SSH</application> 存取</para>
	  </listitem>

	  <listitem>
	    <para>正常會需要 <systemitem class="username">root</systemitem> 的權限來傳送與接收串流，這需要可以 <systemitem class="username">root</systemitem> 登入到接收端系統。但是，預設因安全性考慮會關閉以 <systemitem class="username">root</systemitem> 登入。ZFS 委託 (<link linkend="zfs-zfs-allow">ZFS Delegation</link>) 系統可以用來允許一個非 <systemitem class="username">root</systemitem> 使用者在每個系統上執行各自的發送與接收操作。</para>
	  </listitem>

	  <listitem>
	    <para>在傳送端系統上：</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs allow -u someuser send,snapshot <replaceable>mypool</replaceable></userinput></screen>
	  </listitem>

	  <listitem>
	    <para>要掛載儲存池，無權限的使用者必須擁有該目錄且必須允許一般的使用者掛載檔案系統。在接收端系統上：</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl vfs.usermount=1</userinput>
vfs.usermount: 0 -&gt; 1
<prompt>#</prompt> <userinput>sysrc -f /etc/sysctl.conf vfs.usermount=1</userinput>
<prompt>#</prompt> <userinput>zfs create <replaceable>recvpool/backup</replaceable></userinput>
<prompt>#</prompt> <userinput>zfs allow -u <replaceable>someuser</replaceable> create,mount,receive <replaceable>recvpool/backup</replaceable></userinput>
<prompt>#</prompt> <userinput>chown <replaceable>someuser</replaceable> <replaceable>/recvpool/backup</replaceable></userinput></screen>
	  </listitem>
	</itemizedlist>

	<para>無權限的使用者現在有能力可以接收並掛載資料集，且 <replaceable>home</replaceable> 資料集可以被複製到遠端系統：</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>zfs snapshot -r <replaceable>mypool/home</replaceable>@<replaceable>monday</replaceable></userinput>
<prompt>%</prompt> <userinput>zfs send -R <replaceable>mypool/home</replaceable>@<replaceable>monday</replaceable> | ssh <replaceable>someuser@backuphost</replaceable> zfs recv -dvu <replaceable>recvpool/backup</replaceable></userinput></screen>

	<para>替儲存在儲存池 <replaceable>mypool</replaceable> 上的檔案系統資料集 <replaceable>home</replaceable> 製作一個遞迴快照 <replaceable>monday</replaceable>，然後使用 <command>zfs send -R</command> 來傳送包含該資料集及其所有子資料集、快照、複製與設定的串流。輸出會被導向到 <application>SSH</application> 連線的遠端主機 <replaceable>backuphost</replaceable> 上等候輸入的 <command>zfs receive</command>，在此建議使用完整網域名稱或 IP 位置。接收端的機器會寫入資料到 <replaceable>recvpool</replaceable> 儲存池上的 <replaceable>backup</replaceable> 資料集，在 <command>zfs recv</command> 加上 <option>-d</option> 可覆寫在接收端使用相同名稱的快照，加上 <option>-u</option> 可讓檔案系統在接收端不會被掛載，當使用 <option>-v</option>，會顯示更多有關傳輸的詳細資訊，包含已花費的時間及已傳輸的資料量。</para>
      </sect3>
    </sect2>

    <sect2 xml:id="zfs-zfs-quota">
      <title>資料集、使用者以及群組配額</title>

      <para>資料集配額 (<link linkend="zfs-term-quota">Dataset quota</link>) 可用來限制特定資料集可以使用的的空間量。參考配額 (<link linkend="zfs-term-refquota">Reference Quota</link>) 的功能也非常相似，差在參考配額只會計算資料集自己使用的空間，不含快照與子資料集。類似的，使用者 (<link linkend="zfs-term-userquota">User</link>) 與群組 (<link linkend="zfs-term-groupquota">Group</link>) 配額可以用來避免使用者或群組用掉儲存池或資料集的所有空間。</para>

      <para>要設定 <filename>storage/home/bob</filename> 的資料集配額為 10 GB：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set quota=10G storage/home/bob</userinput></screen>

      <para>要設定 <filename>storage/home/bob</filename> 的參考配額為 10 GB：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set refquota=10G storage/home/bob</userinput></screen>

      <para>要移除 <filename>storage/home/bob</filename> 的 10 GB 配額：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set quota=none storage/home/bob</userinput></screen>

      <para>設定使用者配額的一般格式為 <literal>userquota@<replaceable>user</replaceable>=<replaceable>size</replaceable></literal> 使用者的名稱必須使用以下格式：</para>

      <itemizedlist>
	<listitem>
	  <para><acronym>POSIX</acronym> 相容的名稱，如 <replaceable>joe</replaceable>。</para>
	</listitem>

	<listitem>
	  <para><acronym>POSIX</acronym> 數字 ID，如 <replaceable>789</replaceable>。</para>
	</listitem>

	<listitem>
	  <para><acronym>SID</acronym> 名稱，如 <replaceable>joe.bloggs@example.com</replaceable>。</para>
	</listitem>

	<listitem>
	  <para><acronym>SID</acronym> 數字 ID，如 <replaceable>S-1-123-456-789</replaceable>。</para>
	</listitem>
      </itemizedlist>

      <para>例如，要設定使用者名為 <replaceable>joe</replaceable> 的使用者配額為 50 GB：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set userquota@joe=50G</userinput></screen>

      <para>要移除所有配額：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set userquota@joe=none</userinput></screen>

      <note>
	<para>使用者配額的屬性不會顯示在 <command>zfs get all</command>。非 <systemitem class="username">root</systemitem> 的使用者只可以看到自己的配額，除非它們有被授予 <literal>userquota</literal> 權限，擁有這個權限的使用者可以檢視與設定任何人的配額。</para>
      </note>

      <para>要設定群組配額的一般格式為：<literal>groupquota@<replaceable>group</replaceable>=<replaceable>size</replaceable></literal>。</para>

      <para>要設定群組 <replaceable>firstgroup</replaceable> 的配額為 50 GB 可使用：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set groupquota@firstgroup=50G</userinput></screen>

      <para>要移除群組 <replaceable>firstgroup</replaceable> 的配額，或確保該群組未設定配額可使用：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set groupquota@firstgroup=none</userinput></screen>

      <para>如同使用者配額屬性，非 <systemitem class="username">root</systemitem> 使用者只可以查看自己所屬群組的配額。而 <systemitem class="username">root</systemitem> 或擁有 <literal>groupquota</literal> 權限的使用者，可以檢視並設定所有群組的任何配額。</para>

      <para>要顯示在檔案系統或快照上每位使用者所使用的空間量及配額可使用 <command>zfs userspace</command>，要取得群組的資訊則可使用 <command>zfs groupspace</command>，要取得有關支援的選項資訊或如何只顯示特定選項的資訊請參考 <citerefentry><refentrytitle>zfs</refentrytitle><manvolnum>1</manvolnum></citerefentry>。</para>

      <para>有足夠權限的使用者及 <systemitem class="username">root</systemitem> 可以使用以下指令列出 <filename>storage/home/bob</filename> 的配額：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs get quota storage/home/bob</userinput></screen>
    </sect2>

    <sect2 xml:id="zfs-zfs-reservation">
      <title>保留空間</title>

      <para>保留空間 (<link linkend="zfs-term-reservation">Reservation</link>) 可以確保資料集最少可用的空間量，其他任何資料集無法使用保留的空間，這個功能在要確保有足夠的可用空間來存放重要的資料集或日誌檔時特別有用。</para>

      <para><literal>reservation</literal> 屬性的一般格式為 <literal>reservation=<replaceable>size</replaceable></literal>，所以要在 <filename>storage/home/bob</filename> 設定保留 10 GB 的空間可以用：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set reservation=10G storage/home/bob</userinput></screen>

      <para>要清除任何保留空間：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set reservation=none storage/home/bob</userinput></screen>

      <para>同樣的原則可以應用在 <literal>refreservation</literal> 屬性來設定參考保留空間 (<link linkend="zfs-term-refreservation">Reference Reservation</link>)，參考保留空間的一般格式為 <literal>refreservation=<replaceable>size</replaceable></literal>。</para>

      <para>這個指令會顯示任何已設定於 <filename>storage/home/bob</filename> 的 reservation 或 refreservation：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs get reservation storage/home/bob</userinput>
<prompt>#</prompt> <userinput>zfs get refreservation storage/home/bob</userinput></screen>
    </sect2>

    <sect2 xml:id="zfs-zfs-compression">
      <title>壓縮 (Compression)</title>

      <para><acronym>ZFS</acronym> 提供直接的壓縮功能，在資料區塊層級壓縮資料不僅可以節省空間，也可以增加磁碟的效能。若資料壓縮了 25%，但壓縮的資料會使用了與未壓縮版本相同的速率寫入到磁碟，所以實際的寫入速度會是原來的 125%。壓縮功能也可來替代去重複 (<link linkend="zfs-zfs-deduplication">Deduplication</link>) 功能，因為壓縮並不需要使用額外的記憶體。</para>

      <para><acronym>ZFS</acronym> 提了多種不同的壓縮演算法，每一種都有不同的優缺點，隨著 <acronym>ZFS</acronym> v5000 引進了 <acronym>LZ4</acronym> 壓縮技術，可對整個儲存池開啟壓縮，而不像其他演算法需要消耗大量的效能來達成，最大的優點是 <acronym>LZ4</acronym> 擁有 <emphasis>提早放棄</emphasis> 的功能，若 <acronym>LZ4</acronym> 無法在資料一開始的部份達成至少 12.5% 的壓縮率，便會以不壓縮的方式來寫入資料區塊來避免 CPU 在那些已經壓縮過或無法壓縮的資料上浪費運算能力。要取得更多有關 <acronym>ZFS</acronym> 中可用的壓縮演算法詳細資訊，可參考術語章節中的壓縮 (<link linkend="zfs-term-compression">Compression</link>) 項目。</para>

      <para>管理者可以使用資料集的屬性來監視壓縮的效果。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs get used,compressratio,compression,logicalused <replaceable>mypool/compressed_dataset</replaceable></userinput>
NAME        PROPERTY          VALUE     SOURCE
mypool/compressed_dataset  used              449G      -
mypool/compressed_dataset  compressratio     1.11x     -
mypool/compressed_dataset  compression       lz4       local
mypool/compressed_dataset  logicalused       496G      -</screen>

      <para>資料集目前使用了 449 GB 的空間 (在 used 屬性)。在尚未壓縮前，該資料集應該會使用 496 GB 的空間 (於 <literal>logicalused</literal> 屬性)，這個結果顯示目前的壓縮比為 1.11:1。</para>

      <para>壓縮功能在與使用者配額 (<link linkend="zfs-term-userquota">User Quota</link>) 一併使用時可能會產生無法預期的副作用。使用者配額會限制一個使用者在一個資料集上可以使用多少空間，但衡量的依據是以 <emphasis>壓縮後</emphasis> 所使用的空間，因此，若一個使用者有 10 GB 的配額，寫入了 10 GB 可壓縮的資料，使用者將還會有空間儲存額外的資料。若使用者在之後更新了一個檔案，例如一個資料庫，可能有更多或較少的可壓縮資料，那麼剩餘可用的空間量也會因此而改變，這可能會造成奇怪的現象便是，一個使用者雖然沒有增加實際的資料量 (於 <literal>logicalused</literal> 屬性)，但因為更改影響了壓縮率，導致使用者達到配額的上限。</para>

      <para>壓縮功能在與備份功能一起使用時也可能會有類似的問題，通常會使用配額功能來限制能夠儲存的資料量來確保有足夠的備份空間可用。但是由於配額功能並不會考量壓縮狀況，可能會有比未壓縮版本備份更多的資料量會被寫入到資料集。</para>
    </sect2>

    <sect2 xml:id="zfs-zfs-deduplication">
      <title>去重複 (Deduplication)</title>

      <para>當開啟，去重複 (<link linkend="zfs-term-deduplication">Deduplication</link>) 功能會使用每個資料區塊的校驗碼 (Checksum) 來偵測重複的資料區塊，當新的資料區塊與現有的資料區塊重複，<acronym>ZFS</acronym> 便會寫入連接到現有資料的參考來替代寫入重複的資料區塊，這在資料中有大量重複的檔案或資訊時可以節省大量的空間，要注意的是：去重複功能需要使用大量的記憶體且大部份可節省的空間可改開啟壓縮功能來達成，而壓縮功能不需要使用額外的記憶體。</para>

      <para>要開啟去重複功能，需在目標儲存池設定 <literal>dedup</literal> 屬性：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs set dedup=on <replaceable>pool</replaceable></userinput></screen>

      <para>只有要被寫入到儲存池的新資料才會做去重複的動作，先前已被寫入到儲存池的資料不會因此啟動了這個選項而做去重複。查看已開啟去重複屬性的儲存池會如下：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool list</userinput>
NAME  SIZE ALLOC  FREE   CKPOINT  EXPANDSZ   FRAG   CAP   DEDUP   HEALTH   ALTROOT
pool 2.84G 2.19M 2.83G         -         -     0%    0%   1.00x   ONLINE   -</screen>

      <para><literal>DEDUP</literal> 欄位會顯示儲存池的實際去重複率，數值為 <literal>1.00x</literal> 代表資料尚未被去重複。在下一個例子會在前面所建立的去重複儲存池中複製三份 Port 樹到不同的目錄中。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>for d in dir1 dir2 dir3; do</userinput>
&gt; <userinput>mkdir $d &amp;&amp; cp -R /usr/ports $d &amp;</userinput>
&gt; <userinput>done</userinput></screen>

      <para>已經偵測到重複的資料並做去重複：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zpool list</userinput>
NAME SIZE  ALLOC  FREE   CKPOINT  EXPANDSZ   FRAG  CAP   DEDUP   HEALTH   ALTROOT
pool 2.84G 20.9M 2.82G         -         -     0%   0%   3.00x   ONLINE   -</screen>

      <para><literal>DEDUP</literal> 欄位顯示有 <literal>3.00x</literal> 的去重複率，這代表已偵測到多份複製的 Port 樹資料並做了去重複的動作，且只會使用第三份資料所佔的空間。去重複能節省空間的潛力可以非常巨大，但會需要消耗大量的記憶體來持續追蹤去重複的資料區塊。</para>

      <para>去重複並非總是有效益的，特別是當儲存池中的資料本身並沒有重複時。<acronym>ZFS</acronym> 可以透過在現有儲存池上模擬開啟去重複功能來顯示可能節省的空間：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zdb -S <replaceable>pool</replaceable></userinput>
Simulated DDT histogram:

bucket              allocated                       referenced
______   ______________________________   ______________________________
refcnt   blocks   LSIZE   PSIZE   DSIZE   blocks   LSIZE   PSIZE   DSIZE
------   ------   -----   -----   -----   ------   -----   -----   -----
     1    2.58M    289G    264G    264G    2.58M    289G    264G    264G
     2     206K   12.6G   10.4G   10.4G     430K   26.4G   21.6G   21.6G
     4    37.6K    692M    276M    276M     170K   3.04G   1.26G   1.26G
     8    2.18K   45.2M   19.4M   19.4M    20.0K    425M    176M    176M
    16      174   2.83M   1.20M   1.20M    3.33K   48.4M   20.4M   20.4M
    32       40   2.17M    222K    222K    1.70K   97.2M   9.91M   9.91M
    64        9     56K   10.5K   10.5K      865   4.96M    948K    948K
   128        2   9.50K      2K      2K      419   2.11M    438K    438K
   256        5   61.5K     12K     12K    1.90K   23.0M   4.47M   4.47M
    1K        2      1K      1K      1K    2.98K   1.49M   1.49M   1.49M
 Total    2.82M    303G    275G    275G    3.20M    319G    287G    287G

dedup = 1.05, compress = 1.11, copies = 1.00, dedup * compress / copies = 1.16</screen>

      <para>在 <command>zdb -S</command> 分析完儲存池後會顯示在啟動去重複後可達到的空間減少比例。在本例中，<literal>1.16</literal> 是非常差的空間節省比例，因為這個比例使用壓縮功能便能達成。若在此儲存池上啟動去重複並不能明顯的節省空間使用量，那麼就不值得耗費大量的記憶體來開啟去重複功能。透過公式 <emphasis>ratio = dedup * compress / copies</emphasis>，系統管理者可以規劃儲存空間的配置，來判斷要處理的資料是否有足夠的重複資料區塊來平衡所需的記憶體。若資料是可壓縮的，那麼空間節少的效果可能會非常好，建議先開啟壓縮功能，且壓縮功能也可以大大提高效能。去重複功能只有在可以節省可觀的空間且有足夠的記憶體做 <link linkend="zfs-term-deduplication"><acronym>DDT</acronym></link> 時才開啟。</para>
    </sect2>

    <sect2 xml:id="zfs-zfs-jail">
      <title><acronym>ZFS</acronym> 與 Jail</title>

      <para><command>zfs jail</command> 以及相關的 <literal>jailed</literal> 屬性可以用來將一個 <acronym>ZFS</acronym> 資料集委託給一個 <link linkend="jails">Jail</link> 管理。<command>zfs jail <replaceable>jailid</replaceable></command> 可以將一個資料集連結到一個指定的 Jail，而 <command>zfs unjail</command> 則可解除連結。資料集要可以在 Jail 中控制需設定 <literal>jailed</literal> 屬性，一旦資料集被隔離便無法再掛載到主機，因為有掛載點可能會破壞主機的安全性。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="zfs-zfs-allow">
    <title>委託管理</title>

    <para>一個全面性的權限委託系統可能無權限的使用者執行 <acronym>ZFS</acronym> 的管理功能。例如，若每個使用者的家目錄均為一個資料集，便可以給予使用者權限建立與摧毀它們家目錄中的快照。可以給予備份使用者使用備份功能的權限。一個使用量統計的 Script 可以允許其在執行時能存取所有使用者的空間利用率資料。甚至可以將委託權限委託給其他人，每個子指令與大多數屬性都可使用權限委託。</para>

    <sect2 xml:id="zfs-zfs-allow-create">
      <title>委託資料集建立</title>

      <para><command>zfs allow <replaceable>someuser</replaceable> create <replaceable>mydataset</replaceable></command> 可以給予指定的使用者在指定的父資料集下建立子資料集的權限。這裡需要注意：建立新資料集會牽涉到掛載，因此需要設定 FreeBSD 的 <literal>vfs.usermount</literal> <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 為 <literal>1</literal> 來允許非 root 的使用者掛載一個檔案系統。這裡還有另一項限制可以避免濫用：非 <systemitem class="username">root</systemitem> 使用者必須擁有掛載點在檔案系統中所在位置的權限才可掛載。</para>
    </sect2>

    <sect2 xml:id="zfs-zfs-allow-allow">
      <title>委託權限委託</title>

      <para><command>zfs allow <replaceable>someuser</replaceable> allow <replaceable>mydataset</replaceable></command> 可以給予指定的使用者有權限指派它們在目標資料集或其子資料集上擁有的任何權限給其他人。若該使用者擁有 <literal>snapshot</literal> 權限及 <literal>allow</literal> 權限，則該使用者可以授權 <literal>snapshot</literal> 權限給其他使用者。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="zfs-advanced">
    <title>進階主題</title>

    <sect2 xml:id="zfs-advanced-tuning">
      <title>調校</title>

      <para>這裡有數個可調校的項目可以調整，來讓 <acronym>ZFS</acronym> 在面對各種工作都能以最佳狀況運作。</para>

      <itemizedlist>
	<listitem>
	  <para xml:id="zfs-advanced-tuning-arc_max" xml:lang="en"><emphasis><varname>vfs.zfs.arc_max</varname></emphasis>
	    - Maximum size of the <link linkend="zfs-term-arc"><acronym>ARC</acronym></link>.
	    The default is all <acronym>RAM</acronym> but 1 GB,
	    or 5/8 of all <acronym>RAM</acronym>, whichever is more.
	    However, a lower value should be used if the system will
	    be running any other daemons or processes that may require
	    memory.  This value can be adjusted at runtime with
	    <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> and can be set in
	    <filename>/boot/loader.conf</filename> or
	    <filename>/etc/sysctl.conf</filename>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-arc_meta_limit" xml:lang="en"><emphasis><varname>vfs.zfs.arc_meta_limit</varname></emphasis>
	    - Limit the portion of the
	    <link linkend="zfs-term-arc"><acronym>ARC</acronym></link>
	    that can be used to store metadata.  The default is one
	    fourth of <varname>vfs.zfs.arc_max</varname>.  Increasing
	    this value will improve performance if the workload
	    involves operations on a large number of files and
	    directories, or frequent metadata operations, at the cost
	    of less file data fitting in the <link linkend="zfs-term-arc"><acronym>ARC</acronym></link>.
	    This value can be adjusted at runtime with <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	    and can be set in
	    <filename>/boot/loader.conf</filename> or
	    <filename>/etc/sysctl.conf</filename>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-arc_min" xml:lang="en"><emphasis><varname>vfs.zfs.arc_min</varname></emphasis>
	    - Minimum size of the <link linkend="zfs-term-arc"><acronym>ARC</acronym></link>.
	    The default is one half of
	    <varname>vfs.zfs.arc_meta_limit</varname>.  Adjust this
	    value to prevent other applications from pressuring out
	    the entire <link linkend="zfs-term-arc"><acronym>ARC</acronym></link>.
	    This value can be adjusted at runtime with <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	    and can be set in
	    <filename>/boot/loader.conf</filename> or
	    <filename>/etc/sysctl.conf</filename>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-vdev-cache-size" xml:lang="en"><emphasis><varname>vfs.zfs.vdev.cache.size</varname></emphasis>
	    - A preallocated amount of memory reserved as a cache for
	    each device in the pool.  The total amount of memory used
	    will be this value multiplied by the number of devices.
	    This value can only be adjusted at boot time, and is set
	    in <filename>/boot/loader.conf</filename>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-min-auto-ashift" xml:lang="en"><emphasis><varname>vfs.zfs.min_auto_ashift</varname></emphasis>
	    - Minimum <varname>ashift</varname> (sector size) that
	    will be used automatically at pool creation time.  The
	    value is a power of two.  The default value of
	    <literal>9</literal> represents
	    <literal>2^9 = 512</literal>, a sector size of 512 bytes.
	    To avoid <emphasis>write amplification</emphasis> and get
	    the best performance, set this value to the largest sector
	    size used by a device in the pool.</para>

	  <para xml:lang="en">Many drives have 4 KB sectors.  Using the default
	    <varname>ashift</varname> of <literal>9</literal> with
	    these drives results in write amplification on these
	    devices.  Data that could be contained in a single
	    4 KB write must instead be written in eight 512-byte
	    writes.  <acronym>ZFS</acronym> tries to read the native
	    sector size from all devices when creating a pool, but
	    many drives with 4 KB sectors report that their
	    sectors are 512 bytes for compatibility.  Setting
	    <varname>vfs.zfs.min_auto_ashift</varname> to
	    <literal>12</literal> (<literal>2^12 = 4096</literal>)
	    before creating a pool forces <acronym>ZFS</acronym> to
	    use 4 KB blocks for best performance on these
	    drives.</para>

	  <para xml:lang="en">Forcing 4 KB blocks is also useful on pools where
	    disk upgrades are planned.  Future disks are likely to use
	    4 KB sectors, and <varname>ashift</varname> values
	    cannot be changed after a pool is created.</para>

	  <para xml:lang="en">In some specific cases, the smaller 512-byte block
	    size might be preferable.  When used with 512-byte disks
	    for databases, or as storage for virtual machines, less
	    data is transferred during small random reads.  This can
	    provide better performance, especially when using a
	    smaller <acronym>ZFS</acronym> record size.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-prefetch_disable" xml:lang="en"><emphasis><varname>vfs.zfs.prefetch_disable</varname></emphasis>
	    - Disable prefetch.  A value of <literal>0</literal> is
	    enabled and <literal>1</literal> is disabled.  The default
	    is <literal>0</literal>, unless the system has less than
	    4 GB of <acronym>RAM</acronym>.  Prefetch works by
	    reading larger blocks than were requested into the
	    <link linkend="zfs-term-arc"><acronym>ARC</acronym></link>
	    in hopes that the data will be needed soon.  If the
	    workload has a large number of random reads, disabling
	    prefetch may actually improve performance by reducing
	    unnecessary reads.  This value can be adjusted at any time
	    with <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-vdev-trim_on_init" xml:lang="en"><emphasis><varname>vfs.zfs.vdev.trim_on_init</varname></emphasis>
	    - Control whether new devices added to the pool have the
	    <literal>TRIM</literal> command run on them.  This ensures
	    the best performance and longevity for
	    <acronym>SSD</acronym>s, but takes extra time.  If the
	    device has already been secure erased, disabling this
	    setting will make the addition of the new device faster.
	    This value can be adjusted at any time with
	    <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-vdev-max_pending" xml:lang="en"><emphasis><varname>vfs.zfs.vdev.max_pending</varname></emphasis>
	    - Limit the number of pending I/O requests per device.
	    A higher value will keep the device command queue full
	    and may give higher throughput.  A lower value will reduce
	    latency.  This value can be adjusted at any time with
	    <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-top_maxinflight" xml:lang="en"><emphasis><varname>vfs.zfs.top_maxinflight</varname></emphasis>
	    - Maxmimum number of outstanding I/Os per top-level
	    <link linkend="zfs-term-vdev">vdev</link>.  Limits the
	    depth of the command queue to prevent high latency.  The
	    limit is per top-level vdev, meaning the limit applies to
	    each <link linkend="zfs-term-vdev-mirror">mirror</link>,
	    <link linkend="zfs-term-vdev-raidz">RAID-Z</link>, or
	    other vdev independently.  This value can be adjusted at
	    any time with <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-l2arc_write_max" xml:lang="en"><emphasis><varname>vfs.zfs.l2arc_write_max</varname></emphasis>
	    - Limit the amount of data written to the <link linkend="zfs-term-l2arc"><acronym>L2ARC</acronym></link>
	    per second.  This tunable is designed to extend the
	    longevity of <acronym>SSD</acronym>s by limiting the
	    amount of data written to the device.  This value can be
	    adjusted at any time with <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-l2arc_write_boost" xml:lang="en"><emphasis><varname>vfs.zfs.l2arc_write_boost</varname></emphasis>
	    - The value of this tunable is added to <link linkend="zfs-advanced-tuning-l2arc_write_max"><varname>vfs.zfs.l2arc_write_max</varname></link>
	    and increases the write speed to the
	    <acronym>SSD</acronym> until the first block is evicted
	    from the <link linkend="zfs-term-l2arc"><acronym>L2ARC</acronym></link>.
	    This <quote>Turbo Warmup Phase</quote> is designed to
	    reduce the performance loss from an empty <link linkend="zfs-term-l2arc"><acronym>L2ARC</acronym></link>
	    after a reboot.  This value can be adjusted at any time
	    with <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-scrub_delay" xml:lang="en"><emphasis><varname>vfs.zfs.scrub_delay</varname></emphasis>
	    - Number of ticks to delay between each I/O during a
	    <link linkend="zfs-term-scrub"><command>scrub</command></link>.
	    To ensure that a <command>scrub</command> does not
	    interfere with the normal operation of the pool, if any
	    other <acronym>I/O</acronym> is happening the
	    <command>scrub</command> will delay between each command.
	    This value controls the limit on the total
	    <acronym>IOPS</acronym> (I/Os Per Second) generated by the
	    <command>scrub</command>.  The granularity of the setting
	    is determined by the value of <varname>kern.hz</varname>
	    which defaults to 1000 ticks per second.  This setting may
	    be changed, resulting in a different effective
	    <acronym>IOPS</acronym> limit.  The default value is
	    <literal>4</literal>, resulting in a limit of:
	    1000 ticks/sec / 4 =
	    250 <acronym>IOPS</acronym>.  Using a value of
	    <replaceable>20</replaceable> would give a limit of:
	    1000 ticks/sec / 20 =
	    50 <acronym>IOPS</acronym>.  The speed of
	    <command>scrub</command> is only limited when there has
	    been recent activity on the pool, as determined by <link linkend="zfs-advanced-tuning-scan_idle"><varname>vfs.zfs.scan_idle</varname></link>.
	    This value can be adjusted at any time with
	    <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-resilver_delay" xml:lang="en"><emphasis><varname>vfs.zfs.resilver_delay</varname></emphasis>
	    - Number of milliseconds of delay inserted between
	    each I/O during a
	    <link linkend="zfs-term-resilver">resilver</link>.  To
	    ensure that a resilver does not interfere with the normal
	    operation of the pool, if any other I/O is happening the
	    resilver will delay between each command.  This value
	    controls the limit of total <acronym>IOPS</acronym> (I/Os
	    Per Second) generated by the resilver.  The granularity of
	    the setting is determined by the value of
	    <varname>kern.hz</varname> which defaults to 1000 ticks
	    per second.  This setting may be changed, resulting in a
	    different effective <acronym>IOPS</acronym> limit.  The
	    default value is 2, resulting in a limit of:
	    1000 ticks/sec / 2 =
	    500 <acronym>IOPS</acronym>.  Returning the pool to
	    an <link linkend="zfs-term-online">Online</link> state may
	    be more important if another device failing could
	    <link linkend="zfs-term-faulted">Fault</link> the pool,
	    causing data loss.  A value of 0 will give the resilver
	    operation the same priority as other operations, speeding
	    the healing process.  The speed of resilver is only
	    limited when there has been other recent activity on the
	    pool, as determined by <link linkend="zfs-advanced-tuning-scan_idle"><varname>vfs.zfs.scan_idle</varname></link>.
	    This value can be adjusted at any time with
	    <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-scan_idle" xml:lang="en"><emphasis><varname>vfs.zfs.scan_idle</varname></emphasis>
	    - Number of milliseconds since the last operation before
	    the pool is considered idle.  When the pool is idle the
	    rate limiting for <link linkend="zfs-term-scrub"><command>scrub</command></link>
	    and
	    <link linkend="zfs-term-resilver">resilver</link> are
	    disabled.  This value can be adjusted at any time with
	    <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:id="zfs-advanced-tuning-txg-timeout" xml:lang="en"><emphasis><varname>vfs.zfs.txg.timeout</varname></emphasis>
	    - Maximum number of seconds between
	    <link linkend="zfs-term-txg">transaction group</link>s.
	    The current transaction group will be written to the pool
	    and a fresh transaction group started if this amount of
	    time has elapsed since the previous transaction group.  A
	    transaction group my be triggered earlier if enough data
	    is written.  The default value is 5 seconds.  A larger
	    value may improve read performance by delaying
	    asynchronous writes, but this may cause uneven performance
	    when the transaction group is written.  This value can be
	    adjusted at any time with <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>
      </itemizedlist>
    </sect2>

<!-- These sections will be added in the future
    <sect2 xml:id="zfs-advanced-booting">
      <title>Booting Root on <acronym>ZFS</acronym></title>

      <para></para>
    </sect2>

    <sect2 xml:id="zfs-advanced-beadm">
      <title><acronym>ZFS</acronym> Boot Environments</title>

      <para></para>
    </sect2>

    <sect2 xml:id="zfs-advanced-troubleshoot">
      <title>Troubleshooting</title>

      <para></para>
    </sect2>
-->

    <sect2 xml:id="zfs-advanced-i386">
      <title>i386 上的 <acronym>ZFS</acronym></title>

      <para><acronym>ZFS</acronym> 所提供的部份功能需要使用大量記憶體，且可能需要對有限 <acronym>RAM</acronym> 的系統調校來取得最佳的效率。</para>

      <sect3>
	<title>記憶體</title>

	<para>最低需求，總系統記憶體應至少有 1 GB，建議的 <acronym>RAM</acronym> 量需視儲存池的大小以及使用的 <acronym>ZFS</acronym> 功能而定。一般的經驗法則是每 1 TB 的儲存空間需要 1 GB 的 RAM，若有開啟去重複的功能，一般的經驗法則是每 1 TB 的要做去重複的儲存空間需要 5 GB 的 RAM。雖然有部份使用者成功使用較少的 <acronym>RAM</acronym> 來運作 <acronym>ZFS</acronym>，但系統在負載較重時有可能會因為記憶用耗而導致當機，對於要使用低於建議 RAM 需求量來運作的系統可能會需要更進一步的調校。</para>
      </sect3>

      <sect3>
	<title>核心設定</title>

	<para>由於在 <trademark>i386</trademark> 平台上位址空間的限制，在 <trademark>i386</trademark> 架構上的 <acronym>ZFS</acronym> 使用者必須加入這個選項到自訂核心設定檔，重新編譯核心並重新開啟：</para>

	<programlisting xml:lang="en">options        KVA_PAGES=512</programlisting>

	<para>這個選項會增加核心位址空間，允許調整 <varname>vm.kvm_size</varname> 超出目前的 1 GB 限制或在 <acronym>PAE</acronym> 的 2 GB 限制。要找到這個選項最合適的數值，可以將想要的位址空間換算成 MB 然後除以 4，在本例中，以 2 GB 計算後即為 <literal>512</literal>。</para>
      </sect3>

      <sect3>
	<title>載入程式可調參數</title>

	<para>在所有的 FreeBSD 架構上均可增加 <filename>kmem</filename> 位址空間，經測試在一個 1 GB 實體記憶體的測試系統上，加入以下選項到 <filename>/boot/loader.conf</filename>，重新開啟系統，可成功設定：</para>

	<programlisting xml:lang="en">vm.kmem_size="330M"
vm.kmem_size_max="330M"
vfs.zfs.arc_max="40M"
vfs.zfs.vdev.cache.size="5M"</programlisting>

	<para>要取得更多詳細的 <acronym>ZFS</acronym> 相關調校的建議清單，請參考 <link xlink:href="https://wiki.freebsd.org/ZFSTuningGuide"/>。</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="zfs-links">
    <title>其他資源</title>

    <itemizedlist>
      <listitem>
	<para xml:lang="en"><link xlink:href="https://wiki.freebsd.org/ZFS">FreeBSD
	    Wiki - <acronym>ZFS</acronym></link></para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="https://wiki.freebsd.org/ZFSTuningGuide">FreeBSD
	    Wiki - <acronym>ZFS</acronym> Tuning</link></para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="http://wiki.illumos.org/display/illumos/ZFS">Illumos
	    Wiki - <acronym>ZFS</acronym></link></para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="http://docs.oracle.com/cd/E19253-01/819-5461/index.html">Oracle
	    Solaris <acronym>ZFS</acronym> Administration
	    Guide</link></para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="https://calomel.org/zfs_raid_speed_capacity.html">Calomel
	    Blog - <acronym>ZFS</acronym> Raidz Performance, Capacity
	    and Integrity</link></para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="zfs-term">
    <title><acronym>ZFS</acronym> 特色與術語</title>

    <para><acronym>ZFS</acronym> 是一個從本質上與眾不同的檔案系統，由於它並非只是一個檔案系統，<acronym>ZFS</acronym> 結合了檔案系統及磁碟區管理程式，讓額外的儲存裝置可以即時的加入到系統並可讓既有的檔案系統立即使用這些在儲存池中空間。透過結合傳統區分為二的兩個角色，<acronym>ZFS</acronym> 能夠克服以往 <acronym>RAID</acronym> 磁碟群組無法擴充的限制。每個在儲存池頂層的裝置稱作 <emphasis>vdev</emphasis>，其可以是一個簡單的磁碟或是一個 <acronym>RAID</acronym> 如鏡像或 <acronym>RAID-Z</acronym> 陣列。<acronym>ZFS</acronym> 的檔案系統 (稱作 <emphasis>資料集 (Dataset)</emphasis>) 每一個資料集均可存取整個存池所共通的可用空間，隨著使用儲存池來配置空間區塊，儲存池能給每個檔案系統使用的可用空間就會減少，這個方法可以避免擴大分割區會使的可用空間分散分割區之間的常見問題。</para>

    <informaltable pgwide="1">
      <tgroup cols="2">
	<tbody valign="top">
	  <row>
	    <entry xml:id="zfs-term-pool">儲存池 (Pool)</entry>

	    <entry><emphasis>儲存池 (Pool)</emphasis> 是建構 <acronym>ZFS</acronym> 最基礎的單位。一個儲存池可由一個或多個 vdev 所組成，是用來儲存資料的底層裝置。儲存池會被拿來建立一個或多個檔案系統 (資料集 Dataset) 或區塊裝置 (磁碟區 Volume)，這些資料集與磁碟區會共用儲存池的剩餘可用空間。每一個儲存池可由名稱與 <acronym>GUID</acronym> 來辨識。可用的功能會依儲存池上的 <acronym>ZFS</acronym> 版本而有不同。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-vdev">vdev 型態 (vdev Types)</entry>

	    <entry>儲存池是由一個或多個 vdev 所組成，vdev 可以是一個磁碟或是 <acronym>RAID</acronym> Transform 的磁碟群組。當使用多個 vdev，<acronym>ZFS</acronym> 可以分散資料到各個 vdev 來增加效能與最大的可用空間。<itemizedlist>
		<listitem>
		  <para xml:id="zfs-term-vdev-disk"><emphasis>磁碟 (Disk)</emphasis> - 最基本的 vdev 型態便是一個標準的資料區塊裝置，這可以是一整個磁碟 (例如 <filename><replaceable>/dev/ada0</replaceable></filename> 或 <filename><replaceable>/dev/da0</replaceable></filename>) 或一個分割區 (<filename><replaceable>/dev/ada0p3</replaceable></filename>)。在 FreeBSD 上，使用分割區來替代整個磁碟不會影響效能，這可能與 Solaris 說明文件所建議的有所不同。</para>
		</listitem>

		<listitem>
		  <para xml:id="zfs-term-vdev-file"><emphasis>檔案 (File)</emphasis> - 除了磁碟外，<acronym>ZFS</acronym> 儲存池可以使用一般檔案為基礎，這在測試與實驗時特別有用。在 <command>zpool create</command> 時使用檔案的完整路徑作為裝置路徑。所有 vdev 必須至少有 128 MB 的大小。</para>
		</listitem>

		<listitem>
		  <para xml:id="zfs-term-vdev-mirror"><emphasis>鏡像 (Mirror)</emphasis> - 要建立鏡像，需使用 <literal>mirror</literal> 關鍵字，後面接著要做為該鏡像成員裝置的清單。一個鏡像需要由兩個或多個裝置來組成，所有的資料都會被寫入到所有的成員裝置。鏡像 vdev 可以對抗所有成員故障只剩其中一個而不損失任何資料。</para>

		  <note>
		    <para>正常單一磁碟的 vdev 可以使用 <command>zpool <link linkend="zfs-zpool-attach">attach</link></command> 隨時升級成為鏡像 vdev。</para>
		  </note>
		</listitem>

		<listitem>
		  <para xml:id="zfs-term-vdev-raidz"><emphasis><acronym>RAID-Z</acronym></emphasis> - <acronym>ZFS</acronym> 實作了 <acronym>RAID-Z</acronym>，以標準的 <acronym>RAID-5</acronym> 修改而來，可提供奇偶校驗 (Parity) 更佳的分散性並去除了 <quote><acronym>RAID-5</acronym> write hole</quote> 導致在預期之外的重啟後資料與奇偶校驗資訊不一致的問題。<acronym>ZFS</acronym> 支援三個層級的 <acronym>RAID-Z</acronym>，可提供不同程度的備援來換取減少不同程度的可用空間，類型的名稱以陣列中奇偶校驗裝置的數量與儲存池可以容許磁碟故障的數量來命名，從 <acronym>RAID-Z1</acronym> 到 <acronym>RAID-Z3</acronym> 。</para>

		  <para>在 <acronym>RAID-Z1</acronym> 配置 4 個磁碟，每個磁碟 1 TB，可用的儲存空間則為 3 TB，且若其中一個磁碟故障仍可以降級 (Degraded) 的模式運作，若在故障磁碟尚未更換並修復 (Resilver) 之前又有磁碟故障，所有在儲存池中的資料便會遺失。</para>

		  <para>在 <acronym>RAID-Z3</acronym> 配置 8 個 1 TB 的磁碟，磁碟區將會可以提供 5 TB 的可用空間且在 3 個磁碟故障的情況下仍可運作。<trademark>Sun</trademark> 建議單一個 vdev 不要使用超過 9 個磁碟。若配置需要使用更多磁碟，建議分成兩個 vdev，這樣儲存池的資料便會分散到這兩個 vdev。</para>

		  <para>使用兩個 <acronym>RAID-Z2</acronym> 各由 8 個磁碟組成的 vdev 的配置可以建立一個類似 <acronym>RAID-60</acronym> 的陣列。<acronym>RAID-Z</acronym> 群組的儲存空量會接近其中最小的磁碟乘上非奇偶校驗磁碟的數量。4 個 1 TB 磁碟在 <acronym>RAID-Z1</acronym> 會有接近 3 TB 的實際大小，且一個由 8 個 1 TB 磁碟組成的 <acronym>RAID-Z3</acronym> 陣列會有 5 TB 的可用空間。</para>
		</listitem>

		<listitem>
		  <para xml:id="zfs-term-vdev-spare"><emphasis>備援 (Spare)</emphasis> - <acronym>ZFS</acronym> 有特殊的虛擬 vdev 型態可用來持續追蹤可用的熱備援裝置 (Hot spare)。注意，安裝的熱備援裝置並不會自動佈署，熱備援裝置需要手動使用 <command>zfs replace</command> 設定替換故障的裝置。</para>
		</listitem>

		<listitem>
		  <para xml:id="zfs-term-vdev-log"><emphasis>日誌 (Log)</emphasis> - <acronym>ZFS</acronym> 記錄裝置，也被稱作 <acronym>ZFS</acronym> 意圖日誌 (ZFS Intent Log, <link linkend="zfs-term-zil"><acronym>ZIL</acronym></link>) 會從正常的儲存池裝置移動意圖日誌到獨立的裝置上，通常是一個 <acronym>SSD</acronym>。有了獨立的日誌裝置，可以明顯的增進有大量同步寫入應用程式的效能，特別是資料庫。日誌裝置可以做成鏡像，但不支援 <acronym>RAID-Z</acronym>，若使用多個日誌裝置，寫入動作會被負載平衡分散到這些裝置。</para>
		</listitem>

		<listitem>
		  <para xml:id="zfs-term-vdev-cache"><emphasis>快取 (Cache)</emphasis> - 加入快取 vdev 到儲存池可以增加儲存空間的 <link linkend="zfs-term-l2arc"><acronym>L2ARC</acronym></link> 快取。快取裝置無法做鏡像，因快取裝置只會儲存額外的現有資料的複本，並沒有資料遺失的風險。</para>
		</listitem>
	      </itemizedlist></entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-txg">交易群組 (Transaction Group, <acronym>TXG</acronym>)</entry>

	    <entry>交易群組是一種將更動的資料區塊包裝成一組的方式，最後再一次寫入到儲存池。交易群組是 <acronym>ZFS</acronym> 用來檢驗一致性的基本單位。每個交易群組會被分配一個獨一無二的 64-bit 連續代號。最多一次可以有三個活動中的交易群組，這三個交易群組的每一個都有這三種狀態：<itemizedlist>
		<listitem>
		  <para><emphasis>開放 (Open)</emphasis> - 新的交易群組建立之後便處於開放的狀態，可以接受新的寫入動作。永遠會有開放狀態的交易群組，即始交易群組可能會因到達上限而拒絕新的寫入動作。一但開放的交易群組到達上限或到達 <link linkend="zfs-advanced-tuning-txg-timeout"><varname>vfs.zfs.txg.timeout</varname></link>，交易群組便會繼續進入下一個狀態。</para>
		</listitem>

		<listitem>
		  <para><emphasis>靜置中 (Quiescing)</emphasis> - 一個短暫的狀態，會等候任何未完成的操作完成，不會阻擋新開放的交易群組建立。一旦所有在群組中的交易完成，交易群組便會進入到最終狀態。</para>
		</listitem>

		<listitem>
		  <para><emphasis>同步中 (Syncing)</emphasis> - 所有在交易群組中的資料會被寫任到穩定的儲存空間，這個程序會依序修改其他也需同樣寫入到穩定儲存空間的資料，如 Metadata 與空間對應表。同步的程多會牽涉多個循環，首先是同步所有更改的資料區塊，也是最大的部份，接著是 Metadata，這可能會需要多個循環來完成。由於要配置空間供資料區塊使用會產生新的 Metadata，同步中狀態在到達循環完成而不再需要分配任何額外空間的狀態前無法結束。同步中狀態也是完成 <emphasis>synctask</emphasis> 的地方，Synctask 是指管理操作，如：建立或摧毀快照與資料集，會修改 uberblock，也會在此時完成。同步狀態完成後，其他處於狀態中狀態的交易群組便會進入同步中狀態。</para>
		</listitem>
	      </itemizedlist> 所有管理功能如快照 (<link linkend="zfs-term-snapshot"><command>Snapshot</command></link>) 會作為交易群組的一部份寫入。當 synctask 建立之後，便會加入到目前開放的交易群組中，然後該群組會盡快的進入同步中狀態來減少管理指令的延遲。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-arc" xml:lang="en">Adaptive Replacement
	      Cache (<acronym>ARC</acronym>)</entry>

	    <entry><acronym>ZFS</acronym> 使用了自適應替換快取 (Adaptive Replacement Cache, <acronym>ARC</acronym>)，而不是傳統的最近最少使用 (Least Recently Used, <acronym>LRU</acronym>) 快取，LRU 快取在快取中是一個簡單的項目清單，會依每個物件最近使用的時間來排序，新項會加入到清單的最上方，當快取額滿了便會去除清單最下方的項目來空出空間給較常使用的物件。<acronym>ARC</acronym> 結合了四種快取清單，最近最常使用 (Most Recently Used, <acronym>MRU</acronym>) 及最常使用 (Most Frequently Used, <acronym>MFU</acronym>) 物件加上兩個清單各自的幽靈清單 (Ghost list)，這些幽靈清單會追蹤最近被去除的物件來避免又被加回到快取，避免過去只有偶爾被使用的物件加入清單可以增加快取的命中率。同時使用 <acronym>MRU</acronym> 及 <acronym>MFU</acronym> 的另外一個優點是掃描一個完整檔案系統可以去除在 <acronym>MRU</acronym> 或 <acronym>LRU</acronym> 快取中的所有資料，有利於這些才剛存取的內容。使用 <acronym>ZFS</acronym> 也有 <acronym>MFU</acronym> 可只追蹤最常使用的物件並保留最常被存取的資料區塊快取。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-l2arc" xml:lang="en"><acronym>L2ARC</acronym></entry>

	    <entry><acronym>L2ARC</acronym> 是  <acronym>ZFS</acronym> 快取系統的第二層，主要的 <acronym>ARC</acronym> 會儲存在 <acronym>RAM</acronym> 當中，但因為 <acronym>RAM</acronym> 可用的空間量通常有限，因此 <acronym>ZFS</acronym> 也可以使用 <link linkend="zfs-term-vdev-cache">快取 vdev (Cache vdev)</link>。固態磁碟 (Solid State Disk, <acronym>SSD</acronym>) 常被拿來此處作為快取裝置，因為比起傳統旋轉碟片的磁碟，固態磁碟有較快的速度與較低的延遲。<acronym>L2ARC</acronym> 是選用的，但使用可以明顯增進那些已使用 <acronym>SSD</acronym> 快取的檔案讀取速度，無須從一般磁碟讀取。<acronym>L2ARC</acronym> 也同樣可以加速去重複 (<link linkend="zfs-term-deduplication">Deduplication</link>)，因為 <acronym>DDT</acronym> 並不適合放在 <acronym>RAM</acronym>，但適合放在 <acronym>L2ARC</acronym>，比起要從磁碟讀取，可以加快不少速度。為了避免  <acronym>SSD</acronym> 因寫入次速過多而過早耗損，加入到快取裝置的資料速率會被限制，直到快取用盡 (去除第一個資料區塊來騰出空間) 之前，寫入到 <acronym>L2ARC</acronym> 的資料速率會限制在寫入限制 (Write limit) 與加速限制 (Boost limit) 的總合，之後則會限制為寫入限制，可以控制這兩個速度限制的 <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> 數值分別為 <link linkend="zfs-advanced-tuning-l2arc_write_max"><varname>vfs.zfs.l2arc_write_max</varname></link> 控制每秒有多少數位元組可寫入到快取，而 <link linkend="zfs-advanced-tuning-l2arc_write_boost"><varname>vfs.zfs.l2arc_write_boost</varname></link> 可在 <quote>渦輪預熱階段</quote> (即寫入加速) 時增加寫入限制。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-zil" xml:lang="en"><acronym>ZIL</acronym></entry>

	    <entry><acronym>ZIL</acronym> 會使用比主要儲存池還更快的儲存裝置來加速同步寫入動作 (Synchronous transaction)，如 <acronym>SSD</acronym>。當應用程式請求做一個同步的寫入時 (保証資料會安全的儲存到磁碟，而不是先快取稍後再寫入)，資料會先寫入到速度較快的 <acronym>ZIL</acronym> 儲存空間，之後再一併寫入到一般的磁碟。這可大量的減少延遲並增進效能。<acronym>ZIL</acronym> 只會有利於使用像資料庫這類的同步工作，一般非同步的寫入像複製檔案，則完全不會用到 <acronym>ZIL</acronym>。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-cow">寫入時複製 (Copy-On-Write)</entry>

	    <entry>不像傳統的檔案系統，在 <acronym>ZFS</acronym>，當資料要被覆寫時，不會直接覆寫舊資料所在的位置，而是將新資料會寫入到另一個資料區塊，只在資料寫入完成後才會更新 Metadata 指向新的位置。因此，在發生寫入中斷 (在寫入檔案的過程中系統當機或電源中斷) 時，原來檔案的完整內容並不會遺失，只會放棄未寫入完成的新資料，這也意謂著 <acronym>ZFS</acronym> 在發生預期之外的關機後不需要做 <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-dataset">資料集 (Dataset)</entry>

	    <entry><emphasis>資料集 (Dataset)</emphasis> 是 <acronym>ZFS</acronym> 檔案系統、磁碟區、快照或複本的通用術語。每個資料集都有獨一無二的名稱使用 <replaceable>poolname/path@snapshot</replaceable> 格式。儲存池的根部技術上來說也算一個資料集，子資料集會採用像目錄一樣的層級來命名，例如 <replaceable>mypool/home</replaceable>，home 資料集是 <replaceable>mypool</replaceable> 的子資料集並且會繼承其屬性。這可以在往後繼續擴展成 <replaceable>mypool/home/user</replaceable>，這個孫資料集會繼承其父及祖父的屬性。在子資料集的屬性可以覆蓋預設繼承自父及祖父的屬性。資料集及其子資料級的管理權限可以委託 (<link linkend="zfs-zfs-allow">Delegate</link>) 給他人。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-filesystem">檔案系統 (File system)</entry>

	    <entry><acronym>ZFS</acronym> 資料集最常被當做檔案系統使用。如同大多數其他的檔案系統，<acronym>ZFS</acronym> 檔案系統會被掛載在系統目錄層級的某一處且內含各自擁有權限、旗標及 Metadata 的檔案與目錄。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-volume">磁碟區 (Volume)</entry>

	    <entry>除了一般的檔案系統資料集之外，<acronym>ZFS</acronym> 也可以建立磁碟區 (Volume)，磁碟區是資料區塊裝置。磁碟區有許多與資料集相似的功能，包含複製時寫入、快照、複本以及資料校驗。要在 <acronym>ZFS</acronym> 的頂層執行其他檔案系統格式時使用磁碟區非常有用，例如 <acronym>UFS</acronym> 虛擬化或匯出 <acronym>iSCSI</acronym> 延伸磁區 (Extent)。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-snapshot">快照 (Snapshot)</entry>

	    <entry><acronym>ZFS</acronym> 的寫入時複製 (<link linkend="zfs-term-cow">Copy-On-Write</link>, <acronym>COW</acronym>) 設計可以使用任意的名稱做到幾乎即時、一致的快照。在製做資料集的快照或父資料集遞迴快照 (會包含其所有子資料集) 之後，新的資料會寫入到資的資料區塊，但不會回收舊的資料區塊為可用空間，快照中會使用原版本的檔案系統，而快照之後所做的變更則會儲存在目前的檔案系統，因此不會重複使用額外的空間。當新的資料寫入到目前的檔案系統，便會配置新的資料區塊來儲存這些資料。快照表面大小 (Apparent size) 會隨著在目前檔案系統停止使用的資料區塊而成長，但僅限於快照。可以用唯讀的方式掛載這些快照來復原先前版本的檔案，也可以還原 (<link linkend="zfs-zfs-snapshot">Rollback</link>) 目前的檔案系統到指定的快照，來還原任何在快照之後所做的變更。每個在儲存池中的資料區塊都會有一個參考記數器，可以用來持續追蹤有多少快照、複本、資料集或是磁碟區使用這個資料區塊，當刪除檔案與快照參照的計數變會滅少，直到沒有任何東西參考這個資料區塊才會被回收為可用空間。快照也可使用 <link linkend="zfs-zfs-snapshot">hold</link> 來標記，檔標記為 hold 時，任何嘗試要刪除該快照的動作便會回傳 <literal>EBUSY</literal> 的錯誤，每個快照可以標記多個不同唯一名稱的 hold，而 <link linkend="zfs-zfs-snapshot">release</link> 指令則可以移除 hold，這樣才可刪除快照。在磁碟區上快可以製作快照，但只能用來複製或還原，無法獨立掛載。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-clone">複本 (Clone)</entry>

	    <entry>快照也可以做複本，複本是可寫入版本的快照，讓檔案系統可分支成為新的資料集。如同快照，複本一開始不會消耗任何額外空間，隨著新資料寫入到複本會配置新的資料區塊，複本的表面大小 (Apparent size) 才會成長，當在複本檔案系統或磁碟區的資料區塊被覆寫時，在先前資料區塊的參考計數則會減少。建立複本所使用的快照無法被刪除，因為複本會相依該快照，快照為父，複本為子。複本可以被提升 (<emphasis>promoted</emphasis>)、反轉相依關係，來讓複本成為父，之前的父變為子，這個操作不需要額外的空間。由於反轉了父與子使用的空間量，所以可能會影響既有的配額 (Quota) 與保留空間 (Reservation)。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-checksum">校驗碼 (Checksum)</entry>

	    <entry>配置每個資料區塊快的同時也會做資料校驗，資料校驗用的演算法是依資料集屬性而有所不同的，請參考 <link linkend="zfs-zfs-set"><command>set</command></link>。每個資料區塊會在讀取的過成便完成校驗，讓 <acronym>ZFS</acronym> 可以偵測到隱藏的損壞，若資料不符合預期的校驗碼，<acronym>ZFS</acronym> 會嘗試從任何可用的備援來還原資料，例如鏡像 (Mirror) 或 <acronym>RAID-Z</acronym>。要檢驗所有資料的校驗碼可以使用清潔 (<link linkend="zfs-term-scrub"><command>Scrub</command></link>)，資料校驗的演算法有：<itemizedlist>
		<listitem>
		  <para><literal>fletcher2</literal></para>
		</listitem>

		<listitem>
		  <para><literal>fletcher4</literal></para>
		</listitem>

		<listitem>
		  <para><literal>sha256</literal></para>
		</listitem>
	      </itemizedlist> <literal>fletcher</literal> 演算法最快，而 <literal>sha256</literal> 雖較消耗效能，但其有強大的密碼雜湊與較低的衝突率。也可關閉資料校驗，但並不建議。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-compression">壓縮 (Compression)</entry>

	    <entry>每個資料集都有壓縮 (Compression) 屬性，預設是關閉的，這個屬性可以設定使用以下幾個壓縮演算法的其中一個來壓縮寫入到資料集的新資料。壓縮除了減少空間使用量外，常也會增加讀取與寫入的吞吐量，因為會減少讀取與寫入的資料區塊。 <itemizedlist>
		<listitem xml:id="zfs-term-compression-lz4">
		  <para><emphasis><acronym>LZ4</acronym></emphasis> - <acronym>ZFS</acronym> 儲存池版本 5000 (功能旗標) 後所增加，<acronym>LZ4</acronym> 現在是建議的壓縮演算法，在處理可壓縮的資料時 <acronym>LZ4</acronym> 壓縮比 <acronym>LZJB</acronym> 快將近 50%，在處理不可壓縮的資料時快將近三倍，<acronym>LZ4</acronym> 解壓縮也比 <acronym>LZJB</acronym> 將近 80%。在現代的 <acronym>CPU</acronym> 上，<acronym>LZ4</acronym> 經常平均可用 500 MB/s 的速度壓縮，而解壓縮可到達 1.5 GB/s (每個 CPU 核心)。</para>
		</listitem>

		<listitem xml:id="zfs-term-compression-lzjb">
		  <para><emphasis><acronym>LZJB</acronym></emphasis> - 預設的壓縮演算法。由 Jeff Bonwick 所開發 (<acronym>ZFS</acronym> 的創始人之一)。<acronym>LZJB</acronym> 與 <acronym>GZIP</acronym> 相比，可以較低的 <acronym>CPU</acronym> 提供較佳的壓縮功能。在未來預設的壓縮演算法將會更換為 <acronym>LZ4</acronym>。</para>
		</listitem>

		<listitem xml:id="zfs-term-compression-gzip">
		  <para><emphasis><acronym>GZIP</acronym></emphasis> - 在 <acronym>ZFS</acronym> 可用的熱門串流壓縮演算法。使用 <acronym>GZIP</acronym> 主要的優點之一便是可設定壓縮層級。當設定 <literal>compress</literal> 屬性，管理者可以選擇壓縮層級範圍從最低的壓縮層級 <literal>gzip1</literal> 到最高的壓縮層級 <literal>gzip9</literal>。這讓管理者可以控制要使用多少 <acronym>CPU</acronym> 來節省磁碟空間。</para>
		</listitem>

		<listitem xml:id="zfs-term-compression-zle">
		  <para><emphasis><acronym>ZLE</acronym></emphasis> - 零長度編號是一個特殊的壓縮演算法，它只會壓縮連續的零。這種壓縮演算法只在資料集中含有大量為零的資料區塊時有用。</para>
		</listitem>
	      </itemizedlist></entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-copies">備份數 (Copies)</entry>

	    <entry>當設定大於 1 的數值時，<literal>copies</literal> 屬性會指示 <acronym>ZFS</acronym> 備份每個在檔案系統 (<link linkend="zfs-term-filesystem">File System</link>) 或磁碟區 (<link linkend="zfs-term-volume">Volume</link>) 的資料區塊數份。在重要的資料集上設定這個屬性可以做額外的備援以在資料校驗碼不相符時可做復原。在沒有做備援的儲存池上，備份功能提供只是一種資料的備援方式，備份功能可以復原單一壞軌或其他情況的次要損壞，但無法復原儲存池中整個磁碟損壞所損失的資料。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-deduplication">去重複 (Deduplication)</entry>

	    <entry>校驗碼讓在寫入時可以偵測重複資料區塊，使用去重複，可以增加既有、完全相同的資料區塊參考數來節省儲存空間。要偵測重複的資料區塊需要在記憶體中儲存去重複資料表 (Deduplication table, <acronym>DDT</acronym>)，這個資料表中會有唯一的校驗碼清單、這些資料區塊的所在位置以及參考數。當寫入新資料時，便會計算校驗碼然後比對清單中是否有符合的既有資料區塊已在清單。去重複使用了 <acronym>SHA256</acronym> 校驗碼演算法來提供一個安全的加密雜湊，去重複功能是可以調校的，若 <literal>dedup</literal> 設為 <literal>on</literal> 只要符合校驗碼便會認為資料完全相同，若 <literal>dedup</literal> 設為 <literal>verify</literal> 則會一個一個位元檢查兩個資料區塊的資料來確保資料真的完全相同，若資料不同便會註記與雜湊衝突並會分別儲存兩個資料區塊。由於 <acronym>DDT</acronym> 須要儲存每個唯一資料區塊的雜湊，所以會消耗大量的記憶體，一般的經驗法則是每 1 TB 的去重複資料需要使用 5-6 GB 的記憶體。由於要有足夠的 <acronym>RAM</acronym> 來儲存整個 <acronym>DDT</acronym> 在實務上並不實際，導致在每個新資料區塊寫入前需要從磁碟來讀取 <acronym>DDT</acronym> 會對效能有很大的影響，去重複功能可以使用 <acronym>L2ARC</acronym> 儲存 <acronym>DDT</acronym> 以在快速的系統記憶體及較慢的磁碟之間取得一個平衡點。也可以考慮使用壓縮功能來取代此功能，因為壓縮也能節省相近的空間使用量而不需要大量額外的記憶體。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-scrub">清潔 (Scrub)</entry>

	    <entry><acronym>ZFS</acronym>  有 <command>scrub</command> 來替代 <citerefentry><refentrytitle>fsck</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來做一致性的檢查。<command>scrub</command> 會讀取所有儲存在儲存池中的資料區塊並且根據儲存在 Metadata 中已知良好的校驗碼來檢驗這些資料區塊的校驗碼，定期檢查儲存池中儲存的所有資料可以確保實際使用這些資料前已將所有損壞的資料區塊復原。在不正常的關閉之後並不需要做清潔動作，但建議每三個月至少執行一次。在正常使用讀取時便會檢查每個資料區塊的校驗碼，但清潔動作可以確保那些不常用的資料也會被檢查以避免隱藏的損壞，如此便能增進資料的安全性，特別是對用來保存資料的儲存裝置。<command>scrub</command> 可以使用 <link linkend="zfs-advanced-tuning-scrub_delay"><varname>vfs.zfs.scrub_delay</varname></link> 調整相對優先權來避免清潔動作降低儲存池上其他工作的效率。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-quota">資料集配額 (Dataset Quota)</entry>

	    <entry>除了配額及空間保留外，<acronym>ZFS</acronym> 提供非常快速且準確的資料集、使用者及群組空間的計算功能，這可讓管理者調整空間配置的方式且可為重要的檔案系統保留空間。 <para><acronym>ZFS</acronym> supports different types of
		quotas: the dataset quota, the <link linkend="zfs-term-refquota">reference
		  quota (<acronym>refquota</acronym>)</link>, the
		<link linkend="zfs-term-userquota">user
		  quota</link>, and the
		<link linkend="zfs-term-groupquota">group
		  quota</link>.</para> <para>配額會限制資料集及後裔包含資料集的快照、子資料集及子資料集的快照能使用的空間量。</para> <note>
		<para>磁碟區上無法設定配額，因為 <literal>volsize</literal> 屬性已經被用來做內定的配額。</para>
	      </note></entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-refquota">參考配額 (Reference Quota)</entry>

	    <entry>參考配額可以設定一個硬性限制 (Hard limit) 來限制資料集能使用的空間量，而這個硬性限制只包含了資料集參考的空間，並不含其後裔所使用的空間，如：檔案系統或快照。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-userquota">使用者配額 (User Quota)</entry>

	    <entry>使用者配額在用來限制特定使用者能使用的空間量時非常有用。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-groupquota">群組配額 (Group Quota)</entry>

	    <entry>群組配額可以限制特定群組能使用的空間量。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-reservation">資料集保留空間 (Dataset Reservation)</entry>

	    <entry><literal>reservation</literal> 屬性可以確保對特定資料集及其後裔最小可用的空間量，若在 <filename>storage/home/bob</filename> 設定 10 GB 的保留空間且其他資料集嘗試使用所有剩餘的空間時，會保留至少 10 GB 的空間供這個資料集使用。若要製作 <filename>storage/home/bob</filename> 的快照，該快照所使用的空間也會被列入保留空間計算。 <link linkend="zfs-term-refreservation"><literal>refreservation</literal></link> 屬性也以類似的方式運作，但是他 <emphasis>不包含</emphasis> 後裔，例如：快照。 <para>不管那一種保留空間在許多情境皆很有用，例如：要規劃與測試磁碟空間配置在新系統上的適應性，或是確保有足夠的空間供稽查日誌或系統還原程序及檔案使用。</para></entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-refreservation">參考保留空間 (Reference Reservation)</entry>

	    <entry><literal>refreservation</literal> 屬性可以確保對特定資料集 <emphasis>不包含</emphasis> 其後裔最小可用的空間，這代表若在 <filename>storage/home/bob</filename> 設定 10 GB 的保留空間且其他資料集嘗試使用所有剩餘的空間時，會保留至少 10 GB 的空間供這個資料集使用。於正常 <link linkend="zfs-term-reservation">reservation</link> 不同的是，由快照及後裔資料集所使用的空間並不會列入保留空間計算。例如，若要製作一個 <filename>storage/home/bob</filename> 的快照，在 <literal>refreservation</literal> 空間之外必須要有足夠的空間才能成功完成這項操作，主資料集的後裔並不會列入 <literal>refreservation</literal> 空間額計算，所以也不會佔用保留空間。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-resilver">修復 (Resilver)</entry>

	    <entry>當有磁碟故障且被更換後，新的磁碟必須回存先前所遺失的資料，會使用分散在其他磁碟上的奇偶校驗資訊來計算並寫入遺失的資料到新的磁碟機的這個程序稱作 <emphasis>修復 (Resilvering)</emphasis>。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-online">上線 (Online)</entry>

	    <entry>一個儲存池或 vdev 處於線上 (<literal>Online</literal>) 狀態時代表所有該裝置的成員均已連結且正常運作。個別裝置處於線上 (<literal>Online</literal>) 狀態時代表功能正常。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-offline">離線 (Offline)</entry>

	    <entry>若有足夠的備援可避免儲存池或 vdev  進入故障 (<link linkend="zfs-term-faulted">Faulted</link>) 狀態，個別裝置若可由管理者設為離線 (<literal>Offline</literal>) 狀態，管理者可以選擇要設定那一個磁碟為離線來準備更換或是讓其更容易辨識。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-degraded">降級 (Degraded)</entry>

	    <entry>一個儲存池或 vdev 處於降級 (<literal>Degraded</literal>) 狀態代表其有一個或多個磁碟已斷線或故障，此時儲存池仍可以使用，但只要再有其他的裝置故障，儲存池會無法復原。重新連線缺少的裝置或更換故障的磁碟，並在新裝置完成修復 (<link linkend="zfs-term-resilver">Resilver</link>) 程序可讓儲存池返回線上 (<link linkend="zfs-term-online">Online</link>) 狀態。</entry>
	  </row>

	  <row>
	    <entry xml:id="zfs-term-faulted">故障 (Faulted)</entry>

	    <entry>一個儲存池或 vdev 處於故障 (<literal>Faulted</literal>) 狀態代表無法運作，會無法存取在該裝置上的資料。當在 vdev 中缺少或故障的裝置數超過備援的層級，儲存池或 vdev 會進入故障 (<literal>Faulted</literal>) 狀態。若缺少的裝置可以重新連結上，儲存池便會返回線上 (<link linkend="zfs-term-online">Online</link>) 狀態。若沒有足夠的備援可補償故障的磁碟數量便會遺失儲存池中的內容且只能從備份還原。</entry>
	  </row>
	</tbody>
      </tgroup>
    </informaltable>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project
     $FreeBSD$
-->
<chapter version="5.0" xml:id="filesystems">
  <info>
    <title>其他檔案系統</title>

    <authorgroup>
      <author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Written
	by </contrib></author>
    </authorgroup>
  </info>

  <sect1 xml:id="filesystems-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en"><primary>File Systems</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>File Systems Support</primary>
      <see>File Systems</see>
    </indexterm>

    <para xml:lang="en">File systems are an integral part of any operating system.
      They allow users to upload and store files, provide access to
      data, and make hard drives useful.  Different operating systems
      differ in their native file system.  Traditionally, the native
      FreeBSD file system has been the Unix File System
      <acronym>UFS</acronym> which has been modernized as
      <acronym>UFS2</acronym>.  Since FreeBSD 7.0, the Z File System
      (<acronym>ZFS</acronym>) is also available as a native file
      system.  See <xref linkend="zfs"/> for more information.</para>

    <para xml:lang="en">In addition to its native file systems, FreeBSD supports a
      multitude of other file systems so that data from other
      operating systems can be accessed locally, such as data stored
      on locally attached <acronym>USB</acronym> storage devices,
      flash drives, and hard disks.  This includes support for the
      <trademark class="registered">Linux</trademark> Extended File System (<acronym>EXT</acronym>).</para>

    <para xml:lang="en">There are different levels of FreeBSD support for the various
      file systems.  Some require a kernel module to be loaded and
      others may require a toolset to be installed.  Some non-native
      file system support is full read-write while others are
      read-only.</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">The difference between native and supported file
	  systems.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Which file systems are supported by FreeBSD.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to enable, configure, access, and make use of
	  non-native file systems.</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Understand <trademark class="registered">UNIX</trademark> and
	  <link linkend="basics">FreeBSD basics</link>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Be familiar with the basics of <link linkend="kernelconfig">kernel configuration and
	    compilation</link>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Feel comfortable <link linkend="ports">installing
	    software</link> in FreeBSD.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Have some familiarity with <link linkend="disks">disks</link>, storage, and device names in
	  FreeBSD.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="filesystems-linux">
    <title><trademark class="registered">Linux</trademark> 檔案系統</title>

    <para xml:lang="en">FreeBSD provides built-in support for several <trademark class="registered">Linux</trademark> file
      systems.  This section demonstrates how to load support for and
      how to mount the supported <trademark class="registered">Linux</trademark> file systems.</para>

    <sect2>
      <title xml:lang="en"><acronym>ext2</acronym></title>

      <para xml:lang="en">Kernel support for ext2 file systems has
	been available since FreeBSD 2.2.  In FreeBSD 8.x and
	earlier, the code is licensed under the
	<acronym>GPL</acronym>.  Since FreeBSD 9.0, the code has
	been rewritten and is now <acronym>BSD</acronym>
	licensed.</para>

      <para xml:lang="en">The <citerefentry><refentrytitle>ext2fs</refentrytitle><manvolnum>5</manvolnum></citerefentry> driver allows the FreeBSD kernel to both
	read and write to ext2 file systems.</para>

      <note>
	<para xml:lang="en">This driver can also be used to access ext3 and ext4
	  file systems.  The <citerefentry><refentrytitle>ext2fs</refentrytitle><manvolnum>5</manvolnum></citerefentry> filesystem has full read
	  and write support for ext4 as of FreeBSD 12.0-RELEASE.
	  Additionally, extended attributes and ACLs are also
	  supported, while journalling and encryption are not.
	  Starting with FreeBSD 12.1-RELEASE, a DTrace provider will
	  be available as well.  Prior versions of FreeBSD can access
	  ext4 in read and write mode using
	  <package>sysutils/fusefs-ext2</package>.</para>
      </note>

      <para xml:lang="en">To access an ext file system, first
	load the kernel loadable module:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload ext2fs</userinput></screen>

      <para xml:lang="en">Then, mount the ext volume by specifying its FreeBSD
	partition name and an existing mount point.  This example
	mounts <filename>/dev/ad1s1</filename> on
	<filename>/mnt</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mount -t ext2fs <replaceable>/dev/ad1s1</replaceable> <replaceable>/mnt</replaceable></userinput></screen>
    </sect2>
  </sect1>

  <!--
  <sect1>
    <title>Device File System</title>
  </sect1>

  <sect1>
    <title>DOS and NTFS File Systems</title>
    <para>This is a good section for those who transfer files, using
      USB devices, from Windows to FreeBSD and vice-versa.  My camera,
      and many other cameras I have seen default to using FAT16.  There
      is (was?) a kde utility, I think called kamera, that could be used
      to access camera devices.  A section on this would be useful.</para>

    <para>XXXTR: Though!  The disks chapter, covers a bit of this and
      devfs under it's USB devices.  It leaves a lot to be desired though,
      see:
https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/usb-disks.html
      It may be better to flesh out that section a bit more.  Add the
      word "camera" to it so that others can easily notice.</para>
  </sect1>

  <sect1>
    <title>Linux EXT File System</title>

    <para>Probably NOT as useful as the other two, but it requires
      knowledge of the existence of the tools.  Which are hidden in
      the ports collection.  Most Linux guys would probably only use
      Linux, BSD guys would be smarter and use NFS.</para>
  </sect1>

  <sect1>
    <title>HFS</title>

    <para>I think this is the file system used on Apple OSX.  There are
      tools in the ports collection, and with Apple being a big
      FreeBSD supporter and user of our technologies, surely there
      is enough cross over to cover this?</para>
  </sect1>
  -->

</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="virtualization">

  <info>
    <title>虛擬化</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Murray</firstname>
	  <surname>Stokely</surname>
	</personname>
	<contrib>Contributed by </contrib>
      </author>
    </authorgroup>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Allan</firstname>
	  <surname>Jude</surname>
	</personname>
	<contrib>bhyve section by </contrib>
      </author>
    </authorgroup>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Benedict</firstname>
	  <surname>Reuschling</surname>
	</personname>
	<contrib>Xen section by </contrib>
      </author>
    </authorgroup>
  </info>

  <sect1 xml:id="virtualization-synopsis">
    <title>概述</title>

    <para>虛擬化軟體可以讓同一台機器得以同時執行多種作業系統。在 <acronym>PC</acronym> 上的這類軟體系統通常涉及的角色有執行虛擬化軟體的主端 (Host) 作業系統以及數個安裝在其中的客端 (Guest) 作業系統。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>主端作業系統及客端作業系統的差別。</para>
      </listitem>

      <listitem>
	<para>如何在 <trademark class="registered">Intel</trademark>-based <trademark class="registered">Apple</trademark> <trademark class="registered">Mac</trademark> 電腦安裝 FreeBSD 。</para>
      </listitem>

      <listitem>
	<para>如何在 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 使用 <application>Virtual PC</application> 安裝 FreeBSD。</para>
      </listitem>

      <listitem>
	<para>如何以 FreeBSD 作為客端安裝在 <application>bhyve</application>。</para>
      </listitem>

      <listitem>
	<para>如何調校 FreeBSD 系統來取得虛擬化的最佳效能。</para>
      </listitem>

    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>了解 <link linkend="basics"><trademark class="registered">UNIX</trademark> 與 FreeBSD 的基礎</link>。</para>
      </listitem>

      <listitem>
	<para>知道如何<link linkend="bsdinstall">安裝 FreeBSD</link>。</para>
      </listitem>

      <listitem>
	<para>知道如何<link linkend="advanced-networking">設定網路連線</link>。</para>
      </listitem>

      <listitem>
	<para>知道如何<link linkend="ports">安裝其他第三方軟體</link>。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="virtualization-guest-parallels">
    <title>在 <trademark class="registered">Mac OS</trademark> X 的 <application>Parallels</application> 安裝 FreeBSD 為客端</title>

    <para><trademark class="registered">Mac</trademark> 的 <application>Parallels Desktop</application> 是一套商業軟體可在 <trademark class="registered">Intel</trademark> 為基礎的 <trademark class="registered">Apple</trademark> <trademark class="registered">Mac</trademark> 的 <trademark class="registered">Mac OS</trademark> 10.4.6 或更新版本上執行。 該軟體完全支援使用 FreeBSD 作為客端作業系統。 在 <trademark class="registered">Mac OS</trademark> X 裝好 <application>Parallels</application> 後，使用者必先完成虛擬機器的設定後才可安裝想使用的客端作業系統。</para>

    <sect2 xml:id="virtualization-guest-parallels-install">
      <title>在 Parallels/<trademark class="registered">Mac OS</trademark> X 安裝 FreeBSD</title>

      <para>在 <application>Parallels</application> 上安裝 FreeBSD 的第一步是建立供安裝 FreeBSD 使用的新虛擬機器。提示出現後請選擇 <guimenu>Guest OS Type</guimenu> 為 <guimenuitem>FreeBSD</guimenuitem>：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd1"/>
	</imageobject>
      </mediaobject>

      <para>根據您對此虛擬 FreeBSD 作業系統的規畫選擇合理的磁碟及記憶體空間，對大多數在 <application>Parallels</application> 下的 FreeBSD 使用來講 4GB 的磁碟空間與 512MB 的 RAM 便足夠：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd2"/>
	</imageobject>
      </mediaobject>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd3"/>
	</imageobject>
      </mediaobject>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd4"/>
	</imageobject>
      </mediaobject>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd5"/>
	</imageobject>
      </mediaobject>

      <para>選擇網路類型以及網路介面：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd6"/>
	</imageobject>
      </mediaobject>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd7"/>
	</imageobject>
      </mediaobject>

      <para>儲存並完成設定：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd8"/>
	</imageobject>
      </mediaobject>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd9"/>
	</imageobject>
      </mediaobject>

      <para>在 FreeBSD 虛擬機器新增後，就可以繼續以其安裝 FreeBSD。 安裝方面，比較好的作法是使用官方的 FreeBSD <acronym>CD</acronym>/<acronym>DVD</acronym> 或者是自官方 <acronym>FTP</acronym> 站下載的 <acronym>ISO</acronym> 映像檔。 複製適合的 <acronym>ISO</acronym> 映像檔到 <trademark class="registered">Mac</trademark> 檔案系統本地端或放入 <acronym>CD</acronym>/<acronym>DVD</acronym> 到 <trademark class="registered">Mac</trademark> 的 <acronym>CD-ROM</acronym> 磁碟機。在 FreeBSD <application>Parallels</application> 視窗的右下角點選磁碟圖示後會出現一個視窗，可用來建立虛擬機器內的 <acronym>CD-ROM</acronym> 磁碟機與磁碟上 <acronym>ISO</acronym> 檔案或實際 <acronym>CD-ROM</acronym> 磁碟機的關聯。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd11"/>
	</imageobject>
      </mediaobject>

      <para>建立與 <acronym>CD-ROM</acronym> 來源的關聯後，點選重新開機圖示重新開啟 FreeBSD 虛擬機器。<application>Parallels</application> 會重新開機進入一個特殊的 <acronym>BIOS</acronym> 畫面並檢查是否有 <acronym>CD-ROM</acronym>。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd10"/>
	</imageobject>
      </mediaobject>

      <para>在此處會找到 FreeBSD 安裝媒體並開始正常的 FreeBSD 安裝程序。完成安裝，但不要在此時嘗試設定 <application>Xorg</application>。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd12"/>
	</imageobject>
      </mediaobject>

      <para>當安裝完成後，重新開機將會進入新安裝的 FreeBSD 虛擬機器。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/parallels-freebsd13"/>
	</imageobject>
      </mediaobject>
    </sect2>

    <sect2 xml:id="virtualization-guest-parallels-configure">
      <title>在 <application>Parallels</application> 設定 FreeBSD</title>

      <para>在成功將 FreeBSD 安裝到 <trademark class="registered">Mac OS</trademark> X 的 <application>Parallels</application> 後，有數個設定步驟要完成來最佳化系統在虛擬機器上的運作。</para>

      <procedure>
	<step>
	  <title>設定 Boot Loader 變數</title>

	  <para>最重要的一個步驟是減少 <option>kern.hz</option> 參數來減少 FreeBSD 在 <application>Parallels</application> 環境下對 CPU 的使用率。加入以下行到 <filename>/boot/loader.conf</filename> 來完成這個動作：</para>

	  <programlisting xml:lang="en">kern.hz=100</programlisting>

	  <para>若沒有完成此設定，閒置的 FreeBSD <application>Parallels</application> 客端將會消耗掉單一處理器的 <trademark class="registered">iMac</trademark> 將近 15% 的 CPU。完成此更改後使用率會減至接近 5%。</para>
	</step>

	<step>
	  <title>建立新核心設定檔</title>

	  <para>所有的 SCSI, FireWire 及 USB 裝置可以從自訂的核心設定檔中移除。<application>Parallels</application> 提供的虛擬網路卡使用 <citerefentry><refentrytitle>ed</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式，所以除了 <citerefentry><refentrytitle>ed</refentrytitle><manvolnum>4</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>miibus</refentrytitle><manvolnum>4</manvolnum></citerefentry> 外的所有網路裝置可以自核心中移除。</para>
	</step>

	<step>
	  <title>設定網路</title>

	  <para>最基本的網路設定是使用 DHCP 來讓虛擬機器連線到與主端 <trademark class="registered">Mac</trademark> 相同的區域網路，這可以透過加入 <literal>ifconfig_ed0="DHCP"</literal> 到 <filename>/etc/rc.conf</filename> 來完成。更進階的網路設定在 <xref linkend="advanced-networking"/> 中描述。</para>
	</step>
      </procedure>
    </sect2>
  </sect1>

  <sect1 xml:id="virtualization-guest-virtualpc">
    <title>在 <trademark class="registered">Windows</trademark> 的 <application>Virtual PC</application> 安裝 FreeBSD 為客端</title>

    <para>給 <trademark class="registered">Windows</trademark> 使用的 <application>Virtual PC</application> 是一套可免費下載的 <trademark class="registered">Microsoft</trademark> 軟體產品，請參考此網站取得<link xlink:href="http://www.microsoft.com/windows/downloads/virtualpc/sysreq.mspx">系統需求</link>。<application>Virtual PC</application> 在 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 上安裝完成之後，使用者可以設定一台虛擬機器然後安裝想要的客端作業系統。</para>

    <sect2 xml:id="virtualization-guest-virtualpc-install">
      <title>在 <application>Virtual PC</application> 安裝 FreeBSD</title>

      <para>安裝 FreeBSD 到 <application>Virtual PC</application> 的第一個步驟是建立新的虛擬機器來安裝 FreeBSD。當提示畫面出現時，請選擇 <guimenuitem>Create a virtual machine</guimenuitem>：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd1"/>
	</imageobject>
      </mediaobject>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd2"/>
	</imageobject>
      </mediaobject>

      <para>當提示畫面出現時，選擇 <guimenuitem>Operating system</guimenuitem> 為 <guimenuitem>Other</guimenuitem>：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd3"/>
	</imageobject>
      </mediaobject>

      <para>然後，根據您對此虛擬 FreeBSD 作業系統的規畫選擇合理的磁碟及記憶體空間，對大多數在 <application>Virtual PC</application> 下的 FreeBSD 使用來講 4GB 的磁碟空間與 512MB 的 RAM 便足夠：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd4"/>
	</imageobject>
      </mediaobject>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd5"/>
	</imageobject>
      </mediaobject>

      <para>儲存並完成設定：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd6"/>
	</imageobject>
      </mediaobject>

      <para>選擇 FreeBSD 虛擬機器然後點選 <guimenu>Settings</guimenu>，接著設定網路類型及網路介面卡：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd7"/>
	</imageobject>
      </mediaobject>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd8"/>
	</imageobject>
      </mediaobject>

      <para>FreeBSD 虛擬機器建立完成之後，便可安裝 FreeBSD 到該虛擬機器。安裝最好使用官方 FreeBSD <acronym>CD</acronym>/<acronym>DVD</acronym> 或使用自官方 <acronym>FTP</acronym> 站下載的 <acronym>ISO</acronym> 映像檔。複製適當的 <acronym>ISO</acronym> 映像檔到本地 <trademark class="registered">Windows</trademark> 檔案系統或插入 <acronym>CD</acronym>/<acronym>DVD</acronym> 到 <acronym>CD</acronym> 磁碟機，然後雙擊點選 FreeBSD 虛擬機器來開機。接著，點選 <guimenu>CD</guimenu> 並在 <application>Virtual PC</application> 視窗選擇 <guimenu>Capture ISO Image...</guimenu>，這將會顯示一個視窗可以建立虛擬機器中的 <acronym>CD-ROM</acronym> 與 <acronym>ISO</acronym> 檔或磁碟或實體 <acronym>CD-ROM</acronym> 磁碟機之間的關聯。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd9"/>
	</imageobject>
      </mediaobject>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd10"/>
	</imageobject>
      </mediaobject>

      <para>建立與 <acronym>CD-ROM</acronym> 來源的關聯後，點選 <guimenu>Action</guimenu> 及 <guimenu>Reset</guimenu> 重新開機 FreeBSD 虛擬機器。<application>Virtual PC</application> 會重新開始並進入特殊的 <acronym>BIOS</acronym> 來做 <acronym>CD-ROM</acronym> 的第一次檢查。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd11"/>
	</imageobject>
      </mediaobject>

      <para>在這個情況下會找到 FreeBSD 安裝媒體然後開始正常的 FreeBSD 安裝。接著繼續安裝，但此時請不要嘗試設定 <application>Xorg</application>。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd12"/>
	</imageobject>
      </mediaobject>

      <para>當安裝完成之後，記得退出 <acronym>CD</acronym>/<acronym>DVD</acronym> 或釋放 <acronym>ISO</acronym> 映像檔。最後，重新開機進入新安裝的 FreeBSD 虛擬機器。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/virtualpc-freebsd13"/>
	</imageobject>
      </mediaobject>
    </sect2>

    <sect2 xml:id="virtualization-guest-virtualpc-configure">
      <title>在 <application>Virtual PC</application> 設定 FreeBSD</title>

      <para>在成功將 FreeBSD 安裝到 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 的 <application>Virtual PC</application> 後，有數個設定步驟要完成來最佳化系統在虛擬機器上的運作。</para>

      <procedure>
	<step>
	  <title>設定 Boot Loader 變數</title>

	  <para>最重要的一個步驟是減少 <option>kern.hz</option>，來減少 FreeBSD 在 <application>Virtual PC</application> 環境下 CPU 的使用量。這可以透過加入下列幾行到 <filename>/boot/loader.conf</filename> 來完成：</para>

	  <programlisting xml:lang="en">kern.hz=100</programlisting>

	  <para>若沒有完成此設定，閒置的 FreeBSD <application>Virtual PC</application> 客端 OS 會消耗掉單一處理器的電腦 40% 的 CPU。完成此更改後使用率會減至接近 3%。</para>
	</step>

	<step>
	  <title>建立新核心設定檔</title>

	  <para>所有的 SCSI, FireWire 及 USB 裝置可以從自訂的核心設定檔中移除。<application>Virtual PC</application> 提供的虛擬網路卡使用 <citerefentry><refentrytitle>de</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式，所以除了 <citerefentry><refentrytitle>de</refentrytitle><manvolnum>4</manvolnum></citerefentry> 以及 <citerefentry><refentrytitle>miibus</refentrytitle><manvolnum>4</manvolnum></citerefentry> 外的所有網路裝置可以自核心中移除。</para>
	</step>

	<step>
	  <title>設定網路</title>

	  <para>最基本的網路設定是使用 DHCP 來讓虛擬機器連線到與主端 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 相同的區域網路，這可以透過加入 <literal>ifconfig_de0="DHCP"</literal> 到 <filename>/etc/rc.conf</filename> 來完成。更進階的網路設定在 <xref linkend="advanced-networking"/> 中描述。</para>
	</step>
      </procedure>
    </sect2>
  </sect1>

  <sect1 xml:id="virtualization-guest-vmware">
    <title>在 <trademark class="registered">Mac OS</trademark> 的 <application>VMware Fusion</application> 安裝 FreeBSD 為客端</title>

    <para><application>VMware Fusion</application> 是一套商業軟體可在 <trademark class="registered">Intel</trademark> 為基礎的 <trademark class="registered">Apple</trademark> <trademark class="registered">Mac</trademark> 的 <trademark class="registered">Mac OS</trademark> 10.4.9 或更新版本上執行。 該軟體完全支援使用 FreeBSD 作為客端作業系統。 在 <trademark class="registered">Mac OS</trademark> X 裝好 <application>VMware Fusion</application> 後，使用者必先完成虛擬機器的設定後才可安裝想使用的客端作業系統。</para>

    <sect2 xml:id="virtualization-guest-vmware-install">
      <title>在 <application>VMware Fusion</application> 安裝 FreeBSD</title>

      <para>第一個步驟是啟動 <application>VMware Fusion</application> 載入 Virtual Machine Library，點選 <guimenuitem>New</guimenuitem> 建立虛擬機器：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd01"/>
	</imageobject>
      </mediaobject>

      <para>這個動做會載入 New Virtual Machine Assistant，點選 <guimenuitem>Continue</guimenuitem> 繼續：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd02"/>
	</imageobject>
      </mediaobject>

      <para>選擇 <guimenuitem>Operating System</guimenuitem> 為 <guimenuitem>Other</guimenuitem> 以及在 <guimenu>Version</guimenu> 提示出現時選擇 <guimenuitem>FreeBSD</guimenuitem> 或 <guimenuitem>FreeBSD 64-bit</guimenuitem>：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd03"/>
	</imageobject>
      </mediaobject>

      <para>選擇虛擬機器要使用的名稱以及要儲存目錄位置：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd04"/>
	</imageobject>
      </mediaobject>

      <para>選擇虛擬機器的 Virtual Hard Disk 大小：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd05"/>
	</imageobject>
      </mediaobject>

      <para>選擇安裝虛擬機器的方式，可從 <acronym>ISO</acronym> 映像檔或從 <acronym>CD</acronym>/<acronym>DVD</acronym>：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd06"/>
	</imageobject>
      </mediaobject>

      <para>點選 <guimenuitem>Finish</guimenuitem> 接著虛擬機器會開機：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd07"/>
	</imageobject>
      </mediaobject>

      <para>照往常方式安裝 FreeBSD：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd08"/>
	</imageobject>
      </mediaobject>

      <para>安裝完成後，可以修改虛擬機器的設定，例如記憶體使用量：</para>

      <note>
	<para>虛擬機器的 System Hardware 設定無法在虛擬機器執行時修改。</para>
      </note>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd09"/>
	</imageobject>
      </mediaobject>

      <para>虛擬機器要使用的 CPU 數量：</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd10"/>
	</imageobject>
      </mediaobject>

      <para><acronym>CD-ROM</acronym> 裝置的狀態，正常情況 <acronym>CD</acronym>/<acronym>DVD</acronym>/<acronym>ISO</acronym> 在不需要時會中斷與虛擬機器的連線。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd11"/>
	</imageobject>
      </mediaobject>

      <para>最後一件事是更改虛擬機器連線到網路的方式，要允許除了主端以外的機器連線到虛擬機器，請選擇 <guimenuitem>Connect directly to the physical network (Bridged)</guimenuitem>。否則會偏好使用 <guimenuitem>Share the host's internet connection (NAT)</guimenuitem> 來讓虛擬機器可以存取網際網路，但外部網路無法連線到虛擬機器。</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="virtualization/vmware-freebsd12"/>
	</imageobject>
      </mediaobject>

      <para>在修改設定之後，開機進入新安裝的 FreeBSD 虛擬機器。</para>
    </sect2>

    <sect2 xml:id="virtualization-guest-vmware-configure">
      <title>在 <application>VMware Fusion</application> 設定 FreeBSD</title>

      <para>在成功將 FreeBSD 安裝到 <trademark class="registered">Mac OS</trademark> X 的 <application>VMware Fusion</application> 後，有數個設定步驟要完成來最佳化系統在虛擬機器上的運作。</para>

      <procedure>
	<step>
	  <title>設定 Boot Loader 變數</title>

	  <para>最重要的一個步驟是減少 <option>kern.hz</option>，來減少 FreeBSD 在 <application>VMware Fusion</application> 環境下 CPU 的使用量。這可以透過加入下列幾行到 <filename>/boot/loader.conf</filename> 來完成：</para>

	  <programlisting xml:lang="en">kern.hz=100</programlisting>

	  <para>若沒有完成此設定，閒置的 FreeBSD <application>VMware Fusion</application> 客端將會消耗掉單一處理器的 <trademark class="registered">iMac</trademark> 將近 15% 的 CPU。完成此更改後使用率會減至接近 5%。</para>
	</step>

	<step>
	  <title>建立新核心設定檔</title>

	  <para>所有的 SCSI, FireWire 及 USB 裝置可以從自訂的核心設定檔中移除。<application>VMware Fusion</application> 提供的虛擬網路卡使用 <citerefentry><refentrytitle>em</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式，所以除了 <citerefentry><refentrytitle>em</refentrytitle><manvolnum>4</manvolnum></citerefentry> 外的所有網路裝置可以自核心中移除。</para>
	</step>

	<step>
	  <title>設定網路</title>

	  <para>最基本的網路設定是使用 DHCP 來讓虛擬機器連線到與主端 <trademark class="registered">Mac</trademark> 相同的區域網路，這可以透過加入 <literal>ifconfig_em0="DHCP"</literal> 到 <filename>/etc/rc.conf</filename> 來完成。更進階的網路設定在 <xref linkend="advanced-networking"/> 中描述。</para>
	</step>
      </procedure>
    </sect2>
  </sect1>

  <sect1 xml:id="virtualization-guest-virtualbox">
    <title>在 <trademark>VirtualBox</trademark> 安裝 FreeBSD 作為客端</title>

    <para>在 <application><trademark>VirtualBox</trademark></application> 中使用 FreeBSD 做為客端系統也可運作的很好，虛擬化軟體可支援最常見的幾個作業系統，這當然也包含 FreeBSD。</para>

    <para><application><trademark>VirtualBox</trademark></application> guest additions 支援以下功能：</para>

    <itemizedlist>
      <listitem>
	<para>剪貼簿共享。</para>
      </listitem>

      <listitem>
	<para>滑鼠指標整合。</para>
      </listitem>

      <listitem>
	<para>主機時間同步。</para>
      </listitem>

      <listitem>
	<para>視窗縮放。</para>
      </listitem>

      <listitem>
	<para>無痕模式。</para>
      </listitem>
    </itemizedlist>

    <note>
      <para>以下指令均是在 FreeBSD 客端中執行。</para>
    </note>

    <para>首先，在 FreeBSD 客端安裝 <package>emulators/virtualbox-ose-additions</package> 套件或 Port，以下指令會安裝 Port：</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/emulators/virtualbox-ose-additions &amp;&amp; make install clean</userinput></screen>

    <para>加入下行到 <filename>/etc/rc.conf</filename>：</para>

    <programlisting xml:lang="en">vboxguest_enable="YES"
vboxservice_enable="YES"</programlisting>

    <para>若有使用 <citerefentry><refentrytitle>ntpd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 或 <citerefentry><refentrytitle>ntpdate</refentrytitle><manvolnum>8</manvolnum></citerefentry>，便可關閉主機時間同步功能：</para>

    <programlisting xml:lang="en">vboxservice_flags="--disable-timesync"</programlisting>

    <para><application>Xorg</application> 會自動辨識 <literal>vboxvideo</literal> 驅動程式，也可手動在 <filename>/etc/X11/xorg.conf</filename> 中輸入：</para>

    <programlisting xml:lang="en">Section "Device"
	Identifier "Card0"
	Driver "vboxvideo"
	VendorName "InnoTek Systemberatung GmbH"
	BoardName "VirtualBox Graphics Adapter"
EndSection</programlisting>

    <para>要使用 <literal>vboxmouse</literal> 驅動程式，可調整在 <filename>/etc/X11/xorg.conf</filename> 中與滑鼠相關的一節：</para>

    <programlisting xml:lang="en">Section "InputDevice"
	Identifier "Mouse0"
	Driver "vboxmouse"
EndSection</programlisting>

    <para><acronym>HAL</acronym> 的使用者應建立以下 <filename>/usr/local/etc/hal/fdi/policy/90-vboxguest.fdi</filename> 或複製自 <filename>/usr/local/share/hal/fdi/policy/10osvendor/90-vboxguest.fdi</filename>：</para>

    <programlisting xml:lang="en">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;!--
# Sun VirtualBox
# Hal driver description for the vboxmouse driver
# $Id: chapter.xml,v 1.33 2012-03-17 04:53:52 eadler Exp $

	Copyright (C) 2008-2009 Sun Microsystems, Inc.

	This file is part of VirtualBox Open Source Edition (OSE, as
	available from http://www.virtualbox.org. This file is free software;
	you can redistribute it and/or modify it under the terms of the GNU
	General Public License (GPL) as published by the Free Software
	Foundation, in version 2 as it comes in the "COPYING" file of the
	VirtualBox OSE distribution. VirtualBox OSE is distributed in the
	hope that it will be useful, but WITHOUT ANY WARRANTY of any kind.

	Please contact Sun Microsystems, Inc., 4150 Network Circle, Santa
	Clara, CA 95054 USA or visit http://www.sun.com if you need
	additional information or have any questions.
--&gt;
&lt;deviceinfo version="0.2"&gt;
  &lt;device&gt;
    &lt;match key="info.subsystem" string="pci"&gt;
      &lt;match key="info.product" string="VirtualBox guest Service"&gt;
        &lt;append key="info.capabilities" type="strlist"&gt;input&lt;/append&gt;
	&lt;append key="info.capabilities" type="strlist"&gt;input.mouse&lt;/append&gt;
        &lt;merge key="input.x11_driver" type="string"&gt;vboxmouse&lt;/merge&gt;
	&lt;merge key="input.device" type="string"&gt;/dev/vboxguest&lt;/merge&gt;
      &lt;/match&gt;
    &lt;/match&gt;
  &lt;/device&gt;
&lt;/deviceinfo&gt;</programlisting>

    <para xml:lang="en">Shared folders for file transfers between host and VM are
      accessible by mounting them using
      <literal>mount_vboxvfs</literal>.  A shared folder can be created
      on the host using the VirtualBox GUI or via
      <command>vboxmanage</command>.  For example, to create a shared
      folder called <replaceable>myshare</replaceable> under
      <filename><replaceable>/mnt/bsdboxshare</replaceable></filename>
      for the VM named <replaceable>BSDBox</replaceable>, run:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>vboxmanage sharedfolder add '<replaceable>BSDBox</replaceable>' --name <replaceable>myshare</replaceable> --hostpath <replaceable>/mnt/bsdboxshare</replaceable></userinput></screen>

    <para xml:lang="en">Note that the shared folder name must not contain spaces.
      Mount the shared folder from within the guest system like
      this:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>mount_vboxvfs -w <replaceable>myshare</replaceable> <replaceable>/mnt</replaceable></userinput></screen>
  </sect1>

  <sect1 xml:id="virtualization-host-virtualbox">
    <title>以 FreeBSD 作為主端使用 <trademark>VirtualBox</trademark></title>

    <para><application><trademark>VirtualBox</trademark></application> 是一套積極開發、完整的虛擬化套件，適用大多數作業系統，包含 <trademark class="registered">Windows</trademark>, <trademark class="registered">Mac OS</trademark>, <trademark class="registered">Linux</trademark> 與 FreeBSD，它同樣能夠執行類 <trademark class="registered">Windows</trademark> 或 <trademark class="registered">UNIX</trademark> 的客端系統。它是以開源軟體的方式發佈，但閉源元件可獨立在擴充包中使用，這些元件包含對 USB 2.0 裝置的支援。更多資訊可在 <link xlink:href="http://www.virtualbox.org/wiki/Downloads"><application><trademark>VirtualBox</trademark></application> wiki 的 <quote>Downloads</quote> 頁面</link>。目前，這些擴充套件並不支援 FreeBSD。</para>

    <sect2 xml:id="virtualization-virtualbox-install">
      <title>安裝 <trademark>VirtualBox</trademark></title>

      <para><application><trademark>VirtualBox</trademark></application> 可於 <package>emulators/virtualbox-ose</package> 以 FreeBSD 套件或 Port 的方式取得。要安裝 Port 可使用以下指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/emulators/virtualbox-ose</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>在 Port 的設定選單中 <literal>GuestAdditions</literal> 相關程式是最有用的選項之一，這些程式可在客端作業系統提供數個有用的功能，如滑鼠指標整合 (允許滑鼠在主端與客端之間移動，不需要按特殊快速鍵來切換) 與較快的影像繪圖速度，特別是在 <trademark class="registered">Windows</trademark> 的客端系統。Guest additions 可在客端系統安裝完之後的 <guimenu>Devices</guimenu> 選單找到。</para>

      <para>還有一些設定需要在 <application><trademark>VirtualBox</trademark></application> 第一次啟動端做修改，Port 會安裝一個核心模組在 <filename>/boot/modules</filename>，該模組必須在核心中載入：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload vboxdrv</userinput></screen>

      <para>要確保該模組在重新開機後會載入，可加入下行到 <filename>/boot/loader.conf</filename>：</para>

      <programlisting xml:lang="en">vboxdrv_load="YES"</programlisting>

      <para>要使用可支援橋接或僅限主端 (Host-only) 的網路，可加入下行到 <filename>/etc/rc.conf</filename>，然後重新啟動電腦：</para>

      <programlisting xml:lang="en">vboxnet_enable="YES"</programlisting>

      <para>在安裝 <application><trademark>VirtualBox</trademark></application> 的過程中會建立 <systemitem class="groupname">vboxusers</systemitem> 群組，所有需要存取 <application><trademark>VirtualBox</trademark></application> 的使用者均需要加入成為此群組的成員，<command>pw</command> 可用來加入新的成員：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupmod vboxusers -m <replaceable>yourusername</replaceable></userinput></screen>

      <para><filename>/dev/vboxnetctl</filename> 的預設權限是受限的，需要更改後才可使用橋接網路：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>chown root:vboxusers /dev/vboxnetctl</userinput>
<prompt>#</prompt> <userinput>chmod 0660 /dev/vboxnetctl</userinput></screen>

      <para>要永久變更權限，可加入下列幾行到 <filename>/etc/devfs.conf</filename>：</para>

      <programlisting xml:lang="en">own     vboxnetctl root:vboxusers
perm    vboxnetctl 0660</programlisting>

      <para>要執行 <application><trademark>VirtualBox</trademark></application>，可在 <application>Xorg</application> 工作階段輸入：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>VirtualBox</userinput></screen>

      <para>要取得更多有關設定與使用 <application><trademark>VirtualBox</trademark></application> 的資訊，請參考 <link xlink:href="http://www.virtualbox.org">官方網站</link>。供 FreeBSD 特定的資訊與疑難排解操作指示，可參考 <link xlink:href="http://wiki.FreeBSD.org/VirtualBox">FreeBSD wiki 中相關的頁面</link>。</para>
    </sect2>

    <sect2 xml:id="virtualization-virtualbox-usb-support">
      <title><trademark>VirtualBox</trademark> USB 支援</title>

      <para xml:lang="en"><application><trademark>VirtualBox</trademark></application> can be configured
	to pass <acronym>USB</acronym> devices through to the guest
	operating system.  The host controller of the OSE version is
	limited to emulating <acronym>USB</acronym> 1.1 devices until
	the extension pack supporting <acronym>USB</acronym> 2.0 and
	3.0 devices becomes available on FreeBSD.</para>

      <para xml:lang="en">For <application><trademark>VirtualBox</trademark></application> to be aware of
	<acronym>USB</acronym> devices attached to the machine, the
	user needs to be a member of the <systemitem class="groupname">operator</systemitem> group.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pw groupmod operator -m <replaceable>yourusername</replaceable></userinput></screen>

      <para xml:lang="en">Then, add the following to
       <filename>/etc/devfs.rules</filename>, or create this file if
       it does not exist yet:</para>

      <programlisting xml:lang="en">[system=10]
add path 'usb/*' mode 0660 group operator</programlisting>

      <para>若服務未執行，請加入下行到 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">devfs_system_ruleset="system"</programlisting>

      <para>然後重新啟動 devfs：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service devfs restart</userinput></screen>

      <para>重新啟動登作階段與 <application><trademark>VirtualBox</trademark></application> 來讓這些變更生效，且建立必要的 <acronym>USB</acronym> 的過濾器。</para>
    </sect2>

    <sect2 xml:id="virtualization-virtualbox-host-dvd-cd-access">
      <title><trademark>VirtualBox</trademark> Host <acronym>DVD</acronym>/<acronym>CD</acronym> 存取</title>

      <para>透過共享實體磁碟機可讓客端系統能夠存取主端系統的 <acronym>DVD</acronym>/<acronym>CD</acronym> 磁碟機。在 <trademark>VirtualBox</trademark> 中，這個功能可在虛擬機器設定中的儲存 (Storage) 視窗中設定。若需要，可先建立一個空的 <acronym>IDE</acronym> <acronym>CD</acronym>/<acronym>DVD</acronym> 裝置，然後在跳出的選單中選擇要做為虛擬 <acronym>CD</acronym>/<acronym>DVD</acronym> 磁碟機的主端磁碟機，此時會出現一個標籤為 <literal>Passthrough</literal> 的核選方塊，勾選這個核選方塊可讓虛擬機器直接使用該硬體，例如，音樂 <acronym>CD</acronym> 或燒錄機只會在有勾選此選項時能夠運作。</para>

      <para><application><trademark>VirtualBox</trademark></application> <acronym>DVD</acronym>/<acronym>CD</acronym> 功能要能運作需要執行 <acronym>HAL</acronym>，因此需在 <filename>/etc/rc.conf</filename> 中開啟，若該服務尚未啟動，則啟動它：</para>

      <programlisting xml:lang="en">hald_enable="YES"</programlisting>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service hald start</userinput></screen>

      <para>為了讓使用者能夠使用 <application><trademark>VirtualBox</trademark></application> <acronym>DVD</acronym>/<acronym>CD</acronym> 功能，這些使用者需要存取 <filename>/dev/xpt0</filename>, <filename>/dev/cd<replaceable>N</replaceable></filename> 以及 <filename>/dev/pass<replaceable>N</replaceable></filename>，這通常可讓這些使用者成為 <systemitem class="groupname">operator</systemitem> 的成員來達成。對這些裝置的權限必須加入下行到 <filename>/etc/devfs.conf</filename> 來修正：</para>

      <programlisting xml:lang="en">perm cd* 0660
perm xpt0 0660
perm pass* 0660</programlisting>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service devfs restart</userinput></screen>
    </sect2>
  </sect1>

  <sect1 xml:id="virtualization-host-bhyve">
    <title>以 FreeBSD 作為主端安裝 <application>bhyve</application></title>

    <para xml:lang="en">The <application>bhyve</application>
      <acronym>BSD</acronym>-licensed hypervisor became part of the
      base system with FreeBSD 10.0-RELEASE.  This hypervisor supports a
      number of guests, including FreeBSD, OpenBSD, and many <trademark class="registered">Linux</trademark>
      distributions.  By default, <application>bhyve</application>
      provides access to serial console and does not emulate a
      graphical console.  Virtualization offload features of newer
      <acronym>CPU</acronym>s are used to avoid the legacy methods of
      translating instructions and manually managing memory
      mappings.</para>

    <para xml:lang="en">The <application>bhyve</application> design requires a
      processor that supports <trademark class="registered">Intel</trademark> Extended Page Tables
      (<acronym>EPT</acronym>) or <trademark class="registered">AMD</trademark> Rapid Virtualization Indexing
      (<acronym>RVI</acronym>) or Nested Page Tables
      (<acronym>NPT</acronym>).  Hosting <trademark class="registered">Linux</trademark> guests or FreeBSD guests
      with more than one <acronym>vCPU</acronym> requires
      <acronym>VMX</acronym> unrestricted mode support
      (<acronym>UG</acronym>).  Most newer processors, specifically
      the <trademark class="registered">Intel</trademark> <trademark>Core</trademark> i3/i5/i7 and <trademark class="registered">Intel</trademark> <trademark>Xeon</trademark>
      E3/E5/E7, support these features.  <acronym>UG</acronym> support
      was introduced with Intel's Westmere micro-architecture.  For a
      complete list of <trademark class="registered">Intel</trademark> processors that support
      <acronym>EPT</acronym>, refer to <link xlink:href="https://ark.intel.com/content/www/us/en/ark/search/featurefilter.html?productType=873&amp;0_ExtendedPageTables=True"/>.
      <acronym>RVI</acronym> is found on the third generation and
      later of the <trademark>AMD Opteron</trademark> (Barcelona) processors.  The easiest
      way to tell if a processor supports
      <application>bhyve</application> is to run
      <command>dmesg</command> or look in
      <filename>/var/run/dmesg.boot</filename> for the
      <literal>POPCNT</literal> processor feature flag on the
      <literal>Features2</literal> line for <trademark class="registered">AMD</trademark> processors or
      <literal>EPT</literal> and <literal>UG</literal> on the
      <literal>VT-x</literal> line for <trademark class="registered">Intel</trademark> processors.</para>

    <sect2 xml:id="virtualization-bhyve-prep">
      <title>準備主端</title>

      <para xml:lang="en">The first step to creating a virtual machine in
	<application>bhyve</application> is configuring the host
	system.  First, load the <application>bhyve</application>
	kernel module:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload vmm</userinput></screen>

      <para xml:lang="en">Then, create a <filename>tap</filename> interface for the
	network device in the virtual machine to attach to.  In order
	for the network device to participate in the network, also
	create a bridge interface containing the
	<filename>tap</filename> interface and the physical interface
	as members.  In this example, the physical interface is
	<replaceable>igb0</replaceable>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>tap0</replaceable> create</userinput>
<prompt>#</prompt> <userinput>sysctl net.link.tap.up_on_open=1</userinput>
net.link.tap.up_on_open: 0 -&gt; 1
<prompt>#</prompt> <userinput>ifconfig <replaceable>bridge0</replaceable> create</userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>bridge0</replaceable> addm <replaceable>igb0</replaceable> addm <replaceable>tap0</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>bridge0</replaceable> up</userinput></screen>
    </sect2>

    <sect2 xml:id="virtualization-bhyve-freebsd">
      <title>建立 FreeBSD 客端</title>

      <para xml:lang="en">Create a file to use as the virtual disk for the guest
	machine.  Specify the size and name of the virtual
	disk:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>truncate -s <replaceable>16G</replaceable> <replaceable>guest.img</replaceable></userinput></screen>

      <para xml:lang="en">Download an installation image of FreeBSD to install:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>fetch <replaceable>ftp://ftp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.3/FreeBSD-10.3-RELEASE-amd64-bootonly.iso</replaceable></userinput>
FreeBSD-10.3-RELEASE-amd64-bootonly.iso       100% of  230 MB  570 kBps 06m17s</screen>

      <para xml:lang="en">FreeBSD comes with an example script for running a virtual
	machine in <application>bhyve</application>.  The script will
	start the virtual machine and run it in a loop, so it will
	automatically restart if it crashes.  The script takes a
	number of options to control the configuration of the machine:
	<option>-c</option> controls the number of virtual CPUs,
	<option>-m</option> limits the amount of memory available to
	the guest, <option>-t</option> defines which
	<filename>tap</filename> device to use, <option>-d</option>
	indicates which disk image to use, <option>-i</option> tells
	<application>bhyve</application> to boot from the
	<acronym>CD</acronym> image instead of the disk, and
	<option>-I</option> defines which <acronym>CD</acronym> image
	to use.  The last parameter is the name of the virtual
	machine, used to track the running machines.  This example
	starts the virtual machine in installation mode:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sh /usr/share/examples/bhyve/vmrun.sh -c <replaceable>1</replaceable> -m <replaceable>1024M</replaceable> -t <replaceable>tap0</replaceable> -d <replaceable>guest.img</replaceable> -i -I <replaceable>FreeBSD-10.3-RELEASE-amd64-bootonly.iso</replaceable> <replaceable>guestname</replaceable></userinput></screen>

      <para xml:lang="en">The virtual machine will boot and start the installer.
	After installing a system in the virtual machine, when the
	system asks about dropping in to a shell at the end of the
	installation, choose <guibutton>Yes</guibutton>.</para>

      <para xml:lang="en">Reboot the virtual machine.  While rebooting the virtual
	machine causes <application>bhyve</application> to exit, the
	<filename>vmrun.sh</filename> script runs
	<command>bhyve</command> in a loop and will automatically
	restart it.  When this happens, choose the reboot option from
	the boot loader menu in order to escape the loop.  Now the
	guest can be started from the virtual disk:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sh /usr/share/examples/bhyve/vmrun.sh -c <replaceable>4</replaceable> -m <replaceable>1024M</replaceable> -t <replaceable>tap0</replaceable> -d <replaceable>guest.img</replaceable> <replaceable>guestname</replaceable></userinput></screen>
    </sect2>

    <sect2 xml:id="virtualization-bhyve-linux">
      <title>建立 <trademark class="registered">Linux</trademark> 客端</title>

      <para xml:lang="en">In order to boot operating systems other than FreeBSD, the
	<package>sysutils/grub2-bhyve</package> port must be first
	installed.</para>

      <para xml:lang="en">Next, create a file to use as the virtual disk for the
	guest machine:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>truncate -s <replaceable>16G</replaceable> <replaceable>linux.img</replaceable></userinput></screen>

      <para xml:lang="en">Starting a virtual machine with
	<application>bhyve</application> is a two step process.  First
	a kernel must be loaded, then the guest can be started.  The
	<trademark class="registered">Linux</trademark> kernel is loaded with
	<package>sysutils/grub2-bhyve</package>.  Create a
	<filename>device.map</filename> that
	<application>grub</application> will use to map the virtual
	devices to the files on the host system:</para>

      <programlisting xml:lang="en">(hd0) ./linux.img
(cd0) ./somelinux.iso</programlisting>

      <para xml:lang="en">Use <package>sysutils/grub2-bhyve</package> to load the
	<trademark class="registered">Linux</trademark> kernel from the <acronym>ISO</acronym> image:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>grub-bhyve -m device.map -r cd0 -M <replaceable>1024M</replaceable> <replaceable>linuxguest</replaceable></userinput></screen>

      <para xml:lang="en">This will start grub.  If the installation
	<acronym>CD</acronym> contains a
	<filename>grub.cfg</filename>, a menu will be displayed.
	If not, the <literal>vmlinuz</literal> and
	<literal>initrd</literal> files must be located and loaded
	manually:</para>

      <screen xml:lang="en">grub&gt; <userinput>ls</userinput>
(hd0) (cd0) (cd0,msdos1) (host)
grub&gt; <userinput>ls (cd0)/isolinux</userinput>
boot.cat boot.msg grub.conf initrd.img isolinux.bin isolinux.cfg memtest
splash.jpg TRANS.TBL vesamenu.c32 vmlinuz
grub&gt; <userinput>linux (cd0)/isolinux/vmlinuz</userinput>
grub&gt; <userinput>initrd (cd0)/isolinux/initrd.img</userinput>
grub&gt; <userinput>boot</userinput></screen>

      <para xml:lang="en">Now that the <trademark class="registered">Linux</trademark> kernel is loaded, the guest can be
	started:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>bhyve -A -H -P -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,<replaceable>tap0</replaceable> -s 3:0,virtio-blk,<replaceable>./linux.img</replaceable> \
    -s 4:0,ahci-cd,<replaceable>./somelinux.iso</replaceable> -l com1,stdio -c <replaceable>4</replaceable> -m <replaceable>1024M</replaceable> <replaceable>linuxguest</replaceable></userinput></screen>

      <para xml:lang="en">The system will boot and start the installer.  After
	installing a system in the virtual machine, reboot the virtual
	machine.  This will cause <application>bhyve</application> to
	exit.  The instance of the virtual machine needs to be
	destroyed before it can be started again:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>bhyvectl --destroy --vm=<replaceable>linuxguest</replaceable></userinput></screen>

      <para xml:lang="en">Now the guest can be started directly from the virtual
	disk.  Load the kernel:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>grub-bhyve -m device.map -r hd0,msdos1 -M <replaceable>1024M</replaceable> <replaceable>linuxguest</replaceable></userinput>
grub&gt; <userinput>ls</userinput>
(hd0) (hd0,msdos2) (hd0,msdos1) (cd0) (cd0,msdos1) (host)
(lvm/VolGroup-lv_swap) (lvm/VolGroup-lv_root)
grub&gt; <userinput>ls (hd0,msdos1)/</userinput>
lost+found/ grub/ efi/ System.map-2.6.32-431.el6.x86_64 config-2.6.32-431.el6.x
86_64 symvers-2.6.32-431.el6.x86_64.gz vmlinuz-2.6.32-431.el6.x86_64
initramfs-2.6.32-431.el6.x86_64.img
grub&gt; <userinput>linux (hd0,msdos1)/vmlinuz-2.6.32-431.el6.x86_64 root=/dev/mapper/VolGroup-lv_root</userinput>
grub&gt; <userinput>initrd (hd0,msdos1)/initramfs-2.6.32-431.el6.x86_64.img</userinput>
grub&gt; <userinput>boot</userinput></screen>

      <para xml:lang="en">Boot the virtual machine:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>bhyve -A -H -P -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,<replaceable>tap0</replaceable> \
    -s 3:0,virtio-blk,<replaceable>./linux.img</replaceable> -l com1,stdio -c <replaceable>4</replaceable> -m <replaceable>1024M</replaceable> <replaceable>linuxguest</replaceable></userinput></screen>

      <para xml:lang="en"><trademark class="registered">Linux</trademark> will now boot in the virtual machine and
	eventually present you with the login prompt.  Login and use
	the virtual machine.  When you are finished, reboot the
	virtual machine to exit <application>bhyve</application>.
	Destroy the virtual machine instance:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>bhyvectl --destroy --vm=<replaceable>linuxguest</replaceable></userinput></screen>
    </sect2>

    <sect2 xml:id="virtualization-bhyve-uefi">
      <title>使用 <acronym>UEFI</acronym> 韌體開機 <application>bhyve</application> 虛擬機器</title>

      <para xml:lang="en">In addition to <application>bhyveload</application> and
	<application>grub-bhyve</application>, the
	<application>bhyve</application> hypervisor can also boot
	virtual machines using the <acronym>UEFI</acronym> userspace
	firmware.  This option may support guest operating systems
	that are not supported by the other loaders.</para>

      <para xml:lang="en">In order to make use of the <acronym>UEFI</acronym>
	support in <application>bhyve</application>, first obtain the
	<acronym>UEFI</acronym> firmware images.  This can be done by
	installing <package>sysutils/bhyve-firmware</package> port or
	package.</para>

      <para xml:lang="en">With the firmware in place, add the flags <option>-l
	  bootrom,<replaceable>/path/to/firmware</replaceable></option>
	to your <application>bhyve</application> command line.  The
	actual <application>bhyve</application> command may look like
	this:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>bhyve -AHP -s 0:0,hostbridge -s 1:0,lpc \
-s 2:0,virtio-net,<replaceable>tap1</replaceable> -s 3:0,virtio-blk,<replaceable>./disk.img</replaceable> \
-s 4:0,ahci-cd,<replaceable>./install.iso</replaceable> -c <replaceable>4</replaceable> -m <replaceable>1024M</replaceable> \
-l bootrom,<replaceable>/usr/local/share/uefi-firmware/BHYVE_UEFI.fd</replaceable> \
<replaceable>guest</replaceable></userinput></screen>

      <para xml:lang="en"><package>sysutils/bhyve-firmware</package> also contains a
	<acronym>CSM</acronym>-enabled firmware, to boot guests with
	no <acronym>UEFI</acronym> support in legacy
	<acronym>BIOS</acronym> mode:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>bhyve -AHP -s 0:0,hostbridge -s 1:0,lpc \
-s 2:0,virtio-net,<replaceable>tap1</replaceable> -s 3:0,virtio-blk,<replaceable>./disk.img</replaceable> \
-s 4:0,ahci-cd,<replaceable>./install.iso</replaceable> -c <replaceable>4</replaceable> -m <replaceable>1024M</replaceable> \
-l bootrom,<replaceable>/usr/local/share/uefi-firmware/BHYVE_UEFI_CSM.fd</replaceable> \
<replaceable>guest</replaceable></userinput></screen>
    </sect2>

    <sect2 xml:id="virtualization-bhyve-framebuffer">
      <title>供 <application>bhyve</application> 客端用的圖型化 <acronym>UEFI</acronym> Framebuffer</title>

      <para xml:lang="en">The <acronym>UEFI</acronym> firmware support is
	particularly useful with predominantly graphical guest
	operating systems such as Microsoft <trademark class="registered">Windows</trademark>.</para>

      <para xml:lang="en">Support for the UEFI-GOP framebuffer may also be enabled
	with the <option>-s
	  29,fbuf,tcp=<replaceable>0.0.0.0:5900</replaceable></option>
	flags.  The framebuffer resolution may be configured with
	<option>w=<replaceable>800</replaceable></option> and
	<option>h=<replaceable>600</replaceable></option>, and
	<application>bhyve</application> can be instructed to wait for
	a <acronym>VNC</acronym> connection before booting the guest
	by adding <option>wait</option>.  The framebuffer may be
	accessed from the host or over the network via the
	<acronym>VNC</acronym> protocol.</para>

      <para><application>bhyve</application> 指令的結果會如下：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>bhyve -AHP -s 0:0,hostbridge -s 31:0,lpc \
-s 2:0,virtio-net,<replaceable>tap1</replaceable> -s 3:0,virtio-blk,<replaceable>./disk.img</replaceable> \
-s 4:0,ahci-cd,<replaceable>./install.iso</replaceable> -c <replaceable>4</replaceable> -m <replaceable>1024M</replaceable> \
-s 29,fbuf,tcp=<replaceable>0.0.0.0:5900</replaceable>,w=<replaceable>800</replaceable>,h=<replaceable>600</replaceable>,wait \
-l bootrom,<replaceable>/usr/local/share/uefi-firmware/BHYVE_UEFI.fd</replaceable> \
<replaceable>guest</replaceable></userinput></screen>

      <para xml:lang="en">Note, in BIOS emulation mode, the framebuffer will cease
	receiving updates once control is passed from firmware to
	guest operating system.</para>
    </sect2>

    <sect2 xml:id="virtualization-bhyve-zfs">
      <title>在 <application>bhyve</application> 客端使用 <acronym>ZFS</acronym></title>

      <para xml:lang="en">If <acronym>ZFS</acronym> is available on the host
	machine, using <acronym>ZFS</acronym> volumes
	instead of disk image files can provide significant
	performance benefits for the guest <acronym>VMs</acronym>.  A
	<acronym>ZFS</acronym> volume can be created by:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs create -V<replaceable>16G</replaceable> -o volmode=dev <replaceable>zroot/linuxdisk0</replaceable></userinput></screen>

      <para xml:lang="en">When starting the <acronym>VM</acronym>, specify the
	<acronym>ZFS</acronym> volume as the disk drive:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>bhyve -A -H -P -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,<replaceable>tap0</replaceable> -s3:0,virtio-blk,<replaceable>/dev/zvol/zroot/linuxdisk0</replaceable> \
    -l com1,<replaceable>stdio</replaceable> -c <replaceable>4</replaceable> -m <replaceable>1024M</replaceable> <replaceable>linuxguest</replaceable></userinput></screen>
    </sect2>

    <sect2 xml:id="virtualization-bhyve-nmdm">
      <title>虛擬機器 Console</title>

      <para xml:lang="en">It is advantageous to wrap the
	<application>bhyve</application> console in a session
	management tool such as <package>sysutils/tmux</package> or
	<package>sysutils/screen</package> in order to detach and
	reattach to the console.  It is also possible to have the
	console of <application>bhyve</application> be a null modem
	device that can be accessed with <command>cu</command>.  To do
	this, load the <filename>nmdm</filename> kernel module and
	replace <option>-l com1,stdio</option> with
	<option>-l com1,/dev/nmdm0A</option>.  The
	<filename>/dev/nmdm</filename> devices are created
	automatically as needed, where each is a pair, corresponding
	to the two ends of the null modem cable
	(<filename>/dev/nmdm0A</filename> and
	<filename>/dev/nmdm0B</filename>).  See <citerefentry><refentrytitle>nmdm</refentrytitle><manvolnum>4</manvolnum></citerefentry> for more
	information.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload nmdm</userinput>
<prompt>#</prompt> <userinput>bhyve -A -H -P -s 0:0,hostbridge -s 1:0,lpc -s 2:0,virtio-net,<replaceable>tap0</replaceable> -s 3:0,virtio-blk,<replaceable>./linux.img</replaceable> \
    -l com1,<replaceable>/dev/nmdm0A</replaceable> -c <replaceable>4</replaceable> -m <replaceable>1024M</replaceable> <replaceable>linuxguest</replaceable></userinput>
<prompt>#</prompt> <userinput>cu -l <replaceable>/dev/nmdm0B</replaceable></userinput>
Connected

Ubuntu 13.10 handbook ttyS0

handbook login:</screen>
    </sect2>

    <sect2 xml:id="virtualization-bhyve-managing">
      <title>管理虛擬機器</title>

      <para xml:lang="en">A device node is created in <filename role="directory">/dev/vmm</filename> for each virtual
	machine.  This allows the administrator to easily see a list
	of the running virtual machines:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ls -al /dev/vmm</userinput>
total 1
dr-xr-xr-x   2 root  wheel    512 Mar 17 12:19 ./
dr-xr-xr-x  14 root  wheel    512 Mar 17 06:38 ../
crw-------   1 root  wheel  0x1a2 Mar 17 12:20 guestname
crw-------   1 root  wheel  0x19f Mar 17 12:19 linuxguest
crw-------   1 root  wheel  0x1a1 Mar 17 12:19 otherguest</screen>

      <para xml:lang="en">A specified virtual machine can be destroyed using
	<command>bhyvectl</command>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>bhyvectl --destroy --vm=<replaceable>guestname</replaceable></userinput></screen>
    </sect2>

    <sect2 xml:id="virtualization-bhyve-onboot">
      <title>Persistent 設定</title>

      <para xml:lang="en">In order to configure the system to start
	<application>bhyve</application> guests at boot time, the
	following configurations must be made in the specified
	files:</para>

      <procedure>
	<step>
	  <title xml:lang="en"><filename>/etc/sysctl.conf</filename></title>

	  <programlisting xml:lang="en">net.link.tap.up_on_open=1</programlisting>
	</step>

	<step>
	  <title xml:lang="en"><filename>/etc/rc.conf</filename></title>

	  <programlisting xml:lang="en">cloned_interfaces="<replaceable>bridge0</replaceable> <replaceable>tap0</replaceable>"
ifconfig_bridge0="addm <replaceable>igb0</replaceable> addm <replaceable>tap0</replaceable>"
kld_list="nmdm vmm"</programlisting>
	</step>
      </procedure>
    </sect2>
  </sect1>

  <sect1 xml:id="virtualization-host-xen">
    <title>以 FreeBSD 作為主端安裝 <trademark>Xen</trademark></title>

    <para xml:lang="en"><application>Xen</application> is a GPLv2-licensed <link xlink:href="https://en.wikipedia.org/wiki/Hypervisor#Classification">type
	1 hypervisor</link> for <trademark class="registered">Intel</trademark> and <trademark class="registered">ARM</trademark> architectures.  FreeBSD
      has included <trademark>i386</trademark> and <trademark class="registered">AMD</trademark> 64-Bit <link xlink:href="https://wiki.xenproject.org/wiki/DomU">DomU</link>
      and <link xlink:href="https://en.wikipedia.org/wiki/Amazon_Elastic_Compute_Cloud">Amazon
	EC2</link> unprivileged domain (virtual machine) support since
      FreeBSD 8.0 and includes Dom0 control domain (host) support in
      FreeBSD 11.0.  Support for para-virtualized (PV) domains has
      been removed from FreeBSD 11 in favor of hardware virtualized
      (HVM) domains, which provides better performance.</para>

    <para xml:lang="en"><trademark>Xen</trademark> is a bare-metal hypervisor, which means that it is the
      first program loaded after the BIOS. A special privileged guest
      called the Domain-0 (<literal>Dom0</literal> for short) is then
      started.  The Dom0 uses its special privileges to directly
      access the underlying physical hardware, making it a
      high-performance solution.  It is able to access the disk
      controllers and network adapters directly.  The <trademark>Xen</trademark> management
      tools to manage and control the <trademark>Xen</trademark> hypervisor are also used
      by the Dom0 to create, list, and destroy VMs.  Dom0 provides
      virtual disks and networking for unprivileged domains, often
      called <literal>DomU</literal>.  <trademark>Xen</trademark> Dom0 can be compared to
      the service console of other hypervisor solutions, while the
      DomU is where individual guest VMs are run.</para>

<!-- Hidden until the mode in which FreeBSD uses Xen is supported.
    <para>Features of &xen; include GPU passthrough from the host
      running the Dom0 into a DomU guest machine.  This requires a
      CPU, chipset, and BIOS with VT-D support and might require extra
      patches or not work with all graphics cards.  A list of adapters
      can be found in the <link
	xlink:href="https://wiki.xenproject.org/wiki/Xen_VGA_Passthrough_Tested_Adapters">Xen
	Wiki</link>.  Note that not all GPUs listed there are
      supported on &os;.  The  &xen; hypervisor also supports PCI
      passthrough to give a DomU guest full, direct access to a PCI
      device like NIC, disk controller, or soundcard.</para>
-->
    <para xml:lang="en"><trademark>Xen</trademark> can migrate VMs between different <trademark>Xen</trademark> servers.  When
      the two xen hosts share the same underlying storage, the
      migration can be done without having to shut the VM down first.
      Instead, the migration is performed live while the DomU is
      running and there is no need to restart it or plan a downtime.
      This is useful in maintenance scenarios or upgrade windows to
      ensure that the services provided by the DomU are still
      provided.  Many more features of <trademark>Xen</trademark> are listed on the <link xlink:href="https://wiki.xenproject.org/wiki/Category:Overview">Xen
	Wiki Overview page</link>.  Note that not all features are
      supported on FreeBSD yet.</para>

    <sect2 xml:id="virtualization-host-xen-requirements">
      <title><trademark>Xen</trademark> Dom0 的硬體需求</title>

      <para xml:lang="en">To run the <trademark>Xen</trademark> hypervisor on a host, certain hardware
	functionality is required.  Hardware virtualized domains
	require Extended Page Table (<link xlink:href="http://en.wikipedia.org/wiki/Extended_Page_Table">EPT</link>)
	and Input/Output Memory Management Unit (<link xlink:href="http://en.wikipedia.org/wiki/List_of_IOMMU-supporting_hardware">IOMMU</link>)
	support in the host processor.</para>

      <note>
	<para xml:lang="en">In order to run a FreeBSD <trademark>Xen</trademark> Dom0 the box must be
	  booted using legacy boot (BIOS).</para>
      </note>

    </sect2>

    <sect2 xml:id="virtualization-host-xen-dom0-setup">
      <title><trademark>Xen</trademark> Dom0 控制領域安裝</title>

      <para xml:lang="en">Users of FreeBSD 11 should install the
	<package>emulators/xen-kernel47</package> and
	<package>sysutils/xen-tools47</package> packages that are
	based on Xen version 4.7.  Systems running on FreeBSD-12.0 or
	newer can use Xen 4.11 provided by
	<package>emulators/xen-kernel411</package> and
	<package>sysutils/xen-tools411</package>, respectively.</para>

      <para xml:lang="en">Configuration files must be edited to prepare the host
	for the Dom0 integration after the Xen packages are installed.
	An entry to <filename>/etc/sysctl.conf</filename> disables the
	limit on how many pages of memory are allowed to be wired.
	Otherwise, DomU VMs with higher memory requirements will not
	run.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>echo 'vm.max_wired=-1' &gt;&gt; /etc/sysctl.conf</userinput></screen>

      <para xml:lang="en">Another memory-related setting involves changing
	<filename>/etc/login.conf</filename>, setting the
	<literal>memorylocked</literal> option to
	<literal>unlimited</literal>.  Otherwise, creating DomU
	domains may fail with <errorname>Cannot allocate
	  memory</errorname> errors.  After making the change to
	<filename>/etc/login.conf</filename>, run
	<command>cap_mkdb</command> to update the capability database.
	See <xref linkend="security-resourcelimits"/> for
	details.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sed -i '' -e 's/memorylocked=64K/memorylocked=unlimited/' /etc/login.conf</userinput>
<prompt>#</prompt> <userinput>cap_mkdb /etc/login.conf</userinput></screen>

      <para xml:lang="en">Add an entry for the <trademark>Xen</trademark> console to
	<filename>/etc/ttys</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>echo 'xc0     "/usr/libexec/getty Pc"         xterm   onifconsole  secure' &gt;&gt; /etc/ttys</userinput></screen>

      <para xml:lang="en">Selecting a <trademark>Xen</trademark> kernel in
	<filename>/boot/loader.conf</filename> activates the Dom0.
	<trademark>Xen</trademark> also requires resources like CPU and memory from the
	host machine for itself and other DomU domains.  How much CPU
	and memory depends on the individual requirements and hardware
	capabilities.  In this example, 8 GB of memory and 4
	virtual CPUs are made available for the Dom0. The serial
	console is also activated and logging options are
	defined.</para>

      <para xml:lang="en">The following command is used for Xen 4.7 packages:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc -f /boot/loader.conf hw.pci.mcfg=0</userinput>
<prompt>#</prompt> <userinput>sysrc -f /boot/loader.conf if_tap_load="YES"</userinput>
<prompt>#</prompt> <userinput>sysrc -f /boot/loader.conf xen_kernel="/boot/xen"</userinput>
<prompt>#</prompt> <userinput>sysrc -f /boot/loader.conf xen_cmdline="dom0_mem=<replaceable>8192M</replaceable> dom0_max_vcpus=<replaceable>4</replaceable> dom0pvh=1 console=com1,vga com1=115200,8n1 guest_loglvl=all loglvl=all"</userinput></screen>

      <para xml:lang="en">For Xen versions 4.11 and higher, the following command
	should be used instead:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc -f /boot/loader.conf if_tap_load="YES"</userinput>
<prompt>#</prompt> <userinput>sysrc -f /boot/loader.conf xen_kernel="/boot/xen"</userinput>
<prompt>#</prompt> <userinput>sysrc -f /boot/loader.conf xen_cmdline="dom0_mem=<replaceable>8192M</replaceable> dom0_max_vcpus=<replaceable>4</replaceable> dom0=pvh console=com1,vga com1=115200,8n1 guest_loglvl=all loglvl=all"</userinput></screen>

	<tip>
	  <para xml:lang="en">Log files that <trademark>Xen</trademark> creates for the DomU VMs
	    are stored in <filename>/var/log/xen</filename>.  Please
	    be sure to check the contents of that directory if
	    experiencing issues.</para>
	</tip>

	<para xml:lang="en">Activate the xencommons service during system
	  startup:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc xencommons_enable=yes</userinput></screen>

	<para xml:lang="en">These settings are enough to start a Dom0-enabled
	  system.  However, it lacks network functionality for the
	  DomU machines.  To fix that, define a bridged interface with
	  the main NIC of the system which the DomU VMs can use to
	  connect to the network.  Replace
	  <replaceable>em0</replaceable> with the host network
	  interface name.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc cloned_interfaces="bridge0"</userinput>
<prompt>#</prompt> <userinput>sysrc ifconfig_bridge0="addm <replaceable>em0</replaceable> SYNCDHCP"</userinput>
<prompt>#</prompt> <userinput>sysrc ifconfig_<replaceable>em0</replaceable>="up"</userinput></screen>

	<para xml:lang="en">Restart the host to load the <trademark>Xen</trademark> kernel and start the
	  Dom0.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>reboot</userinput></screen>

	<para xml:lang="en">After successfully booting the <trademark>Xen</trademark> kernel and logging
	  into the system again, the <trademark>Xen</trademark> management tool
	  <command>xl</command> is used to show information about the
	  domains.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>xl list</userinput>
Name                                        ID   Mem VCPUs      State   Time(s)
Domain-0                                     0  8192     4     r-----     962.0</screen>

	<para xml:lang="en">The output confirms that the Dom0 (called
	  <literal>Domain-0</literal>) has the ID <literal>0</literal>
	  and is running.  It also has the memory and virtual CPUs
	  that were defined in <filename>/boot/loader.conf</filename>
	  earlier.  More information can be found in the <link xlink:href="https://www.xenproject.org/help/documentation.html"><trademark>Xen</trademark>
	    Documentation</link>.  DomU guest VMs can now be
	  created.</para>
      </sect2>

      <sect2 xml:id="virtualization-host-xen-domu-setup">
	<title><trademark>Xen</trademark> DomU 客端 VM 設置</title>

	<para xml:lang="en">Unprivileged domains consist of a configuration file and
	  virtual or physical hard disks.  Virtual disk storage for
	  the DomU can be files created by <citerefentry><refentrytitle>truncate</refentrytitle><manvolnum>1</manvolnum></citerefentry> or ZFS
	  volumes as described in <xref linkend="zfs-zfs-volume"/>.
	  In this example, a 20 GB volume is used.  A VM is
	  created with the ZFS volume, a FreeBSD ISO image, 1 GB of
	  RAM and two virtual CPUs.  The ISO installation file is
	  retrieved with <citerefentry><refentrytitle>fetch</refentrytitle><manvolnum>1</manvolnum></citerefentry> and saved locally in a file
	  called <filename>freebsd.iso</filename>.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>fetch <replaceable>ftp://ftp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/<replaceable>12.0</replaceable>/FreeBSD-<replaceable>12.0</replaceable>-RELEASE-amd64-bootonly.iso</replaceable> -o <replaceable>freebsd.iso</replaceable></userinput></screen>

      <para xml:lang="en">A ZFS volume of 20 GB called
	<filename>xendisk0</filename> is created to serve as the disk
	space for the VM.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>zfs create -V20G -o volmode=dev zroot/xendisk0</userinput></screen>

      <para xml:lang="en">The new DomU guest VM is defined in a file.  Some specific
	definitions like name, keymap, and VNC connection details are
	also defined.  The following <filename>freebsd.cfg</filename>
	contains a minimum DomU configuration for this example:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cat freebsd.cfg</userinput>
builder = "hvm" <co xml:id="co-xen-builder"/>
name = "freebsd" <co xml:id="co-xen-name"/>
memory = 1024 <co xml:id="co-xen-memory"/>
vcpus = 2 <co xml:id="co-xen-vcpus"/>
vif = [ 'mac=00:16:3E:74:34:32,bridge=bridge0' ] <co xml:id="co-xen-vif"/>
disk = [
'/dev/zvol/tank/xendisk0,raw,hda,rw', <co xml:id="co-xen-disk"/>
'/root/freebsd.iso,raw,hdc:cdrom,r' <co xml:id="co-xen-cdrom"/>
  ]
vnc = 1 <co xml:id="co-xen-vnc"/>
vnclisten = "0.0.0.0"
serial = "pty"
usbdevice = "tablet"</screen>

      <para xml:lang="en">These lines are explained in more detail:</para>

      <calloutlist>
	<callout arearefs="co-xen-builder">
	  <para xml:lang="en">This defines what kind of virtualization to use.
	    <literal>hvm</literal> refers to hardware-assisted
	    virtualization or hardware virtual machine.  Guest
	    operating systems can run unmodified on CPUs with
	    virtualization extensions, providing nearly the same
	    performance as running on physical hardware.
	    <literal>generic</literal> is the default value and
	    creates a PV domain.</para>
	</callout>

	<callout arearefs="co-xen-name">
	  <para xml:lang="en">Name of this virtual machine to distinguish it from
	    others running on the same Dom0.  Required.</para>
	</callout>

	<callout arearefs="co-xen-memory">
	  <para xml:lang="en">Quantity of RAM in megabytes to make available to the
	    VM.  This amount is subtracted from the hypervisor's total
	    available memory, not the memory of the Dom0.</para>
	</callout>

	<callout arearefs="co-xen-vcpus">
	  <para xml:lang="en">Number of virtual CPUs available to the guest VM.  For
	    best performance, do not create guests with more virtual
	    CPUs than the number of physical CPUs on the host.</para>
	</callout>

	<callout arearefs="co-xen-vif">
	  <para xml:lang="en">Virtual network adapter.  This is the bridge connected
	    to the network interface of the host.  The
	    <literal>mac</literal> parameter is the MAC address set on
	    the virtual network interface.  This parameter is
	    optional, if no MAC is provided <trademark>Xen</trademark> will generate a
	    random one.</para>
	</callout>

	<callout arearefs="co-xen-disk">
	  <para xml:lang="en">Full path to the disk, file, or ZFS volume of the disk
	    storage for this VM.  Options and multiple disk
	    definitions are separated by commas.</para>
	</callout>

	<callout arearefs="co-xen-cdrom">
	  <para xml:lang="en">Defines the Boot medium from which the initial
	    operating system is installed.  In this example, it is the
	    ISO imaged downloaded earlier.  Consult the <trademark>Xen</trademark>
	    documentation for other kinds of devices and options to
	    set.</para>
	</callout>

	<callout arearefs="co-xen-vnc">
	  <para xml:lang="en">Options controlling VNC connectivity to the serial
	    console of the DomU.  In order, these are: active VNC
	    support, define IP address on which to listen, device node
	    for the serial console, and the input method for precise
	    positioning of the mouse and other input methods.
	    <literal>keymap</literal> defines which keymap to use, and
	    is <literal>english</literal> by default.</para>
	</callout>
      </calloutlist>

      <para xml:lang="en">After the file has been created with all the necessary
	options, the DomU is created by passing it to <command>xl
	  create</command> as a parameter.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>xl create freebsd.cfg</userinput></screen>

      <note>
	<para xml:lang="en">Each time the Dom0 is restarted, the configuration file
	  must be passed to <command>xl create</command> again to
	  re-create the DomU.  By default, only the Dom0 is created
	  after a reboot, not the individual VMs.  The VMs can
	  continue where they left off as they stored the operating
	  system on the virtual disk.  The virtual machine
	  configuration can change over time (for example, when adding
	  more memory).  The virtual machine configuration files must
	  be properly backed up and kept available to be able to
	  re-create the guest VM when needed.</para>
      </note>

      <para xml:lang="en">The output of <command>xl list</command> confirms that the
	DomU has been created.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>xl list</userinput>
Name                                        ID   Mem VCPUs      State   Time(s)
Domain-0                                     0  8192     4     r-----  1653.4
freebsd                                      1  1024     1     -b----   663.9</screen>

      <para xml:lang="en">To begin the installation of the base operating system,
	start the VNC client, directing it to the main network address
	of the host or to the IP address defined on the
	<literal>vnclisten</literal> line of
	<filename>freebsd.cfg</filename>.  After the operating system
	has been installed, shut down the DomU and disconnect the VNC
	viewer.  Edit <filename>freebsd.cfg</filename>, removing the
	line with the <literal>cdrom</literal> definition or
	commenting it out by inserting a <literal>#</literal>
	character at the beginning of the line.  To load this new
	configuration, it is necessary to remove the old DomU with
	<command>xl destroy</command>, passing either the name or the
	id as the parameter.  Afterwards, recreate it using the
	modified <filename>freebsd.cfg</filename>.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>xl destroy freebsd</userinput>
<prompt>#</prompt> <userinput>xl create freebsd.cfg</userinput></screen>

      <para xml:lang="en">The machine can then be accessed again using the VNC
	viewer.  This time, it will boot from the virtual disk where
	the operating system has been installed and can be used as a
	virtual machine.</para>
    </sect2>

    <sect2 xml:id="virtualization-host-xen-troubleshooting">
      <title>疑難排解</title>

      <para xml:lang="en">This section contains basic information in order to help
	troubleshoot issues found when using FreeBSD as a <trademark>Xen</trademark> host or
	guest.</para>

      <sect3 xml:id="virtualization-host-xen-troubleshooting-host">
	<title>主端開機疑難排解</title>

	<para xml:lang="en">Please note that the following troubleshooting tips
	  are intended for <trademark>Xen</trademark> 4.11 or newer.  If you are still
	  using <trademark>Xen</trademark> 4.7 and having issues consider migrating to
	  a newer version of <trademark>Xen</trademark>.</para>

	<para xml:lang="en">In order to troubleshoot host boot issues you will
	  likely need a serial cable, or a debug USB cable.  Verbose
	  <trademark>Xen</trademark> boot output can be obtained by adding options to the
	  <literal>xen_cmdline</literal> option found in
	  <filename>loader.conf</filename>.  A couple of relevant
	  debug options are:</para>

	<itemizedlist>
	  <listitem>
	    <para xml:lang="en"><literal>iommu=debug</literal>: can be used to print
	      additional diagnostic information about the
	      iommu.</para>
	  </listitem>
	  <listitem>
	    <para xml:lang="en"><literal>dom0=verbose</literal>: can be used to
	      print additional diagnostic information about the
	      dom0 build process.</para>
	  </listitem>
	  <listitem>
	    <para xml:lang="en"><literal>sync_console</literal>: flag to force
	      synchronous console output.  Useful for debugging to
	      avoid losing messages due to rate limiting.
	      Never use this option in production environments since
	      it can allow malicious guests to perform DoS attacks
	      against <trademark>Xen</trademark> using the console.</para>
	  </listitem>
	</itemizedlist>

	<para xml:lang="en">FreeBSD should also be booted in verbose mode in order
	  to identify any issues.  To activate verbose booting, run
	  this command:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc -f /boot/loader.conf boot_verbose="YES"</userinput></screen>

	<para xml:lang="en">If none of these options help solving the problem,
	  please send the serial boot log to
	  <email>freebsd-xen@FreeBSD.org</email> and
	  <email>xen-devel@lists.xenproject.org</email>
	  for further analysis.</para>
      </sect3>

      <sect3 xml:id="virtualization-host-xen-troubleshooting-guest">
	<title>客端建立疑難排解</title>

	<para xml:lang="en">Issues can also arise when creating guests, the
	  following attempts to provide some help for those trying
	  to diagnose guest creation issues.</para>

	<para xml:lang="en">The most common cause of guest creation failures is the
	  <literal>xl</literal> command spitting some error and
	  exiting with a return code different than 0.  If the error
	  provided is not enough to help identify the issue, more
	  verbose output can also be obtained from
	  <literal>xl</literal> by using the <literal>v</literal>
	  option repeatedly.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>xl -vvv create freebsd.cfg</userinput>
Parsing config from freebsd.cfg
libxl: debug: libxl_create.c:1693:do_domain_create: Domain 0:ao 0x800d750a0: create: how=0x0 callback=0x0 poller=0x800d6f0f0
libxl: debug: libxl_device.c:397:libxl__device_disk_set_backend: Disk vdev=xvda spec.backend=unknown
libxl: debug: libxl_device.c:432:libxl__device_disk_set_backend: Disk vdev=xvda, using backend phy
libxl: debug: libxl_create.c:1018:initiate_domain_create: Domain 1:running bootloader
libxl: debug: libxl_bootloader.c:328:libxl__bootloader_run: Domain 1:not a PV/PVH domain, skipping bootloader
libxl: debug: libxl_event.c:689:libxl__ev_xswatch_deregister: watch w=0x800d96b98: deregister unregistered
domainbuilder: detail: xc_dom_allocate: cmdline="", features=""
domainbuilder: detail: xc_dom_kernel_file: filename="/usr/local/lib/xen/boot/hvmloader"
domainbuilder: detail: xc_dom_malloc_filemap    : 326 kB
libxl: debug: libxl_dom.c:988:libxl__load_hvm_firmware_module: Loading BIOS: /usr/local/share/seabios/bios.bin
...</screen>

	<para xml:lang="en">If the verbose output does not help diagnose the issue
	  there are also QEMU and <trademark>Xen</trademark> toolstack logs in
	  <filename>/var/log/xen</filename>.  Note that the name of
	  the domain is appended to the log name, so if the domain
	  is named <literal>freebsd</literal> you should find a
	  <filename>/var/log/xen/xl-freebsd.log</filename> and likely
	  a <filename>/var/log/xen/qemu-dm-freebsd.log</filename>.
	  Both log files can contain useful information for debugging.
	  If none of this helps solve the issue, please send the
	  description of the issue you are facing and as much
	  information as possible to
	  <email>freebsd-xen@FreeBSD.org</email> and
	  <email>xen-devel@lists.xenproject.org</email> in order to
	  get help.</para>
      </sect3>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="l10n">
  <info>
    <title>在地化 - <acronym>i18n</acronym>/<acronym>L10n</acronym> 使用與安裝</title>

    <authorgroup>
      <author xml:lang="en"><personname><firstname>Andrey</firstname><surname>Chernov</surname></personname><contrib>Contributed
	by </contrib></author>
    </authorgroup>
    <authorgroup>
      <author xml:lang="en"><personname><firstname>Michael
	C.</firstname><surname>Wu</surname></personname><contrib>Rewritten
	by </contrib></author>
      <!-- 30 Nv 2000 -->
    </authorgroup>
  </info>

  <sect1 xml:id="l10n-synopsis">
    <title>概述</title>

    <para>FreeBSD 計劃的使用者及貢獻者分佈在世界各地，也因此 FreeBSD 支援多語系，讓使用者可以使用非英文語言來檢視、輸入或處理資料。使用者可以選擇大多數主要語言，包含但不限於以下語言：中文、德文、日文、韓文、法文、俄文及越南文。</para>

    <indexterm xml:lang="en">
      <primary>internationalization</primary>
	<see>localization</see>
    </indexterm>
    <indexterm><primary>在地化</primary></indexterm>

    <para><literal>國際化</literal> (Internationalization) 一詞可以縮寫為 <acronym>i18n</acronym>，即  第一個字母到最後一個字母間的字母數量。<acronym>L10n</acronym> 也使用同樣的命名規則，但源自 <literal>在地化</literal> (Localization)。 <acronym>i18n</acronym>/<acronym>L10n</acronym> 的方法、協定及應用程式讓使用者可以自己選擇使用的語言。</para>

    <para>本章會討論 FreeBSD 的國際化及在地化功能。在閱讀本章之後，您會了解：</para>

    <itemizedlist>
      <listitem>
	<para>語系名稱如何組成。</para>
      </listitem>

      <listitem>
	<para>如何設定登入 Shell 的語系。</para>
      </listitem>

      <listitem>
	<para>如何設定 Console 給非英文語言的使用者。</para>
      </listitem>

      <listitem>
	<para>如果設定 <application>Xorg</application> 使用不同語言。</para>
      </listitem>

      <listitem>
	<para>如何找到支援 <acronym>i18n</acronym> 的應用程式。</para>
      </listitem>

      <listitem>
	<para>那裡可以找到更多設定特定語言的資訊。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem><para>了解如何 <link linkend="ports">安裝其他第三方應用程式</link>。</para></listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="using-localization">
    <title>使用語系</title>

    <indexterm xml:lang="en"><primary>locale</primary></indexterm>

    <para>語系設定值由三個元件所組成：語言代號、城市代號及編碼。語系名稱組成的方式如下：</para>

    <programlisting xml:lang="en"><replaceable>LanguageCode</replaceable>_<replaceable>CountryCode</replaceable>.<replaceable>Encoding</replaceable></programlisting>

      <indexterm xml:lang="en"><primary>language codes</primary></indexterm>
      <indexterm xml:lang="en"><primary>country codes</primary></indexterm>

      <para><replaceable>LanguageCode</replaceable> 與 <replaceable>CountryCode</replaceable> 用來表示城市及特定語言。<xref linkend="locale-lang-country"/> 提供了幾個 <replaceable>LanguageCode</replaceable>_<replaceable>CountryCode</replaceable> 的範例：</para>

      <table xml:id="locale-lang-country" frame="none" pgwide="1">
	<title>常用語言及城市代碼</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>語言代號_城市代號</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">en_US</entry>
	      <entry>英文，美國</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">ru_RU</entry>
	      <entry>俄文，俄國</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">zh_TW</entry>
	      <entry>繁體中文，台灣</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>完整可用的語系清單可用以下指令查詢：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>locale -a | more</userinput></screen>

      <para>查詢目前使用的語系設定：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>locale</userinput></screen>

      <indexterm xml:lang="en"><primary>encodings</primary></indexterm>
      <indexterm xml:lang="en"><primary>ASCII</primary></indexterm>

      <para>語言特定的字元集如 ISO8859-1, ISO8859-15, KOI8-R 及 CP437 在 <citerefentry><refentrytitle>multibyte</refentrytitle><manvolnum>3</manvolnum></citerefentry> 有詳細說明。可用的字元集可在 <link xlink:href="http://www.iana.org/assignments/character-sets">IANA Registry</link> 查詢。</para>

      <para>某些語言，如中文或日文，無法使用 <acronym>ASCII</acronym> 字元表示，會需要使用寬 (Wide) 字元或多位元組 (Multibyte) 字元來擴充的語言編碼。EUC 與 Big5 即是使用寬子元或多位元組字元的例子。舊的應用程式會誤判這些字元為控制字元，新的應用程式則通常可以辨識這些字元，依實作的需要，使用者可能需要開啟寬字元或多位元組字元支援或者使用正確的字元設定來編譯應用程式。</para>

      <note>
	<para>FreeBSD 使用 Xorg 相容的語系編碼。</para>
      </note>

      <para>本節剩餘的部份將說明各種在 FreeBSD 系統上設定語系的方法。下一節將會探討如何尋找以及編譯使用 <acronym>i18n</acronym> 支援的應用程式。</para>

    <sect2 xml:id="setting-locale">
      <title>設定登入 Shell 的語系</title>

      <para>語系設定可在使用者的 <filename>~/.login_conf</filename> 或使用者的 Shell 的啟動檔設定：<filename>~/.profile</filename>, <filename>~/.bashrc</filename> 或 <filename>~/.cshrc</filename>。</para>

      <para>有兩個環境變數需要設定：</para>

      <itemizedlist>
	<listitem>
	  <para><envar>LANG</envar> 用來設定語系<indexterm>
	    <primary>POSIX</primary></indexterm></para>
	</listitem>

	<listitem>
	  <indexterm xml:lang="en"><primary>MIME</primary></indexterm>

	  <para><envar>MM_CHARSET</envar> 用來設定應用程式所使用的 <acronym>MIME</acronym> 字元集</para>
	</listitem>
      </itemizedlist>

      <para>除了使用者的 Shell 設定外，這些變數也應針對特定應用程式設定以及 <application>Xorg</application> 設定。</para>

      <indexterm xml:lang="en"><primary>locale</primary></indexterm>
      <indexterm xml:lang="en"><primary>login class</primary></indexterm>

      <para>兩種可以完成所需變數設定的方法有：<link linkend="login-class">登入類別 (Login class)</link> 法 (較建議) 及 <link linkend="startup-file">啟動檔 (Startup file) </link> 法。以下兩節將示範如何使用這兩個方法。</para>

      <sect3 xml:id="login-class">
	<title>登入類別 (Login Class) 法</title>

	<para>第一種方式，同時也是建議使用的方法，它可以對任何可能的 Shell 設定需要的語系及 MIME 字元集變數。此設定也可由每位使用者自行設定或者由超級管理者為所有使用者設定。</para>

	<para>以下精簡範例示範在一個使用者的家目錄中的 <filename>.login_conf</filename> 設定 Latin-1 編碼使用的兩個環境變數：</para>

	<programlisting xml:lang="en">me:\
	:charset=ISO-8859-1:\
	:lang=de_DE.ISO8859-1:</programlisting>

	<indexterm xml:lang="en"><primary>Traditional Chinese</primary>
	  <secondary>BIG-5 encoding</secondary></indexterm>

	<para>以下使用者的 <filename>~/.login_conf</filename> 範例設定了繁體中文於 BIG-5 編碼使用到的環境變數。有一部份應用程式無法正確處理中文、日文及韓文的語系變數，因此需要額外多做一些設定：</para>

	<programlisting xml:lang="en">#Users who do not wish to use monetary units or time formats
#of Taiwan can manually change each variable
me:\
	:lang=zh_TW.Big5:\
	:setenv=LC_ALL=zh_TW.Big5,LC_COLLATE=zh_TW.Big5,LC_CTYPE=zh_TW.Big5,LC_MESSAGES=zh_TW.Big5,LC_MONETARY=zh_TW.Big5,LC_NUMERIC=zh_TW.Big5,LC_TIME=zh_TW.Big5:\
	:charset=big5:\
	:xmodifiers="@im=gcin": #Set gcin as the XIM Input Server</programlisting>

	<para>或者，超級使用者可以設定所有系統使用者的語系。以下在 <filename>/etc/login.conf</filename> 中的變數可用來設定語系及 <acronym>MIME</acronym> 字元集：</para>

	<programlisting xml:lang="en"><replaceable>language_name</replaceable>|<replaceable>Account Type Description</replaceable>:\
	:charset=<replaceable>MIME_charset</replaceable>:\
	:lang=<replaceable>locale_name</replaceable>:\
	:tc=default:</programlisting>

	<para>若套用之前的 Latin-1 編碼範例如下：</para>

	<programlisting xml:lang="en">german|German Users Accounts:\
	:charset=ISO-8859-1:\
	:lang=de_DE.ISO8859-1:\
	:tc=default:</programlisting>

	<para>請參考 <citerefentry><refentrytitle>login.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 以取得更多有關這些變數的詳細資訊。請注意，它已經含有預先定義的 <replaceable>russian</replaceable> class。</para>

	<para>每次編輯 <filename>/etc/login.conf</filename> 之後，請記得要執行以下指令來更新登入類別的能力資料庫(Capability database)：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cap_mkdb /etc/login.conf</userinput></screen>

	<sect4>
	  <title>變更登入類別的工具</title>

	  <indexterm xml:lang="en">
	    <primary><command>vipw</command></primary>
	  </indexterm>

	  <para>除了手動編輯 <filename>/etc/login.conf</filename> 之外，尚有需多工具可用來為新建立的使用者設定語系。</para>

	  <para>當使用 <command>vipw</command> 來新增使用者時，可指定 <replaceable>language</replaceable> 來設定語系：</para>

	  <programlisting xml:lang="en">user:password:1111:11:<replaceable>language</replaceable>:0:0:User Name:/home/user:/bin/sh</programlisting>

	  <indexterm xml:lang="en">
	    <primary><command>adduser</command></primary>
	  </indexterm>
	  <indexterm xml:lang="en"><primary>login class</primary></indexterm>

	  <para>當使用 <command>adduser</command> 來新增使用者時，可對所有使用者或指定的使用者事先設定預設的語言。</para>

	  <para>若所有新的使用者都使用同樣的語言，可在 <filename>/etc/adduser.conf</filename> 設定 <literal>defaultclass=<replaceable>language</replaceable></literal>。</para>

	  <para>要在建立使用者時覆蓋預設的設定，可在出現此提示時輸入需要的語系：</para>

	  <screen xml:lang="en"><prompt>Enter login class: default []:</prompt></screen>

	  <para>或執行 <command>adduser</command> 時指定語系：</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>adduser -class <replaceable>language</replaceable></userinput></screen>

	  <indexterm xml:lang="en">
	    <primary><command>pw</command></primary>
	  </indexterm>

	  <para>若使用 <command>pw</command> 來新增使用者，則可指定語系如下：</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>pw useradd <replaceable>user_name</replaceable> -L <replaceable>language</replaceable></userinput></screen>

	  <para xml:lang="en">To change the login class of an existing user,
	    <command>chpass</command> can be used.  Invoke it as
	    superuser and provide the username to edit as the
	    argument.</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>chpass <replaceable>user_name</replaceable></userinput></screen>
	  </sect4>
	</sect3>

	<sect3 xml:id="startup-file">
	  <title>Shell 啟動檔 (Startup File) 法</title>

	  <para>第二種方法，較不建議使用，因每一種使用到的 Shell 都需要手動設定，而每一種 Shell 都有不同的設定檔以及語法。例如將一位使用者的 <command>sh</command> shell 設定為德語，需要將下列行加到 <filename>~/.profile</filename>，若要設定給使用該 Shell 的所有使用者則必須將下列行加到 <filename>/etc/profile</filename> 或 <filename>/usr/share/skel/dot.profile</filename>：</para>

	  <programlisting xml:lang="en"><envar>LANG</envar>=de_DE.ISO8859-1; export <envar>LANG</envar>
<envar>MM_CHARSET</envar>=ISO-8859-1; export <envar>MM_CHARSET</envar></programlisting>

	  <para>然而，在 <command>csh</command> shell 所使用的設定檔名稱及語法不同。同樣的設定需加入下列行至 <filename>~/.csh.login</filename>, <filename>/etc/csh.login</filename> 或 <filename>/usr/share/skel/dot.login</filename>：</para>

	  <programlisting xml:lang="en">setenv <envar>LANG</envar> de_DE.ISO8859-1
setenv <envar>MM_CHARSET</envar> ISO-8859-1</programlisting>

	  <para>更複雜一點的情況，<application>Xorg</application> 的 <filename>~/.xinitrc</filename> 語系設定會依使用的 Shell 而有所不同。第一個例子是針對 <command>sh</command> shell 而第二個則是針對 <command>csh</command> shell：</para>

	  <programlisting xml:lang="en"><envar>LANG</envar>=de_DE.ISO8859-1; export <envar>LANG</envar></programlisting>

	  <programlisting xml:lang="en">setenv <envar>LANG</envar> de_DE.ISO8859-1</programlisting>
      </sect3>
    </sect2>

    <sect2 xml:id="setting-console">
      <title>Console 設定</title>

      <para>已有許多語系的字型可在 Console 使用，要查看可用的字型清單，可輸入 <command>ls /usr/share/syscons/fonts</command>。要設定 Console 的字型，可在 <filename>/etc/rc.conf</filename> 指定去掉 <filename>.fnt</filename> 字尾的字型名稱 <replaceable>font_name</replaceable>：</para>

      <programlisting xml:lang="en">font8x16=<replaceable>font_name</replaceable>
font8x14=<replaceable>font_name</replaceable>
font8x8=<replaceable>font_name</replaceable></programlisting>

      <indexterm xml:lang="en"><primary>keymap</primary></indexterm>
      <indexterm xml:lang="en"><primary>screenmap</primary></indexterm>
      <para>鍵盤對應表 (Keymap) 及螢幕對應表 (Screenmap) 用可加入下行到 <filename>/etc/rc.conf</filename> 來設定：</para>

      <programlisting xml:lang="en">scrnmap=<replaceable>screenmap_name</replaceable>
keymap=<replaceable>keymap_name</replaceable>
keychange="<replaceable>fkey_number sequence</replaceable>"</programlisting>

      <para>要查看可用的螢幕對應表，可輸入 <command>ls /usr/share/syscons/scrnmaps</command>。在設定螢幕對應表 <replaceable>screenmap_name</replaceable> 時請去掉 <filename>.scm</filename> 字尾。在 VGA Adapter 的字型字元矩陣擴充位元 8 到位元 9 時會需要使用螢幕對應表與相關的字型對應來解決，因此若螢幕字型使用位元 8 的欄位，字母會移出虛擬繪圖區 (Pseudographics area)。</para>

      <para>要查看可用的鍵盤對應表，可輸入 <command>ls /usr/share/syscons/keymaps</command>。在設定鍵盤對應表 <replaceable>keymap_name</replaceable> 時請去掉 <filename>.kbd</filename> 字尾。若要不重開機測試鍵盤對應用可使用 <citerefentry><refentrytitle>kbdmap</refentrytitle><manvolnum>1</manvolnum></citerefentry>。</para>

      <para><literal>keychange</literal> 項目用在當功能鍵序列無法定義在鍵盤對應表時，可設定對應選擇終對機類型的功能鍵。</para>

      <para>接下來，在 <filename>/etc/ttys</filename> 為所有虛擬終端機項目設定正確的 Console 終端機類型。<xref linkend="locale-charset"/> 摘要了可用的終端機類型：</para>

      <table xml:id="locale-charset" frame="none" pgwide="1">
	<title>已定義供特定字元集使用的終端機類型</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>字元集</entry>
	      <entry>終端機類型</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">ISO8859-1 or ISO8859-15</entry>
	      <entry xml:lang="en"><literal>cons25l1</literal></entry>
	    </row>

	    <row>
	      <entry xml:lang="en">ISO8859-2</entry>
	      <entry xml:lang="en"><literal>cons25l2</literal></entry>
	    </row>

	    <row>
	      <entry xml:lang="en">ISO8859-7</entry>
	      <entry xml:lang="en"><literal>cons25l7</literal></entry>
	    </row>

	    <row>
	      <entry xml:lang="en">KOI8-R</entry>
	      <entry xml:lang="en"><literal>cons25r</literal></entry>
	    </row>

	    <row>
	      <entry xml:lang="en">KOI8-U</entry>
	      <entry xml:lang="en"><literal>cons25u</literal></entry>
	    </row>

	    <row>
	      <entry>CP437 (VGA 預設值)</entry>
	      <entry xml:lang="en"><literal>cons25</literal></entry>
	    </row>

	    <row>
	      <entry xml:lang="en">US-ASCII</entry>
	      <entry xml:lang="en"><literal>cons25w</literal></entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <indexterm xml:lang="en">
	<primary><application>moused</application></primary>
      </indexterm>

      <para>對於使用寬字元或多位元組字元的語言，需從 Port 套件集安裝支援該語言的 Console。 可用的 Port 摘要在 <xref linkend="locale-console"/>。安裝完成之後，請參考 Port 的 <filename>pkg-message</filename> 或操作手冊來取得設定及使用說明。</para>

      <table xml:id="locale-console" frame="none" pgwide="1">
	<title>Port 套件集中可用的 Console</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>語言</entry>
	      <entry>Port 位置</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry>繁體中文 (BIG-5)</entry>
	      <entry xml:lang="en"><package>chinese/big5con</package></entry>
	    </row>

	    <row>
	      <entry>中文/日文/韓文</entry>
	      <entry xml:lang="en"><package>chinese/cce</package></entry>
	    </row>

	    <row>
	      <entry>中文/日文/韓文</entry>
	      <entry xml:lang="en"><package>chinese/zhcon</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>chinese/kon2</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/kon2-14dot</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/kon2-16dot</package></entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para>若在 <filename>/etc/rc.conf</filename> 有開啟 <application>moused</application>，可能會需要額外的設定。預設 <citerefentry><refentrytitle>syscons</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式的滑鼠游標會佔用字元集 <literal>0xd0</literal>-<literal>0xd3</literal> 的範圍，若語言有使用到此範圍，可加入以下行到 <filename>/etc/rc.conf</filename> 來移動游標的範圍：</para>

      <programlisting xml:lang="en">mousechar_start=3</programlisting>
    </sect2>

    <sect2>
      <title>Xorg 設定</title>

      <para><xref linkend="x11"/> 會說明如何安裝並設定 <application>Xorg</application>。當要設定 <application>Xorg</application> 在地化時，可從 FreeBSD Port 套件集中取得其他可用的字型及輸入法。應用程式特定的 <acronym>i18n</acronym> 設定像是字型與選單，可以在 <filename>~/.Xresources</filename> 中調校且可允許使用者在圖型化應用程式選單檢視其所選擇的語言。</para>

      <indexterm xml:lang="en"><primary>X Input Method (XIM)</primary></indexterm>

      <para>X 輸入法 (X Input Method, <acronym>XIM</acronym>) 協定是 <application>Xorg</application> 針對輸入非英語字元的標準。<xref linkend="locale-xim"/> 摘要了在 FreeBSD 套件集中可用的輸入法應用程式。也可使用其他如 Fcitx 及 Uim 應用程式。</para>

      <table xml:id="locale-xim" frame="none" pgwide="1">
	<title>可用的輸入法</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>語言</entry>
	      <entry>輸入法</entry>
	    </row>
	  </thead>

	  <tbody>

	    <row>
	      <entry>中文</entry>
	      <entry xml:lang="en"><package>chinese/gcin</package></entry>
	    </row>

	    <row>
	      <entry>中文</entry>
	      <entry xml:lang="en"><package>chinese/ibus-chewing</package></entry>
	    </row>

	    <row>
	      <entry>中文</entry>
	      <entry xml:lang="en"><package>chinese/ibus-pinyin</package></entry>
	    </row>

	    <row>
	      <entry>中文</entry>
	      <entry xml:lang="en"><package>chinese/oxim</package></entry>
	    </row>

	    <row>
	      <entry>中文</entry>
	      <entry xml:lang="en"><package>chinese/scim-fcitx</package></entry>
	    </row>

	    <row>
	      <entry>中文</entry>
	      <entry xml:lang="en"><package>chinese/scim-pinyin</package></entry>
	    </row>

	    <row>
	      <entry>中文</entry>
	      <entry xml:lang="en"><package>chinese/scim-tables</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/ibus-anthy</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/ibus-mozc</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/ibus-skk</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/im-ja</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/kinput2</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/scim-anthy</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/scim-canna</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/scim-honoka</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/scim-honoka-plugin-romkan</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/scim-honoka-plugin-wnn</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/scim-prime</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/scim-skk</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/scim-tables</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/scim-tomoe</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/scim-uim</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/skkinput</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/skkinput3</package></entry>
	    </row>

	    <row>
	      <entry>日文</entry>
	      <entry xml:lang="en"><package>japanese/uim-anthy</package></entry>
	    </row>

	    <row>
	      <entry>韓文</entry>
	      <entry xml:lang="en"><package>korean/ibus-hangul</package></entry>
	    </row>

	    <row>
	      <entry>韓文</entry>
	      <entry xml:lang="en"><package>korean/imhangul</package></entry>
	    </row>

	    <row>
	      <entry>韓文</entry>
	      <entry xml:lang="en"><package>korean/nabi</package></entry>
	    </row>

	    <row>
	      <entry>韓文</entry>
	      <entry xml:lang="en"><package>korean/scim-hangul</package></entry>
	    </row>

	    <row>
	      <entry>韓文</entry>
	      <entry xml:lang="en"><package>korean/scim-tables</package></entry>
	    </row>

	    <row>
	      <entry>越南文</entry>
	      <entry xml:lang="en"><package>vietnamese/xvnkb</package></entry>
	    </row>

	    <row>
	      <entry>越南文</entry>
	      <entry xml:lang="en"><package>vietnamese/x-unikey</package></entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>
    </sect2>
<!--
Comment out for now. If needed, can be added as note in new Printing chapter.
    <sect2>
      <title>Printer Setup</title>

      <para>Some single C chars character sets are hardware coded
	into printers.  Wide or multibyte character sets require
	special setup using a utility such as
	<application>apsfilter</application>.  Documents can be
	converted to &postscript; or PDF formats using language
	specific converters.</para>
    </sect2>
Not sure where to put this section, perhaps as a note in the File system chapter?
    <sect2>
      <title>Kernel and File Systems</title>

      <para>The &os; fast filesystem (<acronym>FFS</acronym>) is 8-bit
	clean, so it can be used with any single C chars character
	set.  However, character set names are not stored in the
	filesystem as it is raw 8-bit and does not understand encoding
	order.  Officially, <acronym>FFS</acronym> does not support
	any form of wide or multibyte character sets.  However, some
	wide or multibyte character sets have independent patches for
	enabling support on <acronym>FFS</acronym>.  Refer to the
	respective languages' web sites for more information and the
	patch files.</para>

      <indexterm><primary>DOS</primary></indexterm>
      <indexterm><primary>Unicode</primary></indexterm>
      <para>&os;'s support for the &ms-dos; filesystem has the
	configurable ability to convert between &ms-dos;, Unicode
	character sets, and chosen &os; filesystem character sets.
	Refer to &man.mount.msdosfs.8; for details.</para>
    </sect2>
        -->
  </sect1>

  <sect1 xml:id="l10n-compiling">
    <title>尋找 <acronym>i18n</acronym> 應用程式</title>

    <para><acronym>i18n</acronym> 應用程式會使用 <acronym>i18n</acronym> 工具包做為程式庫開發。這讓開發人員可以寫一個簡單的檔案並翻譯顯示的選單及文字至各種語言。</para>

    <para><link xlink:href="@@URL_RELPREFIX@@/ports/index.html">FreeBSD Port 套件集</link>中含有許多內建支援寬字元或多位元組字元的應用程式可支援各種語言。該類型的應用程式在名稱上會註明 <literal>i18n</literal> 以易於辨識。雖然如此，但不一定支援您所需要的語言。</para>

    <para>有一部份應用程式可以使用指定的字元集來編譯。通常會在 Port 的 <filename>Makefile</filename> 中設定，或者傳送參數給 <application>configure</application>。請參考各 FreeBSD Port 原始碼中的 <acronym>i18n</acronym> 說明文件以取得更多有關需要的設定值資訊或 Port 的 <filename>Makefile</filename> 來了解在編譯時有那些可以使用的編譯選項。</para>
  </sect1>

  <sect1 xml:id="lang-setup">
    <title>特定語言的語系設定</title>

    <para xml:lang="en">This section provides configuration examples for localizing
      a FreeBSD system for the Russian language.  It then provides some
      additional resources for localizing other languages.</para>

    <sect2 xml:id="ru-localize">
      <info>
	<title>俄語 (KOI8-R 編碼)</title>

	<authorgroup>
	  <author xml:lang="en"><personname><firstname>Andrey</firstname><surname>Chernov</surname></personname><contrib>Originally
	    contributed by </contrib></author>
	</authorgroup>
      </info>

      <indexterm xml:lang="en">
	<primary>localization</primary>
	<secondary>Russian</secondary>
      </indexterm>

      <para xml:lang="en">This section shows the specific settings needed to
	localize a FreeBSD system for the Russian language.  Refer to
	<link linkend="using-localization">Using Localization</link>
	for a more complete description of each type of
	setting.</para>

      <para xml:lang="en">To set this locale for the login shell, add the following
	lines to each user's
	<filename>~/.login_conf</filename>:</para>

      <programlisting xml:lang="en">me:My Account:\
	:charset=KOI8-R:\
	:lang=ru_RU.KOI8-R:</programlisting>

      <para xml:lang="en">To configure the console, add the following lines to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">keymap="ru.koi8-r"
scrnmap="koi8-r2cp866"
font8x16="cp866b-8x16"
font8x14="cp866-8x14"
font8x8="cp866-8x8"
mousechar_start=3</programlisting>

      <para xml:lang="en">For each <literal>ttyv</literal> entry in
	<filename>/etc/ttys</filename>, use
	<literal>cons25r</literal> as the terminal type.</para>

      <indexterm xml:lang="en"><primary>printers</primary></indexterm>
      <para xml:lang="en">To configure printing, a special output filter is needed
	to convert from KOI8-R to CP866 since most printers with
	Russian characters come with hardware code page CP866.  FreeBSD
	includes a default filter for this purpose,
	<filename>/usr/libexec/lpr/ru/koi2alt</filename>.  To use this
	filter, add this entry to
	<filename>/etc/printcap</filename>:</para>

      <programlisting xml:lang="en">lp|Russian local line printer:\
	:sh:of=/usr/libexec/lpr/ru/koi2alt:\
	:lp=/dev/lpt0:sd=/var/spool/output/lpd:lf=/var/log/lpd-errs:</programlisting>

      <para xml:lang="en">Refer to <citerefentry><refentrytitle>printcap</refentrytitle><manvolnum>5</manvolnum></citerefentry> for a more detailed
	explanation.</para>

      <para xml:lang="en">To configure support for Russian filenames in mounted
	<trademark class="registered">MS-DOS</trademark> file systems, include <option>-L</option> and the
	locale name when adding an entry to
	<filename>/etc/fstab</filename>:</para>

     <programlisting xml:lang="en">/dev/ad0s2      /dos/c  msdos   rw,-Lru_RU.KOI8-R 0 0</programlisting>

      <para xml:lang="en">Refer to <citerefentry><refentrytitle>mount_msdosfs</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more details.</para>

      <para xml:lang="en">To configure Russian fonts for
	<application>Xorg</application>, install the
	<package>x11-fonts/xorg-fonts-cyrillic</package> package.
	Then, check the <literal>"Files"</literal> section in
	<filename>/etc/X11/xorg.conf</filename>.  The following line
	must be added <emphasis>before</emphasis> any other
	<literal>FontPath</literal> entries:</para>

      <programlisting xml:lang="en">FontPath   "/usr/local/lib/X11/fonts/cyrillic"</programlisting>

      <para xml:lang="en">Additional Cyrillic fonts are available in the Ports
	Collection.</para>

      <para xml:lang="en">To activate a Russian keyboard, add the following to the
	<literal>"Keyboard"</literal> section of
	<filename>/etc/xorg.conf</filename>:</para>

      <programlisting xml:lang="en">Option "XkbLayout"   "us,ru"
Option "XkbOptions"  "grp:toggle"</programlisting>

      <para xml:lang="en">Make sure that <literal>XkbDisable</literal> is
	commented out in that file.</para>

      <para xml:lang="en">For <literal>grp:toggle</literal> use
	<keycap>Right Alt</keycap>, for
	<literal>grp:ctrl_shift_toggle</literal> use <keycombo action="simul"><keycap>Ctrl</keycap><keycap>Shift</keycap></keycombo>.
	For <literal>grp:caps_toggle</literal> use
	<keycap>CapsLock</keycap>.  The old
	<keycap>CapsLock</keycap> function is still available in LAT
	mode only using <keycombo action="simul"><keycap>Shift</keycap><keycap>CapsLock</keycap></keycombo>.
	<literal>grp:caps_toggle</literal> does not work in
	<application>Xorg</application> for some unknown
	reason.</para>

      <para xml:lang="en">If the keyboard has <quote><trademark class="registered">Windows</trademark></quote> keys, and
	some non-alphabetical keys are mapped incorrectly, add the
	following line to <filename>/etc/xorg.conf</filename>:</para>

      <programlisting xml:lang="en">Option "XkbVariant" ",winkeys"</programlisting>

      <note>
	<para xml:lang="en">The Russian XKB keyboard may not work with
	  non-localized applications.  Minimally localized
	  applications should call a <function>XtSetLanguageProc
	    (NULL, NULL, NULL);</function> function early in the
	  program.</para>
      </note>

      <para xml:lang="en">See <uri xlink:href="http://koi8.pp.ru/xwin.html">http://koi8.pp.ru/xwin.html</uri>
	for more instructions on localizing
	<application>Xorg</application> applications.  For more
	general information about KOI8-R encoding, refer to <uri xlink:href="http://koi8.pp.ru/">http://koi8.pp.ru/</uri>.</para>
    </sect2>

    <sect2>
      <title>其他特定語言資源</title>

      <para xml:lang="en">This section lists some additional resources for
	configuring other locales.</para>

      <indexterm xml:lang="en">
	<primary>localization</primary>
	<secondary>Traditional Chinese</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>localization</primary>
	<secondary>German</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>localization</primary>
	<secondary>Greek</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>localization</primary>
	<secondary>Japanese</secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>localization</primary>
	<secondary>Korean</secondary>
      </indexterm>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">Traditional Chinese for Taiwan</term>

	  <listitem>
	    <para xml:lang="en">The FreeBSD-Taiwan Project has a Chinese HOWTO for FreeBSD
	      at <uri xlink:href="http://netlab.cse.yzu.edu.tw/~statue/freebsd/zh-tut/">http://netlab.cse.yzu.edu.tw/~statue/freebsd/zh-tut/</uri>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">Greek Language Localization</term>

	  <listitem>
	    <para xml:lang="en">A complete article on Greek support in FreeBSD
	      is available <link xlink:href="@@URL_RELPREFIX@@/doc/el_GR.ISO8859-7/articles/greek-language-support/index.html">here</link>,
	      in Greek only, as part of the official FreeBSD Greek
	      documentation.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">Japanese and Korean Language Localization</term>

	  <listitem>
	    <para xml:lang="en">For Japanese, refer to <uri xlink:href="http://www.jp.FreeBSD.org/">http://www.jp.FreeBSD.org/</uri>,
	      and for Korean, refer to <uri xlink:href="http://www.kr.FreeBSD.org/">http://www.kr.FreeBSD.org/</uri>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">Non-English FreeBSD Documentation</term>

	  <listitem>
	    <para xml:lang="en">Some FreeBSD contributors have translated parts of the
	      FreeBSD documentation to other languages.  They are
	      available through links on the <link xlink:href="@@URL_RELPREFIX@@/index.html">FreeBSD web
		site</link> or in
	      <filename>/usr/share/doc</filename>.</para>
	  </listitem>
	</varlistentry>
      </variablelist>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="updating-upgrading">

  <info>
    <title>更新與升級 FreeBSD</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Jim</firstname>
	  <surname>Mock</surname>
	</personname>
	<contrib>Restructured, reorganized, and parts updated
	  by </contrib>
      </author>
      <!-- Mar 2000 -->
    </authorgroup>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Jordan</firstname>
	  <surname>Hubbard</surname>
	</personname>
	<contrib>Original work by </contrib>
      </author>

      <author xml:lang="en">
	<personname>
	  <firstname>Poul-Henning</firstname>
	  <surname>Kamp</surname>
	</personname>
      </author>

      <author xml:lang="en">
	<personname>
	  <firstname>John</firstname>
	  <surname>Polstra</surname>
	</personname>
      </author>

      <author xml:lang="en">
	<personname>
	  <firstname>Nik</firstname>
	  <surname>Clayton</surname>
	</personname>
      </author>
    </authorgroup>
  </info>

  <sect1 xml:id="updating-upgrading-synopsis">
    <title>概述</title>

    <para>FreeBSD 在每次的發佈之間持續在開發。有些人偏好正式發佈的版本，也有另一群人喜歡使用最新的開發版本。然而，即使是正式發佈的版本也時常會有安全性與其他緊急修復的更新，因此，無論使用哪種版本，FreeBSD 都提供所有必要的工具來讓系統能維持最新的版本，且讓各種版本都能簡單的升級。本章將說明如何追蹤開發版本的系統及讓 FreeBSD 系統維持最新版本的基本工具。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>如何使用 <application>freebsd-update</application>, <application>Subversion</application> 來維持 FreeBSD 系統為最新版。</para>
      </listitem>

      <listitem>
	<para>如何比對已安裝系統與已知原始複本間的狀態。</para>
      </listitem>

      <listitem>
	<para>如何使用 <application>Subversion</application> 或說明文件 Port 來維持已安裝的文件為新版。</para>
      </listitem>

      <listitem>
	<para>兩種開發分支間的差異：FreeBSD-STABLE 與 FreeBSD-CURRENT。</para>
      </listitem>

      <listitem>
	<para>如何重新編譯及重新安裝整個基礎系統 (Base system)。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>正確的設定網路連線 (<xref linkend="advanced-networking"/>)。</para>
      </listitem>

      <listitem>
	<para>了解如何安裝其他第三方軟體 (<xref linkend="ports"/>)。</para>
      </listitem>
    </itemizedlist>

    <note>
      <para>本章會經常使用 <command>svnlite</command> 來取得與更新 FreeBSD 原始碼。您也可以使用 <package>devel/subversion</package> Port 或套件。</para>
    </note>
  </sect1>

  <sect1 xml:id="updating-upgrading-freebsdupdate">
    <info>
      <title>FreeBSD 更新</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Colin</firstname>
	    <surname>Percival</surname>
	  </personname>
	  <contrib>Based on notes provided by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>Updating and Upgrading</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>freebsd-update</primary>
      <see>updating-upgrading</see>
    </indexterm>

    <para>隨時套用安全性更新以及升級到新發佈的作業系統版本對管理一個持續運作的系統是非常重要的任務，FreeBSD 內含可以執行這兩項任務的工具程式，叫做 <command>freebsd-update</command>。</para>

    <para>這個工具程式支援使用 Binary 對 FreeBSD 做安全性與和錯誤更新，不需要手動編譯和安裝修補 (Patch) 或新核心。目前由安全性團隊提供支援的 Binary 更新可用於所有的架構和發行版。支援的發行版清單及各自的支援期限列於 <uri xlink:href="https://www.FreeBSD.org/security/">https://www.FreeBSD.org/security/</uri>。</para>

    <para>這個工具程式也支援升級作業系統到次要的發佈版以及升級到另一個發佈版分支。在升級到新的發佈版本前，需先查看該版本的發佈公告，因為發行公告中包含了該發行版本的相關重要資訊。發行公告可自 <uri xlink:href="https://www.FreeBSD.org/releases/">https://www.FreeBSD.org/releases/</uri> 取得。</para>

    <note>
      <para>如果有使用 <command>crontab</command> 來執行 <citerefentry><refentrytitle>freebsd-update</refentrytitle><manvolnum>8</manvolnum></citerefentry>，則必須在升級作業系統前先關閉。</para>
    </note>

    <para>本節將說明 <command>freebsd-update</command> 使用的設定檔， 示範如何套用安全性修補及如何升級到主要或次要的作業系統發行版，並討論升級作業系統的需要考量的事項。</para>

    <sect2 xml:id="freebsdupdate-config-file">
      <title>設定檔</title>

      <para><command>freebsd-update</command> 預設的設定檔不需變更即可運作。 部份使用者可能會想要調校位於 <filename>/etc/freebsd-update.conf</filename> 的預設設定檔來對程序有更好的控制。該設定檔中的註解均有說明可用的選項，但以下幾個項目可能需要進一步的說明：</para>

      <programlisting xml:lang="en"># Components of the base system which should be kept updated.
Components world kernel</programlisting>

      <para>這個參數控制 FreeBSD 要保持最新版本的部份。 預設是更新整個基礎系統 (Base system) 和核心。 可指定個別元件，例如：<literal>src/base</literal> 或 <literal>src/sys</literal>。 雖然如此，最好的選項是維持預設值，因為更改指定特定項目時需列出每一個需要的項目。時間一久可能會因為原始碼和 Binary 檔案沒有更新而造成慘重的後果。</para>

      <programlisting xml:lang="en"># Paths which start with anything matching an entry in an IgnorePaths
# statement will be ignored.
IgnorePaths /boot/kernel/linker.hints</programlisting>

      <para>要保持特定的目錄在更新過程不被更動，例如 <filename>/bin</filename> 或 <filename>/sbin</filename>，可以將他們的路徑加到此敘述中。 這個選項可以防止 <command>freebsd-update</command> 覆蓋本地的修改。</para>

      <programlisting xml:lang="en"># Paths which start with anything matching an entry in an UpdateIfUnmodified
# statement will only be updated if the contents of the file have not been
# modified by the user (unless changes are merged; see below).
UpdateIfUnmodified /etc/ /var/ /root/ /.cshrc /.profile</programlisting>

      <para>這個選項只會更新特定目錄中未修改的設定檔。任何使用者修改的檔案都不會自動更新。 有另一個選項 <literal>KeepModifiedMetadata</literal> 可讓 <command>freebsd-update</command> 在合併時儲存使用者做的變更。</para>

      <programlisting xml:lang="en"># When upgrading to a new FreeBSD release, files which match MergeChanges
# will have any local changes merged into the version from the new release.
MergeChanges /etc/ /var/named/etc/ /boot/device.hints</programlisting>

      <para>列出 <command>freebsd-update</command> 應嘗試合併的設定檔目錄。 檔案合併程序是指一系列類似 <citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry> 做的 <citerefentry><refentrytitle>diff</refentrytitle><manvolnum>1</manvolnum></citerefentry> 修補動作， 但是選項比較少。 合併的動作包含接受、開啟編輯器，或讓 <command>freebsd-update</command> 中止。 如果有疑慮，請先備份 <filename>/etc</filename>，然後再接受合併。 更多關於 <command>mergemaster</command> 的資訊， 參見 <citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry>。</para>

      <programlisting xml:lang="en"># Directory in which to store downloaded updates and temporary
# files used by FreeBSD Update.
# WorkDir /var/db/freebsd-update</programlisting>

      <para>這個目錄是所有修補檔和暫存檔的存放處。當使用者進行版本升級時，這個位置應該要有至少 1GB 的可用磁碟空間。</para>

      <programlisting xml:lang="en"># When upgrading between releases, should the list of Components be
# read strictly (StrictComponents yes) or merely as a list of components
# which *might* be installed of which FreeBSD Update should figure out
# which actually are installed and upgrade those (StrictComponents no)?
# StrictComponents no</programlisting>

      <para>當這個選項設定為 <literal>yes</literal> 時，<command>freebsd-update</command> 將會假設 <literal>Components</literal> 清單已完成，將不會對清單之外的項目做變更。 實際上 <command>freebsd-update</command> 會將嘗試更新每一個屬於 <literal>Components</literal> 清單中的檔案。</para>
    </sect2>

    <sect2 xml:id="freebsdupdate-security-patches">
      <title>套用安全性修補</title>

      <para>套用 FreeBSD 安全性修補的過程已經被簡化，讓系統管理員可使用 <command>freebsd-update</command> 來保持系統更新。更多有關 FreeBSD 安全性報告的資訊可以參考 <xref linkend="security-advisories"/>。</para>

      <para>FreeBSD 安全性修補可以使用以下指令下載並安裝。 第一個指令會偵測是否有可用的修補，如果有，將列出若執行修補後會變更的檔案清單。第二個指令將會套用修補。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>freebsd-update fetch</userinput>
<prompt>#</prompt> <userinput>freebsd-update install</userinput></screen>

      <para>如果更新套用了任何核心修補，系統將會需要重新開機以使用修補過的核心。如果修補套用在任何執行中的 Binary，受影響的應用程式應重新啟動來使用修補過的 Binary 版本。</para>

      <para>加入以下項目至 <filename>/etc/crontab</filename> 可設定系統每天自動檢查更新一次：</para>

      <programlisting xml:lang="en">@daily                                  root    freebsd-update cron</programlisting>

      <para>如果有新的修補，該程式會會自動下載，但不會執行。<systemitem class="username">root</systemitem> 使用者會收到電子郵件通知複查該修補並手動執行 <command>freebsd-update install</command> 安裝。</para>

      <para>如果有發生任何錯誤，<command>freebsd-update</command> 可以使用以下指令還原最後所做的變更：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>freebsd-update rollback</userinput>
Uninstalling updates... done.</screen>

      <para>再次強調，若核心或任何核心模組有做過修改應重新啟動系統，以及任何受影響的 Binary 應重新執行。</para>

      <para>只有 <filename>GENERIC</filename> 核心可使用 <command>freebsd-update</command> 自動更新。 如果有安裝自訂的核心，在 <command>freebsd-update</command> 完成安裝更新後，需要重新編譯和重新安裝。 預設的核心名稱為 <emphasis>GENERIC</emphasis>，可使用 <citerefentry><refentrytitle>uname</refentrytitle><manvolnum>1</manvolnum></citerefentry> 指令來檢查安裝的核心。</para>

      <note>
	<para>隨時在 <filename>/boot/GENERIC</filename> 保留一份 <filename>GENERIC</filename> 核心的複本將有助於診斷各種問題及執行版本升級。請參考 <xref linkend="freebsd-update-custom-kernel-9x"/> 來了解有關如何取得 <filename>GENERIC</filename> 核心的複本說明。</para>
      </note>

      <para>除非在 <filename>/etc/freebsd-update.conf</filename> 的預設設定檔被修改，否則 <command>freebsd-update</command> 將會安裝更新後的核心原始碼和其餘的更新，可依平常的方式執行重新編譯與重新安裝核心。</para>

      <para>以 <command>freebsd-update</command> 發行的更新並非總是會更新核心。若核心的原始碼沒有被 <command>freebsd-update install</command> 修改則不需要重新編譯自訂的核心。雖然如此 <command>freebsd-update</command> 總是會更新 <filename>/usr/src/sys/conf/newvers.sh</filename>，目前修補的版本如 <command>uname -r</command> 執行結果中的 <literal>-p</literal> 數字，便是由該檔取得。即使沒有做任何其他變更，重新編譯自訂核心可讓 <command>uname</command> 準確的回報系統目前的修補版本。當維護多個系統時這會特別有用，因其可讓你快速評估每個系統安裝的更新。</para>
    </sect2>

    <sect2 xml:id="freebsdupdate-upgrade">
      <title>執行主要及次要版號升級</title>

      <para>從 FreeBSD 的次要版本升級到另一個版本，例如從 FreeBSD 9.0 到 FreeBSD 9.1, 叫作 <firstterm>次要版本 (Minor version)</firstterm> 更新。 <firstterm>主要版本 (Major version)</firstterm> 更新發生在當 FreeBSD 從一個主要版本升級到主要版本升級到另一個主要版本時，例如從 FreeBSD 9.X 到 FreeBSD 10.X。 兩種更新都可以透過提供 <command>freebsd-update</command> 目標的發佈版本來執行。</para>

      <note>
	<para>如果系統正在執行自訂的核心，請在開始升級前，確定有保留一份 <filename>GENERIC</filename> 核心的複本在 <filename>/boot/GENERIC</filename>。 請參考 <xref linkend="freebsd-update-custom-kernel-9x"/> 關於如何取得 <filename>GENERIC</filename> 核心複本的說明。</para>
      </note>

      <para>在 FreeBSD 9.0 系統執行以下指令，將會把系統升級至 FreeBSD 9.1：</para>

       <screen xml:lang="en"><prompt>#</prompt> <userinput>freebsd-update -r 9.1-RELEASE upgrade</userinput></screen>

      <para>收到這個指令後，<command>freebsd-update</command> 會開始評估設定檔和目前的系統來收集升級所需的資訊。 螢幕會顯示偵測到或沒偵測到的元件清單。例如：</para>

      <screen xml:lang="en">Looking up update.FreeBSD.org mirrors... 1 mirrors found.
Fetching metadata signature for 9.0-RELEASE from update1.FreeBSD.org... done.
Fetching metadata index... done.
Inspecting system... done.

The following components of FreeBSD seem to be installed:
kernel/smp src/base src/bin src/contrib src/crypto src/etc src/games
src/gnu src/include src/krb5 src/lib src/libexec src/release src/rescue
src/sbin src/secure src/share src/sys src/tools src/ubin src/usbin
world/base world/info world/lib32 world/manpages

The following components of FreeBSD do not seem to be installed:
kernel/generic world/catpages world/dict world/doc world/games
world/proflibs

Does this look reasonable (y/n)? <userinput>y</userinput></screen>

      <para>此時，<command>freebsd-update</command> 將會嘗試下載所有升級需要的檔案。 在某些情況，會詢問使用者一些關於要安裝什麼或要如何繼續。</para>

      <para>當使用自訂核心，上述的步驟將會產生如下的警告：</para>

      <screen xml:lang="en">WARNING: This system is running a "<replaceable>MYKERNEL</replaceable>" kernel, which is not a
kernel configuration distributed as part of FreeBSD 9.0-RELEASE.
This kernel will not be updated: you MUST update the kernel manually
before running "/usr/sbin/freebsd-update install"</screen>

      <para>這時的警告可以安全地忽略，升級過程將會使用更新過的 <filename>GENERIC</filename> 核心來進行。</para>

      <para>所有的修補都下載到本地系統之後， 將會開始套用更新。這個過程可能會花點時間，取決於機器的速度和工作量。設定檔將會被合併。 合併的過程中當檔案被合併或是手動合併畫面上出現編輯器時需要使用者操作。 每一個成功合併的結果將會顯示給使用者並繼續程序，失敗或忽略合併將會使程序中斷。使用者可能想要備份 <filename>/etc</filename> 並稍後手動合併重要的檔案，例如：<filename>master.passwd</filename> 或 <filename>group</filename>。</para>

      <note>
	<para>所有的修補與合併動作會在另一個目錄進行，並不會直接修改。當成功套用所有修補，所有設定檔已合併且過程順利，使用者可使用以下指令將變更安裝到磁碟：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>freebsd-update install</userinput></screen>
      </note>

      <para>核心與核心模組會先修補，若系統正在執行自訂的核心，使用 <citerefentry><refentrytitle>nextboot</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來設定下次開機使用更新過的 <filename>/boot/GENERIC</filename>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>nextboot -k GENERIC</userinput></screen>

      <warning>
	<para>若機器在遠端進行更新，請在使用 <filename>GENERIC</filename> 核心重新開機前，請確定該核心含有所有系統所需的驅動程式以正常開機並連線至網路。特別是在執行的自訂核心有使用到由核心模組提供內建功能，請確定將這些模組已暫時使用 <filename>/boot/loader.conf</filename> 設定檔載入到 <filename>GENERIC</filename> 核心。建議關閉非必須的服務和磁碟與網路掛載直到升級程序完成。</para>
      </warning>

      <para>機器現在應使用更新過的核心重新開機：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>shutdown -r now</userinput></screen>

      <para>一旦系統重新上線，使用以下指令繼續 <command>freebsd-update</command>。 由於程序的狀態已被儲存，<command>freebsd-update</command> 不會重頭開始，但會進行下一個階段並移除所有舊的共用程式庫和目標檔。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>freebsd-update install</userinput></screen>

      <note>
	<para>取決於是否有任何程式庫版本編號衝突，也可能只有兩個而不是三個安裝階段。</para>
      </note>

      <para>升級程序現在完成了。如果所做的是主要的版本升級，則需依 <xref linkend="freebsdupdate-portsrebuild"/> 的說明重新安裝所有的 Port 和套件。</para>

      <sect3 xml:id="freebsd-update-custom-kernel-9x">
	<title>在 FreeBSD 9.X 及之後版本自訂核心</title>

	<para>在使用 <command>freebsd-update</command> 前，請確定已有 <filename>GENERIC</filename> 核心的複本於 <filename>/boot/GENERIC</filename>。若只編譯過一次自訂核心，那麼 <filename>/boot/kernel.old</filename> 就是 <literal>GENERIC</literal> 核心，只需要將該目錄重新命名為 <filename>/boot/kernel</filename>。</para>

	<para>若有編譯自訂核心過超過一次，或已經不曉得編譯自訂核心的次數，則需取得與目前作業系統版本相符的 <literal>GENERIC</literal> 核心複本。若可直接操作實體系統，則可以從安裝媒體取得 <literal>GENERIC</literal> 核心複本：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mount /cdrom</userinput>
<prompt>#</prompt> <userinput>cd /cdrom/usr/freebsd-dist</userinput>
<prompt>#</prompt> <userinput>tar -C/ -xvf kernel.txz boot/kernel/kernel</userinput></screen>

	<para>或者，可以從原始碼重新編譯 <literal>GENERIC</literal> 核心：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make kernel __MAKE_CONF=/dev/null SRCCONF=/dev/null</userinput></screen>

	<para>這個核心要被 <command>freebsd-update</command> 認做 <literal>GENERIC</literal> 核心，<filename>GENERIC</filename> 設定檔必須不能做任何修改，也建議在編譯核心時不要使用其他特殊選項。</para>

	<para><command>freebsd-update</command> 僅需要 <filename>/boot/GENERIC</filename> 存在便可，因此不須重新開機進入 <filename>GENERIC</filename>。</para>
      </sect3>

      <sect3 xml:id="freebsdupdate-portsrebuild">
	<title>主要版號升級後的套件升級</title>

	<para>一般來說，已安裝的應用程式在次要版本升級仍可沒問題的正常執行。但主要版本升級會採用不同的應用程式 Binary 介面 (Application Binary Interfaces, <acronym>ABI</acronym>s)，會導致大部份第三方應用程式無法正常執行。 因此在主要版本升級後，需要升及所有已安裝的套件和 Port，套件可以使用 <command>pkg upgrade</command> 來升級，而 Port 則需使用 <package>ports-mgmt/portmaster</package> 工具。</para>

	<para>強制升級所有已安裝的套件會使用檔案庫中新版本的套件來取得目前套件，即使該版號沒有增加。由於在升級 FreeBSD 主要版本時會變更 ABI 版本，因此這是必要動作。強制升級可以執行以下指令來完成：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pkg-static upgrade -f</userinput></screen>

	<para>重新編譯所有已安裝的應用程式可以執行以下指令來完成：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>portmaster -af</userinput></screen>

	<para>這個指令會在安裝每個應用程式有可設定選項時顯示設定畫面，並會等待使用者操作該畫面，要避免這種情況並使用預設的設定選項，可在上述指令加上 <option>-G</option> 參數。</para>

	<para>完成軟體升級後，最後需執行 <command>freebsd-update</command> 來完成最後的升級動作：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>freebsd-update install</userinput></screen>

	<para>若有使用臨時 <filename>GENERIC</filename> 核心，便應在此時依據 <xref linkend="kernelconfig"/> 的說明編譯並安裝新的自訂核心。</para>

	<para>重新開機使用新的 FreeBSD 版本後，升級程序便正式完成。</para>
      </sect3>
    </sect2>

    <sect2 xml:id="freebsdupdate-system-comparison">
      <title>比對系統狀態</title>

      <para>已安裝的 FreeBSD 版本狀態可以使用 <command>freebsd-update IDS</command> 與另一個已知良好的複本來做比對測試。 這個指令會評估目前版本的系統工具，程式庫和設定檔，可做為內建的入侵偵測系統來使用 (Intrusion Detection System, <acronym>IDS</acronym>)。</para>

      <warning>
	<para>這個指令並非用來取代真正的 <acronym>IDS</acronym>，如 <package>security/snort</package>。由於 <command>freebsd-update</command> 儲存在磁碟上，被竄改的可能性是顯而易見的，雖然這個可能性會因使用 <varname>kern.securelevel</varname> 以及將 <command>freebsd-update</command> 在不使用時以唯讀儲存而降低，最好的解決方案是能夠與安全的磁碟，如 <acronym>DVD</acronym> 或儲存在外部的 <acronym>USB</acronym> 磁碟裝置比對系統。替代的方式是使用內建工具的 <acronym>IDS</acronym> 功能，在 <xref linkend="security-ids"/> 有詳細說明</para>
      </warning>

      <para>要開始比對，需指定輸出的檔案來儲存結果：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>freebsd-update IDS &gt;&gt; outfile.ids</userinput></screen>

      <para>系統將會開始檢查並且會產生相當長的檔案清單，內容包含發佈版本已知的與目前安裝版本的 <acronym>SHA256</acronym> 雜湊值會儲存到指定的輸出檔。</para>

      <para>清單中的項目會相當的多，但輸出的格式可以很簡單的用來分析。例如，要取得與發佈版本不同的檔案清單，可使用以下指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cat outfile.ids | awk '{ print $1 }' | more</userinput>
/etc/master.passwd
/etc/motd
/etc/passwd
/etc/pf.conf</screen>

      <para>實際的檔案會更多，此範例的輸出已精簡。部份檔案可能本來就會被修改。例如 <filename>/etc/passwd</filename> 在新增使用者到系統時會被修改，核心模組也有可能因使用 <command>freebsd-update</command> 更新而有所不同。要排除特定的檔案或目錄可將這些檔案或目錄加入到 <filename>/etc/freebsd-update.conf</filename> 中的 <literal>IDSIgnorePaths</literal> 選項。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="updating-upgrading-documentation">
    <title>更新文件集</title>

    <indexterm xml:lang="en"><primary>Updating and Upgrading</primary></indexterm>

    <indexterm xml:lang="en">
      <primary>Documentation</primary>
      <see>Updating and Upgrading</see>
    </indexterm>

    <para>說明文件是 FreeBSD 作業系統不可或缺的一部份。最新版本的 FreeBSD 文件除了可在 FreeBSD 網站 (<link xlink:href="@@URL_RELPREFIX@@/doc/">https://www.freebsd.org/doc/</link>) 取得，也可很簡單的取得本地的 FreeBSD 網站、使用手冊、<acronym>FAQ</acronym> 及文章副本。</para>

    <para>本節將說明如何使用原始碼與 FreeBSD Port 套件集來取得最新版本 FreeBSD 文件本地複本。</para>

    <para>有關編輯與提出修正說明文件的資訊，請參考 FreeBSD 文件計畫入門書 (<link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/books/fdp-primer">https://www.freebsd.org/doc/en_US.ISO8859-1/books/fdp-primer/</link>)。</para>

    <sect2 xml:id="updating-installed-documentation">
      <title>自原始碼更新說明文件</title>

      <para>從原始碼重新編譯 FreeBSD 文件需要一些不屬於 FreeBSD 基礎系統的工具。需要的工具可安裝由 FreeBSD 文件計劃所開發的 <package>textproc/docproj</package> 套件或 Port。</para>

      <para>安裝完成之後，可使用 <application>svnlite</application> 來取得乾淨的文件原始碼複本：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>svnlite checkout https://svn.FreeBSD.org/doc/head /usr/doc</userinput></screen>

      <para>第一次下載文件原始碼需要一些時間，請耐心等候執行完畢。</para>

      <para>往後更新文件原始碼可執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>svnlite update /usr/doc</userinput></screen>

      <para>下載最新的文件原始碼到 <filename>/usr/doc</filename> 之後，便完成要更新已安裝文件的準備動作。</para>

      <para>完整更新所有可用的語言可以執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/doc</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>若只想要更新特定語言，可對 <filename>/usr/doc</filename> 中特定語言的子目錄執行 <command>make</command>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/doc/en_US.ISO8859-1</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>另一個更新文件的方式是在 <filename>/usr/doc</filename> 或特定的語言子目錄下執行此指令：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>make update</userinput></screen>

      <para>要指定安裝的輸出格式可使用 <varname>FORMATS</varname> 來設定：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/doc</userinput>
<prompt>#</prompt> <userinput>make FORMATS='html html-split' install clean</userinput></screen>

      <para>有數個選項可更新部份文件或只編譯特定翻譯來簡化更新程序。這些選項可在 <filename>/etc/make.conf</filename> 設為系統全域的預設選項，或是透過指令傳送給 <command>make</command>。</para>

      <para>選項有：</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en"><varname>DOC_LANG</varname></term>

	  <listitem>
	    <para>要編譯與安裝的語言及編碼清單，例如 <literal>en_US.ISO8859-1</literal> 代表英語文件。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><varname>FORMATS</varname></term>

	  <listitem>
	    <para>要編譯的輸出格式清單，目前支援 <literal>html</literal>, <literal>html-split</literal>, <literal>txt</literal>, <literal>ps</literal> 以及 <literal>pdf</literal>。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><varname>DOCDIR</varname></term>

	  <listitem>
	    <para>要安裝文件的位置，預設為 <filename>/usr/share/doc</filename>。</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para>要取得更多可做為 FreeBSD 系統全域選項的 <command>make</command> 變數，請參考 <citerefentry><refentrytitle>make.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>。</para>
    </sect2>

    <sect2 xml:id="doc-ports-install-package">
      <info>
	<title>自 Port 更新說明文件</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Marc</firstname>
	      <surname>Fonvieille</surname>
	    </personname>
	    <contrib>Based on the work of </contrib>
	  </author>
	</authorgroup>
      </info>

      <indexterm xml:lang="en">
	<primary>Updating and Upgrading</primary>
      </indexterm>

      <indexterm xml:lang="en">
	<primary>documentation package</primary>
	<see>Updating and Upgrading</see>
      </indexterm>

      <para>前一節介紹了由原始碼更新 FreeBSD 文件的方法，本節將說明使用 Port 套件集的替代方法，可由以下方式達成：</para>

      <itemizedlist>
	<listitem>
	  <para>安裝事先編譯好的文件套件，無須在本地編譯任何東西或安裝文件工具集。</para>
	</listitem>

	<listitem>
	  <para>使用 Port 框架來編譯文件原始碼，可讓取得與編譯文件的步驟更簡單。</para>
	</listitem>
      </itemizedlist>

      <para>這個更新 FreeBSD 文件的方法，會使用到一系列由文件工程團隊 <email>doceng@FreeBSD.org</email> 每月更新的文件 Port 與套件。這些套件列於 FreeBSD Port 套件集的 docs 分類下 (<link xlink:href="http://www.freshports.org/docs/">http://www.freshports.org/docs/</link>)。</para>

      <para>文件 Port 的組織方式如下：</para>

      <itemizedlist>
	<listitem>
	  <para><package>misc/freebsd-doc-en</package> 套件或 Port 會安裝所有英語的文件。</para>
	</listitem>

	<listitem>
	  <para><package>misc/freebsd-doc-all</package> 套件或 Port 會安裝所有可用語言的文件。</para>
	</listitem>

	<listitem>
	  <para>每個翻譯語言都有套件與 Port，如 <package>misc/freebsd-doc-hu</package> 為匈牙利語文件。</para>
	</listitem>
      </itemizedlist>

      <para>當使用 Binary 套件時，會安裝指定語言 FreeBSD 文件的所有可用格式。例如以下指令會安裝最新的匈牙利語文件套件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install hu-freebsd-doc</userinput></screen>

      <note>
	<para>套件使用的名稱格式與 Port 的名稱不同：<literal><replaceable>lang</replaceable>-freebsd-doc</literal>，其中 <replaceable>lang</replaceable> 是語言代碼的縮寫，例如 <literal>hu</literal> 代表匈牙利語，<literal>zh_cn</literal> 代表簡體中文。</para>
      </note>

      <para>要指定文件的格式，需以編譯 Port 來代替安裝套件。例如要編譯並安裝英語文件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/misc/freebsd-doc-en</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>Port 提供設定選單來指定要編譯與安裝的格式，預設會選擇分頁的 <acronym>HTML</acronym> (類似 <uri xlink:href="http://www.FreeBSD.org">http://www.FreeBSD.org</uri> 使用的格式) 以及 <acronym>PDF</acronym>。</para>

      <para>此外，編譯文件 Port 時也可指定數個 <command>make</command> 選項，包括：</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en"><varname>WITH_HTML</varname></term>

	  <listitem>
	    <para>編譯一份文件使用一個 HTML 檔的 HTML 格式。格式化後的文件會儲存至名稱為 <filename>article.html</filename> 或 <filename>book.html</filename> 的檔案。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><varname>WITH_PDF</varname></term>

	  <listitem>
	    <para>格式化的文件會儲存至名稱為 <filename>article.pdf</filename> 或 <filename>book.pdf</filename> 的檔案。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><varname>DOCBASE</varname></term>

	  <listitem>
	    <para>指定要安裝文件的位置，預設為 <filename>/usr/local/share/doc/freebsd</filename>。</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para>以下範例使用變數來安裝 <acronym>PDF</acronym> 的匈牙利語文件到特定目錄：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/misc/freebsd-doc-hu</userinput>
<prompt>#</prompt> <userinput>make -DWITH_PDF DOCBASE=share/doc/freebsd/hu install clean</userinput></screen>

      <para>文件套件或 Port 可以依 <xref linkend="ports"/> 的說明更新。例如以下指令會使用 <package>ports-mgmt/portmaster</package> 更新已安裝的匈牙利語文件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>portmaster -PP hu-freebsd-doc</userinput></screen>
    </sect2>
  </sect1>

  <sect1 xml:id="current-stable">
    <title>追蹤開發分支</title>

    <indexterm xml:lang="en"><primary>-CURRENT</primary></indexterm>
    <indexterm xml:lang="en"><primary>-STABLE</primary></indexterm>

    <para>FreeBSD 有兩個開發分支：FreeBSD-CURRENT 及 FreeBSD-STABLE。</para>

    <para>本節將說明每個分支及其的特定使用者，也會說明如何在各別分支維持系統為最新版。</para>

    <sect2 xml:id="current">
      <title>使用 FreeBSD-CURRENT</title>

      <para>FreeBSD-CURRENT 是 FreeBSD 開發的 <quote>最前線</quote>，FreeBSD-CURRENT 的使用者需具備較強的技術能力。技術能力較弱的使用者應改追蹤 FreeBSD-STABLE 開發分支。</para>

      <para>FreeBSD-CURRENT 是 FreeBSD 最新的原始碼，其中包括正在進行的開發工作、實驗性的變更以及不一定會在下一個官方發行版出現的過渡機制。 雖然 FreeBSD 開發者每天編譯 FreeBSD-CURRENT 原始碼，但仍可能有短暫時間原始碼是無法編譯的。雖然這些問題會儘快被解決，但是無論 FreeBSD-CURRENT 帶來災難或是新功能，同步原始碼時都要考量這個問題。</para>

      <para>FreeBSD-CURRENT 主要給下以三種族群：</para>

      <orderedlist>
	<listitem>
	  <para>致力於開發某一部份原始碼樹的 FreeBSD 社群成員。</para>
	</listitem>

	<listitem>
	  <para>FreeBSD 社群成員中活耀的測試人員。 他們願意花時間解決問題，對 FreeBSD 的變更及大方向提出專業建議並送交修補。</para>
	</listitem>

	<listitem>
	  <para>隨時關注的使用者，使用目前原始碼做為參考用途，或是偶爾提供意見或貢獻原始碼。</para>
	</listitem>
      </orderedlist>

      <para><emphasis>不應</emphasis>將 FreeBSD-CURRENT 當做下一個發行版前取得新功能的快速途徑，因為尚未發行的功能並未被完整測試，很可能有問題。這也不是一個快速取得問題修正的方式，因為任何已知的問題修正有可能產生新的問題。 使用 FreeBSD-CURRENT 不在 <quote>官方支援</quote> 的範圍內。</para>

      <indexterm><primary>-CURRENT</primary> <secondary>使用</secondary></indexterm>

      <para>若要追蹤 FreeBSD-CURRENT：</para>

      <orderedlist>
	<listitem>
	  <para>加入 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-current">freebsd-current</link> 和 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-head">svn-src-head</link> 郵遞論壇。這是 <emphasis>重要</emphasis> 的，是為了要了解目前人們對於系統目前狀態的評論並接收有關 FreeBSD-CURRENT 目前狀態的重要公告。</para>

	  <para><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-head">svn-src-head</link> 郵遞論壇會記錄每一次修改的提交項目，以及可能產生的副作用的相關資訊。</para>

	  <para>要加入這兩個郵遞論壇，請前往 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo">http://lists.FreeBSD.org/mailman/listinfo</link> 點選要訂閱的郵遞論壇，並依照網頁指示的步驟操作。要追蹤整個原始碼樹，不單只有 FreeBSD-CURRENT 的變更，可訂閱 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-all">svn-src-all</link> 郵遞論壇。</para>
	</listitem>

	<listitem>
	  <para>同步 FreeBSD-CURRENT 原始碼。 通常會使用 <link linkend="svn">svnlite</link> 自列於 <xref linkend="svn-mirrors"/> 中的其中一個 Subversion 鏡像站的 <literal>head</literal> 分支中取出 -CURRENT 的程式碼。</para>
	</listitem>

	<listitem>
	  <para>考量到檔案庫的大小，部份使用者選擇只同步他們有興趣或貢獻修補的部份原始碼。然而， 計劃要從原始碼編譯整個作業系統的使用者須下載 <emphasis>全部</emphasis> 的 FreeBSD-CURRENT，不可只有選擇的部份。</para>

	  <para>編譯 FreeBSD-CURRENT <indexterm>
	      <primary>-CURRENT</primary>
		<secondary>compiling</secondary>
	    </indexterm> 前，請仔細地閱讀 <filename>/usr/src/Makefile</filename> 並依照 <xref linkend="makeworld"/> 的指示操作。 閱讀 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-current">FreeBSD-CURRENT 郵遞論壇</link> 以及 <filename>/usr/src/UPDATING</filename> 來了解升級的相關資訊，有時會含有升級下一個發行版的必要資訊。</para>
	</listitem>

	<listitem>
	  <para>要活躍！我們非常鼓勵 FreeBSD-CURRENT 的使用者發表他們對加強哪些功能或是修復哪些錯誤的建議。 如果您在建議時能附上相關程式碼的話，是最好的。</para>
	</listitem>
      </orderedlist>
    </sect2>

    <sect2 xml:id="stable">
      <title>使用 FreeBSD-STABLE</title>

      <para>FreeBSD-STABLE 是一個開發分支，會在主要的版本更新後產生，進入這個分支的步伐會比較緩慢，而且通常會假定已經在 FreeBSD-CURRENT 中做過測試，所以問題會比較少，但這<emphasis>仍然</emphasis>是一個開發分支，在任何時間點，FreeBSD-STABLE 中的原始碼不能保証能供一般使用，它只是另一個開發支線，並不是供最終使用者使用的資源，若沒有任何資源可以做測試的使用者應改使用最新版本的 FreeBSD 發佈版。</para>

      <para>對於那些有興趣追蹤或為 FreeBSD 開發流程提供一些貢獻的人，特別是針對下一個主要發佈版的 FreeBSD，應該考慮追蹤 FreeBSD-STABLE。</para>

      <para>雖然 FreeBSD-STABLE 分支應該已經做過編譯並執行過，但這仍然無法保証不會出任何問題。由於使用 FreeBSD-STABLE 的人比 FreeBSD-CURRENT 更多，因此不可避免的，有時仍會在 FreeBSD-STABLE 中發現未在 FreeBSD-CURRENT 中出現的問題與特殊狀況。基於這個原因，任何人都不應盲目的追蹤 FreeBSD-STABLE，特別重要的是 <emphasis>不</emphasis> 要將任何產線上的伺服器更新成未經開發或測試環境中測試過的 FreeBSD-STABLE。</para>

      <para>若要追蹤 FreeBSD-STABLE：</para>

      <indexterm><primary>-STABLE</primary> <secondary>使用</secondary></indexterm>
      <orderedlist>
	<listitem>
	  <para>加入 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-stable">freebsd-stable</link> 郵遞論壇來隨時了解 FreeBSD-STABLE 可能需要的編譯相依項目或任何需要特別注意的問題，當有一些有爭議的修復或更新時，開發人員也會在郵遞論壇中公告，如果有使用者對所提出的更改有任何的疑慮，可讓使用者有機會能反應問題。</para>

	  <para>加入要追蹤的分支所相關的 <application>svn</application> 郵遞論壇，例如，在追蹤 9-STABLE 分支的使用者會加入 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-stable-9">svn-src-stable-9</link> 郵遞論壇，該郵遞論壇會記錄每次變更的提交記錄，以及有關可能出現的副作用的任何相關訊息。</para>

	  <para>要加入這些郵遞論壇，請前往 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo">http://lists.FreeBSD.org/mailman/listinfo</link> 點選要訂閱的郵遞論壇，並依照網頁指示的步驟操作。要追蹤整個原始碼樹的變更，可訂閱 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-all">svn-src-all</link> 郵遞論壇。</para>
	</listitem>

	<listitem>
	  <para>要安裝新的 FreeBSD-STABLE 系統，可安裝在 <link linkend="mirrors">FreeBSD 鏡像站</link> 中最近的 FreeBSD-STABLE 發佈版或使用每月使用 FreeBSD-STABLE 所編譯的快照 (Snapshot)，請參考 <link xlink:href="@@URL_RELPREFIX@@/snapshots/">www.freebsd.org/snapshots</link> 取得更多有關快照的資訊。</para>

	  <para>要編譯或升級已有的 FreeBSD 系統到 FreeBSD-STABLE 可使用 <link linkend="svn">svn</link> <indexterm>
		<primary>Subversion</primary>
	      </indexterm> 來取出欲升級的分支程式碼，可用分支的名稱如：<literal>stable/9</literal> 會列在 <link xlink:href="@@URL_RELPREFIX@@/releng/">www.freebsd.org/releng</link>。</para>
	</listitem>

	<listitem>
	  <para>編譯 FreeBSD-STABLE <indexterm>
	      <primary>-STABLE</primary>
		<secondary>compiling</secondary>
	    </indexterm> 前，請仔細地閱讀 <filename>/usr/src/Makefile</filename> 並依照 <xref linkend="makeworld"/> 的指示操作。 閱讀 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-stable">FreeBSD-STABLE 郵遞論壇</link> 以及 <filename>/usr/src/UPDATING</filename> 來了解升級的相關資訊，有時會含有升級下一個發行版的必要資訊。</para>
	</listitem>
      </orderedlist>
    </sect2>
  </sect1>

  <sect1 xml:id="makeworld">
    <title xml:id="updating-src">從原始碼更新 FreeBSD</title>

    <para>從編譯原始碼來更新 FreeBSD 比起用 Binary 更新有幾項優點，在編譯程式碼時可以自訂選項來充分運用特定硬體，部份基礎系統可以使用非預設的設定值編譯，或是在不需要或不想要的時候跳過編譯。使用編譯的程序來更新系統比起安裝 Binary 來更新會耗時許多，但能夠完整自訂一個量身定做版本的 FreeBSD。</para>

    <sect2 xml:id="updating-src-quick-start">
      <title>快速開始</title>

      <para>這是從原始碼編譯來更新 FreeBSD 的標準步驟快速的參考，稍後的章節會更詳細的說明這個程序。</para>

      <procedure>
	<step>
	  <title>更新並編譯</title>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>svnlite update /usr/src</userinput>  <co xml:id="updating-src-qs-svnup"/>
<emphasis>check <filename>/usr/src/UPDATING</filename></emphasis>  <co xml:id="updating-src-qs-review-updating"/>
<prompt>#</prompt> <userinput>cd /usr/src</userinput>          <co xml:id="updating-src-qs-cd"/>
<prompt>#</prompt> <userinput>make -j<replaceable>4</replaceable> buildworld</userinput>  <co xml:id="updating-src-qs-buildworld"/>
<prompt>#</prompt> <userinput>make -j<replaceable>4</replaceable> kernel</userinput>      <co xml:id="updating-src-qs-kernel"/>
<prompt>#</prompt> <userinput>shutdown -r now</userinput>      <co xml:id="updating-src-qs-reboot"/>
<prompt>#</prompt> <userinput>cd /usr/src</userinput>          <co xml:id="updating-src-qs-cd2"/>
<prompt>#</prompt> <userinput>make installworld</userinput>    <co xml:id="updating-src-qs-installworld"/>
<prompt>#</prompt> <userinput>mergemaster -Ui</userinput>      <co xml:id="updating-src-qs-mergemaster"/>
<prompt>#</prompt> <userinput>shutdown -r now</userinput>      <co xml:id="updating-src-qs-shutdown"/></screen>

	  <calloutlist>
	    <callout arearefs="updating-src-qs-svnup">
	      <para>取得最新版本的原始碼，請參考 <xref linkend="updating-src-obtaining-src"/> 來了解更多取得與更新原始碼的資訊。</para>
	    </callout>

	    <callout arearefs="updating-src-qs-review-updating">
	      <para>檢查 <filename>/usr/src/UPDATING</filename> 看是否有任後在原始碼編譯之前或之後需要手動操作的步驟。</para>
	    </callout>

	    <callout arearefs="updating-src-qs-cd">
	      <para>前往原始碼目錄。</para>
	    </callout>

	    <callout arearefs="updating-src-qs-buildworld">
	      <para>編譯世界 (World)，即除了核心 (Kernel) 外的所有東西。</para>
	    </callout>

	    <callout arearefs="updating-src-qs-kernel">
	      <para>編譯並安裝核心，此動作等同於 <command>make buildkernel installkernel</command>。</para>
	    </callout>

	    <callout arearefs="updating-src-qs-reboot">
	      <para>重新啟動系統以使用新的核心。</para>
	    </callout>

	    <callout arearefs="updating-src-qs-cd2">
	      <para>前往原始碼目錄。</para>
	    </callout>

	    <callout arearefs="updating-src-qs-installworld">
	      <para>安裝世界。</para>
	    </callout>

	    <callout arearefs="updating-src-qs-mergemaster">
	      <para>更新與合併在 <filename>/etc/</filename> 中的設定檔案。</para>
	    </callout>

	    <callout arearefs="updating-src-qs-shutdown">
	      <para>重新啟動系統以使用新編譯好的世界與核心。</para>
	    </callout>
	  </calloutlist>
	</step>
      </procedure>
    </sect2>

    <sect2 xml:id="updating-src-preparing">
      <title>準備原始碼更新</title>

      <para>閱讀 <filename>/usr/src/UPDATING</filename>，從原始碼編譯之前與之後任何需要手動操作步驟會在此檔案中說明。</para>
    </sect2>

    <sect2 xml:id="updating-src-obtaining-src">
      <title>更新原始碼</title>

      <para>FreeBSD 的原始碼位於 <filename>/usr/src/</filename>，較建議透過 <application>Subversion</application> 版本控制系統來更新這份原始碼，要確認原始碼已在版本控制系統的管控下可：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>svnlite info /usr/src</userinput>
Path: /usr/src
Working Copy Root Path: /usr/src
...</screen>

      <para>此結果代表 <filename>/usr/src/</filename> 已在版本控制系統的管控下並且可以使用 <citerefentry><refentrytitle>svnlite</refentrytitle><manvolnum>1</manvolnum></citerefentry> 來更新：</para>

      <screen xml:id="synching" xml:lang="en"><prompt>#</prompt> <userinput>svnlite update /usr/src</userinput></screen>

      <para>若該目錄最近沒有更新過，可能會需要一些時間來完成更新動作。在更新完成之後，原始碼便為最新版本，並可開始依下一章節的說明來編譯程序。</para>

      <note xml:id="updating-src-obtaining-src-checkout">
	<title>取得原始碼</title>

	<para>若輸出結果顯示 <literal>'/usr/src' is not a working copy</literal> 代表有缺少檔案或原始碼是採用其他方式安裝，若是如此，便需重新取出 (checkout) 原始碼。</para>

	<table xml:id="updating-src-obtaining-src-repopath">
	  <title>FreeBSD 版本與檔案庫路徑</title>

	  <tgroup cols="3">
	    <thead>
	      <row>
		<entry><command>uname -r</command> 的輸出結果</entry>
		<entry>檔案庫路徑</entry>
		<entry>說明</entry>
	      </row>
	    </thead>

	    <tbody>
	      <row>
		<entry xml:lang="en"><literal><replaceable>X.Y</replaceable>-RELEASE</literal></entry>
		<entry><literal>base/releng/</literal><replaceable>X.Y</replaceable></entry>
		<entry>發佈版本加上關鍵的安全性與錯誤修正，較建議大多數使用者使用這個分支。</entry>
	      </row>

	      <row xml:id="STABLE">
		<entry xml:lang="en"><literal><replaceable>X.Y</replaceable>-STABLE</literal></entry>
		<entry xml:lang="en"><literal>base/stable/</literal><replaceable>X</replaceable></entry>
		<entry>
		  <para>發佈版本加上所有在該分支上其他開發中的程式，<emphasis>STABLE</emphasis> 代表不會更改應用程式 Binary 介面 (Applications Binary Interface, <acronym>ABI</acronym>)，所以在先前版本所編譯的軟體仍可以正常運作，舉例來說，被編譯在 FreeBSD 10.1 可執行的軟體在編譯完 FreeBSD 10-STABLE 之後仍可以執行。</para>

		  <para>STABLE 分支偶爾也會有錯誤或無法相容的問題會影響使用者，雖然這些問題通常會很快的被修正。</para>
		</entry>
	      </row>

	      <row>
		<entry xml:lang="en"><literal><replaceable>X</replaceable>-CURRENT</literal></entry>
		<entry xml:lang="en"><literal>base/head/</literal></entry>
		<entry>最新未發佈的 FreeBSD 開發版本，CURRENT 分支可能會有重大錯誤或不相容的問題，只建議進階的使用者使用。</entry>
	      </row>
	    </tbody>
	  </tgroup>
	</table>

	<para>查看 FreeBSD 目前使用的版本可使用 <citerefentry><refentrytitle>uname</refentrytitle><manvolnum>1</manvolnum></citerefentry>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>uname -r</userinput>
10.3-RELEASE</screen>

	<para>根據 <xref linkend="updating-src-obtaining-src-repopath"/>，要更新 <literal>10.3-RELEASE</literal> 需使用的原始碼檔案庫路徑為 <literal>base/releng/10.3</literal>，在取出 (checkout) 原始碼時便要使用這個路徑：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mv /usr/src /usr/src.bak</userinput>  <co xml:id="updating-src-obtaining-src-mv"/>
<prompt>#</prompt> <userinput>svnlite checkout https://svn.freebsd.org/base/<replaceable>releng/10.3</replaceable> /usr/src</userinput>  <co xml:id="updating-src-obtaining-src-checkout-cmd"/></screen>

	<calloutlist>
	  <callout arearefs="updating-src-obtaining-src-mv">
	    <para>將舊的目錄移到其他地方，若沒有在這個目錄做過任何本地修改，可直接刪除這個目錄。</para>
	  </callout>

	  <callout arearefs="updating-src-obtaining-src-checkout-cmd">
	    <para>將從 <xref linkend="updating-src-obtaining-src-repopath"/> 查到的路徑加到檔案庫 <acronym>URL</acronym> 之後。第三個參數用來存放本地系統原始碼的目標目錄。</para>
	  </callout>
	</calloutlist>
      </note>
    </sect2>

    <sect2 xml:id="updating-src-building">
      <title>從原始碼編譯</title>

      <para>編譯世界 (<emphasis>world</emphasis>) 即編譯整個作業系統除了核心 (Kernel)，要先做這個動作以便提供最新的工具來編譯核心，接著便可編譯核心：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make buildworld</userinput>
<prompt>#</prompt> <userinput>make buildkernel</userinput></screen>

      <para>編譯完的程式會寫入至 <filename>/usr/obj</filename>。</para>

      <para>以上這些均為基本的步驟，用來控制編譯的其他選項在以下章節會說明。</para>

      <sect3 xml:id="updating-src-building-clean-build">
	<title>執行清除編譯</title>

	<para>部份 FreeBSD 編譯系統版本會保留先前編譯的程式於暫存的物件目錄 <filename>/usr/obj</filename>，避免重新編譯那些尚未更動過的程式碼可加速後續的編譯動作，若要強制重新編譯所有東西可在開始編譯前使用 <buildtarget>cleanworld</buildtarget>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make cleanworld</userinput></screen>
      </sect3>

      <sect3 xml:id="updating-src-building-jobs">
	<title>設定工作數量</title>

	<para>在多核處理器上增加編譯工作的數量可增加編譯速度，可使用 <command>sysctl hw.ncpu</command> 來查看有多少核心，不同處理器使用不同版本的 FreeBSD 編譯系統，所以唯一能了解不同工作數量對編譯速度影響的方式便是測試。在一開始可考慮選擇一個介於 1/2 到 2 倍核心數之間的數值，工作的數量可使用 <option>-j</option> 來指定。</para>

	<example xml:id="updating-src-building-jobs-example">
	  <title>增加編譯工作數</title>

	  <para>使用四個工作來編譯世界與核心：</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>make -j4 buildworld buildkernel</userinput></screen>
	</example>
      </sect3>

      <sect3 xml:id="updating-src-building-only-kernel">
	<title>只編譯核心</title>

	<para>若原始碼有更動，便須執行 <buildtarget>buildworld</buildtarget>，完成之後，便可隨時執行 <buildtarget>buildkernel</buildtarget> 來編譯核心，若要只編譯核心可：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make buildkernel</userinput></screen>
      </sect3>

      <sect3 xml:id="updating-src-building-custom-kernel">
	<title>編譯自訂核心</title>

	<para>標準的 FreeBSD 核心是以一個名為 <filename>GENERIC</filename> 的<emphasis>核心設定檔 (Kernel config file)</emphasis>為基礎，<filename>GENERIC</filename> 核心中內含了所有最常用的裝置驅動程式與選項，有時這個檔案對編譯自訂核心也非常有用，可根據其來加入或移除裝置驅動程式或選項來滿足特定需求。</para>

	<para>例如，要開發一個 <acronym>RAM</acronym> 受到嚴重限制的小型嵌入式電腦，便可移除不需要的裝置驅動程式或選項來縮小核心。</para>

	<para>核心設定檔位於 <filename>/usr/src/sys/<replaceable>arch</replaceable>/conf/</filename>，其中使用的 <replaceable>arch</replaceable> 即為 <command>uname -m</command> 輸出的結果，大部份的電腦為 <literal>amd64</literal>，那其設定檔目錄則為 <filename>/usr/src/sys/<replaceable>amd64</replaceable>/conf/</filename>。</para>

	<tip>
	  <para><filename>/usr/src</filename> 可以被刪除或重建，所以較建議將自訂核心設定檔放在另一個目錄，如 <filename>/root</filename>，並將核心設定檔以連結放至 <filename>conf</filename> 目錄，若該目錄被刪除或覆寫，便可重新建立一個新的核心設定的連結。</para>
	</tip>

	<para>自訂設定檔可由複製 <filename>GENERIC</filename> 設定檔來建立，在此範例，新的自訂核心要用在儲存伺服器，所以將其命名為 <filename>STORAGESERVER</filename>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cp /usr/src/sys/amd64/conf/GENERIC /root/STORAGESERVER</userinput>
<prompt>#</prompt> <userinput>cd /usr/src/sys/amd64/conf</userinput>
<prompt>#</prompt> <userinput>ln -s /root/STORAGESERVER .</userinput></screen>

	<para>接著編譯 <filename>/root/STORAGESERVER</filename>，要加入或移除裝置或選項可見 <citerefentry><refentrytitle>config</refentrytitle><manvolnum>5</manvolnum></citerefentry>。</para>

	<para>自訂核心要在指令列設定 <varname>KERNCONF</varname> 為核心設定檔來編譯：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make buildkernel KERNCONF=STORAGESERVER</userinput></screen>
      </sect3>
    </sect2>

    <sect2 xml:id="updating-src-installing">
      <title>安裝編譯好的程式</title>

      <para>在完成 <buildtarget>buildworld</buildtarget> 與 <buildtarget>buildkernel</buildtarget> 兩個步驟之後，便可安裝新的核心與世界：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make installkernel</userinput>
<prompt>#</prompt> <userinput>shutdown -r now</userinput>
<prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make installworld</userinput>
<prompt>#</prompt> <userinput>shutdown -r now</userinput></screen>

      <para>若使用自訂核心，則同樣須設定 <varname>KERNCONF</varname> 來使用新的自訂核心：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make installkernel KERNCONF=STORAGESERVER</userinput>
<prompt>#</prompt> <userinput>shutdown -r now</userinput>
<prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make installworld</userinput>
<prompt>#</prompt> <userinput>shutdown -r now</userinput></screen>
    </sect2>

    <sect2 xml:id="updating-src-completing">
      <title>完成更新</title>

      <para>還有最後一些的工作要做來完成更新，任何修改過的設定檔要與新版本的設定檔合併、移除找到的過時程式庫，然後重新啟動系統。</para>

      <sect3 xml:id="updating-src-completing-merge-mergemaster">
	<title>使用 <citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry> 合併設定檔案</title>

	<para><citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry> 可簡單的將修改過的系統設定檔與新版設定檔合併。</para>

	<para>使用 <option>-Ui</option>，<citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry> 會自動更新那些未被使用者修改過的設定檔並安裝尚不存在的檔案：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>mergemaster -Ui</userinput></screen>

	<para>若檔案需要手動合併，會有互動式介面可讓使用者選擇要保留那一邊的檔案，請參考 <citerefentry><refentrytitle>mergemaster</refentrytitle><manvolnum>8</manvolnum></citerefentry> 取得更多資訊。</para>
      </sect3>

      <sect3 xml:id="updating-src-completing-check-old">
	<title>檢查過時的檔案與程式庫</title>

	<para>部份廢棄的檔案或目錄可以在更新之後保留，可使用以下指令找出這些檔案：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make check-old</userinput></screen>

	<para>並用以下指令刪除：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make delete-old</userinput></screen>

	<para>部份廢棄的程式庫也可以保留下來，可使用以下指令來偵測這些程式庫：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make check-old-libs</userinput></screen>

	<para>並使用以下指令刪除</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>make delete-old-libs</userinput></screen>

	<para>那些仍使用舊程式庫的程式將在刪除程式庫之後無法正常運作，而這些程式須要在刪除舊程式庫之後重新編譯或更換。</para>

	<tip>
	  <para>當確認所有舊檔案或目錄可安全的刪除時，要避免刪除每一個檔案時均需按下 <keycap>y</keycap> 與 <keycap>Enter</keycap> 鍵可在指令設定 <varname>BATCH_DELETE_OLD_FILES</varname>，例如：</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>make BATCH_DELETE_OLD_FILES=yes delete-old-libs</userinput></screen>
	</tip>
      </sect3>

      <sect3 xml:id="updating-src-completing-restart">
	<title>更新後重新啟動</title>

	<para>更新之後的最後一個步驟便是重新啟動電腦，來讓所有的變更生效：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>shutdown -r now</userinput></screen>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="small-lan">
    <info>
      <title>多部機器追蹤</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Mike</firstname>
	    <surname>Meyer</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>NFS</primary>
      <secondary>installing multiple machines</secondary>
    </indexterm>

    <para>當有多部主機需要追蹤相同的原始碼樹，要在每一部主機的系統下載原始碼與重新編譯所有的東西會耗費不少磁碟空間、網路頻寬與 <acronym>CPU</acronym> 運算，要解決這個問題的方法是先在一部主機上做完大部份的工作，而其餘的主機透過 <acronym>NFS</acronym> 掛載使用編譯完的成果。本節會介紹如何做這件事。要取得更多有關使用 <acronym>NFS</acronym> 的資訊請參考 <xref linkend="network-nfs"/>。</para>

    <para>首先，要先確認要執行同一組 Binary 的一群主機，這群主機又稱作 <firstterm>建置集 (Build set)</firstterm>，其中每部主機可以有自己的自訂核心，但會執行相同的 Userland binary。建置集中需挑選一部做為<firstterm>建置主機 (Build machine)</firstterm>，這部主機將會拿來編譯 World 與核心 (Kernel)，理想情況下，要挑選一部速度較快、有足夠的 <acronym>CPU</acronym> 能夠執行 <command>make buildworld</command> 與 <command>make buildkernel</command> 的主機。</para>

    <para>再挑選一部主機做為<firstterm>測試主機 (Test machine)</firstterm>，這部主機,要在將系統更新上正式運作的環境前做測試，這<emphasis>必須</emphasis>一部能夠承受服務停止一段時間的主機，它也可是同時是建置主機，但不是一定要。</para>

    <para>所有在此建置集中的主機需要透過 <acronym>NFS</acronym> 掛載在建置主機上的 <filename>/usr/obj</filename> 與 <filename>/usr/src</filename>。在有多個建置集時，<filename>/usr/src</filename> 也應放在其中一部建置主機，然後由其他主機使用 <acronym>NFS</acronym> 掛載。</para>

    <para>確保在建置集中的所有主機的 <filename>/etc/make.conf</filename> 及 <filename>/etc/src.conf</filename> 與建置主機一致，這是由於建置主機必須編譯整個基礎系統 (Base system) 給所有建置集中的主機安裝。此外，每一部建置主機應在 <filename>/etc/make.conf</filename> 使用 <varname>KERNCONF</varname> 設定其核心名稱，且建置主機應列出所有要編譯的核心名稱在 <varname>KERNCONF</varname>，並且把自己要用的核心放在第一個。建置主機也必須有每部主機的核心設定檔在其 <filename>/usr/src/sys/<replaceable>arch</replaceable>/conf</filename>。</para>

    <para>在建置主機上，編譯核心與 World 如 <xref linkend="makeworld"/> 所述，但不要在建置主機上安裝所有編譯好的東西，而是要將編譯好的核心安裝到測試主機，在測試主機透過 <acronym>NFS</acronym> 掛載 <filename>/usr/src</filename> 及 <filename>/usr/obj</filename>。然後執行 <command>shutdown now</command> 進入單使用者模式來安裝新的核心與 World 並如同往常執行 <command>mergemaster</command>。完成之後，重新開機回到正常的多使用者模式運作。</para>

    <para>在測試主機上檢驗完所有東西皆運作正常之後，使用相同的程序將編譯好的結果安裝到在建置集中的其他主機。</para>

    <para>同樣的方法也可用在 Port 樹，第一個步驟是透過 <acronym>NFS</acronym> 共享 <filename>/usr/ports</filename> 給所有在建置集中的主機。要設定 <filename>/etc/make.conf</filename> 使用共享的 distfiles，可設定 <varname>DISTDIR</varname> 為由 <acronym>NFS</acronym> 掛載對應到的使用者 <systemitem class="username">root</systemitem> 可寫入的通用共享目錄。每一台主機應設定 <varname>WRKDIRPREFIX</varname> 到一個本地的編譯目錄，若 Port 要在本地編譯。或者，若建置系統要編譯並散佈套件到建置集中的主機可在建置系統上設定 <varname>PACKAGES</varname> 到一個類似 <varname>DISTDIR</varname> 的目錄。</para>
  </sect1>
</chapter>

    
<!--
Recently I suggested to myself that this should become a profiling
and debugging chapter, which covers things like ktrace(1) and
using other debugging (like -x in shell scripts).  But then I
realized that, over time and while DTrace becomes better supported,
that might make this chapter too large.
-->
<!--
     The FreeBSD Documentation Project
     $FreeBSD$
-->
<!-- XXXTR: Should probably put links and resources here.  I'm
        nervous about this chapter as it may require a partial
	re-write and large modification once DTrace is complete, but
	at least we can get everyone started ... -->
<chapter version="5.0" xml:id="dtrace">
  <info>
    <title xml:lang="en">DTrace</title>

    <authorgroup>
      <author xml:lang="en"><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Written
	by </contrib></author>
    </authorgroup>
  </info>

  <sect1 xml:id="dtrace-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en"><primary>DTrace</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>DTrace support</primary>
      <see>DTrace</see>
    </indexterm>

    <para xml:lang="en">DTrace, also known as Dynamic Tracing, was developed by
      <trademark>Sun</trademark> as a tool for locating performance bottlenecks in
      production and pre-production systems.  In addition to
      diagnosing performance problems, DTrace can be used to help
      investigate and debug unexpected behavior in both the FreeBSD
      kernel and in userland programs.</para>

    <para xml:lang="en">DTrace is a remarkable profiling tool, with an impressive
      array of features for diagnosing system issues.  It may also be
      used to run pre-written scripts to take advantage of its
      capabilities.  Users can author their own utilities using the
      DTrace D Language, allowing them to customize their profiling
      based on specific needs.</para>

    <para xml:lang="en">The FreeBSD implementation provides full support for kernel
      DTrace and experimental support for userland DTrace.
      Userland DTrace allows users to perform function boundary
      tracing for userland programs using the <literal>pid</literal>
      provider, and to insert static probes into userland programs for
      later tracing.  Some ports, such as
      <package>databases/postgres-server</package> and
      <package>lang/php56</package> have a DTrace option to enable
      static probes.  FreeBSD 10.0-RELEASE has reasonably good userland
      DTrace support, but it is not considered production ready.  In
      particular, it is possible to crash traced programs.</para>

    <para xml:lang="en">The official guide to DTrace is maintained by the Illumos
      project at <uri xlink:href="http://dtrace.org/guide">DTrace
	Guide</uri>.</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">What DTrace is and what features it provides.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Differences between the <trademark>Solaris</trademark> DTrace
	  implementation and the one provided by FreeBSD.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to enable and use DTrace on FreeBSD.</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>了解 <trademark class="registered">UNIX</trademark> 及 FreeBSD 基礎 (<xref linkend="basics"/>)。</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Have some familiarity with security and how it pertains
	  to FreeBSD (<xref linkend="security"/>).</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="dtrace-implementation">
    <title>實作差異</title>

    <para xml:lang="en">While the DTrace in FreeBSD is similar to that found in
      <trademark>Solaris</trademark>, differences do exist.  The primary difference is that
      in FreeBSD, DTrace is implemented as a set of kernel modules and
      DTrace can not be used until the modules are loaded.  To load
      all of the necessary modules:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload dtraceall</userinput></screen>

    <para xml:lang="en">Beginning with FreeBSD 10.0-RELEASE, the modules are
      automatically loaded when <command>dtrace</command> is
      run.</para>

    <para xml:lang="en">FreeBSD uses the <literal>DDB_CTF</literal> kernel option to
      enable support for loading <acronym>CTF</acronym> data from
      kernel modules and the kernel itself.  <acronym>CTF</acronym> is
      the <trademark>Solaris</trademark> Compact C Type Format which encapsulates a reduced
      form of debugging information similar to
      <acronym>DWARF</acronym> and the venerable stabs.
      <acronym>CTF</acronym> data is added to binaries by the
      <command>ctfconvert</command> and <command>ctfmerge</command>
      build tools.  The <command>ctfconvert</command> utility parses
      <acronym>DWARF</acronym> <acronym>ELF</acronym> debug sections
      created by the compiler and <command>ctfmerge</command> merges
      <acronym>CTF</acronym> <acronym>ELF</acronym> sections from
      objects into either executables or shared libraries.</para>

    <para xml:lang="en">Some different providers exist for FreeBSD than for <trademark>Solaris</trademark>.
      Most notable is the <literal>dtmalloc</literal> provider, which
      allows tracing <function>malloc()</function> by type in the FreeBSD
      kernel.  Some of the providers found in <trademark>Solaris</trademark>, such as
      <literal>cpc</literal> and <literal>mib</literal>, are not
      present in FreeBSD.  These may appear in future versions of FreeBSD.
      Moreover, some of the providers available in both operating
      systems are not compatible, in the sense that their probes have
      different argument types.  Thus, <acronym>D</acronym> scripts
      written on <trademark>Solaris</trademark> may or may not work unmodified on FreeBSD, and
      vice versa.</para>

    <para xml:lang="en">Due to security differences, only <systemitem class="username">root</systemitem> may use DTrace on FreeBSD.
      <trademark>Solaris</trademark> has a few low level security checks which do not yet
      exist in FreeBSD.  As such, the
      <filename>/dev/dtrace/dtrace</filename> is strictly limited to
      <systemitem class="username">root</systemitem>.</para>

    <para xml:lang="en">DTrace falls under the Common Development and Distribution
      License (<acronym>CDDL</acronym>) license.  To view this license
      on FreeBSD, see
      <filename>/usr/src/cddl/contrib/opensolaris/OPENSOLARIS.LICENSE</filename>
      or view it online at <uri xlink:href="http://opensource.org/licenses/CDDL-1.0">http://opensource.org/licenses/CDDL-1.0</uri>.
      While a FreeBSD kernel with DTrace support is
      <acronym>BSD</acronym> licensed, the <acronym>CDDL</acronym> is
      used when the modules are distributed in binary form or the
      binaries are loaded.</para>
  </sect1>

  <sect1 xml:id="dtrace-enable">
    <title>開啟 DTrace 支援</title>

    <para xml:lang="en">In FreeBSD 9.2 and 10.0, DTrace support is built into the
      <filename>GENERIC</filename> kernel.  Users of earlier versions
      of FreeBSD or who prefer to statically compile in DTrace support
      should add the following lines to a custom kernel configuration
      file and recompile the kernel using the instructions in <xref linkend="kernelconfig"/>:</para>

    <programlisting xml:lang="en">options         KDTRACE_HOOKS
options         DDB_CTF
makeoptions	DEBUG=-g
makeoptions	WITH_CTF=1</programlisting>

    <para xml:lang="en">Users of the AMD64 architecture should also add this
      line:</para>

    <programlisting xml:lang="en">options         KDTRACE_FRAME</programlisting>

    <para xml:lang="en">This option provides support for <acronym>FBT</acronym>.
      While DTrace will work without this option, there will be
      limited support for function boundary tracing.</para>

    <para xml:lang="en">Once the FreeBSD system has rebooted into the new kernel, or
      the DTrace kernel modules have been loaded using
      <command>kldload dtraceall</command>, the system will need
      support for the Korn shell as the DTrace
      Toolkit has several utilities written in <command>ksh</command>.
      Make sure that the <package>shells/ksh93</package> package or
      port is installed.  It is also possible to run these tools under
      <package>shells/pdksh</package> or
      <package>shells/mksh</package>.</para>

    <para xml:lang="en">Finally, install the current DTrace Toolkit,
      a collection of ready-made scripts
      for collecting system information.  There are scripts to check
      open files, memory, <acronym>CPU</acronym> usage, and a lot
      more.  FreeBSD 10
      installs a few of these scripts into
      <filename>/usr/share/dtrace</filename>.  On other FreeBSD versions,
      or to install the full
      DTrace Toolkit, use the
      <package>sysutils/DTraceToolkit</package> package or
      port.</para>

    <note>
      <para xml:lang="en">The scripts found in
	<filename>/usr/share/dtrace</filename> have been specifically
	ported to FreeBSD.  Not all of the scripts found in the DTrace
	Toolkit will work as-is on FreeBSD and some scripts may require
	some effort in order for them to work on FreeBSD.</para>
    </note>

    <para xml:lang="en">The DTrace Toolkit includes many scripts in the special
      language of DTrace.  This language is called the D language
      and it is very similar to C++.  An in depth discussion of the
      language is beyond the scope of this document.  It is
      covered extensively in the <uri xlink:href="http://www.dtrace.org/guide">Illumos Dynamic
	Tracing Guide</uri>.</para></sect1>

  <sect1 xml:id="dtrace-using">
    <title>使用 DTrace</title>

    <para xml:lang="en">DTrace scripts consist of a list of one or more
      <firstterm>probes</firstterm>, or instrumentation points, where
      each probe is associated with an action.  Whenever the condition
      for a probe is met, the associated action is executed.  For
      example, an action may occur when a file is opened, a process is
      started, or a line of code is executed.  The action might be to
      log some information or to modify context variables.  The
      reading and writing of context variables allows probes to share
      information and to cooperatively analyze the correlation of
      different events.</para>

    <para xml:lang="en">To view all probes, the administrator can execute the
      following command:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>dtrace -l | more</userinput></screen>

    <para xml:lang="en">Each probe has an <literal>ID</literal>, a
      <literal>PROVIDER</literal> (dtrace or fbt), a
      <literal>MODULE</literal>, and a
      <literal>FUNCTION NAME</literal>.    Refer to <citerefentry><refentrytitle>dtrace</refentrytitle><manvolnum>1</manvolnum></citerefentry> for
      more information about this command.</para>

    <para xml:lang="en">The examples in this section provide an overview of how to
      use two of the fully supported scripts from the
      DTrace Toolkit: the
      <filename>hotkernel</filename> and
      <filename>procsystime</filename> scripts.</para>

    <para xml:lang="en">The <filename>hotkernel</filename> script is designed to
      identify which function is using the most kernel time.  It will
      produce output similar to the following:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/share/dtrace/toolkit</userinput>
<prompt>#</prompt> <userinput>./hotkernel</userinput>
Sampling... Hit Ctrl-C to end.</screen>

    <para xml:lang="en">As instructed, use the
      <keycombo action="simul"><keycap>Ctrl</keycap><keycap>C</keycap>
      </keycombo> key combination to stop the process.  Upon
      termination, the script will display a list of kernel functions
      and timing information, sorting the output in increasing order
      of time:</para>

    <screen xml:lang="en">kernel`_thread_lock_flags                                   2   0.0%
0xc1097063                                                  2   0.0%
kernel`sched_userret                                        2   0.0%
kernel`kern_select                                          2   0.0%
kernel`generic_copyin                                       3   0.0%
kernel`_mtx_assert                                          3   0.0%
kernel`vm_fault                                             3   0.0%
kernel`sopoll_generic                                       3   0.0%
kernel`fixup_filename                                       4   0.0%
kernel`_isitmyx                                             4   0.0%
kernel`find_instance                                        4   0.0%
kernel`_mtx_unlock_flags                                    5   0.0%
kernel`syscall                                              5   0.0%
kernel`DELAY                                                5   0.0%
0xc108a253                                                  6   0.0%
kernel`witness_lock                                         7   0.0%
kernel`read_aux_data_no_wait                                7   0.0%
kernel`Xint0x80_syscall                                     7   0.0%
kernel`witness_checkorder                                   7   0.0%
kernel`sse2_pagezero                                        8   0.0%
kernel`strncmp                                              9   0.0%
kernel`spinlock_exit                                       10   0.0%
kernel`_mtx_lock_flags                                     11   0.0%
kernel`witness_unlock                                      15   0.0%
kernel`sched_idletd                                       137   0.3%
0xc10981a5                                              42139  99.3%</screen>

    <!-- XXXTR: I attempted to use objdump and nm on /boot/kernel/kernel
        to find 0xc10981a5, but to no avail.  It would be nice to know
	how we should look that up. -->

    <para xml:lang="en">This script will also work with kernel modules.  To use this
      feature, run the script with <option>-m</option>:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>./hotkernel -m</userinput>
Sampling... Hit Ctrl-C to end.
^C
MODULE                                                  COUNT   PCNT
0xc107882e                                                  1   0.0%
0xc10e6aa4                                                  1   0.0%
0xc1076983                                                  1   0.0%
0xc109708a                                                  1   0.0%
0xc1075a5d                                                  1   0.0%
0xc1077325                                                  1   0.0%
0xc108a245                                                  1   0.0%
0xc107730d                                                  1   0.0%
0xc1097063                                                  2   0.0%
0xc108a253                                                 73   0.0%
kernel                                                    874   0.4%
0xc10981a5                                             213781  99.6%</screen>

    <!-- XXXTR: I was unable to match these up with output from
        kldstat and kldstat -v and grep.  Maybe I'm missing something
	seriously obvious.  It is 5AM btw. -->

    <para xml:lang="en">The <filename>procsystime</filename> script captures and
      prints the system call time usage for a given process
      <acronym>ID</acronym> (<acronym>PID</acronym>) or process name.
      In the following example, a new instance of
      <filename>/bin/csh</filename> was spawned.  Then,
      <filename>procsystime</filename> was executed and remained
      waiting while a few commands were typed on the other incarnation
      of <command>csh</command>.  These are the results of this
      test:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>./procsystime -n csh</userinput>
Tracing... Hit Ctrl-C to end...
^C

Elapsed Times for processes csh,

         SYSCALL          TIME (ns)
          getpid               6131
       sigreturn               8121
           close              19127
           fcntl              19959
             dup              26955
         setpgid              28070
            stat              31899
       setitimer              40938
           wait4              62717
       sigaction              67372
     sigprocmask             119091
    gettimeofday             183710
           write             263242
          execve             492547
           ioctl             770073
           vfork            3258923
      sigsuspend            6985124
            read         3988049784</screen>

    <para xml:lang="en">As shown, the <function>read()</function> system call used
      the most time in nanoseconds while the
      <function>getpid()</function> system call used the least amount
      of time.</para>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->

<chapter version="5.0" xml:id="usb-device-mode">

  <title xml:lang="en">USB Device Mode / USB OTG</title>

  <sect1 xml:id="usb-device-mode-synopsis">
    <title>概述</title>

    <info>
      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Edward Tomasz</firstname>
	    <surname>Napierala</surname>
	  </personname>
	  <affiliation>
	    <address xml:lang="en">
	      <email>trasz@FreeBSD.org</email>
	    </address>
	  </affiliation>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>
    </info>

    <para xml:lang="en">This chapter covers the use of USB Device Mode and USB On
      The Go (<acronym>USB OTG</acronym>) in FreeBSD.  This includes
      virtual serial consoles, virtual network interfaces, and
      virtual USB drives.</para>

    <para xml:lang="en">When running on hardware that supports USB device mode
      or <acronym>USB OTG</acronym>, like that built into
      many embedded boards, the FreeBSD <acronym>USB</acronym> stack
      can run in <emphasis>device mode</emphasis>.  Device mode
      makes it possible for the computer to present itself as
      different kinds of <acronym>USB</acronym> device classes,
      including serial ports, network adapters, and mass storage,
      or a combination thereof.  A <acronym>USB</acronym> host like
      a laptop or desktop computer is able to access them just like
      physical <acronym>USB</acronym> devices.  Device mode is
      sometimes called the <quote>USB gadget mode</quote>.</para>

    <para xml:lang="en">There are two basic ways the hardware can provide the
      device mode functionality: with a separate "client port", which
      only supports the device mode, and with a USB OTG port, which
      can provide both device and host mode.  For
      <acronym>USB OTG</acronym> ports, the <acronym>USB</acronym>
      stack switches between host-side and device-side automatically,
      depending on what is connected to the port.  Connecting a
      <acronym>USB</acronym> device like a memory stick to the
      port causes FreeBSD to switch to host mode.  Connecting a
      <acronym>USB</acronym> host like a computer causes FreeBSD to
      switch to device mode.  Single purpose "client ports" always
      work in device mode.</para>

    <para xml:lang="en">What FreeBSD presents to the <acronym>USB</acronym> host
      depends on the <varname>hw.usb.template</varname> sysctl.  Some
      templates provide a single device, such as a serial terminal;
      others provide multiple ones, which can all be used at the same
      time.  An example is the template 10, which provides a mass
      storage device, a serial console, and a network interface.
      See <citerefentry><refentrytitle>usb_template</refentrytitle><manvolnum>4</manvolnum></citerefentry> for the list of available
      values.</para>

    <para xml:lang="en">Note that in some cases, depending on the hardware and the
      hosts operating system, for the host to notice the configuration
      change, it must be either physically disconnected and
      reconnected, or forced to rescan the <acronym>USB</acronym>
      bus in a system-specific way.  When FreeBSD is running on the host,
      <citerefentry vendor="current"><refentrytitle>usbconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> <command>reset</command> can be used.
      This also must be done after loading
      <filename>usb_template.ko</filename> if the
      <acronym>USB</acronym> host was already connected to the
      <acronym>USB</acronym> <acronym>OTG</acronym> socket.</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">How to set up USB Device Mode functionality on
	  FreeBSD.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to configure the virtual serial port on
	  FreeBSD.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to connect to the virtual serial port
	  from various operating systems.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to configure FreeBSD to provide a virtual
	  <acronym>USB</acronym> network interface.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to configure FreeBSD to provide a virtual
	  <acronym>USB</acronym> storage device.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="usb-device-mode-terminals">
    <title><acronym>USB</acronym> 虛擬序列埠</title>

    <sect2>
      <title>設定 USB 裝置模式序列埠</title>

      <para xml:lang="en">Virtual serial port support is provided by templates
	number 3, 8, and 10.  Note that template 3 works with
	Microsoft Windows 10 without the need for special drivers
	and INF files.  Other host operating systems work with all
	three templates.  Both <citerefentry><refentrytitle>usb_template</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>umodem</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	kernel modules must be loaded.</para>

      <para xml:lang="en">To enable USB device mode serial ports, add those lines
	to <filename>/etc/ttys</filename>:</para>

      <screen xml:lang="en">ttyU0	"/usr/libexec/getty 3wire"	vt100	onifconsole secure
ttyU1	"/usr/libexec/getty 3wire"	vt100	onifconsole secure</screen>

      <para>然後加入這些行到 <filename>/etc/devd.conf</filename>：</para>

      <screen xml:lang="en">notify 100 {
	match "system"		"DEVFS";
	match "subsystem"	"CDEV";
	match "type"		"CREATE";
	match "cdev"		"ttyU[0-9]+";
	action "/sbin/init q";
};</screen>

      <para xml:lang="en">Reload the configuration if
	<citerefentry><refentrytitle>devd</refentrytitle><manvolnum>8</manvolnum></citerefentry> is already running:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service devd restart</userinput></screen>

      <para xml:lang="en">Make sure the necessary modules are loaded and the
	correct template is set at boot by adding
	those lines to <filename>/boot/loader.conf</filename>,
	creating it if it does not already exist:</para>

      <screen xml:lang="en">umodem_load="YES"
hw.usb.template=3</screen>

      <para xml:lang="en">To load the module and set the template without rebooting
	use:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload umodem</userinput>
<prompt>#</prompt> <userinput>sysctl hw.usb.template=3</userinput></screen>

    </sect2>

    <sect2>
      <title>自 FreeBSD 連線到 USB 裝置模式序列埠</title>

      <para xml:lang="en">To connect to a board configured to provide USB device
	mode serial ports, connect the USB host, such as a laptop, to
	the boards USB OTG or USB client port.  Use
	<command>pstat -t</command> on the host to list the terminal
	lines.  Near the end of the list you should see a USB serial
	port, eg "ttyU0".  To open the connection, use:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cu -l /dev/ttyU0</userinput></screen>

      <para xml:lang="en">After pressing the Enter key a few times you will see
	a login prompt.</para>
    </sect2>

    <sect2>
      <title>自 macOS 連線到 USB 裝置模式序列埠</title>

      <para xml:lang="en">To connect to a board configured to provide USB device
	mode serial ports, connect the USB host, such as a laptop,
	to the boards USB OTG or USB client port.  To open the
	connection, use:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cu -l /dev/cu.usbmodemFreeBSD1</userinput></screen>
    </sect2>

    <sect2>
      <title>自 Linux 連線到 USB 裝置模式序列埠</title>

      <para xml:lang="en">To connect to a board configured to provide USB device
	mode serial ports, connect the USB host, such as a laptop,
	to the boards USB OTG or USB client port.  To open the
	connection, use:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>minicom -D /dev/ttyACM0</userinput></screen>
    </sect2>

    <sect2>
      <title>自 Microsoft Windows 10 連線到 USB 裝置模式序列埠</title>

      <para xml:lang="en">To connect to a board configured to provide USB device
	mode serial ports, connect the USB host, such as a laptop,
	to the boards USB OTG or USB client port.  To open a
	connection you will need a serial terminal program, such as
	<application>PuTTY</application>.  To check the COM port name
	used by Windows, run Device Manager, expand "Ports (COM &amp;
	LPT)".  You will see a name similar to "USB Serial Device
	(COM4)".  Run serial terminal program of your choice, for
	example <application>PuTTY</application>.  In the
	<application>PuTTY</application> dialog set "Connection type"
	to "Serial", type the COMx obtained from Device Manager in the
	"Serial line" dialog box and click Open.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="usb-device-mode-network">

    <title><acronym>USB</acronym> 裝置模式網路介面</title>

    <para xml:lang="en">Virtual network interfaces support is provided by templates
      number 1, 8, and 10.  Note that none of them works with
      Microsoft Windows.  Other host operating systems work with all
      three templates.  Both <citerefentry><refentrytitle>usb_template</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>if_cdce</refentrytitle><manvolnum>4</manvolnum></citerefentry>
      kernel modules must be loaded.</para>

    <para xml:lang="en">Make sure the necessary modules are loaded and the correct
      template is set at boot by adding
      those lines to <filename>/boot/loader.conf</filename>, creating
      it if it does not already exist:</para>

    <screen xml:lang="en">if_cdce_load="YES"
hw.usb.template=1</screen>

    <para xml:lang="en">To load the module and set the template without rebooting
      use:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload if_cdce</userinput>
<prompt>#</prompt> <userinput>sysctl hw.usb.template=1</userinput></screen>
  </sect1>

  <sect1 xml:id="usb-device-mode-storage">
    <title><acronym>USB</acronym> 虛擬儲存裝置</title>

    <note>
      <para><citerefentry><refentrytitle>cfumass</refentrytitle><manvolnum>4</manvolnum></citerefentry> 驅動程式是一個在 FreeBSD 12.0 之後才可用的 <acronym>USB</acronym> 裝置模式驅動程式。</para>
    </note>

    <para xml:lang="en">Mass Storage target is provided by templates 0 and 10.
      Both <citerefentry><refentrytitle>usb_template</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>cfumass</refentrytitle><manvolnum>4</manvolnum></citerefentry> kernel modules
      must be loaded.  <citerefentry><refentrytitle>cfumass</refentrytitle><manvolnum>4</manvolnum></citerefentry> interfaces to the CTL
      subsystem, the same one that is used for
      <acronym>iSCSI</acronym> or Fibre Channel targets.
      On the host side, <acronym>USB</acronym> Mass Storage
      initiators can only access a single <acronym>LUN</acronym>,
      <acronym>LUN</acronym> 0.</para>

    <sect2>
      <title>使用 cfumass 啟動 Script 設定 USB 大容量儲存目標</title>

      <para xml:lang="en">The simplest way to set up a read-only USB storage target
	is to use the <filename>cfumass</filename> rc script.  To
	configure it this way, copy the files to be presented to the
	USB host machine into the <literal>/var/cfumass</literal>
	directory, and add this line to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">cfumass_enable="YES"</programlisting>

      <para xml:lang="en">To configure the target without restarting,
	run this command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service cfumass start</userinput></screen>

      <para xml:lang="en">Differently from serial and network functionality, the
	template should not be set to 0 or 10 in
	<filename>/boot/loader.conf</filename>.  This is because the
	LUN must be set up before setting the template.  The cfumass
	startup script sets the correct template number automatically
	when started.</para>
    </sect2>
    <sect2>
      <title>使用其他方式設定 USB 大容量存儲目標</title>

      <para xml:lang="en">The rest of this chapter provides detailed description of
	setting the target without using the cfumass rc file.  This is
	necessary if eg one wants to provide a writeable LUN.</para>

      <para xml:lang="en"><acronym>USB</acronym> Mass Storage does not require the
	<citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon to be running, although it can be used if
	desired.  This is different from <acronym>iSCSI</acronym>.
	Thus, there are two ways to configure the target:
	<citerefentry><refentrytitle>ctladm</refentrytitle><manvolnum>8</manvolnum></citerefentry>, or <citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  Both require the
	<filename>cfumass.ko</filename> kernel module to be loaded.
	The module can be loaded manually:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload cfumass</userinput></screen>

      <para xml:lang="en">If <filename>cfumass.ko</filename> has not been built into
	the kernel, <filename>/boot/loader.conf</filename> can be set
	to load the module at boot:</para>

      <programlisting xml:lang="en">cfumass_load="YES"</programlisting>

      <para xml:lang="en">A <acronym>LUN</acronym> can be created without the
	<citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ctladm create -b block -o file=/data/target0</userinput></screen>

      <para xml:lang="en">This presents the contents of the image file
	<filename>/data/target0</filename> as a <acronym>LUN</acronym>
	to the <acronym>USB</acronym> host.  The file must exist
	before executing the command.  To configure the
	<acronym>LUN</acronym> at system startup, add the command to
	<filename>/etc/rc.local</filename>.</para>

      <para xml:lang="en"><citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> can also be used to manage
	<acronym>LUN</acronym>s.  Create
	<filename>/etc/ctl.conf</filename>, add a line to
	<filename>/etc/rc.conf</filename> to make sure <citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> is
	automatically started at boot, and then start the
	daemon.</para>

      <para xml:lang="en">This is an example of a simple
	<filename>/etc/ctl.conf</filename> configuration file.  Refer
	to <citerefentry><refentrytitle>ctl.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for a more complete description of the
	options.</para>

      <programlisting xml:lang="en">target naa.50015178f369f092 {
	lun 0 {
		path /data/target0
		size 4G
	}
}</programlisting>

      <para xml:lang="en">The example creates a single target with a single
	<acronym>LUN</acronym>.  The
	<literal>naa.50015178f369f092</literal> is a device identifier
	composed of 32 random hexadecimal digits.  The
	<literal>path</literal> line defines the full path to a file
	or zvol backing the <acronym>LUN</acronym>.  That file must
	exist before starting <citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  The second line is
	optional and specifies the size of the
	<acronym>LUN</acronym>.</para>

      <para xml:lang="en">To make sure the <citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon is started at
	boot, add this line to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">ctld_enable="YES"</programlisting>

      <para xml:lang="en">To start <citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> now, run this command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service ctld start</userinput></screen>

      <para>當 <citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> Daemon 啟動後，它會讀取 <filename>/etc/ctl.conf</filename>，若這個檔案在 Daemon 啟動之後才做修改，要重新載入變更的內容才能立即生效：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service ctld reload</userinput></screen>
    </sect2>
  </sect1>
</chapter>

  </part>

  <part xml:id="network-communication">
    <title>網路通訊</title>

    <partintro>
      <para>FreeBSD 是一種廣泛的被使用在高效能的網路伺服器中的作業系統，這些章節包含了：</para>

      <itemizedlist>
	<listitem>
	  <para>序列通訊</para>
	</listitem>

	<listitem>
	  <para><acronym>PPP</acronym> 和在乙太網路使用 <acronym>PPP</acronym></para>
	</listitem>

	<listitem>
	  <para>電子郵件</para>
	</listitem>

	<listitem>
	  <para>執行網路伺服器</para>
	</listitem>

	<listitem>
	  <para>防火牆</para>
	</listitem>

	<listitem>
	  <para>其他的進階網路主題</para>
	</listitem>
      </itemizedlist>

      <para>這些章節是讓您在需要查資料的時候翻閱用的。 您不需要依照特定的順序來讀，也不需要將這些章節全部讀過之後才將 FreeBSD 用在網路環境下。</para>
    </partintro>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="serialcomms">
  <title>序列通訊</title>

  <sect1 xml:id="serial-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en"><primary>serial communications</primary></indexterm>

    <para><trademark class="registered">UNIX</trademark> 從最早的第一台 <trademark class="registered">UNIX</trademark> 仰賴序列線路來讓使用者輸入與輸出以來一直都支援序列通訊，雖與每秒 10 個字元的序列印表機及鍵盤組成的終端機時代比起已改變很多。本章將說明幾種可在 FreeBSD 使用的序列通訊方式。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>如何連線終端機到 FreeBSD 系統。</para>
      </listitem>
      <listitem>
	<para>如何使用數據機撥號給遠端主機。</para>
      </listitem>
      <listitem>
	<para>如何允許遠端使用者透過數據機來登入 FreeBSD 系統。</para>
      </listitem>
      <listitem>
	<para>如何從序列 Console 啟動 FreeBSD 系統。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>了解如何 <link linkend="kernelconfig">設定並安裝自訂核心</link>。</para>
      </listitem>
      <listitem>
	<para>了解 <link linkend="basics"> FreeBSD 的權限與程序</link>。</para>
      </listitem>
      <listitem>
	<para>能夠取得要在 FreeBSD 使用的序列硬體的技術手冊。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="serial">
    <title>序列術語與硬體</title>

    <para xml:lang="en">The following terms are often used in serial
      communications:</para>
    <variablelist>
      <varlistentry>
	<term xml:lang="en"><acronym>bps</acronym></term>
	<listitem>
	  <para xml:lang="en">Bits per
	    Second<indexterm xml:lang="en"><primary>bits-per-second</primary></indexterm>
	    (<acronym>bps</acronym>) is the rate at which data is
	    transmitted.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en"><acronym>DTE</acronym></term>
	<listitem>
	  <para xml:lang="en">Data Terminal
	    Equipment<indexterm xml:lang="en"><primary>DTE</primary></indexterm>
	    (<acronym>DTE</acronym>) is one of two endpoints in a
	    serial communication.  An example would be a
	    computer.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en"><acronym>DCE</acronym></term>
	<listitem>
	  <para xml:lang="en">Data Communications
	    Equipment<indexterm xml:lang="en"><primary>DCE</primary></indexterm>
	    (<acronym>DTE</acronym>) is the other endpoint in a
	    serial communication.  Typically, it is a modem or serial
	    terminal.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en"><acronym>RS-232</acronym></term>
	<listitem>
	  <para xml:lang="en">The original standard which defined hardware serial
	    communications.  It has since been renamed to
	    <acronym>TIA-232</acronym>.</para>
	</listitem>
      </varlistentry>
    </variablelist>

    <para xml:lang="en">When referring to communication data rates, this section
      does not use the term <firstterm>baud</firstterm>.  Baud refers
      to the number of electrical state transitions made in a period
      of time, while <acronym>bps</acronym> is the correct term to
      use.</para>

    <para xml:lang="en">To connect a serial terminal to a FreeBSD system, a serial port
      on the computer and the proper cable to connect to the serial
      device are needed.  Users who are already familiar with serial
      hardware and cabling can safely skip this section.</para>

    <sect2 xml:id="term-cables-null">
      <title>序列線與埠</title>

      <para xml:lang="en">There are several different kinds of serial cables.  The
	two most common types are null-modem cables and standard
	<acronym>RS-232</acronym> cables.  The documentation for the
	hardware should describe the type of cable required.</para>

      <para xml:lang="en">These two types of cables differ in how the wires are
	connected to the connector.  Each wire represents a signal,
	with the defined signals summarized in <xref linkend="serialcomms-signal-names"/>.  A standard serial
	cable passes all of the <acronym>RS-232C</acronym> signals
	straight through.  For example, the <quote>Transmitted
	  Data</quote> pin on one end of the cable goes to the
	<quote>Transmitted Data</quote> pin on the other end.  This is
	the type of cable used to connect a modem to the FreeBSD system,
	and is also appropriate for some terminals.</para>

      <para xml:lang="en">A null-modem cable switches the <quote>Transmitted
	  Data</quote> pin of the connector on one end with the
	<quote>Received Data</quote> pin on the other end.  The
	connector can be either a <acronym>DB-25</acronym> or a
	<acronym>DB-9</acronym>.</para>

      <para xml:lang="en">A null-modem cable can be constructed using the pin
	connections summarized in <xref linkend="nullmodem-db25"/>,
	<xref linkend="nullmodem-db9"/>, and <xref linkend="nullmodem-db9-25"/>.  While the standard calls for
	a straight-through pin 1 to pin 1 <quote>Protective
	  Ground</quote> line, it is often omitted.  Some terminals
	work using only pins 2, 3, and 7, while others require
	different configurations.  When in doubt, refer to the
	documentation for the hardware.</para>

      <indexterm xml:lang="en">
	<primary>null-modem cable</primary>
      </indexterm>

      <table frame="none" pgwide="1" xml:id="serialcomms-signal-names">
	<title><acronym>RS-232C</acronym> 信號名稱</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry align="left">縮寫</entry>
	      <entry align="left" xml:lang="en">Names</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><acronym>RD</acronym></entry>
	      <entry xml:lang="en">Received Data</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><acronym>TD</acronym></entry>
	      <entry xml:lang="en">Transmitted Data</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><acronym>DTR</acronym></entry>
	      <entry xml:lang="en">Data Terminal Ready</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><acronym>DSR</acronym></entry>
	      <entry xml:lang="en">Data Set Ready</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><acronym>DCD</acronym></entry>
	      <entry xml:lang="en">Data Carrier Detect</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><acronym>SG</acronym></entry>
	      <entry xml:lang="en">Signal Ground</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><acronym>RTS</acronym></entry>
	      <entry xml:lang="en">Request to Send</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><acronym>CTS</acronym></entry>
	      <entry xml:lang="en">Clear to Send</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <table frame="none" pgwide="1" xml:id="nullmodem-db25">
	<title>DB-25 對 DB-25 Null-Modem 線</title>

	<tgroup cols="5">
	  <thead>
	    <row>
	      <entry align="left">信號</entry>
	      <entry align="left">針腳 #</entry>
	      <entry/>
	      <entry align="left">針腳 #</entry>
	      <entry align="left">信號</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">SG</entry>
	      <entry xml:lang="en">7</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">7</entry>
	      <entry xml:lang="en">SG</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">TD</entry>
	      <entry xml:lang="en">2</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">3</entry>
	      <entry xml:lang="en">RD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">RD</entry>
	      <entry xml:lang="en">3</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">2</entry>
	      <entry xml:lang="en">TD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">RTS</entry>
	      <entry xml:lang="en">4</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">5</entry>
	      <entry xml:lang="en">CTS</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">CTS</entry>
	      <entry xml:lang="en">5</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">4</entry>
	      <entry xml:lang="en">RTS</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DTR</entry>
	      <entry xml:lang="en">20</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">6</entry>
	      <entry xml:lang="en">DSR</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DTR</entry>
	      <entry xml:lang="en">20</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">8</entry>
	      <entry xml:lang="en">DCD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DSR</entry>
	      <entry xml:lang="en">6</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">20</entry>
	      <entry xml:lang="en">DTR</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DCD</entry>
	      <entry xml:lang="en">8</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">20</entry>
	      <entry xml:lang="en">DTR</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <table frame="none" pgwide="1" xml:id="nullmodem-db9">
	<title>DB-9 對 DB-9 Null-Modem 線</title>

	<tgroup cols="5">
	  <thead>
	    <row>
	      <entry align="left">信號</entry>
	      <entry align="left">針腳 #</entry>
	      <entry/>
	      <entry align="left">針腳 #</entry>
	      <entry align="left">信號</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">RD</entry>
	      <entry xml:lang="en">2</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">3</entry>
	      <entry xml:lang="en">TD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">TD</entry>
	      <entry xml:lang="en">3</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">2</entry>
	      <entry xml:lang="en">RD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DTR</entry>
	      <entry xml:lang="en">4</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">6</entry>
	      <entry xml:lang="en">DSR</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DTR</entry>
	      <entry xml:lang="en">4</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">1</entry>
	      <entry xml:lang="en">DCD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">SG</entry>
	      <entry xml:lang="en">5</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">5</entry>
	      <entry xml:lang="en">SG</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DSR</entry>
	      <entry xml:lang="en">6</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">4</entry>
	      <entry xml:lang="en">DTR</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DCD</entry>
	      <entry xml:lang="en">1</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">4</entry>
	      <entry xml:lang="en">DTR</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">RTS</entry>
	      <entry xml:lang="en">7</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">8</entry>
	      <entry xml:lang="en">CTS</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">CTS</entry>
	      <entry xml:lang="en">8</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">7</entry>
	      <entry xml:lang="en">RTS</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <table frame="none" pgwide="1" xml:id="nullmodem-db9-25">
	<title>DB-9 對 DB-25 Null-Modem 線</title>

	<tgroup cols="5">
	  <thead>
	    <row>
	      <entry align="left">信號</entry>
	      <entry align="left">針腳 #</entry>
	      <entry/>
	      <entry align="left">針腳 #</entry>
	      <entry align="left">信號</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">RD</entry>
	      <entry xml:lang="en">2</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">2</entry>
	      <entry xml:lang="en">TD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">TD</entry>
	      <entry xml:lang="en">3</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">3</entry>
	      <entry xml:lang="en">RD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DTR</entry>
	      <entry xml:lang="en">4</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">6</entry>
	      <entry xml:lang="en">DSR</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DTR</entry>
	      <entry xml:lang="en">4</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">8</entry>
	      <entry xml:lang="en">DCD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">SG</entry>
	      <entry xml:lang="en">5</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">7</entry>
	      <entry xml:lang="en">SG</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DSR</entry>
	      <entry xml:lang="en">6</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">20</entry>
	      <entry xml:lang="en">DTR</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">DCD</entry>
	      <entry xml:lang="en">1</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">20</entry>
	      <entry xml:lang="en">DTR</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">RTS</entry>
	      <entry xml:lang="en">7</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">5</entry>
	      <entry xml:lang="en">CTS</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">CTS</entry>
	      <entry xml:lang="en">8</entry>
	      <entry xml:lang="en">connects to</entry>
	      <entry xml:lang="en">4</entry>
	      <entry xml:lang="en">RTS</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <note>
	<para xml:lang="en">When one pin at one end connects to a pair of pins at
	  the other end, it is usually implemented with one short wire
	  between the pair of pins in their connector and a long wire
	  to the other single pin.</para>
      </note>

      <para xml:lang="en">Serial ports are the devices through which data is
	transferred between the FreeBSD host computer and the terminal.
	Several kinds of serial ports exist.  Before purchasing or
	constructing a cable, make sure it will fit the ports on the
	terminal and on the FreeBSD system.</para>

      <para xml:lang="en">Most terminals have <acronym>DB-25</acronym> ports.
	Personal computers may have <acronym>DB-25</acronym> or
	<acronym>DB-9</acronym> ports.  A multiport serial card may
	have <acronym>RJ-12</acronym> or <acronym>RJ-45/</acronym>
	ports.  See the documentation that accompanied the hardware
	for specifications on the kind of port or visually verify the
	type of port.</para>

      <para xml:lang="en">In FreeBSD, each serial port is accessed through an entry in
	<filename>/dev</filename>.  There are two different kinds of
	entries:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Call-in ports are named
	    <filename>/dev/ttyu<replaceable>N</replaceable></filename>
	    where <replaceable>N</replaceable> is the port number,
	    starting from zero.  If a terminal is connected to the
	    first serial port (<filename>COM1</filename>), use
	    <filename>/dev/ttyu0</filename> to refer to the terminal.
	    If the terminal is on the second serial port
	    (<filename>COM2</filename>), use
	    <filename>/dev/ttyu1</filename>, and so forth.  Generally,
	    the call-in port is used for terminals.  Call-in ports
	    require that the serial line assert the <quote>Data
	      Carrier Detect</quote> signal to work correctly.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Call-out ports are named
	    <filename>/dev/cuau<replaceable>N</replaceable></filename>
	    on FreeBSD versions 8.X and higher and
	    <filename>/dev/cuad<replaceable>N</replaceable></filename>
	    on FreeBSD versions 7.X and lower.  Call-out ports are
	    usually not used for terminals, but are used for modems.
	    The call-out port can be used if the serial cable or the
	    terminal does not support the <quote>Data Carrier
	      Detect</quote> signal.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">FreeBSD also provides initialization devices
	(<filename>/dev/ttyu<replaceable>N</replaceable>.init</filename>
	and
	<filename>/dev/cuau<replaceable>N</replaceable>.init</filename>
	or
	<filename>/dev/cuad<replaceable>N</replaceable>.init</filename>)
	and locking devices
	(<filename>/dev/ttyu<replaceable>N</replaceable>.lock</filename>
	and
	<filename>/dev/cuau<replaceable>N</replaceable>.lock</filename>
	or
	<filename>/dev/cuad<replaceable>N</replaceable>.lock</filename>).
	The initialization devices are used to initialize
	communications port parameters each time a port is opened,
	such as <literal>crtscts</literal> for modems which use
	<literal>RTS/CTS</literal> signaling for flow control.  The
	locking devices are used to lock flags on ports to prevent
	users or programs changing certain parameters.  Refer to
	<citerefentry><refentrytitle>termios</refentrytitle><manvolnum>4</manvolnum></citerefentry>, <citerefentry><refentrytitle>sio</refentrytitle><manvolnum>4</manvolnum></citerefentry>, and <citerefentry><refentrytitle>stty</refentrytitle><manvolnum>1</manvolnum></citerefentry> for information
	on terminal settings, locking and initializing devices, and
	setting terminal options, respectively.</para>
    </sect2>

    <sect2 xml:id="serial-hw-config">
      <title>序列埠設定</title>

      <para xml:lang="en">By default, FreeBSD supports four serial ports which are
	commonly known as <filename>COM1</filename>,
	<filename>COM2</filename>, <filename>COM3</filename>, and
	<filename>COM4</filename>.  FreeBSD also supports dumb multi-port
	serial interface cards, such as the BocaBoard 1008 and 2016,
	as well as more intelligent multi-port cards such as those
	made by Digiboard.  However, the default kernel only looks for
	the standard <filename>COM</filename> ports.</para>

      <para xml:lang="en">To see if the system recognizes the serial ports, look for
	system boot messages that start with
	<literal>uart</literal>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>grep uart /var/run/dmesg.boot</userinput></screen>

      <para xml:lang="en">If the system does not recognize all of the needed serial
	ports, additional entries can be added to
	<filename>/boot/device.hints</filename>.  This file already
	contains <literal>hint.uart.0.*</literal> entries for
	<filename>COM1</filename> and <literal>hint.uart.1.*</literal>
	entries for <filename>COM2</filename>.  When adding a port
	entry for <filename>COM3</filename> use
	<literal>0x3E8</literal>, and for <filename>COM4</filename>
	use <literal>0x2E8</literal>.  Common <acronym>IRQ</acronym>
	addresses are <literal>5</literal> for
	<filename>COM3</filename> and <literal>9</literal> for
	<filename>COM4</filename>.</para>

      <indexterm xml:lang="en"><primary><filename>ttyu</filename></primary></indexterm>
      <indexterm xml:lang="en"><primary><filename>cuau</filename></primary></indexterm>

      <para xml:lang="en">To determine the default set of terminal
	<acronym>I/O</acronym> settings used by the port, specify its
	device name.  This example determines the settings for the
	call-in port on <filename>COM2</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>stty -a -f /dev/<replaceable>ttyu1</replaceable></userinput></screen>

      <para xml:lang="en">System-wide initialization of serial devices is controlled
	by <filename>/etc/rc.d/serial</filename>.  This file affects
	the default settings of serial devices.  To change the
	settings for a device, use <command>stty</command>.  By
	default, the changed settings are in effect until the device
	is closed and when the device is reopened, it goes back to the
	default set.  To permanently change the default set, open and
	adjust the settings of the initialization device.  For
	example, to turn on <option>CLOCAL</option> mode, 8 bit
	communication, and <option>XON/XOFF</option> flow control for
	<filename>ttyu5</filename>, type:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>stty -f /dev/ttyu5.init clocal cs8 ixon ixoff</userinput></screen>

      <indexterm xml:lang="en">
	<primary>rc files</primary>
	<secondary><filename>rc.serial</filename></secondary>
      </indexterm>

      <para xml:lang="en">To prevent certain settings from being changed by an
	application, make adjustments to the locking device.  For
	example, to lock the speed of <filename>ttyu5</filename> to
	57600 bps, type:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>stty -f /dev/ttyu5.lock 57600</userinput></screen>

      <para xml:lang="en">Now, any application that opens <filename>ttyu5</filename>
	and tries to change the speed of the port will be stuck with
	57600 bps.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="term">
    <info>
      <title>終端機</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Sean</firstname>
	    <surname>Kelly</surname>
	  </personname>
	  <contrib>Contributed by </contrib> <!--in July 1996 -->
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en"><primary>terminals</primary></indexterm>

    <para xml:lang="en">Terminals provide a convenient and low-cost way to access
      a FreeBSD system when not at the computer's console or on a
      connected network.  This section describes how to use terminals
      with FreeBSD.</para>

    <para xml:lang="en">The original <trademark class="registered">UNIX</trademark> systems did not have consoles.  Instead,
      users logged in and ran programs through terminals that were
      connected to the computer's serial ports.</para>

    <para xml:lang="en">The ability to establish a login session on a serial port
      still exists in nearly every <trademark class="registered">UNIX</trademark>-like operating system
      today, including FreeBSD.  By using a terminal attached to an
      unused serial port, a user can log in and run any text program
      that can normally be run on the console or in an
      <command>xterm</command> window.</para>

    <para xml:lang="en">Many terminals can be attached to a FreeBSD system.  An older
      spare computer can be used as a terminal wired into a more
      powerful computer running FreeBSD.  This can turn what might
      otherwise be a single-user computer into a powerful
      multiple-user system.</para>

    <para xml:lang="en">FreeBSD supports three types of terminals:</para>

    <variablelist>
      <varlistentry>
	<term xml:lang="en">Dumb terminals</term>
	<listitem>
	  <para xml:lang="en">Dumb terminals are specialized hardware that connect
	    to computers over serial lines.  They are called
	    <quote>dumb</quote> because they have only enough
	    computational power to display, send, and receive text.
	    No programs can be run on these devices.  Instead, dumb
	    terminals connect to a computer that runs the needed
	    programs.</para>

	  <para xml:lang="en">There are hundreds of kinds of dumb terminals made by
	    many manufacturers, and just about any kind will work with
	    FreeBSD.  Some high-end terminals can even display graphics,
	    but only certain software packages can take advantage of
	    these advanced features.</para>

	  <para xml:lang="en">Dumb terminals are popular in work environments where
	    workers do not need access to graphical
	    applications.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">Computers Acting as Terminals</term>
	<listitem>
	  <para xml:lang="en">Since a dumb terminal has just enough ability to
	    display, send, and receive text, any spare computer can
	    be a dumb terminal.  All that is needed is the proper
	    cable and some <firstterm>terminal emulation</firstterm>
	    software to run on the computer.</para>

	  <para xml:lang="en">This configuration can be useful.  For example, if one
	    user is busy working at the FreeBSD system's console, another
	    user can do some text-only work at the same time from a
	    less powerful personal computer hooked up as a terminal to
	    the FreeBSD system.</para>

	  <para xml:lang="en">There are at least two utilities in the base-system of
	    FreeBSD that can be used to work through a serial connection:
	    <citerefentry><refentrytitle>cu</refentrytitle><manvolnum>1</manvolnum></citerefentry> and <citerefentry><refentrytitle>tip</refentrytitle><manvolnum>1</manvolnum></citerefentry>.</para>

	  <para xml:lang="en">For example, to connect from a client system that runs
	    FreeBSD to the serial connection of another system:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>cu -l /dev/cuau<replaceable>N</replaceable></userinput></screen>

	  <para xml:lang="en">Ports are numbered starting from zero.  This means that
	    <filename>COM1</filename> is
	    <filename>/dev/cuau0</filename>.</para>

	  <para xml:lang="en">Additional programs are available through the Ports
	    Collection, such as
	    <package>comms/minicom</package>.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">X Terminals</term>
	<listitem>
	  <para xml:lang="en">X terminals are the most sophisticated kind of
	    terminal available.  Instead of connecting to a serial
	    port, they usually connect to a network like Ethernet.
	    Instead of being relegated to text-only applications, they
	    can display any <application>Xorg</application>
	    application.</para>

	  <para xml:lang="en">This chapter does not cover the setup, configuration,
	    or use of X terminals.</para>
	</listitem>
      </varlistentry>
    </variablelist>

    <sect2 xml:id="term-config">
      <title>終端機設定</title>

      <para xml:lang="en">This section describes how to configure a FreeBSD system to
	enable a login session on a serial terminal.  It assumes that
	the system recognizes the serial port to which the terminal is
	connected and that the terminal is connected with the correct
	cable.</para>

      <para xml:lang="en">In FreeBSD, <command>init</command> reads
	<filename>/etc/ttys</filename> and starts a
	<command>getty</command> process on the available terminals.
	The <command>getty</command> process is responsible for
	reading a login name and starting the <command>login</command>
	program.  The ports on the FreeBSD system which allow logins are
	listed in <filename>/etc/ttys</filename>.  For example, the
	first virtual console, <filename>ttyv0</filename>, has an
	entry in this file, allowing logins on the console.  This file
	also contains entries for the other virtual consoles, serial
	ports, and pseudo-ttys.  For a hardwired terminal, the serial
	port's <filename>/dev</filename> entry is listed without the
	<literal>/dev</literal> part.  For example,
	<filename>/dev/ttyv0</filename> is listed as
	<literal>ttyv0</literal>.</para>

      <para xml:lang="en">The default <filename>/etc/ttys</filename> configures
	support for the first four serial ports,
	<filename>ttyu0</filename> through
	<filename>ttyu3</filename>:</para>

      <programlisting xml:lang="en">ttyu0   "/usr/libexec/getty std.9600"   dialup  off secure
ttyu1   "/usr/libexec/getty std.9600"   dialup  off secure
ttyu2   "/usr/libexec/getty std.9600"   dialup  off secure
ttyu3   "/usr/libexec/getty std.9600"   dialup  off secure</programlisting>

      <para xml:lang="en">When attaching a terminal to one of those ports, modify
	the default entry to set the required speed and terminal type,
	to turn the device <literal>on</literal> and, if needed, to
	change the port's <literal>secure</literal> setting.  If the
	terminal is connected to another port, add an entry for the
	port.</para>

      <para xml:lang="en"><xref linkend="ex-etc-ttys"/> configures two terminals in
	<filename>/etc/ttys</filename>.  The first entry configures a
	Wyse-50 connected to <filename>COM2</filename>.  The second
	entry configures an old computer running
	<application>Procomm</application> terminal software emulating
	a VT-100 terminal.  The computer is connected to the sixth
	serial port on a multi-port serial card.</para>

      <example xml:id="ex-etc-ttys">
	<title>設定終端機項目</title>

	<programlisting xml:lang="en">ttyu1<co xml:id="co-ttys-line1col1"/>  "/usr/libexec/getty std.38400"<co xml:id="co-ttys-line1col2"/>  wy50<co xml:id="co-ttys-line1col3"/>  on<co xml:id="co-ttys-line1col4"/>  insecure<co xml:id="co-ttys-line1col5"/>
ttyu5   "/usr/libexec/getty std.19200"  vt100  on insecure</programlisting>

	<calloutlist>
	  <callout arearefs="co-ttys-line1col1">
	    <para xml:lang="en">The first field specifies the device name of the
	      serial terminal.</para>
	  </callout>

	  <callout arearefs="co-ttys-line1col2">
	    <para xml:lang="en">The second field tells <command>getty</command> to
	      initialize and open the line, set the line speed, prompt
	      for a user name, and then execute the
	      <command>login</command> program.  The optional
	      <firstterm>getty type</firstterm> configures
	      characteristics on the terminal line, like
	      <acronym>bps</acronym> rate and parity.  The available
	      getty types are listed in
	      <filename>/etc/gettytab</filename>.  In almost all
	      cases, the getty types that start with
	      <literal>std</literal> will work for hardwired terminals
	      as these entries ignore parity.  There is a
	      <literal>std</literal> entry for each
	      <acronym>bps</acronym> rate from 110 to 115200.  Refer
	      to <citerefentry><refentrytitle>gettytab</refentrytitle><manvolnum>5</manvolnum></citerefentry> for more information.</para>

	    <para xml:lang="en">When setting the getty type, make sure to match the
	      communications settings used by the terminal.  For this
	      example, the Wyse-50 uses no parity and connects at
	      38400 bps.  The computer uses no parity and
	      connects at 19200 bps.</para>
	  </callout>

	  <callout arearefs="co-ttys-line1col3">
	    <para xml:lang="en">The third field is the type of terminal.  For
	      dial-up ports, <literal>unknown</literal> or
	      <literal>dialup</literal> is typically used since users
	      may dial up with practically any type of terminal or
	      software.  Since the terminal type does not change for
	      hardwired terminals, a real terminal type from
	      <filename>/etc/termcap</filename> can be specified.  For
	      this example, the Wyse-50 uses the real terminal type
	      while the computer running
	      <application>Procomm</application> is set to emulate a
	      VT-100.</para>
	  </callout>

	  <callout arearefs="co-ttys-line1col4">
	    <para xml:lang="en">The fourth field specifies if the port should be
	      enabled.  To enable logins on this port, this field must
	      be set to <literal>on</literal>.</para>
	  </callout>

	  <callout arearefs="co-ttys-line1col5">
	    <para xml:lang="en">The final field is used to specify whether the port
	      is secure.  Marking a port as <literal>secure</literal>
	      means that it is trusted enough to allow <systemitem class="username">root</systemitem> to login from that
	      port.  Insecure ports do not allow <systemitem class="username">root</systemitem> logins.  On an
	      insecure port, users must login from unprivileged
	      accounts and then use <command>su</command> or a similar
	      mechanism to gain superuser privileges, as described in
	      <xref linkend="users-superuser"/>.  For security
	      reasons, it is recommended to change this setting to
	      <literal>insecure</literal>.</para>
	  </callout>
	</calloutlist>
      </example>

      <para xml:lang="en">After making any changes to
	<filename>/etc/ttys</filename>, send a SIGHUP (hangup) signal
	to the <command>init</command> process to force it to re-read
	its configuration file:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kill -HUP 1</userinput></screen>

      <para xml:lang="en">Since <command>init</command> is always the first process
	run on a system, it always has a process <acronym>ID</acronym>
	of <literal>1</literal>.</para>

      <para xml:lang="en">If everything is set up correctly, all cables are in
	place, and the terminals are powered up, a
	<command>getty</command> process should now be running on each
	terminal and login prompts should be available on each
	terminal.</para>
    </sect2>

    <sect2 xml:id="term-debug">
      <title>連線疑難排解</title>

      <para xml:lang="en">Even with the most meticulous attention to detail,
	something could still go wrong while setting up a terminal.
	Here is a list of common symptoms and some suggested
	fixes.</para>

      <para xml:lang="en">If no login prompt appears, make sure the terminal is
	plugged in and powered up.  If it is a personal computer
	acting as a terminal, make sure it is running terminal
	emulation software on the correct serial port.</para>

      <para xml:lang="en">Make sure the cable is connected firmly to both the
	terminal and the FreeBSD computer.  Make sure it is the right
	kind of cable.</para>

      <para xml:lang="en">Make sure the terminal and FreeBSD agree on the
	<acronym>bps</acronym> rate and parity settings.  For a video
	display terminal, make sure the contrast and brightness
	controls are turned up.  If it is a printing terminal, make
	sure paper and ink are in good supply.</para>

      <para xml:lang="en">Use <command>ps</command> to make sure that a
	<command>getty</command> process is running and serving the
	terminal.  For example, the following listing shows that a
	<command>getty</command> is running on the second serial port,
	<filename>ttyu1</filename>, and is using the
	<literal>std.38400</literal> entry in
	<filename>/etc/gettytab</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ps -axww|grep ttyu</userinput>
22189  d1  Is+    0:00.03 /usr/libexec/getty std.38400 ttyu1</screen>

      <para xml:lang="en">If no <command>getty</command> process is running, make
	sure the port is enabled in <filename>/etc/ttys</filename>.
	Remember to run <command>kill -HUP 1</command> after modifying
	<filename>/etc/ttys</filename>.</para>

      <para xml:lang="en">If the <command>getty</command> process is running but the
	terminal still does not display a login prompt, or if it
	displays a prompt but will not accept typed input, the
	terminal or cable may not support hardware handshaking.  Try
	changing the entry in <filename>/etc/ttys</filename> from
	<literal>std.38400</literal> to
	<literal>3wire.38400</literal>, then run <command>kill -HUP
	  1</command> after modifying <filename>/etc/ttys</filename>.
	The <literal>3wire</literal> entry is similar to
	<literal>std</literal>, but ignores hardware handshaking.  The
	baud rate may need to be reduced or software flow control
	enabled when using <literal>3wire</literal> to prevent buffer
	overflows.</para>

      <para xml:lang="en">If garbage appears instead of a login prompt, make sure
	the terminal and FreeBSD agree on the <acronym>bps</acronym> rate
	and parity settings.  Check the <command>getty</command>
	processes to make sure the correct
	<replaceable>getty</replaceable> type is in use.  If not, edit
	<filename>/etc/ttys</filename> and run <command>kill
	  -HUP 1</command>.</para>

      <para xml:lang="en">If characters appear doubled and the password appears when
	typed, switch the terminal, or the terminal emulation
	software, from <quote>half duplex</quote> or <quote>local
	  echo</quote> to <quote>full duplex.</quote></para>
    </sect2>
  </sect1>

  <sect1 xml:id="dialup">
    <info>
      <title>撥入服務</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Guy</firstname>
	    <surname>Helmer</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Sean</firstname>
	    <surname>Kelly</surname>
	  </personname>
	  <contrib>Additions by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en"><primary>dial-in service</primary></indexterm>

    <para xml:lang="en">Configuring a FreeBSD system for dial-in service is similar to
      configuring terminals, except that modems are used instead of
      terminal devices.  FreeBSD supports both external and internal
      modems.</para>

    <para xml:lang="en">External modems are more convenient because they often can
      be configured via parameters stored in non-volatile
      <acronym>RAM</acronym> and they usually provide lighted
      indicators that display the state of important
      <acronym>RS-232</acronym> signals, indicating whether the modem
      is operating properly.</para>

    <para xml:lang="en">Internal modems usually lack non-volatile
      <acronym>RAM</acronym>, so their configuration may be limited to
      setting <acronym>DIP</acronym> switches.  If the internal modem
      has any signal indicator lights, they are difficult to view when
      the system's cover is in place.</para>

    <indexterm xml:lang="en"><primary>modem</primary></indexterm>

    <para xml:lang="en">When using an external modem, a proper cable is needed.  A
      standard <acronym>RS-232C</acronym> serial cable should
      suffice.</para>

    <para xml:lang="en">FreeBSD needs the <acronym>RTS</acronym> and
      <acronym>CTS</acronym> signals for flow control at speeds above
      2400 bps, the <acronym>CD</acronym> signal to detect when a
      call has been answered or the line has been hung up, and the
      <acronym>DTR</acronym> signal to reset the modem after a session
      is complete.  Some cables are wired without all of the needed
      signals, so if a login session does not go away when the line
      hangs up, there may be a problem with the cable.  Refer to <xref linkend="term-cables-null"/> for more information about these
      signals.</para>

    <para xml:lang="en">Like other <trademark class="registered">UNIX</trademark>-like operating systems, FreeBSD uses the
      hardware signals to find out when a call has been answered or a
      line has been hung up and to hangup and reset the modem after a
      call.  FreeBSD avoids sending commands to the modem or watching for
      status reports from the modem.</para>

    <para xml:lang="en">FreeBSD supports the <acronym>NS8250</acronym>,
      <acronym>NS16450</acronym>, <acronym>NS16550</acronym>, and
      <acronym>NS16550A</acronym>-based <acronym>RS-232C</acronym>
      (<acronym>CCITT</acronym> V.24) communications interfaces.  The
      8250 and 16450 devices have single-character buffers.  The 16550
      device provides a 16-character buffer, which allows for better
      system performance.  Bugs in plain 16550 devices prevent the use
      of the 16-character buffer, so use 16550A devices if possible.
      Because single-character-buffer devices require more work by the
      operating system than the 16-character-buffer devices,
      16550A-based serial interface cards are preferred.  If the
      system has many active serial ports or will have a heavy load,
      16550A-based cards are better for low-error-rate
      communications.</para>

    <para xml:lang="en">The rest of this section demonstrates how to configure a
      modem to receive incoming connections, how to communicate with
      the modem, and offers some troubleshooting tips.</para>

    <sect2 xml:id="dialup-ttys">
      <title>數據機設定</title>

      <indexterm xml:lang="en"><primary>getty</primary></indexterm>
      <para xml:lang="en">As with terminals, <command>init</command> spawns a
	<command>getty</command> process for each configured serial
	port used for dial-in connections.  When a user dials the
	modem's line and the modems connect, the <quote>Carrier
	  Detect</quote> signal is reported by the modem.  The kernel
	notices that the carrier has been detected and instructs
	<command>getty</command> to open the port and display a
	<prompt>login:</prompt> prompt at the specified initial line
	speed.  In a typical configuration, if garbage characters are
	received, usually due to the modem's connection speed being
	different than the configured speed, <command>getty</command>
	tries adjusting the line speeds until it receives reasonable
	characters.  After the user enters their login name,
	<command>getty</command> executes <command>login</command>,
	which completes the login process by asking for the user's
	password and then starting the user's shell.</para>

      <indexterm xml:lang="en">
	<primary><command>/usr/bin/login</command></primary>
      </indexterm>

      <para xml:lang="en">There are two schools of thought regarding dial-up modems.
	One configuration method is to set the modems and systems so
	that no matter at what speed a remote user dials in, the
	dial-in <acronym>RS-232</acronym> interface runs at a locked
	speed.  The benefit of this configuration is that the remote
	user always sees a system login prompt immediately.  The
	downside is that the system does not know what a user's true
	data rate is, so full-screen programs like
	<application>Emacs</application> will not adjust their
	screen-painting methods to make their response better for
	slower connections.</para>

      <para xml:lang="en">The second method is to configure the
	<acronym>RS-232</acronym> interface to vary its speed based on
	the remote user's connection speed.  Because
	<command>getty</command> does not understand any particular
	modem's connection speed reporting, it gives a
	<prompt>login:</prompt> message at an initial speed and
	watches the characters that come back in response.  If the
	user sees junk, they should press <keycap>Enter</keycap> until
	they see a recognizable prompt.  If the data rates do not
	match, <command>getty</command> sees anything the user types
	as junk, tries the next speed, and gives the
	<prompt>login:</prompt> prompt again.  This procedure normally
	only takes a keystroke or two before the user sees a good
	prompt.  This login sequence does not look as clean as the
	locked-speed method, but a user on a low-speed connection
	should receive better interactive response from full-screen
	programs.</para>

      <para xml:lang="en">When locking a modem's data communications rate at a
	particular speed, no changes to
	<filename>/etc/gettytab</filename> should be needed.  However,
	for a matching-speed configuration, additional entries may be
	required in order to define the speeds to use for the modem.
	This example configures a 14.4 Kbps modem with a top
	interface speed of 19.2 Kbps using 8-bit, no parity
	connections.  It configures <command>getty</command> to start
	the communications rate for a V.32bis connection at
	19.2 Kbps, then cycles through 9600 bps,
	2400 bps, 1200 bps, 300 bps, and back to
	19.2 Kbps.  Communications rate cycling is implemented
	with the <literal>nx=</literal> (next table) capability.  Each
	line uses a <literal>tc=</literal> (table continuation) entry
	to pick up the rest of the settings for a particular data
	rate.</para>

      <programlisting xml:lang="en">#
# Additions for a V.32bis Modem
#
um|V300|High Speed Modem at 300,8-bit:\
        :nx=V19200:tc=std.300:
un|V1200|High Speed Modem at 1200,8-bit:\
        :nx=V300:tc=std.1200:
uo|V2400|High Speed Modem at 2400,8-bit:\
        :nx=V1200:tc=std.2400:
up|V9600|High Speed Modem at 9600,8-bit:\
        :nx=V2400:tc=std.9600:
uq|V19200|High Speed Modem at 19200,8-bit:\
        :nx=V9600:tc=std.19200:</programlisting>

      <para xml:lang="en">For a 28.8 Kbps modem, or to take advantage of
	compression on a 14.4 Kbps modem, use a higher
	communications rate, as seen in this example:</para>

      <programlisting xml:lang="en">#
# Additions for a V.32bis or V.34 Modem
# Starting at 57.6 Kbps
#
vm|VH300|Very High Speed Modem at 300,8-bit:\
        :nx=VH57600:tc=std.300:
vn|VH1200|Very High Speed Modem at 1200,8-bit:\
        :nx=VH300:tc=std.1200:
vo|VH2400|Very High Speed Modem at 2400,8-bit:\
        :nx=VH1200:tc=std.2400:
vp|VH9600|Very High Speed Modem at 9600,8-bit:\
        :nx=VH2400:tc=std.9600:
vq|VH57600|Very High Speed Modem at 57600,8-bit:\
        :nx=VH9600:tc=std.57600:</programlisting>

      <para xml:lang="en">For a slow <acronym>CPU</acronym> or a heavily loaded
	system without 16550A-based serial ports, this configuration
	may produce <errorname>sio</errorname>
	<quote>silo</quote> errors at 57.6 Kbps.</para>

      <indexterm xml:lang="en">
	<primary><filename>/etc/ttys</filename></primary>
      </indexterm>

      <para xml:lang="en">The configuration of <filename>/etc/ttys</filename> is
	similar to <xref linkend="ex-etc-ttys"/>, but a different
	argument is passed to <command>getty</command> and
	<literal>dialup</literal> is used for the terminal type.
	Replace <replaceable>xxx</replaceable> with the process
	<command>init</command> will run on the device:</para>

      <programlisting xml:lang="en">ttyu0   "/usr/libexec/getty <replaceable>xxx</replaceable>"   dialup on</programlisting>

      <para xml:lang="en">The <literal>dialup</literal> terminal type can be
	changed.  For example, setting <literal>vt102</literal> as the
	default terminal type allows users to use
	<acronym>VT102</acronym> emulation on their remote
	systems.</para>

      <para xml:lang="en">For a locked-speed configuration, specify the speed with
	a valid type listed in <filename>/etc/gettytab</filename>.
	This example is for a modem whose port speed is locked at
	19.2 Kbps:</para>

      <programlisting xml:lang="en">ttyu0   "/usr/libexec/getty std.<replaceable>19200</replaceable>"   dialup on</programlisting>

      <para xml:lang="en">In a matching-speed configuration, the entry needs to
	reference the appropriate beginning <quote>auto-baud</quote>
	entry in <filename>/etc/gettytab</filename>.  To continue the
	example for a matching-speed modem that starts at
	19.2 Kbps, use this entry:</para>

      <programlisting xml:lang="en">ttyu0   "/usr/libexec/getty V19200"   dialup on</programlisting>

      <para xml:lang="en">After editing <filename>/etc/ttys</filename>, wait until
	the modem is properly configured and connected before
	signaling <command>init</command>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kill -HUP 1</userinput></screen>

      <indexterm xml:lang="en">
	<primary>rc files</primary>
	<secondary><filename>rc.serial</filename></secondary>
      </indexterm>

      <para xml:lang="en">High-speed modems, like <acronym>V.32</acronym>,
	<acronym>V.32bis</acronym>, and <acronym>V.34</acronym>
	modems, use hardware (<literal>RTS/CTS</literal>) flow
	control.  Use <command>stty</command> to set the hardware flow
	control flag for the modem port.  This example sets the
	<varname>crtscts</varname> flag on <filename>COM2</filename>'s
	dial-in and dial-out initialization devices:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>stty -f /dev/ttyu1.init crtscts</userinput>
<prompt>#</prompt> <userinput>stty -f /dev/cuau1.init crtscts</userinput></screen>
    </sect2>

<!--
Comment out for now. If this is still needed, the example should
either be updated or the section modified to be more generic
e.g. refer to the modem's manual
    <sect2>
      <title>Modem Settings</title>

      <para>For a modem whose parameters may be permanently set in
	non-volatile RAM, a terminal program such as
	<command>tip</command> can be used to set the parameters.
	Connect to the modem using the same communications speed as
	the initial speed <command>getty</command> will use and
	configure the modem's non-volatile RAM to match these
	requirements:</para>

      <itemizedlist>
	<listitem>
	  <para><acronym>CD</acronym> asserted when connected.</para>
	</listitem>

	<listitem>
	  <para><acronym>DTR</acronym> asserted for operation and
	    dropping DTR hangs up the line and resets the
	    modem.</para>
	</listitem>

	<listitem>
	  <para><acronym>CTS</acronym> transmitted data flow
	    control.</para>
	</listitem>

	<listitem>
	  <para>Disable <acronym>XON/XOFF</acronym> flow
	    control.</para>
	</listitem>

	<listitem>
	  <para><acronym>RTS</acronym> received data flow
	    control.</para>
	</listitem>

	<listitem>
	  <para>Quiet mode (no result codes).</para>
	</listitem>

	<listitem>
	  <para>No command echo.</para>
	</listitem>
      </itemizedlist>

      <para>Read the documentation for the modem to find out
	which commands and/or DIP switch settings are needed.</para>

      <para>For example, to set the above parameters on a &usrobotics;
	&sportster; 14,400 external modem, give these commands to
	the modem:</para>

      <programlisting>ATZ
AT&amp;C1&amp;D2&amp;H1&amp;I0&amp;R2&amp;W</programlisting>

      <para>Other settings can be adjusted in the modem, such as
	whether it will use V.42bis and/or MNP5 compression.</para>

      <para>The &usrobotics; &sportster; 14,400 external modem also
	has some DIP switches that need to be set.  Other modems,
	may need these settings:</para>

      <itemizedlist>
	<listitem>
	  <para>Switch 1: UP &mdash; DTR Normal</para>
	</listitem>

	<listitem>
	  <para>Switch 2: N/A (Verbal Result Codes/Numeric Result
	    Codes)</para>
	</listitem>

	<listitem>
	  <para>Switch 3: UP &mdash; Suppress Result Codes</para>
	</listitem>

	<listitem>
	  <para>Switch 4: DOWN &mdash; No echo, offline
	    commands</para>
	</listitem>

	<listitem>
	  <para>Switch 5: UP &mdash; Auto Answer</para>
	</listitem>

	<listitem>
	  <para>Switch 6: UP &mdash; Carrier Detect Normal</para>
	</listitem>

	<listitem>
	  <para>Switch 7: UP &mdash; Load NVRAM Defaults</para>
	</listitem>

	<listitem>
	  <para>Switch 8: N/A (Smart Mode/Dumb Mode)</para>
	</listitem>
      </itemizedlist>

      <para>Result codes should be disabled/suppressed for dial-up
	modems to avoid problems that can occur if
	<command>getty</command> mistakenly gives a
	<prompt>login:</prompt> prompt to a modem that is in command
	mode and the modem echoes the command or returns a result
	code.  This sequence can result in an extended, silly
	conversation between <command>getty</command> and the
	modem.</para>

      <para>For a locked-speed configuration, configure the modem to
	maintain a constant modem-to-computer data rate independent
	of the communications rate.  On a &usrobotics; &sportster;
	14,400 external modem, these commands will lock the
	modem-to-computer data rate at the speed used to issue the
	commands:</para>

      <programlisting>ATZ
AT&amp;B1&amp;W</programlisting>

      <para>For a variable-speed configuration, configure the modem
	to adjust its serial port data rate to match the incoming
	call rate.  On a &usrobotics; &sportster; 14,400 external
	modem, these commands will lock the modem's error-corrected
	data rate to the speed used to issue the commands, while
	allowing the serial port rate to vary for
	non-error-corrected connections:</para>

      <programlisting>ATZ
AT&amp;B2&amp;W</programlisting>

      <para>Most high-speed modems provide commands to view the
	modem's current operating parameters in a somewhat
	human-readable fashion.  On the &usrobotics; &sportster;
	14,400 external modem, <command>ATI5</command> displays the
	settings that are stored in the non-volatile RAM.  To see the
	true operating parameters of the modem, as influenced by the
	modem's DIP switch settings, use <command>ATZ</command> and
	then <command>ATI4</command>.</para>

      <para>For a different brand of modem, check the modem's manual
	to see how to double-check the modem's configuration
	parameters.</para>
    </sect2>
    -->

    <sect2>
      <title>疑難排解</title>

      <para xml:lang="en">This section provides a few tips for troubleshooting a
	dial-up modem that will not connect to a FreeBSD system.</para>

      <para xml:lang="en">Hook up the modem to the FreeBSD system and boot the system.
	If the modem has status indication lights, watch to see
	whether the modem's <acronym>DTR</acronym> indicator lights
	when the <prompt>login:</prompt> prompt appears on the
	system's console.  If it lights up, that should mean that FreeBSD
	has started a <command>getty</command> process on the
	appropriate communications port and is waiting for the modem
	to accept a call.</para>

      <para xml:lang="en">If the <acronym>DTR</acronym> indicator does not light,
	login to the FreeBSD system through the console and type
	<command>ps ax</command> to see if FreeBSD is running a
	<command>getty</command> process on the correct port:</para>

      <screen xml:lang="en">  114 ??  I      0:00.10 /usr/libexec/getty V19200 <replaceable>ttyu0</replaceable></screen>

      <para xml:lang="en">If the second column contains a <literal>d0</literal>
	instead of a <literal>??</literal> and the modem has not
	accepted a call yet, this means that <command>getty</command>
	has completed its open on the communications port.  This could
	indicate a problem with the cabling or a misconfigured modem
	because <command>getty</command> should not be able to open
	the communications port until the carrier detect signal has
	been asserted by the modem.</para>

      <para xml:lang="en">If no <command>getty</command> processes are waiting to
	open the port, double-check that the entry for the port is
	correct in <filename>/etc/ttys</filename>.  Also, check
	<filename>/var/log/messages</filename> to see if there are
	any log messages from <command>init</command> or
	<command>getty</command>.</para>

      <para xml:lang="en">Next, try dialing into the system.  Be sure to use 8 bits,
	no parity, and 1 stop bit on the remote system.  If a prompt
	does not appear right away, or the prompt shows garbage, try
	pressing <keycap>Enter</keycap> about once per second.  If
	there is still no <prompt>login:</prompt> prompt,
	try sending a <command>BREAK</command>.  When using a
	high-speed modem, try dialing again after locking the
	dialing modem's interface speed.</para>

      <para xml:lang="en">If there is still no <prompt>login:</prompt> prompt, check
	<filename>/etc/gettytab</filename> again and double-check
	that:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">The initial capability name specified in the entry in
	    <filename>/etc/ttys</filename> matches the name of a
	    capability in <filename>/etc/gettytab</filename>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Each <literal>nx=</literal> entry matches another
	    <filename>gettytab</filename> capability name.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Each <literal>tc=</literal> entry matches another
	    <filename>gettytab</filename> capability name.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">If the modem on the FreeBSD system will not answer, make
	sure that the modem is configured to answer the phone when
	<acronym>DTR</acronym> is asserted.  If the modem seems to be
	configured correctly, verify that the
	<acronym>DTR</acronym> line is asserted by checking the
	modem's indicator lights.</para>

      <para xml:lang="en">If it still does not work, try sending an email
	to the <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-questions">FreeBSD general questions mailing list</link> describing the modem and the
	problem.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="dialout">
    <title>撥出服務</title>

    <indexterm xml:lang="en"><primary>dial-out service</primary></indexterm>

    <para xml:lang="en">The following are tips for getting the host to connect over
      the modem to another computer.  This is appropriate for
      establishing a terminal session with a remote host.</para>

    <para xml:lang="en">This kind of connection can be helpful to get a file on the
      Internet if there are problems using PPP.  If PPP is not
      working, use the terminal session to FTP the needed file.  Then
      use zmodem to transfer it to the machine.</para>

    <sect2 xml:id="hayes-unsupported">
      <title>使用 Stock Hayes 數據機</title>

      <para xml:lang="en">A generic Hayes dialer is built into
	<command>tip</command>.  Use <literal>at=hayes</literal> in
	<filename>/etc/remote</filename>.</para>

      <para xml:lang="en">The Hayes driver is not smart enough to recognize some of
	the advanced features of newer modems messages like
	<literal>BUSY</literal>, <literal>NO DIALTONE</literal>, or
	<literal>CONNECT 115200</literal>.  Turn those messages off
	when using <command>tip</command> with
	<command>ATX0&amp;W</command>.</para>

      <para xml:lang="en">The dial timeout for <command>tip</command> is 60
	seconds.  The modem should use something less, or else
	<command>tip</command> will think there is a communication
	problem.  Try <command>ATS7=45&amp;W</command>.</para>
    </sect2>

    <sect2 xml:id="direct-at">
      <title>使用 <literal>AT</literal> 指令</title>

      <indexterm xml:lang="en">
	<primary><filename>/etc/remote</filename></primary>
      </indexterm>
      <para xml:lang="en">Create a <quote>direct</quote> entry in
	<filename>/etc/remote</filename>.  For example, if the modem
	is hooked up to the first serial port,
	<filename>/dev/cuau0</filename>, use the following
	line:</para>

      <programlisting xml:lang="en">cuau0:dv=/dev/cuau0:br#19200:pa=none</programlisting>

      <para xml:lang="en">Use the highest <acronym>bps</acronym> rate the modem
	supports in the <literal>br</literal> capability.  Then, type
	<command>tip cuau0</command> to connect to the modem.</para>

      <para xml:lang="en">Or, use <command>cu</command> as <systemitem class="username">root</systemitem> with the following
	      command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cu -l<replaceable>line</replaceable> -s<replaceable>speed</replaceable></userinput></screen>

      <para xml:lang="en"><replaceable>line</replaceable> is the serial port, such
	as <filename>/dev/cuau0</filename>, and
	<replaceable>speed</replaceable> is the speed, such as
	<literal>57600</literal>.  When finished entering the AT
	commands, type <command>~.</command> to exit.</para>
    </sect2>

    <sect2 xml:id="gt-failure">
      <title><literal>@</literal> 符號無法運作</title>

      <para xml:lang="en">The <literal>@</literal> sign in the phone number
	capability tells <command>tip</command> to look in
	<filename>/etc/phones</filename> for a phone number.  But, the
	<literal>@</literal> sign is also a special character in
	capability files like <filename>/etc/remote</filename>, so it
	needs to be escaped with a backslash:</para>

      <programlisting xml:lang="en">pn=\@</programlisting>
    </sect2>

    <sect2 xml:id="dial-command-line">
      <title>從指令列撥號</title>

      <para xml:lang="en">Put a <quote>generic</quote> entry in
	<filename>/etc/remote</filename>.  For example:</para>

      <programlisting xml:lang="en">tip115200|Dial any phone number at 115200 bps:\
        :dv=/dev/cuau0:br#115200:at=hayes:pa=none:du:
tip57600|Dial any phone number at 57600 bps:\
        :dv=/dev/cuau0:br#57600:at=hayes:pa=none:du:</programlisting>

      <para xml:lang="en">This should now work:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>tip -115200 5551234</userinput></screen>

      <para xml:lang="en">Users who prefer <command>cu</command> over
	<command>tip</command>, can use a generic
	<literal>cu</literal> entry:</para>

      <programlisting xml:lang="en">cu115200|Use cu to dial any number at 115200bps:\
        :dv=/dev/cuau1:br#57600:at=hayes:pa=none:du:</programlisting>

      <para xml:lang="en">and type:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cu 5551234 -s 115200</userinput></screen>
    </sect2>

    <sect2 xml:id="set-bps">
      <title>設定 <acronym>bps</acronym> 率</title>

      <para xml:lang="en">Put in an entry for <literal>tip1200</literal> or
	<literal>cu1200</literal>, but go ahead and use whatever
	<acronym>bps</acronym> rate is appropriate with the
	<literal>br</literal> capability.
	<command>tip</command> thinks a good default is 1200 bps
	which is why it looks for a <literal>tip1200</literal> entry.
	1200 bps does not have to be used, though.</para>
    </sect2>

    <sect2 xml:id="terminal-server">
      <title>透過終端伺服器存取多個主機</title>

      <para xml:lang="en">Rather than waiting until connected and typing
	<command>CONNECT <replaceable>host</replaceable></command>
	each time, use <command>tip</command>'s <literal>cm</literal>
	capability.  For example, these entries in
	<filename>/etc/remote</filename> will let you type
	<command>tip pain</command> or <command>tip muffin</command>
	to connect to the hosts <systemitem>pain</systemitem> or
	<systemitem>muffin</systemitem>, and <command>tip
	  deep13</command> to connect to the terminal server.</para>

      <programlisting xml:lang="en">pain|pain.deep13.com|Forrester's machine:\
        :cm=CONNECT pain\n:tc=deep13:
muffin|muffin.deep13.com|Frank's machine:\
        :cm=CONNECT muffin\n:tc=deep13:
deep13:Gizmonics Institute terminal server:\
        :dv=/dev/cuau2:br#38400:at=hayes:du:pa=none:pn=5551234:</programlisting>

    </sect2>

    <sect2 xml:id="tip-multiline">
      <title>在 <command>tip</command> 使用超過一行</title>

      <para xml:lang="en">This is often a problem where a university has several
	modem lines and several thousand students trying to use
	them.</para>

      <para xml:lang="en">Make an entry in <filename>/etc/remote</filename> and use
	<literal>@</literal> for the <literal>pn</literal>
	capability:</para>

      <programlisting xml:lang="en">big-university:\
        :pn=\@:tc=dialout
dialout:\
        :dv=/dev/cuau3:br#9600:at=courier:du:pa=none:</programlisting>

      <para xml:lang="en">Then, list the phone numbers in
	<filename>/etc/phones</filename>:</para>

      <programlisting xml:lang="en">big-university 5551111
big-university 5551112
big-university 5551113
big-university 5551114</programlisting>

      <para xml:lang="en"><command>tip</command> will try each number in the listed
	order, then give up.  To keep retrying, run
	<command>tip</command> in a <literal>while</literal>
	loop.</para>
    </sect2>

    <sect2 xml:id="multi-controlp">
      <title>使用強制字元</title>

      <para xml:lang="en"><keycombo action="simul">
	  <keycap>Ctrl</keycap>
	  <keycap>P</keycap>
	</keycombo> is the default <quote>force</quote> character,
	used to tell <command>tip</command> that the next character is
	literal data.  The force character can be set to any other
	character with the <command>~s</command> escape, which means
	<quote>set a variable.</quote></para>

      <para xml:lang="en">Type
	<command>~sforce=<replaceable>single-char</replaceable></command>
	followed by a newline.  <replaceable>single-char</replaceable>
	is any single character.  If
	<replaceable>single-char</replaceable> is left out, then the
	force character is the null character, which is accessed by
	typing
	<keycombo action="simul">
	  <keycap>Ctrl</keycap><keycap>2</keycap>
	</keycombo>
	or <keycombo action="simul">
	  <keycap>Ctrl</keycap><keycap>Space</keycap>
	</keycombo>.  A pretty good value for
	<replaceable>single-char</replaceable> is
	<keycombo action="simul">
	  <keycap>Shift</keycap>
	  <keycap>Ctrl</keycap>
	  <keycap>6</keycap>
	</keycombo>, which is only used on some terminal
	servers.</para>

      <para xml:lang="en">To change the force character, specify the following in
	<filename>~/.tiprc</filename>:</para>

      <programlisting xml:lang="en">force=<replaceable>single-char</replaceable></programlisting>
    </sect2>

    <sect2 xml:id="uppercase">
      <title>大寫字元</title>

      <para xml:lang="en">This happens when
	<keycombo action="simul">
	  <keycap>Ctrl</keycap>
	  <keycap>A</keycap>
	</keycombo> is pressed, which is <command>tip</command>'s
	<quote>raise character</quote>, specially designed for people
	with broken caps-lock keys.  Use <command>~s</command> to set
	<literal>raisechar</literal> to something reasonable.  It can
	be set to be the same as the force character, if neither
	feature is used.</para>

      <para xml:lang="en">Here is a sample <filename>~/.tiprc</filename> for
	<application>Emacs</application> users who need to type
	<keycombo action="simul">
	  <keycap>Ctrl</keycap>
	  <keycap>2</keycap>
	</keycombo> and <keycombo action="simul">
	  <keycap>Ctrl</keycap>
	  <keycap>A</keycap>
	</keycombo>:</para>

    <programlisting xml:lang="en">force=^^
raisechar=^^</programlisting>

      <para xml:lang="en">The <literal>^^</literal> is
	<keycombo action="simul">
	  <keycap>Shift</keycap><keycap>Ctrl</keycap><keycap>6</keycap>
	  </keycombo>.</para>

    </sect2>

    <sect2 xml:id="tip-filetransfer">
      <title>使用 <command>tip</command> 傳輸檔案</title>

      <para xml:lang="en">When talking to another <trademark class="registered">UNIX</trademark>-like operating system,
	files can be sent and received using <command>~p</command>
	(put) and <command>~t</command> (take).  These commands run
	<command>cat</command> and <command>echo</command> on the
	remote system to accept and send files.  The syntax is:</para>

      <cmdsynopsis xml:lang="en">
	<command>~p</command>
	<arg choice="plain">local-file</arg>
	<arg choice="opt">remote-file</arg>
      </cmdsynopsis>

      <cmdsynopsis xml:lang="en">
	<command>~t</command>
	<arg choice="plain">remote-file</arg>
	<arg choice="opt">local-file</arg>
      </cmdsynopsis>

      <para xml:lang="en">There is no error checking, so another protocol, like
	zmodem, should probably be used.</para>
    </sect2>

    <sect2 xml:id="zmodem-tip">
      <title>在 <application>zmodem</application> 使用 <command>tip</command>?</title>

      <para xml:lang="en">To receive files, start the sending program on the remote
	end.  Then, type <command>~C rz</command> to begin receiving
	them locally.</para>

      <para xml:lang="en">To send files, start the receiving program on the remote
	end.  Then, type <command>~C sz
	<replaceable>files</replaceable></command> to send them to the
	remote system.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="serialconsole-setup">
    <info>
      <title>設定序列 Console</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Kazutaka</firstname>
	    <surname>YOKOTA</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Bill</firstname>
	    <surname>Paul</surname>
	  </personname>
	  <contrib>Based on a document by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en"><primary>serial console</primary></indexterm>

    <para xml:lang="en">FreeBSD has the ability to boot a system with a dumb
      terminal on a serial port as a console.  This configuration is
      useful for system administrators who wish to install FreeBSD on
      machines that have no keyboard or monitor attached, and
      developers who want to debug the kernel or device
      drivers.</para>

    <para xml:lang="en">As described in <xref linkend="boot"/>, FreeBSD employs a three
      stage bootstrap.  The first two stages are in the boot block
      code which is stored at the beginning of the FreeBSD slice on the
      boot disk.  The boot block then loads and runs the boot loader
      as the third stage code.</para>

    <para xml:lang="en">In order to set up booting from a serial console, the boot
      block code, the boot loader code, and the kernel need to be
      configured.</para>

    <sect2 xml:id="serialconsole-howto-fast">
      <title>快速序列 Console 設定</title>

      <para xml:lang="en">This section provides a fast overview of setting up the
	serial console.  This procedure can be used when the dumb
	terminal is connected to <filename>COM1</filename>.</para>

      <procedure>
	<title xml:lang="en">Configuring a Serial Console on
	  <filename>COM1</filename></title>

	<step>
	  <para xml:lang="en">Connect the serial cable to
	    <filename>COM1</filename> and the controlling
	    terminal.</para>
	</step>

	<step>
	  <para xml:lang="en">To configure boot messages to display on the serial
	    console, issue the following command as the
	    superuser:</para>

	  <screen xml:lang="en"><prompt>#</prompt> sysrc -f /boot/loader.conf console=comconsole</screen>
	</step>

	<step>
	  <para xml:lang="en">Edit <filename>/etc/ttys</filename> and change
	    <literal>off</literal> to <literal>on</literal> and
	    <literal>dialup</literal> to <literal>vt100</literal> for
	    the <filename>ttyu0</filename> entry.  Otherwise, a
	    password will not be required to connect via the serial
	    console, resulting in a potential security hole.</para>
	</step>

	<step>
	  <para xml:lang="en">Reboot the system to see if the changes took
	    effect.</para>
	</step>

      </procedure>

      <para xml:lang="en">If a different configuration is required, see the next
	section for a more in-depth configuration explanation.</para>
    </sect2>

    <sect2 xml:id="serialconsole-howto">
      <title>深入序列 Console 設定</title>

      <para xml:lang="en">This section provides a more detailed explanation of the
	steps needed to setup a serial console in FreeBSD.</para>

      <procedure>
	<title xml:lang="en">Configuring a Serial Console</title>

	<step>
	  <para xml:lang="en">Prepare a serial cable.</para>

	  <indexterm xml:lang="en"><primary>null-modem cable</primary></indexterm>

	  <para xml:lang="en">Use either a null-modem cable or a standard serial
	    cable and a null-modem adapter.  See <xref linkend="term-cables-null"/> for a discussion on serial
	    cables.</para>
	</step>

	<step>
	  <para xml:lang="en">Unplug the keyboard.</para>

	  <para xml:lang="en">Many systems probe for the keyboard during the
	    Power-On Self-Test (<acronym>POST</acronym>) and will
	    generate an error if the keyboard is not detected.  Some
	    machines will refuse to boot until the keyboard is plugged
	    in.</para>

	  <para xml:lang="en">If the computer complains about the error, but boots
	    anyway, no further configuration is needed.</para>

	  <para xml:lang="en">If the computer refuses to boot without a keyboard
	    attached, configure the <acronym>BIOS</acronym> so that it
	    ignores this error.  Consult the motherboard's manual for
	    details on how to do this.</para>

	  <tip>
	    <para xml:lang="en">Try setting the keyboard to <quote>Not
		installed</quote> in the <acronym>BIOS</acronym>.
	      This setting tells the <acronym>BIOS</acronym> not to
	      probe for a keyboard at power-on so it should not
	      complain if the keyboard is absent.  If that option is
	      not present in the <acronym>BIOS</acronym>, look for an
	      <quote>Halt on Error</quote> option instead.  Setting
	      this to <quote>All but Keyboard</quote> or to <quote>No
		Errors</quote> will have the same effect.</para>
	  </tip>

	  <para xml:lang="en">If the system has a <trademark class="registered">PS/2</trademark> mouse, unplug it as well.
	    <trademark class="registered">PS/2</trademark> mice share some hardware with the keyboard and
	    leaving the mouse plugged in can fool the keyboard probe
	    into thinking the keyboard is still there.</para>

	  <note>
	    <para xml:lang="en">While most systems will boot without a keyboard,
	      quite a few will not boot without a graphics adapter.
	      Some systems can be configured to  boot with no graphics
	      adapter by changing the <quote>graphics adapter</quote>
	      setting in the <acronym>BIOS</acronym> configuration to
	      <quote>Not installed</quote>.  Other systems do not
	      support this option and will refuse to boot if there is
	      no display hardware in the system.  With these machines,
	      leave some kind of graphics card plugged in, even if it
	      is just a junky mono board.  A monitor does not need to
	      be attached.</para>
	  </note>
	</step>

	<step>
	  <para xml:lang="en">Plug a dumb terminal, an old computer with a modem
	    program, or the serial port on another <trademark class="registered">UNIX</trademark> box into the
	    serial port.</para>
	</step>

	<step>
	  <para xml:lang="en">Add the appropriate <literal>hint.sio.*</literal>
	    entries to <filename>/boot/device.hints</filename> for the
	    serial port.  Some multi-port cards also require kernel
	    configuration options.  Refer to <citerefentry><refentrytitle>sio</refentrytitle><manvolnum>4</manvolnum></citerefentry> for the
	    required options and device hints for each supported
	    serial port.</para>
	</step>

	<step>
	  <para xml:lang="en">Create <filename>boot.config</filename> in the root
	    directory of the <literal>a</literal> partition on the
	    boot drive.</para>

	  <para xml:lang="en">This file instructs the boot block code how to boot
	    the system.  In order to activate the serial console, one
	    or more of the following options are needed.  When using
	    multiple options, include them all on the same
	    line:</para>

	  <variablelist>
	    <varlistentry>
	      <term xml:lang="en"><option>-h</option></term>

	      <listitem>
		<para xml:lang="en">Toggles between the internal and serial
		  consoles.  Use this to switch console devices.  For
		  instance, to boot from the internal (video) console,
		  use <option>-h</option> to direct the boot loader
		  and the kernel to use the serial port as its console
		  device.  Alternatively, to boot from the serial
		  port, use <option>-h</option> to tell the boot
		  loader and the kernel to use the video display as
		  the console instead.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en"><option>-D</option></term>

	      <listitem>
		<para xml:lang="en">Toggles between the single and dual console
		  configurations.  In the single configuration, the
		  console will be either the internal console (video
		  display) or the serial port, depending on the state
		  of <option>-h</option>.  In the dual console
		  configuration, both the video display  and the
		  serial port will become the console at the same
		  time, regardless of the state of
		  <option>-h</option>.  However, the dual console
		  configuration takes effect only while the boot
		  block is running.  Once the boot loader gets
		  control, the console specified by
		  <option>-h</option> becomes the only
		  console.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en"><option>-P</option></term>

	      <listitem>
		<para xml:lang="en">Makes the boot block probe the keyboard.  If no
		  keyboard is found, the <option>-D</option> and
		  <option>-h</option> options are automatically
		  set.</para>

		<note>
		  <para xml:lang="en">Due to space constraints in the current
		    version of the boot blocks, <option>-P</option> is
		    capable of detecting extended keyboards only.
		    Keyboards with less than 101 keys and without F11
		    and F12 keys may not be detected.  Keyboards on
		    some laptops may not be properly found because of
		    this limitation.  If this is the case, do not use
		    <option>-P</option>.</para>
		</note>
	      </listitem>
	    </varlistentry>
	  </variablelist>

	  <para xml:lang="en">Use either <option>-P</option> to select the console
	    automatically or <option>-h</option> to activate the
	    serial console.  Refer to <citerefentry><refentrytitle>boot</refentrytitle><manvolnum>8</manvolnum></citerefentry> and
	    <citerefentry><refentrytitle>boot.config</refentrytitle><manvolnum>5</manvolnum></citerefentry> for more details.</para>

	  <para xml:lang="en">The options, except for <option>-P</option>, are
	    passed to the boot loader.  The boot loader will
	    determine whether the internal video or the serial port
	    should become the console by examining the state of
	    <option>-h</option>.  This means that if
	    <option>-D</option> is specified but <option>-h</option>
	    is not specified in <filename>/boot.config</filename>, the
	    serial port can be used as the console only during the
	    boot block as the boot loader will use the internal video
	    display as the console.</para>
	</step>

	<step>
	  <para xml:lang="en">Boot the machine.</para>

	  <para xml:lang="en">When FreeBSD starts, the boot blocks echo the contents of
	    <filename>/boot.config</filename> to the console.  For
	    example:</para>

	  <screen xml:lang="en">/boot.config: -P
Keyboard: no</screen>

	  <para xml:lang="en">The second line appears only if <option>-P</option> is
	    in <filename>/boot.config</filename> and indicates the
	    presence or absence of the keyboard.  These messages go
	    to either the serial or internal console, or both,
	    depending on the option in
	    <filename>/boot.config</filename>:</para>

	  <informaltable frame="none" pgwide="1">
	    <tgroup cols="2">
	      <thead>
		<row>
		  <entry align="left" xml:lang="en">Options</entry>
		  <entry align="left" xml:lang="en">Message goes to</entry>
		</row>
	      </thead>

	      <tbody>
		<row>
		  <entry xml:lang="en">none</entry>
		  <entry xml:lang="en">internal console</entry>
		</row>

		<row>
		  <entry xml:lang="en"><option>-h</option></entry>
		  <entry xml:lang="en">serial console</entry>
		</row>

		<row>
		  <entry xml:lang="en"><option>-D</option></entry>
		  <entry xml:lang="en">serial and internal consoles</entry>
		</row>

		<row>
		  <entry xml:lang="en"><option>-Dh</option></entry>
		  <entry xml:lang="en">serial and internal consoles</entry>
		</row>

		<row>
		  <entry xml:lang="en"><option>-P</option>, keyboard present</entry>
		  <entry xml:lang="en">internal console</entry>
		</row>

		<row>
		  <entry xml:lang="en"><option>-P</option>, keyboard absent</entry>
		  <entry xml:lang="en">serial console</entry>
		</row>
	      </tbody>
	    </tgroup>
	  </informaltable>

	  <para xml:lang="en">After the message, there will be a small pause before
	    the boot blocks continue loading the boot loader and
	    before any further messages are printed to the console.
	    Under normal circumstances, there is no need to interrupt
	    the boot blocks, but one can do so in order to make sure
	    things are set up correctly.</para>

	  <para xml:lang="en">Press any key, other than <keycap>Enter</keycap>, at
	    the console to interrupt the boot process.  The boot
	    blocks will then prompt for further action:</para>

	  <screen xml:lang="en">&gt;&gt; FreeBSD/i386 BOOT
Default: 0:ad(0,a)/boot/loader
boot:</screen>

	  <para xml:lang="en">Verify that the above message appears on either the
	    serial or internal console, or both, according to the
	    options in <filename>/boot.config</filename>.  If the
	    message appears in the correct console, press
	    <keycap>Enter</keycap> to continue the boot
	    process.</para>

	  <para xml:lang="en">If there is no prompt on the serial terminal,
	    something is wrong with the settings.  Enter
	    <option>-h</option> then <keycap>Enter</keycap> or
	    <keycap>Return</keycap> to tell the boot block (and then
	    the boot loader and the kernel) to choose the serial port
	    for the console.  Once the system is up, go back and check
	    what went wrong.</para>
	</step>
      </procedure>

      <para xml:lang="en">During the third stage of the boot process, one can still
	switch between the internal console and the serial console by
	setting appropriate environment variables in the boot loader.
	See <citerefentry><refentrytitle>loader</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more
	information.</para>

      <note>
	<para xml:lang="en">This line in <filename>/boot/loader.conf</filename> or
	  <filename>/boot/loader.conf.local</filename> configures the
	  boot loader and the kernel to send their boot messages to
	  the serial console, regardless of the options in
	  <filename>/boot.config</filename>:</para>

	<programlisting xml:lang="en">console="comconsole"</programlisting>

	<para xml:lang="en">That line should be the first line of
	  <filename>/boot/loader.conf</filename> so that boot messages
	  are displayed on the serial console as early as
	  possible.</para>

	<para xml:lang="en">If that line does not exist, or if it is set to
	  <literal>console="vidconsole"</literal>, the boot loader and
	  the kernel will use whichever console is indicated by
	  <option>-h</option> in the boot block.  See
	  <citerefentry><refentrytitle>loader.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for more information.</para>

	<para xml:lang="en">At the moment, the boot loader has no option
	  equivalent to <option>-P</option> in the boot block, and
	  there is no provision to automatically select the internal
	  console and the serial console based on the presence of the
	  keyboard.</para>
      </note>

      <tip>
	<para xml:lang="en">While it is not required, it is possible to provide a
	  <command>login</command> prompt over the serial line.  To
	  configure this, edit the entry for the serial port in
	  <filename>/etc/ttys</filename> using the instructions in
	  <xref linkend="term-config"/>.  If the speed of the serial
	  port has been changed, change <literal>std.9600</literal> to
	  match the new setting.</para>
      </tip>
    </sect2>

    <sect2>
      <title>設定使用更快的序列埠速度</title>

      <para xml:lang="en">By default, the serial port settings are 9600 baud, 8
	bits, no parity, and 1 stop bit.  To change the default
	console speed, use one of the following options:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Edit <filename>/etc/make.conf</filename> and set
	    <varname>BOOT_COMCONSOLE_SPEED</varname> to the new
	    console speed.  Then, recompile and install the boot
	    blocks and the boot loader:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /sys/boot</userinput>
<prompt>#</prompt> <userinput>make clean</userinput>
<prompt>#</prompt> <userinput>make</userinput>
<prompt>#</prompt> <userinput>make install</userinput></screen>

	  <para xml:lang="en">If the serial console is configured in some other way
	    than by booting with <option>-h</option>, or if the serial
	    console used by the kernel is different from the one used
	    by the boot blocks, add the following option, with the
	    desired speed, to a custom kernel configuration file and
	    compile a new kernel:</para>

	  <programlisting xml:lang="en">options CONSPEED=<replaceable>19200</replaceable></programlisting>
	</listitem>

	<listitem>
	  <para xml:lang="en">Add the
	    <option>-S<replaceable>19200</replaceable></option> boot
	    option to <filename>/boot.config</filename>, replacing
	    <replaceable>19200</replaceable> with the speed to
	    use.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Add the following options to
	    <filename>/boot/loader.conf</filename>.  Replace
	    <replaceable>115200</replaceable> with the speed to
	    use.</para>

	  <programlisting xml:lang="en">boot_multicons="YES"
boot_serial="YES"
comconsole_speed="<replaceable>115200</replaceable>"
console="comconsole,vidconsole"</programlisting>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="serialconsole-ddb">
      <title>從序列線路 (Serial Line) 進入 DDB 除錯程式</title>

      <para xml:lang="en">To configure the ability to drop into the kernel debugger
	from the serial console, add the following options to a custom
	kernel configuration file and compile the kernel using the
	instructions in <xref linkend="kernelconfig"/>.  Note that
	while this is useful for remote diagnostics, it is also
	dangerous if a spurious BREAK is generated on the serial port.
	Refer to <citerefentry><refentrytitle>ddb</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>ddb</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more information
	about the kernel debugger.</para>

      <programlisting xml:lang="en">options BREAK_TO_DEBUGGER
options DDB</programlisting>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="ppp-and-slip">
  <!--
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Jim</firstname>
	<surname>Mock</surname>
	<contrib>Restructured, reorganized, and updated by in Mar 2000</contrib>
      </author>
    </authorgroup>
  </chapterinfo>
  -->

  <title xml:lang="en"><acronym>PPP</acronym></title>

  <sect1 xml:id="ppp-and-slip-synopsis">
    <title>概述</title>

    <indexterm xml:id="ppp-ppp" xml:lang="en">
      <primary><acronym>PPP</acronym></primary>
    </indexterm>

    <para>FreeBSD 支援點對點 (Point-to-Point, <acronym>PPP</acronym>) 通訊協定，可透過撥號數據機用來建立網路或網際網路連線。本章將說明如何設定在 FreeBSD 中以數據機為基礎的通訊服務。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>如何設定、使用 <acronym>PPP</acronym> 連線及排除問題。</para>
      </listitem>
      <listitem>
	<para>如何設定在乙太網路 (Ethernet) 上的 <acronym>PPP</acronym> (<acronym>PPPoE</acronym>)。</para>
      </listitem>
      <listitem>
	<para>如何設定在 <acronym>ATM</acronym> 上的 <acronym>PPP</acronym> (<acronym>PPPoA</acronym>)。</para>
      </listitem>
    </itemizedlist>

    <indexterm xml:lang="en">
      <primary><acronym>PPP</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><acronym>PPP</acronym></primary>
      <secondary>over Ethernet</secondary>
    </indexterm>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>熟悉基本網路術語。</para>
      </listitem>
      <listitem>
	<para>了解撥號連線及 <acronym>PPP</acronym> 的基礎及目的。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="userppp">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Updated and enhanced by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Brian</firstname>
	  <surname>Somers</surname>
	  <contrib>Originally contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Nik</firstname>
	  <surname>Clayton</surname>
	  <contrib>With input from </contrib>
	</author>
	<author>
	  <firstname>Dirk</firstname>
	  <surname>Fr&ouml;mberg</surname>
	</author>
	<author>
	  <firstname>Peter</firstname>
	  <surname>Childs</surname>
	</author>
      </authorgroup>
    </sect1info>
    -->

    <title>設定 <acronym>PPP</acronym></title>

    <para xml:lang="en">FreeBSD provides built-in support for managing dial-up
      <acronym>PPP</acronym> connections using <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  The
      default FreeBSD kernel provides support for
      <filename>tun</filename> which is used to interact with a
      modem hardware.  Configuration is performed by editing at least
      one configuration file, and configuration files containing
      examples are provided.  Finally, <command>ppp</command> is
      used to start and manage connections.</para>

    <para xml:lang="en">In order to use a <acronym>PPP</acronym> connection, the
      following items are needed:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">A dial-up account with an Internet Service Provider
	  (<acronym>ISP</acronym>).</para>
      </listitem>

      <listitem>
	<para xml:lang="en">A dial-up modem.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The dial-up number for the
	  <acronym>ISP</acronym>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The login name and password assigned by the
	  <acronym>ISP</acronym>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The <acronym>IP</acronym> address of one or more
	  <acronym>DNS</acronym> servers.  Normally, the
	  <acronym>ISP</acronym> provides these addresses.  If it did
	  not, FreeBSD can be configured to use
	  <acronym>DNS</acronym> negotiation.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">If any of the required information is missing, contact
      the <acronym>ISP</acronym>.</para>

    <para xml:lang="en">The following information may be supplied by the
      <acronym>ISP</acronym>, but is not necessary:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">The <acronym>IP</acronym> address of the default
	  gateway.  If this information is unknown, the
	  <acronym>ISP</acronym> will automatically provide the
	  correct value during connection setup.  When configuring
	  <acronym>PPP</acronym> on FreeBSD, this address is referred to
	  as <literal>HISADDR</literal>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The subnet mask.  If the <acronym>ISP</acronym> has not
	  provided one, <systemitem class="netmask">255.255.255.255</systemitem> will be used
	  in the <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry> configuration file.</para>
      </listitem>

      <listitem>
	<indexterm xml:id="ppp-static-ip" xml:lang="en">
	  <primary>static <acronym>IP</acronym> address</primary>
	</indexterm>

	<para xml:lang="en">If the <acronym>ISP</acronym> has assigned a static
	  <acronym>IP</acronym> address and hostname, it should be
	  input into the configuration file.  Otherwise, this
	  information will be automatically provided during
	  connection setup.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">The rest of this section demonstrates how to configure FreeBSD
      for common <acronym>PPP</acronym> connection scenarios.  The
      required configuration file is
      <filename>/etc/ppp/ppp.conf</filename> and additional files and
      examples are available in
      <filename>/usr/share/examples/ppp/</filename>.</para>

    <note>
      <para xml:lang="en">Throughout this section, many of the file examples
	display line numbers.  These line numbers have been added to
	make it easier to follow the discussion and are not meant to
	be placed in the actual file.</para>

      <para xml:lang="en">When editing a configuration file, proper indentation is
	important.  Lines that end in a <literal>:</literal> start in
	the first column (beginning of the line) while all other lines
	should be indented as shown using spaces or tabs.</para>
    </note>

    <sect2 xml:id="userppp-staticIP">
      <title>基礎設定</title>

      <indexterm xml:lang="en">
	<primary>PPP</primary>
	  <secondary>with static <acronym>IP</acronym>
	    addresses</secondary>
      </indexterm>

      <para xml:lang="en">In order to configure a <acronym>PPP</acronym> connection,
	first edit <filename>/etc/ppp/ppp.conf</filename> with the
	dial-in information for the <acronym>ISP</acronym>.  This file
	is described as follows:</para>

      <programlisting xml:lang="en">1     default:
2       set log Phase Chat LCP IPCP CCP tun command
3       ident user-ppp VERSION
4       set device /dev/cuau0
5       set speed 115200
6       set dial "ABORT BUSY ABORT NO\\sCARRIER TIMEOUT 5 \
7                 \"\" AT OK-AT-OK ATE1Q0 OK \\dATDT\\T TIMEOUT 40 CONNECT"
8       set timeout 180
9       enable dns
10
11    provider:
12      set phone "(123) 456 7890"
13      set authname foo
14      set authkey bar
15      set timeout 300
16      set ifaddr <replaceable>x.x.x.x</replaceable>/0 <replaceable>y.y.y.y</replaceable>/0 255.255.255.255 0.0.0.0
17      add default HISADDR</programlisting>

	  <variablelist>
	    <varlistentry>
	      <term xml:lang="en">Line 1:</term>

	      <listitem>
		<para xml:lang="en">Identifies the <literal>default</literal> entry.
		  Commands in this entry (lines 2 through 9) are
		  executed automatically when <command>ppp</command>
		  is run.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 2:</term>

	      <listitem>
		<para xml:lang="en">Enables verbose logging parameters for testing
		  the connection.  Once the configuration is working
		  satisfactorily, this line should be reduced
		  to:</para>

		  <programlisting xml:lang="en">set log phase tun</programlisting>

	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 3:</term>

	      <listitem>
		<para xml:lang="en">Displays the version of <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry> to the
		  <acronym>PPP</acronym> software running on the other
		  side of the  connection.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 4:</term>

	      <listitem>
		<para xml:lang="en">Identifies the device to which the modem is
		  connected, where  <filename>COM1</filename> is
		  <filename>/dev/cuau0</filename> and
		  <filename>COM2</filename> is
		  <filename>/dev/cuau1</filename>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 5:</term>

	      <listitem>
		<para xml:lang="en">Sets the connection speed.  If
		  <literal>115200</literal> does not work on an older
		  modem, try <literal>38400</literal> instead.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Lines 6 &amp; 7:</term>

	      <listitem>
		<para xml:lang="en">The dial string written as an expect-send
		  syntax.  Refer to <citerefentry><refentrytitle>chat</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more
		  information.</para>

		<para xml:lang="en">Note that this command continues onto the next
		  line for readability.  Any command in
		  <filename>ppp.conf</filename> may do this if the
		  last character on the line is
		  <literal>\</literal>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 8:</term>

	      <listitem>
		<para xml:lang="en">Sets the idle timeout for the link in
		  seconds.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 9:</term>

	      <listitem>
		<para xml:lang="en">Instructs the peer to confirm the
		  <acronym>DNS</acronym> settings.  If the local
		  network is running its own <acronym>DNS</acronym>
		  server, this line should be commented out, by adding
		  a <literal>#</literal> at the beginning of the line,
		  or removed.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 10:</term>

	      <listitem>
		<para xml:lang="en">A blank line for readability.  Blank lines are
		  ignored by <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 11:</term>

	      <listitem>
		<para xml:lang="en">Identifies an entry called
		  <literal>provider</literal>.  This could be changed
		  to the name of the <acronym>ISP</acronym> so that
		  <option>load
		    <replaceable>ISP</replaceable></option> can be
		  used to start the connection.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 12:</term>

	      <listitem>
		<para xml:lang="en">Use the phone number for the
		  <acronym>ISP</acronym>.  Multiple phone numbers may
		  be specified using the colon (<literal>:</literal>)
		  or pipe character (<literal>|</literal>) as a
		  separator.  To rotate through the numbers, use a
		  colon.  To always attempt to dial the first number
		  first and only use the other numbers if the first
		  number fails, use the pipe character.  Always
		  enclose the entire set of phone numbers between
		  quotation marks (<literal>"</literal>) to prevent
		  dialing failures.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Lines 13 &amp; 14:</term>

	      <listitem>
		<para xml:lang="en">Use the user name and password for the
		  <acronym>ISP</acronym>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 15:</term>

	      <listitem>
		<para xml:lang="en">Sets the default idle timeout in seconds for the
		  connection.  In this example, the connection will be
		  closed automatically after 300 seconds of
		  inactivity.  To prevent a timeout, set this value to
		  zero.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 16:</term>
	      <listitem>
		<para xml:lang="en">Sets the interface addresses.  The values used
		  depend upon whether a static <acronym>IP</acronym>
		  address has been obtained from the
		  <acronym>ISP</acronym> or if it  instead negotiates
		  a dynamic <acronym>IP</acronym> address during
		  connection.</para>

		<para xml:lang="en">If the  <acronym>ISP</acronym> has allocated a
		  static <acronym>IP</acronym> address and default
		  gateway, replace <replaceable>x.x.x.x</replaceable>
		  with the static  <acronym>IP</acronym> address and
		  replace <replaceable>y.y.y.y</replaceable> with the
		  <acronym>IP</acronym> address of the default
		  gateway.  If the <acronym>ISP</acronym> has only
		  provided a static <acronym>IP</acronym> address
		  without a gateway address, replace
		  <replaceable>y.y.y.y</replaceable> with <systemitem class="netmask">10.0.0.2/0</systemitem>.</para>

		<para xml:lang="en">If the <acronym>IP</acronym> address changes
		  whenever a connection is made, change this line to
		  the following value.  This tells <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry> to use
		  the <acronym>IP</acronym> Configuration Protocol
		  (<acronym>IPCP</acronym>) to negotiate a dynamic
		  <acronym>IP</acronym> address:</para>

	  <programlisting xml:lang="en">set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.255 0.0.0.0</programlisting>

	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 17:</term>

	      <listitem>
		<para xml:lang="en">Keep this line as-is as it adds a default route
		  to the gateway.  The <literal>HISADDR</literal> will
		  automatically be replaced with the gateway address
		  specified on line 16.  It is important that this
		  line appears after line 16.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>

	  <para xml:lang="en">Depending upon whether <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry> is started
	    manually or automatically, a
	    <filename>/etc/ppp/ppp.linkup</filename> may also need to
	    be created which contains the following lines.  This file
	    is required when running <command>ppp</command> in
	    <option>-auto</option> mode.  This file is used after the
	    connection has been established.  At this point, the
	    <acronym>IP</acronym> address will have been assigned and
	    it is now be possible to add the routing table entries.
	    When creating this file, make sure that
	    <replaceable>provider</replaceable> matches the value
	    demonstrated in line 11 of
	    <filename>ppp.conf</filename>.</para>

	  <programlisting xml:lang="en">provider:
      add default HISADDR</programlisting>

	<para xml:lang="en">This file is also needed when the default gateway
	  address is <quote>guessed</quote> in a static
	  <acronym>IP</acronym> address configuration.  In this case,
	  remove line 17 from <filename>ppp.conf</filename> and
	  create <filename>/etc/ppp/ppp.linkup</filename> with the
	  above two lines.  More examples for this file can be found
	  in <filename>/usr/share/examples/ppp/</filename>.</para>

	<para xml:lang="en">By default, <command>ppp</command> must be
	  run as <systemitem class="username">root</systemitem>.
	  To change this default, add the account of the user
	  who should run <command>ppp</command> to the <systemitem class="groupname">network</systemitem> group in
	  <filename>/etc/group</filename>.</para>

	<para xml:lang="en">Then, give the user access to one or more entries in
	  <filename>/etc/ppp/ppp.conf</filename> with
	  <command>allow</command>.  For example, to give
	  <systemitem class="username">fred</systemitem> and
	  <systemitem class="username">mary</systemitem>
	  permission to only the <literal>provider:</literal> entry,
	  add this line to the <literal>provider:</literal>
	  section:</para>

	<programlisting xml:lang="en">allow users <replaceable>fred mary</replaceable></programlisting>

	<para xml:lang="en">To give the specified users access to all entries, put
	  that line in the <literal>default</literal> section
	  instead.</para>
      </sect2>

    <?ignore <sect2>
	  <title>Receiving Incoming Calls</title>

	  <indexterm>
	    <primary><acronym>PPP</acronym></primary>
	    <secondary>receiving incoming calls</secondary>
	  </indexterm>

	  <para>When configuring &man.ppp.8; to receive incoming calls
	    on a machine connected to a Local Area Network
	    (<acronym>LAN</acronym>), decide if packets should be
	    forwarded to the <acronym>LAN</acronym>.  If so, allocate
	    the connecting system an <acronym>IP</acronym> address
	    from the <acronym>LAN</acronym>'s subnet, and add the
	    <command>enable proxy</command> line to
	    <filename>/etc/ppp/ppp.conf</filename>.
	    Also, confirm that <filename>/etc/rc.conf</filename>
	    contains the following line:</para>

	  <programlisting>gateway_enable="YES"</programlisting>

	  <para>Refer to &man.ppp.8; and
	    <filename>/usr/share/examples/ppp/ppp.conf.sample</filename>
	    for more details.  The following steps will also be
	    required:</para>

	  <procedure>
	    <step>
	      <para>Create an entry in
		<filename>/etc/passwd</filename> (using the
		&man.vipw.8; program).</para>
	    </step>

	    <step>
	      <para>Create a profile in this users home directory that
		runs <command>ppp -direct direct-server</command> or
		similar.</para>
	    </step>

	    <step>
	      <para>Create an entry in
		<filename>/etc/ppp/ppp.conf</filename>.  The
		<filename>direct-server</filename> example should
		suffice.</para>
	    </step>

	    <step>
	      <para>Create an entry in
		<filename>/etc/ppp/ppp.linkup</filename>.</para>
	    </step>
	  </procedure>
	</sect2>

	  <title><acronym>PPP</acronym> Shells for Dynamic
	    <acronym>IP</acronym> Users</title>

	  <indexterm>
	    <primary><acronym>PPP</acronym> shells</primary>
	  </indexterm>

	  <para>Create a file called
	    <filename>/etc/ppp/ppp-shell</filename> containing the
	    following:</para>

	  <programlisting>#!/bin/sh
IDENT=`echo $0 | sed -e 's/^.*-\(.*\)$/\1/'`
CALLEDAS="$IDENT"
TTY=`tty`

if [ x$IDENT = xdialup ]; then
        IDENT=`basename $TTY`
fi

echo "PPP for $CALLEDAS on $TTY"
echo "Starting PPP for $IDENT"

exec /usr/sbin/ppp -direct $IDENT</programlisting>

	  <para>This script should be executable.  Now make a
	    symbolic link called <filename>ppp-dialup</filename> to
	    this script using the following commands:</para>

	  <screen>&prompt.root; <userinput>ln -s ppp-shell /etc/ppp/ppp-dialup</userinput></screen>

	  <para>Use this script as the
	    <emphasis>shell</emphasis> for all of dial-up users.  This
	    is an example from <filename>/etc/passwd</filename> for a
	    dial-up <acronym>PPP</acronym>:</para>

	    <programlisting>pchilds:*:1011:300:Peter Childs PPP:/home/ppp:/etc/ppp/ppp-dialup</programlisting>

	    <para>Create a <filename
		>/home/ppp</filename> directory that
	      is world readable containing the following 0 byte
	      files:</para>

	    <screen>-r--r--r--   1 root     wheel           0 May 27 02:23 .hushlogin
-r--r--r--   1 root     wheel           0 May 27 02:22 .rhosts</screen>

	    <para>which prevents <filename>/etc/motd</filename> from
	      being displayed.</para>
	  </sect2>
	  <sect2>
	    <title><acronym>PPP</acronym> Shells for Static
	      <acronym>IP</acronym> Users</title>

	    <indexterm>
	      <primary><acronym>PPP</acronym> shells</primary>
	    </indexterm>

	    <para>Create <filename>ppp-shell</filename> as
	      above, and for each account with statically assigned
	      <acronym>IP</acronym>s create a symbolic link to
	      <filename>ppp-shell</filename>.</para>

	    <para>For example, to route /24 CIDR networks for the
	      dial-up customers <username>fred</username>,
	      <username>sam</username>, and
	      <username>mary</username>, type:</para>

	    <screen>&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-fred</userinput>
&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-sam</userinput>
&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-mary</userinput></screen>

	    <para>Each of these users dial-up accounts should have
	      their shell set to the symbolic link created above (for
	      example, <username>mary</username>'s shell should be
	      <filename>/etc/ppp/ppp-mary</filename>).</para>
	  </sect2>

	  <sect2>
	    <title>Setting Up <filename>ppp.conf</filename> for
	      Dynamic <acronym>IP</acronym> Users</title>

	    <para>Ensure that <filename>/etc/ppp/ppp.conf</filename>
	      contains something along the lines of:</para>

	    <programlisting>default:
  set debug phase lcp chat
  set timeout 0

ttyu0:
  set ifaddr 203.14.100.1 203.14.100.20 255.255.255.255
  enable proxy

ttyu1:
  set ifaddr 203.14.100.1 203.14.100.21 255.255.255.255
  enable proxy</programlisting>

	    <note>
	      <para>The indenting is important.</para>
	    </note>

	    <para>The <literal>default:</literal> section is loaded
	      for each session.  For each dial-up line enabled in
	      <filename>/etc/ttys</filename> create an entry similar
	      to the one for <literal>ttyu0:</literal> above.  Each
	      line should get a unique <acronym>IP</acronym> address
	      from the pool of <acronym>IP</acronym> addresses for
	      dynamic users.</para>
	  </sect2>

	  <sect2>
	    <title>Setting Up <filename>ppp.conf</filename> for
	      Static <acronym>IP</acronym> Users</title>

	    <para>Along with the contents of the sample
	      <filename>/usr/share/examples/ppp/ppp.conf</filename>
	      above, add a section for each of the statically assigned
	      dial-up users:.</para>

	    <programlisting>fred:
  set ifaddr 203.14.100.1 203.14.101.1 255.255.255.255

sam:
  set ifaddr 203.14.100.1 203.14.102.1 255.255.255.255

mary:
  set ifaddr 203.14.100.1 203.14.103.1 255.255.255.255</programlisting>

	    <para>The file <filename>/etc/ppp/ppp.linkup</filename>
	      should also contain routing information for each static
	      <acronym>IP</acronym> user if required.  The line below
	      would add a route for the <hostid
		role="ipaddr">203.14.101.0/24</hostid> network via the
	      client's ppp link.</para>

	    <programlisting>fred:
  add 203.14.101.0 netmask 255.255.255.0 HISADDR

sam:
  add 203.14.102.0 netmask 255.255.255.0 HISADDR

mary:
  add 203.14.103.0 netmask 255.255.255.0 HISADDR</programlisting>
	</sect2>
	?>

	<sect2>
	  <title>進階設定</title>

	  <indexterm xml:lang="en">
	    <primary>DNS</primary>
	  </indexterm>

	  <indexterm xml:lang="en">
	    <primary>NetBIOS</primary>
	  </indexterm>

	  <indexterm xml:lang="en">
	    <primary><acronym>PPP</acronym></primary>
	    <secondary>Microsoft extensions</secondary>
	  </indexterm>

	  <para xml:lang="en">It is possible to configure PPP to supply DNS and
	    NetBIOS nameserver addresses on demand.</para>

	  <para xml:lang="en">To enable these extensions with
	    <acronym>PPP</acronym> version 1.x, the following lines
	    might be added to the relevant section of
	    <filename>/etc/ppp/ppp.conf</filename>.</para>

	  <programlisting xml:lang="en">enable msext
set ns 203.14.100.1 203.14.100.2
set nbns 203.14.100.5</programlisting>

	  <para xml:lang="en">And for <acronym>PPP</acronym> version 2 and
	    above:</para>

	  <programlisting xml:lang="en">accept dns
set dns 203.14.100.1 203.14.100.2
set nbns 203.14.100.5</programlisting>

	  <para xml:lang="en">This will tell the clients the primary and secondary
	    name server addresses, and a NetBIOS nameserver
	    host.</para>

	  <para xml:lang="en">In version 2 and above, if the <literal>set
	      dns</literal> line is omitted,
	    <acronym>PPP</acronym> will use the values found in
	    <filename>/etc/resolv.conf</filename>.</para>

	<sect3 xml:id="userppp-PAPnCHAP">
	  <title>PAP 與 CHAP 認證</title>

	  <indexterm xml:lang="en"><primary>PAP</primary></indexterm>
	  <indexterm xml:lang="en"><primary>CHAP</primary></indexterm>
	  <para xml:lang="en">Some <acronym>ISP</acronym>s set their system up so
	    that the authentication part of the connection is done
	    using either of the PAP or CHAP authentication mechanisms.
	    If this is the case, the <acronym>ISP</acronym> will not
	    give a <prompt>login:</prompt> prompt at connection, but
	    will start talking <acronym>PPP</acronym>
	    immediately.</para>

	  <para xml:lang="en">PAP is less secure than CHAP, but security is not
	    normally an issue here as passwords, although being sent
	    as plain text with PAP, are being transmitted down a
	    serial line only.  There is not much room for crackers
	    to <quote>eavesdrop</quote>.</para>

	  <para xml:lang="en">The following
	    alterations must be made:</para>

	  <programlisting xml:lang="en">13      set authname <replaceable>MyUserName</replaceable>
14      set authkey <replaceable>MyPassword</replaceable>
15      set login</programlisting>

	  <variablelist>
	    <varlistentry>
	      <term xml:lang="en">Line 13:</term>

	      <listitem>
		<para xml:lang="en">This line specifies the PAP/CHAP user name.
		  Insert the correct value for
		  <replaceable>MyUserName</replaceable>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 14:</term>
	      <listitem>
		<para xml:lang="en">This line specifies the PAP/CHAP
		  password<indexterm xml:lang="en"><primary>password</primary></indexterm>.
		  Insert the correct value for
		  <replaceable>MyPassword</replaceable>.  You may
		  want to add an additional line, such as:</para>

		<programlisting xml:lang="en">16      accept PAP</programlisting>

		<para>或</para>

		<programlisting xml:lang="en">16      accept CHAP</programlisting>

		<para xml:lang="en">to make it obvious that this is the intention,
		  but PAP and CHAP are both accepted by
		  default.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term xml:lang="en">Line 15:</term>

	      <listitem>
		<para xml:lang="en">The <acronym>ISP</acronym> will not normally
		  require a login to the server when using PAP or
		  CHAP.  Therefore, disable the <quote>set
		    login</quote> string.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</sect3>

      <sect3 xml:id="userppp-nat">
	<title>使用 <acronym>PPP</acronym> 網路位址轉譯功能</title>

	<indexterm xml:lang="en">
	  <primary><acronym>PPP</acronym></primary><secondary>NAT</secondary>
	</indexterm>

	<para xml:lang="en">PPP has ability to use internal NAT without kernel
	  diverting capabilities.  This functionality may be enabled
	  by the following line in
	  <filename>/etc/ppp/ppp.conf</filename>:</para>

	<programlisting xml:lang="en">nat enable yes</programlisting>

	<para xml:lang="en">Alternatively, NAT may be enabled by command-line
	  option <literal>-nat</literal>.  There is also
	  <filename>/etc/rc.conf</filename> knob named
	  <literal>ppp_nat</literal>, which is enabled by
	  default.</para>

	<para xml:lang="en">When using this feature, it may be useful to include
	  the following <filename>/etc/ppp/ppp.conf</filename> options
	  to enable incoming connections forwarding:</para>

	<programlisting xml:lang="en">nat port tcp 10.0.0.2:ftp ftp
nat port tcp 10.0.0.2:http http</programlisting>

	<para xml:lang="en">or do not trust the outside at all</para>

	<programlisting xml:lang="en">nat deny_incoming yes</programlisting>
      </sect3>
      </sect2>

      <sect2 xml:id="userppp-final">
	<title>最終系統設定</title>

	<indexterm xml:lang="en">
	  <primary><acronym>PPP</acronym></primary><secondary>configuration</secondary>
	</indexterm>

	<para xml:lang="en">While <command>ppp</command> is now configured,
	  some edits still need to be made to
	  <filename>/etc/rc.conf</filename>.</para>

	<para xml:lang="en">Working from the top down in this file, make sure the
	  <literal>hostname=</literal> line is set:</para>

	<programlisting xml:lang="en">hostname="foo.example.com"</programlisting>

	<para xml:lang="en">If the <acronym>ISP</acronym> has supplied a static
	  <acronym>IP</acronym> address and name, use this name as the
	  host name.</para>

	<para xml:lang="en">Look for the <literal>network_interfaces</literal>
	  variable.  To configure the system to dial the
	  <acronym>ISP</acronym> on demand, make sure the
	  <filename>tun0</filename> device is added to the list,
	  otherwise remove it.</para>

	<programlisting xml:lang="en">network_interfaces="lo0 tun0"
ifconfig_tun0=</programlisting>

	<note>
	  <para xml:lang="en">The <literal>ifconfig_tun0</literal> variable should
	    be empty, and a file called
	    <filename>/etc/start_if.tun0</filename> should be created.
	    This file should contain the line:</para>

	  <programlisting xml:lang="en">ppp -auto mysystem</programlisting>

	  <para xml:lang="en">This script is executed at network configuration time,
	    starting the ppp daemon in automatic mode.  If this
	    machine acts as a gateway, consider including
	    <option>-alias</option>.  Refer to the manual page for
	    further details.</para>
	</note>

	<para xml:lang="en">Make sure that the router program is set to
	  <literal>NO</literal> with the following line in
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">router_enable="NO"</programlisting>

	<indexterm xml:lang="en">
	  <primary><application>routed</application></primary>
	</indexterm>

	<para xml:lang="en">It is important that the <command>routed</command>
	  daemon is not started, as <command>routed</command> tends
	  to delete the default routing table entries created by
	  <command>ppp</command>.</para>

	<para xml:lang="en">It is probably a good idea to ensure that the
	  <literal>sendmail_flags</literal> line does not include the
	  <option>-q</option> option, otherwise
	  <command>sendmail</command> will attempt to do a network
	  lookup every now and then, possibly causing your machine
	  to dial out.  You may try:</para>

	<programlisting xml:lang="en">sendmail_flags="-bd"</programlisting>

	<indexterm xml:lang="en">
	  <primary><application>sendmail</application></primary>
	</indexterm>
	<para xml:lang="en">The downside is that <command>sendmail</command> is
	  forced to re-examine the mail queue whenever the ppp link.
	  To automate this, include <command>!bg</command> in
	  <filename>ppp.linkup</filename>:</para>

	<programlisting xml:lang="en">1     provider:
2       delete ALL
3       add 0 0 HISADDR
4       !bg sendmail -bd -q30m</programlisting>

	<indexterm xml:lang="en">
	  <primary>SMTP</primary>
	</indexterm>

	<para xml:lang="en">An alternative is to set up a
	  <quote>dfilter</quote> to block SMTP traffic.  Refer to the
	  sample files for further details.</para>
      </sect2>

      <sect2>
	<title>使用 <command>ppp</command></title>

	<para xml:lang="en">All that is left is to reboot the machine.  After
	  rebooting, either type:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ppp</userinput></screen>

	<para xml:lang="en">and then <command>dial provider</command> to start the
	  <acronym>PPP</acronym> session, or, to configure
	  <command>ppp</command> to establish sessions automatically
	  when there is outbound traffic and
	  <filename>start_if.tun0</filename> does not exist,
	  type:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ppp -auto provider</userinput></screen>

	  <para xml:lang="en">It is possible to talk to the <command>ppp</command>
	    program while it is running in the background, but only
	    if a suitable diagnostic port has been set up.  To do
	    this, add the following line to the configuration:</para>

	  <programlisting xml:lang="en">set server /var/run/ppp-tun<replaceable>%d</replaceable> DiagnosticPassword 0177</programlisting>

	<para xml:lang="en">This will tell PPP to listen to the specified
	  <trademark class="registered">UNIX</trademark> domain socket, asking clients for the specified
	  password before allowing access.  The
	  <literal>%d</literal> in the name is replaced with the
	  <filename>tun</filename> device number that is in
	  use.</para>

	<para xml:lang="en">Once a socket has been set up, the <citerefentry><refentrytitle>pppctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	  program may be used in scripts that wish to manipulate
	  the running program.</para>
      </sect2>

	<sect2 xml:id="userppp-mgetty">
	  <title>設定撥入服務</title>

	  <indexterm xml:lang="en">
	    <primary><command>mgetty</command></primary>
	  </indexterm>

	  <indexterm xml:lang="en">
	    <primary>AutoPPP</primary>
	  </indexterm>

	  <indexterm xml:lang="en">
	    <primary>LCP</primary>
	  </indexterm>
	  <para xml:lang="en"><xref linkend="dialup"/> provides a good description
	    on enabling dial-up services using <citerefentry><refentrytitle>getty</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

	  <para xml:lang="en">An alternative to <command>getty</command> is
	    <package>comms/mgetty+sendfax</package>
	    port), a smarter version of <command>getty</command>
	    designed with dial-up lines in mind.</para>

	  <para xml:lang="en">The advantages of using <command>mgetty</command> is
	    that it actively <emphasis>talks</emphasis> to modems,
	    meaning if port is turned off in
	    <filename>/etc/ttys</filename> then the modem will not
	    answer the phone.</para>

	  <para xml:lang="en">Later versions of <command>mgetty</command> (from
	    0.99beta onwards) also support the automatic detection of
	    <acronym>PPP</acronym> streams, allowing clients
	    scriptless access to the server.</para>

	  <para xml:lang="en">Refer to <link xlink:href="http://mgetty.greenie.net/doc/mgetty_toc.html">http://mgetty.greenie.net/doc/mgetty_toc.html</link>
	    for more information on <command>mgetty</command>.</para>

	  <para xml:lang="en">By default the <package>comms/mgetty+sendfax</package>
	    port comes with the <literal>AUTO_PPP</literal> option
	    enabled allowing <command>mgetty</command> to detect the
	    LCP phase of <acronym>PPP</acronym> connections and
	    automatically spawn off a ppp shell.  However, since the
	    default login/password sequence does not occur it is
	    necessary to authenticate users using either PAP or
	    CHAP.</para>

	  <para xml:lang="en">This section assumes the user has successfully
	    compiled, and installed the
	    <package>comms/mgetty+sendfax</package> port on his
	    system.</para>

	  <para xml:lang="en">Ensure that
	    <filename>/usr/local/etc/mgetty+sendfax/login.config</filename>
	    has the following:</para>

	  <programlisting xml:lang="en">/AutoPPP/ -     - /etc/ppp/ppp-pap-dialup</programlisting>

	  <para xml:lang="en">This tells <command>mgetty</command> to run
	    <filename>ppp-pap-dialup</filename> for detected
	    <acronym>PPP</acronym> connections.</para>

	  <para xml:lang="en">Create an executable file called
	    <filename>/etc/ppp/ppp-pap-dialup</filename> containing
	    the following:</para>

	  <programlisting xml:lang="en">#!/bin/sh
exec /usr/sbin/ppp -direct pap$IDENT</programlisting>

	  <para xml:lang="en">For each dial-up line enabled in
	    <filename>/etc/ttys</filename>, create a corresponding
	    entry in <filename>/etc/ppp/ppp.conf</filename>.  This
	    will happily co-exist with the definitions we created
	    above.</para>

	  <programlisting xml:lang="en">pap:
  enable pap
  set ifaddr 203.14.100.1 203.14.100.20-203.14.100.40
  enable proxy</programlisting>

	  <para xml:lang="en">Each user logging in with this method will need to
	    have a username/password in
	    <filename>/etc/ppp/ppp.secret</filename>, or
	    alternatively add the following option to authenticate
	    users via PAP from
	    <filename>/etc/passwd</filename>.</para>

	  <programlisting xml:lang="en">enable passwdauth</programlisting>

	  <para xml:lang="en">To assign some users a static <acronym>IP</acronym>
	    number, specify the number as the third argument in
	    <filename>/etc/ppp/ppp.secret</filename>.  See
	    <filename>/usr/share/examples/ppp/ppp.secret.sample</filename>
	    for examples.</para>
	</sect2>
  </sect1>

  <sect1 xml:id="ppp-troubleshoot">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Contributed by in June 2003</contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title><acronym>PPP</acronym> 連線疑難排解</title>

    <indexterm xml:lang="en">
      <primary><acronym>PPP</acronym></primary>
      <secondary>troubleshooting</secondary>
    </indexterm>

    <para xml:lang="en">This section covers a few issues which may arise when
      using <acronym>PPP</acronym> over a modem connection.  Some
      <acronym>ISP</acronym>s present the
      <literal>ssword</literal> prompt while others present
      <literal>password</literal>.  If the <command>ppp</command>
      script is not written accordingly, the login attempt will
      fail.  The most common way to debug <command>ppp</command>
      connections is by connecting manually as described in this
      section.</para>

    <sect2>
      <title>檢查裝置節點</title>

      <para xml:lang="en">When using a custom kernel, make sure to include the
	following line in the kernel configuration file:</para>

      <programlisting xml:lang="en">device   uart</programlisting>

      <para xml:lang="en">The <filename>uart</filename> device is already
	included in the <literal>GENERIC</literal> kernel, so no
	additional steps are necessary in this case.  Just
	check the <command>dmesg</command> output for the modem
	device with:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>dmesg | grep uart</userinput></screen>

      <para xml:lang="en">This should display some pertinent output about the
	<filename>uart</filename> devices.  These are the COM
	ports we need.  If the modem acts like a standard serial port,
	it should be listed on <filename>uart1</filename>, or
	<filename>COM2</filename>.  If so, a kernel rebuild is not
	required.  When matching up, if the modem is on
	<filename>uart1</filename>, the modem device would be
	<filename>/dev/cuau1</filename>.</para>
    </sect2>

    <sect2>
      <title>手動連線</title>

      <para xml:lang="en">Connecting to the Internet by manually controlling
	<command>ppp</command> is quick, easy, and a great way to
	debug a connection or just get information on how the
	<acronym>ISP</acronym> treats <command>ppp</command> client
	connections.  Lets start <application>PPP</application> from
	the command line.  Note that in all of our examples we will
	use <emphasis>example</emphasis> as the hostname of the
	machine running <application>PPP</application>.  To start
	<command>ppp</command>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ppp</userinput></screen>

      <screen xml:lang="en">ppp ON example&gt; <userinput>set device /dev/cuau1</userinput></screen>

      <para xml:lang="en">This second command sets the modem device to
	<filename>cuau1</filename>.</para>

      <screen xml:lang="en">ppp ON example&gt; <userinput>set speed 115200</userinput></screen>

      <para xml:lang="en">This sets the connection speed to
	115,200 <acronym>kbps</acronym>.</para>

      <screen xml:lang="en">ppp ON example&gt; <userinput>enable dns</userinput></screen>

      <para xml:lang="en">This tells <command>ppp</command> to configure the
	resolver and add the nameserver lines to
	<filename>/etc/resolv.conf</filename>.  If
	<command>ppp</command> cannot determine the hostname, it can
	manually be set later.</para>

      <screen xml:lang="en">ppp ON example&gt; <userinput>term</userinput></screen>

      <para xml:lang="en">This switches to <quote>terminal</quote> mode in order to
	manually control the modem.</para>

      <programlisting xml:lang="en">deflink: Entering terminal mode on <filename class="devicefile">/dev/cuau1</filename>
type '~h' for help</programlisting>

      <screen xml:lang="en"><userinput>at</userinput>
OK
<userinput>atdt<replaceable>123456789</replaceable></userinput></screen>

      <para xml:lang="en">Use <command>at</command> to initialize the modem, then
	use <command>atdt</command> and the number for the
	<acronym>ISP</acronym> to begin the dial in process.</para>

      <screen xml:lang="en">CONNECT</screen>

      <para xml:lang="en">Confirmation of the connection, if we are going to have
	any connection problems, unrelated to hardware, here is where
	we will attempt to resolve them.</para>

      <screen xml:lang="en">ISP Login:<userinput>myusername</userinput></screen>

      <para xml:lang="en">At this prompt, return the prompt with the username that
	was provided by the <acronym>ISP</acronym>.</para>

      <screen xml:lang="en">ISP Pass:<userinput>mypassword</userinput></screen>

      <para xml:lang="en">At this prompt, reply with the password that was provided
	by the <acronym>ISP</acronym>.  Just like logging into FreeBSD,
	the password will not echo.</para>

      <screen xml:lang="en">Shell or PPP:<userinput>ppp</userinput></screen>

      <para xml:lang="en">Depending on the <acronym>ISP</acronym>, this prompt
	might not appear.  If it does, it is asking whether to use a
	shell on the provider or to start
	<command>ppp</command>.  In this example,
	<command>ppp</command> was selected in order to establish an
	Internet connection.</para>

      <screen xml:lang="en">Ppp ON example&gt;</screen>

      <para xml:lang="en">Notice that in this example the first <option>p</option>
	has been capitalized.  This shows that we have successfully
	connected to the <acronym>ISP</acronym>.</para>

      <screen xml:lang="en">PPp ON example&gt;</screen>

      <para xml:lang="en">We have successfully authenticated with our
	<acronym>ISP</acronym> and are waiting for the assigned
	<acronym>IP</acronym> address.</para>

      <screen xml:lang="en">PPP ON example&gt;</screen>

      <para xml:lang="en">We have made an agreement on an <acronym>IP</acronym>
	address and successfully completed our connection.</para>

      <screen xml:lang="en">PPP ON example&gt;<userinput>add default HISADDR</userinput></screen>

      <para xml:lang="en">Here we add our default route, we need to do this before
	we can talk to the outside world as currently the only
	established connection is with the peer.  If this fails due to
	existing routes, put a bang character
	<literal>!</literal> in front of the <option>add</option>.
	Alternatively, set this before making the actual
	connection and it will negotiate a new route
	accordingly.</para>

      <para xml:lang="en">If everything went good we should now have an active
	connection to the Internet, which could be thrown into the
	background using <keycombo action="simul"><keycap>CTRL</keycap>
	  <keycap>z</keycap></keycombo> If <command>PPP</command>
	returns to <command>ppp</command> then the connection has bee
	lost.  This is good to know because it shows the connection
	status.  Capital P's represent a connection to the
	<acronym>ISP</acronym> and lowercase p's show that the
	connection has been lost.</para>
      </sect2>

      <sect2>
	<title>除錯</title>

	<para xml:lang="en">If a connection cannot be established, turn hardware
	  flow <acronym>CTS/RTS</acronym> to off using <option>set
	    ctsrts off</option>.  This is mainly the case when
	  connected to some <application>PPP</application>-capable
	  terminal servers, where <application>PPP</application> hangs
	  when it tries to write data to the communication link, and
	  waits for a Clear To Send (<acronym>CTS</acronym>) signal
	  which may never come.  When using this option, include
	  <option>set accmap</option> as it may be required to defeat
	  hardware dependent on passing certain characters from end to
	  end, most of the time XON/XOFF.  Refer to <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry> for
	  more information on this option and how it is used.</para>

	<para xml:lang="en">An older modem may need <option>set parity
	    even</option>.  Parity is set at none be default, but is
	  used for error checking with a large increase in traffic,
	  on older modems.</para>

	<para xml:lang="en"><application>PPP</application> may not return to the
	  command mode, which is usually a negotiation error where the
	  <acronym>ISP</acronym> is waiting for negotiating to begin.
	  At this point, using  <command>~p</command> will force ppp
	  to start sending the configuration information.</para>

	<para xml:lang="en">If a login prompt never appears, <acronym>PAP</acronym>
	  or <acronym>CHAP</acronym> authentication is most likely
	  required.  To use <acronym>PAP</acronym> or
	  <acronym>CHAP</acronym>, add the following options to
	  <application>PPP</application> before going into terminal
	  mode:</para>

	<screen xml:lang="en">ppp ON example&gt; <userinput>set authname <replaceable>myusername</replaceable></userinput></screen>

	<para xml:lang="en">Where <replaceable>myusername</replaceable> should be
	  replaced with the username that was assigned by the
	  <acronym>ISP</acronym>.</para>

	<screen xml:lang="en">ppp ON example&gt; <userinput>set authkey <replaceable>mypassword</replaceable></userinput></screen>

	<para xml:lang="en">Where <replaceable>mypassword</replaceable> should be
	  replaced with the password that was assigned by the
	  <acronym>ISP</acronym>.</para>

	<para xml:lang="en">If a connection is established, but cannot seem to find
	  any domain name,  try to <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry> an
	  <acronym>IP</acronym> address.  If there is 100 percent
	  (100%) packet loss, it is likely that a default route was
	  not assigned.  Double check that <option>add default
	    HISADDR</option> was set during the connection.  If a
	  connection can be made to a remote <acronym>IP</acronym>
	  address, it is possible that a resolver address has not been
	  added to <filename>/etc/resolv.conf</filename>.  This file
	  should look like:</para>

	<programlisting xml:lang="en">domain <replaceable>example.com</replaceable>
nameserver <replaceable>x.x.x.x</replaceable>
nameserver <replaceable>y.y.y.y</replaceable></programlisting>

	<para xml:lang="en">Where <replaceable>x.x.x.x</replaceable> and
	  <replaceable>y.y.y.y</replaceable> should be replaced with
	  the <acronym>IP</acronym> address of the
	  <acronym>ISP</acronym>'s DNS servers.</para>

	<para xml:lang="en">To configure <citerefentry><refentrytitle>syslog</refentrytitle><manvolnum>3</manvolnum></citerefentry> to provide logging for the
	  <application>PPP</application> connection, make sure this
	  line exists in <filename>/etc/syslog.conf</filename>:</para>

	<programlisting xml:lang="en">!ppp
*.*     /var/log/ppp.log</programlisting>

    </sect2>
  </sect1>

  <sect1 xml:id="pppoe">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Jim</firstname>
	  <surname>Mock</surname>
	  <contrib>Contributed (from
	    http://node.to/freebsd/how-tos/how-to-freebsd-pppoe.html)
	    by in Jan 2000</contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>在乙太網路使用 <acronym>PPP</acronym> (PPPoE)</title>

    <indexterm xml:lang="en">
      <primary><acronym>PPP</acronym></primary>
      <secondary>over Ethernet</secondary>
    </indexterm>

    <para>本節介紹如何設定在 乙太網路使用 <acronym>PPP</acronym> (<acronym>PPPoE</acronym>)。</para>

    <para>以下有一個可用的的 <filename>ppp.conf</filename> 範例：</para>

    <programlisting xml:lang="en">default:
  set log Phase tun command # you can add more detailed logging if you wish
  set ifaddr 10.0.0.1/0 10.0.0.2/0

name_of_service_provider:
  set device PPPoE:<replaceable>xl1</replaceable> # replace xl1 with your Ethernet device
  set authname YOURLOGINNAME
  set authkey YOURPASSWORD
  set dial
  set login
  add default HISADDR</programlisting>

      <para>以 <systemitem class="username">root</systemitem> 身份執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ppp -ddial name_of_service_provider</userinput></screen>

      <para>將以下參數加到 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">ppp_enable="YES"
ppp_mode="ddial"
ppp_nat="YES"	# if you want to enable nat for your local network, otherwise NO
ppp_profile="name_of_service_provider"</programlisting>

    <sect2>
      <title>使用 PPPoE 服務標籤</title>

      <para>有時需要使用服務標籤 (Service Tag) 才能建立連線，服務標籤用來區別不同網路要各自連線的 PPPoE 伺服器。</para>

      <para>所需的服務標籤資訊應該會在 <acronym>ISP</acronym> 所提供的文件中說明。</para>

      <para>最後的手段是嘗試安裝 <package>net/rr-pppoe</package> 套件或 Port。但是請注意，這可能會解除安裝數據機中的程式並使其無法運作，所以請三思而為。只需要安裝數據機所提供的程式，然後由該程式進入 <guimenu>System</guimenu> 選單，基本資料 (Profile name) 的名稱應該會列出來，通常是 <emphasis>ISP</emphasis> 的名稱。</para>

      <para>基本資料名稱 (Profile Name) 即服務標籤，會被用在 <filename>ppp.conf</filename> 中的 PPPoE 設定項目，<command>set device</command> 的提供商 (Provider) 部份。請參考 <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry> 以取得詳細說明，結果應如下：</para>

      <programlisting xml:lang="en">set device PPPoE:<replaceable>xl1</replaceable>:<replaceable>ISP</replaceable></programlisting>

      <para>別忘記更改 <replaceable>xl1</replaceable> 為乙太網路卡的裝置名稱。</para>

      <para>別忘記更改 <replaceable>ISP</replaceable> 為基本資料名稱。</para>

      <para>要取得更進一步資訊，請參考 Renaud Waldura 所著的 <link xlink:href="http://renaud.waldura.com/doc/freebsd/pppoe/">Cheaper Broadband with FreeBSD on DSL</link>。</para>
    </sect2>

    <sect2 xml:id="ppp-3com">

      <title>在 <trademark class="registered">3Com</trademark> <trademark class="registered">HomeConnect</trademark> ADSL Modem Dual Link 使用 PPPoE</title>

      <para>這台數據機並不採用 <link xlink:href="http://www.faqs.org/rfcs/rfc2516.html">RFC 2516</link> 所定義的規格。</para>

      <para>為了要讓 FreeBSD 能夠與這台裝置通訊，必須設定 sysctl，這可以透過更新 <filename>/etc/sysctl.conf</filename> 來讓開機時自動設定。</para>

	<programlisting xml:lang="en">net.graph.nonstandard_pppoe=1</programlisting>

      <para>或可以執行以下指令立即更改：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl net.graph.nonstandard_pppoe=1</userinput></screen>

      <para>不幸的是，由於這是一個全系統的設定，這可能導致一般 PPPoE 客戶端或伺服器無法與 <trademark class="registered">3Com</trademark> <trademark class="registered">HomeConnect</trademark> ADSL 數據機同時使用。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="pppoa">
    <title>在 ATM 使用 <application>PPP</application> (PPPoA)</title>

    <indexterm xml:lang="en">
      <primary><acronym>PPP</acronym></primary>
      <secondary>over <acronym>ATM</acronym></secondary>
    </indexterm>

    <indexterm xml:lang="en">
      <primary>PPPoA</primary>
    </indexterm>

    <para xml:lang="en">The following describes how to set up PPP over
      <acronym>ATM</acronym> (PPPoA).  PPPoA is a popular choice among
      European DSL providers.</para>
<!--
This port is broken as of June, 2009
    <sect2>
      <title>Using PPPoA with the Alcatel &speedtouch; USB</title>

      <para>PPPoA support for this device is supplied as a port in
	&os; because the firmware is distributed under <ulink
	url="http://www.speedtouchdsl.com/disclaimer_lx.htm">Alcatel's
	license agreement</ulink> and can not be redistributed freely
	with the base system of &os;.</para>

      <para>This software can be installed using the
	<filename role="package">net/pppoa</filename> package or port.  Once installed, follow
	the instructions provided with it.</para>

      <para>Like many USB devices, the Alcatel &speedtouch; USB needs
	to download firmware from the host computer to operate
	properly.  It is possible to automate this process in &os;
	so that this transfer takes place whenever the device is
	plugged into a USB port.  The following information can be
	added to the <filename>/etc/usbd.conf</filename> file to
	enable this automatic firmware transfer.  This file must be
	edited as the <username>root</username> user.</para>

      <programlisting>device "Alcatel SpeedTouch USB"
    devname "ugen[0-9]+"
    vendor 0x06b9
    product 0x4061
    attach "/usr/local/sbin/modem_run -f /usr/local/libdata/mgmt.o"</programlisting>

      <para>To enable the USB daemon, <application>usbd</application>,
	put the following the line into
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting>usbd_enable="YES"</programlisting>

      <para>It is also possible to set up
	<application>ppp</application> to dial up at startup.  To do
	this add the following lines to
	<filename>/etc/rc.conf</filename>.  Again, for this procedure
	you will need to be logged in as the <username>root</username>
	user.</para>

      <programlisting>ppp_enable="YES"
ppp_mode="ddial"
ppp_profile="adsl"</programlisting>

      <para>For this to work correctly you will need to have used the
	sample <filename>ppp.conf</filename> which is supplied with
	the <filename role="package">net/pppoa</filename> port.</para>
    </sect2>
    -->

    <sect2>
      <title>使用 mpd</title>

      <para xml:lang="en">The <application>mpd</application> application can be used
	to connect to a variety of services, in particular PPTP
	services.  It can be installed using the
	<package>net/mpd5</package> package or port.  Many ADSL modems
	require that a PPTP tunnel is created between the modem and
	computer.</para>

      <para xml:lang="en">Once installed, configure <application>mpd</application>
	to suit the provider's settings.  The port places a set of
	sample configuration files which are well documented in
	<filename>/usr/local/etc/mpd/</filename>.  A complete guide to
	configure <application>mpd</application> is available in HTML
	format in <filename>/usr/ports/share/doc/mpd/</filename>.
	Here is a sample configuration for connecting to an ADSL
	service with <application>mpd</application>.  The
	configuration is spread over two files, first the
	<filename>mpd.conf</filename>:</para>

      <note>
	<para xml:lang="en">This example <filename>mpd.conf</filename> only works
	  with <application>mpd</application> 4.x.</para>
      </note>

      <programlisting xml:lang="en">default:
    load adsl

adsl:
    new -i ng0 adsl adsl
    set bundle authname <replaceable>username</replaceable> <co xml:id="co-mpd-ex-user"/>
    set bundle password <replaceable>password</replaceable> <co xml:id="co-mpd-ex-pass"/>
    set bundle disable multilink

    set link no pap acfcomp protocomp
    set link disable chap
    set link accept chap
    set link keep-alive 30 10

    set ipcp no vjcomp
    set ipcp ranges 0.0.0.0/0 0.0.0.0/0

    set iface route default
    set iface disable on-demand
    set iface enable proxy-arp
    set iface idle 0

    open</programlisting>

    <calloutlist>
      <callout arearefs="co-mpd-ex-user">
	<para xml:lang="en">The username used to authenticate with your
	  <acronym>ISP</acronym>.</para>
      </callout>
      <callout arearefs="co-mpd-ex-pass">
	<para xml:lang="en">The password used to authenticate with your
	  <acronym>ISP</acronym>.</para>
      </callout>
    </calloutlist>

    <para xml:lang="en">Information about the link, or links, to establish is found
      in <filename>mpd.links</filename>.  An example
      <filename>mpd.links</filename> to accompany the above example
      is given beneath:</para>

    <programlisting xml:lang="en">adsl:
    set link type pptp
    set pptp mode active
    set pptp enable originate outcall
    set pptp self <replaceable>10.0.0.1</replaceable> <co xml:id="co-mpd-ex-self"/>
    set pptp peer <replaceable>10.0.0.138</replaceable> <co xml:id="co-mpd-ex-peer"/></programlisting>

    <calloutlist>
      <callout arearefs="co-mpd-ex-self">
	<para xml:lang="en">The <acronym>IP</acronym> address of FreeBSD computer
	  running <application>mpd</application>.</para>
      </callout>
      <callout arearefs="co-mpd-ex-peer">
	<para xml:lang="en">The <acronym>IP</acronym> address of the ADSL modem.
	  The Alcatel <trademark>SpeedTouch</trademark> Home defaults to <systemitem class="ipaddress">10.0.0.138</systemitem>.</para>
      </callout>
    </calloutlist>

    <para xml:lang="en">It is possible to initialize the connection easily by
      issuing the following command as
      <systemitem class="username">root</systemitem>:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>mpd -b <replaceable>adsl</replaceable></userinput></screen>

    <para xml:lang="en">To view the status of the connection:</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>ifconfig <replaceable>ng0</replaceable></userinput>
ng0: flags=88d1&lt;UP,POINTOPOINT,RUNNING,NOARP,SIMPLEX,MULTICAST&gt; mtu 1500
     inet 216.136.204.117 --&gt; 204.152.186.171 netmask 0xffffffff</screen>

    <para xml:lang="en">Using <application>mpd</application> is the recommended
      way to connect to an ADSL service with FreeBSD.</para>
  </sect2>

  <sect2>
    <title>使用 pptpclient</title>

    <para xml:lang="en">It is also possible to use FreeBSD to connect to other
      PPPoA services using <package>net/pptpclient</package>.</para>

    <para xml:lang="en">To use <package>net/pptpclient</package>
      to connect to a DSL service, install the port or package, then
      edit <filename>/etc/ppp/ppp.conf</filename>.  An example section
      of <filename>ppp.conf</filename> is given below.  For further
      information on <filename>ppp.conf</filename> options consult
      <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

    <programlisting xml:lang="en">adsl:
 set log phase chat lcp ipcp ccp tun command
 set timeout 0
 enable dns
 set authname <replaceable>username</replaceable> <co xml:id="co-pptp-ex-user"/>
 set authkey <replaceable>password</replaceable> <co xml:id="co-pptp-ex-pass"/>
 set ifaddr 0 0
 add default HISADDR</programlisting>

    <calloutlist>
      <callout arearefs="co-pptp-ex-user">
	<para xml:lang="en">The username for the DSL provider.</para>
      </callout>

      <callout arearefs="co-pptp-ex-pass">
	<para xml:lang="en">The password for your account.</para>
      </callout>
    </calloutlist>

    <warning>
      <para xml:lang="en">Since the account's password is added to
	<filename>ppp.conf</filename>in plain text form, make sure
	nobody can read the contents of this file:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>chown root:wheel /etc/ppp/ppp.conf</userinput>
<prompt>#</prompt> <userinput>chmod 600 /etc/ppp/ppp.conf</userinput></screen>

      </warning>

      <para xml:lang="en">This will open a tunnel for a <acronym>PPP</acronym>
	session to the DSL router.  Ethernet DSL modems have a
	preconfigured LAN <acronym>IP</acronym> address to connect to.
	In the case of the Alcatel <trademark>SpeedTouch</trademark> Home, this address is
	<systemitem class="ipaddress">10.0.0.138</systemitem>.  The
	router's documentation should list the address the device
	uses.  To open the tunnel and start a <acronym>PPP</acronym>
	session:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pptp <replaceable>address</replaceable> <replaceable>adsl</replaceable></userinput></screen>

      <tip>
	<para xml:lang="en">If an ampersand (<quote>&amp;</quote>) is added
	  to the end of this command,
	  <application>pptp</application> will return the
	  prompt.</para>
      </tip>

      <para xml:lang="en">A <filename>tun</filename> virtual tunnel device
	will be created for interaction between the
	<application>pptp</application> and
	<application>ppp</application> processes.  Once the
	prompt is returned, or the
	<application>pptp</application> process has confirmed a
	connection, examine the tunnel:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>ifconfig <replaceable>tun0</replaceable></userinput>
tun0: flags=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1500
        inet 216.136.204.21 --&gt; 204.152.186.171 netmask 0xffffff00
	Opened by PID 918</screen>

      <para xml:lang="en">If the connection fails, check the configuration of
	the router, which is usually accessible using
	a web browser.  Also, examine the output of
	<command>pptp</command> and the contents of the
	log file,
	<filename>/var/log/ppp.log</filename> for clues.</para>
    </sect2>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="mail">
  <info>
    <title>電子郵件</title>

    <authorgroup>
      <author xml:lang="en"><personname><firstname>Bill</firstname><surname>Lloyd</surname></personname><contrib>Original
	work by </contrib></author>
    </authorgroup>
    <authorgroup>
      <author xml:lang="en"><personname><firstname>Jim</firstname><surname>Mock</surname></personname><contrib>Rewritten
	by </contrib></author>
    </authorgroup>
  </info>

  <sect1 xml:id="mail-synopsis">
    <title>概述</title>

    <indexterm xml:lang="en"><primary>email</primary></indexterm>

    <para><quote>電子郵件</quote> 或稱 email，是現今使用最廣泛的溝通方式之一。本章主要介紹如何在 FreeBSD 上執行郵件伺服器，以及如何使用 FreeBSD 收發信件，若欲瞭解細節請參閱 <xref linkend="bibliography"/> 內的參考書籍。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>哪些軟體元件與收發電子郵件有關。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 內的 <application>Sendmail</application> 設定檔在哪。</para>
      </listitem>

      <listitem>
	<para>遠端信箱 (Mailbox) 與本機信箱的差異。</para>
      </listitem>

      <listitem>
	<para>如何阻擋垃圾郵件寄件者 (Spammer) 非法使用郵件伺服器作為中繼站。</para>
      </listitem>

      <listitem>
	<para>如何安裝與設定其他的郵件傳輸代理程式 (Mail Transfer Agent) 來取代 <application>Sendmail</application>。</para>
      </listitem>

      <listitem>
	<para>如何排除常見的郵件伺服器問題。</para>
      </listitem>

      <listitem>
	<para>如何設定系統只能寄送郵件。</para>
      </listitem>

      <listitem>
	<para>如何在撥號連線上使用郵件。</para>
      </listitem>

      <listitem>
	<para>如何設定 SMTP 認証來增加安全性。</para>
      </listitem>

      <listitem>
	<para>如何安裝並使用郵件使用者代理程式 (Mail User Agent) 如 <application>mutt</application> 來寄發與接收電子郵件。</para>
      </listitem>

      <listitem>
	<para>如何從遠端的 <acronym>POP</acronym> 或 <acronym>IMAP</acronym> 伺服器下載郵件。</para>
      </listitem>

      <listitem>
	<para>如何自動套用過濾器及規則在收到的電子郵件上。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>正確的設定網路連線 (<xref linkend="advanced-networking"/>)。</para>
      </listitem>

      <listitem>
	<para>正確的設定郵件主機的 <acronym>DNS</acronym> 資訊 (<xref linkend="network-servers"/>)。</para>
      </listitem>

      <listitem>
	<para>了解如何安裝其他第三方軟體 (<xref linkend="ports"/>)。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="mail-using">
    <title>郵件組成</title>

    <indexterm xml:lang="en"><primary>POP</primary></indexterm>
    <indexterm xml:lang="en"><primary>IMAP</primary></indexterm>
    <indexterm xml:lang="en"><primary>DNS</primary></indexterm>
      <indexterm xml:lang="en">
	<primary>mail server daemons</primary>
	<secondary><application>Sendmail</application></secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>mail server daemons</primary>
	<secondary><application>Postfix</application></secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>mail server daemons</primary>
	<secondary><application>qmail</application></secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>mail server daemons</primary>
	<secondary><application>Exim</application></secondary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>email</primary>
	<secondary>receiving</secondary>
      </indexterm>
      <indexterm xml:lang="en"><primary>MX record</primary></indexterm>
      <indexterm xml:lang="en"><primary>mail host</primary></indexterm>

    <para xml:lang="en">There are five major parts involved in an email exchange:
      the Mail User Agent (<acronym>MUA</acronym>), the Mail Transfer
      Agent (<acronym>MTA</acronym>), a mail host, a remote or local
      mailbox, and <acronym>DNS</acronym>.  This section provides an
      overview of these components.</para>

    <variablelist>
      <varlistentry>
	<term>郵件使用者代理程式 (Mail User Agent, <acronym>MUA</acronym>)</term>
	<listitem>
	  <para xml:lang="en">The Mail User Agent (<acronym>MUA</acronym>) is an
	    application which is used to compose, send, and receive
	    emails.  This application can be a command line program,
	    such as the built-in <command>mail</command> utility or a
	    third-party application from the Ports Collection, such as
	    <application>mutt</application>,
	    <application>alpine</application>, or
	    <application>elm</application>.  Dozens of graphical
	    programs are also available in the Ports Collection,
	    including <application>Claws Mail</application>,
	    <application>Evolution</application>, and
	    <application>Thunderbird</application>.  Some
	    organizations provide a web mail program which can be
	    accessed through a web browser.  More information about
	    installing and using a <acronym>MUA</acronym> on FreeBSD can
	    be found in <xref linkend="mail-agents"/>.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>郵件傳輸代理程式 (Mail Transfer Agent, <acronym>MTA</acronym>)</term>
	<listitem>
	  <para xml:lang="en">The Mail Transfer Agent (<acronym>MTA</acronym>) is
	    responsible for receiving incoming mail and delivering
	    outgoing mail.  FreeBSD ships with
	    <application>Sendmail</application> as the default
	    <acronym>MTA</acronym>, but it also supports numerous
	    other mail server daemons, including
	    <application>Exim</application>,
	    <application>Postfix</application>, and
	    <application>qmail</application>.
	    <application>Sendmail</application> configuration is
	    described in <xref linkend="sendmail"/>.  If another
	    <acronym>MTA</acronym> is installed using the Ports
	    Collection, refer to its post-installation message for
	    FreeBSD-specific configuration details and the application's
	    website for more general configuration
	    instructions.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>郵件主機 (Mail Host) 與郵件信箱 (Mailbox)</term>
	<listitem>
	  <para xml:lang="en">The mail host is a server that is responsible for
	    delivering and receiving mail for a host or a network.
	    The mail host collects all mail sent to the domain and
	    stores it either in the default <filename>mbox</filename>
	    or the alternative Maildir format, depending on the
	    configuration.  Once mail has been stored, it may either
	    be read locally using a <acronym>MUA</acronym> or remotely
	    accessed and collected using protocols such as
	    <acronym>POP</acronym> or <acronym>IMAP</acronym>.  If
	    mail is read locally, a <acronym>POP</acronym> or
	    <acronym>IMAP</acronym> server does not need to be
	    installed.</para>

	  <para xml:lang="en">To access mailboxes remotely, a <acronym>POP</acronym>
	    or <acronym>IMAP</acronym> server is required as these
	    protocols allow users to connect to their mailboxes from
	    remote locations.  <acronym>IMAP</acronym> offers several
	    advantages over <acronym>POP</acronym>.  These include the
	    ability to store a copy of messages on a remote server
	    after they are downloaded and concurrent updates.
	    <acronym>IMAP</acronym> can be useful over low-speed links
	    as it allows users to fetch the structure of messages
	    without downloading them.  It can also perform tasks such
	    as searching on the server in order to minimize data
	    transfer between clients and servers.</para>

	  <para xml:lang="en">Several <acronym>POP</acronym> and
	    <acronym>IMAP</acronym> servers are available in the Ports
	    Collection.  These include
	    <package>mail/qpopper</package>,
	    <package>mail/imap-uw</package>,
	    <package>mail/courier-imap</package>, and
	    <package>mail/dovecot2</package>.</para>

	  <warning>
	    <para xml:lang="en">It should be noted that both <acronym>POP</acronym>
	      and <acronym>IMAP</acronym> transmit information,
	      including username and password credentials, in
	      clear-text.  To secure the transmission of information
	      across these protocols, consider tunneling sessions over
	      <citerefentry><refentrytitle>ssh</refentrytitle><manvolnum>1</manvolnum></citerefentry> (<xref linkend="security-ssh-tunneling"/>)
	      or using <acronym>SSL</acronym> (<xref linkend="openssl"/>).</para>
	  </warning>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>網域名稱系統 (<acronym>DNS</acronym>)</term>
	<listitem>
	  <para xml:lang="en">The Domain Name System (<acronym>DNS</acronym>) and
	    its daemon <command>named</command> play a large role in
	    the delivery of email.  In order to deliver mail from one
	    site to another, the <acronym>MTA</acronym> will look up
	    the remote site in <acronym>DNS</acronym> to determine
	    which host will receive mail for the destination.  This
	    process also occurs when mail is sent from a remote host
	    to the <acronym>MTA</acronym>.</para>

	  <para xml:lang="en">In addition to mapping hostnames to
	    <acronym>IP</acronym> addresses, <acronym>DNS</acronym> is
	    responsible for storing information specific to mail
	    delivery, known as Mail eXchanger
	    <acronym>MX</acronym> records.  The <acronym>MX</acronym>
	    record specifies which hosts will receive mail for a
	    particular domain.</para>

	  <para xml:lang="en">To view the <acronym>MX</acronym> records for a
	    domain, specify the type of record.   Refer to
	    <citerefentry><refentrytitle>host</refentrytitle><manvolnum>1</manvolnum></citerefentry>, for more details about this command:</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>host -t mx FreeBSD.org</userinput>
FreeBSD.org mail is handled by 10 mx1.FreeBSD.org</screen>

	  <para xml:lang="en">Refer to <xref linkend="network-dns"/> for more
	    information about <acronym>DNS</acronym> and its
	    configuration.</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </sect1>

  <sect1 xml:id="sendmail">
    <info>
      <title><application>Sendmail</application> 設定檔</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Christopher</firstname>
	    <surname>Shumway</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary><application>Sendmail</application></primary>
    </indexterm>

    <para xml:lang="en"><application>Sendmail</application> is the default
      <acronym>MTA</acronym> installed with FreeBSD.  It accepts mail
      from <acronym>MUA</acronym>s and delivers it to the appropriate
      mail host, as defined by its configuration.
      <application>Sendmail</application> can also accept network
      connections and deliver mail to local mailboxes or to another
      program.</para>

    <para xml:lang="en">The configuration files for
      <application>Sendmail</application> are located in
      <filename>/etc/mail</filename>.  This section describes these
      files in more detail.</para>

    <indexterm xml:lang="en">
      <primary><filename>/etc/mail/access</filename></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><filename>/etc/mail/aliases</filename></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><filename>/etc/mail/local-host-names</filename></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><filename>/etc/mail/mailer.conf</filename></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><filename>/etc/mail/mailertable</filename></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><filename>/etc/mail/sendmail.cf</filename></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><filename>/etc/mail/virtusertable</filename></primary>
    </indexterm>

    <variablelist>
      <varlistentry>
	<term xml:lang="en"><filename>/etc/mail/access</filename></term>
	<listitem>
	  <para xml:lang="en">This access database file defines which hosts or
	    <acronym>IP</acronym> addresses have access to the local
	    mail server and what kind of access they have.  Hosts
	    listed as <option>OK</option>, which is the default
	    option, are allowed to send mail to this host as long as
	    the mail's final destination is the local machine.  Hosts
	    listed as <option>REJECT</option> are rejected for all
	    mail connections.  Hosts listed as <option>RELAY</option>
	    are allowed to send mail for any destination using this
	    mail server.  Hosts listed as <option>ERROR</option> will
	    have their mail returned with the specified mail error.
	    If a host is listed as <option>SKIP</option>,
	    <application>Sendmail</application> will abort the current
	    search for this entry without accepting or rejecting the
	    mail.  Hosts listed as <option>QUARANTINE</option> will
	    have their messages held and will receive the specified
	    text as the reason for the hold.</para>

	  <para xml:lang="en">Examples of using these options for both
	    <acronym>IPv4</acronym> and <acronym>IPv6</acronym>
	    addresses can be found in the FreeBSD sample configuration,
	    <filename>/etc/mail/access.sample</filename>:</para>

	  <programlisting xml:lang="en"># <phrase its:translate="no">$FreeBSD$</phrase>
#
# Mail relay access control list.  Default is to reject mail unless the
# destination is local, or listed in /etc/mail/local-host-names
#
## Examples (commented out for safety)
#From:cyberspammer.com          ERROR:"550 We don't accept mail from spammers"
#From:okay.cyberspammer.com     OK
#Connect:sendmail.org           RELAY
#To:sendmail.org                RELAY
#Connect:128.32                 RELAY
#Connect:128.32.2               SKIP
#Connect:IPv6:1:2:3:4:5:6:7     RELAY
#Connect:suspicious.example.com QUARANTINE:Mail from suspicious host
#Connect:[127.0.0.3]            OK
#Connect:[IPv6:1:2:3:4:5:6:7:8] OK</programlisting>

	  <para xml:lang="en">To configure the access database, use the format shown
	    in the sample to make entries in
	    <filename>/etc/mail/access</filename>, but do not put a
	    comment symbol (<literal>#</literal>) in front of the
	    entries.  Create an entry for each host or network whose
	    access should be configured.  Mail senders that match the
	    left side of the table are affected by the action on the
	    right side of the table.</para>

	  <para xml:lang="en">Whenever this file is updated, update its database and
	    restart <application>Sendmail</application>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>makemap hash /etc/mail/access &lt; /etc/mail/access</userinput>
<prompt>#</prompt> <userinput>service sendmail restart</userinput></screen>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en"><filename>/etc/mail/aliases</filename></term>
	<listitem>
	  <para xml:lang="en">This database file contains a list of virtual
	    mailboxes that are expanded to users, files, programs, or
	    other aliases.  Here are a few entries to illustrate the
	    file format:</para>

	  <programlisting xml:lang="en">root: localuser
ftp-bugs: joe,eric,paul
bit.bucket:  /dev/null
procmail: "|/usr/local/bin/procmail"</programlisting>

	  <para xml:lang="en">The mailbox name on the left side of the colon is
	    expanded to the target(s) on the right.  The first entry
	    expands the <systemitem class="username">root</systemitem>
	    mailbox  to the <systemitem class="username">localuser</systemitem> mailbox, which
	    is then looked up in the
	    <filename>/etc/mail/aliases</filename> database.  If no
	    match is found, the message is delivered to <systemitem class="username">localuser</systemitem>.  The second
	    entry shows a mail list.  Mail to <systemitem class="username">ftp-bugs</systemitem> is expanded to
	    the three local mailboxes <systemitem class="username">joe</systemitem>, <systemitem class="username">eric</systemitem>, and <systemitem class="username">paul</systemitem>.  A remote mailbox
	    could be specified as
	    <replaceable>user@example.com</replaceable>.  The third
	    entry shows how to write mail to a file, in this case
	    <filename>/dev/null</filename>.  The last entry
	    demonstrates how to send mail to a program,
	    <filename>/usr/local/bin/procmail</filename>, through a
	    <trademark class="registered">UNIX</trademark> pipe.  Refer to <citerefentry><refentrytitle>aliases</refentrytitle><manvolnum>5</manvolnum></citerefentry> for more
	    information about the format of this file.</para>

	  <para xml:lang="en">Whenever this file is updated, run
	    <command>newaliases</command> to update and initialize the
	    aliases database.</para>
	</listitem>
      </varlistentry>
<!--
This section needs to explain that this feature is for hosts with
alternate names, such as a host that MXs for a dynamic set of other
hosts.
It won't work unless freebsd.mc is built with FEATURE(`use_cw_file'),
meaning it needs a section to refer to on how to make mc files.
    <varlistentry>
      <term><filename>/etc/mail/local-host-names</filename></term>
      <listitem>
      <para>This is a list of hostnames <application>Sendmail</application> will accept
	as the local host name.  Place any domains or hosts that
	<application>Sendmail</application> will receive mail for.
	For example, to configure a mail server to accept mail for the
	domain <systemitem
	  class="fqdomainname">example.com</systemitem> and the host
	<systemitem
	  class="fqdomainname">mail.example.com</systemitem>, add
	these entries to
	<filename>local-host-names</filename>:</para>

      <programlisting>example.com
mail.example.com</programlisting>

    <para>Whenever this file is updated, &man.sendmail.8; needs to be
      restarted so that it will read the changes.</para>
  </listitem>
  </varlistentry>
  -->
      <varlistentry>
	<term xml:lang="en"><filename>/etc/mail/sendmail.cf</filename></term>
	<listitem>
	  <para xml:lang="en">This is the master configuration file for
	    <application>Sendmail</application>.  It controls the
	    overall behavior of <application>Sendmail</application>,
	    including everything from rewriting email addresses to
	    printing rejection messages to remote mail servers.
	    Accordingly, this configuration file is quite complex.
	    Fortunately, this file rarely needs to be changed for
	    standard mail servers.</para>

	  <para xml:lang="en">The master <application>Sendmail</application>
	    configuration file can be built from <citerefentry><refentrytitle>m4</refentrytitle><manvolnum>1</manvolnum></citerefentry> macros
	    that define the features and behavior of
	    <application>Sendmail</application>.  Refer to
	    <filename>/usr/src/contrib/sendmail/cf/README</filename>
	    for some of the details.</para>

	  <para xml:lang="en">Whenever changes to this file are made,
	    <application>Sendmail</application> needs to be restarted
	    for the changes to take effect.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en"><filename>/etc/mail/virtusertable</filename></term>
	<listitem>
	  <para xml:lang="en">This database file maps mail addresses for virtual
	    domains and users to real mailboxes.  These mailboxes can
	    be local, remote, aliases defined in
	    <filename>/etc/mail/aliases</filename>, or files.  This
	    allows multiple virtual domains to be hosted on one
	    machine.</para>

	  <para xml:lang="en">FreeBSD provides a sample configuration file in
	    <filename>/etc/mail/virtusertable.sample</filename> to
	    further demonstrate its format.  The following example
	    demonstrates how to create custom entries using that
	    format:</para>

	  <programlisting xml:lang="en">root@example.com                root
postmaster@example.com          postmaster@noc.example.net
@example.com                    joe</programlisting>

	  <para xml:lang="en">This file is processed in a first match order.   When
	    an email address matches the address on the left, it is
	    mapped to the local mailbox listed on the right.  The
	    format of the first entry in this example maps a specific
	    email address to a local mailbox, whereas the format of
	    the second entry maps a specific email address to a remote
	    mailbox.  Finally, any email address from
	    <literal>example.com</literal> which has not matched any
	    of the previous entries will match the last mapping and be
	    sent to the local mailbox <literal>joe</literal>.  When
	    creating custom entries, use this format and add them to
	    <filename>/etc/mail/virtusertable</filename>.  Whenever
	    this file is edited, update its database and restart
	    <application>Sendmail</application>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>makemap hash /etc/mail/virtusertable &lt; /etc/mail/virtusertable</userinput>
<prompt>#</prompt> <userinput>service sendmail restart</userinput></screen>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en"><filename>/etc/mail/relay-domains</filename></term>
	<listitem>
	  <para xml:lang="en">In a default FreeBSD installation,
	    <application>Sendmail</application> is configured to only
	    send mail from the host it is running on.  For example, if
	    a <acronym>POP</acronym> server is available, users will
	    be able to check mail from remote locations but they will
	    not be able to send outgoing emails from outside
	    locations.  Typically, a few moments after the attempt, an
	    email will be sent from <literal>MAILER-DAEMON</literal>
	    with a <errorname>5.7 Relaying Denied</errorname>
	    message.</para>

	  <para xml:lang="en">The most straightforward solution is to add the
	    <acronym>ISP</acronym>'s <acronym>FQDN</acronym> to
	    <filename>/etc/mail/relay-domains</filename>.  If multiple
	    addresses are needed, add them one per
	    line:</para>

	  <programlisting xml:lang="en">your.isp.example.com
other.isp.example.net
users-isp.example.org
www.example.org</programlisting>

	  <para xml:lang="en">After creating or editing this file, restart
	    <application>Sendmail</application> with
	    <command>service sendmail restart</command>.</para>

	  <para xml:lang="en">Now any mail sent through the system by any host in
	    this list, provided the user has an account on the system,
	    will succeed.  This allows users to send mail from the
	    system remotely without opening the system up to relaying
	    <acronym>SPAM</acronym> from the Internet.</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </sect1>

  <sect1 xml:id="mail-changingmta">
    <info>
      <title>更改郵件傳輸代理程式</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Andrew</firstname>
	    <surname>Boothman</surname>
	  </personname>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Gregory</firstname>
	    <surname>Neil Shapiro</surname>
	  </personname>
	  <contrib>Information taken from emails written by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>email</primary>
      <secondary>change mta</secondary>
    </indexterm>

    <para xml:lang="en">FreeBSD comes with <application>Sendmail</application> already
      installed as the <acronym>MTA</acronym> which is in charge of
      outgoing and incoming mail.  However, the system administrator
      can change the system's <acronym>MTA</acronym>.  A wide choice
      of alternative <acronym>MTA</acronym>s is available from the
      <literal>mail</literal> category of the FreeBSD Ports
      Collection.</para>

    <para xml:lang="en">Once a new <acronym>MTA</acronym> is installed, configure
      and test the new software before replacing
      <application>Sendmail</application>.  Refer to the documentation
      of the new <acronym>MTA</acronym> for information on how to
      configure the software.</para>

    <para xml:lang="en">Once the new <acronym>MTA</acronym> is working, use the
      instructions in this section to disable
      <application>Sendmail</application> and configure FreeBSD to use
      the replacement <acronym>MTA</acronym>.</para>

    <sect2 xml:id="mail-disable-sendmail">
      <title>關閉 <application>Sendmail</application></title>

      <warning>
	<para xml:lang="en">If <application>Sendmail</application>'s outgoing mail
	  service is disabled, it is important that it is replaced
	  with an alternative mail delivery system.  Otherwise, system
	  functions such as <citerefentry><refentrytitle>periodic</refentrytitle><manvolnum>8</manvolnum></citerefentry> will be unable to deliver
	  their results by email.  Many parts of the system expect a
	  functional <acronym>MTA</acronym>.  If applications continue
	  to use <application>Sendmail</application>'s binaries to try
	  to send email after they are disabled, mail could go into an
	  inactive <application>Sendmail</application> queue and
	  never be delivered.</para>
      </warning>

      <para xml:lang="en">In order to completely disable
	<application>Sendmail</application>, add or edit the following
	lines in <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">sendmail_enable="NO"
sendmail_submit_enable="NO"
sendmail_outbound_enable="NO"
sendmail_msp_queue_enable="NO"</programlisting>

      <para xml:lang="en">To only disable <application>Sendmail</application>'s
	incoming mail service, use only this entry in
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">sendmail_enable="NO"</programlisting>

      <para xml:lang="en">More information on <application>Sendmail</application>'s
	startup options is available in <citerefentry><refentrytitle>rc.sendmail</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
    </sect2>

    <sect2>
      <title>替換預設的 <acronym>MTA</acronym></title>

      <para xml:lang="en">When a new <acronym>MTA</acronym> is installed using the
	Ports Collection, its startup script is also installed and
	startup instructions are mentioned in its package message.
	Before starting the new <acronym>MTA</acronym>, stop the
	running <application>Sendmail</application> processes.  This
	example stops all of these services, then starts the
	<application>Postfix</application> service:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service sendmail stop</userinput>
<prompt>#</prompt> <userinput>service postfix start</userinput></screen>

      <para xml:lang="en">To start the replacement <acronym>MTA</acronym> at system
	boot, add its configuration line to
	<filename>/etc/rc.conf</filename>.  This entry enables the
	Postfix <acronym>MTA</acronym>:</para>

      <programlisting xml:lang="en">postfix_enable="YES"</programlisting>

      <para xml:lang="en">Some extra configuration is needed as
	<application>Sendmail</application> is so ubiquitous that some
	software assumes it is already installed and configured.
	Check <filename>/etc/periodic.conf</filename> and make sure
	that these values are set to <literal>NO</literal>.  If this
	file does not exist, create it with these entries:</para>

      <programlisting xml:lang="en">daily_clean_hoststat_enable="NO"
daily_status_mail_rejects_enable="NO"
daily_status_include_submit_mailq="NO"
daily_submit_queuerun="NO"</programlisting>

      <para xml:lang="en">Some alternative <acronym>MTA</acronym>s provide their own
	compatible implementations of the
	<application>Sendmail</application> command-line interface in
	order to facilitate using them as drop-in replacements for
	<application>Sendmail</application>.  However, some
	<acronym>MUA</acronym>s may try to execute standard
	<application>Sendmail</application> binaries instead of the
	new <acronym>MTA</acronym>'s binaries.  FreeBSD uses
	<filename>/etc/mail/mailer.conf</filename> to map the expected
	<application>Sendmail</application> binaries to the location
	of the new binaries.  More information about this mapping can
	be found in <citerefentry><refentrytitle>mailwrapper</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

      <para xml:lang="en">The default <filename>/etc/mail/mailer.conf</filename>
	looks like this:</para>

      <programlisting xml:lang="en"># <phrase its:translate="no">$FreeBSD$</phrase>
#
# Execute the "real" sendmail program, named /usr/libexec/sendmail/sendmail
#
sendmail        /usr/libexec/sendmail/sendmail
send-mail       /usr/libexec/sendmail/sendmail
mailq           /usr/libexec/sendmail/sendmail
newaliases      /usr/libexec/sendmail/sendmail
hoststat        /usr/libexec/sendmail/sendmail
purgestat       /usr/libexec/sendmail/sendmail</programlisting>

      <para xml:lang="en">When any of the commands listed on the left are run, the
	system actually executes the associated command shown on the
	right.  This system makes it easy to change what binaries are
	executed when these default binaries are invoked.</para>

      <para xml:lang="en">Some <acronym>MTA</acronym>s, when installed using the
	Ports Collection, will prompt to update this file for the new
	binaries.  For example, <application>Postfix</application>
	will update the file like this:</para>

      <programlisting xml:lang="en">#
# Execute the Postfix sendmail program, named /usr/local/sbin/sendmail
#
sendmail        /usr/local/sbin/sendmail
send-mail       /usr/local/sbin/sendmail
mailq           /usr/local/sbin/sendmail
newaliases      /usr/local/sbin/sendmail</programlisting>

      <para xml:lang="en">If the installation of the <acronym>MTA</acronym> does
	not automatically update
	<filename>/etc/mail/mailer.conf</filename>, edit this file in
	a text editor so that it points to the new binaries.  This
	example points to the binaries installed by
	<package>mail/ssmtp</package>:</para>

      <programlisting xml:lang="en">sendmail        /usr/local/sbin/ssmtp
send-mail       /usr/local/sbin/ssmtp
mailq           /usr/local/sbin/ssmtp
newaliases      /usr/local/sbin/ssmtp
hoststat        /usr/bin/true
purgestat       /usr/bin/true</programlisting>

      <para xml:lang="en">Once everything is configured, it is recommended to reboot
	the system.  Rebooting provides the opportunity to ensure that
	the system is correctly configured to start the new
	<acronym>MTA</acronym> automatically on boot.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="mail-trouble">
    <title>疑難排解</title>

    <indexterm xml:lang="en">
      <primary>email</primary>
      <secondary>troubleshooting</secondary>
    </indexterm>

    <qandaset>
      <qandaentry>
	<question>
	  <para xml:lang="en">Why do I have to use the FQDN for hosts on my
	    site?</para>
	</question>

	<answer>
	  <para xml:lang="en">The host may actually be in a different domain.  For
	    example, in order for a host in <systemitem class="fqdomainname">foo.bar.edu</systemitem> to reach a
	    host called <systemitem>mumble</systemitem> in the
	    <systemitem class="fqdomainname">bar.edu</systemitem>
	    domain, refer to it by the Fully-Qualified Domain Name
	    <acronym>FQDN</acronym>, <systemitem class="fqdomainname">mumble.bar.edu</systemitem>,
	    instead of just <systemitem>mumble</systemitem>.</para>

	  <para xml:lang="en">This is because the version of
	    <application>BIND</application><indexterm xml:lang="en">
	    <primary>BIND</primary></indexterm> which ships with FreeBSD
	    no longer provides default abbreviations for non-FQDNs
	    other than the local domain.  An unqualified host such as
	    <systemitem>mumble</systemitem> must either be found as
	    <systemitem class="fqdomainname">mumble.foo.bar.edu</systemitem>, or
	    it will be searched for in the root domain.</para>

	  <para xml:lang="en">In older versions of <application>BIND</application>,
	    the search continued across <systemitem class="fqdomainname">mumble.bar.edu</systemitem>, and
	    <systemitem class="fqdomainname">mumble.edu</systemitem>.
	    RFC 1535 details why this is considered bad practice or
	    even a security hole.</para>

	  <para xml:lang="en">As a good workaround, place the line:</para>

	  <programlisting xml:lang="en">search foo.bar.edu bar.edu</programlisting>

	  <para xml:lang="en">instead of the previous:</para>

	  <programlisting xml:lang="en">domain foo.bar.edu</programlisting>

	  <para xml:lang="en">into <filename>/etc/resolv.conf</filename>.  However,
	    make sure that the search order does not go beyond the
	    <quote>boundary between local and public
	      administration</quote>, as RFC 1535 calls it.</para>
	</answer>
      </qandaentry>

      <qandaentry>
	<question>
	  <para xml:lang="en">How can I run a mail server on a dial-up PPP
	    host?</para>
	</question>

	<answer>
	  <para xml:lang="en">Connect to a FreeBSD mail gateway on the LAN.  The PPP
	    connection is non-dedicated.</para>

	  <para xml:lang="en">One way to do this is to get a full-time Internet
	    server to provide secondary
	    <acronym>MX</acronym>
	    <indexterm xml:lang="en"><primary>MX record</primary></indexterm>
	    services for the domain.  In this example, the domain is
	    <systemitem class="fqdomainname">example.com</systemitem>
	    and the ISP has configured
	    <systemitem class="fqdomainname">example.net</systemitem>
	    to provide secondary <acronym>MX</acronym> services to the
	    domain:</para>

	  <programlisting xml:lang="en">example.com.          MX        10      example.com.
                      MX        20      example.net.</programlisting>

	  <para xml:lang="en">Only one host should be specified as the final
	    recipient.  For <application>Sendmail</application>, add
	    <literal>Cw example.com</literal> in
	    <filename>/etc/mail/sendmail.cf</filename> on <systemitem class="fqdomainname">example.com</systemitem>.</para>

	  <para xml:lang="en">When the sending <acronym>MTA</acronym> attempts
	    to deliver mail, it will try to connect to the system,
	    <systemitem class="fqdomainname">example.com</systemitem>,
	    over the PPP link.  This will time out if the destination
	    is offline.  The <acronym>MTA</acronym> will automatically
	    deliver it to the secondary <acronym>MX</acronym> site at
	    the Internet Service Provider (<acronym>ISP</acronym>),
	    <systemitem class="fqdomainname">example.net</systemitem>.
	    The secondary <acronym>MX</acronym> site will periodically
	    try to connect to the primary <acronym>MX</acronym> host,
	    <systemitem class="fqdomainname">example.com</systemitem>.</para>

	  <para xml:lang="en">Use something like this as a login script:</para>

	  <programlisting xml:lang="en">#!/bin/sh
# Put me in /usr/local/bin/pppmyisp
( sleep 60 ; /usr/sbin/sendmail -q ) &amp;
/usr/sbin/ppp -direct pppmyisp</programlisting>

	  <para xml:lang="en">When creating a separate login script for users,
	    instead use <command>sendmail -qRexample.com</command> in
	    the script above.  This will force all mail in the queue
	    for
	    <systemitem class="fqdomainname">example.com</systemitem>
	    to be processed immediately.</para>

	  <para xml:lang="en">A further refinement of the situation can be seen from
	    this example from the <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-isp">FreeBSD Internet service provider's mailing list</link>:</para>

	  <programlisting xml:lang="en">&gt; we provide the secondary MX for a customer. The customer connects to
&gt; our services several times a day automatically to get the mails to
&gt; his primary MX (We do not call his site when a mail for his domains
&gt; arrived). Our sendmail sends the mailqueue every 30 minutes. At the
&gt; moment he has to stay 30 minutes online to be sure that all mail is
&gt; gone to the primary MX.
&gt;
&gt; Is there a command that would initiate sendmail to send all the mails
&gt; now? The user has not root-privileges on our machine of course.

In the <quote>privacy flags</quote> section of sendmail.cf, there is a
definition Opgoaway,restrictqrun

Remove restrictqrun to allow non-root users to start the queue processing.
You might also like to rearrange the MXs. We are the 1st MX for our
customers like this, and we have defined:

# If we are the best MX for a host, try directly instead of generating
# local config error.
OwTrue

That way a remote site will deliver straight to you, without trying
the customer connection.  You then send to your customer.  Only works for
<quote>hosts</quote>, so you need to get your customer to name their mail
machine <quote>customer.com</quote> as well as
<quote>hostname.customer.com</quote> in the DNS.  Just put an A record in
the DNS for <quote>customer.com</quote>.</programlisting>
	</answer>
      </qandaentry>
    </qandaset>
  </sect1>

  <sect1 xml:id="mail-advanced">
    <title>進階主題</title>

    <para xml:lang="en">This section covers more involved topics such as mail
      configuration and setting up mail for an entire domain.</para>

    <sect2 xml:id="mail-config">
      <title>基礎設定</title>

      <indexterm xml:lang="en">
	<primary>email</primary>
	<secondary>configuration</secondary>
      </indexterm>

      <para xml:lang="en">Out of the box, one can send email to external hosts as
	long as <filename>/etc/resolv.conf</filename> is configured or
	the network has access to a configured <acronym>DNS</acronym>
	server.  To have email delivered to the <acronym>MTA</acronym>
	on the FreeBSD host, do one of the following:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Run a <acronym>DNS</acronym> server for the
	    domain.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Get mail delivered directly to the
	    <acronym>FQDN</acronym> for the machine.</para>
	</listitem>
      </itemizedlist>

      <indexterm xml:lang="en"><primary>SMTP</primary></indexterm>
      <para xml:lang="en">In order to have mail delivered directly to a host, it
	must have a permanent static IP address, not a dynamic IP
	address.  If the system is behind a firewall, it must be
	configured to allow SMTP traffic.  To receive mail directly at
	a host, one of these two must be configured:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Make sure that the lowest-numbered
	    <acronym>MX</acronym><indexterm xml:lang="en"><primary>MX
	      record</primary></indexterm> record in
	    <acronym>DNS</acronym> points to the host's static IP
	    address.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Make sure there is no <acronym>MX</acronym> entry in
	    the <acronym>DNS</acronym> for the host.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">Either of the above will allow mail to be received
	directly at the host.</para>

      <para xml:lang="en">Try this:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>hostname</userinput>
example.FreeBSD.org
<prompt>#</prompt> <userinput>host example.FreeBSD.org</userinput>
example.FreeBSD.org has address 204.216.27.XX</screen>

      <para xml:lang="en">In this example, mail sent directly to
	<email role="nolink">yourlogin@example.FreeBSD.org</email>
	should work without problems, assuming
	<application>Sendmail</application> is running correctly on
	<systemitem class="fqdomainname">example.FreeBSD.org</systemitem>.</para>

      <para xml:lang="en">For this example:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>host example.FreeBSD.org</userinput>
example.FreeBSD.org has address 204.216.27.XX
example.FreeBSD.org mail is handled (pri=10) by nevdull.FreeBSD.org</screen>

      <para xml:lang="en">All mail sent to <systemitem class="fqdomainname">example.FreeBSD.org</systemitem> will
	be collected on <systemitem>hub</systemitem> under the same
	username instead of being sent directly to your host.</para>

      <para xml:lang="en">The above information is handled by the
	<acronym>DNS</acronym> server.  The <acronym>DNS</acronym>
	record that carries mail routing information is the
	<acronym>MX</acronym> entry.  If no <acronym>MX</acronym>
	record exists, mail will be delivered directly to the host by
	way of its IP address.</para>

      <para xml:lang="en">The <acronym>MX</acronym> entry for <systemitem class="fqdomainname">freefall.FreeBSD.org</systemitem> at
	one time looked like this:</para>

      <programlisting xml:lang="en">freefall		MX	30	mail.crl.net
freefall		MX	40	agora.rdrop.com
freefall		MX	10	freefall.FreeBSD.org
freefall		MX	20	who.cdrom.com</programlisting>

      <para xml:lang="en"><systemitem>freefall</systemitem> had many
	<acronym>MX</acronym> entries.  The lowest
	<acronym>MX</acronym> number is the host that receives mail
	directly, if available.  If it is not accessible for some
	reason, the next lower-numbered host will accept messages
	temporarily, and pass it along when a lower-numbered host
	becomes available.</para>

      <para xml:lang="en">Alternate <acronym>MX</acronym> sites should have separate
	Internet connections in order to be most useful.  Your
	<acronym>ISP</acronym> can provide this service.</para>
    </sect2>

    <sect2 xml:id="mail-domain">
      <title>網域中的郵件</title>

      <para xml:lang="en">When configuring a <acronym>MTA</acronym> for a network,
	any mail sent to hosts in its domain should be diverted to the
	<acronym>MTA</acronym> so that users can receive their mail on
	the master mail server.</para>

      <indexterm xml:lang="en"><primary>DNS</primary></indexterm>
      <para xml:lang="en">To make life easiest, a user account with the same
	<emphasis>username</emphasis> should exist on both the
	<acronym>MTA</acronym> and the system with the
	<acronym>MUA</acronym>.  Use <citerefentry><refentrytitle>adduser</refentrytitle><manvolnum>8</manvolnum></citerefentry> to create the
	user accounts.</para>

      <para xml:lang="en">The <acronym>MTA</acronym> must be the designated mail
	exchanger for each workstation on the network.  This is done
	in the<acronym>DNS</acronym> configuration with an
	<acronym>MX</acronym> record:</para>

      <programlisting xml:lang="en">example.FreeBSD.org	A	204.216.27.XX		; Workstation
			MX	10 nevdull.FreeBSD.org	; Mailhost</programlisting>

      <para xml:lang="en">This will redirect mail for the workstation to the
	<acronym>MTA</acronym> no matter where the A record points.
	The mail is sent to the <acronym>MX</acronym> host.</para>

      <para xml:lang="en">This must be configured on a <acronym>DNS</acronym>
	server.  If the network does not run its own
	<acronym>DNS</acronym> server, talk to the
	<acronym>ISP</acronym> or <acronym>DNS</acronym>
	provider.</para>

      <para xml:lang="en">The following is an example of virtual email hosting.
	Consider a customer with the domain <systemitem class="fqdomainname">customer1.org</systemitem>, where all
	the mail for <systemitem class="fqdomainname">customer1.org</systemitem> should be
	sent to <systemitem class="fqdomainname">mail.myhost.com</systemitem>.  The
	<acronym>DNS</acronym> entry should look like this:</para>

      <programlisting xml:lang="en">customer1.org		MX	10	mail.myhost.com</programlisting>

      <para xml:lang="en">An <literal>A</literal>&gt; record is
	<emphasis>not</emphasis> needed for <systemitem class="fqdomainname">customer1.org</systemitem> in order to
	only handle email for that domain.  However, running
	<command>ping</command> against <systemitem class="fqdomainname">customer1.org</systemitem> will not
	work unless an <literal>A</literal> record exists for
	it.</para>

      <para xml:lang="en">Tell the <acronym>MTA</acronym> which domains and/or
	hostnames it should accept mail for.  Either of the following
	will work for <application>Sendmail</application>:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Add the hosts to
	    <filename>/etc/mail/local-host-names</filename> when
	    using the <literal>FEATURE(use_cw_file)</literal>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Add a <literal>Cwyour.host.com</literal> line to
	    <filename>/etc/sendmail.cf</filename>.</para>
	</listitem>
      </itemizedlist>
    </sect2>
  </sect1>

  <sect1 xml:id="outgoing-only">
    <info>
      <title>寄件設定</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Bill</firstname>
	    <surname>Moran</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <para xml:lang="en">There are many instances where one may only want to send
      mail through a relay.  Some examples are:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">The computer is a desktop machine that needs to use
	  programs such as <citerefentry><refentrytitle>mail</refentrytitle><manvolnum>1</manvolnum></citerefentry>, using the
	  <acronym>ISP</acronym>'s mail relay.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The computer is a server that does not handle mail
	  locally, but needs to pass off all mail to a relay for
	  processing.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">While any <acronym>MTA</acronym> is capable of filling
      this particular niche, it can be difficult to properly configure
      a full-featured <acronym>MTA</acronym> just to handle offloading
      mail.  Programs such as <application>Sendmail</application> and
      <application>Postfix</application> are overkill for this
      use.</para>

    <para xml:lang="en">Additionally, a typical Internet access service agreement
      may forbid one from running a <quote>mail server</quote>.</para>

    <para xml:lang="en">The easiest way to fulfill those needs is to install the
      <package>mail/ssmtp</package> port:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/mail/ssmtp</userinput>
<prompt>#</prompt> <userinput>make install replace clean</userinput></screen>

    <para xml:lang="en">Once installed, <package>mail/ssmtp</package> can be
      configured with
      <filename>/usr/local/etc/ssmtp/ssmtp.conf</filename>:</para>

    <programlisting xml:lang="en">root=yourrealemail@example.com
mailhub=mail.example.com
rewriteDomain=example.com
hostname=_HOSTNAME_</programlisting>

    <para xml:lang="en">Use the real email address for <systemitem class="username">root</systemitem>.  Enter the
      <acronym>ISP</acronym>'s outgoing mail relay in place of
      <systemitem class="fqdomainname">mail.example.com</systemitem>.
      Some <acronym>ISP</acronym>s call this the <quote>outgoing mail
	server</quote> or <quote>SMTP server</quote>.</para>

    <para xml:lang="en">Make sure to disable <application>Sendmail</application>,
      including the outgoing mail service.  See <xref linkend="mail-disable-sendmail"/> for details.</para>

    <para xml:lang="en"><package>mail/ssmtp</package> has some other options
      available.  Refer to the examples in
      <filename>/usr/local/etc/ssmtp</filename> or the manual page
      of <application>ssmtp</application> for more information.</para>

    <para xml:lang="en">Setting up <application>ssmtp</application> in this manner
      allows any software on the computer that needs to send mail to
      function properly, while not violating the
      <acronym>ISP</acronym>'s usage policy or allowing the computer
      to be hijacked for spamming.</para>
  </sect1>

  <sect1 xml:id="SMTP-dialup">
    <title>在撥號連線使用郵件</title>

    <para xml:lang="en">When using a static IP address, one should not need to
      adjust the default configuration.  Set the hostname to the
      assigned Internet name and <application>Sendmail</application>
      will do the rest.</para>

    <para xml:lang="en">When using a dynamically assigned IP address and a dialup
      PPP connection to the Internet, one usually has a mailbox on the
      <acronym>ISP</acronym>'s mail server.  In this example, the
      <acronym>ISP</acronym>'s domain is <systemitem class="fqdomainname">example.net</systemitem>, the user name
      is <systemitem class="username">user</systemitem>, the hostname
      is <systemitem class="fqdomainname">bsd.home</systemitem>, and
      the <acronym>ISP</acronym> has allowed <systemitem class="fqdomainname">relay.example.net</systemitem> as a mail
      relay.</para>

    <para xml:lang="en">In order to retrieve mail from the <acronym>ISP</acronym>'s
      mailbox, install a retrieval agent from the Ports Collection.
      <package>mail/fetchmail</package> is a good choice as it
      supports many different protocols.  Usually, the
      <acronym>ISP</acronym> will provide <acronym>POP</acronym>.
      When using user <acronym>PPP</acronym>, email can be
      automatically fetched when an Internet connection is established
      with the following entry in
      <filename>/etc/ppp/ppp.linkup</filename>:</para>

    <programlisting xml:lang="en">MYADDR:
!bg su user -c fetchmail</programlisting>

    <para xml:lang="en">When using <application>Sendmail</application> to deliver
      mail to non-local accounts, configure
      <application>Sendmail</application> to process the mail queue as
      soon as the Internet connection is established.  To do this, add
      this line after the above <command>fetchmail</command> entry in
      <filename>/etc/ppp/ppp.linkup</filename>:</para>

    <programlisting xml:lang="en">  !bg su user -c "sendmail -q"</programlisting>

    <para xml:lang="en">In this example, there is an account for
      <systemitem class="username">user</systemitem> on <systemitem class="fqdomainname">bsd.home</systemitem>.  In the home
      directory of <systemitem class="username">user</systemitem> on
      <systemitem class="fqdomainname">bsd.home</systemitem>, create a
      <filename>.fetchmailrc</filename> which contains this
      line:</para>

    <programlisting xml:lang="en">poll example.net protocol pop3 fetchall pass MySecret</programlisting>

    <para xml:lang="en">This file should not be readable by anyone except
      <systemitem class="username">user</systemitem> as it contains
      the password <literal>MySecret</literal>.</para>

    <para xml:lang="en">In order to send mail with the correct
      <literal>from:</literal> header, configure
      <application>Sendmail</application> to use
      <email>user@example.net</email> rather than <email role="nolink">user@bsd.home</email> and to send all mail via
      <systemitem class="fqdomainname">relay.example.net</systemitem>,
      allowing quicker mail transmission.</para>

    <para xml:lang="en">The following <filename>.mc</filename> should
      suffice:</para>

    <programlisting xml:lang="en">VERSIONID(`bsd.home.mc version 1.0')
OSTYPE(bsd4.4)dnl
FEATURE(nouucp)dnl
MAILER(local)dnl
MAILER(smtp)dnl
Cwlocalhost
Cwbsd.home
MASQUERADE_AS(`example.net')dnl
FEATURE(allmasquerade)dnl
FEATURE(masquerade_envelope)dnl
FEATURE(nocanonify)dnl
FEATURE(nodns)dnl
define(`SMART_HOST', `relay.example.net')
Dmbsd.home
define(`confDOMAIN_NAME',`bsd.home')dnl
define(`confDELIVERY_MODE',`deferred')dnl</programlisting>

    <para xml:lang="en">Refer to the previous section for details of how to convert
      this file into the <filename>sendmail.cf</filename> format.  Do
      not forget to restart <application>Sendmail</application> after
      updating <filename>sendmail.cf</filename>.</para>
  </sect1>

  <sect1 xml:id="SMTP-Auth">
    <info>
      <title>SMTP 認證</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>James</firstname>
	    <surname>Gorham</surname>
	  </personname>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>
    </info>

    <para xml:lang="en">Configuring <acronym>SMTP</acronym> authentication on the
      <acronym>MTA</acronym> provides a number of benefits.
      <acronym>SMTP</acronym> authentication adds a layer
      of security to <application>Sendmail</application>, and provides
      mobile users who switch hosts the ability to use the same
      <acronym>MTA</acronym> without the need to reconfigure their
      mail client's settings each time.</para>

    <procedure>
      <step>
	<para xml:lang="en">Install <package>security/cyrus-sasl2</package>
	  from the Ports Collection.  This port supports a number of
	  compile-time options.  For the SMTP authentication method
	  demonstrated in this example, make sure that
	  <option>LOGIN</option> is not disabled.</para>
      </step>


      <step>
	<para xml:lang="en">After installing
	  <package>security/cyrus-sasl2</package>, edit
	  <filename>/usr/local/lib/sasl2/Sendmail.conf</filename>,
	  or create it if it does not exist, and add the following
	  line:</para>

	<programlisting xml:lang="en">pwcheck_method: saslauthd</programlisting>
      </step>

      <step>
	<para xml:lang="en">Next, install
	  <package>security/cyrus-sasl2-saslauthd</package> and add
	  the following line to
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">saslauthd_enable="YES"</programlisting>

	<para xml:lang="en">Finally, start the saslauthd daemon:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service saslauthd start</userinput></screen>

	<para xml:lang="en">This daemon serves as a broker for
	  <application>Sendmail</application> to authenticate against
	  the FreeBSD <citerefentry><refentrytitle>passwd</refentrytitle><manvolnum>5</manvolnum></citerefentry> database.  This saves the trouble of
	  creating a new set of usernames and passwords for each user
	  that needs to use <acronym>SMTP</acronym> authentication,
	  and keeps the login and mail password the same.</para>
      </step>

      <step>
	<para xml:lang="en">Next, edit <filename>/etc/make.conf</filename> and add
	  the following lines:</para>

	<programlisting xml:lang="en">SENDMAIL_CFLAGS=-I/usr/local/include/sasl -DSASL
SENDMAIL_LDFLAGS=-L/usr/local/lib
SENDMAIL_LDADD=-lsasl2</programlisting>

	<para xml:lang="en">These lines provide <application>Sendmail</application>
	  the proper configuration options for linking to
	  <package>cyrus-sasl2</package> at compile time.  Make sure
	  that <package>cyrus-sasl2</package> has been installed
	  before recompiling
	  <application>Sendmail</application>.</para>
      </step>

      <step>
	<para xml:lang="en">Recompile <application>Sendmail</application> by
	  executing the following commands:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src/lib/libsmutil</userinput>
<prompt>#</prompt> <userinput>make cleandir &amp;&amp; make obj &amp;&amp; make</userinput>
<prompt>#</prompt> <userinput>cd /usr/src/lib/libsm</userinput>
<prompt>#</prompt> <userinput>make cleandir &amp;&amp; make obj &amp;&amp; make</userinput>
<prompt>#</prompt> <userinput>cd /usr/src/usr.sbin/sendmail</userinput>
<prompt>#</prompt> <userinput>make cleandir &amp;&amp; make obj &amp;&amp; make &amp;&amp; make install</userinput></screen>

	<para xml:lang="en">This compile should not have any problems if
	  <filename>/usr/src</filename> has not changed extensively
	  and the shared libraries it needs are available.</para>
      </step>

      <step>
	<para xml:lang="en">After <application>Sendmail</application> has been
	  compiled and reinstalled, edit
	  <filename>/etc/mail/freebsd.mc</filename> or the local
	  <filename>.mc</filename>.  Many administrators choose
	  to use the output from <citerefentry><refentrytitle>hostname</refentrytitle><manvolnum>1</manvolnum></citerefentry> as the name of
	  <filename>.mc</filename> for uniqueness.  Add these
	  lines:</para>

	<programlisting xml:lang="en">dnl set SASL options
TRUST_AUTH_MECH(`GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN')dnl
define(`confAUTH_MECHANISMS', `GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN')dnl</programlisting>

	<para xml:lang="en">These options configure the different methods available
	  to <application>Sendmail</application> for authenticating
	  users.  To use a method other than
	  <application>pwcheck</application>, refer to the
	  <application>Sendmail</application> documentation.</para>
      </step>

      <step>
	<para xml:lang="en">Finally, run <citerefentry><refentrytitle>make</refentrytitle><manvolnum>1</manvolnum></citerefentry> while in
	  <filename>/etc/mail</filename>.  That will run the new
	  <filename>.mc</filename> and create a
	  <filename>.cf</filename> named either
	  <filename>freebsd.cf</filename> or the name used for the
	  local <filename>.mc</filename>.  Then, run <command>make
	    install restart</command>, which will copy the file to
	  <filename>sendmail.cf</filename>, and properly restart
	  <application>Sendmail</application>.  For more information
	  about this process, refer to
	  <filename>/etc/mail/Makefile</filename>.</para>
      </step>
    </procedure>

    <para xml:lang="en">To test the configuration, use a <acronym>MUA</acronym> to
      send a test message.  For further investigation, set the
      <option>LogLevel</option> of <application>Sendmail</application>
      to <literal>13</literal> and watch
      <filename>/var/log/maillog</filename> for any errors.</para>

    <para xml:lang="en">For more information, refer to <link xlink:href="http://www.sendmail.org/~ca/email/auth.html">
	<acronym>SMTP</acronym> authentication</link>.</para>
  </sect1>

  <sect1 xml:id="mail-agents">
    <info>
      <title>郵件使用者代理程式</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Silver</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>Mail User Agents</primary>
    </indexterm>

    <para xml:lang="en">A <acronym>MUA</acronym> is an application that is used to
      send and receive email.  As email <quote>evolves</quote> and
      becomes more complex, <acronym>MUA</acronym>s are becoming
      increasingly powerful and provide users increased functionality
      and flexibility.  The <literal>mail</literal> category of the
      FreeBSD Ports Collection contains numerous <acronym>MUA</acronym>s.
      These include graphical email clients such as
      <application>Evolution</application> or
      <application>Balsa</application> and console based clients such
      as <application>mutt</application> or
      <application>alpine</application>.</para>

    <sect2 xml:id="mail-command">
      <title xml:lang="en"><command>mail</command></title>

      <para xml:lang="en"><citerefentry><refentrytitle>mail</refentrytitle><manvolnum>1</manvolnum></citerefentry> is the default
	<acronym>MUA</acronym> installed with FreeBSD.  It is a console
	based <acronym>MUA</acronym> that offers the basic
	functionality required to send and receive text-based email.
	It provides limited attachment support and can only access
	local mailboxes.</para>

      <para xml:lang="en">Although <command>mail</command> does not natively support
	interaction with <acronym>POP</acronym> or
	<acronym>IMAP</acronym> servers, these mailboxes may be
	downloaded to a local <filename>mbox</filename> using an
	application such as
	<application>fetchmail</application>.</para>

      <para xml:lang="en">In order to send and receive email, run
	<command>mail</command>:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>mail</userinput></screen>

      <para xml:lang="en">The contents of the user's mailbox in
	<filename>/var/mail</filename> are automatically read by
	<command>mail</command>.  Should the mailbox be empty, the
	utility exits with a message indicating that no mail could
	be found.  If mail exists, the application interface starts,
	and a list of messages will be displayed.  Messages are
	automatically numbered, as can be seen in the following
	example:</para>

      <screen xml:lang="en">Mail version 8.1 6/6/93.  Type ? for help.
"/var/mail/marcs": 3 messages 3 new
&gt;N  1 root@localhost        Mon Mar  8 14:05  14/510   "test"
 N  2 root@localhost        Mon Mar  8 14:05  14/509   "user account"
 N  3 root@localhost        Mon Mar  8 14:05  14/509   "sample"</screen>

      <para xml:lang="en">Messages can now be read by typing <keycap>t</keycap>
	followed by the message number.  This example reads the first
	email:</para>

      <screen xml:lang="en">&amp; <userinput>t 1</userinput>
Message 1:
From root@localhost  Mon Mar  8 14:05:52 2004
X-Original-To: marcs@localhost
Delivered-To: marcs@localhost
To: marcs@localhost
Subject: test
Date: Mon,  8 Mar 2004 14:05:52 +0200 (SAST)
From: root@localhost (Charlie Root)

This is a test message, please reply if you receive it.</screen>

      <para xml:lang="en">As seen in this example, the message will be displayed
	with full headers.  To display the list of messages again,
	press <keycap>h</keycap>.</para>

      <para xml:lang="en">If the email requires a reply, press either
	<keycap>R</keycap> or <keycap>r</keycap>
	<command>mail</command> keys.  <keycap>R</keycap> instructs
	<command>mail</command> to reply only to the sender of the
	email, while <keycap>r</keycap> replies to all other
	recipients of the message.  These commands can be suffixed
	with the mail number of the message to reply to.  After typing
	the response, the end of the message should be marked by a
	single <keycap>.</keycap> on its own line.  An example can be
	seen below:</para>

      <screen xml:lang="en">&amp; <userinput>R 1</userinput>
To: root@localhost
Subject: Re: test

<userinput>Thank you, I did get your email.
.</userinput>
EOT</screen>

      <para xml:lang="en">In order to send a new email, press <keycap>m</keycap>,
	followed by the recipient email address.  Multiple recipients
	may be specified by separating each address with the
	<keycap>,</keycap> delimiter.  The subject of the message may
	then be entered, followed by the message contents.  The end of
	the message should be specified by putting a single
	<keycap>.</keycap> on its own line.</para>

      <screen xml:lang="en">&amp; <userinput>mail root@localhost</userinput>
Subject: <userinput>I mastered mail

Now I can send and receive email using mail ... :)
.</userinput>
EOT</screen>

      <para xml:lang="en">While using <command>mail</command>, press
	<keycap>?</keycap> to display help at any time.  Refer to
	<citerefentry><refentrytitle>mail</refentrytitle><manvolnum>1</manvolnum></citerefentry> for more help on how to use
	<command>mail</command>.</para>

      <note>
	<para xml:lang="en"><citerefentry><refentrytitle>mail</refentrytitle><manvolnum>1</manvolnum></citerefentry> was not designed to handle attachments and
	  thus deals with them poorly.  Newer <acronym>MUA</acronym>s
	  handle attachments in a more intelligent way.  Users who
	  prefer to use <command>mail</command> may find the
	  <package>converters/mpack</package> port to be of
	  considerable use.</para>
      </note>
    </sect2>

    <sect2 xml:id="mutt-command">
      <title xml:lang="en"><application>mutt</application></title>

      <para xml:lang="en"><application>mutt</application> is a powerful
	<acronym>MUA</acronym>, with many features, including:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">The ability to thread messages.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">PGP support for digital signing and encryption of
	    email.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">MIME support.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Maildir support.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Highly customizable.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">Refer to <uri xlink:href="http://www.mutt.org">http://www.mutt.org</uri>
	for more information on
	<application>mutt</application>.</para>

      <para xml:lang="en"><application>mutt</application> may be installed using the
	<package>mail/mutt</package> port.  After the port has been
	installed, <application>mutt</application> can be started by
	issuing the following command:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>mutt</userinput></screen>

      <para xml:lang="en"><application>mutt</application> will automatically read
	and display the contents of the user mailbox in
	<filename>/var/mail</filename>.  If no mails are found,
	<application>mutt</application> will wait for commands from
	the user.  The example below shows
	<application>mutt</application> displaying a list of
	messages:</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="mail/mutt1"/>
	</imageobject>
      </mediaobject>

      <para xml:lang="en">To read an email, select it using the cursor keys and
	press <keycap>Enter</keycap>.  An example of
	<application>mutt</application> displaying email can be seen
	below:</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="mail/mutt2"/>
	</imageobject>
      </mediaobject>

      <para xml:lang="en">Similar to <citerefentry><refentrytitle>mail</refentrytitle><manvolnum>1</manvolnum></citerefentry>, <application>mutt</application>
	can be used to reply only to the sender of the message as well
	as to all recipients.  To reply only to the sender of the
	email, press <keycap>r</keycap>.  To send a group reply
	to the original sender as well as all the message recipients,
	press <keycap>g</keycap>.</para>

      <note>
	<para xml:lang="en">By default, <application>mutt</application> uses the
	  <citerefentry><refentrytitle>vi</refentrytitle><manvolnum>1</manvolnum></citerefentry> editor for creating and replying to emails.  Each
	  user can customize this by creating or editing the
	  <filename>.muttrc</filename> in their home directory and
	  setting the <literal>editor</literal> variable or by setting
	  the <envar>EDITOR</envar> environment variable.  Refer to
	  <uri xlink:href="http://www.mutt.org/">http://www.mutt.org/</uri>
	  for more information about configuring
	  <application>mutt</application>.</para>
      </note>

      <para xml:lang="en">To compose a new mail message, press
	<keycap>m</keycap>.  After a valid subject has been given,
	<application>mutt</application> will start <citerefentry><refentrytitle>vi</refentrytitle><manvolnum>1</manvolnum></citerefentry> so the
	email can be written.  Once the contents of the email are
	complete, save and quit from <command>vi</command>.
	<application>mutt</application> will resume, displaying a
	summary screen of the mail that is to be delivered.  In
	order to send the mail, press <keycap>y</keycap>.  An example
	of the summary screen can be seen below:</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="mail/mutt3"/>
	</imageobject>
      </mediaobject>

      <para xml:lang="en"><application>mutt</application> contains extensive help
	which can be accessed from most of the menus by pressing
	<keycap>?</keycap>.  The top line also displays the keyboard
	shortcuts where appropriate.</para>

    </sect2>

    <sect2 xml:id="alpine-command">
      <title xml:lang="en"><application>alpine</application></title>

      <para xml:lang="en"><application>alpine</application> is aimed at a beginner
	user, but also includes some advanced features.</para>

      <warning>
	<para xml:lang="en"><application>alpine</application> has had several remote
	  vulnerabilities discovered in the past, which allowed remote
	  attackers to execute arbitrary code as users on the local
	  system, by the action of sending a specially-prepared email.
	  While <emphasis>known</emphasis> problems have been fixed,
	  <application>alpine</application> code is written in an
	  insecure style and the FreeBSD Security Officer believes there
	  are likely to be other undiscovered vulnerabilities.  Users
	  install <application>alpine</application> at their own
	  risk.</para>
      </warning>

      <para xml:lang="en">The current version of <application>alpine</application>
	may be installed using the <package>mail/alpine</package>
	port.  Once the port has installed,
	<application>alpine</application> can be started by issuing
	the following command:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>alpine</userinput></screen>

      <para xml:lang="en">The first time <application>alpine</application>
	runs, it displays a greeting page with a brief introduction,
	as well as a request from the
	<application>alpine</application> development team to send
	an anonymous email message allowing them to judge how many
	users are using their client.  To send this anonymous message,
	press <keycap>Enter</keycap>.  Alternatively, press
	<keycap>E</keycap> to exit the greeting without sending an
	anonymous message.  An example of the greeting page is
	shown below:</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="mail/pine1"/>
	</imageobject>
      </mediaobject>

      <para xml:lang="en">The main menu is then presented, which can be navigated
	using the cursor keys.  This main menu provides shortcuts for
	the composing new mails, browsing mail directories, and
	administering address book entries.  Below the main menu,
	relevant keyboard shortcuts to perform functions specific to
	the task at hand are shown.</para>

      <para xml:lang="en">The default directory opened by
	<application>alpine</application> is
	<filename>inbox</filename>.  To view the message index, press
	<keycap>I</keycap>, or select the
	<guimenuitem>MESSAGE INDEX</guimenuitem> option shown
	below:</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="mail/pine2"/>
	</imageobject>
      </mediaobject>

      <para xml:lang="en">The message index shows messages in the current directory
	and can be navigated by using the cursor keys.  Highlighted
	messages can be read by pressing
	<keycap>Enter</keycap>.</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="mail/pine3"/>
	</imageobject>
      </mediaobject>

      <para xml:lang="en">In the screenshot below, a sample message is displayed by
	<application>alpine</application>.  Contextual keyboard
	shortcuts are displayed at the bottom of the screen.  An
	example of one of a shortcut is <keycap>r</keycap>, which
	tells the <acronym>MUA</acronym> to reply to the current
	message being displayed.</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="mail/pine4"/>
	</imageobject>
      </mediaobject>

      <para xml:lang="en">Replying to an email in <application>alpine</application>
	is done using the <application>pico</application> editor,
	which is installed by default with
	<application>alpine</application>.
	<application>pico</application> makes it easy to navigate the
	message and is easier for novice users to use than <citerefentry><refentrytitle>vi</refentrytitle><manvolnum>1</manvolnum></citerefentry>
	or <citerefentry><refentrytitle>mail</refentrytitle><manvolnum>1</manvolnum></citerefentry>.  Once the reply is complete, the message can
	be sent by pressing <keycombo action="simul"><keycap>Ctrl</keycap><keycap>X</keycap>
	</keycombo>.  <application>alpine</application> will ask for
	confirmation before sending the message.</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="mail/pine5"/>
	</imageobject>
      </mediaobject>

      <para xml:lang="en"><application>alpine</application> can be customized using
	the <guimenuitem>SETUP</guimenuitem> option from the main
	menu.  Consult <uri xlink:href="http://www.washington.edu/alpine/">http://www.washington.edu/alpine/</uri>
	for more information.</para>

    </sect2>
  </sect1>

  <sect1 xml:id="mail-fetchmail">
    <info>
      <title>使用 <application>fetchmail</application></title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Silver</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>fetchmail</primary>
    </indexterm>

    <para xml:lang="en"><application>fetchmail</application> is a full-featured
      <acronym>IMAP</acronym> and <acronym>POP</acronym> client.  It
      allows users to automatically download mail from remote
      <acronym>IMAP</acronym> and <acronym>POP</acronym> servers and
      save it into local mailboxes where it can be accessed more
      easily.  <application>fetchmail</application> can be installed
      using the <package>mail/fetchmail</package> port, and offers
      various features, including:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Support for the <acronym>POP3</acronym>,
	  <acronym>APOP</acronym>, <acronym>KPOP</acronym>,
	  <acronym>IMAP</acronym>, <acronym>ETRN</acronym> and
	  <acronym>ODMR</acronym> protocols.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Ability to forward mail using <acronym>SMTP</acronym>,
	  which allows filtering, forwarding, and aliasing to function
	  normally.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">May be run in daemon mode to check periodically for new
	  messages.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Can retrieve multiple mailboxes and forward them, based
	  on configuration, to different local users.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">This section explains some of the basic features of
      <application>fetchmail</application>.  This utility requires a
      <filename>.fetchmailrc</filename> configuration in the user's
      home directory in order to run correctly.  This file includes
      server information as well as login credentials.  Due to the
      sensitive nature of the contents of this file, it is advisable
      to make it readable only by the user, with the following
      command:</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>chmod 600 .fetchmailrc</userinput></screen>

    <para xml:lang="en">The following <filename>.fetchmailrc</filename> serves as an
      example for downloading a single user mailbox using
      <acronym>POP</acronym>.  It tells
      <application>fetchmail</application> to connect to
      <systemitem class="fqdomainname">example.com</systemitem> using
      a username of <systemitem class="username">joesoap</systemitem>
      and a password of <literal>XXX</literal>.  This example assumes
      that the user <systemitem class="username">joesoap</systemitem>
      exists on the local system.</para>

    <programlisting xml:lang="en">poll example.com protocol pop3 username "joesoap" password "XXX"</programlisting>

    <para xml:lang="en">The next example connects to multiple <acronym>POP</acronym>
      and <acronym>IMAP</acronym> servers and redirects to different
      local usernames where applicable:</para>

    <programlisting xml:lang="en">poll example.com proto pop3:
user "joesoap", with password "XXX", is "jsoap" here;
user "andrea", with password "XXXX";
poll example2.net proto imap:
user "john", with password "XXXXX", is "myth" here;</programlisting>

    <para xml:lang="en"><application>fetchmail</application> can be run in daemon
      mode by running it with <option>-d</option>, followed by the
      interval (in seconds) that <application>fetchmail</application>
      should poll servers listed in <filename>.fetchmailrc</filename>.
      The following example configures
      <application>fetchmail</application> to poll every 600
      seconds:</para>

    <screen xml:lang="en"><prompt>%</prompt> <userinput>fetchmail -d 600</userinput></screen>

    <para xml:lang="en">More information on <application>fetchmail</application> can
      be found at <uri xlink:href="http://www.fetchmail.info/">http://www.fetchmail.info/</uri>.</para>
  </sect1>

  <sect1 xml:id="mail-procmail">
    <info>
      <title>使用 <application>procmail</application></title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Silver</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>procmail</primary>
    </indexterm>

    <para xml:lang="en"><application>procmail</application> is a powerful
      application used to filter incoming mail.  It allows users to
      define <quote>rules</quote> which can be matched to incoming
      mails to perform specific functions or to reroute mail to
      alternative mailboxes or email addresses.
      <application>procmail</application> can be installed using the
      <package>mail/procmail</package> port.  Once installed, it can
      be directly integrated into most <acronym>MTA</acronym>s.
      Consult the <acronym>MTA</acronym> documentation for more
      information.  Alternatively, <application>procmail</application>
      can be integrated by adding the following line to a
      <filename>.forward</filename> in the home directory of the
      user:</para>

    <programlisting xml:lang="en">"|exec /usr/local/bin/procmail || exit 75"</programlisting>

    <para xml:lang="en">The following section displays some basic
      <application>procmail</application> rules, as well as brief
      descriptions of what they do.  Rules must be inserted into a
      <filename>.procmailrc</filename>, which must reside in the
      user's home directory.</para>

    <para xml:lang="en">The majority of these rules can be found in
      <citerefentry vendor="ports"><refentrytitle>procmailex</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

    <para xml:lang="en">To forward all mail from <email>user@example.com</email> to
      an external address of <email role="nolink">goodmail@example2.com</email>:</para>

      <programlisting xml:lang="en">:0
* ^From.*user@example.com
! goodmail@example2.com</programlisting>

    <para xml:lang="en">To forward all mails shorter than 1000 bytes to an external
      address of <email role="nolink">goodmail@example2.com</email>:</para>

      <programlisting xml:lang="en">:0
* &lt; 1000
! goodmail@example2.com</programlisting>

    <para xml:lang="en">To send all mail sent to
      <email>alternate@example.com</email> to a mailbox called
      <filename>alternate</filename>:</para>

    <programlisting xml:lang="en">:0
* ^TOalternate@example.com
alternate</programlisting>

    <para xml:lang="en">To send all mail with a subject of <quote>Spam</quote> to
      <filename>/dev/null</filename>:</para>

    <programlisting xml:lang="en">:0
^Subject:.*Spam
/dev/null</programlisting>

    <para xml:lang="en">A useful recipe that parses incoming <systemitem class="fqdomainname">FreeBSD.org</systemitem> mailing lists and
      places each list in its own mailbox:</para>

    <programlisting xml:lang="en">:0
* ^Sender:.owner-freebsd-\/[^@]+@FreeBSD.ORG
{
	LISTNAME=${MATCH}
	:0
	* LISTNAME??^\/[^@]+
	FreeBSD-${MATCH}
}</programlisting>
  </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="network-servers">
  <!--
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Murray</firstname>
	<surname>Stokely</surname>
	<contrib>Reorganized by in July 2004</contrib>
      </author>
    </authorgroup>
  </chapterinfo>
  -->

  <title>網路伺服器</title>

  <sect1 xml:id="network-servers-synopsis">
    <title>概述</title>

    <para>本章節涵蓋一些在 <trademark class="registered">UNIX</trademark> 系統常用的網路服務，包含安裝、設定、測試及維護各種不同類型的網路服務。本章會提供範例設定檔以供參考。</para>

    <para>讀完本章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>如何管理 <application>inetd</application> Daemon。</para>
      </listitem>

      <listitem>
	<para>如何設定網路檔案系統 (Network File System, <acronym>NFS</acronym>)。</para>
      </listitem>

      <listitem>
	<para>如何設定網路資訊伺服器 (Network Information Server, <acronym>NIS</acronym>) 來集中管理及共用使用者帳號。</para>
      </listitem>

      <listitem>
	<para>如何設定 FreeBSD 成為 <acronym>LDAP</acronym> 伺服器或客戶端</para>
      </listitem>

      <listitem>
	<para>如何設定使用 <acronym>DHCP</acronym> 自動網路設定。</para>
      </listitem>

      <listitem>
	<para>如何設定網域名稱伺服器 (Domain Name Server, <acronym>DNS</acronym>)。</para>
      </listitem>

      <listitem>
	<para>如何設定 <application>Apache</application> <acronym>HTTP</acronym> 伺服器。</para>
      </listitem>

      <listitem>
	<para>如何設定檔案傳輸協定 (File Transfer Protocol, <acronym>FTP</acronym>) 伺服器。</para>
      </listitem>

      <listitem>
	<para>如何設定 <application>Samba</application> 檔案與列印伺服器供 <trademark class="registered">Windows</trademark> 客戶端使用。</para>
      </listitem>

      <listitem>
	<para>如何同步時間與日期，並使用網路時間協定 (Network Time Protocol, <acronym>NTP</acronym>) 設定時間伺服器。</para>
      </listitem>

      <listitem>
	<para>如何設定 <acronym>iSCSI</acronym>。</para>
      </listitem>
    </itemizedlist>

    <para>本章假設您有以下基礎知識：</para>

    <itemizedlist>
      <listitem>
	<para><filename>/etc/rc</filename> Script。</para>
      </listitem>

      <listitem>
	<para>網路術語。</para>
      </listitem>

      <listitem>
	<para>安裝其他第三方軟體 (<xref linkend="ports"/>)。</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="network-inetd">
    <title><application>inetd</application> 超級伺服器</title>

    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Chern</firstname>
	  <surname>Lee</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <contrib>Updated by </contrib>
	  <othername>The &os; Documentation Project</othername>
	</author>
      </authorgroup>
    </sect1info>
    -->

    <para xml:lang="en">The <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon is sometimes referred to as a
      Super-Server because it manages connections for many services.
      Instead of starting multiple applications, only the
      <application>inetd</application> service needs to be started.
      When a connection is received for a service that is managed by
      <application>inetd</application>, it determines which program
      the connection is destined for, spawns a process for that
      program, and delegates the program a socket.  Using
      <application>inetd</application> for services that are not
      heavily used can reduce system load, when compared to running
      each daemon individually in stand-alone mode.</para>

    <para xml:lang="en">Primarily, <application>inetd</application> is used to
      spawn other daemons, but several trivial protocols are handled
      internally, such as <application>chargen</application>,
      <application>auth</application>,
      <application>time</application>,
      <application>echo</application>,
      <application>discard</application>, and
      <application>daytime</application>.</para>

    <para xml:lang="en">This section covers the basics of configuring
      <application>inetd</application>.</para>

    <sect2 xml:id="network-inetd-conf">
      <title>設定檔</title>

      <para xml:lang="en">Configuration of <application>inetd</application> is
	done by editing <filename>/etc/inetd.conf</filename>.  Each
	line of this configuration file represents an application
	which can be started by <application>inetd</application>.  By
	default, every line starts with a comment
	(<literal>#</literal>), meaning that
	<application>inetd</application> is not listening for any
	applications.  To configure <application>inetd</application>
	to listen for an application's connections, remove the
	<literal>#</literal> at the beginning of the line for that
	application.</para>

      <para xml:lang="en">After saving your edits, configure
	<application>inetd</application> to start at system boot by
	editing <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">inetd_enable="YES"</programlisting>

      <para xml:lang="en">To start  <application>inetd</application> now, so that it
	listens for the service you configured, type:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service inetd start</userinput></screen>

      <para xml:lang="en">Once <application>inetd</application> is started, it needs
	to be notified whenever a modification is made to
	<filename>/etc/inetd.conf</filename>:</para>

      <example xml:id="network-inetd-reread">
	<title>重新庫入 <application>inetd</application> 設定檔</title>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service inetd reload</userinput></screen>
      </example>

      <para xml:lang="en">Typically, the default entry for an application does not
	need to be edited beyond removing the <literal>#</literal>.
	In some situations, it may be appropriate to edit the default
	entry.</para>

      <para xml:lang="en">As an example, this is the default entry for <citerefentry><refentrytitle>ftpd</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	over IPv4:</para>

      <programlisting xml:lang="en">ftp     stream  tcp     nowait  root    /usr/libexec/ftpd       ftpd -l</programlisting>

      <para xml:lang="en">The seven columns in an entry are as follows:</para>

      <programlisting xml:lang="en">service-name
socket-type
protocol
{wait|nowait}[/max-child[/max-connections-per-ip-per-minute[/max-child-per-ip]]]
user[:group][/login-class]
server-program
server-program-arguments</programlisting>

      <para xml:lang="en">where:</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">service-name</term>

	  <listitem>
	    <para xml:lang="en">The service name of the daemon to start.  It must
	      correspond to a service listed in
	      <filename>/etc/services</filename>.  This determines
	      which port <application>inetd</application> listens on
	      for incoming connections to that service.  When using a
	      custom service, it must first be added to
	      <filename>/etc/services</filename>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">socket-type</term>

	  <listitem>
	    <para xml:lang="en">Either <literal>stream</literal>,
	      <literal>dgram</literal>, <literal>raw</literal>, or
	      <literal>seqpacket</literal>.  Use
	      <literal>stream</literal> for TCP connections and
	      <literal>dgram</literal> for
	      <acronym>UDP</acronym> services.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">protocol</term>

	  <listitem>
	    <para xml:lang="en">Use one of the following protocol names:</para>

	    <informaltable frame="none" pgwide="1">
	      <tgroup cols="2">
		<thead>
		  <row>
		    <entry xml:lang="en">Protocol Name</entry>
		    <entry xml:lang="en">Explanation</entry>
		  </row>
		</thead>

		<tbody>
		  <row>
		    <entry xml:lang="en">tcp or tcp4</entry>
		    <entry xml:lang="en">TCP IPv4</entry>
		  </row>

		  <row>
		    <entry xml:lang="en">udp or udp4</entry>
		    <entry xml:lang="en"><acronym>UDP</acronym> IPv4</entry>
		  </row>

		  <row>
		    <entry xml:lang="en">tcp6</entry>
		    <entry xml:lang="en">TCP IPv6</entry>
		  </row>

		  <row>
		    <entry xml:lang="en">udp6</entry>
		    <entry xml:lang="en"><acronym>UDP</acronym> IPv6</entry>
		  </row>

		  <row>
		    <entry xml:lang="en">tcp46</entry>
		    <entry xml:lang="en">Both TCP IPv4 and IPv6</entry>
		  </row>

		  <row>
		    <entry xml:lang="en">udp46</entry>
		    <entry xml:lang="en">Both <acronym>UDP</acronym> IPv4 and
		      IPv6</entry>
		  </row>
		</tbody>
	      </tgroup>
	    </informaltable>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">{wait|nowait}[/max-child[/max-connections-per-ip-per-minute[/max-child-per-ip]]]</term>

	  <listitem>
	    <para xml:lang="en">In this field, <option>wait</option> or
	      <option>nowait</option> must be specified.
	      <option>max-child</option>,
	      <option>max-connections-per-ip-per-minute</option> and
	      <option>max-child-per-ip</option> are optional.</para>

	    <para xml:lang="en"><option>wait|nowait</option> indicates whether or
	      not the service is able to handle its own socket.
	      <option>dgram</option> socket types must use
	      <option>wait</option> while
	      <option>stream</option> daemons, which are usually
	      multi-threaded, should use <option>nowait</option>.
	      <option>wait</option> usually hands off multiple sockets
	      to a single daemon, while <option>nowait</option> spawns
	      a child daemon for each new socket.</para>

	    <para xml:lang="en">The maximum number of child daemons
	      <application>inetd</application> may spawn is set by
	      <option>max-child</option>.  For example, to limit ten
	      instances of the daemon, place a <literal>/10</literal>
	      after <option>nowait</option>.  Specifying
	      <literal>/0</literal> allows an unlimited number of
	      children.</para>

	    <para xml:lang="en"><option>max-connections-per-ip-per-minute</option>
	      limits the number of connections from any particular
	      <acronym>IP</acronym> address per minute.  Once the
	      limit  is reached, further connections from this IP
	      address will be dropped until the end of the minute.
	      For example, a value of <literal>/10</literal> would
	      limit any particular <acronym>IP</acronym> address to
	      ten connection attempts per minute.
	      <option>max-child-per-ip</option> limits the number of
	      child processes that can be started on behalf on any
	      single <acronym>IP</acronym> address at any moment.
	      These options can limit excessive resource consumption
	      and help to prevent Denial of Service attacks.</para>

	    <para xml:lang="en">An example can be seen in the default settings for
	      <citerefentry><refentrytitle>fingerd</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

	    <programlisting xml:lang="en">finger stream  tcp     nowait/3/10 nobody /usr/libexec/fingerd fingerd -k -s</programlisting>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">user</term>

	  <listitem>
	    <para xml:lang="en">The username the daemon
	      will run as.  Daemons typically run as
	      <systemitem class="username">root</systemitem>,
	      <systemitem class="username">daemon</systemitem>, or
	      <systemitem class="username">nobody</systemitem>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">server-program</term>

	  <listitem>
	    <para xml:lang="en">The full path to the daemon.  If the daemon is a
	      service provided by <application>inetd</application>
	      internally, use <option>internal</option>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">server-program-arguments</term>

	  <listitem>
	    <para xml:lang="en">Used to specify any command arguments to be passed
	      to the daemon on invocation.  If the daemon is an
	      internal service, use
	      <option>internal</option>.</para>
	  </listitem>
	</varlistentry>
      </variablelist>
    </sect2>

    <sect2 xml:id="network-inetd-cmdline">
      <title>指令列選項</title>

      <para xml:lang="en">Like most server daemons, <application>inetd</application>
	has a number of options that can be used to modify its
	behavior.  By default, <application>inetd</application> is
	started with <literal>-wW -C 60</literal>.  These options
	enable TCP wrappers for all services, including internal
	services, and prevent any <acronym>IP</acronym> address from
	requesting any service more than 60 times per minute.</para>

      <para xml:lang="en">To change the default options which are passed to
	<application>inetd</application>, add an entry for
	<literal>inetd_flags</literal> in
	<filename>/etc/rc.conf</filename>.  If
	<application>inetd</application> is already running, restart
	it with <command>service inetd restart</command>.</para>

      <para xml:lang="en">The available rate limiting options are:</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">-c maximum</term>

	  <listitem>
	    <para xml:lang="en">Specify the default maximum number of simultaneous
	      invocations of each service, where the default is
	      unlimited.  May be overridden on a per-service basis by
	      using <option>max-child</option> in
	      <filename>/etc/inetd.conf</filename>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">-C rate</term>

	  <listitem>
	    <para xml:lang="en">Specify the default maximum number of times a
	      service can be invoked from a single
	      <acronym>IP</acronym> address per minute.  May be
	      overridden on a per-service basis by using
	      <option>max-connections-per-ip-per-minute</option> in
	      <filename>/etc/inetd.conf</filename>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">-R rate</term>

	  <listitem>
	    <para xml:lang="en">Specify the maximum number of times a service can be
	      invoked in one minute, where the default is
	      <literal>256</literal>.  A rate of <literal>0</literal>
	      allows an unlimited number.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">-s maximum</term>

	  <listitem>
	    <para xml:lang="en">Specify the maximum number of times a service can be
	      invoked from a single <acronym>IP</acronym> address at
	      any one time, where the default is unlimited.  May be
	      overridden on a per-service basis by using
	      <option>max-child-per-ip</option> in
	      <filename>/etc/inetd.conf</filename>.</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para xml:lang="en">Additional options are available.  Refer to <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	for the full list of options.</para>
    </sect2>

    <sect2 xml:id="network-inetd-security">
      <title>安全注意事項</title>

      <para xml:lang="en">Many of the daemons which can be managed by
	<application>inetd</application> are not security-conscious.
	Some daemons, such as <application>fingerd</application>, can
	provide information that may be useful to an attacker.  Only
	enable the services which are needed and monitor the system
	for excessive connection attempts.
	<literal>max-connections-per-ip-per-minute</literal>,
	<literal>max-child</literal> and
	<literal>max-child-per-ip</literal> can be used to limit such
	attacks.</para>

      <para xml:lang="en">By default, TCP wrappers is enabled.  Consult
	<citerefentry><refentrytitle>hosts_access</refentrytitle><manvolnum>5</manvolnum></citerefentry> for more information on placing TCP
	restrictions on various
	<application>inetd</application> invoked daemons.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="network-nfs">
    <info>
      <title>網路檔案系統 (NFS)</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Reorganized and enhanced by </contrib>
	</author>
      </authorgroup>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Bill</firstname>
	    <surname>Swingle</surname>
	  </personname>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en"><primary>NFS</primary></indexterm>
    <para xml:lang="en">FreeBSD supports the Network File System
      (<acronym>NFS</acronym>), which allows a server to share
      directories and files with clients over a network.  With
      <acronym>NFS</acronym>, users and programs can access files on
      remote systems as if they were stored locally.</para>

    <para xml:lang="en"><acronym>NFS</acronym> has many practical uses.  Some of
      the more common uses include:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Data that would otherwise be duplicated on each client
	  can be kept in a single location and accessed by clients
	  on the network.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Several clients may need access to the
	  <filename>/usr/ports/distfiles</filename> directory.
	  Sharing that directory allows for quick access to the
	  source files without having to download them to each
	  client.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">On large networks, it is often more convenient to
	  configure a central <acronym>NFS</acronym> server on which
	  all user home directories are stored.  Users can log into
	  a client anywhere on the network and have access to their
	  home directories.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Administration of <acronym>NFS</acronym> exports is
	  simplified.  For example, there is only one file system
	  where security or backup policies must be set.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Removable media storage devices can be used by other
	  machines on the network.  This reduces the number of devices
	  throughout the network and provides a centralized location
	  to manage their security.  It is often more convenient to
	  install software on multiple machines from a centralized
	  installation media.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en"><acronym>NFS</acronym> consists of a server and one or more
      clients.  The client remotely accesses the data that is stored
      on the server machine.  In order for this to function properly,
      a few processes have to be configured and running.</para>

    <para xml:lang="en">These daemons must be running on the server:</para>
    <indexterm xml:lang="en">
      <primary>NFS</primary>
	<secondary>server</secondary>
     </indexterm>
     <indexterm xml:lang="en">
       <primary>file server</primary>
	<secondary>UNIX clients</secondary>
      </indexterm>

      <indexterm xml:lang="en">
	<primary><application>rpcbind</application></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><application>mountd</application></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><application>nfsd</application></primary>
      </indexterm>

      <informaltable frame="none" pgwide="1">
	<tgroup cols="2">
	  <colspec colwidth="1*"/>
	  <colspec colwidth="3*"/>

	  <thead>
	    <row>
	      <entry xml:lang="en">Daemon</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><application>nfsd</application></entry>
	      <entry xml:lang="en">The <acronym>NFS</acronym> daemon which services
		requests from <acronym>NFS</acronym> clients.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><application>mountd</application></entry>
	      <entry xml:lang="en">The <acronym>NFS</acronym> mount daemon which
		carries out requests received from
		<application>nfsd</application>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><application>rpcbind</application></entry>
	      <entry xml:lang="en"> This daemon allows <acronym>NFS</acronym>
		clients to discover which port the
		<acronym>NFS</acronym> server is using.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable>

      <para xml:lang="en">Running <citerefentry><refentrytitle>nfsiod</refentrytitle><manvolnum>8</manvolnum></citerefentry> on the client can improve
	performance, but is not required.</para>

      <sect2 xml:id="network-configuring-nfs">
	<title>設定伺服器</title>

	<indexterm xml:lang="en">
	  <primary>NFS</primary>
	  <secondary>configuration</secondary>
	</indexterm>

      <para xml:lang="en">The file systems which the <acronym>NFS</acronym> server
	will share are specified in <filename>/etc/exports</filename>.
	Each line in this file specifies a file system to be exported,
	which clients have access to that file system, and any access
	options.  When adding entries to this file, each exported file
	system, its properties, and allowed hosts must occur on a
	single line.  If no clients are listed in the entry, then any
	client on the network can mount that file system.</para>

      <indexterm xml:lang="en">
	<primary>NFS</primary>
	<secondary>export examples</secondary>
      </indexterm>

      <para xml:lang="en">The following <filename>/etc/exports</filename> entries
	demonstrate how to export file systems.  The examples can be
	modified to match the file systems and client names on the
	reader's network.  There are many options that can be used in
	this file, but only a few will be mentioned here.  See
	<citerefentry><refentrytitle>exports</refentrytitle><manvolnum>5</manvolnum></citerefentry> for the full list of options.</para>

      <para xml:lang="en">This example shows how to export
	<filename>/cdrom</filename> to three hosts named
	<replaceable>alpha</replaceable>,
	<replaceable>bravo</replaceable>, and
	<replaceable>charlie</replaceable>:</para>

      <programlisting xml:lang="en">/cdrom -ro <replaceable>alpha</replaceable> <replaceable>bravo</replaceable> <replaceable>charlie</replaceable></programlisting>

      <para xml:lang="en">The <literal>-ro</literal> flag makes the file system
	read-only, preventing clients from making any changes to the
	exported file system.  This example assumes that the host
	names are either in <acronym>DNS</acronym> or in
	<filename>/etc/hosts</filename>.  Refer to <citerefentry><refentrytitle>hosts</refentrytitle><manvolnum>5</manvolnum></citerefentry> if
	the network does not have a <acronym>DNS</acronym>
	server.</para>

      <para xml:lang="en">The next example exports <filename>/home</filename> to
	three clients by <acronym>IP</acronym> address.  This can be
	useful for networks without <acronym>DNS</acronym> or
	<filename>/etc/hosts</filename> entries.  The
	<literal>-alldirs</literal> flag allows subdirectories to be
	mount points.  In other words, it will not automatically mount
	the subdirectories, but will permit the client to mount the
	directories that are required as needed.</para>

      <programlisting xml:lang="en">/usr/home  -alldirs  10.0.0.2 10.0.0.3 10.0.0.4</programlisting>

      <para xml:lang="en">This next example exports <filename>/a</filename> so that
	two clients from different domains may access that file
	system.  The <option>-maproot=root</option> allows <systemitem class="username">root</systemitem> on the remote system to
	write data on the exported file system as <systemitem class="username">root</systemitem>.  If
	<literal>-maproot=root</literal> is not specified, the
	client's <systemitem class="username">root</systemitem> user
	will be mapped to the server's <systemitem class="username">nobody</systemitem> account and will be
	subject to the access limitations defined for <systemitem class="username">nobody</systemitem>.</para>

      <programlisting xml:lang="en">/a  -maproot=root  host.example.com box.example.org</programlisting>

      <para xml:lang="en">A client can only be specified once per file system.  For
	example, if <filename>/usr</filename> is a single file system,
	these entries would be invalid as both entries specify the
	same host:</para>

      <programlisting xml:lang="en"># Invalid when /usr is one file system
/usr/src   client
/usr/ports client</programlisting>

      <para xml:lang="en">The correct format for this situation is to use one
	entry:</para>

      <programlisting xml:lang="en">/usr/src /usr/ports  client</programlisting>

      <para xml:lang="en">The following is an example of a valid export list, where
	<filename>/usr</filename> and <filename>/exports</filename>
	are local file systems:</para>

      <programlisting xml:lang="en"># Export src and ports to client01 and client02, but only
# client01 has root privileges on it
/usr/src /usr/ports -maproot=root    client01
/usr/src /usr/ports               client02
# The client machines have root and can mount anywhere
# on /exports. Anyone in the world can mount /exports/obj read-only
/exports -alldirs -maproot=root      client01 client02
/exports/obj -ro</programlisting>

      <para xml:lang="en">To enable the processes required by the
	<acronym>NFS</acronym> server at boot time, add these options
	to <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">rpcbind_enable="YES"
nfs_server_enable="YES"
mountd_flags="-r"</programlisting>

      <para xml:lang="en">The server can be started now by running this
	command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service nfsd start</userinput></screen>

      <para xml:lang="en">Whenever the <acronym>NFS</acronym> server is started,
	<application>mountd</application> also starts automatically.
	However, <application>mountd</application> only reads
	<filename>/etc/exports</filename> when it is started.  To make
	subsequent <filename>/etc/exports</filename> edits take effect
	immediately, force <application>mountd</application> to reread
	it:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service mountd reload</userinput></screen>
    </sect2>

    <sect2>
      <title>設定客戶端</title>

      <para xml:lang="en">To enable <acronym>NFS</acronym> clients, set this option
	in each client's <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">nfs_client_enable="YES"</programlisting>

      <para xml:lang="en">Then, run this command on each <acronym>NFS</acronym>
	client:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service nfsclient start</userinput></screen>

      <para xml:lang="en">The client now has everything it needs to mount a remote
	file system.  In these examples, the server's name is
	<systemitem>server</systemitem> and the client's name is
	<systemitem>client</systemitem>.  To mount
	<filename>/home</filename> on
	<systemitem>server</systemitem> to the
	<filename>/mnt</filename> mount point on
	<systemitem>client</systemitem>:</para>

      <indexterm xml:lang="en">
	<primary>NFS</primary>
	<secondary>mounting</secondary>
      </indexterm>
      <screen xml:lang="en"><prompt>#</prompt> <userinput>mount server:/home /mnt</userinput></screen>

      <para xml:lang="en">The files and directories in
	<filename>/home</filename> will now be available on
	<systemitem>client</systemitem>, in the
	<filename>/mnt</filename> directory.</para>

      <para xml:lang="en">To mount a remote file system each time the client boots,
	add it to <filename>/etc/fstab</filename>:</para>

      <programlisting xml:lang="en">server:/home	/mnt	nfs	rw	0	0</programlisting>

      <para xml:lang="en">Refer to <citerefentry><refentrytitle>fstab</refentrytitle><manvolnum>5</manvolnum></citerefentry> for a description of all available
	options.</para>
    </sect2>

    <sect2>
      <title>鎖定</title>

      <para xml:lang="en">Some applications require file locking to operate
	correctly.  To enable locking, add these lines to
	<filename>/etc/rc.conf</filename> on both the client and
	server:</para>

      <programlisting xml:lang="en">rpc_lockd_enable="YES"
rpc_statd_enable="YES"</programlisting>

      <para xml:lang="en">Then start the applications:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service lockd start</userinput>
<prompt>#</prompt> <userinput>service statd start</userinput></screen>

      <para xml:lang="en">If locking is not required on the server, the
	<acronym>NFS</acronym> client can be configured to lock
	locally by including <option>-L</option> when running
	<application>mount</application>.  Refer to <citerefentry><refentrytitle>mount_nfs</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	for further details.</para>
    </sect2>

    <sect2 xml:id="network-amd">
      <info>
	<title>使用 <citerefentry><refentrytitle>amd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 自動掛載</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Wylie</firstname>
	      <surname>Stilwell</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Chern</firstname>
	      <surname>Lee</surname>
	    </personname>
	    <contrib>Rewritten by </contrib>
	  </author>
	</authorgroup>
      </info>

      <indexterm xml:lang="en"><primary>amd</primary></indexterm>
      <indexterm xml:lang="en">
	<primary>automatic mounter daemon</primary>
      </indexterm>

      <para xml:lang="en">The automatic mounter daemon,
	<application>amd</application>, automatically mounts a remote
	file system whenever a file or directory within that file
	system is accessed.  File systems that are inactive for a
	period of time will be automatically unmounted by
	<application>amd</application>.</para>

      <para xml:lang="en">This daemon provides an alternative to modifying
	<filename>/etc/fstab</filename> to list every client.  It
	operates by attaching itself as an  <acronym>NFS</acronym>
	server to the <filename>/host</filename> and
	<filename>/net</filename> directories.  When a file is
	accessed within one of these directories,
	<application>amd</application> looks up the corresponding
	remote mount and automatically mounts it.
	<filename>/net</filename> is used to mount an exported file
	system from an <acronym>IP</acronym> address while
	<filename>/host</filename> is used to mount an export from a
	remote hostname.  For instance, an attempt to access a file
	within <filename>/host/foobar/usr</filename> would tell
	<application>amd</application> to mount the
	<filename>/usr</filename> export on the host
	<systemitem>foobar</systemitem>.</para>

      <example>
	<title>使用 <application>amd</application> 掛載 Export</title>

	<para xml:lang="en">In this example, <command>showmount -e</command> shows
	  the exported file systems that can be mounted from the
	  <acronym>NFS</acronym> server,
	  <systemitem>foobar</systemitem>:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>showmount -e foobar</userinput>
Exports list on foobar:
/usr                               10.10.10.0
/a                                 10.10.10.0
<prompt>%</prompt> <userinput>cd /host/foobar/usr</userinput></screen>
      </example>

      <para xml:lang="en">The output from <command>showmount</command> shows
	<filename>/usr</filename> as an export.  When changing
	directories to <filename>/host/foobar/usr</filename>,
	<application>amd</application> intercepts the request and
	attempts to resolve the hostname
	<systemitem>foobar</systemitem>.  If successful,
	<application>amd</application> automatically mounts the
	desired export.</para>

      <para xml:lang="en">To enable <application>amd</application> at boot time, add
	this line to <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">amd_enable="YES"</programlisting>

      <para xml:lang="en">To start <application>amd</application> now:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service amd start</userinput></screen>

      <para xml:lang="en">Custom flags can be passed to
	<application>amd</application> from the
	<varname>amd_flags</varname> environment variable.  By
	default, <varname>amd_flags</varname> is set to:</para>

      <programlisting xml:lang="en">amd_flags="-a /.amd_mnt -l syslog /host /etc/amd.map /net /etc/amd.map"</programlisting>

      <para xml:lang="en">The default options with which exports are mounted are
	defined in <filename>/etc/amd.map</filename>.  Some of the
	more advanced features of <application>amd</application> are
	defined in <filename>/etc/amd.conf</filename>.</para>

      <para xml:lang="en">Consult <citerefentry><refentrytitle>amd</refentrytitle><manvolnum>8</manvolnum></citerefentry> and <citerefentry><refentrytitle>amd.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for more
	information.</para>
    </sect2>

    <sect2 xml:id="network-autofs">
      <title>使用 <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> 自動掛載</title>

      <note>
	<para xml:lang="en">The <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> automount facility is supported
	  starting with FreeBSD 10.1-RELEASE.  To use the
	  automounter functionality in older versions of FreeBSD, use
	  <citerefentry><refentrytitle>amd</refentrytitle><manvolnum>8</manvolnum></citerefentry> instead.  This chapter only describes the
	  <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> automounter.</para>
      </note>


      <indexterm xml:lang="en"><primary>autofs</primary></indexterm>
      <indexterm xml:lang="en">
	<primary>automounter subsystem</primary>
      </indexterm>

      <para xml:lang="en">The <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> facility is a common name for several
	components that, together, allow for automatic mounting of
	remote and local filesystems whenever a file or directory
	within that file system is accessed.  It consists of the
	kernel component, <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry>, and several userspace
	applications: <citerefentry><refentrytitle>automount</refentrytitle><manvolnum>8</manvolnum></citerefentry>, <citerefentry><refentrytitle>automountd</refentrytitle><manvolnum>8</manvolnum></citerefentry> and
	<citerefentry><refentrytitle>autounmountd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  It serves as an alternative for
	<citerefentry><refentrytitle>amd</refentrytitle><manvolnum>8</manvolnum></citerefentry> from previous FreeBSD releases.  Amd is still
	provided for backward compatibility purposes, as the two use
	different map format; the one used by autofs is the same as
	with other SVR4 automounters, such as the ones in Solaris,
	MacOS X, and Linux.</para>

      <para xml:lang="en">The <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> virtual filesystem is mounted on
	specified mountpoints by <citerefentry><refentrytitle>automount</refentrytitle><manvolnum>8</manvolnum></citerefentry>, usually invoked
	during boot.</para>

      <para xml:lang="en">Whenever a process attempts to access file within the
	<citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> mountpoint, the kernel will notify
	<citerefentry><refentrytitle>automountd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon and pause the triggering process.
	The <citerefentry><refentrytitle>automountd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon will handle kernel requests by
	finding the proper map and mounting the filesystem according
	to it, then signal the kernel to release blocked process.  The
	<citerefentry><refentrytitle>autounmountd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon automatically unmounts automounted
	filesystems after some time, unless they are still being
	used.</para>

      <para xml:lang="en">The primary autofs configuration file is
	<filename>/etc/auto_master</filename>.  It assigns individual
	maps to top-level mounts.  For an explanation of
	<filename>auto_master</filename> and the map syntax, refer to
	<citerefentry><refentrytitle>auto_master</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

      <para xml:lang="en">There is a special automounter map mounted on
	<filename>/net</filename>.  When a file is accessed within
	this directory, <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> looks up the corresponding
	remote mount and automatically mounts it.  For instance, an
	attempt to access a file within
	<filename>/net/foobar/usr</filename> would tell
	<citerefentry><refentrytitle>automountd</refentrytitle><manvolnum>8</manvolnum></citerefentry> to mount the <filename>/usr</filename> export from the host
	<systemitem class="fqdomainname">foobar</systemitem>.</para>

      <example>
	<title>使用 <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> 掛載 Export</title>

	<para xml:lang="en">In this example, <command>showmount -e</command> shows
	  the exported file systems that can be mounted from the
	  <acronym>NFS</acronym> server,
	  <systemitem class="fqdomainname">foobar</systemitem>:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>showmount -e foobar</userinput>
Exports list on foobar:
/usr                               10.10.10.0
/a                                 10.10.10.0
<prompt>%</prompt> <userinput>cd /net/foobar/usr</userinput></screen>
      </example>

      <para xml:lang="en">The output from <command>showmount</command> shows
	<filename>/usr</filename> as an export.
	When changing directories to <filename>/host/foobar/usr</filename>,
	<citerefentry><refentrytitle>automountd</refentrytitle><manvolnum>8</manvolnum></citerefentry> intercepts the request and attempts to
	resolve the hostname <systemitem class="fqdomainname">foobar</systemitem>.  If successful,
	<citerefentry><refentrytitle>automountd</refentrytitle><manvolnum>8</manvolnum></citerefentry> automatically mounts the source
	export.</para>

      <para xml:lang="en">To enable <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> at boot time, add this line to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">autofs_enable="YES"</programlisting>

      <para xml:lang="en">Then <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> can be started by running:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service automount start</userinput>
<prompt>#</prompt> <userinput>service automountd start</userinput>
<prompt>#</prompt> <userinput>service autounmountd start</userinput></screen>

      <para xml:lang="en">The <citerefentry><refentrytitle>autofs</refentrytitle><manvolnum>5</manvolnum></citerefentry> map format is the same as in other
	operating systems.  Information about this format from other
	sources can be useful, like the <link xlink:href="http://web.archive.org/web/20160813071113/http://images.apple.com/business/docs/Autofs.pdf">Mac
	  OS X document</link>.</para>

      <para xml:lang="en">Consult the <citerefentry><refentrytitle>automount</refentrytitle><manvolnum>8</manvolnum></citerefentry>, <citerefentry><refentrytitle>automountd</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
	<citerefentry><refentrytitle>autounmountd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, and <citerefentry><refentrytitle>auto_master</refentrytitle><manvolnum>5</manvolnum></citerefentry> manual pages for
	more information.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="network-nis">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Bill</firstname>
	  <surname>Swingle</surname>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Eric</firstname>
	  <surname>Ogren</surname>
	  <contrib>Enhanced by </contrib>
	</author>
	<author>
	  <firstname>Udo</firstname>
	  <surname>Erdelhoff</surname>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>網路資訊系統 (<acronym>NIS</acronym>)</title>

    <indexterm xml:lang="en"><primary>NIS</primary></indexterm>
    <indexterm xml:lang="en"><primary>Solaris</primary></indexterm>
    <indexterm xml:lang="en"><primary>HP-UX</primary></indexterm>
    <indexterm xml:lang="en"><primary>AIX</primary></indexterm>
    <indexterm xml:lang="en"><primary>Linux</primary></indexterm>
    <indexterm xml:lang="en"><primary>NetBSD</primary></indexterm>
    <indexterm xml:lang="en"><primary>OpenBSD</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>yellow pages</primary>
      <see>NIS</see>
    </indexterm>

    <para xml:lang="en">Network Information System (<acronym>NIS</acronym>) is
      designed to centralize administration of <trademark class="registered">UNIX</trademark>-like systems
      such as <trademark>Solaris</trademark>, HP-UX, <trademark class="registered">AIX</trademark>, Linux, NetBSD, OpenBSD, and
      FreeBSD.  <acronym>NIS</acronym> was originally known as Yellow
      Pages but the name was changed due to trademark issues.   This
      is the reason why <acronym>NIS</acronym> commands begin with
      <literal>yp</literal>.</para>

    <indexterm xml:lang="en">
      <primary>NIS</primary>
      <secondary>domains</secondary>
      </indexterm>

    <para xml:lang="en"><acronym>NIS</acronym> is a Remote Procedure Call
      (<acronym>RPC</acronym>)-based client/server system that allows
      a group of machines within an <acronym>NIS</acronym> domain to
      share a common set of configuration files.  This permits a
      system administrator to set up <acronym>NIS</acronym> client
      systems with only minimal configuration data and to add, remove,
      or modify configuration data from a single location.</para>

    <para xml:lang="en">FreeBSD uses version 2 of the <acronym>NIS</acronym>
      protocol.</para>

    <sect2>
      <title><acronym>NIS</acronym> 術語與程序</title>

      <para xml:lang="en">Table 28.1 summarizes the terms and important processes
	used by <acronym>NIS</acronym>:</para>

      <indexterm xml:lang="en">
	<primary><application>rpcbind</application></primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary><application>portmap</application></primary>
      </indexterm>

      <table frame="none" pgwide="1">
	<title><acronym>NIS</acronym> 術語</title>

	<tgroup cols="2">
	  <colspec colwidth="1*"/>
	  <colspec colwidth="3*"/>

	  <thead>
	    <row>
	      <entry>術語</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><acronym>NIS</acronym> domain name</entry>

	      <entry xml:lang="en"><acronym>NIS</acronym> servers and clients share
		an <acronym>NIS</acronym> domain name.  Typically,
		this name does not have anything to do with
		<acronym>DNS</acronym>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><citerefentry><refentrytitle>rpcbind</refentrytitle><manvolnum>8</manvolnum></citerefentry></entry>

	      <entry xml:lang="en">This service enables <acronym>RPC</acronym> and
		must be running in order to run an
		<acronym>NIS</acronym> server or act as an
		<acronym>NIS</acronym> client.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><citerefentry><refentrytitle>ypbind</refentrytitle><manvolnum>8</manvolnum></citerefentry></entry>
	      <entry xml:lang="en">This service binds an <acronym>NIS</acronym>
		client to its <acronym>NIS</acronym> server.  It will
		take the <acronym>NIS</acronym> domain name and use
		<acronym>RPC</acronym> to connect to the server.  It
		is the core of client/server communication in an
		<acronym>NIS</acronym> environment.  If this service
		is not running on a client machine, it will not be
		able to access the <acronym>NIS</acronym>
		server.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><citerefentry><refentrytitle>ypserv</refentrytitle><manvolnum>8</manvolnum></citerefentry></entry>
	      <entry xml:lang="en">This is the process for the
		<acronym>NIS</acronym> server.  If this service stops
		running, the server will no longer be able to respond
		to <acronym>NIS</acronym> requests so hopefully, there
		is a slave server to take over.  Some non-FreeBSD clients
		will not try to reconnect using a slave server and the
		<application>ypbind</application> process may need to
		be restarted on these
		clients.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><citerefentry><refentrytitle>rpc.yppasswdd</refentrytitle><manvolnum>8</manvolnum></citerefentry></entry>
	      <entry xml:lang="en">This process only runs on
		<acronym>NIS</acronym> master servers.  This daemon
		allows <acronym>NIS</acronym> clients to change their
		<acronym>NIS</acronym> passwords.  If this daemon is
		not running, users will have to login to the
		<acronym>NIS</acronym> master server and change their
		passwords there.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>
      <!-- XXX Missing: rpc.ypxfrd (not important, though) May only run
      on the master -->
    </sect2>

    <sect2>
      <title>主機類型</title>

      <indexterm xml:lang="en"><primary>NIS</primary>
	<secondary>master server</secondary>
      </indexterm>
      <indexterm xml:lang="en"><primary>NIS</primary>
	<secondary>slave server</secondary>
      </indexterm>
      <indexterm xml:lang="en"><primary>NIS</primary>
	<secondary>client</secondary>
      </indexterm>

      <para xml:lang="en">There are three types of hosts in an
	<acronym>NIS</acronym> environment:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><acronym>NIS</acronym> master server</para>

	  <para xml:lang="en">This server acts as a central repository for host
	    configuration information and maintains the
	    authoritative copy of the files used by all of the
	    <acronym>NIS</acronym> clients.  The
	    <filename>passwd</filename>, <filename>group</filename>,
	    and other various files used by <acronym>NIS</acronym>
	    clients are stored on the master server.  While it is
	    possible for one machine to be an <acronym>NIS</acronym>
	    master server for more than one <acronym>NIS</acronym>
	    domain, this type of configuration will not be covered in
	    this chapter as it assumes a relatively small-scale
	    <acronym>NIS</acronym> environment.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><acronym>NIS</acronym> slave servers</para>

	  <para xml:lang="en"><acronym>NIS</acronym> slave servers maintain copies
	    of the <acronym>NIS</acronym> master's data files in
	    order to provide redundancy.  Slave servers also help to
	    balance the load of the master server as
	    <acronym>NIS</acronym> clients always attach to the
	    <acronym>NIS</acronym> server which responds
	    first.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><acronym>NIS</acronym> clients</para>

	  <para xml:lang="en"><acronym>NIS</acronym> clients authenticate
	    against the <acronym>NIS</acronym> server during log
	    on.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">Information in many files can be shared using
	<acronym>NIS</acronym>.  The
	<filename>master.passwd</filename>,
	<filename>group</filename>, and <filename>hosts</filename>
	files are commonly shared via <acronym>NIS</acronym>.
	Whenever a process on a client needs information that would
	normally be found in these files locally, it makes a query to
	the <acronym>NIS</acronym> server that it is bound to
	instead.</para>
    </sect2>

    <sect2>
      <title>規劃注意事項</title>

      <para xml:lang="en">This section describes a sample <acronym>NIS</acronym>
	environment which consists of 15 FreeBSD machines with no
	centralized point of administration.  Each machine has its own
	<filename>/etc/passwd</filename> and
	<filename>/etc/master.passwd</filename>.  These files are kept
	in sync with each other only through manual intervention.
	Currently, when a user is added to the lab, the process must
	be repeated on all 15 machines.</para>

      <para xml:lang="en">The configuration of the lab will be as follows:</para>

      <informaltable frame="none" pgwide="1">
	<tgroup cols="3">
	  <thead>
	    <row>
	      <entry xml:lang="en">Machine name</entry>
	      <entry><acronym>IP</acronym> 位址</entry>
	      <entry xml:lang="en">Machine role</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><systemitem>ellington</systemitem></entry>
	      <entry xml:lang="en"><systemitem class="ipaddress">10.0.0.2</systemitem></entry>
	      <entry xml:lang="en"><acronym>NIS</acronym> master</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>coltrane</systemitem></entry>
	      <entry xml:lang="en"><systemitem class="ipaddress">10.0.0.3</systemitem></entry>
	      <entry xml:lang="en"><acronym>NIS</acronym> slave</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>basie</systemitem></entry>
	      <entry xml:lang="en"><systemitem class="ipaddress">10.0.0.4</systemitem></entry>
	      <entry xml:lang="en">Faculty workstation</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>bird</systemitem></entry>
	      <entry xml:lang="en"><systemitem class="ipaddress">10.0.0.5</systemitem></entry>
	      <entry xml:lang="en">Client machine</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>cli[1-11]</systemitem></entry>
	      <entry xml:lang="en">
		<systemitem class="ipaddress">10.0.0.[6-17]</systemitem></entry>
	      <entry xml:lang="en">Other client machines</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable>

      <para xml:lang="en">If this is the first time an <acronym>NIS</acronym>
	scheme is being developed, it should be thoroughly planned
	ahead of time.  Regardless of network size, several decisions
	need to be made as part of the planning process.</para>

      <sect3>
	<title>選擇 <acronym>NIS</acronym> 網域名稱</title>

	<indexterm xml:lang="en">
	  <primary>NIS</primary>
	  <secondary>domain name</secondary>
	</indexterm>
	<para xml:lang="en">When a client broadcasts its requests for info, it
	  includes the name of the <acronym>NIS</acronym> domain that
	  it is part of.  This is how multiple servers on one network
	  can tell which server should answer which request.  Think of
	  the <acronym>NIS</acronym> domain name as the name for a
	  group of hosts.</para>

	<para xml:lang="en">Some organizations choose to use their Internet domain
	  name for their <acronym>NIS</acronym> domain name.  This is
	  not recommended as it can cause confusion when trying to
	  debug network problems.  The <acronym>NIS</acronym> domain
	  name should be unique within the network and it is helpful
	  if it describes the group of machines it represents.  For
	  example, the Art department at Acme Inc. might be in the
	  <quote>acme-art</quote> <acronym>NIS</acronym> domain.  This
	  example will use the domain name
	  <literal>test-domain</literal>.</para>

	<para xml:lang="en">However, some non-FreeBSD operating systems require the
	  <acronym>NIS</acronym> domain name to be the same as the
	  Internet domain name.  If one or more machines on the
	  network have this restriction, the Internet domain name
	  <emphasis>must</emphasis> be used as the
	  <acronym>NIS</acronym> domain name.</para>
      </sect3>

      <sect3>
	<title>實體伺服器需求</title>

	<para xml:lang="en">There are several things to keep in mind when choosing a
	  machine to use as a <acronym>NIS</acronym> server.  Since
	  <acronym>NIS</acronym> clients depend upon the availability
	  of the server, choose a machine that is not rebooted
	  frequently.  The <acronym>NIS</acronym> server should
	  ideally be a stand alone machine whose sole purpose is to be
	  an <acronym>NIS</acronym> server.  If the network is not
	  heavily used, it is acceptable to put the
	  <acronym>NIS</acronym> server on a machine running other
	  services.  However, if the <acronym>NIS</acronym> server
	  becomes unavailable, it will adversely affect all
	  <acronym>NIS</acronym> clients.</para>
      </sect3>
    </sect2>

    <sect2>
      <title>設定 <acronym>NIS</acronym> Master 伺服器</title>

      <para xml:lang="en">The canonical copies of all <acronym>NIS</acronym> files
	are stored on the master server.  The databases used to store
	the information are called <acronym>NIS</acronym> maps.  In
	FreeBSD, these maps are stored in
	<filename>/var/yp/[domainname]</filename> where
	<filename>[domainname]</filename> is the name of the
	<acronym>NIS</acronym> domain.  Since multiple domains are
	supported, it is possible to have several directories, one for
	each domain.  Each domain will have its own independent set of
	maps.</para>

      <para xml:lang="en"><acronym>NIS</acronym> master and slave servers handle all
	<acronym>NIS</acronym> requests through <citerefentry><refentrytitle>ypserv</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  This
	daemon is responsible for receiving incoming requests from
	<acronym>NIS</acronym> clients, translating the requested
	domain and map name to a path to the corresponding database
	file, and transmitting data from the database back to the
	client.</para>

      <indexterm xml:lang="en"><primary>NIS</primary>
	<secondary>server configuration</secondary>
      </indexterm>
      <para xml:lang="en">Setting up a master <acronym>NIS</acronym> server can be
	relatively straight forward, depending on environmental needs.
	Since FreeBSD provides built-in <acronym>NIS</acronym> support,
	it only needs to be enabled by adding the following lines to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">nisdomainname="test-domain"	<co xml:id="network-nis-co-domainname"/>
nis_server_enable="YES"		<co xml:id="network-nis-co-server"/>
nis_yppasswdd_enable="YES"	<co xml:id="network-nis-co-yppasswdd"/></programlisting>

      <calloutlist>
	<callout arearefs="network-nis-co-domainname">
	  <para xml:lang="en">This line sets the <acronym>NIS</acronym> domain name
	    to <literal>test-domain</literal>.</para>
	</callout>

	<callout arearefs="network-nis-co-server">
	  <para xml:lang="en">This automates the start up of the
	    <acronym>NIS</acronym> server processes when the system
	    boots.</para>
	</callout>

	<callout arearefs="network-nis-co-yppasswdd">
	  <para xml:lang="en">This enables the <citerefentry><refentrytitle>rpc.yppasswdd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon so that
	    users can change their <acronym>NIS</acronym> password
	    from a client machine.</para>
	</callout>
      </calloutlist>

      <para xml:lang="en">Care must be taken in a multi-server domain where the
	server machines are also <acronym>NIS</acronym> clients.  It
	is generally a good idea to force the servers to bind to
	themselves rather than allowing them to broadcast bind
	requests and possibly become bound to each other.  Strange
	failure modes can result if one server goes down and others
	are dependent upon it.  Eventually, all the clients will time
	out and attempt to bind to other servers, but the delay
	involved can be considerable and the failure mode is still
	present since the servers might bind to each other all over
	again.</para>

      <para xml:lang="en">A server that is also a client can be forced to bind to a
	particular server by adding these additional lines to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">nis_client_enable="YES" # run client stuff as well
nis_client_flags="-S <replaceable>NIS domain</replaceable>,<replaceable>server</replaceable>"</programlisting>

      <para xml:lang="en">After saving the edits, type
	<command>/etc/netstart</command> to restart the network and
	apply the values defined in <filename>/etc/rc.conf</filename>.
	Before initializing the <acronym>NIS</acronym> maps, start
	<citerefentry><refentrytitle>ypserv</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service ypserv start</userinput></screen>

      <sect3>
	<title>初始化 <acronym>NIS</acronym> 對應表</title>

	<indexterm xml:lang="en">
	  <primary>NIS</primary>
	  <secondary>maps</secondary>
	</indexterm>
	<para xml:lang="en"><acronym>NIS</acronym> maps are generated from the
	  configuration files in <filename>/etc</filename> on the
	  <acronym>NIS</acronym> master, with one exception:
	  <filename>/etc/master.passwd</filename>.  This is to prevent
	  the propagation of passwords to all the servers in the
	  <acronym>NIS</acronym> domain.  Therefore, before the
	  <acronym>NIS</acronym> maps are initialized, configure the
	  primary password files:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cp /etc/master.passwd /var/yp/master.passwd</userinput>
<prompt>#</prompt> <userinput>cd /var/yp</userinput>
<prompt>#</prompt> <userinput>vi master.passwd</userinput></screen>

	<para xml:lang="en">It is advisable to remove all entries for system
	  accounts as well as any user accounts that do not need to be
	  propagated to the <acronym>NIS</acronym> clients, such as
	  the <systemitem class="username">root</systemitem> and any
	  other administrative accounts.</para>

	<note>
	  <para xml:lang="en">Ensure that the
	    <filename>/var/yp/master.passwd</filename> is neither
	    group or world readable by setting its permissions to
	    <literal>600</literal>.</para>
	</note>

	<para xml:lang="en">After completing this task, initialize the
	  <acronym>NIS</acronym> maps.  FreeBSD includes the
	  <citerefentry><refentrytitle>ypinit</refentrytitle><manvolnum>8</manvolnum></citerefentry> script to do this.  When generating maps
	  for the master server, include <option>-m</option> and
	  specify the <acronym>NIS</acronym> domain name:</para>

	<screen xml:lang="en">ellington<prompt>#</prompt> <userinput>ypinit -m test-domain</userinput>
Server Type: MASTER Domain: test-domain
Creating an YP server will require that you answer a few questions.
Questions will all be asked at the beginning of the procedure.
Do you want this procedure to quit on non-fatal errors? [y/n: n] <userinput>n</userinput>
Ok, please remember to go back and redo manually whatever fails.
If not, something might not work.
At this point, we have to construct a list of this domains YP servers.
rod.darktech.org is already known as master server.
Please continue to add any slave servers, one per line. When you are
done with the list, type a &lt;control D&gt;.
master server   :  ellington
next host to add:  <userinput>coltrane</userinput>
next host to add:  <userinput>^D</userinput>
The current list of NIS servers looks like this:
ellington
coltrane
Is this correct?  [y/n: y] <userinput>y</userinput>

[..output from map generation..]

NIS Map update completed.
ellington has been setup as an YP master server without any errors.</screen>

	<para xml:lang="en">This will create <filename>/var/yp/Makefile</filename>
	  from <filename>/var/yp/Makefile.dist</filename>.  By
	  default, this file assumes that the environment has a
	  single <acronym>NIS</acronym> server with only FreeBSD clients.
	  Since <literal>test-domain</literal> has a slave server,
	  edit this line in <filename>/var/yp/Makefile</filename> so
	  that it begins with a  comment
	  (<literal>#</literal>):</para>

	<programlisting xml:lang="en">NOPUSH = "True"</programlisting>
      </sect3>

      <sect3>
	<title>新增使用者</title>

	<para xml:lang="en">Every time a new user is created, the user account must
	  be added to the master <acronym>NIS</acronym> server and the
	  <acronym>NIS</acronym> maps rebuilt.  Until this occurs, the
	  new user will not be able to login anywhere except on the
	  <acronym>NIS</acronym> master.  For example, to add the new
	  user <systemitem class="username">jsmith</systemitem> to the
	  <literal>test-domain</literal> domain, run these commands on
	  the master server:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pw useradd jsmith</userinput>
<prompt>#</prompt> <userinput>cd /var/yp</userinput>
<prompt>#</prompt> <userinput>make test-domain</userinput></screen>

	<para xml:lang="en">The user could also be added using <command>adduser
	    jsmith</command> instead of <command>pw useradd
	    smith</command>.</para>
      </sect3>
    </sect2>

    <sect2>
      <title>設定 <acronym>NIS</acronym> Slave 伺服器</title>

      <indexterm xml:lang="en">
	<primary>NIS</primary>
	<secondary>slave server</secondary>
      </indexterm>
      <para xml:lang="en">To set up an <acronym>NIS</acronym> slave server, log on
	to the slave server and edit <filename>/etc/rc.conf</filename>
	as for the master server.  Do not generate any
	<acronym>NIS</acronym> maps, as these already exist on the
	master server.  When running <command>ypinit</command> on the
	slave server, use <option>-s</option> (for slave) instead of
	<option>-m</option> (for master).  This option requires the
	name of the <acronym>NIS</acronym> master in addition to the
	domain name, as  seen in this example:</para>

      <screen xml:lang="en">coltrane<prompt>#</prompt> <userinput>ypinit -s ellington test-domain</userinput>

Server Type: SLAVE Domain: test-domain Master: ellington

Creating an YP server will require that you answer a few questions.
Questions will all be asked at the beginning of the procedure.

Do you want this procedure to quit on non-fatal errors? [y/n: n]  <userinput>n</userinput>

Ok, please remember to go back and redo manually whatever fails.
If not, something might not work.
There will be no further questions. The remainder of the procedure
should take a few minutes, to copy the databases from ellington.
Transferring netgroup...
ypxfr: Exiting: Map successfully transferred
Transferring netgroup.byuser...
ypxfr: Exiting: Map successfully transferred
Transferring netgroup.byhost...
ypxfr: Exiting: Map successfully transferred
Transferring master.passwd.byuid...
ypxfr: Exiting: Map successfully transferred
Transferring passwd.byuid...
ypxfr: Exiting: Map successfully transferred
Transferring passwd.byname...
ypxfr: Exiting: Map successfully transferred
Transferring group.bygid...
ypxfr: Exiting: Map successfully transferred
Transferring group.byname...
ypxfr: Exiting: Map successfully transferred
Transferring services.byname...
ypxfr: Exiting: Map successfully transferred
Transferring rpc.bynumber...
ypxfr: Exiting: Map successfully transferred
Transferring rpc.byname...
ypxfr: Exiting: Map successfully transferred
Transferring protocols.byname...
ypxfr: Exiting: Map successfully transferred
Transferring master.passwd.byname...
ypxfr: Exiting: Map successfully transferred
Transferring networks.byname...
ypxfr: Exiting: Map successfully transferred
Transferring networks.byaddr...
ypxfr: Exiting: Map successfully transferred
Transferring netid.byname...
ypxfr: Exiting: Map successfully transferred
Transferring hosts.byaddr...
ypxfr: Exiting: Map successfully transferred
Transferring protocols.bynumber...
ypxfr: Exiting: Map successfully transferred
Transferring ypservers...
ypxfr: Exiting: Map successfully transferred
Transferring hosts.byname...
ypxfr: Exiting: Map successfully transferred

coltrane has been setup as an YP slave server without any errors.
Remember to update map ypservers on ellington.</screen>

      <para xml:lang="en">This will generate a directory on the slave server called
	<filename>/var/yp/test-domain</filename> which contains copies
	of the <acronym>NIS</acronym> master server's maps.  Adding
	these <filename>/etc/crontab</filename> entries on each slave
	server will force the slaves to sync their maps with the maps
	on the master server:</para>

      <programlisting xml:lang="en">20      *       *       *       *       root   /usr/libexec/ypxfr passwd.byname
21      *       *       *       *       root   /usr/libexec/ypxfr passwd.byuid</programlisting>

      <para xml:lang="en">These entries are not mandatory because the master server
	automatically attempts to push any map changes to its slaves.
	However, since clients may depend upon the slave server to
	provide correct password information, it is recommended to
	force frequent password map updates.  This is especially
	important on busy networks where map updates might not always
	complete.</para>

      <para xml:lang="en">To finish the configuration, run
	<command>/etc/netstart</command> on the slave server in order
	to start the <acronym>NIS</acronym> services.</para>
    </sect2>

    <sect2>
      <title>設定 <acronym>NIS</acronym> 客戶端</title>

      <para xml:lang="en">An <acronym>NIS</acronym> client binds to an
	<acronym>NIS</acronym> server using <citerefentry><refentrytitle>ypbind</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  This
	daemon broadcasts RPC requests on the local network.  These
	requests specify the domain name configured on the client.  If
	an <acronym>NIS</acronym> server in the same domain receives
	one of the broadcasts, it will respond to
	<application>ypbind</application>, which will record the
	server's address.  If there are several servers available,
	the client will use the address of the first server to respond
	and will direct all of its <acronym>NIS</acronym> requests to
	that server.  The client will automatically
	<application>ping</application> the server on a regular basis
	to make sure it is still available.  If it fails to receive a
	reply within a reasonable amount of time,
	<application>ypbind</application> will mark the domain as
	unbound and begin broadcasting again in the hopes of locating
	another server.</para>

      <indexterm xml:lang="en"><primary>NIS</primary>
	<secondary>client configuration</secondary>
      </indexterm>

      <para xml:lang="en">To configure a FreeBSD machine to be an
	<acronym>NIS</acronym> client:</para>

      <procedure>
	<step>
	  <para xml:lang="en">Edit <filename>/etc/rc.conf</filename> and add the
	    following lines in order to set the
	    <acronym>NIS</acronym> domain name and start
	    <citerefentry><refentrytitle>ypbind</refentrytitle><manvolnum>8</manvolnum></citerefentry> during network startup:</para>

	  <programlisting xml:lang="en">nisdomainname="test-domain"
nis_client_enable="YES"</programlisting>
	</step>

	<step>
	  <para xml:lang="en">To import all possible password entries from the
	    <acronym>NIS</acronym> server, use
	    <command>vipw</command> to remove all user accounts
	    except one from <filename>/etc/master.passwd</filename>.
	    When removing the accounts, keep in mind that at least one
	    local account should remain and this account should be a
	    member of <systemitem class="groupname">wheel</systemitem>.  If there is a
	    problem with <acronym>NIS</acronym>, this local account
	    can be used to log in remotely, become the superuser, and
	    fix the problem.  Before saving the edits, add the
	    following line to the end of the file:</para>

	  <programlisting xml:lang="en">+:::::::::</programlisting>

	  <para xml:lang="en">This line configures the client to provide anyone with
	    a valid account in the <acronym>NIS</acronym> server's
	    password maps an account on the client.  There are many
	    ways to configure the <acronym>NIS</acronym> client by
	    modifying this line.  One method is described in <xref linkend="network-netgroups"/>.  For more detailed
	    reading, refer to the book
	    <literal>Managing NFS and NIS</literal>, published by
	    O'Reilly Media.</para>
	</step>

	<step>
	  <para xml:lang="en">To import all possible group entries from the
	    <acronym>NIS</acronym> server, add this line to
	    <filename>/etc/group</filename>:</para>

	  <programlisting xml:lang="en">+:*::</programlisting>
	</step>
      </procedure>

      <para xml:lang="en">To start the <acronym>NIS</acronym> client immediately,
	execute the following commands as the superuser:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>/etc/netstart</userinput>
<prompt>#</prompt> <userinput>service ypbind start</userinput></screen>

      <para xml:lang="en">After completing these steps, running
	<command>ypcat passwd</command> on the client should show
	the server's <filename>passwd</filename> map.</para>
    </sect2>

    <sect2>
      <title><acronym>NIS</acronym> 安全性</title>

      <para xml:lang="en">Since <acronym>RPC</acronym> is a broadcast-based service,
	any system running <application>ypbind</application> within
	the same domain can retrieve the contents of the
	<acronym>NIS</acronym> maps.  To prevent unauthorized
	transactions, <citerefentry><refentrytitle>ypserv</refentrytitle><manvolnum>8</manvolnum></citerefentry> supports a feature called
	<quote>securenets</quote> which can be used to restrict access
	to a given set of hosts.  By default, this information is
	stored in <filename>/var/yp/securenets</filename>, unless
	<citerefentry><refentrytitle>ypserv</refentrytitle><manvolnum>8</manvolnum></citerefentry> is started with <option>-p</option> and an
	alternate path.  This file contains entries that consist of a
	network specification and a network mask separated by white
	space.  Lines starting with <literal>#</literal> are
	considered to be comments.  A sample
	<filename>securenets</filename> might look like this:</para>

      <programlisting xml:lang="en"># allow connections from local host -- mandatory
127.0.0.1     255.255.255.255
# allow connections from any host
# on the 192.168.128.0 network
192.168.128.0 255.255.255.0
# allow connections from any host
# between 10.0.0.0 to 10.0.15.255
# this includes the machines in the testlab
10.0.0.0      255.255.240.0</programlisting>

      <para xml:lang="en">If <citerefentry><refentrytitle>ypserv</refentrytitle><manvolnum>8</manvolnum></citerefentry> receives a request from an address that
	matches one of these rules, it will process the request
	normally.  If the address fails to match a rule, the request
	will be ignored and a warning message will be logged.  If the
	<filename>securenets</filename> does not exist,
	<command>ypserv</command> will allow connections from any
	host.</para>

      <para xml:lang="en"><xref linkend="tcpwrappers"/> is an alternate mechanism
	for providing access control instead of
	<filename>securenets</filename>.  While either access control
	mechanism adds some security, they are both vulnerable to
	<quote><acronym>IP</acronym> spoofing</quote> attacks.  All
	<acronym>NIS</acronym>-related traffic should be blocked at
	the firewall.</para>

      <para xml:lang="en">Servers using <filename>securenets</filename>
	may fail to serve legitimate <acronym>NIS</acronym> clients
	with archaic TCP/IP implementations.  Some of these
	implementations set all host bits to zero when doing
	broadcasts or fail to observe the subnet mask when
	calculating the broadcast address.  While some of these
	problems can be fixed by changing the client configuration,
	other problems may force the retirement of these client
	systems or the abandonment of
	<filename>securenets</filename>.</para>

      <indexterm xml:lang="en"><primary>TCP Wrapper</primary></indexterm>
      <para xml:lang="en">The use of <application>TCP Wrapper</application>
	increases the latency of the <acronym>NIS</acronym> server.
	The additional delay may be long enough to cause timeouts in
	client programs, especially in busy networks with slow
	<acronym>NIS</acronym> servers.  If one or more clients suffer
	from latency, convert those clients into
	<acronym>NIS</acronym> slave servers and force them to bind to
	themselves.</para>

      <sect3>
	<title>阻擋部份使用者</title>

	<para xml:lang="en">In this example, the <systemitem>basie</systemitem>
	  system is a faculty workstation within the
	  <acronym>NIS</acronym> domain.  The
	  <filename>passwd</filename> map on the master
	  <acronym>NIS</acronym> server contains accounts for both
	  faculty and students.  This section demonstrates how to
	  allow faculty logins on this system while refusing student
	  logins.</para>

	<para xml:lang="en">To prevent specified users from logging on to a system,
	  even if they are present in the <acronym>NIS</acronym>
	  database, use <command>vipw</command> to add
	  <literal>-<replaceable>username</replaceable></literal> with
	  the correct number of colons towards the end of
	  <filename>/etc/master.passwd</filename> on the client,
	  where <replaceable>username</replaceable> is the username of
	  a user to bar from logging in.  The line with the blocked
	  user must be before the <literal>+</literal> line that
	  allows <acronym>NIS</acronym> users.  In this example,
	  <systemitem class="username">bill</systemitem> is barred
	  from logging on to <systemitem>basie</systemitem>:</para>

	<screen xml:lang="en">basie<prompt>#</prompt> <userinput>cat /etc/master.passwd</userinput>
root:[password]:0:0::0:0:The super-user:/root:/bin/csh
toor:[password]:0:0::0:0:The other super-user:/root:/bin/sh
daemon:*:1:1::0:0:Owner of many system processes:/root:/usr/sbin/nologin
operator:*:2:5::0:0:System &amp;:/:/usr/sbin/nologin
bin:*:3:7::0:0:Binaries Commands and Source,,,:/:/usr/sbin/nologin
tty:*:4:65533::0:0:Tty Sandbox:/:/usr/sbin/nologin
kmem:*:5:65533::0:0:KMem Sandbox:/:/usr/sbin/nologin
games:*:7:13::0:0:Games pseudo-user:/usr/games:/usr/sbin/nologin
news:*:8:8::0:0:News Subsystem:/:/usr/sbin/nologin
man:*:9:9::0:0:Mister Man Pages:/usr/share/man:/usr/sbin/nologin
bind:*:53:53::0:0:Bind Sandbox:/:/usr/sbin/nologin
uucp:*:66:66::0:0:UUCP pseudo-user:/var/spool/uucppublic:/usr/libexec/uucp/uucico
xten:*:67:67::0:0:X-10 daemon:/usr/local/xten:/usr/sbin/nologin
pop:*:68:6::0:0:Post Office Owner:/nonexistent:/usr/sbin/nologin
nobody:*:65534:65534::0:0:Unprivileged user:/nonexistent:/usr/sbin/nologin
-bill:::::::::
+:::::::::

basie<prompt>#</prompt></screen>
      </sect3>
    </sect2>

    <sect2 xml:id="network-netgroups">
      <!--
      <sect2info>
	<authorgroup>
	  <author>
	    <firstname>Udo</firstname>
	    <surname>Erdelhoff</surname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </sect2info>
      -->

      <title>使用 Netgroups</title>

      <indexterm xml:lang="en"><primary>netgroups</primary></indexterm>

      <para xml:lang="en">Barring specified users from logging on to individual
	systems becomes unscaleable on larger networks and quickly
	loses the main benefit of <acronym>NIS</acronym>:
	<emphasis>centralized</emphasis> administration.</para>

      <para xml:lang="en">Netgroups were developed to handle large, complex networks
	with hundreds of users and machines.  Their use is comparable
	to <trademark class="registered">UNIX</trademark> groups, where the main difference is the lack of a
	numeric ID and the ability to define a netgroup by including
	both user accounts and other netgroups.</para>

      <para xml:lang="en">To expand on the example used in this chapter, the
	<acronym>NIS</acronym> domain will be extended to add the
	users and systems shown in Tables 28.2 and 28.3:</para>

      <table frame="none" pgwide="1">
	<title>其他使用者</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>使用者名稱</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><systemitem class="username">alpha</systemitem>,
		<systemitem class="username">beta</systemitem></entry>
	      <entry xml:lang="en">IT department employees</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem class="username">charlie</systemitem>, <systemitem class="username">delta</systemitem></entry>
	      <entry xml:lang="en">IT department apprentices</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem class="username">echo</systemitem>,
		<systemitem class="username">foxtrott</systemitem>,
		<systemitem class="username">golf</systemitem>,
		...</entry>
	      <entry xml:lang="en">employees</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem class="username">able</systemitem>,
		<systemitem class="username">baker</systemitem>,
		...</entry>
	      <entry xml:lang="en">interns</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <table frame="none" pgwide="1">
	<title>其他系統</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>機器名稱</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <!--  Names taken from "Good Omens" by Neil Gaiman and Terry
		    Pratchett.  Many thanks for a brilliant book.  -->
	      <entry xml:lang="en"><systemitem>war</systemitem>,
		<systemitem>death</systemitem>,
		<systemitem>famine</systemitem>,
		<systemitem>pollution</systemitem></entry>
	      <entry xml:lang="en">Only IT employees are allowed to log onto these
		servers.</entry>
	    </row>

	    <row>
	      <!-- gluttony was omitted because it was too fat -->
	      <entry xml:lang="en"><systemitem>pride</systemitem>,
		<systemitem>greed</systemitem>,
		<systemitem>envy</systemitem>,
		<systemitem>wrath</systemitem>,
		<systemitem>lust</systemitem>,
		<systemitem>sloth</systemitem></entry>
	      <entry xml:lang="en">All members of the IT department are allowed to
		login onto these servers.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>one</systemitem>,
		<systemitem>two</systemitem>,
		<systemitem>three</systemitem>,
		<systemitem>four</systemitem>,
		...</entry>
	      <entry xml:lang="en">Ordinary workstations used by
		employees.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>trashcan</systemitem></entry>
	      <entry xml:lang="en">A very old machine without any critical data.
		Even interns are allowed to use this system.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para xml:lang="en">When using netgroups to configure this scenario, each user
	is assigned to one or more netgroups and logins are then
	allowed or forbidden for all members of the netgroup.  When
	adding a new machine, login restrictions must be defined for
	all netgroups.  When a new user is added, the account must be
	added to one or more netgroups.  If the
	<acronym>NIS</acronym> setup is planned carefully, only one
	central configuration file needs modification to grant or deny
	access to machines.</para>

      <para xml:lang="en">The first step is the initialization of the
	<acronym>NIS</acronym> <literal>netgroup</literal> map.  In
	FreeBSD, this map is not created by default.  On the
	<acronym>NIS</acronym> master server, use an editor to create
	a map named <filename>/var/yp/netgroup</filename>.</para>

      <para xml:lang="en">This example creates four netgroups to represent IT
	employees, IT apprentices, employees, and interns:</para>

      <programlisting xml:lang="en">IT_EMP  (,alpha,test-domain)    (,beta,test-domain)
IT_APP  (,charlie,test-domain)  (,delta,test-domain)
USERS   (,echo,test-domain)     (,foxtrott,test-domain) \
        (,golf,test-domain)
INTERNS (,able,test-domain)     (,baker,test-domain)</programlisting>

      <para xml:lang="en">Each entry configures a netgroup.  The first column in an
	entry is the name of the netgroup.  Each set of brackets
	represents  either a group of one or more users or the name of
	another netgroup.  When specifying a user, the three
	comma-delimited fields inside each group represent:</para>

      <orderedlist>
	<listitem>
	  <para xml:lang="en">The name of the host(s) where the other fields
	    representing the user are valid.  If a hostname is not
	    specified, the entry is valid on all hosts.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The name of the account that belongs to this
	    netgroup.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The <acronym>NIS</acronym> domain for the account.
	    Accounts may be imported from other <acronym>NIS</acronym>
	    domains into a netgroup.</para>
	</listitem>
      </orderedlist>

      <para xml:lang="en">If a group contains multiple users, separate each user
	with  whitespace.  Additionally, each field may contain
	wildcards.  See <citerefentry><refentrytitle>netgroup</refentrytitle><manvolnum>5</manvolnum></citerefentry> for details.</para>

      <indexterm xml:lang="en"><primary>netgroups</primary></indexterm>
      <para xml:lang="en">Netgroup names longer than 8 characters should not be
	used.  The names are case sensitive and using capital letters
	for netgroup names is an easy way to distinguish between user,
	machine and netgroup names.</para>

      <para xml:lang="en">Some non-FreeBSD <acronym>NIS</acronym> clients cannot
	handle netgroups containing more than 15 entries.  This
	limit may be circumvented by creating several sub-netgroups
	with 15 users or fewer and a real netgroup consisting of the
	sub-netgroups, as seen in this example:</para>

      <programlisting xml:lang="en">BIGGRP1  (,joe1,domain)  (,joe2,domain)  (,joe3,domain) [...]
BIGGRP2  (,joe16,domain)  (,joe17,domain) [...]
BIGGRP3  (,joe31,domain)  (,joe32,domain)
BIGGROUP  BIGGRP1 BIGGRP2 BIGGRP3</programlisting>

      <para xml:lang="en">Repeat this process if more than 225 (15 times 15) users
	exist within a single netgroup.</para>

      <para xml:lang="en">To activate and distribute the new
	<acronym>NIS</acronym> map:</para>

      <screen xml:lang="en">ellington<prompt>#</prompt> <userinput>cd /var/yp</userinput>
ellington<prompt>#</prompt> <userinput>make</userinput></screen>

      <para xml:lang="en">This will generate the three <acronym>NIS</acronym> maps
	<filename>netgroup</filename>,
	<filename>netgroup.byhost</filename> and
	<filename>netgroup.byuser</filename>.  Use the map key option
	of <citerefentry><refentrytitle>ypcat</refentrytitle><manvolnum>1</manvolnum></citerefentry> to check if the new <acronym>NIS</acronym>
	maps are available:</para>

      <screen xml:lang="en">ellington<prompt>%</prompt> <userinput>ypcat -k netgroup</userinput>
ellington<prompt>%</prompt> <userinput>ypcat -k netgroup.byhost</userinput>
ellington<prompt>%</prompt> <userinput>ypcat -k netgroup.byuser</userinput></screen>

      <para xml:lang="en">The output of the first command should resemble the
	contents of <filename>/var/yp/netgroup</filename>.  The second
	command only produces output if host-specific netgroups were
	created.  The third command is used to get the list of
	netgroups for a user.</para>

      <para xml:lang="en">To configure a client, use <citerefentry><refentrytitle>vipw</refentrytitle><manvolnum>8</manvolnum></citerefentry> to specify the
	name  of the netgroup.  For example, on the server named
	<systemitem>war</systemitem>,  replace this line:</para>

      <programlisting xml:lang="en">+:::::::::</programlisting>

      <para xml:lang="en">with</para>

      <programlisting xml:lang="en">+@IT_EMP:::::::::</programlisting>

      <para xml:lang="en">This specifies that only the users defined in the netgroup
	<literal>IT_EMP</literal> will be imported into this system's
	password database and only those users are allowed to login to
	this system.</para>

      <para xml:lang="en">This configuration also applies to the
	<literal>~</literal> function of the shell and all routines
	which convert between user names and numerical user IDs.  In
	other words,
	<command>cd ~<replaceable>user</replaceable></command> will
	not work, <command>ls -l</command> will show the numerical ID
	instead of the username, and <command>find . -user joe
	  -print</command> will fail with the message
	<errorname>No such user</errorname>.  To fix this, import all
	user entries without allowing them to login into the servers.
	This can be achieved by adding an extra line:</para>

      <programlisting xml:lang="en">+:::::::::/usr/sbin/nologin</programlisting>

      <para xml:lang="en">This line configures the client to import all entries but
	to replace the shell in those entries with
	<filename>/usr/sbin/nologin</filename>.</para>

      <!-- Been there, done that, got the scars to prove it - ue -->
      <para xml:lang="en">Make sure that extra line is placed
	<emphasis>after</emphasis>
	<literal>+@IT_EMP:::::::::</literal>.  Otherwise, all user
	accounts imported from <acronym>NIS</acronym> will have
	<filename>/usr/sbin/nologin</filename> as their login
	shell and no one will be able to login to the system.</para>

      <para xml:lang="en">To configure the less important servers, replace the old
	<literal>+:::::::::</literal> on the servers with these
	lines:</para>

      <programlisting xml:lang="en">+@IT_EMP:::::::::
+@IT_APP:::::::::
+:::::::::/usr/sbin/nologin</programlisting>

      <para xml:lang="en">The corresponding lines for the workstations
	would be:</para>

      <programlisting xml:lang="en">+@IT_EMP:::::::::
+@USERS:::::::::
+:::::::::/usr/sbin/nologin</programlisting>

      <para xml:lang="en">NIS supports the creation of netgroups from other
	netgroups which can be useful if the policy regarding user
	access changes.  One possibility is the creation of role-based
	netgroups.  For example, one might create a netgroup called
	<literal>BIGSRV</literal> to define the login restrictions for
	the important servers, another netgroup called
	<literal>SMALLSRV</literal> for the less important servers,
	and a third netgroup called <literal>USERBOX</literal> for the
	workstations.  Each of these netgroups contains the netgroups
	that are allowed to login onto these machines.  The new
	entries for the <acronym>NIS</acronym>
	<literal>netgroup</literal> map would look like this:</para>

      <programlisting xml:lang="en">BIGSRV    IT_EMP  IT_APP
SMALLSRV  IT_EMP  IT_APP  ITINTERN
USERBOX   IT_EMP  ITINTERN USERS</programlisting>

      <para xml:lang="en">This method of defining login restrictions works
	reasonably well when it is possible to define groups of
	machines with identical restrictions.  Unfortunately, this is
	the exception and not the rule.  Most of the time, the ability
	to define login restrictions on a per-machine basis is
	required.</para>

      <para xml:lang="en">Machine-specific netgroup definitions are another
	possibility to deal with the policy changes.  In this
	scenario, the <filename>/etc/master.passwd</filename> of each
	system contains two lines starting with <quote>+</quote>.
	The first line adds a netgroup with the accounts allowed to
	login onto this machine and the second line adds all other
	accounts with <filename>/usr/sbin/nologin</filename> as shell.
	It is recommended to use the <quote>ALL-CAPS</quote> version
	of the hostname as the name of the netgroup:</para>

      <programlisting xml:lang="en">+@<replaceable>BOXNAME</replaceable>:::::::::
+:::::::::/usr/sbin/nologin</programlisting>

      <para xml:lang="en">Once this task is completed on all the machines, there is
	no longer a need to modify the local versions of
	<filename>/etc/master.passwd</filename> ever again.  All
	further changes can be handled by modifying the
	<acronym>NIS</acronym> map.  Here is an example of a possible
	<literal>netgroup</literal> map for this scenario:</para>

      <programlisting xml:lang="en"># Define groups of users first
IT_EMP    (,alpha,test-domain)    (,beta,test-domain)
IT_APP    (,charlie,test-domain)  (,delta,test-domain)
DEPT1     (,echo,test-domain)     (,foxtrott,test-domain)
DEPT2     (,golf,test-domain)     (,hotel,test-domain)
DEPT3     (,india,test-domain)    (,juliet,test-domain)
ITINTERN  (,kilo,test-domain)     (,lima,test-domain)
D_INTERNS (,able,test-domain)     (,baker,test-domain)
#
# Now, define some groups based on roles
USERS     DEPT1   DEPT2     DEPT3
BIGSRV    IT_EMP  IT_APP
SMALLSRV  IT_EMP  IT_APP    ITINTERN
USERBOX   IT_EMP  ITINTERN  USERS
#
# And a groups for a special tasks
# Allow echo and golf to access our anti-virus-machine
SECURITY  IT_EMP  (,echo,test-domain)  (,golf,test-domain)
#
# machine-based netgroups
# Our main servers
WAR       BIGSRV
FAMINE    BIGSRV
# User india needs access to this server
POLLUTION  BIGSRV  (,india,test-domain)
#
# This one is really important and needs more access restrictions
DEATH     IT_EMP
#
# The anti-virus-machine mentioned above
ONE       SECURITY
#
# Restrict a machine to a single user
TWO       (,hotel,test-domain)
# [...more groups to follow]</programlisting>

      <para xml:lang="en">It may not always be advisable
	to use machine-based netgroups.  When deploying a couple of
	dozen or hundreds of systems,
	role-based netgroups instead of machine-based netgroups may be
	used to keep the size of the <acronym>NIS</acronym> map within
	reasonable limits.</para>
    </sect2>

    <sect2>
      <title>密碼格式</title>

      <indexterm xml:lang="en">
	<primary>NIS</primary>
	  <secondary>password formats</secondary>
      </indexterm>
      <para xml:lang="en"><acronym>NIS</acronym> requires that all hosts within an
	<acronym>NIS</acronym> domain use the same format for
	encrypting passwords.  If users have trouble authenticating on
	an <acronym>NIS</acronym> client, it may be due to a differing
	password format.  In a heterogeneous network, the format must
	be supported by all operating systems, where
	<acronym>DES</acronym> is the lowest common standard.</para>

      <para xml:lang="en">To check which format a server or client is using, look
	at this section of
	<filename>/etc/login.conf</filename>:</para>

      <programlisting xml:lang="en">default:\
	:passwd_format=des:\
	:copyright=/etc/COPYRIGHT:\
	[Further entries elided]</programlisting>

      <para xml:lang="en">In this example, the system is using the
	<acronym>DES</acronym> format.  Other possible values are
	<literal>blf</literal> for Blowfish and <literal>md5</literal>
	for MD5 encrypted passwords.</para>

      <para xml:lang="en">If the format on a host needs to be edited to match the
	one  being used in the <acronym>NIS</acronym> domain, the
	login capability database must be rebuilt after saving the
	change:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cap_mkdb /etc/login.conf</userinput></screen>

      <note>
	<para xml:lang="en">The format of passwords for existing user accounts will
	  not be updated until each user changes their password
	  <emphasis>after</emphasis> the login capability database is
	  rebuilt.</para>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="network-ldap">
    <info>
      <title>輕量級目錄存取協定 (<acronym>LDAP</acronym>)</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Originally contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Rocky</firstname>
	    <surname>Hotas</surname>
	  </personname>
	  <contrib>Updates by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en"><primary>LDAP</primary></indexterm>

    <para>輕量級目錄存取協定 (Lightweight Directory Access Protocol, <acronym>LDAP</acronym>) 是一個利用分散式目錄資訊服務來做到存取、修改與認証物件的應用層通訊協定，可以想像成是一本可以儲存數個階層、同質資訊的電話簿或記錄簿。它用在 Active Directory 及 <application>OpenLDAP</application> 網路，允許使用者利用一個帳號來存取數個階層的內部資訊，例如：電子郵件認証、取得員工聯絡資訊及內部網站的認証皆可使用 <acronym>LDAP</acronym> 伺服器資料庫中的單一使用者帳號來存取。</para>

    <para>本章節將介紹在 FreeBSD 系統上如何快速的設定一個 <acronym>LDAP</acronym> 伺服器。本章節假設管理者已做好規劃，這包含：要儲存何種類型的資訊、這些資訊要來做什麼、那些使用者擁有存取這些資訊的權限以及如何確保這些資訊不會被未經授權存取。</para>

    <sect2>
      <title><acronym>LDAP</acronym> 術語與結構</title>

      <para><acronym>LDAP</acronym> 使用了數個術語在開始設置之前必須先了解。所有的目錄項目由一群屬性 (<firstterm>attributes</firstterm>) 所組成，每個屬性集皆有一個獨特的辨識碼稱為辨識名稱 (<firstterm>Distinguished Name</firstterm>, <acronym>DN</acronym>)，這個辨識碼會由數個其他的屬性，如：常用或相對辨識名稱 (<firstterm>Relative Distinguished Name</firstterm>, <acronym>RDN</acronym>) 所組成，這就像目錄有絕對路徑與相對路徑，可以把 <acronym>DN</acronym> 當做絕對路徑，<acronym>RDN</acronym> 當做相對路徑。</para>

      <para><acronym>LDAP</acronym> 項目的例子如下。這個例子會搜尋指定使用者帳號 (<literal>uid</literal>)、組織單位 (<literal>ou</literal>) 及組織的項目 (<literal>o</literal>)：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>ldapsearch -xb "uid=<replaceable>trhodes</replaceable>,ou=<replaceable>users</replaceable>,o=<replaceable>example.com</replaceable>"</userinput>
# extended LDIF
#
# LDAPv3
# base &lt;uid=trhodes,ou=users,o=example.com&gt; with scope subtree
# filter: (objectclass=*)
# requesting: ALL
#

# trhodes, users, example.com
dn: uid=trhodes,ou=users,o=example.com
mail: trhodes@example.com
cn: Tom Rhodes
uid: trhodes
telephoneNumber: (123) 456-7890

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1</screen>

      <para>這個範例項目會顯示 <literal>dn</literal>, <literal>mail</literal>, <literal>cn</literal>, <literal>uid</literal> 以及 <literal>telephoneNumber</literal> 屬性的數值。而 <acronym>cn</acronym> 屬性則是 <acronym>RDN</acronym>。</para>

      <para>更多有關 <acronym>LDAP</acronym> 以及其術語的資訊可在 <uri xlink:href="http://www.openldap.org/doc/admin24/intro.html">http://www.openldap.org/doc/admin24/intro.html</uri> 找到。</para>
    </sect2>

    <sect2 xml:id="ldap-config">
      <title>設定 <acronym>LDAP</acronym> 伺服器</title>

      <indexterm xml:lang="en"><primary>LDAP Server</primary></indexterm>

      <para>FreeBSD 並未提供內建的 <acronym>LDAP</acronym> 伺服器，要開始設定前請先安裝 <package role="port">net/openldap-server</package> 套件或 Port：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install openldap-server</userinput></screen>

      <para>在<link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/linux-users/software.html">套件</link>中已開啟了許多的預設選項，可以透過執行 <command>pkg info openldap-server</command> 來查看已開啟的選項，若有不足的地方 (例如需要開啟 SQL 的支援)，請考慮使用適當的<link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/books/handbook/ports-using.html">方式</link>重新編譯該 Port。</para>

      <para>安裝程序會建立目錄 <filename>/var/db/openldap-data</filename> 來儲存資料，同時需要建立儲存憑證的目錄：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /usr/local/etc/openldap/private</userinput></screen>

      <para>接下來是設定憑証機構 (Certificate authority)。以下指令必須在 <filename>/usr/local/etc/openldap/private</filename> 下執行，這很重要是由於檔案權限須要被限制且其他使用者不應有這些檔案的存取權限，更多有關憑証的詳細資訊以及相關的參數可在 <xref linkend="openssl"/> 中找到。要建立憑証授權，需先輸人這個指令並依提示操作：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>openssl req -days <replaceable>365</replaceable> -nodes -new -x509 -keyout ca.key -out ../ca.crt</userinput></screen>

      <para>提示輸入的項目<emphasis>除了</emphasis>通用名稱 (<literal>Common Name</literal>) 外其他是可以一樣的，這個項目必須使用跟系統主機名稱 <emphasis>不同</emphasis> 的名稱。若這是一個自行簽署的憑証 (Self signed certificate)，則在憑証機構 <literal>CA</literal> 的前面加上主機名稱。</para>

      <para>接下來的工作是建立一個伺服器的憑証簽署請求與一個私鑰。請輸入以下指令然後依提示操作：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>openssl req -days <replaceable>365</replaceable> -nodes -new -keyout server.key -out server.csr</userinput></screen>

      <para>在憑証產生程序的過程中請確認 <literal>Common Name</literal> 屬性設定正確。憑証簽署請求 (Certificate Signing Request) 必須經過憑証機構簽署後才會成為有效的憑証：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>openssl x509 -req -days <replaceable>365</replaceable> -in server.csr -out ../server.crt -CA ../ca.crt -CAkey ca.key -CAcreateserial</userinput></screen>

      <para>在憑証產生程序的最後一步是產生並簽署客戶端憑証：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>openssl req -days <replaceable>365</replaceable> -nodes -new -keyout client.key -out client.csr</userinput>
<prompt>#</prompt> <userinput>openssl x509 -req -days 3650 -in client.csr -out ../client.crt -CA ../ca.crt -CAkey ca.key</userinput></screen>

      <para>記得當提示時要使用同樣的 <literal>Common Name</literal> 屬性。完成之後，請確認執行的指令產生了 8 個新檔案。</para>

      <para>OpenLDAP 伺服器所執行的 Daemon 為 <filename>slapd</filename>，OpenLDAP 是透過 <filename>slapd.ldif</filename> 來做設定， OpenLDAP 官方已停止採用舊的 <filename>slapd.conf</filename> 格式。</para>

      <para>這裡有些 <filename>slapd.ldif</filename> 的 <link xlink:href="http://www.openldap.org/doc/admin24/slapdconf2.html">設定檔範例</link> 可以使用，同時您也可以在 <filename>/usr/local/etc/openldap/slapd.ldif.sample</filename> 找到範例資訊。相關可用的選項在 slapd-config(5) 文件會有說明。<filename>slapd.ldif</filename> 的每個段落，如同其他 LDAP 屬性設定一樣會透過獨一無二 DN 來辨識，並請確保 <literal>dn:</literal> 描述與其相關屬性之間沒有空行。以下的範例中會實作一個使用 TLS 的安全通道，首先是全域的設定：</para>

      <programlisting xml:lang="en">#
# See slapd-config(5) for details on configuration options.
# This file should NOT be world readable.
#
dn: cn=config
objectClass: olcGlobal
cn: config
#
#
# Define global ACLs to disable default read access.
#
olcArgsFile: /var/run/openldap/slapd.args
olcPidFile: /var/run/openldap/slapd.pid
olcTLSCertificateFile: /usr/local/etc/openldap/server.crt
olcTLSCertificateKeyFile: /usr/local/etc/openldap/private/server.key
olcTLSCACertificateFile: /usr/local/etc/openldap/ca.crt
#olcTLSCipherSuite: HIGH
olcTLSProtocolMin: 3.1
olcTLSVerifyClient: never</programlisting>

      <para>這個檔案中必須指定憑証機構 (Certificate Authority)、伺服器憑証 (Server Certificate) 與伺服器私鑰 (Server Private Key)，建議可讓客戶端決定使用的安全密碼 (Security Cipher)，略過 <literal>olcTLSCipherSuite</literal> 選項 (此選項不相容 <filename>openssl</filename> 以外的 TLS 客戶端)。選項 <literal>olcTLSProtocolMin</literal> 讓伺服器可要求一個安全等級的最低限度，建議使用。伺服器有進行驗証的必要，但客戶端並不需要，因此可設定 <literal>olcTLSVerifyClient: never</literal>。</para>

      <para>第二個部份是設定後端要採用的模組有那些，可使用以下方式設定：</para>

      <programlisting xml:lang="en">#
# Load dynamic backend modules:
#
dn: cn=module,cn=config
objectClass: olcModuleList
cn: module
olcModulepath:	/usr/local/libexec/openldap
olcModuleload:	back_mdb.la
#olcModuleload:	back_bdb.la
#olcModuleload:	back_hdb.la
#olcModuleload:	back_ldap.la
#olcModuleload:	back_passwd.la
#olcModuleload:	back_shell.la</programlisting>

      <para>第三個部份要載入資料庫所需的 <literal>ldif</literal> 綱要 (Schema)，這個動作是必要的。</para>

      <programlisting xml:lang="en">dn: cn=schema,cn=config
objectClass: olcSchemaConfig
cn: schema

include: file:///usr/local/etc/openldap/schema/core.ldif
include: file:///usr/local/etc/openldap/schema/cosine.ldif
include: file:///usr/local/etc/openldap/schema/inetorgperson.ldif
include: file:///usr/local/etc/openldap/schema/nis.ldif</programlisting>

      <para>接下來是前端設定的部份：</para>

      <programlisting xml:lang="en"># Frontend settings
#
dn: olcDatabase={-1}frontend,cn=config
objectClass: olcDatabaseConfig
objectClass: olcFrontendConfig
olcDatabase: {-1}frontend
olcAccess: to * by * read
#
# Sample global access control policy:
#	Root DSE: allow anyone to read it
#	Subschema (sub)entry DSE: allow anyone to read it
#	Other DSEs:
#		Allow self write access
#		Allow authenticated users read access
#		Allow anonymous users to authenticate
#
#olcAccess: to dn.base="" by * read
#olcAccess: to dn.base="cn=Subschema" by * read
#olcAccess: to *
#	by self write
#	by users read
#	by anonymous auth
#
# if no access controls are present, the default policy
# allows anyone and everyone to read anything but restricts
# updates to rootdn.  (e.g., "access to * by * read")
#
# rootdn can always read and write EVERYTHING!
#
olcPasswordHash: {SSHA}
# {SSHA} is already the default for olcPasswordHash</programlisting>

      <para>再來是<emphasis>設定後端</emphasis>的部份，之後唯一能夠存取 OpenLDAP 伺服器設定的方式是使用全域超級使用者。</para>

      <programlisting xml:lang="en">dn: olcDatabase={0}config,cn=config
objectClass: olcDatabaseConfig
olcDatabase: {0}config
olcAccess: to * by * none
olcRootPW: {SSHA}iae+lrQZILpiUdf16Z9KmDmSwT77Dj4U</programlisting>

      <para>預設的管理者使用者名稱是 <literal>cn=config</literal>，可在 Shell 中輸入 <filename>slappasswd</filename>，決定要使用的密碼並將其產生的編碼放到 <literal>olcRootPW</literal> 欄位中。若這個選項在這時沒有設定好，在匯入 <filename>slapd.ldif</filename> 之後將沒有任何人有辦法修改<emphasis>全域的設定</emphasis>。</para>

      <para>最後一個部份是有關資料庫後端的設定：</para>

      <programlisting xml:lang="en">#######################################################################
# LMDB database definitions
#######################################################################
#
dn: olcDatabase=mdb,cn=config
objectClass: olcDatabaseConfig
objectClass: olcMdbConfig
olcDatabase: mdb
olcDbMaxSize: 1073741824
olcSuffix: dc=domain,dc=example
olcRootDN: cn=mdbadmin,dc=domain,dc=example
# Cleartext passwords, especially for the rootdn, should
# be avoided.  See slappasswd(8) and slapd-config(5) for details.
# Use of strong authentication encouraged.
olcRootPW: {SSHA}X2wHvIWDk6G76CQyCMS1vDCvtICWgn0+
# The database directory MUST exist prior to running slapd AND
# should only be accessible by the slapd and slap tools.
# Mode 700 recommended.
olcDbDirectory:	/var/db/openldap-data
# Indices to maintain
olcDbIndex: objectClass eq</programlisting>

      <para>這裡指定的資料庫即<emphasis>實際用來保存</emphasis> <acronym>LDAP</acronym> 目錄的資料，也可以使用 <literal>mdb</literal> 以外的項目，資料庫的超級使用者可在這裡設定 (與全域的超級使用者是不同的東西)：<literal>olcRootDN</literal>　需填寫使用者名稱 (可自訂)，<literal>olcRootPW</literal> 需填寫該使用者編碼後的密碼，將密碼編碼可使用 <filename>slappasswd</filename> 如同前面所述。</para>

      <para>這裡有個<link xlink:href="http://www.openldap.org/devel/gitweb.cgi?p=openldap.git;a=tree;f=tests/data/regressions/its8444;h=8a5e808e63b0de3d2bdaf2cf34fecca8577ca7fd;hb=HEAD">檔案庫</link>內有四個 <filename>slapd.ldif</filename> 的範例，要將現有的 <filename>slapd.conf</filename> 轉換成 <filename>slapd.ldif</filename> 格式，可參考<link xlink:href="http://www.openldap.org/doc/admin24/slapdconf2.html">此頁</link> (注意，這裡面的說明也會介紹一些不常用的選項)。</para>

      <para>當設定完成之後，需將 <filename>slapd.ldif</filename> 放在一個空的目錄當中，建議如以下方式建立：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>mkdir /usr/local/etc/openldap/slapd.d/</userinput></screen>

      <para>匯入設定資料庫：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>/usr/local/sbin/slapadd -n0 -F /usr/local/etc/openldap/slapd.d/ -l /usr/local/etc/openldap/slapd.ldif</userinput></screen>

      <para>啟動 <filename>slapd</filename> Daemon：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>/usr/local/libexec/slapd -F /usr/local/etc/openldap/slapd.d/</userinput></screen>

      <para>選項 <literal>-d</literal> 可以用來除錯使用，如同 slapd(8) 中所說明的，若要檢驗伺服器是否正常執行與運作可以：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ldapsearch -x -b '' -s base '(objectclass=*)' namingContexts</userinput>
# extended LDIF
#
# LDAPv3
# base &lt;&gt; with scope baseObject
# filter: (objectclass=*)
# requesting: namingContexts
#

#
dn:
namingContexts: dc=domain,dc=example

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1</screen>

      <para>伺服器端仍必須受到信任，若在此之前未做過這個動作，請依照以下指示操作。安裝 OpenSSL 套件或 Port：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install openssl</userinput></screen>

      <para>進入 <filename>ca.crt</filename> 所在的目錄 (以這邊使用的例子來說則是 <filename>/usr/local/etc/openldap</filename>)，執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>c_rehash .</userinput></screen>

      <para>現在 CA 與伺服器憑証可以依其用途被辨識，可進入 <filename>server.crt</filename> 所在的目錄執行以下指令來檢查：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>openssl verify -verbose -CApath . server.crt</userinput></screen>

      <para>若 <filename>slapd</filename> 已正在執行，就重新啟動它。如同 <filename>/usr/local/etc/rc.d/slapd</filename> 所述，要讓 <filename>slapd</filename> 開機時可正常執行，須要加入以下行到 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">lapd_enable="YES"
slapd_flags='-h "ldapi://%2fvar%2frun%2fopenldap%2fldapi/
ldap://0.0.0.0/"'
slapd_sockets="/var/run/openldap/ldapi"
slapd_cn_config="YES"</programlisting>

      <para>開機啟動 <filename>slapd</filename> 並不會提供除錯的功能，您可以檢查 <filename>/var/log/debug.log</filename>, <filename>dmesg -a</filename> 及 <filename>/var/log/messages</filename> 檢確認是否有正常運作。</para>

      <para>以下範例會新增群組 <literal>team</literal> 及使用者 <literal>john</literal> 到 <systemitem class="systemname">domain.example</systemitem> <acronym>LDAP</acronym> 資料庫，而該資料庫目前是空的。首先要先建立 <filename>domain.ldif</filename> 檔：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cat domain.ldif</userinput>
dn: dc=domain,dc=example
objectClass: dcObject
objectClass: organization
o: domain.example
dc: domain

dn: ou=groups,dc=domain,dc=example
objectClass: top
objectClass: organizationalunit
ou: groups

dn: ou=users,dc=domain,dc=example
objectClass: top
objectClass: organizationalunit
ou: users

dn: cn=team,ou=groups,dc=domain,dc=example
objectClass: top
objectClass: posixGroup
cn: team
gidNumber: 10001

dn: uid=john,ou=users,dc=domain,dc=example
objectClass: top
objectClass: account
objectClass: posixAccount
objectClass: shadowAccount
cn: John McUser
uid: john
uidNumber: 10001
gidNumber: 10001
homeDirectory: /home/john/
loginShell: /usr/bin/bash
userPassword: secret</screen>

      <para>請查看 OpenLDAP 說明文件取得更詳細的資訊，使用 <filename>slappasswd</filename> 來將純文字的密碼 <literal>secret</literal> 更改為已編碼的型式來填寫 <literal>userPassword</literal> 欄位。在 <literal>loginShell</literal> 所指定的路徑，必須在所有可讓 <literal>john</literal> 登入的系統中存在。最後是使用 <literal>mdb</literal> 管理者修改資料庫：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ldapadd -W -D "cn=mdbadmin,dc=domain,dc=example" -f domain.ldif</userinput></screen>

      <para>要修改<emphasis>全域設定</emphasis>只能使用全域的超及使用者。例如，假設一開始採用了 <literal>olcTLSCipherSuite: HIGH:MEDIUM:SSLv3</literal> 選項，但最後想要把它移除，可以建立一個有以下內容的檔案：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cat <replaceable>global_mod</replaceable></userinput>
dn: cn=config
changetype: modify
delete: olcTLSCipherSuite</screen>

      <para>然後套用修改內容：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ldapmodify -f global_mod -x -D "cn=config" -W</userinput></screen>

      <para>當提示輸入密碼時，提供當時在<emphasis>設定後端</emphasis>一節所設定的密碼，在這裡無須填寫使用者名稱，<literal>cn=config</literal> 代表要修改資料庫資料的位置。也可以使用 <literal>ldapmodify</literal> 刪除其中一行屬性，或是 <literal>ldapdelete</literal> 刪除整筆資料。</para>

      <para>若有問題無法正常執行，或是全域的超級使用者無法存取後端的設定，可以刪除並重建整個後端設定：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>rm -rf /usr/local/etc/openldap/slapd.d/</userinput></screen>

      <para>可以修改 <filename>slapd.ldif</filename> 後再重新匯入一次。請注意，這個步驟只在沒有其他方式可用時才使用。</para>

      <para>本章節的設定說明只針對伺服器端的部份，在同一台主機中也可以同時有安裝 LDAP 客戶端但需要額外做設定。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="network-dhcp">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Greg</firstname>
	  <surname>Sutter</surname>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>動態主機設置協定 (<acronym>DHCP</acronym>)</title>

    <indexterm xml:lang="en">
      <primary>Dynamic Host Configuration Protocol</primary>
      <see><acronym>DHCP</acronym></see>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>Internet Systems Consortium (ISC)</primary>
    </indexterm>

    <para>動態主機設置協定 (Dynamic Host Configuration Protocol, <acronym>DHCP</acronym>) 可分配必要的位置資訊給一個連線到網路的系統以在該網路通訊。FreeBSD 內含 OpenBSD 版本的 <command>dhclient</command>，可用來做為客戶端來取得位置資訊。FreeBSD 預設並不會安裝 <acronym>DHCP</acronym> 伺服器，但在 FreeBSD Port 套件集中有許多可用的伺服器。有關 <acronym>DHCP</acronym> 通訊協定的完整說明位於 <link xlink:href="http://www.freesoft.org/CIE/RFC/2131/">RFC 2131</link>，相關資源也可至 <link xlink:href="http://www.isc.org/downloads/dhcp/">isc.org/downloads/dhcp/</link> 取得。</para>

    <para>本節將介紹如何使用內建的 <acronym>DHCP</acronym> 客戶端，接著會介紹如何安裝並設定一個 <acronym>DHCP</acronym> 伺服器。</para>

    <note>
      <para>在 FreeBSD 中，<citerefentry><refentrytitle>bpf</refentrytitle><manvolnum>4</manvolnum></citerefentry> 裝置同時會被 <acronym>DHCP</acronym> 伺服器與 <acronym>DHCP</acronym> 客戶端所使用。這個裝置會在 <filename>GENERIC</filename> 核心中被引用並隨著 FreeBSD 安裝。想要建立自訂核心的使用者若要使用 <acronym>DHCP</acronym> 則須保留這個裝置。</para>

      <para>另外要注意 <filename>bpf</filename> 也會讓有權限的使用者在該系統上可執行網路封包監聽程式。</para>
    </note>

    <sect2>
      <title>設定 <acronym>DHCP</acronym> 客戶端</title>

      <para><acronym>DHCP</acronym> 客戶端內含在 FreeBSD 安裝程式當中，這讓在新安裝的系統上設定自動從 <acronym>DHCP</acronym> 伺服器接收網路位置資訊變的更簡單。請參考 <xref linkend="bsdinstall-post"/> 取得網路設置的範例。</para>

      <indexterm xml:lang="en"><primary><acronym>UDP</acronym></primary></indexterm>
      <para>當 <command>dhclient</command> 在客戶端機器上執行時，它便會開始廣播請求取得設置資訊。預設這些請求會使用 <acronym>UDP</acronym> 埠號 68。而伺服器則會在 <acronym>UDP</acronym> 埠號 67 來回覆，將 <acronym>IP</acronym> 位址與其他相關的網路資訊，如：子網路遮罩、預設閘道及 <acronym>DNS</acronym> 伺服器位址告訴客戶端，詳細的清單可在 <citerefentry><refentrytitle>dhcp-options</refentrytitle><manvolnum>5</manvolnum></citerefentry> 找到。</para>

      <para>預設當 FreeBSD 系統開機時，其 <acronym>DHCP</acronym> 客戶端會在背景執行或稱非同步 (<firstterm>Asynchronously</firstterm>) 執行，在完成 <acronym>DHCP</acronym> 程序的同時其他啟動 Script 會繼續執行，來加速系統啟動。</para>

      <para>背景 <acronym>DHCP</acronym> 在 <acronym>DHCP</acronym> 伺服器可以快速的回應客戶端請求時可運作的很好。然而 <acronym>DHCP</acronym> 在某些系統可能需要較長的時間才能完成，若網路服務嘗試在 <acronym>DHCP</acronym> 尚未分配網路位置資訊前執行則會失敗。使用同步 (<firstterm>Synchronous</firstterm>) 模式執行 <acronym>DHCP</acronym> 可避免這個問題，因為同步模式會暫停啟動直到 <acronym>DHCP</acronym> 已設置完成。</para>

      <para>在 <filename>/etc/rc.conf</filename> 中的這行用來設定採用背景 (非同步模式)：</para>

      <programlisting xml:lang="en">ifconfig_<replaceable>fxp0</replaceable>="DHCP"</programlisting>

      <para>若系統已經在安裝時設定使用 <acronym>DHCP</acronym>，這行可能會已存在。替換在例子中的 <replaceable>fxp0</replaceable> 為實際要動態設置的網路介面名稱，如 <xref linkend="config-network-setup"/> 中的說明。</para>

      <para>要改設定系統採用同步模式，在啟動時暫停等候 <acronym>DHCP</acronym> 完成，使用 <quote><literal>SYNCDHCP</literal></quote>：</para>

      <programlisting xml:lang="en">ifconfig_<replaceable>fxp0</replaceable>="SYNCDHCP"</programlisting>

      <para>尚有其他可用的客戶端選項，請在 <citerefentry><refentrytitle>rc.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 搜尋 <literal>dhclient</literal> 來取得詳細資訊。</para>

      <indexterm xml:lang="en">
	<primary><acronym>DHCP</acronym></primary>
	<secondary>configuration files</secondary>
      </indexterm>

      <para><acronym>DHCP</acronym> 客戶端會使用到以下檔案：</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><filename>/etc/dhclient.conf</filename></para>

	  <para><command>dhclient</command> 用到的設定檔。通常這個檔案只會有註解，因為預設便適用大多數客戶端。這個設定檔在 <citerefentry><refentrytitle>dhclient.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 中有說明。</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><filename>/sbin/dhclient</filename></para>

	  <para>有關指令本身的更多資訊可於 <citerefentry><refentrytitle>dhclient</refentrytitle><manvolnum>8</manvolnum></citerefentry> 找到。</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><filename>/sbin/dhclient-script</filename></para>

	  <para>FreeBSD 特定的 <acronym>DHCP</acronym> 客戶端設定 Script。在 <citerefentry><refentrytitle>dhclient-script</refentrytitle><manvolnum>8</manvolnum></citerefentry> 中有說明，但應不須做任何修改便可正常運作。</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><filename>/var/db/dhclient.leases.<replaceable>interface</replaceable></filename></para>

	  <para><acronym>DHCP</acronym> 客戶端會在這個檔案中儲存有效租約的資料，寫入的格式類似日誌，在 <citerefentry><refentrytitle>dhclient.leases</refentrytitle><manvolnum>5</manvolnum></citerefentry> 有說明。</para>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2 xml:id="network-dhcp-server">
      <title>安裝並設定 <acronym>DHCP</acronym> 伺服器</title>

      <para>本節將示範如何設定 FreeBSD 系統成為 <acronym>DHCP</acronym> 伺服器，使用 Internet Systems Consortium (<acronym>ISC</acronym>) 所實作的 <acronym>DHCP</acronym> 伺服器，這個伺服器及其文件可使用 <package>net/isc-dhcp43-server</package> 套件或 Port 安裝。</para>

      <indexterm xml:lang="en">
	<primary><acronym>DHCP</acronym></primary>
	<secondary>server</secondary>
      </indexterm>

      <indexterm xml:lang="en">
	<primary><acronym>DHCP</acronym></primary>
	  <secondary>installation</secondary>
      </indexterm>

      <para><package>net/isc-dhcp43-server</package> 的安裝程式會安裝一份範例設定檔，複製 <filename>/usr/local/etc/dhcpd.conf.example</filename> 到 <filename>/usr/local/etc/dhcpd.conf</filename> 並在這個新檔案做編輯。</para>

      <indexterm xml:lang="en">
	<primary><acronym>DHCP</acronym></primary>
	  <secondary>dhcpd.conf</secondary>
      </indexterm>
      <para>這個設定檔內容包括了子網路及主機的宣告，用來定義要提供給 <acronym>DHCP</acronym> 客戶端的資訊。如以下行設定：</para>

      <programlisting xml:lang="en">option domain-name "example.org";<co xml:id="domain-name"/>
option domain-name-servers ns1.example.org;<co xml:id="domain-name-servers"/>
option subnet-mask 255.255.255.0;<co xml:id="subnet-mask"/>

default-lease-time 600;<co xml:id="default-lease-time"/>
max-lease-time 72400;<co xml:id="max-lease-time"/>
ddns-update-style none;<co xml:id="ddns-update-style"/>

subnet 10.254.239.0 netmask 255.255.255.224 {
  range 10.254.239.10 10.254.239.20;<co xml:id="range"/>
  option routers rtr-239-0-1.example.org, rtr-239-0-2.example.org;<co xml:id="routers"/>
}

host fantasia {
  hardware ethernet 08:00:07:26:c0:a5;<co xml:id="hardware"/>
  fixed-address fantasia.fugue.com;<co xml:id="fixed-address"/>
}</programlisting>

      <calloutlist>
	<callout arearefs="domain-name">
	  <para>這個選項指定了要提供給客戶端的預設搜尋網域。請參考 <citerefentry><refentrytitle>resolv.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 取得更多資訊。</para>
	</callout>

	<callout arearefs="domain-name-servers">
	  <para>這個選項指定了客戶端應使用的 <acronym>DNS</acronym> 伺服器清單 (以逗號分隔)。如範例中所示，可使用伺服器的完整網域名稱 (Fully Qualified Domain Names, <acronym>FQDN</acronym>) 或伺服器的 <acronym>IP</acronym> 位址。</para>
	</callout>

	<callout arearefs="subnet-mask">
	  <para>要提供給客戶端的子網路遮罩。</para>
	</callout>

	<callout arearefs="default-lease-time">
	  <para>預設租約到期時間 (秒)。客戶端可以自行設定覆蓋這個數值。</para>
	</callout>

	<callout arearefs="max-lease-time">
	  <para>一個租約最多允許的時間長度 (秒)。若客戶端請求更長的租約，仍會發出租約，但最多只會在 <literal>max-lease-time</literal> 內有效。</para>
	</callout>

	<callout arearefs="ddns-update-style">
	  <para>預設的 <option>none</option> 會關閉動態 DNS 更新。更改此值為 <option>interim</option> 可讓 <acronym>DHCP</acronym> 伺服器每當發出一個租約便通知 <acronym>DNS</acronym> 伺服器更新，如此一來 <acronym>DNS</acronym> 伺服器便知道網路中該電腦的 <acronym>IP</acronym> 位址。不要更改此預設值，除非 <acronym>DNS</acronym> 伺服器已設定為支援動態 <acronym>DNS</acronym>。</para>
	</callout>

	<callout arearefs="range">
	  <para>此行會建立一個可用 <acronym>IP</acronym> 位址的儲存池來保留這些要分配給 <acronym>DHCP</acronym> 客戶端的位址。位址範圍必須在前一行所指定的網路或子網路中有效。</para>
	</callout>

	<callout arearefs="routers">
	  <para>宣告在開始的 <literal>{</literal> 括號之前所指定的網路或子網路中有效的預設通訊閘。</para>
	</callout>

	<callout arearefs="hardware">
	  <para>指定客戶端的硬體 <acronym>MAC</acronym> 位址，好讓 <acronym>DHCP</acronym> 伺服器在客戶端發出請求時可以辨識客戶端。</para>
	</callout>

	<callout arearefs="fixed-address">
	  <para>指定這個主機應分配相同的 <acronym>IP</acronym> 位址。在此處用主機名稱是正確的，由於 <acronym>DHCP</acronym> 伺服器會在回傳租約資訊前先解析主機名稱。</para>
	</callout>
      </calloutlist>

      <para>此設定檔還支援其他選項，請參考隨伺服器一併安裝的  dhcpd.conf(5) 來取得詳細資訊與範例。</para>

      <para>完成 <filename>dhcpd.conf</filename> 的設定之後，在 <filename>/etc/rc.conf</filename> 啟動 <acronym>DHCP</acronym> 伺服器：</para>

      <programlisting xml:lang="en">dhcpd_enable="YES"
dhcpd_ifaces="dc0"</programlisting>

      <para>替換 <literal>dc0</literal> 為 <acronym>DHCP</acronym> 伺服器要傾聽 <acronym>DHCP</acronym> 客戶端請求的網路介面 (多個介面可以空白分隔)。</para>

      <para>執行以下指令來啟動伺服器：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service isc-dhcpd start</userinput></screen>

      <para>往後任何對伺服器設定的變更會需要使用 <citerefentry><refentrytitle>service</refentrytitle><manvolnum>8</manvolnum></citerefentry> 中止 <application>dhcpd</application> 服務然後啟動。</para>

      <para><acronym>DHCP</acronym> 伺服器會使用到以下檔案。注意，操作手冊會與伺服器軟體一同安裝。</para>

      <indexterm xml:lang="en">
	<primary><acronym>DHCP</acronym></primary>
	<secondary>configuration files</secondary>
      </indexterm>
      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><filename>/usr/local/sbin/dhcpd</filename></para>

	  <para>更多有關 <application>dhcpd</application> 伺服器的資訊可在 dhcpd(8) 找到。</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><filename>/usr/local/etc/dhcpd.conf</filename></para>

	  <para>伺服器設定檔需要含有所有要提供給客戶端的資訊以及有關伺服器運作的資訊。在 dhcpd.conf(5) 有此設定檔的說明。</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><filename>/var/db/dhcpd.leases</filename></para>

	  <para><acronym>DHCP</acronym> 伺服器會儲存一份已發出租約的資料於這個檔案，寫入的格式類似日誌。參考 dhcpd.leases(5) 會有更完整的說明。</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><filename>/usr/local/sbin/dhcrelay</filename></para>

	  <para>這個 Daemon 會用在更進階的環境中，在一個 <acronym>DHCP</acronym> 伺服器要轉發來自客戶端的請求到另一個網路的另一個 <acronym>DHCP</acronym> 伺服器的環境。若需要使用此功能，請安裝 <package>net/isc-dhcp43-relay</package> 套件或 Port，安裝會包含 dhcrelay(8)，裡面有提供更詳細的資訊。</para>
	</listitem>
      </itemizedlist>
    </sect2>
  </sect1>

  <sect1 xml:id="network-dns">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Chern</firstname>
	  <surname>Lee</surname>
	  <contrib>Contributed by </contrib>
	</author>

	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	</author>

	<author>
	  <firstname>Daniel</firstname>
	  <surname>Gerzo</surname>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>網域名稱系統 (<acronym>DNS</acronym>)</title>

    <indexterm xml:lang="en"><primary>DNS</primary></indexterm>

    <para>網域名稱系統 (Domain Name System, <acronym>DNS</acronym>) 是一種協定用來轉換網域名稱為 <acronym>IP</acronym> 位址，反之亦然。<acronym>DNS</acronym> 會協調網際網路上有權的根節點 (Authoritative root)、最上層網域 (Top Level Domain, <acronym>TLD</acronym>) 及其他小規模名稱伺服器來取得結果，而這些伺服器可管理與快取個自的網域資訊。要在系統上做 <acronym>DNS</acronym> 查詢並不需要架設一個名稱伺服器。</para>

    <indexterm xml:lang="en"><primary>resolver</primary></indexterm>
    <indexterm xml:lang="en"><primary>reverse
      <acronym>DNS</acronym></primary></indexterm>
    <indexterm xml:lang="en"><primary>root zone</primary></indexterm>

    <para>以下表格會說明一些與 <acronym>DNS</acronym> 有關的術語：</para>

    <table frame="none" pgwide="1">
      <title><acronym>DNS</acronym> 術語</title>

      <tgroup cols="2">
	<colspec colwidth="1*"/>
	<colspec colwidth="3*"/>

	<thead>
	  <row>
	    <entry>術語</entry>
	    <entry>定義</entry>
	  </row>
	</thead>

	<tbody>
	  <row>
	    <entry>正向 <acronym>DNS</acronym> (Forward <acronym>DNS</acronym>)</entry>
	    <entry>將主機名稱對應 <acronym>IP</acronym> 位址的動作。</entry>
	  </row>

	  <row>
	    <entry>源頭 (Origin)</entry>
	    <entry>代表某個轄區檔案中所涵蓋的網域。</entry>
	  </row>

	  <row>
	    <entry>解析器 (Resolver)</entry>
	    <entry>主機向名稱伺服器查詢轄區資訊的系統程序。</entry>
	  </row>

	  <row>
	    <entry>反向 <acronym>DNS</acronym> (Reverse <acronym>DNS</acronym>)</entry>
	    <entry>將 <acronym>IP</acronym> 對應主機名稱的動作。</entry>
	  </row>

	  <row>
	    <entry>根轄區 (Root zone)</entry>

	    <entry>網際網路轄區階層的最開始，所有的轄區會在根轄區之下，類似在檔案系統中所有的檔案會在根目錄底下。</entry>
	  </row>

	  <row>
	    <entry>轄區 (Zone)</entry>
	    <entry>獨立的網域、子網域或或由相同授權 (Authority) 管理的部分 <acronym>DNS</acronym>。</entry>
	  </row>
	</tbody>
      </tgroup>
    </table>

    <indexterm xml:lang="en">
      <primary>zones</primary>
      <secondary>examples</secondary>
    </indexterm>

    <para>轄區範例：</para>

    <itemizedlist>
      <listitem>
	<para><systemitem>.</systemitem> 是一般在文件中表達根轄區的方式。</para>
      </listitem>

      <listitem>
	<para><systemitem>org.</systemitem> 是一個在根轄區底下的最上層網域 (Top Level Domain , <acronym>TLD</acronym>)。</para>
      </listitem>

      <listitem>
	<para><systemitem class="fqdomainname">example.org.</systemitem> 是一個在 <systemitem>org.</systemitem> <acronym>TLD</acronym> 底下的轄區。</para>
      </listitem>

      <listitem>
	<para><systemitem>1.168.192.in-addr.arpa</systemitem> 是一個轄區用來代表所有在 <systemitem class="ipaddress">192.168.1.*</systemitem> <acronym>IP</acronym> 位址空間底下的 <acronym>IP</acronym> 位址。</para>
      </listitem>
    </itemizedlist>

    <para>如您所見，更詳細的主機名稱會加在左方，例如 <systemitem class="fqdomainname">example.org.</systemitem> 比 <systemitem>org.</systemitem> 更具體，如同 <systemitem>org.</systemitem> 比根轄區更具體，主機名稱每一部份的架構很像檔案系統：<filename>/dev</filename> 目錄在根目錄底下，以此類推。</para>

    <sect2>
      <title>要架設名稱伺服器的原因</title>

      <para>名稱伺服器通常有兩種形式：有權的 (Authoritative) 名稱伺服器與快取 (或稱解析) 名稱伺服器。</para>

      <para>以下情況會需要一台有權的名稱伺服器：</para>

      <itemizedlist>
	<listitem>
	  <para>想要提供 <acronym>DNS</acronym> 資訊給全世界，做為官方回覆查詢。</para>
	</listitem>

	<listitem>
	  <para>已經註冊了一個網域，例如 <systemitem class="fqdomainname">example.org</systemitem>，且要將 <acronym>IP</acronym> 位址分配到主機名稱下。</para>
	</listitem>

	<listitem>
	  <para>一段 <acronym>IP</acronym> 位址範圍需要反向 <acronym>DNS</acronym> 項目 (<acronym>IP</acronym> 轉主機名稱)。</para>
	</listitem>

	<listitem>
	  <para>要有一台備援或次要名稱伺服器用來回覆查詢。</para>
	</listitem>
      </itemizedlist>

      <para>以下情況會需要一台快取名稱伺服器：</para>

      <itemizedlist>
	<listitem>
	  <para>比起查詢外部的名稱伺服器本地 <acronym>DNS</acronym> 伺服器可以快取並更快的回應。</para>
	</listitem>
      </itemizedlist>

      <para>當查詢 <systemitem class="fqdomainname">www.FreeBSD.org</systemitem> 時，解析程式通常會查詢上游 <acronym>ISP</acronym> 的名稱伺服器然後接收其回覆，使用本地、快取 <acronym>DNS</acronym> 伺服器，只需要由快取 <acronym>DNS</acronym> 伺服器對外部做一次查詢，其他的查詢則不需要再向區域網路之外查詢，因為這些資訊已經在本地被快取了。</para>
    </sect2>

    <sect2>
      <title><acronym>DNS</acronym> 伺服器設定</title>

      <para><application>Unbound</application> 由 FreeBSD 基礎系統提供，預設只會提供本機的 <acronym>DNS</acronym> 解析，雖然基礎系統的套件可被設定提供本機以外的解析服務，但要解決這樣的需求仍建議安裝 FreeBSD Port 套件集中的 <application>Unbound</application>。</para>

      <para>要開啟 <application>Unbound</application> 可加入下行到 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">local_unbound_enable="YES"</programlisting>

      <para>任何已存在於 <filename>/etc/resolv.conf</filename> 中的名稱伺服器會在新的 <application>Unbound</application> 設定中被設為追隨者 (Forwarder)。</para>

      <note>
	<para>若任一個列在清單中的名稱伺服器不支援 <acronym>DNSSEC</acronym>，則本地的 <acronym>DNS</acronym> 解析便會失敗，請確認有測試每一台名稱伺服器並移除所有測試失敗的項目。以下指令會顯示出信認樹或在 <systemitem class="ipaddress">192.168.1.1</systemitem> 上執行失敗的名稱伺服器：</para>
      </note>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>drill -S FreeBSD.org @<replaceable>192.168.1.1</replaceable></userinput></screen>

      <para>確認完每一台名稱伺服器都支援 <acronym>DNSSEC</acronym> 後啟動 <application>Unbound</application>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service local_unbound onestart</userinput></screen>

      <para>這將會更新 <filename>/etc/resolv.conf</filename> 來讓查詢已用 <acronym>DNSSEC</acronym> 確保安全的網域現在可以運作，例如，執行以下指令來檢驗 FreeBSD.org <acronym>DNSSEC</acronym> 信任樹：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>drill -S FreeBSD.org</userinput>
;; Number of trusted keys: 1
;; Chasing: freebsd.org. A

DNSSEC Trust tree:
freebsd.org. (A)
|---freebsd.org. (DNSKEY keytag: 36786 alg: 8 flags: 256)
    |---freebsd.org. (DNSKEY keytag: 32659 alg: 8 flags: 257)
    |---freebsd.org. (DS keytag: 32659 digest type: 2)
        |---org. (DNSKEY keytag: 49587 alg: 7 flags: 256)
            |---org. (DNSKEY keytag: 9795 alg: 7 flags: 257)
            |---org. (DNSKEY keytag: 21366 alg: 7 flags: 257)
            |---org. (DS keytag: 21366 digest type: 1)
            |   |---. (DNSKEY keytag: 40926 alg: 8 flags: 256)
            |       |---. (DNSKEY keytag: 19036 alg: 8 flags: 257)
            |---org. (DS keytag: 21366 digest type: 2)
                |---. (DNSKEY keytag: 40926 alg: 8 flags: 256)
                    |---. (DNSKEY keytag: 19036 alg: 8 flags: 257)
;; Chase successful</screen>
    </sect2>
  </sect1>

  <sect1 xml:id="network-apache">
    <info>
      <title>Apache HTTP 伺服器</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Murray</firstname>
	    <surname>Stokely</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en"><primary>web servers</primary>
      <secondary>setting up</secondary></indexterm>
    <indexterm xml:lang="en"><primary>Apache</primary></indexterm>

    <para>開放源碼的 <application>Apache HTTP Server</application> 是目前最廣泛被使用的網頁伺服器，FreeBSD 預設並不會安裝這個網頁伺服器，但可從 <package>www/apache24</package> 套件或 Port 安裝。</para>

    <para>本節將會摘要如何設定並啟動在 FreeBSD 上 2.<replaceable>x</replaceable> 版的 <application>Apache HTTP Server</application>，要取得有關 <application>Apache</application> 更詳細的資訊及其設定項目請參考 <link xlink:href="http://httpd.apache.org/">httpd.apache.org</link>。</para>

    <sect2>
      <title>設定並啟動 Apache</title>

      <indexterm xml:lang="en"><primary>Apache</primary>
	<secondary>configuration file</secondary></indexterm>

      <para>在 FreeBSD 中，主 <application>Apache HTTP Server</application> 設定檔會安裝於 <filename>/usr/local/etc/apache2<replaceable>x</replaceable>/httpd.conf</filename>，其中 <replaceable>x</replaceable> 代表版號，這份 <acronym>ASCII</acronym> 文字檔中以 <literal>#</literal> 做為行首的是註解，而最常需修改的項目有：</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en"><literal>ServerRoot "/usr/local"</literal></term>

	  <listitem>
	    <para>指定該 <application>Apache</application> 的預設安裝路徑，Binary 檔會儲存在伺服器根目錄 (Server root) 下的 <filename>bin</filename> 與 <filename>sbin</filename> 子目錄，而設定檔會儲存在 <filename>etc/apache2<replaceable>x</replaceable></filename> 子目錄。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><literal>ServerAdmin you@example.com</literal></term>

	  <listitem>
	    <para>更改此項目為您要接收問題回報的電子郵件位址，這個位址也會顯示在一些伺服器產生的頁面上，如：錯誤頁面。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><literal>ServerName
	      www.example.com:80</literal></term>

	  <listitem>
	    <para>讓管理者可以設定伺服器要回傳給客戶端的主機名稱 (Hostname)，例如，<systemitem>www</systemitem> 可以更改為實際的主機名稱，若系統並未有註冊的 <acronym>DNS</acronym> 名稱，則可改輸入其 <acronym>IP</acronym> 位址，若伺服器需要傾聽其他埠號，可更改 <literal>80</literal> 為其他埠號。</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><literal>DocumentRoot
	    "/usr/local/www/apache2<replaceable>x</replaceable>/data"</literal></term>

	  <listitem>
	    <para>提供文件的目錄，預設所有的請求均會到此目錄，但可以使用符號連結與別名來指向其他地方。</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para>在對 <application>Apache</application> 設定檔做變更之前，建議先做備份，在 <application>Apache</application> 設定完成之後，儲存讓檔案並使用 <command>apachectl</command> 檢驗設定，執行 <command>apachectl configtest</command> 的結果應回傳 <literal>Syntax OK</literal>。</para>

      <indexterm xml:lang="en"><primary>Apache</primary>
	<secondary>starting or stopping</secondary></indexterm>

      <para>要在系統啟動時執行 <application>Apache</application>，可加入下行到 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">apache<replaceable>24</replaceable>_enable="YES"</programlisting>

      <para>若 <application>Apache</application> 要使用非預設的選項啟動，可加入下行到 <filename>/etc/rc.conf</filename> 來指定所需的旗標參數：</para>

      <programlisting xml:lang="en">apache<replaceable>24</replaceable>_flags=""</programlisting>

      <para>若 <application>apachectl</application> 未回報設定錯，則可啟動 <command>httpd</command>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service apache<replaceable>24</replaceable> start</userinput></screen>

      <para><command>httpd</command> 服務可以透過在網頁瀏覽器中輸入 <literal>http://<replaceable>localhost</replaceable></literal> 來測試，將 <replaceable>localhost</replaceable> 更改為執行 <command>httpd</command> 那台主機的完整網域名稱 (Fully-qualified domain name)。預設會顯示的網頁為 <filename>/usr/local/www/apache<replaceable>24</replaceable>/data/index.html</filename>。</para>

      <para>後續若有在 <command>httpd</command> 執行中時修改 <application>Apache</application> 設定檔可使用以下指令來測試是否有誤：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service apache<replaceable>24</replaceable> configtest</userinput></screen>

      <note>
	<para>注意，<literal>configtest</literal> 並非採用 <citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> 標準，不應預期其可在所有的啟動 Script 中正常運作。</para>
      </note>
    </sect2>

    <sect2>
      <title>虛擬主機</title>

      <para>虛擬主機允許在一個 <application>Apache</application> 伺服器執行多個網站，虛擬主機可以是以 IP 為主 (<firstterm>IP-based</firstterm>) 或以名稱為主 (<firstterm>name-based</firstterm>)。以 <acronym>IP</acronym> 為主的虛擬主機中的每一個網站要使用不同的 <acronym>IP</acronym> 位址。以名稱為主的虛擬主機會使用客戶端的 HTTP/1.1 標頭來判斷主機名稱，這可讓不同的網站共用相同的 <acronym>IP</acronym> 位址。</para>

      <para>要設定 <application>Apache</application> 使用以名稱為主的虛擬主機可在每一個網站加入 <literal>VirtualHost</literal> 區塊，例如，有一個名稱為 <systemitem class="fqdomainname">www.domain.tld</systemitem> 的主機擁有一個 <systemitem class="fqdomainname">www.someotherdomain.tld</systemitem> 的虛擬網域，可加入以下項目到 <filename>httpd.conf</filename>：</para>

      <programlisting xml:lang="en">&lt;VirtualHost *&gt;
    ServerName <replaceable>www.domain.tld</replaceable>
    DocumentRoot <replaceable>/www/domain.tld</replaceable>
&lt;/VirtualHost&gt;

&lt;VirtualHost *&gt;
    ServerName <replaceable>www.someotherdomain.tld</replaceable>
    DocumentRoot <replaceable>/www/someotherdomain.tld</replaceable>
&lt;/VirtualHost&gt;</programlisting>

      <para>每一個虛擬主機均需更改其 <literal>ServerName</literal> 與 <literal>DocumentRoot</literal> 的值為實際要使用的值。</para>

      <para>更多有關設定虛擬主機的資訊，可參考 <application>Apache</application> 官方說明文件於：<uri xlink:href="http://httpd.apache.org/docs/vhosts/">http://httpd.apache.org/docs/vhosts/</uri>。</para>
    </sect2>

    <sect2>
      <title>Apache 模組</title>

      <indexterm xml:lang="en"><primary>Apache</primary>
	<secondary>modules</secondary></indexterm>

      <para><application>Apache</application> 使用模組 (Module) 來擴充伺服器所提供的功能。請參考 <uri xlink:href="http://httpd.apache.org/docs/current/mod/">http://httpd.apache.org/docs/current/mod/</uri> 來取得可用模組的完整清單與設定詳細資訊。</para>

      <para>在 FreeBSD 中有些模組可以隨著 <package>www/apache24</package> Port 編譯，只要在 <filename>/usr/ports/www/apache24</filename> 輸入 <command>make config</command> 便可查看有那一些模組是預設開啟的，若模組未與 Port 一併編譯，FreeBSD Port 套件集也提供了一個簡單的方式可安裝各種模組，本節將介紹最常使用的三個模組。</para>

      <sect3>
	<title xml:lang="en"><filename>mod_ssl</filename></title>

	<indexterm xml:lang="en">
	  <primary>web servers</primary>
	  <secondary>secure</secondary>
	</indexterm>
	<indexterm xml:lang="en"><primary>SSL</primary></indexterm>
	<indexterm xml:lang="en"><primary>cryptography</primary></indexterm>

	<para><filename>mod_ssl</filename> 模組利用了 <application>OpenSSL</application> 透過 Secure Sockets Layer (<acronym>SSLv3</acronym>) 與 Transport Layer Security (<acronym>TLSv1</acronym>) 通訊協定來提供強大的加密，這個模組提供了向受信認的憑証簽署機構申請簽章憑証所需的任何東西，讓 FreeBSD 上能夠執行安全的網頁伺服器。</para>

	<para>在 FreeBSD 中 <filename>mod_ssl</filename> 模組預設在套件與 Port 均是開啟的，可用的設定項目在 <uri xlink:href="http://httpd.apache.org/docs/current/mod/mod_ssl.html">http://httpd.apache.org/docs/current/mod/mod_ssl.html</uri> 會說明。</para>
      </sect3>

      <sect3>
	<title xml:lang="en"><filename>mod_perl</filename></title>

	<indexterm xml:lang="en">
	  <primary>mod_perl</primary>
	  <secondary>Perl</secondary>
	</indexterm>

	<para><filename>mod_perl</filename> 模組讓您可以使用 <application>Perl</application> 撰寫 <application>Apache</application> 模組，除此之外，嵌入到伺服器的直譯器可避免啟動外部直譯器的額外開銷與 <application>Perl</application> 耗費的啟動時間。</para>

	<para><filename>mod_perl</filename> 可以使用 <package>www/mod_perl2</package> 套件或 Port 安裝，有關使用此模組的說明文件可在 <uri xlink:href="http://perl.apache.org/docs/2.0/index.html">http://perl.apache.org/docs/2.0/index.html</uri> 中找到。</para>
      </sect3>

      <sect3>
	<info>
	  <title xml:lang="en"><filename>mod_php</filename></title>

	  <authorgroup>
	    <author xml:lang="en">
	      <personname>
		<firstname>Tom</firstname>
		<surname>Rhodes</surname>
	      </personname>
	      <contrib>Written by </contrib>
	    </author>
	  </authorgroup>
	</info>

	<indexterm xml:lang="en">
	  <primary>mod_php</primary>
	  <secondary>PHP</secondary>
	</indexterm>

	<para><firstterm>PHP: Hypertext Preprocessor</firstterm> (<acronym>PHP</acronym>) 是一般用途的腳本 (Script) 語言，特別適用於網站開發，能夠嵌入在 <acronym>HTML</acronym> 當中，它的語法參考自 <application>C</application>, <trademark>Java</trademark> 及 <application>Perl</application>，目的在讓網頁開發人員能快速的寫出動態網頁。</para>

	<para>要在 <application>Apache</application> 網頁伺服器上加入對 <acronym>PHP</acronym>5 的支援，可安裝 <package>www/mod_php56</package> 套件或 Port，這會安裝並設定支援動態 <acronym>PHP</acronym> 應用程式所需的模組。安裝過程會自動加入下行到 <filename>/usr/local/etc/apache2<replaceable>4</replaceable>/httpd.conf</filename>：</para>

	<programlisting xml:lang="en">LoadModule php5_module        libexec/apache24/libphp5.so</programlisting>

<!--
I do not think this is still needed
AddModule mod_php5.c
    &lt;IfModule mod_php5.c&gt;
        DirectoryIndex index.php index.html
    &lt;/IfModule&gt;
    &lt;IfModule mod_php5.c&gt;
        AddType application/x-httpd-php .php
        AddType application/x-httpd-php-source .phps
    &lt;/IfModule&gt;</programlisting>

    -->

	<para>接著，執行 graceful 重新啟動來載入 <acronym>PHP</acronym> 模組：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>apachectl graceful</userinput></screen>

	<para>由 <package>www/mod_php56</package> 所提供的 <acronym>PHP</acronym> 支援是有限的，若需要額外的支援可以使用 <package>lang/php56-extensions</package> Port 來安裝，該 Port 提供了選單介面來選擇可用的 <acronym>PHP</acronym> 擴充套件。</para>

	<para>或者，可以找到適當的 Port 來安裝各別的擴充套件，例如，要增加 <acronym>PHP</acronym> 對 <application>MySQL</application> 資料庫伺服器的支援可安裝 <package>databases/php56-mysql</package>。</para>

	<para>在安裝完擴充套件之後，必須重新載入 <application>Apache</application> 伺服器來使用新的設定值：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>apachectl graceful</userinput></screen>
      </sect3>
    </sect2>

    <sect2>
      <title>動態網站</title>

      <indexterm xml:lang="en">
	<primary>web servers</primary>
	<secondary>dynamic</secondary>
      </indexterm>

      <para>除了 <application>mod_perl</application> 與 <application>mod_php</application> 外，也有其他語言可用來建立動態網頁內容，這包含了 <application>Django</application> 與 <application>Ruby on Rails</application>。</para>

      <sect3>
	<title xml:lang="en">Django</title>

	<indexterm xml:lang="en"><primary>Python</primary></indexterm>
	<indexterm xml:lang="en"><primary>Django</primary></indexterm>

	<para><application>Django</application> 是以 BSD 授權的框架 (Framework)，指在讓開發人員能快速的寫出高效、優雅的網頁應用程式。它提供了物件關聯對應器 (Object-relational mapper)，所以各種資料型態可當做 <application>Python</application> 的物件來開發，且提供了豐富的動態資料庫存取 <acronym>API</acronym> 給這些物件，讓開發人員不再需要寫 <acronym>SQL</acronym>。它也同時提供了可擴充的樣板系統，來讓應用程式的邏輯與 <acronym>HTML</acronym> 呈現能夠被拆開。</para>

	<para>Django 需要 <filename>mod_python</filename>，以及一個 <acronym>SQL</acronym> 資料庫引擎才能運作。在 FreeBSD 中的 <package>www/py-django</package> Port 會自動安裝 <filename>mod_python</filename> 以及對 <application>PostgreSQL</application>, <application>MySQL</application> 或 <application>SQLite</application> 資料庫的支援，預設為 <application>SQLite</application>，要更改資料庫引擎可在 <filename>/usr/ports/www/py-django</filename> 輸入 <command>make config</command> 然後再安裝該 Port。</para>

	<para><application>Django</application> 安裝完成之後，應用程式會需要一個專案目錄並搭配 <application>Apache</application> 設定才能使用內嵌的 <application>Python</application> 直譯器，此直譯器會用來呼叫網站上指定 <acronym>URL</acronym> 的應用程式。</para>

	<para>要設定 <application>Apache</application> 傳遞某個 <acronym>URL</acronym> 請求到網站應用程式，可加入下行到 <filename>httpd.conf</filename> 來指定專案目錄的完整路徑：</para>

	<programlisting xml:lang="en">&lt;Location "/"&gt;
    SetHandler python-program
    PythonPath "['<replaceable>/dir/to/the/django/packages/</replaceable>'] + sys.path"
    PythonHandler django.core.handlers.modpython
    SetEnv DJANGO_SETTINGS_MODULE mysite.settings
    PythonAutoReload On
    PythonDebug On
&lt;/Location&gt;</programlisting>

	<para>請參考 <uri xlink:href="https://docs.djangoproject.com">https://docs.djangoproject.com</uri> 來取得如何使用 <application>Django</application> 的更多資訊。</para>
      </sect3>

      <sect3>
	<title xml:lang="en">Ruby on Rails</title>

	<indexterm xml:lang="en"><primary>Ruby on Rails</primary></indexterm>

	<para><application>Ruby on Rails</application> 是另外一套開放源碼的網站框架 (Framework)，提供了完整的開發堆疊，這使得網頁開發人員可以更有生產力且能夠快速的寫出強大的應用程式，在 FreeBSD 它可以使用 <package>www/rubygem-rails</package> 套件或 Port 安裝。</para>

	<para>請參考 <uri xlink:href="http://guides.rubyonrails.org">http://guides.rubyonrails.org</uri> 來取得更多有關如何使用 <application>Ruby on Rails</application> 的資訊。</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 xml:id="network-ftp">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Murray</firstname>
	  <surname>Stokely</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>檔案傳輸協定 (<acronym>FTP</acronym>)</title>

    <indexterm xml:lang="en"><primary><acronym>FTP</acronym>
	servers</primary></indexterm>

    <para>檔案傳輸協定 (File Transfer Protocol, <acronym>FTP</acronym>) 提供了使用一個簡單的方式能夠將檔案傳輸到與接收自 <acronym>FTP</acronym> 伺服器，FreeBSD 內建了 <acronym>FTP</acronym> 伺服器軟體 <application>ftpd</application> 在基礎系統 (Base system) 中。</para>

    <para>FreeBSD 提供了多個設定檔來控制對 <acronym>FTP</acronym> 伺服器的存取，本節將摘要這些檔案的設定方式，請參考 <citerefentry><refentrytitle>ftpd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來取得更多有關內建 <acronym>FTP</acronym> 伺服器的詳細資訊。</para>

    <sect2>
      <title>設定</title>

      <para>最重要的一個設定步驟便是決定那些帳號能夠存取 <acronym>FTP</acronym> 伺服器，FreeBSD 系統有數個系統帳號，這些帳號不應該能夠擁有 <acronym>FTP</acronym> 存取權，不允許存取 <acronym>FTP</acronym> 的使用者清單可在 <filename>/etc/ftpusers</filename> 找到，預設該檔案內會有所有的系統帳號，其他不應允許存取 <acronym>FTP</acronym> 的使用者也可在此加入。</para>

      <para>在某些情況可能會布望限制某些使用者的存取，而不是完全避免這些使用者使用 <acronym>FTP</acronym>，這可以透過建立 <filename>/etc/ftpchroot</filename> 來完成，詳如 <citerefentry><refentrytitle>ftpchroot</refentrytitle><manvolnum>5</manvolnum></citerefentry> 所述，這個檔案會列出受到 <acronym>FTP</acronym> 存取限制的使用者與群組。</para>

      <indexterm xml:lang="en">
	<primary><acronym>FTP</acronym></primary>
	<secondary>anonymous</secondary>
      </indexterm>

      <para>要在伺服器上開啟匿名 <acronym>FTP</acronym> 存取權，可在 FreeBSD 系統上建立一個名稱為 <systemitem class="username">ftp</systemitem> 使用者，使用者將能夠使用 <systemitem class="username">ftp</systemitem> 或 <systemitem class="username">anonymous</systemitem> 使用者名稱來登入 <acronym>FTP</acronym> 伺服器，當提示輸入密碼時，輸入任何值都會被接受，但是慣例上應使用電子郵件位址來當做密碼。當匿名使用者登入時 <acronym>FTP</acronym> 伺服器會呼叫 <citerefentry><refentrytitle>chroot</refentrytitle><manvolnum>2</manvolnum></citerefentry> 來限制使用者只能存取 <systemitem class="username">ftp</systemitem> 使用者的家目錄。</para>

      <para>要設定顯示給 <acronym>FTP</acronym> 客戶端的歡迎訊息有兩個文字檔可以建立，<filename>/etc/ftpwelcome</filename> 的內容會在收到登入提示前顯示給使用者看，登入成功能後，則會顯示 <filename>/etc/ftpmotd</filename> 的內容。注意，這個檔案的路徑是相對於登入環境的，所以 <filename>~ftp/etc/ftpmotd</filename> 的內容只會對匿名使用者顯示。</para>

      <para>設定完 <acronym>FTP</acronym> 伺服器之後，在 <filename>/etc/rc.conf</filename> 設定適當的變數來在開機時啟動該服務：</para>

      <programlisting xml:lang="en">ftpd_enable="YES"</programlisting>

      <para>要立即啟動服務可：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service ftpd start</userinput></screen>

      <para>要測試到 <acronym>FTP</acronym> 伺服器的連線可輸入：</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>ftp localhost</userinput></screen>

      <indexterm xml:lang="en"><primary>syslog</primary></indexterm>
      <indexterm xml:lang="en"><primary>log files</primary>
	<secondary><acronym>FTP</acronym></secondary></indexterm>

      <para><application>ftpd</application> daemon 會使用 <citerefentry><refentrytitle>syslog</refentrytitle><manvolnum>3</manvolnum></citerefentry> 來記錄訊息，預設，系統記錄 Daemon 會寫入有關 <acronym>FTP</acronym> 的訊息到 <filename>/var/log/xferlog</filename>，<acronym>FTP</acronym> 記錄的位置可以透過更改 <filename>/etc/syslog.conf</filename> 中下行來做修改：</para>

      <programlisting xml:lang="en">ftp.info      /var/log/xferlog</programlisting>

      <indexterm xml:lang="en">
	<primary><acronym>FTP</acronym></primary>
	<secondary>anonymous</secondary>
      </indexterm>

      <note>
	<para>要注意啟動匿名 <acronym>FTP</acronym> 伺服器可能的潛藏問題，尤其是要讓匿名使用者上傳檔案時要再次確認，因為這可能讓該 <acronym>FTP</acronym> 站變成用來交換未授權商業軟體的交流平台或者更糟的狀況。若真的需要匿名 <acronym>FTP</acronym> 上傳，那麼請檢查權限設定，讓這些檔案在尚未被管理者審查前不能夠被其他匿名使用者讀取。</para>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="network-samba">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Murray</firstname>
	  <surname>Stokely</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title><trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 用戶端檔案與列印服務 (Samba)</title>

    <indexterm xml:lang="en"><primary>Samba server</primary></indexterm>
    <indexterm xml:lang="en"><primary>Microsoft Windows</primary></indexterm>
    <indexterm xml:lang="en">
      <primary>file server</primary>
      <secondary>Windows clients</secondary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>print server</primary>
      <secondary>Windows clients</secondary>
    </indexterm>

    <para><application>Samba</application> 是熱門的開放源碼軟體套件，使用 <acronym>SMB/CIFS</acronym> 通訊協定提供檔案與列印服務，此通訊協定內建於 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 系統，在非 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 的系統可透過安裝 <application>Samba</application> 客戶端程式庫來支援此協定。此通訊協定讓客戶端可以存取共享的資料與印表機，這些共享的資源可掛載到一個本機的磁碟機，而共享的印表機則可以當做本機的印表機使用。</para>

    <para>在 FreeBSD 上，可以使用 <package>net/samba48</package> Port 或套件來安裝 <application>Samba</application> 客戶端程式庫，這個客戶端提供了讓 FreeBSD 系統能存取 <acronym>SMB/CIFS</acronym> 在 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 網路中共享的資源。</para>

    <para>FreeBSD 系統也可以透過安裝 <package>net/samba48</package> Port 或套件來設定成 <application>Samba</application> 伺服器，這讓管理者可以在 FreeBSD 系統上建立 <acronym>SMB</acronym>/<acronym>CIFS</acronym> 的共享資源，讓執行 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 或 <application>Samba</application> 客戶端程式庫的客戶端能夠存取。</para>

    <sect2>
      <title>伺服器設定</title>

      <para><application>Samba</application> 的設定位於 <filename>/usr/local/etc/smb4.conf</filename>，必須先設定這個檔案才可使用 <application>Samba</application>。</para>

      <para>要共享目錄與印表機給在工作群組中的 <trademark class="registered">Windows</trademark> 客戶端的簡易 <filename>smb4.conf</filename> 範例如下。對於涉及 LDAP 或 Active Directory 的複雜安裝，可使用 <citerefentry><refentrytitle>samba-tool</refentrytitle><manvolnum>8</manvolnum></citerefentry> 來建立初始的 <filename>smb4.conf</filename>。</para>

      <programlisting xml:lang="en">[global]
workgroup = WORKGROUP
server string = Samba Server Version %v
netbios name = ExampleMachine
wins support = Yes
security = user
passdb backend = tdbsam

# Example: share /usr/src accessible only to 'developer' user
[src]
path = /usr/src
valid users = developer
writable  = yes
browsable = yes
read only = no
guest ok = no
public = no
create mask = 0666
directory mask = 0755</programlisting>

      <sect3>
	<title>全域設定</title>

	<para>在 <filename>/usr/local/etc/smb4.conf</filename> 中加入用來描述網路環境的設定有：</para>

	<variablelist>
	  <varlistentry>
	    <term xml:lang="en"><literal>workgroup</literal></term>

	    <listitem>
	      <para>要提供的工作群組名稱。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term xml:lang="en"><literal>netbios name</literal></term>

	    <listitem>
	      <para><application>Samba</application> 伺服器已知的 NetBIOS 名稱，預設為主機的 <acronym>DNS</acronym> 名稱第一節。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term xml:lang="en"><literal>server string</literal></term>

	    <listitem>
	      <para>會顯示於 <command>net view</command> 輸出結果以及其他會尋找伺服器描述文字並顯示的網路工具的文字。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term xml:lang="en"><literal>wins support</literal></term>

	    <listitem>
	      <para>不論 <application>Samba</application> 是否要作為 <acronym>WINS</acronym> 伺服器，請不要在網路上開啟超過一台伺服器的 <acronym>WINS</acronym> 功能。</para>
	    </listitem>
	  </varlistentry>
	</variablelist>
      </sect3>

      <sect3>
	<title>安全性設定</title>

	<para>在 <filename>/usr/local/etc/smb4.conf</filename> 中最重要的設定便是安全性模式以及後端密碼格式，以下項目管控的選項有：</para>

	<variablelist>
	  <varlistentry>
	    <term xml:lang="en"><literal>security</literal></term>

	    <listitem>
	      <para>最常見的設定為 <literal>security = share</literal> 以及 <literal>security = user</literal>，若客戶端使用的使用者名稱與在 FreeBSD 主機上使用的使用者名稱相同，則應該使用使用者 (user) 層級的安全性，這是預設的安全性原則且它會要求客戶端在存取共享資源前先登入。</para>

	      <para>安全性為共享 (share) 層級時，客戶端存取共享資源不需要先使用有效的使用者名稱與密碼登入伺服器，在是在舊版 <application>Samba</application> 所採用的預設安全性模式。</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry>
	    <term xml:lang="en"><literal>passdb backend</literal></term>

	    <listitem>
	      <indexterm xml:lang="en"><primary>NIS+</primary></indexterm>
	      <indexterm xml:lang="en"><primary>LDAP</primary></indexterm>
	      <indexterm xml:lang="en"><primary>SQL database</primary></indexterm>

	      <para><application>Samba</application> 支援數種不同的後端認証模式，客戶端可以使用 LDAP, NIS+, SQL 資料庫或修改過的密碼檔來認証，建議的認証方式是 <literal>tdbsam</literal>，適用於簡易的網路環境且在此處說明，對於較大或更複雜的網路則較建議使用 <literal>ldapsam</literal>，而 <literal>smbpasswd</literal> 是舊版的預設值，現在已廢棄不使用。</para>
	    </listitem>
	  </varlistentry>
	</variablelist>

      </sect3>

      <sect3>
	<title><application>Samba</application> 使用者</title>

	<para>FreeBSD 使用者帳號必須對應 <literal>SambaSAMAccount</literal> 資料庫， 才能讓 <trademark class="registered">Windows</trademark> 客戶端存取共享資源，要對應既有的 FreeBSD 使用者帳號可使用 <citerefentry><refentrytitle>pdbedit</refentrytitle><manvolnum>8</manvolnum></citerefentry>：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pdbedit -a <replaceable>username</replaceable></userinput></screen>

	<para>本節只會提到一些最常用的設定，請參考 <link xlink:href="http://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/">官方 Samba HOWTO</link> 來取得有關可用設定選項的額外資訊。</para>
      </sect3>
    </sect2>

    <sect2>
      <title>啟動 <application>Samba</application></title>

      <para>要在開機時啟動 <application>Samba</application>，可加入下行到 <filename>/etc/rc.conf</filename>：</para>

      <programlisting xml:lang="en">samba_server_enable="YES"</programlisting>

      <para>要立即啟動 <application>Samba</application>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service samba_server start</userinput>
Performing sanity check on Samba configuration: OK
Starting nmbd.
Starting smbd.</screen>

      <para><application>Samba</application> 由三個獨立的 Daemon 所組成，<application>nmbd</application> 與 <application>smbd</application> daemon 可透過 <varname>samba_enable</varname> 來啟動，若同時也需要 winbind 名稱解析服務則需額外設定：</para>

	<programlisting xml:lang="en">winbindd_enable="YES"</programlisting>

      <para><application>Samba</application> 可以隨時停止，要停止可輸入：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service samba_server stop</userinput></screen>

      <para><application>Samba</application> 是一套擁有能整合 <trademark class="registered">Microsoft</trademark> <trademark class="registered">Windows</trademark> 網路功能的複雜軟體套件，除了在此處說明的基礎設定，要取得更多的功能資訊，請參考 <uri xlink:href="http://www.samba.org">http://www.samba.org</uri>。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="network-ntp">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Hukins</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </sect1info>
    -->
    <title>NTP 時間校對</title>

    <indexterm xml:lang="en"><primary>NTP</primary>
      <secondary>ntpd</secondary>
    </indexterm>

    <para>隨著使用時間，電腦的時鐘會逐漸偏移，這對需要網路上電腦有相同準確度時間的許多網路服務來說是一個大問題。準確的時間同樣能確保檔案時間戳記的一致性。網路時間協定 (Network Time Protocol, <acronym>NTP</acronym>) 是一種在網路上可以確保時間準確的方式。</para>

    <para>FreeBSD 內含 <citerefentry><refentrytitle>ntpd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 可設定來查詢其他 <acronym>NTP</acronym> 伺服器來同步電腦的時間或提供時間服務給其他在網路上的電腦。</para>

    <para>本節將會介紹如何設定 FreeBSD 上的 <application>ntpd</application>，更進一步的說明文件可於 <filename>/usr/share/doc/ntp/</filename> 找到 HTML 格式的版本。</para>

    <sect2>
      <title><acronym>NTP</acronym> 設定</title>

      <indexterm><primary>NTP</primary></indexterm>

      <para>在 FreeBSD，內建的 <application>ntpd</application> 可用來同步系統的時間，<application>Ntpd</application> 要使用 <citerefentry><refentrytitle>rc.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 中的變數以及下一節會詳細說明的 <filename>/etc/ntp.conf</filename> 來設定。</para>

      <para><application>Ntpd</application> 與網路中各節點的通訊採用 UDP 封包，在伺服器與 NTP 各節點間的防火牆必須設定成可允許進/出埠 123 的 UDP 封包。</para>

      <sect3>
	<title><filename>/etc/ntp.conf</filename> 檔</title>

	<indexterm xml:lang="en"><primary>NTP</primary>
	  <secondary>ntp.conf</secondary>
	</indexterm>

	<para><application>Ntpd</application> 會讀取 <filename>/etc/ntp.conf</filename> 來得知要從那些 <acronym>NTP</acronym> 伺服器查詢時間，建議可設定多個 <acronym>NTP</acronym> 伺服器，來避免萬一其中一個伺服器無法連線或是時間不可靠的問題，當 <application>ntpd</application> 收到回應，它會偏好先採用較可信賴的伺服器。查詢的伺服器可以是來自本地網路的 <acronym>ISP</acronym> 所提供，也可從<link xlink:href="http://support.ntp.org/bin/view/Servers/WebHome">線上可公開存取的<acronym>NTP</acronym> 伺服器清單</link>中挑選，您可以選擇一個離您地理位置較近的伺服器並閱讀它的使用規則。也有 <link xlink:href="http://support.ntp.org/bin/view/Servers/NTPPoolServers">可公開存取的 <acronym>NTP</acronym> 池線上清單</link>可用，由一個地理區域所組織，除此之外 FreeBSD 提供了計劃贊助的伺服器池，<literal>0.freebsd.pool.ntp.org</literal>。</para>

	<example>
	  <title><filename>/etc/ntp.conf</filename> 範例</title>
	  <para>這份簡單的 <filename>ntp.conf</filename> 範例檔可以放心的使用，其中包含了建議的 <literal>restrict</literal> 選項可避免伺服器被公開存取。</para>
	  <programlisting xml:lang="en">
# Disallow ntpq control/query access.  Allow peers to be added only
# based on pool and server statements in this file.
restrict default limited kod nomodify notrap noquery nopeer
restrict source  limited kod nomodify notrap noquery

# Allow unrestricted access from localhost for queries and control.
restrict 127.0.0.1
restrict ::1

# Add a specific server.
server ntplocal.example.com iburst

# Add FreeBSD pool servers until 3-6 good servers are available.
tos minclock 3 maxclock 6
pool 0.freebsd.pool.ntp.org iburst

# Use a local leap-seconds file.
leapfile "/var/db/ntpd.leap-seconds.list"</programlisting></example>

	<para>這個檔案的格式在 <citerefentry><refentrytitle>ntp.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 有詳細說明，以下的說明僅快速的帶過以上範例檔有用到的一些關鍵字。</para>

	<para>預設 <acronym>NTP</acronym> 伺服器是可以被任何網路主機所存取，<literal>restrict</literal> 關鍵字可以控制有那些系統可以存取伺服器。<literal>restrict</literal> 支援設定多項，每一項可再更進一步調整前面所做的設定。範例中的設定授權本地系統有完整的查詢及控制權限，而遠端系統只有查詢時間的權限。要了解更詳細的資訊請參考 <citerefentry><refentrytitle>ntp.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> 中的 <literal>Access Control Support</literal> 一節。</para>

	<para><literal>server</literal> 關鍵字可指定要查詢的伺服器，設定檔中可以使用多個 server 關鍵字，一個伺服器列一行。<literal>pool</literal> 關鍵字可指定伺服器池，<application>Ntpd</application> 會加入該伺服器池中的一或多台伺服器，直到數量滿足 <literal>tos minclock</literal> 的設定。<literal>iburst</literal> 關鍵字會指示 <application>ntpd</application> 在建立連線時執行 8 連發快速封包交換，可以更快的同步系統時間。</para>

	<para><literal>leapfile</literal> 關鍵字用來指定含有閏秒 (Leap second) 資訊的檔案位置，該檔案是由 <citerefentry><refentrytitle>periodic</refentrytitle><manvolnum>8</manvolnum></citerefentry> 自動更新。這個關鍵字指定的檔案位置必須與 <filename>/etc/rc.conf</filename> 中設定的 <literal>ntp_db_leapfile</literal> 相同。</para>
      </sect3>

      <sect3>
	<title>在 <filename>/etc/rc.conf</filename> 中的 NTP 設定項目</title>

	<indexterm><primary>NTP</primary> <secondary>rc.conf</secondary></indexterm>

	<para>設定 <literal>ntpd_enable="YES"</literal> 可讓開機時會啟動 <application>ntpd</application>。將 <literal>ntpd_enable=YES</literal> 加到 <filename>/etc/rc.conf</filename> 之後，可輸入以下指令讓 <application>ntpd</application> 不需重新開機立即啟動：</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service ntpd start</userinput></screen>

	<para>要使用 ntpd 必須設定 <literal>ntpd_enable</literal>，以下所列的 <filename>rc.conf</filename> 變數可視所需請況設定。</para>

	<para>設定 <literal>ntpd_sync_on_start=YES</literal> 可讓 <application>ntpd</application> 可以在系統啟動時一次同步任何差距的時間，正常情況若時鐘的差距超過 1000 秒便會記錄錯誤並且中止。這個設定項目在沒有電池備援的時鐘上特別有用。</para>

	<para>設定 <literal>ntpd_oomprotect=YES</literal> 可保護 <application>ntpd</application> daemon 被系統中止並嘗試從記憶體不足 (Out Of Memory, <acronym>OOM</acronym>) 的情況恢復運作。</para>

        <para>設定 <literal>ntpd_config=</literal> 可更改 <filename>ntp.conf</filename> 檔案的位置。</para>

	<para>設定 <literal>ntpd_flags=</literal> 可設定使用任何其他所需 <application>ntpd</application> 參數，但要避免使用由 <filename>/etc/rc.d/ntpd</filename> 內部控管的參數如下：<itemizedlist spacing="compact">
	    <listitem><para><literal>-p</literal> (pid 檔案位置)</para></listitem>
	    <listitem><para><literal>-c</literal> (改用<literal>ntpd_config=</literal> 設定)</para></listitem>
	  </itemizedlist></para>
      </sect3>

      <sect3>
	<title>使用無特權的 <literal>ntpd</literal> 使用者執行 <application>Ntpd</application></title>

	<para>在 FreeBSD 上的 <application>Ntpd</application> 現在可以使用無特權的使用者啟動並執行，要達到這個功能需要 <citerefentry><refentrytitle>mac_ntpd</refentrytitle><manvolnum>4</manvolnum></citerefentry> 規則模組。<filename>/etc/rc.d/ntpd</filename> 啟動 Script 會先檢查 NTP 的設定，若可以的話它會載入 <literal>mac_ntpd</literal> 模組，然後以無特權的使用者 <literal>ntpd</literal> (user id 123) 來啟動 <application>ntpd</application>。為了避免檔案與目錄存取權限的問題，當設定中有任何檔案相關的選項時，啟動 Script 不會自動以 <literal>ntpd</literal> 身份啟動 <application>ntpd</application>。</para>

	<para>在 <literal>ntpd_flags</literal> 若出現以下任何參數則需要以最下面的方式手動設定才能以 <literal>ntpd</literal> 使用者的身份執行：<itemizedlist spacing="compact">
	    <listitem><para>-f 或 --driftfile</para></listitem>
	    <listitem><para>-i 或 --jaildir</para></listitem>
	    <listitem><para>-k 或 --keyfile</para></listitem>
	    <listitem><para>-l 或 --logfile</para></listitem>
	    <listitem><para>-s 或 --statsdir</para></listitem>
	  </itemizedlist></para>

	<para>在 <filename>ntp.conf</filename> 若出現以下任何關鍵字則需要以最下面的方式手動設定才能以 <literal>ntpd</literal> 使用者的身份執行：<itemizedlist spacing="compact">
	    <listitem><para>crypto</para></listitem>
	    <listitem><para>driftfile</para></listitem>
	    <listitem><para>key</para></listitem>
	    <listitem><para>logdir</para></listitem>
	    <listitem><para>statsdir</para></listitem>
	    </itemizedlist></para>

	<para>要手動設定以使用者 <literal>ntpd</literal> 身份執行 <application>ntpd</application> 你必須：<itemizedlist mark="none" spacing="compact">
	    <listitem><para>確保 <literal>ntpd</literal> 使用者有權限存取所有在設定檔中指定的檔案與目錄。</para></listitem>
	    <listitem><para>讓 <literal>mac_ntpd</literal> 模組載入或編譯至核心，請參考 <citerefentry><refentrytitle>mac_ntpd</refentrytitle><manvolnum>4</manvolnum></citerefentry> 取得詳細資訊。</para></listitem>
	    <listitem><para>在 <filename>/etc/rc.conf</filename> 中設定 <literal>ntpd_user="ntpd"</literal></para></listitem>
	  </itemizedlist></para>
      </sect3>
    </sect2>

    <sect2>
      <title>在 <acronym>PPP</acronym> 連線使用 <acronym>NTP</acronym></title>

      <para><application>ntpd</application> 並不需要永久的網際網路連線才能正常運作，若有一個 <acronym>PPP</acronym> 連線是設定成需要時撥號，那麼便需要避免 <acronym>NTP</acronym> 的流量觸發撥號或是保持連線不中斷，這可在 <filename>/etc/ppp/ppp.conf</filename> 使用 <literal>filter</literal> 項目設定，例如：</para>

      <programlisting xml:lang="en">set filter dial 0 deny udp src eq 123
# Prevent NTP traffic from initiating dial out
set filter dial 1 permit 0 0
set filter alive 0 deny udp src eq 123
# Prevent incoming NTP traffic from keeping the connection open
set filter alive 1 deny udp dst eq 123
# Prevent outgoing NTP traffic from keeping the connection open
set filter alive 2 permit 0/0 0/0</programlisting>

      <para>要取得更詳細的資訊，請參考於 <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry> 的 <literal>PACKET FILTERING</literal> 小節以及在 <filename>/usr/share/examples/ppp/</filename> 中的範例。</para>

      <note>
	<para>部份網際網路存取提供商會封鎖較小編號的埠，這會讓 NTP 無法運作，因為回應永遠無到傳送到該主機。</para>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="network-iscsi">
    <!--
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Edward Tomasz</firstname>
	  <surname>Napierala</surname>
	</author>
      </authorgroup>
    </sect1info>
          -->

    <title><acronym>iSCSI</acronym> Initiator 與 Target 設定</title>

    <para xml:lang="en"><acronym>iSCSI</acronym> is a way to share storage over a
      network.  Unlike <acronym>NFS</acronym>, which works at the file
      system level, <acronym>iSCSI</acronym> works at the block device
      level.</para>

    <para xml:lang="en">In <acronym>iSCSI</acronym> terminology, the system that
      shares the storage is known as the <emphasis>target</emphasis>.
      The storage can be a physical disk, or an area representing
      multiple disks or a portion of a physical disk.  For example, if
      the disk(s) are formatted with <acronym>ZFS</acronym>, a zvol
      can be created to use as the <acronym>iSCSI</acronym>
      storage.</para>

    <para xml:lang="en">The clients which access the <acronym>iSCSI</acronym>
      storage are called <emphasis>initiators</emphasis>.  To
      initiators, the storage available through
      <acronym>iSCSI</acronym> appears as a raw, unformatted disk
      known as a <acronym>LUN</acronym>.  Device nodes for the disk
      appear in <filename>/dev/</filename> and the device must be
      separately formatted and mounted.</para>

    <para xml:lang="en">FreeBSD provides a native,
      kernel-based <acronym>iSCSI</acronym> target and initiator.
      This section describes how to configure a FreeBSD system as a
      target or an initiator.</para>

    <sect2 xml:id="network-iscsi-target">
      <title>設定 <acronym>iSCSI</acronym> Target</title>

      <para xml:lang="en">To configure an <acronym>iSCSI</acronym> target, create
	the <filename>/etc/ctl.conf</filename> configuration file, add
	a line to <filename>/etc/rc.conf</filename> to make sure the
	<citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon is automatically started at boot, and then
	start the daemon.</para>

      <para xml:lang="en">The following is an example of a simple
	<filename>/etc/ctl.conf</filename> configuration file.  Refer
	to <citerefentry><refentrytitle>ctl.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for a more complete description of this
	file's available options.</para>

      <programlisting xml:lang="en">portal-group pg0 {
	discovery-auth-group no-authentication
	listen 0.0.0.0
	listen [::]
}

target iqn.2012-06.com.example:target0 {
	auth-group no-authentication
	portal-group pg0

	lun 0 {
		path /data/target0-0
		size 4G
	}
}</programlisting>

      <para xml:lang="en">The first entry defines the <literal>pg0</literal> portal
	group.  Portal groups define which network addresses the
	<citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon will listen on.  The
	<literal>discovery-auth-group no-authentication</literal>
	entry indicates that any initiator is allowed to perform
	<acronym>iSCSI</acronym> target discovery without
	authentication.  Lines three and four configure <citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	to listen on all <acronym>IPv4</acronym>
	(<literal>listen 0.0.0.0</literal>) and
	<acronym>IPv6</acronym> (<literal>listen [::]</literal>)
	addresses on the default port of 3260.</para>

      <para xml:lang="en">It is not necessary to define a portal group as there is a
	built-in portal group called <literal>default</literal>.  In
	this case, the difference between <literal>default</literal>
	and <literal>pg0</literal> is that with
	<literal>default</literal>, target discovery is always denied,
	while with <literal>pg0</literal>, it is always
	allowed.</para>

      <para xml:lang="en">The second entry defines a single target.  Target has two
	possible meanings: a machine serving <acronym>iSCSI</acronym>
	or a named group of <acronym>LUNs</acronym>.  This example
	uses the latter meaning, where
	<literal>iqn.2012-06.com.example:target0</literal> is the
	target name.  This target name is suitable for testing
	purposes.  For actual use, change
	<literal>com.example</literal> to the real domain name,
	reversed.  The <literal>2012-06</literal> represents the year
	and month of acquiring control of that domain name, and
	<literal>target0</literal> can be any value.  Any number of
	targets can be defined in this configuration file.</para>

      <para xml:lang="en">The <literal>auth-group no-authentication</literal> line
	allows all initiators to connect to the specified target and
	<literal>portal-group pg0</literal> makes the target reachable
	through the <literal>pg0</literal> portal group.</para>

      <para xml:lang="en">The next section defines the <acronym>LUN</acronym>.  To
	the initiator, each <acronym>LUN</acronym> will be visible as
	a separate disk device.  Multiple <acronym>LUNs</acronym> can
	be defined for each target.  Each <acronym>LUN</acronym> is
	identified by a number, where <acronym>LUN</acronym> 0 is
	mandatory.  The <literal>path /data/target0-0</literal> line
	defines the full path to a file or zvol backing the
	<acronym>LUN</acronym>.  That path must exist before starting
	<citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  The second line is optional and specifies the
	size of the <acronym>LUN</acronym>.</para>

      <para xml:lang="en">Next, to make sure the <citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon is started at
	boot, add this line to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">ctld_enable="YES"</programlisting>

      <para xml:lang="en">To start <citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> now, run this command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service ctld start</userinput></screen>

      <para xml:lang="en">As the <citerefentry><refentrytitle>ctld</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon is started, it reads
	<filename>/etc/ctl.conf</filename>.  If this file is edited
	after the daemon starts, use this command so that the changes
	take effect immediately:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service ctld reload</userinput></screen>

      <sect3>
	<title>認證</title>

	<para xml:lang="en">The previous example is inherently insecure as it uses
	  no authentication, granting anyone full access to all
	  targets.  To require a username and password to access
	  targets, modify the configuration as follows:</para>

	<programlisting xml:lang="en">auth-group ag0 {
	chap username1 secretsecret
	chap username2 anothersecret
}

portal-group pg0 {
	discovery-auth-group no-authentication
	listen 0.0.0.0
	listen [::]
}

target iqn.2012-06.com.example:target0 {
	auth-group ag0
	portal-group pg0
	lun 0 {
		path /data/target0-0
		size 4G
	}
}</programlisting>

	<para xml:lang="en">The <literal>auth-group</literal> section defines
	  username and password pairs.  An initiator trying to connect
	  to <literal>iqn.2012-06.com.example:target0</literal> must
	  first specify a defined username and secret.  However,
	  target discovery is still permitted without authentication.
	  To require target discovery authentication, set
	  <literal>discovery-auth-group</literal> to a defined
	  <literal>auth-group</literal> name instead of
	  <literal>no-authentication</literal>.</para>

	<para xml:lang="en">It is common to define a single exported target for
	  every initiator.  As a shorthand for the syntax above, the
	  username and password can be specified directly in the
	  target entry:</para>

	<programlisting xml:lang="en">target iqn.2012-06.com.example:target0 {
	portal-group pg0
	chap username1 secretsecret

	lun 0 {
		path /data/target0-0
		size 4G
	}
}</programlisting>
      </sect3>
    </sect2>

    <sect2 xml:id="network-iscsi-initiator">
      <title>設定 <acronym>iSCSI</acronym> Initiator</title>

      <note>
	<para xml:lang="en">The <acronym>iSCSI</acronym> initiator described in this
	  section is supported starting with FreeBSD 10.0-RELEASE.  To
	  use the <acronym>iSCSI</acronym> initiator available in
	  older versions, refer to <citerefentry><refentrytitle>iscontrol</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
      </note>

      <para xml:lang="en">The <acronym>iSCSI</acronym> initiator requires that the
	<citerefentry><refentrytitle>iscsid</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon is running.  This daemon does not use a
	configuration file.  To start it automatically at boot, add
	this line to <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">iscsid_enable="YES"</programlisting>

      <para xml:lang="en">To start <citerefentry><refentrytitle>iscsid</refentrytitle><manvolnum>8</manvolnum></citerefentry> now, run this command:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service iscsid start</userinput></screen>

      <para xml:lang="en">Connecting to a target can be done with or without an
	<filename>/etc/iscsi.conf</filename> configuration file.  This
	section demonstrates both types of connections.</para>

      <sect3>
	<title>不使用設定檔連線到 Target</title>

	<para xml:lang="en">To connect an initiator to a single target, specify the
	  <acronym>IP</acronym> address of the portal and the name of
	  the target:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>iscsictl -A -p <replaceable>10.10.10.10</replaceable> -t <replaceable>iqn.2012-06.com.example:target0</replaceable></userinput></screen>

	<para xml:lang="en">To verify if the connection succeeded, run
	  <command>iscsictl</command> without any arguments.  The
	  output should look similar to this:</para>

	<programlisting xml:lang="en">Target name                                     Target portal   State
iqn.2012-06.com.example:target0                 10.10.10.10     Connected: da0</programlisting>

	<para xml:lang="en">In this example, the <acronym>iSCSI</acronym> session
	  was successfully established, with
	  <filename>/dev/da0</filename> representing the attached
	  <acronym>LUN</acronym>.  If the
	  <literal>iqn.2012-06.com.example:target0</literal> target
	  exports more than one <acronym>LUN</acronym>, multiple
	  device nodes will be shown in that section of the
	  output:</para>

	<screen xml:lang="en">Connected: da0 da1 da2.</screen>

	<para xml:lang="en">Any errors will be reported in the output, as well as
	  the system logs.  For example, this message usually means
	  that the <citerefentry><refentrytitle>iscsid</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon is not running:</para>

	<programlisting xml:lang="en">Target name                                     Target portal   State
iqn.2012-06.com.example:target0                 10.10.10.10     Waiting for iscsid(8)</programlisting>

	<para xml:lang="en">The following message suggests a networking problem,
	  such as a wrong <acronym>IP</acronym> address or
	  port:</para>

	<programlisting xml:lang="en">Target name                                     Target portal   State
iqn.2012-06.com.example:target0                 10.10.10.11     Connection refused</programlisting>

	<para xml:lang="en">This message means that the specified target name is
	  wrong:</para>

	<programlisting xml:lang="en">Target name                                     Target portal   State
iqn.2012-06.com.example:target0                 10.10.10.10     Not found</programlisting>

	<para xml:lang="en">This message means that the target requires
	  authentication:</para>

	<programlisting xml:lang="en">Target name                                     Target portal   State
iqn.2012-06.com.example:target0                 10.10.10.10     Authentication failed</programlisting>

	<para xml:lang="en">To specify a <acronym>CHAP</acronym> username and
	  secret, use this syntax:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>iscsictl -A -p <replaceable>10.10.10.10</replaceable> -t <replaceable>iqn.2012-06.com.example:target0</replaceable> -u <replaceable>user</replaceable> -s <replaceable>secretsecret</replaceable></userinput></screen>
      </sect3>

      <sect3>
	<title>使用設定檔連線到 Target</title>

	<para xml:lang="en">To connect using a configuration file, create
	  <filename>/etc/iscsi.conf</filename> with contents like
	  this:</para>

	<programlisting xml:lang="en">t0 {
	TargetAddress   = 10.10.10.10
	TargetName      = iqn.2012-06.com.example:target0
	AuthMethod      = CHAP
	chapIName       = user
	chapSecret      = secretsecret
}</programlisting>

	<para xml:lang="en">The <literal>t0</literal> specifies a nickname for the
	  configuration file section.  It will be used by the
	  initiator to specify which configuration to use.  The other
	  lines specify the parameters to use during connection.  The
	  <literal>TargetAddress</literal> and
	  <literal>TargetName</literal> are mandatory, whereas the
	  other options are optional.  In this example, the
	  <acronym>CHAP</acronym> username and secret are
	  shown.</para>

	<para xml:lang="en">To connect to the defined target, specify the
	  nickname:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>iscsictl -An <replaceable>t0</replaceable></userinput></screen>

	<para xml:lang="en">Alternately, to connect to all targets defined in the
	  configuration file, use:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>iscsictl -Aa</userinput></screen>

	<para xml:lang="en">To make the initiator automatically connect to all
	  targets in <filename>/etc/iscsi.conf</filename>, add the
	  following to <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">iscsictl_enable="YES"
iscsictl_flags="-Aa"</programlisting>

      </sect3>
    </sect2>
  </sect1>

</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="firewalls">

  <info>
    <title>防火牆</title>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Joseph J.</firstname>
	  <surname>Barbish</surname>
	</personname>
	<contrib>Contributed by </contrib>
      </author>
    </authorgroup>

    <authorgroup>
      <author xml:lang="en">
	<personname>
	  <firstname>Brad</firstname>
	  <surname>Davis</surname>
	</personname>
	<contrib>Converted to SGML and updated by </contrib>
      </author>
    </authorgroup>
  </info>

  <indexterm><primary>防火牆</primary></indexterm>

  <indexterm xml:lang="en">
    <primary>security</primary>

    <secondary>firewalls</secondary>
  </indexterm>

  <sect1 xml:id="firewalls-intro">
    <title>概述</title>

    <para>防火牆能夠過濾透過系統內送 (Incoming) 與外發 (Outgoing) 的流量，防火牆可使用一組或多組 <quote>規則 (Rules)</quote> 來檢查網路連線中進出的網路封包(Network packets)，並且能允許或阻擋其通過。 而防火牆規則可以檢查封包中一個或數個特徵，例如通訊協定類型、來源或目的主機位址，以及來源及目地的連接埠 (Port)。</para>

    <para>防火牆可以加強主機或網路的安全性，它可以用來完成下列事情：</para>

    <itemizedlist>
      <listitem>
	<para>保護並隔離內部網路的應用程式、服務與主機，避免來自網際網路不必要的存取。</para>
      </listitem>

      <listitem>
	<para>限制或者禁止內部網路的主機存取網際網路服務。</para>
      </listitem>

      <listitem>
	<para>支援網路位址轉譯 (Network address translation, <acronym>NAT</acronym>)，可允許內部網路使用私有 <acronym>IP</acronym> 位址並共用一個連線使用一個 <acronym>IP</acronym> 位址連到網際網路或者自動分配一個共用池當中的公開位址。</para>
      </listitem>
    </itemizedlist>

    <para>FreeBSD 有三種內建於基礎系統的防火牆：<application>PF</application>, <application>IPFW</application> 與 <application>IPFILTER</application> 即 <application>IPF</application>。FreeBSD 也提供了兩種流量限制程式 (Traffic shaper) 來控制頻寬的用量：<citerefentry><refentrytitle>altq</refentrytitle><manvolnum>4</manvolnum></citerefentry> 與 <citerefentry><refentrytitle>dummynet</refentrytitle><manvolnum>4</manvolnum></citerefentry>，<application>ALTQ</application> 一般配合 <application>PF</application> 使用，而 <application>dummynet</application> 會配合 <application>IPFW</application>。每一種防火牆都會使用規則來管制來自與送往 FreeBSD 的封包，儘管它們用不同的方式運作且有不同的規則語法。</para>

    <para>FreeBSD 提供多個防火牆是為了滿足不同的需求與各種使用者的偏好，每位使用者應評估那一種防火牆最能滿足其需求。</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para>如何定義封包過濾規則。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 內建防火牆之間的差異。</para>
      </listitem>

      <listitem>
	<para>如何使用與設定 <application>PF</application> 防火牆。</para>
      </listitem>

      <listitem>
	<para>如何使用與設定 <application>IPFW</application> 防火牆。</para>
      </listitem>

      <listitem>
	<para>如何使用與設定 <application>IPFILTER</application> 防火牆。</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para>了解 FreeBSD 基礎及網路概念。</para>
      </listitem>
    </itemizedlist>

    <note>
      <para>由於所有防火牆均是以監控所選封包的控制欄位值為基礎運作，所以防火牆規則集的建立者必須很明白 <acronym>TCP/IP</acronym> 是如何運作的，在封包的控制欄位中會有那些數值，這些數值會被如何用在一般的連線階段，要了解更多相關資訊，可參考 <link xlink:href="http://www.ipprimer.com">Daryl's TCP/IP Primer</link>。</para>
    </note>
  </sect1>

  <sect1 xml:id="firewalls-concepts">
    <title>防火牆概念</title>

    <indexterm xml:lang="en">
      <primary>firewall</primary>

      <secondary>rulesets</secondary>
    </indexterm>

    <para>一個規則集 (Ruleset) 中會有一群根據封包內的資料來判斷通過或封鎖的規則，主機間雙向的封包交換構成一個連線階段的對話，防火牆規則集會同時處理接收自網際網路的封包以及由系統所產生的回應封包，每一個 <acronym>TCP/IP</acronym> 服務都會預先定義其通訊協定以及要傾聽的埠，要送往指定服務的封包會誕生在來源位址，使用一個不需特殊權限的埠並傳送給目標位址上特定服務的埠，所有上述過程中的參數均可用來當做建立規則的篩選條件，來允許或封鎖服務。</para>

    <para>要查詢一個不清楚的埠號，可參考 <filename>/etc/services</filename>，或者至 <uri xlink:href="http://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers">http://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers</uri> 查詢埠號來找出特定埠號的用途。</para>

    <para>查看這個連結來了解有 <uri xlink:href="http://web.archive.org/web/20150803024617/http://www.sans.org/security-resources/idfaq/oddports.php">那些埠號會被木馬程式使用</uri>。</para>

    <para>FTP 有兩個模式：主動 (Active) 模式與被動 (Passive) 模式，兩者的差異在於取得資料通道的方式，被動模式會較安全，由於資料通道會取自 FTP 連線請求者。想要取得 FTP 與兩種模式更進一步的說明，詳見 <uri xlink:href="http://www.slacksite.com/other/ftp.html">http://www.slacksite.com/other/ftp.html</uri>。</para>

    <para>防火牆規則集可以為排除式 (<quote>exclusive</quote>) 或者內含式 (<quote>inclusive</quote>)，一個排除式的防火牆會允許所有的連線通過除了符合規則集的連線，內含式的防火牆則會反過來只允許符合規則集的連線並封鎖其他任何的連線。</para>

    <para>內含式的防火牆對於外發的流量有較好的控制，使其成為提供網際網路服務的系統的最佳選擇，它同時可以控制可存取私有網路的網際網路連線，所有不符合該規則的連線會被封鎖並記錄。一般來說，內含式的防火牆會比排除式的防火牆安全，因為內含式的防火牆可以明顯的減少不必要連線所造成風險。</para>

    <note>
      <para>除非另有說明，否則所有在此章節的範例規則集均為內含式防火牆規則集。</para>
    </note>

    <para>使用具狀態防火牆 (<quote>Stateful firewall</quote>) 可以更進一步加強安全性，這種類型的防火牆可持續追蹤連線，只允許與現有連線相符的封包或符合允許條件的新連線通過。</para>

    <para>狀態過濾技術 (Stateful filtering) 將所有的流量當做是一個由雙向封包交換所組成的連線階段，當在符合的規則上指定狀態 (State) 時，防火牆會自動產生內部規則來處理該連線階段中每個預期會通過的封包，這種防火牆有足夠的比對能力可以辨別是否為同一個連線階段的封包，任何不符合連線階段樣板的封包都會被自動拒絕。</para>

    <para>當連線階段結束時，該規則將會動態狀態表 (Dynamic state table) 中移除。</para>

    <para>Stateful filtering 讓管理者可以專注於封鎖/傳遞新的連線階段，若新的連線階段通過，那麼該連線階段後續的封包將會自動允許通過，且任何假冒的封包會自動被拒絕。若新的連線階最被封鎖，將不允許其任何後續的封包。Stateful filtering 提供了進階的比對能力，能夠抵禦不同種類由攻擊者發動的 flood 攻擊。</para>

    <para><acronym>NAT</acronym> 代表 <emphasis>Network Address Translation</emphasis> 即網路位址轉譯，<acronym>NAT</acronym> 功能讓在防火牆之後的私有 LAN 可以共用一個 ISP 分配的 IP 位址 (甚至是動態分配的)，NAT 每一台在該 LAN 中的電腦均可連線網際網路，而不需要支付 ISP 多個網路帳號或 IP 位址的額外費用。</para>

    <para><acronym>NAT</acronym> 在當封包要外送到防火牆之外的網際網路時，會自動轉譯每一台電腦在私有 LAN 的 IP 位址成為一個公有 IP 位址，它也同樣會對回傳的封包做反向轉譯。</para>

    <para>根據 RFC1918，會保留以下範圍的 IP 位址做為私有網路使用，永遠不會被傳送到網際網路，因此可供 NAT 使用：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en"><literal>10.0.0.0/8</literal>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><literal>172.16.0.0/12</literal>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><literal>192.168.0.0/16</literal>.</para>
      </listitem>
    </itemizedlist>

    <warning>
      <para>在使用防火牆規則時要<emphasis>非常小心</emphasis>，有一些設定<emphasis>會將管理者鎖在伺服器之外</emphasis>，保險起見的方式是在本機的 Console 做初次的防火牆設定，不要直接由遠端透過 <application>ssh</application> 來設定防火牆。</para>
    </warning>
  </sect1>

  <sect1 xml:id="firewalls-pf">
    <info>
      <title xml:lang="en">PF</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>John</firstname>
	    <surname>Ferrell</surname>
	  </personname>
	  <contrib>Revised and updated by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>firewall</primary>

      <secondary>PF</secondary>
    </indexterm>

    <para>自 FreeBSD 5.3 開始，基礎系統便有內建 OpenBSD's <application>PF</application> 防火牆的移植版本，<application>PF</application> 是一套完整、多功能的防火牆，並可選擇開啟 <application>ALTQ</application> (Alternate Queuing) 的支援來提供 Quality of Service (<acronym>QoS</acronym>) 機制。</para>

    <para>OpenBSD 計劃有維護一份官方參考文件於 <link xlink:href="http://www.openbsd.org/faq/pf/">PF FAQ</link> ，Peter Hansteen 有維一份詳盡的 <application>PF</application> 教學於 <link xlink:href="http://home.nuug.no/~peter/pf/">http://home.nuug.no/~peter/pf/</link>。</para>

    <warning>
      <para xml:lang="en">When reading the <link xlink:href="http://www.openbsd.org/faq/pf/">PF FAQ</link>,
	keep in mind that FreeBSD's version of
	<application>PF</application> has diverged substantially from
	the upstream OpenBSD version over the years.  Not all features
	work the same way on FreeBSD as they do in OpenBSD and vice
	versa.</para>
    </warning>

    <para>要詢問有關設定與執行 <application>PF</application> 防火牆的問題可至 <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pf">FreeBSD packet filter 郵遞論壇</link>，在詢問問題之前請先查看該郵遞論壇的封存資料，因您的問題可能已有解答。</para>

    <para xml:lang="en">This section of the Handbook focuses on
      <application>PF</application> as it pertains to FreeBSD.  It
      demonstrates how to enable <application>PF</application> and
      <application>ALTQ</application>.  It also provides several
      examples for creating rulesets on a FreeBSD system.</para>

    <sect2>
      <title>開啟 <application>PF</application></title>

      <para xml:lang="en">To use <application>PF</application>, its kernel
	module must be first loaded.  This section describes the
	entries that can be added to <filename>/etc/rc.conf</filename>
	to enable <application>PF</application>.</para>

      <para xml:lang="en">Start by adding <literal>pf_enable=yes</literal> to
	<filename>/etc/rc.conf</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc pf_enable=yes</userinput></screen>

      <para xml:lang="en">Additional options, described in <citerefentry><refentrytitle>pfctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>, can be
	passed to <application>PF</application> when it is started.
	Add or change this entry in <filename>/etc/rc.conf</filename>
	and specify any required flags between the two quotes
	(<literal>""</literal>):</para>

      <programlisting xml:lang="en">pf_flags=""                     # additional flags for pfctl startup</programlisting>

      <para xml:lang="en"><application>PF</application> will not start if it cannot
	find its ruleset configuration file.  By default, FreeBSD does
	not ship with a ruleset and there is no
	<filename>/etc/pf.conf</filename>.  Example rulesets can be
	found in <filename>/usr/share/examples/pf/</filename>.  If a
	custom ruleset has been saved somewhere else, add a line to
	<filename>/etc/rc.conf</filename> which specifies the full
	path to the file:</para>

      <programlisting xml:lang="en">pf_rules="<replaceable>/path/to/pf.conf</replaceable>"</programlisting>

      <para xml:lang="en">Logging support for <application>PF</application> is
	provided by <citerefentry><refentrytitle>pflog</refentrytitle><manvolnum>4</manvolnum></citerefentry>.  To enable logging support, add
	<literal>pflog_enable=yes</literal> to
	<filename>/etc/rc.conf</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc pflog_enable=yes</userinput></screen>

      <para xml:lang="en">The following lines can also be added to change the
	default location of the log file or to specify any additional
	flags to pass to <citerefentry><refentrytitle>pflog</refentrytitle><manvolnum>4</manvolnum></citerefentry> when it is started:</para>

      <programlisting xml:lang="en">pflog_logfile="/var/log/pflog"  # where pflogd should store the logfile
pflog_flags=""                  # additional flags for pflogd startup</programlisting>

      <para xml:lang="en">Finally, if there is a <acronym>LAN</acronym> behind the
	firewall and packets need to be forwarded for the computers on
	the <acronym>LAN</acronym>, or <acronym>NAT</acronym> is
	required, enable the following option:</para>

      <programlisting xml:lang="en">gateway_enable="YES"            # Enable as LAN gateway</programlisting>

      <para xml:lang="en">After saving the needed edits,
	<application>PF</application> can be started with logging
	support by typing:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service pf start</userinput>
<prompt>#</prompt> <userinput>service pflog start</userinput></screen>

<!--
This is no longer true as of 9.x. It also references the CARP section
which doesn't explain how to use it...At some point it should.
     <indexterm>
	<primary>kernel options</primary>
	<secondary>device pf</secondary>
      </indexterm>

      <indexterm>
	<primary>kernel options</primary>
	<secondary>device pflog</secondary>
      </indexterm>

      <indexterm>
	<primary>kernel options</primary>
	<secondary>device pfsync</secondary>
      </indexterm>

      <note>
      <para>While it is not necessary to compile
	<application>PF</application> support into the &os; kernel,
	some advanced features are not included, namely &man.pfsync.4;, which is a
	pseudo-device that exposes certain changes to the state table
	used by <application>PF</application>.  It can be paired with
	&man.carp.4; to create failover firewalls using
	<application>PF</application>.  More information on
	<acronym>CARP</acronym> can be found in <xref linkend="carp"/>.</para>

      <para>The following <application>PF</application> kernel options
	are available:</para>

      <programlisting>device pf
device pflog
device pfsync</programlisting>

      <para>where:</para>

      <para><literal>device pf</literal> enables PF support.</para>

      <para><literal>device pflog</literal> enables the optional
	&man.pflog.4; pseudo network device which can be used to log
	traffic to a &man.bpf.4; descriptor.  The &man.pflogd.8;
	daemon can then be used to store the logging information to
	disk.</para>

      <para><literal>device pfsync</literal> enables the optional
	&man.pfsync.4; pseudo-network device that is used to monitor
	<quote>state changes</quote>.</para>
    </note>
    -->

      <para xml:lang="en">By default, <application>PF</application> reads its
	configuration rules from <filename>/etc/pf.conf</filename> and
	modifies, drops, or passes packets according to the rules or
	definitions specified in this file.  The FreeBSD installation
	includes several sample files located in
	<filename>/usr/share/examples/pf/</filename>.  Refer to the
	<link xlink:href="http://www.openbsd.org/faq/pf/">PF
	  FAQ</link> for complete coverage
	of <application>PF</application> rulesets.</para>

      <para xml:lang="en">To control <application>PF</application>, use
	<command>pfctl</command>.  <xref linkend="pfctl"/> summarizes
	some useful options to this command.  Refer to <citerefentry><refentrytitle>pfctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	for a description of all available options:</para>

      <table xml:id="pfctl" frame="none" pgwide="1">
	<title>有用的 <command>pfctl</command> 選項</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>指令</entry>
	      <entry>用途</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><command>pfctl
		  -e</command></entry>
	      <entry xml:lang="en">Enable <application>PF</application>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><command>pfctl
		  -d</command></entry>
	      <entry xml:lang="en">Disable <application>PF</application>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><command>pfctl -F all
		  -f /etc/pf.conf</command></entry>
	      <entry xml:lang="en">Flush all <acronym>NAT</acronym>, filter, state,
		and table rules and reload
		<filename>/etc/pf.conf</filename>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><command>pfctl -s [ rules | nat |
		  states ]</command></entry>
	      <entry xml:lang="en">Report on the filter rules,
		<acronym>NAT</acronym> rules, or state
		table.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><command>pfctl -vnf
		  /etc/pf.conf</command></entry>
	      <entry xml:lang="en">Check <filename>/etc/pf.conf</filename> for
		errors, but do not load ruleset.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <tip>
	<para xml:lang="en"><package>security/sudo</package> is useful for running
	  commands like <command>pfctl</command> that require elevated
	  privileges.  It can be installed from the Ports
	  Collection.</para>
      </tip>

      <para xml:lang="en">To keep an eye on the traffic that passes through the
	<application>PF</application> firewall, consider installing
	the <package>sysutils/pftop</package> package or port.  Once
	installed, <application>pftop</application> can be run to
	view a running snapshot of traffic in a format which is
	similar to <citerefentry><refentrytitle>top</refentrytitle><manvolnum>1</manvolnum></citerefentry>.</para>
    </sect2>

    <sect2 xml:id="pf-tutorial">
      <info>
	<title><application>PF</application> 規則集</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Peter</firstname>
	      <surname>Hansteen</surname>
	      <othername>N. M.</othername>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para xml:lang="en">This section demonstrates how to create a customized
	ruleset.  It starts with the simplest of rulesets and builds
	upon its concepts using several examples to demonstrate
	real-world usage of <application>PF</application>'s many
	features.</para>

      <para xml:lang="en">The simplest possible ruleset is for a single machine
	that does not run any services and which needs access to one
	network, which may be the Internet.  To create this minimal
	ruleset, edit <filename>/etc/pf.conf</filename> so it looks
	like this:</para>

      <programlisting xml:lang="en">block in all
pass out all keep state</programlisting>

      <para xml:lang="en">The first rule denies all incoming traffic by default.
	The second rule allows connections created by this system to
	pass out, while retaining state information on those
	connections.  This state information allows return traffic for
	those connections to pass back and should only be used on
	machines that can be trusted.  The ruleset can be loaded
	with:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pfctl -e ; pfctl -f /etc/pf.conf</userinput></screen>

      <para xml:lang="en">In addition to keeping state,
	<application>PF</application> provides
	<firstterm>lists</firstterm> and
	<firstterm>macros</firstterm> which can be defined for use
	when creating rules.  Macros can include lists and need to be
	defined before use.  As an example, insert these lines at the
	very top of the ruleset:</para>

      <programlisting xml:lang="en">tcp_services = "{ ssh, smtp, domain, www, pop3, auth, pop3s }"
udp_services = "{ domain }"</programlisting>

      <para xml:lang="en"><application>PF</application> understands port names as
	well as port numbers, as long as the names are listed in
	<filename>/etc/services</filename>.  This example creates two
	macros.  The first is a list of seven
	<acronym>TCP</acronym> port names and the second is one
	<acronym>UDP</acronym> port name.  Once defined, macros can be
	used in rules.  In this example, all traffic is blocked except
	for the  connections initiated by this system for the seven
	specified <acronym>TCP</acronym> services and the one
	specified <acronym>UDP</acronym> service:</para>

      <programlisting xml:lang="en">tcp_services = "{ ssh, smtp, domain, www, pop3, auth, pop3s }"
udp_services = "{ domain }"
block all
pass out proto tcp to any port $tcp_services keep state
pass proto udp to any port $udp_services keep state</programlisting>

      <para xml:lang="en">Even though <acronym>UDP</acronym> is considered to be a
	stateless protocol, <application>PF</application> is able to
	track some state information.  For example, when a
	<acronym>UDP</acronym> request is passed which asks a name
	server about a domain name, <application>PF</application> will
	watch for the response to pass it back.</para>

      <para xml:lang="en">Whenever an edit is made to a ruleset, the new rules must
	be loaded so they can be used:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pfctl -f /etc/pf.conf</userinput></screen>

      <para xml:lang="en">If there are no syntax errors, <command>pfctl</command>
	will not output any messages during the rule load.  Rules can
	also be tested before attempting to load them:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pfctl -nf /etc/pf.conf</userinput></screen>

      <para xml:lang="en">Including <option>-n</option> causes the rules to be
	interpreted only, but not loaded.  This provides an
	opportunity to correct any errors.  At all times, the last
	valid ruleset loaded will be enforced until either
	<application>PF</application> is disabled or a new ruleset is
	loaded.</para>

      <tip>
	<para xml:lang="en">Adding <option>-v</option> to a <command>pfctl</command>
	  ruleset verify or load will display the fully parsed rules
	  exactly the way they will be loaded.  This is extremely
	  useful when debugging rules.</para>
      </tip>

      <sect3 xml:id="pftut-gateway">
	<title>使用 NAT 的簡單通訊閘</title>

	<para xml:lang="en">This section demonstrates how to configure a FreeBSD system
	  running <application>PF</application> to act as a gateway
	  for at least one other machine.  The gateway needs at least
	  two network interfaces, each connected to a separate
	  network.  In this example, <filename>xl1</filename> is
	  connected to the Internet and <filename>xl0</filename> is
	  connected to the internal network.</para>

	<para xml:lang="en">First, enable the gateway to let the machine
	  forward the network traffic it receives on one interface to
	  another interface.  This <application>sysctl</application>
	  setting will forward <acronym>IPv4</acronym> packets:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl net.inet.ip.forwarding=1</userinput></screen>

	<para xml:lang="en">To forward <acronym>IPv6</acronym> traffic, use:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysctl net.inet6.ip6.forwarding=1</userinput></screen>

	<para xml:lang="en">To enable these settings at system boot, use
	  <citerefentry><refentrytitle>sysrc</refentrytitle><manvolnum>8</manvolnum></citerefentry> to add them to
	  <filename>/etc/rc.conf</filename>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc gateway_enable=yes</userinput>
<prompt>#</prompt> <userinput>sysrc ipv6_gateway_enable=yes</userinput></screen>

	<para xml:lang="en">Verify with <command>ifconfig</command> that both of the
	  interfaces are up and running.</para>

	<para xml:lang="en">Next, create the <application>PF</application> rules to
	  allow the gateway to pass traffic.  While the following rule
	  allows stateful traffic to pass from the Internet  to hosts
	  on the network, the <literal>to</literal> keyword does not
	  guarantee passage all the way from source to
	  destination:</para>

	<programlisting xml:lang="en">pass in on xl1 from xl1:network to xl0:network port $ports keep state</programlisting>

	<para xml:lang="en">That rule only lets the traffic pass in to the gateway
	  on the internal interface.  To let the packets go further, a
	  matching rule is needed:</para>

	<programlisting xml:lang="en">pass out on xl0 from xl1:network to xl0:network port $ports keep state</programlisting>

	<para xml:lang="en">While these two rules will work, rules this specific are
	  rarely needed.  For a busy network admin, a readable ruleset
	  is a safer ruleset.  The remainder of this section
	  demonstrates how to keep the rules as simple as possible for
	  readability.  For example, those two rules could be
	  replaced with one rule:</para>

	<programlisting xml:lang="en">pass from xl1:network to any port $ports keep state</programlisting>

	<para xml:lang="en">The <literal>interface:network</literal> notation can be
	  replaced with a macro to make the ruleset even more
	  readable.  For example, a <literal>$localnet</literal> macro
	  could be defined as the network directly attached to the
	  internal interface (<literal>$xl1:network</literal>).
	  Alternatively, the definition of
	  <literal>$localnet</literal> could be changed to an
	  <emphasis>IP address/netmask</emphasis> notation to denote
	  a network, such as <literal>192.168.100.1/24</literal> for a
	  subnet of private addresses.</para>

	<para xml:lang="en">If required, <literal>$localnet</literal> could even be
	  defined as a list of networks.  Whatever the specific needs,
	  a sensible <literal>$localnet</literal> definition could be
	  used in a typical pass rule as follows:</para>

	<programlisting xml:lang="en">pass from $localnet to any port $ports keep state</programlisting>

	<para xml:lang="en">The following sample ruleset allows all traffic
	  initiated by machines on the internal network.  It first
	  defines two macros to represent the external and internal
	  3COM interfaces of the gateway.</para>

	<note>
	  <para xml:lang="en">For dialup users, the external interface will use
	    <filename>tun0</filename>.  For an
	    <acronym>ADSL</acronym> connection, specifically those
	    using <acronym>PPP</acronym> over Ethernet
	    (<acronym>PPPoE</acronym>), the correct external
	    interface is <filename>tun0</filename>, not the physical
	    Ethernet interface.</para>
	</note>

	<programlisting xml:lang="en">ext_if = "xl0"	# macro for external interface - use tun0 for PPPoE
int_if = "xl1"	# macro for internal interface
localnet = $int_if:network
# ext_if IP address could be dynamic, hence ($ext_if)
nat on $ext_if from $localnet to any -&gt; ($ext_if)
block all
pass from { lo0, $localnet } to any keep state</programlisting>

	<para xml:lang="en">This ruleset introduces the <literal>nat</literal> rule
	  which is used to handle the network address translation from
	  the non-routable addresses inside the internal network to
	  the <acronym>IP</acronym> address assigned to the external
	  interface.  The parentheses surrounding the last part of the
	  nat rule <literal>($ext_if)</literal> is included when the
	  <acronym>IP</acronym> address of the external interface is
	  dynamically assigned.  It ensures that network traffic runs
	  without serious interruptions even if the external
	  <acronym>IP</acronym> address changes.</para>

	<para xml:lang="en">Note that this ruleset probably allows more traffic to
	  pass out of the network than is needed.  One reasonable
	  setup could create this macro:</para>

	<programlisting xml:lang="en">client_out = "{ ftp-data, ftp, ssh, domain, pop3, auth, nntp, http, \
    https, cvspserver, 2628, 5999, 8000, 8080 }"</programlisting>

	<para xml:lang="en">to use in the main pass rule:</para>

	<programlisting xml:lang="en">pass inet proto tcp from $localnet to any port $client_out \
    flags S/SA keep state</programlisting>

	<para xml:lang="en">A few other pass rules may be needed.  This one enables
	  <acronym>SSH</acronym> on the external interface:</para>

	<programlisting xml:lang="en">pass in inet proto tcp to $ext_if port ssh</programlisting>

	<para xml:lang="en">This macro definition and rule allows
	  <acronym>DNS</acronym> and <acronym>NTP</acronym> for
	  internal clients:</para>

	<programlisting xml:lang="en">udp_services = "{ domain, ntp }"
pass quick inet proto { tcp, udp } to any port $udp_services keep state</programlisting>

	<para xml:lang="en">Note the <literal>quick</literal> keyword in this rule.
	  Since the ruleset consists of several rules, it is important
	  to understand the relationships between the rules in a
	  ruleset.  Rules are evaluated from top to bottom, in the
	  sequence they are written.  For each packet or connection
	  evaluated by <application>PF</application>,
	  <emphasis>the last matching rule</emphasis> in the ruleset
	  is the one which is applied.  However, when a packet matches
	  a rule which contains the <literal>quick</literal> keyword,
	  the rule processing stops and the packet is treated
	  according to that rule.  This is very useful when an
	  exception to the general rules is needed.</para>
      </sect3>

      <sect3 xml:id="pftut-ftp">
	<title>建立 <acronym>FTP</acronym> Proxy</title>

	<para xml:lang="en">Configuring working <acronym>FTP</acronym> rules can be
	  problematic due to the nature of the <acronym>FTP</acronym>
	  protocol.  <acronym>FTP</acronym> pre-dates firewalls by
	  several decades and is insecure in its design.  The most
	  common points against using <acronym>FTP</acronym>
	  include:</para>

	<itemizedlist>
	  <listitem>
	    <para xml:lang="en">Passwords are transferred in the clear.</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">The protocol demands the use of at least two
	      <acronym>TCP</acronym> connections (control and data) on
	      separate ports.</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">When a session is established, data is communicated
	      using randomly selected ports.</para>
	  </listitem>
	</itemizedlist>

	<para xml:lang="en">All of these points present security challenges, even
	  before considering any potential security weaknesses in
	  client or server software.  More secure alternatives for
	  file transfer exist, such as <citerefentry><refentrytitle>sftp</refentrytitle><manvolnum>1</manvolnum></citerefentry> or <citerefentry><refentrytitle>scp</refentrytitle><manvolnum>1</manvolnum></citerefentry>,
	  which both feature authentication and data transfer over
	  encrypted connections..</para>

	<para xml:lang="en">For those situations when <acronym>FTP</acronym> is
	  required, <application>PF</application> provides
	  redirection of <acronym>FTP</acronym> traffic to a small
	  proxy program called <citerefentry><refentrytitle>ftp-proxy</refentrytitle><manvolnum>8</manvolnum></citerefentry>, which is included in
	  the base system of FreeBSD.  The role of the proxy is to
	  dynamically insert and delete rules in the ruleset, using a
	  set of anchors, to correctly handle
	  <acronym>FTP</acronym> traffic.</para>

	<para xml:lang="en">To enable the <acronym>FTP</acronym> proxy, add this
	  line to <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">ftpproxy_enable="YES"</programlisting>

	<para xml:lang="en">Then start the proxy by running <command>service
	    ftp-proxy start</command>.</para>

	<para xml:lang="en">For a basic configuration, three elements need to be
	  added to <filename>/etc/pf.conf</filename>.  First, the
	  anchors which the proxy will use to insert the rules it
	  generates for the <acronym>FTP</acronym> sessions:</para>

	<programlisting xml:lang="en">nat-anchor "ftp-proxy/*"
rdr-anchor "ftp-proxy/*"</programlisting>

	<para xml:lang="en">Second, a pass rule is needed to allow
	  <acronym>FTP</acronym> traffic in to the proxy.</para>

	<para xml:lang="en">Third, redirection and <acronym>NAT</acronym> rules need
	  to be defined before the filtering rules.  Insert this
	  <literal>rdr</literal> rule immediately after the
	  <literal>nat</literal> rule:</para>

	<programlisting xml:lang="en">rdr pass on $int_if proto tcp from any to any port ftp -&gt; 127.0.0.1 port 8021</programlisting>

	<para xml:lang="en">Finally, allow the redirected traffic to pass:</para>

	<programlisting xml:lang="en">pass out proto tcp from $proxy to any port ftp</programlisting>

	<para xml:lang="en">where <literal>$proxy</literal> expands to the address
	  the proxy daemon is bound to.</para>

	<para xml:lang="en">Save <filename>/etc/pf.conf</filename>, load the new
	  rules, and verify from a client that <acronym>FTP</acronym>
	  connections are working:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pfctl -f /etc/pf.conf</userinput></screen>

	<para xml:lang="en">This example covers a basic setup where the clients in
	  the local network need to contact <acronym>FTP</acronym>
	  servers elsewhere.  This basic configuration should
	  work well with most combinations of <acronym>FTP</acronym>
	  clients and servers.  As shown in <citerefentry><refentrytitle>ftp-proxy</refentrytitle><manvolnum>8</manvolnum></citerefentry>, the
	  proxy's behavior can be changed in various ways by adding
	  options to the <literal>ftpproxy_flags=</literal> line.
	  Some clients or servers may have specific quirks that must
	  be compensated for in the configuration, or there may be a
	  need to integrate the proxy in specific ways such as
	  assigning <acronym>FTP</acronym> traffic to a specific
	  queue.</para>

	<para xml:lang="en">For ways to run an <acronym>FTP</acronym> server
	  protected by <application>PF</application> and
	  <citerefentry><refentrytitle>ftp-proxy</refentrytitle><manvolnum>8</manvolnum></citerefentry>, configure a separate
	  <command>ftp-proxy</command> in reverse mode, using
	  <option>-R</option>, on a separate port with its own
	  redirecting pass rule.</para>
      </sect3>

      <sect3 xml:id="pftut-icmp">
	<title>管理 <acronym>ICMP</acronym></title>

	<para xml:lang="en">Many of the tools used for debugging or troubleshooting
	  a <acronym>TCP/IP</acronym> network rely on the Internet
	  Control Message Protocol (<acronym>ICMP</acronym>), which
	  was designed specifically with debugging in mind.</para>

	<para xml:lang="en">The <acronym>ICMP</acronym> protocol sends and receives
	  <emphasis>control messages</emphasis> between hosts and
	  gateways, mainly to provide feedback to a sender about any
	  unusual or difficult conditions enroute to the target host.
	  Routers use <acronym>ICMP</acronym> to negotiate packet
	  sizes and other transmission parameters in a process often
	  referred to as <emphasis>path <acronym>MTU</acronym>
	    discovery</emphasis>.</para>

	<para xml:lang="en">From a firewall perspective, some
	  <acronym>ICMP</acronym> control messages are vulnerable to
	  known attack vectors.  Also, letting all diagnostic traffic
	  pass unconditionally makes debugging easier, but it also
	  makes it easier for others to extract information about the
	  network.  For these reasons, the following rule may not be
	  optimal:</para>

	<programlisting xml:lang="en">pass inet proto icmp from any to any</programlisting>

	<para xml:lang="en">One solution is to let all <acronym>ICMP</acronym>
	  traffic from the local network through while stopping all
	  probes from outside the network:</para>

	<programlisting xml:lang="en">pass inet proto icmp from $localnet to any keep state
pass inet proto icmp from any to $ext_if keep state</programlisting>

	<para xml:lang="en">Additional options are available which demonstrate some
	  of <application>PF</application>'s flexibility.  For
	  example, rather than allowing all <acronym>ICMP</acronym>
	  messages, one can specify the messages used by <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	  and <citerefentry><refentrytitle>traceroute</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  Start by defining a macro for that
	  type of message:</para>

	<programlisting xml:lang="en">icmp_types = "echoreq"</programlisting>

	<para xml:lang="en">and a rule which uses the macro:</para>

	<programlisting xml:lang="en">pass inet proto icmp all icmp-type $icmp_types keep state</programlisting>

	<para xml:lang="en">If other types of <acronym>ICMP</acronym> packets are
	  needed, expand <literal>icmp_types</literal> to a list of
	  those packet types.  Type <command>more
	    /usr/src/sbin/pfctl/pfctl_parser.c</command> to see
	  the list of <acronym>ICMP</acronym> message types supported
	  by <application>PF</application>.  Refer to <link xlink:href="http://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml">http://www.iana.org/assignments/icmp-parameters/icmp-parameters.xhtml</link>
	  for an explanation of each message type.</para>

	<para xml:lang="en">Since Unix <command>traceroute</command> uses
	  <acronym>UDP</acronym> by default, another rule is needed to
	  allow Unix <command>traceroute</command>:</para>

	<programlisting xml:lang="en"># allow out the default range for traceroute(8):
pass out on $ext_if inet proto udp from any to any port 33433 &gt;&lt; 33626 keep state</programlisting>

	<para xml:lang="en">Since <command>TRACERT.EXE</command> on Microsoft
	  Windows systems uses <acronym>ICMP</acronym> echo request
	  messages, only the first rule is needed to allow network
	  traces from those systems.  Unix
	  <command>traceroute</command> can be instructed to use other
	  protocols as well, and will use <acronym>ICMP</acronym> echo
	  request messages if <option>-I</option> is used.  Check the
	  <citerefentry><refentrytitle>traceroute</refentrytitle><manvolnum>8</manvolnum></citerefentry> man page for details.</para>

	<sect4 xml:id="pftut-pathmtudisc">
	  <title xml:lang="en">Path <acronym>MTU</acronym> Discovery</title>

	  <para xml:lang="en">Internet protocols are designed to be device
	    independent, and one consequence of device independence is
	    that the optimal packet size for a given connection cannot
	    always be predicted reliably.  The main constraint on
	    packet size is the <firstterm>Maximum Transmission
	      Unit</firstterm> (<acronym>MTU</acronym>) which sets the
	    upper limit on the packet size for an interface.  Type
	    <command>ifconfig</command> to view the
	    <acronym>MTU</acronym>s for a system's network
	    interfaces.</para>

	  <para xml:lang="en"><acronym>TCP/IP</acronym> uses a process known as path
	    <acronym>MTU</acronym> discovery to determine the right
	    packet size for a connection.  This process sends packets
	    of varying sizes with the <quote>Do not fragment</quote>
	    flag set, expecting an <acronym>ICMP</acronym> return
	    packet of <quote>type 3, code 4</quote> when the upper
	    limit has been reached.  Type 3 means <quote>destination
	      unreachable</quote>, and code 4 is short for
	    <quote>fragmentation needed, but the do-not-fragment flag
	      is set</quote>.  To allow path MTU discovery in order
	    to support connections to other <acronym>MTU</acronym>s,
	    add the <literal>destination unreachable</literal> type to
	    the <literal>icmp_types</literal> macro:</para>

	  <programlisting xml:lang="en">icmp_types = "{ echoreq, unreach }"</programlisting>

	  <para xml:lang="en">Since the pass rule already uses that macro, it does
	    not need to be modified to support the new
	    <acronym>ICMP</acronym> type:</para>

	  <programlisting xml:lang="en">pass inet proto icmp all icmp-type $icmp_types keep state</programlisting>

	  <para xml:lang="en"><application>PF</application> allows filtering on all
	    variations of <acronym>ICMP</acronym> types and codes.
	    The list of possible types and codes are documented in
	    <citerefentry><refentrytitle>icmp</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>icmp6</refentrytitle><manvolnum>4</manvolnum></citerefentry>.</para>
	</sect4>
      </sect3>

      <sect3 xml:id="pftut-tables">
	<title>使用 Tables</title>

	<para xml:lang="en">Some types of data are relevant to filtering and
	  redirection at a given time, but their definition is too
	  long to be included in the ruleset file.
	  <application>PF</application> supports the use of tables,
	  which are defined lists that can be manipulated without
	  needing to reload the entire ruleset, and which can provide
	  fast lookups.  Table names are always enclosed within
	  <literal>&lt; &gt;</literal>, like this:</para>

	<programlisting xml:lang="en">table &lt;clients&gt; { 192.168.2.0/24, !192.168.2.5 }</programlisting>

	<para xml:lang="en">In this example, the <literal>192.168.2.0/24</literal>
	  network is part of the table, except for the address
	  <literal>192.168.2.5</literal>, which is excluded using the
	  <literal>!</literal> operator.  It is also possible to load
	  tables from files where each item is on a separate line, as
	  seen in this example
	  <filename>/etc/clients</filename>:</para>

	<programlisting xml:lang="en">192.168.2.0/24
!192.168.2.5</programlisting>

	<para xml:lang="en">To refer to the file, define the table like this:</para>

	<programlisting xml:lang="en">table &lt;clients&gt; persist file "/etc/clients"</programlisting>

	<para xml:lang="en">Once the table is defined, it can be referenced by a
	  rule:</para>

	<programlisting xml:lang="en">pass inet proto tcp from &lt;clients&gt; to any port $client_out flags S/SA keep state</programlisting>

	<para xml:lang="en">A table's contents can be manipulated live, using
	  <command>pfctl</command>.  This example adds another network
	  to the table:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pfctl -t clients -T add 192.168.1.0/16</userinput></screen>

	<para xml:lang="en">Note that any changes made this way will take affect
	  now, making them ideal for testing, but will not survive a
	  power failure or reboot.  To make the changes permanent,
	  modify the definition of the table in the ruleset or edit
	  the file that the table refers to.  One can maintain the
	  on-disk copy of the table using a <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> job which
	  dumps the table's contents to disk at regular intervals,
	  using a command such as <command>pfctl -t clients -T show
	    &gt;/etc/clients</command>.  Alternatively,
	  <filename>/etc/clients</filename> can be updated with the
	  in-memory table contents:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pfctl -t clients -T replace -f /etc/clients</userinput></screen>
      </sect3>

      <sect3 xml:id="pftut-overload">
	<title>使用 Overload Tables 保護 <acronym>SSH</acronym></title>

	<para xml:lang="en">Those who run <acronym>SSH</acronym> on an external
	  interface have probably seen something like this in the
	  authentication logs:</para>

	<programlisting xml:lang="en">Sep 26 03:12:34 skapet sshd[25771]: Failed password for root from 200.72.41.31 port 40992 ssh2
Sep 26 03:12:34 skapet sshd[5279]: Failed password for root from 200.72.41.31 port 40992 ssh2
Sep 26 03:12:35 skapet sshd[5279]: Received disconnect from 200.72.41.31: 11: Bye Bye
Sep 26 03:12:44 skapet sshd[29635]: Invalid user admin from 200.72.41.31
Sep 26 03:12:44 skapet sshd[24703]: input_userauth_request: invalid user admin
Sep 26 03:12:44 skapet sshd[24703]: Failed password for invalid user admin from 200.72.41.31 port 41484 ssh2</programlisting>

	<para xml:lang="en">This is indicative of a brute force attack where
	  somebody or some program is trying to discover the user name
	  and password which will let them into the system.</para>

	<para xml:lang="en">If external <acronym>SSH</acronym> access is needed for
	  legitimate users, changing the default port used by
	  <acronym>SSH</acronym> can offer some protection.  However,
	  <application>PF</application> provides a more elegant
	  solution.  Pass rules can contain limits on what connecting
	  hosts can do and violators can be banished to a table of
	  addresses which are denied some or all access.  It is even
	  possible to drop all existing connections from machines
	  which overreach the limits.</para>

	<para xml:lang="en">To configure this, create this table in the tables
	  section of the ruleset:</para>

	<programlisting xml:lang="en">table &lt;bruteforce&gt; persist</programlisting>

	<para xml:lang="en">Then, somewhere early in the ruleset, add rules to block
	  brute access while allowing legitimate access:</para>

	<programlisting xml:lang="en">block quick from &lt;bruteforce&gt;
pass inet proto tcp from any to $localnet port $tcp_services \
    flags S/SA keep state \
    (max-src-conn <replaceable>100</replaceable>, max-src-conn-rate <replaceable>15/5</replaceable>, \
    overload &lt;bruteforce&gt; flush global)</programlisting>

	<para xml:lang="en">The part in parentheses defines the limits and the
	  numbers should be changed to meet local requirements.  It
	  can be read as follows:</para>

	<para xml:lang="en"><literal>max-src-conn</literal> is the number of
	  simultaneous connections allowed from one host.</para>

	<para xml:lang="en"><literal>max-src-conn-rate</literal> is the rate of new
	  connections allowed from any single host
	  (<replaceable>15</replaceable>) per number of seconds
	  (<replaceable>5</replaceable>).</para>

	<para xml:lang="en"><literal>overload &lt;bruteforce&gt;</literal> means
	  that any host which exceeds these limits gets its address
	  added to the <literal>bruteforce</literal> table.  The
	  ruleset blocks all traffic from addresses in the
	  <literal>bruteforce</literal> table.</para>

	<para xml:lang="en">Finally, <literal>flush global</literal> says that when
	  a host reaches the limit, that all
	  (<literal>global</literal>) of that host's connections will
	  be terminated (<literal>flush</literal>).</para>

	<note>
	  <para xml:lang="en">These rules will <emphasis>not</emphasis> block slow
	    bruteforcers, as described in <link xlink:href="http://home.nuug.no/~peter/hailmary2013/">http://home.nuug.no/~peter/hailmary2013/</link>.</para>
	</note>

	<para xml:lang="en">This example ruleset is intended mainly as an
	  illustration.  For example, if a generous number of
	  connections in general are wanted, but the desire is to be
	  more restrictive when it comes to
	  <application>ssh</application>, supplement the rule above
	  with something like the one below, early on in the rule
	  set:</para>

	<programlisting xml:lang="en">pass quick proto { tcp, udp } from any to any port ssh \
    flags S/SA keep state \
    (max-src-conn 15, max-src-conn-rate 5/3, \
    overload &lt;bruteforce&gt; flush global)</programlisting>

	<note>
	  <title xml:lang="en">It May Not be Necessary to Block All
	    Overloaders</title>

	  <para xml:lang="en">It is worth noting that the overload mechanism is a
	    general technique which does not apply exclusively to
	    <acronym>SSH</acronym>, and it is not always optimal to
	    entirely block all traffic from offenders.</para>

	  <para xml:lang="en">For example, an overload rule could be used to
	    protect a mail service or a web service, and the overload
	    table could be used in a rule to assign offenders to a
	    queue with a minimal bandwidth allocation or to redirect
	    to a specific web page.</para>
	</note>

	<para xml:lang="en">Over time, tables will be filled by overload rules and
	  their size will grow incrementally, taking up more memory.
	  Sometimes an <acronym>IP</acronym> address that is blocked
	  is a dynamically assigned one, which has since been assigned
	  to a host who has a legitimate reason to communicate with
	  hosts in the local network.</para>

	<para xml:lang="en">For situations like these,
	  <application>pfctl</application> provides the ability to
	  expire table entries.  For example, this command will remove
	  <literal>&lt;bruteforce&gt;</literal> table entries which
	  have not been referenced for <literal>86400</literal>
	  seconds:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pfctl -t bruteforce -T expire 86400</userinput></screen>

	<para xml:lang="en">Similar functionality is provided by
	  <package>security/expiretable</package>, which removes table
	  entries which have not been accessed for a specified period
	  of time.</para>

	<para xml:lang="en">Once installed, <application>expiretable</application>
	  can be run to remove <literal>&lt;bruteforce&gt;</literal>
	  table entries older than a specified age.  This example
	  removes all entries older than 24 hours:</para>

	<programlisting xml:lang="en">/usr/local/sbin/expiretable -v -d -t 24h bruteforce</programlisting>
      </sect3>

      <sect3 xml:id="pftut-spamd">
	<title><acronym>SPAM</acronym> 防護</title>

	<para xml:lang="en">Not to be confused with the
	  <application>spamd</application> daemon which comes bundled
	  with <application>spamassassin</application>,
	  <package>mail/spamd</package> can be configured with
	  <application>PF</application> to provide an outer defense
	  against <acronym>SPAM</acronym>.  This
	  <application>spamd</application> hooks into the
	  <application>PF</application> configuration using a set of
	  redirections.</para>

	<para xml:lang="en">Spammers tend to send a large number of messages, and
	  <acronym>SPAM</acronym> is mainly sent from a few spammer
	  friendly networks and a large number of hijacked machines,
	  both of which are reported to
	  <firstterm>blacklists</firstterm> fairly quickly.</para>

	<para xml:lang="en">When an <acronym>SMTP</acronym> connection from an
	  address in a blacklist is received,
	  <application>spamd</application> presents its banner and
	  immediately switches to a mode where it answers
	  <acronym>SMTP</acronym> traffic one byte at a time.  This
	  technique, which is intended to waste as much time as
	  possible on the spammer's end, is called
	  <firstterm>tarpitting</firstterm>.  The specific
	  implementation which uses one byte <acronym>SMTP</acronym>
	  replies is often referred to as
	  <firstterm>stuttering</firstterm>.</para>

	<para xml:lang="en">This example demonstrates the basic procedure for
	  setting up <application>spamd</application> with
	  automatically updated blacklists.  Refer to the man pages
	  which are installed with <package>mail/spamd</package> for
	  more information.</para>

	<procedure>
	  <title xml:lang="en">Configuring <application>spamd</application></title>

	  <step>
	    <para xml:lang="en">Install the <package>mail/spamd</package> package
	      or port.  To use <application>spamd</application>'s
	      greylisting features, <citerefentry><refentrytitle>fdescfs</refentrytitle><manvolnum>5</manvolnum></citerefentry> must be mounted at
	      <filename>/dev/fd</filename>.  Add the following line to
	      <filename>/etc/fstab</filename>:</para>

	    <programlisting xml:lang="en"> fdescfs /dev/fd fdescfs rw 0 0</programlisting>

	    <para xml:lang="en">Then, mount the filesystem:</para>

	    <programlisting xml:lang="en"><prompt>#</prompt> <userinput>mount fdescfs</userinput></programlisting>
	  </step>

	  <step>
	    <para xml:lang="en">Next, edit the <application>PF</application> ruleset
	      to include:</para>

	    <programlisting xml:lang="en">table &lt;spamd&gt; persist
table &lt;spamd-white&gt; persist
rdr pass on $ext_if inet proto tcp from &lt;spamd&gt; to \
    { $ext_if, $localnet } port smtp -&gt; 127.0.0.1 port 8025
rdr pass on $ext_if inet proto tcp from !&lt;spamd-white&gt; to \
    { $ext_if, $localnet } port smtp -&gt; 127.0.0.1 port 8025</programlisting>

	    <para xml:lang="en">The two tables <literal>&lt;spamd&gt;</literal> and
	      <literal>&lt;spamd-white&gt;</literal> are essential.
	      <acronym>SMTP</acronym> traffic from an address listed
	      in <literal>&lt;spamd&gt;</literal> but not in
	      <literal>&lt;spamd-white&gt;</literal> is redirected to
	      the <application>spamd</application> daemon listening at
	      port 8025.</para>
	  </step>

	  <step>
	    <para xml:lang="en">The next step is to configure
	      <application>spamd</application> in
	      <filename>/usr/local/etc/spamd.conf</filename> and to
	      add some <filename>rc.conf</filename> parameters.</para>

	    <para xml:lang="en">The installation of <package>mail/spamd</package>
	      includes a sample configuration file
	      (<filename>/usr/local/etc/spamd.conf.sample</filename>)
	      and a man page for <filename>spamd.conf</filename>.
	      Refer to these for additional configuration options
	      beyond those shown in this example.</para>

	    <para xml:lang="en">One of the first lines in the configuration file
	      that does not begin with a <literal>#</literal> comment
	      sign contains the block which defines the
	      <literal>all</literal> list, which specifies the lists
	      to use:</para>

	    <programlisting xml:lang="en">all:\
    :traplist:whitelist:</programlisting>

	    <para xml:lang="en">This entry adds the desired blacklists, separated by
	      colons (<literal>:</literal>).  To use a whitelist to
	      subtract addresses from a blacklist, add the name of the
	      whitelist <emphasis>immediately</emphasis> after the
	      name of that blacklist.  For example:
	      <literal>:blacklist:whitelist:</literal>.</para>

	    <para xml:lang="en">This is followed by the specified blacklist's
	      definition:</para>

	    <programlisting xml:lang="en">traplist:\
    :black:\
    :msg="SPAM. Your address %A has sent spam within the last 24 hours":\
    :method=http:\
    :file=www.openbsd.org/spamd/traplist.gz</programlisting>

	    <para xml:lang="en">where the first line is the name of the blacklist
	      and the second line specifies the list type.  The
	      <literal>msg</literal> field contains the message to
	      display to blacklisted senders during the
	      <acronym>SMTP</acronym> dialogue.  The
	      <literal>method</literal> field specifies how
	      <application>spamd-setup</application> fetches the list
	      data; supported methods are <literal>http</literal>,
	      <literal>ftp</literal>, from a
	      <literal>file</literal> in a mounted file system, and
	      via <literal>exec</literal> of an external program.
	      Finally, the <literal>file</literal> field specifies
	      the name of the file <application>spamd</application>
	      expects to receive.</para>

	    <para xml:lang="en">The definition of the specified whitelist is
	      similar, but omits the <literal>msg</literal> field
	      since a message is not needed:</para>

	    <programlisting xml:lang="en">whitelist:\
    :white:\
    :method=file:\
    :file=/var/mail/whitelist.txt</programlisting>

	    <tip>
	      <title xml:lang="en">Choose Data Sources with Care</title>

	      <para xml:lang="en">Using all the blacklists in the sample
		<filename>spamd.conf</filename> will blacklist large
		blocks of the Internet.  Administrators need to edit
		the file to create an optimal configuration which uses
		applicable data sources and, when necessary, uses
		custom lists.</para>
	    </tip>

	    <para xml:lang="en">Next, add this entry to
	      <filename>/etc/rc.conf</filename>.  Additional flags are
	      described in the man page specified by the
	      comment:</para>

	    <programlisting xml:lang="en">spamd_flags="-v" # use "" and see spamd-setup(8) for flags</programlisting>

	    <para xml:lang="en">When finished, reload the ruleset, start
	      <application>spamd</application> by typing
	      <command>service obspamd start</command>, and complete
	      the configuration using <command>spamd-setup</command>.
	      Finally, create a <citerefentry><refentrytitle>cron</refentrytitle><manvolnum>8</manvolnum></citerefentry> job which calls
	      <command>spamd-setup</command> to update the tables at
	      reasonable intervals.</para>
	  </step>
	</procedure>

	<para xml:lang="en">On a typical gateway in front of a mail server, hosts
	  will soon start getting trapped within a few seconds to
	  several minutes.</para>

	<para xml:lang="en"><application>PF</application> also supports
	  <firstterm>greylisting</firstterm>, which temporarily
	  rejects messages from unknown hosts with
	  <replaceable>45n</replaceable> codes.  Messages from
	  greylisted hosts which try again within a reasonable time
	  are let through.  Traffic from senders which are set up to
	  behave within the limits set by RFC 1123 and RFC 2821 are
	  immediately let through.</para>

	<para xml:lang="en">More information about greylisting as a technique can be
	  found at the <link xlink:href="http://www.greylisting.org/">greylisting.org</link>
	  web site.  The most amazing thing about greylisting, apart
	  from its simplicity, is that it still works.  Spammers and
	  malware writers have been very slow to adapt to bypass this
	  technique.</para>

	<para xml:lang="en">The basic procedure for configuring greylisting is as
	  follows:</para>

	<procedure>
	  <title xml:lang="en">Configuring Greylisting</title>

	  <step>
	    <para xml:lang="en">Make sure that <citerefentry><refentrytitle>fdescfs</refentrytitle><manvolnum>5</manvolnum></citerefentry> is mounted as
	      described in Step 1 of the previous Procedure.</para>
	  </step>

	  <step>
	    <para xml:lang="en">To run <application>spamd</application> in
	      greylisting mode, add this line to
	      <filename>/etc/rc.conf</filename>:</para>

	    <programlisting xml:lang="en">spamd_grey="YES"  # use spamd greylisting if YES</programlisting>

	    <para xml:lang="en">Refer to the <application>spamd</application> man
	      page for descriptions of additional related
	      parameters.</para>
	  </step>

	  <step>
	    <para xml:lang="en">To complete the greylisting setup:</para>

	    <programlisting xml:lang="en"><prompt>#</prompt> <userinput>service obspamd restart</userinput>
<prompt>#</prompt> <userinput>service obspamlogd start</userinput></programlisting>
	  </step>
	</procedure>

	<para xml:lang="en">Behind the scenes, the <application>spamdb</application>
	  database tool and the <application>spamlogd</application>
	  whitelist updater perform essential functions for the
	  greylisting feature.  <application>spamdb</application> is
	  the administrator's main interface to managing the black,
	  grey, and white lists via the contents of the
	  <filename>/var/db/spamdb</filename> database.</para>
      </sect3>

      <sect3 xml:id="pftut-hygiene">
	<title>網路保健</title>

	<para xml:lang="en">This section describes how
	  <literal>block-policy</literal>, <literal>scrub</literal>,
	  and <literal>antispoof</literal> can be used to make the
	  ruleset behave sanely.</para>

	<para xml:lang="en">The <literal>block-policy</literal> is an option which
	  can be set in the <literal>options</literal> part of the
	  ruleset, which precedes the redirection and filtering rules.
	  This option determines which feedback, if any,
	  <application>PF</application> sends to hosts that are
	  blocked by a rule.  The option has two possible values:
	  <literal>drop</literal> drops blocked packets with no
	  feedback, and <literal>return</literal> returns a status
	  code such as
	  <computeroutput>Connection refused</computeroutput>.</para>

	<para xml:lang="en">If not set, the default policy is
	  <literal>drop</literal>.  To change the
	  <literal>block-policy</literal>, specify the desired
	  value:</para>

	<programlisting xml:lang="en">set block-policy return</programlisting>

	<para xml:lang="en">In <application>PF</application>,
	  <literal>scrub</literal> is a keyword which enables network
	  packet normalization.  This process reassembles fragmented
	  packets and drops TCP packets that have invalid flag
	  combinations.  Enabling <literal>scrub</literal> provides a
	  measure of protection against certain kinds of attacks
	  based on incorrect handling of packet fragments.  A number
	  of options are available, but the simplest form is suitable
	  for most configurations:</para>

	<programlisting xml:lang="en">scrub in all</programlisting>

	<para xml:lang="en">Some services, such as <acronym>NFS</acronym>, require
	  specific fragment handling options.  Refer to <link xlink:href="https://home.nuug.no/~peter/pf/en/scrub.html">https://home.nuug.no/~peter/pf/en/scrub.html</link>
	  for more information.</para>

	<para xml:lang="en">This example reassembles fragments, clears the
	  <quote>do not fragment</quote> bit, and sets the maximum
	  segment size to 1440 bytes:</para>

	<programlisting xml:lang="en">scrub in all fragment reassemble no-df max-mss 1440</programlisting>

	<para xml:lang="en">The <literal>antispoof</literal> mechanism protects
	  against activity from spoofed or forged
	  <acronym>IP</acronym> addresses, mainly by blocking packets
	  appearing on interfaces and in directions which are
	  logically not possible.</para>

	<para xml:lang="en">These rules weed out spoofed traffic coming in from the
	  rest of the world as well as any spoofed packets which
	  originate in the local network:</para>

	<programlisting xml:lang="en">antispoof for $ext_if
antispoof for $int_if</programlisting>
      </sect3>

      <sect3 xml:id="pftut-unrouteables">
	<title>處理不可路由 (Non-Routable) 的位址</title>

	<para xml:lang="en">Even with a properly configured gateway to handle
	  network address translation, one may have to compensate for
	  other people's misconfigurations.  A common misconfiguration
	  is to let traffic with non-routable addresses out to the
	  Internet.  Since traffic from non-routeable addresses can
	  play a part in several <acronym>DoS</acronym> attack
	  techniques, consider explicitly blocking traffic from
	  non-routeable addresses from entering the network through
	  the external interface.</para>

	<para xml:lang="en">In this example, a macro containing non-routable
	  addresses is defined, then used in blocking rules.  Traffic
	  to and from these addresses is quietly dropped on the
	  gateway's external
	  interface.</para>

	<programlisting xml:lang="en">martians = "{ 127.0.0.0/8, 192.168.0.0/16, 172.16.0.0/12, \
	      10.0.0.0/8, 169.254.0.0/16, 192.0.2.0/24, \
	      0.0.0.0/8, 240.0.0.0/4 }"

block drop in quick on $ext_if from $martians to any
block drop out quick on $ext_if from any to $martians</programlisting>
      </sect3>
    </sect2>

    <sect2>
      <title>開啟 <application>ALTQ</application></title>

      <para xml:lang="en">On FreeBSD, <application>ALTQ</application> can be used with
	<application>PF</application> to provide Quality of Service
	(<acronym>QOS</acronym>).  Once
	<application>ALTQ</application> is enabled, queues can be
	defined in the ruleset which determine the processing priority
	of outbound packets.</para>

      <para xml:lang="en">Before enabling <application>ALTQ</application>, refer to
	<citerefentry><refentrytitle>altq</refentrytitle><manvolnum>4</manvolnum></citerefentry> to determine if the drivers for the network cards
	installed on the system support it.</para>

      <para xml:lang="en"><application>ALTQ</application> is not available as a
	loadable kernel module.  If the system's interfaces support
	<application>ALTQ</application>, create a custom kernel using
	the instructions in <xref linkend="kernelconfig"/>.  The
	following kernel options are available.  The first is needed
	to enable <application>ALTQ</application>.  At least one of
	the other options is necessary to specify the queueing
	scheduler algorithm:</para>

      <programlisting xml:lang="en">options         ALTQ
options         ALTQ_CBQ        # Class Based Queuing (CBQ)
options         ALTQ_RED        # Random Early Detection (RED)
options         ALTQ_RIO        # RED In/Out
options         ALTQ_HFSC       # Hierarchical Packet Scheduler (HFSC)
options         ALTQ_PRIQ       # Priority Queuing (PRIQ)</programlisting>

      <para xml:lang="en">The following scheduler algorithms are available:</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">CBQ</term>
	  <listitem>
	    <para xml:lang="en">Class Based Queuing (<acronym>CBQ</acronym>) is
	      used to divide a connection's bandwidth into different
	      classes or queues to prioritize traffic based on filter
	      rules.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">RED</term>
	  <listitem>
	    <para xml:lang="en">Random Early Detection (<acronym>RED</acronym>) is
	      used to avoid network congestion by measuring the length
	      of the queue and comparing it to the minimum and maximum
	      thresholds for the queue.  When the queue is over the
	      maximum, all new packets are randomly dropped.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">RIO</term>
	  <listitem>
	    <para xml:lang="en">In Random Early Detection In and Out
	      (<acronym>RIO</acronym>) mode, <acronym>RED</acronym>
	      maintains multiple average queue lengths and multiple
	      threshold values, one for each
	      <acronym>QOS</acronym> level.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">HFSC</term>
	  <listitem>
	    <para xml:lang="en">Hierarchical Fair Service Curve Packet Scheduler
	      (<acronym>HFSC</acronym>) is described in <uri xlink:href="http://www-2.cs.cmu.edu/~hzhang/HFSC/main.html">http://www-2.cs.cmu.edu/~hzhang/HFSC/main.html</uri>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">PRIQ</term>
	  <listitem>
	    <para xml:lang="en">Priority Queuing (<acronym>PRIQ</acronym>) always
	      passes traffic that is in a higher queue first.</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para xml:lang="en">More information about the scheduling
	algorithms and example rulesets are available at the <uri xlink:href="https://web.archive.org/web/20151109213426/http://www.openbsd.org/faq/pf/queueing.html">OpenBSD's web archive</uri>.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="firewalls-ipfw">
    <title xml:lang="en"><application>IPFW</application></title>

    <indexterm xml:lang="en">
      <primary>firewall</primary>

      <secondary>IPFW</secondary>
    </indexterm>

    <para><application>IPFW</application> 是一套專為 FreeBSD 所寫的具狀態防火牆 (Stateful firewall)，它同時支援 <acronym>IPv4</acronym> 與 <acronym>IPv6</acronym>，它由數個元件組成：核心防火牆過濾規則處理器與其整合的封包計帳設施、記錄設施、<acronym>NAT</acronym>、<citerefentry><refentrytitle>dummynet</refentrytitle><manvolnum>4</manvolnum></citerefentry> 流量限制程式、轉送設施、橋接設施以及 ipstealth 設施。</para>

    <para>FreeBSD 提供一個範本規則集於 <filename>/etc/rc.firewall</filename>，其定義了幾個常見情境會使用的防火牆類型來協助初學的使用者撰寫合適的規則集。<application>IPFW</application> 提供了強大的語法讓進階的使用者可以用來自訂符合環境安全性要求的規則集。</para>

    <para>本節將介紹如何開啟 <application>IPFW</application>、規則語法的概要以及示範幾種常見情境所使用的規則集。</para>

    <sect2 xml:id="firewalls-ipfw-enable">
      <title>開啟 <application>IPFW</application></title>

      <indexterm xml:lang="en">
	<primary><application>IPFW</application></primary>

	<secondary>enabling</secondary>
      </indexterm>

      <para xml:lang="en"><application>IPFW</application> is included in the basic
	FreeBSD install as a kernel loadable module, meaning that a
	custom kernel is not needed in order to enable
	<application>IPFW</application>.</para>

      <para xml:lang="en">For those users who wish to statically compile
	<application>IPFW</application> support into a custom kernel,
	see <xref linkend="firewalls-ipfw-kernelconfig"/>.</para>

      <para xml:lang="en">To configure the system to enable
	<application>IPFW</application> at boot time, add
	<literal>firewall_enable="YES"</literal> to
	<filename>/etc/rc.conf</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc firewall_enable="YES"</userinput></screen>

      <para xml:lang="en">To use one of the default firewall types provided by FreeBSD,
	add another line which specifies the type:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc firewall_type="open"</userinput></screen>

      <para xml:lang="en">The available types are:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><literal>open</literal>: passes all traffic.</para>
	</listitem>
	<listitem>
	  <para xml:lang="en"><literal>client</literal>: protects only this
	    machine.</para>
	</listitem>
	<listitem>
	  <para xml:lang="en"><literal>simple</literal>: protects the whole
	    network.</para>
	</listitem>
	<listitem>
	  <para xml:lang="en"><literal>closed</literal>: entirely disables IP
	    traffic except for the loopback interface.</para>
	</listitem>
	<listitem>
	  <para xml:lang="en"><literal>workstation</literal>: protects only this
	    machine using stateful rules.</para>
	</listitem>
	<listitem>
	  <para xml:lang="en"><literal>UNKNOWN</literal>: disables the loading of
	    firewall rules.</para>
	</listitem>
	<listitem>
	  <para xml:lang="en"><filename><replaceable>filename</replaceable></filename>:
	    full path of the file containing the firewall
	    ruleset.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">If <literal>firewall_type</literal> is set to either
	<literal>client</literal> or <literal>simple</literal>,
	modify the default rules found in
	<filename>/etc/rc.firewall</filename> to fit the
	configuration of the system.</para>

      <para xml:lang="en">Note that the <literal>filename</literal> type is used to
	load a custom ruleset.</para>

      <para xml:lang="en">An alternate way to load a custom ruleset is to set the
	<literal>firewall_script</literal> variable to the absolute
	path of an <emphasis>executable script</emphasis> that
	includes <application>IPFW</application> commands.    The
	examples used in this section assume that the
	<literal>firewall_script</literal> is set to
	<filename>/etc/ipfw.rules</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc firewall_script="/etc/ipfw.rules"</userinput></screen>

      <para xml:lang="en">To enable logging through <citerefentry><refentrytitle>syslogd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, include this
	line:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc firewall_logging="YES"</userinput></screen>

      <warning>
	<para xml:lang="en">Only firewall rules with the <option>log</option> option will
	  be logged.  The default rules do not include this option and it
	  must be manually added.  Therefore it is advisable that the default
	  ruleset is edited for logging.  In addition, log rotation may be
	  desired if the logs are stored in a separate file.</para>
      </warning>

      <para xml:lang="en">There is no <filename>/etc/rc.conf</filename> variable to
	set logging limits.  To limit the number of times a rule is
	logged per connection attempt, specify the number using this
	line in <filename>/etc/sysctl.conf</filename>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>echo "net.inet.ip.fw.verbose_limit=<replaceable>5</replaceable>" &gt;&gt; /etc/sysctl.conf</userinput></screen>

      <para xml:lang="en">To enable logging through a dedicated interface named
	<literal>ipfw0</literal>, add this line to
	<filename>/etc/rc.conf</filename> instead:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc firewall_logif="YES"</userinput></screen>

      <para xml:lang="en">Then use <application>tcpdump</application> to see what is
	being logged:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>tcpdump -t -n -i ipfw0</userinput></screen>

      <tip>
	<para xml:lang="en">There is no overhead due to logging unless
	  <application>tcpdump</application> is attached.</para>
      </tip>

      <para xml:lang="en">After saving the needed edits, start the firewall.  To
	enable logging limits now, also set the
	<command>sysctl</command> value specified above:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service ipfw start</userinput>
<prompt>#</prompt> <userinput>sysctl net.inet.ip.fw.verbose_limit=<replaceable>5</replaceable></userinput></screen>
    </sect2>

    <sect2 xml:id="firewalls-ipfw-rules">
      <title><application>IPFW</application> 規則語法</title>

      <indexterm xml:lang="en">
	<primary><application>IPFW</application></primary>

	<secondary>rule processing order</secondary>
      </indexterm>

      <para xml:lang="en">When a packet enters the <application>IPFW</application>
	firewall, it is compared against the first rule in the ruleset
	and progresses one rule at a time, moving from top to bottom
	in sequence.  When the packet matches the selection parameters
	of a rule, the rule's action is executed and the search of the
	ruleset terminates for that packet.  This is referred to as
	<quote>first match wins</quote>.  If the packet does not match
	any of the rules, it gets caught by the mandatory
	<application>IPFW</application> default rule number 65535,
	which denies all packets and silently discards them.  However,
	if the packet matches a rule that contains the
	<literal>count</literal>, <literal>skipto</literal>, or
	<literal>tee</literal> keywords, the search continues.  Refer
	to <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry> for details on how these keywords affect rule
	processing.</para>

      <indexterm xml:lang="en">
	<primary><application>IPFW</application></primary>

	<secondary>rule syntax</secondary>
      </indexterm>

      <para xml:lang="en">When creating an
	<application>IPFW</application> rule, keywords must be
	written in the following order.  Some keywords are mandatory
	while other keywords are optional.  The words shown in
	uppercase represent a variable and the words shown in
	lowercase must precede the variable that follows it.  The
	<literal>#</literal> symbol is used to mark the start of a
	comment and may appear at the end of a rule or on its own
	line.  Blank lines are ignored.</para>

      <para xml:lang="en"><replaceable>CMD RULE_NUMBER set SET_NUMBER ACTION log
	  LOG_AMOUNT PROTO from SRC SRC_PORT to DST DST_PORT
	  OPTIONS</replaceable></para>

      <para xml:lang="en">This section provides an overview of these keywords and
	their options.  It is not an exhaustive list of every possible
	option.  Refer to <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry> for a complete description of
	the rule syntax that can be used when creating
	<application>IPFW</application> rules.</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">CMD</term>
	  <listitem>
	    <para xml:lang="en">Every rule must start with
	      <parameter>ipfw add</parameter>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">RULE_NUMBER</term>
	  <listitem>
	    <para xml:lang="en">Each rule is associated with a number from
	      <literal>1</literal> to
	      <literal>65534</literal>.  The number is used to
	      indicate the order of rule processing.  Multiple rules
	      can have the same number, in which case they are applied
	      according to the order in which they have been
	      added.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">SET_NUMBER</term>
	  <listitem>
	    <para xml:lang="en">Each rule is associated with a set number from
	      <literal>0</literal> to <literal>31</literal>.
	      Sets can be individually disabled or enabled, making it
	      possible to quickly add or delete a set of rules.  If a
	      SET_NUMBER is not specified, the rule will be added to
	      set <literal>0</literal>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">ACTION</term>
	  <listitem>
	    <para xml:lang="en">A rule can be associated with one of the following
	      actions.  The specified action will be executed when the
	      packet matches the selection criterion of the
	      rule.</para>

	    <para xml:lang="en"><parameter>allow | accept | pass |
		permit</parameter>: these keywords are equivalent and
	      allow packets that match the rule.</para>

	    <para xml:lang="en"><parameter>check-state</parameter>: checks the
	      packet against the dynamic state table.  If a match is
	      found, execute the action associated with the rule which
	      generated this dynamic rule, otherwise move to the next
	      rule.  A <literal>check-state</literal> rule does not
	      have selection criterion.  If no
	      <literal>check-state</literal> rule is present in the
	      ruleset, the dynamic rules table is checked at the first
	      <literal>keep-state</literal> or
	      <literal>limit</literal> rule.</para>

	    <para xml:lang="en"><parameter>count</parameter>: updates counters for
	      all packets that match the rule.  The search continues
	      with the next rule.</para>

	    <para xml:lang="en"><parameter>deny | drop</parameter>: either word
	      silently discards packets that match this rule.</para>

	    <para xml:lang="en">Additional actions are available.  Refer to
	      <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry> for details.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">LOG_AMOUNT</term>
	  <listitem>
	    <para xml:lang="en">When a packet matches a rule with the
	      <literal>log</literal> keyword, a message will be logged
	      to <citerefentry><refentrytitle>syslogd</refentrytitle><manvolnum>8</manvolnum></citerefentry> with a facility name of
	      <literal>SECURITY</literal>.  Logging only occurs if the
	      number of packets logged for that particular rule does
	      not exceed a specified LOG_AMOUNT.  If no
	      LOG_AMOUNT is specified, the limit is taken from the
	      value of
	      <varname>net.inet.ip.fw.verbose_limit</varname>.  A
	      value of zero removes the logging limit.  Once the limit
	      is reached, logging can be re-enabled by clearing the
	      logging counter or the packet counter for that rule,
	      using <command>ipfw resetlog</command>.</para>

	    <note>
	      <para xml:lang="en">Logging is done after all other packet matching
		conditions have been met, and before performing the
		final action on the packet.  The administrator decides
		which rules to enable logging on.</para>
	    </note>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">PROTO</term>
	  <listitem>
	    <para xml:lang="en">This optional value can be used to specify any
	      protocol name or number found in
	      <filename>/etc/protocols</filename>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">SRC</term>
	  <listitem>
	    <para xml:lang="en">The <literal>from</literal> keyword must be followed
	      by the source address or a keyword that represents the
	      source address.  An address can be represented by
	      <literal>any</literal>, <literal>me</literal> (any
	      address configured on an interface on this system),
	      <literal>me6</literal>, (any <acronym>IPv6</acronym>
	      address configured on an interface on this system), or
	      <literal>table</literal> followed by the number of a
	      lookup table which contains a list of addresses.  When
	      specifying an <acronym>IP</acronym> address, it can be
	      optionally followed by its <acronym>CIDR</acronym> mask
	      or subnet mask.  For example,
	      <literal>1.2.3.4/25</literal> or
	      <literal>1.2.3.4:255.255.255.128</literal>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">SRC_PORT</term>
	  <listitem>
	    <para xml:lang="en">An optional source port can be specified using the
	      port number or name from
	      <filename>/etc/services</filename>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">DST</term>
	  <listitem>
	    <para xml:lang="en">The <literal>to</literal> keyword must be followed
	      by the destination address or a keyword that represents
	      the destination address.  The same keywords and
	      addresses described in the SRC section can be used to
	      describe the destination.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">DST_PORT</term>
	  <listitem>
	    <para xml:lang="en">An optional destination port can be specified using
	      the port number or name from
	      <filename>/etc/services</filename>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">OPTIONS</term>
	  <listitem>
	    <para xml:lang="en">Several keywords can follow the source and
	      destination.  As the name suggests, OPTIONS are
	      optional.  Commonly used options include
	      <literal>in</literal> or <literal>out</literal>, which
	      specify the direction of packet flow,
	      <literal>icmptypes</literal> followed by the type of
	      <acronym>ICMP</acronym> message, and
	      <literal>keep-state</literal>.</para>

	    <para xml:lang="en">When a <parameter>keep-state</parameter> rule is
	      matched, the firewall will create a dynamic rule which
	      matches bidirectional traffic between the source and
	      destination addresses and ports using the same
	      protocol.</para>

	    <para xml:lang="en">The dynamic rules facility is vulnerable to resource
	      depletion from a SYN-flood attack which would open a
	      huge number of dynamic rules.  To counter this type of
	      attack with  <application>IPFW</application>, use
	      <literal>limit</literal>.  This option limits the number
	      of simultaneous sessions by checking the open dynamic
	      rules, counting the number of times this rule and
	      <acronym>IP</acronym> address combination occurred.  If
	      this count is greater than the value specified by
	      <literal>limit</literal>, the packet is
	      discarded.</para>

	    <para xml:lang="en">Dozens of OPTIONS are available.  Refer to
	      <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry> for a description of each available
	      option.</para>
	  </listitem>
	</varlistentry>
      </variablelist>
    </sect2>

    <sect2>
      <title>範例規則集</title>

      <para xml:lang="en">This section demonstrates how to create an example
	stateful firewall ruleset script named
	<filename>/etc/ipfw.rules</filename>.  In this example, all
	connection rules use <literal>in</literal> or
	<literal>out</literal> to clarify the direction.  They also
	use <literal>via</literal>
	<replaceable>interface-name</replaceable> to specify
	the interface the packet is traveling over.</para>

      <note>
	<para xml:lang="en">When first creating or testing a firewall ruleset,
	  consider temporarily setting this tunable:</para>

	<programlisting xml:lang="en">net.inet.ip.fw.default_to_accept="1"</programlisting>

	<para xml:lang="en">This sets the default policy of <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry> to be more
	  permissive than the default <literal>deny ip from any to
	    any</literal>, making it slightly more difficult to get
	  locked out of the system right after a reboot.</para>
      </note>

      <para xml:lang="en">The firewall script begins by indicating that it is a
	Bourne shell script and flushes any existing rules.  It then
	creates the <literal>cmd</literal> variable so that
	<literal>ipfw add</literal> does not have to be typed at the
	beginning of every rule.  It also defines the
	<literal>pif</literal> variable which represents the name of
	the interface that is attached to the Internet.</para>

      <programlisting xml:lang="en">#!/bin/sh
# Flush out the list before we begin.
ipfw -q -f flush

# Set rules command prefix
cmd="ipfw -q add"
pif="dc0"     # interface name of NIC attached to Internet</programlisting>

      <para xml:lang="en">The first two rules allow all traffic on the trusted
	internal interface and on the loopback interface:</para>

      <programlisting xml:lang="en"># Change xl0 to LAN NIC interface name
$cmd 00005 allow all from any to any via xl0

# No restrictions on Loopback Interface
$cmd 00010 allow all from any to any via lo0</programlisting>

      <para xml:lang="en">The next rule allows the packet through if it matches an
	existing entry in the dynamic rules table:</para>

      <programlisting xml:lang="en">$cmd 00101 check-state</programlisting>

      <para xml:lang="en">The next set of rules defines which stateful connections
	internal systems can create to hosts on the Internet:</para>

      <programlisting xml:lang="en"># Allow access to public DNS
# Replace x.x.x.x with the IP address of a public DNS server
# and repeat for each DNS server in /etc/resolv.conf
$cmd 00110 allow tcp from any to x.x.x.x 53 out via $pif setup keep-state
$cmd 00111 allow udp from any to x.x.x.x 53 out via $pif keep-state

# Allow access to ISP's DHCP server for cable/DSL configurations.
# Use the first rule and check log for IP address.
# Then, uncomment the second rule, input the IP address, and delete the first rule
$cmd 00120 allow log udp from any to any 67 out via $pif keep-state
#$cmd 00120 allow udp from any to x.x.x.x 67 out via $pif keep-state

# Allow outbound HTTP and HTTPS connections
$cmd 00200 allow tcp from any to any 80 out via $pif setup keep-state
$cmd 00220 allow tcp from any to any 443 out via $pif setup keep-state

# Allow outbound email connections
$cmd 00230 allow tcp from any to any 25 out via $pif setup keep-state
$cmd 00231 allow tcp from any to any 110 out via $pif setup keep-state

# Allow outbound ping
$cmd 00250 allow icmp from any to any out via $pif keep-state

# Allow outbound NTP
$cmd 00260 allow udp from any to any 123 out via $pif keep-state

# Allow outbound SSH
$cmd 00280 allow tcp from any to any 22 out via $pif setup keep-state

# deny and log all other outbound connections
$cmd 00299 deny log all from any to any out via $pif</programlisting>

      <para xml:lang="en">The next set of rules controls connections from Internet
	hosts to the internal network.  It starts by denying packets
	typically associated with attacks and then explicitly allows
	specific types of connections.  All the authorized services
	that originate from the Internet use <literal>limit</literal>
	to prevent flooding.</para>

      <programlisting xml:lang="en"># Deny all inbound traffic from non-routable reserved address spaces
$cmd 00300 deny all from 192.168.0.0/16 to any in via $pif     #RFC 1918 private IP
$cmd 00301 deny all from 172.16.0.0/12 to any in via $pif      #RFC 1918 private IP
$cmd 00302 deny all from 10.0.0.0/8 to any in via $pif         #RFC 1918 private IP
$cmd 00303 deny all from 127.0.0.0/8 to any in via $pif        #loopback
$cmd 00304 deny all from 0.0.0.0/8 to any in via $pif          #loopback
$cmd 00305 deny all from 169.254.0.0/16 to any in via $pif     #DHCP auto-config
$cmd 00306 deny all from 192.0.2.0/24 to any in via $pif       #reserved for docs
$cmd 00307 deny all from 204.152.64.0/23 to any in via $pif    #Sun cluster interconnect
$cmd 00308 deny all from 224.0.0.0/3 to any in via $pif        #Class D &amp; E multicast

# Deny public pings
$cmd 00310 deny icmp from any to any in via $pif

# Deny ident
$cmd 00315 deny tcp from any to any 113 in via $pif

# Deny all Netbios services.
$cmd 00320 deny tcp from any to any 137 in via $pif
$cmd 00321 deny tcp from any to any 138 in via $pif
$cmd 00322 deny tcp from any to any 139 in via $pif
$cmd 00323 deny tcp from any to any 81 in via $pif

# Deny fragments
$cmd 00330 deny all from any to any frag in via $pif

# Deny ACK packets that did not match the dynamic rule table
$cmd 00332 deny tcp from any to any established in via $pif

# Allow traffic from ISP's DHCP server.
# Replace x.x.x.x with the same IP address used in rule 00120.
#$cmd 00360 allow udp from any to x.x.x.x 67 in via $pif keep-state

# Allow HTTP connections to internal web server
$cmd 00400 allow tcp from any to me 80 in via $pif setup limit src-addr 2

# Allow inbound SSH connections
$cmd 00410 allow tcp from any to me 22 in via $pif setup limit src-addr 2

# Reject and log all other incoming connections
$cmd 00499 deny log all from any to any in via $pif</programlisting>

      <para xml:lang="en">The last rule logs all packets that do not match any of
	the rules in the ruleset:</para>

      <programlisting xml:lang="en"># Everything else is denied and logged
$cmd 00999 deny log all from any to any</programlisting>
    </sect2>

    <sect2 xml:id="in-kernel-nat">
      <info>
	<title>核心內 <acronym>NAT</acronym></title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Chern</firstname>
	      <surname>Lee</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Dries</firstname>
	      <surname>Michiels</surname>
	    </personname>
	    <contrib>Rewritten and updated by </contrib>
	  </author>
	</authorgroup>
      </info>

      <indexterm xml:lang="en">
	<primary>NAT</primary>

	<secondary>and <application>IPFW</application></secondary>
      </indexterm>

      <para xml:lang="en">FreeBSD's <application>IPFW</application> firewall has two
	implementations of <acronym>NAT</acronym>: one being the
	userland <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon, and the more recent
	<application>IPFW</application>'s built-in
	<acronym>NAT</acronym> facility also known as in-kernel
	<acronym>NAT</acronym>.  Both work in conjunction with
	<application>IPFW</application> to provide network address
	translation.  This can be used to provide an Internet
	Connection Sharing solution so that several internal computers
	can connect to the Internet using a single public
	<acronym>IP</acronym> address.</para>

      <para xml:lang="en">To do this, the FreeBSD machine connected to the Internet
	must act as a gateway.  This system must have two
	<acronym>NIC</acronym>s, where one is connected to the
	Internet and the other is connected to the internal
	<acronym>LAN</acronym>.  Each machine connected to the
	<acronym>LAN</acronym> should be assigned an
	<acronym>IP</acronym> address in the private network space, as
	defined by <link xlink:href="https://www.ietf.org/rfc/rfc1918.txt">RFC
	1918</link>.</para>

      <para xml:lang="en">Some additional configuration is needed in order to enable
	the in-kernel <acronym>NAT</acronym> function of
	<application>IPFW</application>.  To enable in-kernel
	<acronym>NAT</acronym> support at boot time, the following
	must be set in <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">gateway_enable="YES"
firewall_enable="YES"
firewall_nat_enable="YES"</programlisting>

      <note>
	<para xml:lang="en">When <literal>firewall_enable</literal> is not set,
	  but <literal>firewall_nat_enable</literal> is, it will have
	  no effect and do nothing, because the in-kernel
	  <acronym>NAT</acronym> implementation is only compatible
	  with <application>IPFW</application>.</para></note>

      <para xml:lang="en">When the ruleset contains stateful rules, the positioning
	of the <acronym>NAT</acronym> rule is critical and the
	<literal>skipto</literal> action is used.  The
	<literal>skipto</literal> action requires a rule number so
	that it knows which rule to jump to.  Furthermore, because
	of the architecture of <citerefentry><refentrytitle>libalias</refentrytitle><manvolnum>3</manvolnum></citerefentry>, a library implemented
	as a kernel module used for the in-kernel
	<acronym>NAT</acronym> facility of
	<application>IPFW</application>, it is necessary to disable
	TCP segmentation offloading, or in short
	<acronym>TSO</acronym>.  <acronym>TSO</acronym> can be
	disabled on a per network interface basis by using
	<citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> or on a system wide basis using
	<citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  To disable <acronym>TSO</acronym> system
	wide, the following must be set in
	<filename>/etc/sysctl.conf</filename>:</para>

      <programlisting xml:lang="en">net.inet.tcp.tso="0"</programlisting>

      <para xml:lang="en">The example below builds upon the firewall ruleset
	shown in the previous section.  It adds some additional
	entries and modifies some existing rules in order to configure
	the firewall for in-kernel <acronym>NAT</acronym>.  It starts
	by adding some additional variables which represent the rule
	number to skip to, the <literal>keep-state</literal> option,
	and a list of <acronym>TCP</acronym> ports which will be used
	to reduce the number of rules.</para>

      <programlisting xml:lang="en">#!/bin/sh
ipfw -q -f flush
cmd="ipfw -q add"
skip="skipto 1000"
pif=dc0
ks="keep-state"
good_tcpo="22,25,37,53,80,443,110"</programlisting>

      <para xml:lang="en">A <acronym>NAT</acronym> instance will also be
	configured.  With in-kernel <acronym>NAT</acronym> it is
	possible to have multiple <acronym>NAT</acronym> instances
	each with their own configuration.  Although, for this example
	only one <acronym>NAT</acronym> instance is needed;
	<acronym>NAT</acronym> instance number 1.  The configuration
	takes a few arguments and flags such as: <option>if</option>
	which indicates the public interface,
	<option>same_ports</option> which takes care that alliased
	ports and local port numbers are mapped the same,
	<option>unreg_only</option> will result in only unregistered
	(private) address spaces to be processed by the
	<acronym>NAT</acronym> instance, and <option>reset</option>
	which will help to keep a functioning <acronym>NAT</acronym>
	instance even when the public <acronym>IP</acronym> address of
	the <application>IPFW</application> machine changes.  For all
	possible options that can be passed to a single
	<acronym>NAT</acronym> instance configuration consult
	<citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  Furthermore, because of the nature of a
	stateful <acronym>NAT</acronym>ing firewall, it is neseccary
	to allow translated packets to be reinjected in the firewall
	for further processing, this can be achieved by disabling
	<option>one_pass</option> behavior at the start of the
	firewall script.</para>

      <programlisting xml:lang="en">ipfw disable one_pass
ipfw -q nat 1 config if $pif same_ports unreg_only reset</programlisting>

      <para xml:lang="en">The inbound <acronym>NAT</acronym> rule is inserted
	<emphasis>after</emphasis> the two rules which allow all
	traffic on the trusted and loopback interfaces and after the
	reassamble rule but <emphasis>before</emphasis> the
	<literal>check-state</literal> rule.  It is important that the
	rule number selected for this <acronym>NAT</acronym> rule, in
	this example <literal>100</literal>, is higher than the first
	three rules and lower than the <literal>check-state</literal>
	rule.  Furthermore, because of the behavior of in-kernel
	<acronym>NAT</acronym> it is advised to place a reassamble
	rule just before the first <acronym>NAT</acronym> rule and
	after the rules that allow traffic on trusted interface.
	Normally, <acronym>IP</acronym> fragmentation should not
	happen, but when dealing with <acronym>IPSEC/ESP/GRE</acronym>
	tunneling traffic it might and the reassmabling of fragments
	is necessary before handing the complete packet over to the
	in-kernel <acronym>NAT</acronym> engine.</para>

      <note>
	<para xml:lang="en">The reassemble rule was not needed with userland
	  <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry> because the internal workings of the
	  <application>IPFW</application> <literal>divert</literal>
	  action already takes care of this automatically as also
	  stated in <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

	<para xml:lang="en">The current <acronym>NAT</acronym> instance number and
	  <acronym>NAT</acronym> rule number does not match with the
	  default <acronym>NAT</acronym> instance number and rule
	  number created by <filename>rc.firewall</filename> which is
	  a script to set up the baked-in default firewall rulesets
	  present in FreeBSD.</para></note>

      <programlisting xml:lang="en">$cmd 005 allow all from any to any via xl0  # exclude LAN traffic
$cmd 010 allow all from any to any via lo0  # exclude loopback traffic
$cmd 099 reass all from any to any in       # reassamble inbound packets
$cmd 100 nat 1 ip from any to any in via $pif # NAT any inbound packets
# Allow the packet through if it has an existing entry in the dynamic rules table
$cmd 101 check-state</programlisting>

      <para xml:lang="en">The outbound rules are modified to replace the
	<literal>allow</literal> action with the
	<literal>$skip</literal> variable, indicating that rule
	processing will continue at rule <literal>1000</literal>.  The
	seven <literal>tcp</literal> rules have been replaced by rule
	<literal>125</literal> as the
	<literal>$good_tcpo</literal> variable contains the
	seven allowed outbound ports.</para>

      <note>
	<para xml:lang="en">Remember that <application>IPFW</application>'s
	  firewall performance is largely determined by the number of
	  rules present in the ruleset.</para></note>

      <programlisting xml:lang="en"># Authorized outbound packets
$cmd 120 $skip udp from any to x.x.x.x 53 out via $pif $ks
$cmd 121 $skip udp from any to x.x.x.x 67 out via $pif $ks
$cmd 125 $skip tcp from any to any $good_tcpo out via $pif setup $ks
$cmd 130 $skip icmp from any to any out via $pif $ks</programlisting>

      <para xml:lang="en">The inbound rules remain the same, except for the very
	last rule which removes the <literal>via $pif</literal> in
	order to catch both inbound and outbound rules.  The
	<acronym>NAT</acronym> rule must follow this last outbound
	rule, must have a higher number than that last rule, and the
	rule number must be referenced by the
	<literal>skipto</literal> action.  In this ruleset, rule
	number <literal>1000</literal> handles passing all packets to
	our configured instance for <acronym>NAT</acronym> processing.
	The next rule allows any packet which has undergone
	<acronym>NAT</acronym> processing to pass.</para>

      <programlisting xml:lang="en">$cmd 999 deny log all from any to any
$cmd 1000 nat 1 ip from any to any out via $pif # skipto location for outbound stateful rules
$cmd 1001 allow ip from any to any</programlisting>

      <para xml:lang="en">In this example, rules <literal>100</literal>,
	<literal>101</literal>, <literal>125</literal>,
	<literal>1000</literal>, and <literal>1001</literal> control
	the address translation of the outbound and inbound packets so
	that the entries in the dynamic state table always register
	the private <acronym>LAN</acronym> <acronym>IP</acronym>
	address.</para>

      <para xml:lang="en">Consider an internal web browser which initializes a new
	outbound <acronym>HTTP</acronym> session over port 80.  When
	the first outbound packet enters the firewall, it does not
	match rule <literal>100</literal> because it is headed out
	rather than in.  It passes rule <literal>101</literal> because
	this is the first packet and it has not been posted to the
	dynamic state table yet.  The packet finally matches rule
	<literal>125</literal> as it is outbound on an allowed port
	and has a source <acronym>IP</acronym> address from the
	internal <acronym>LAN</acronym>.  On matching this rule, two
	actions take place.  First, the <literal>keep-state</literal>
	action adds an entry to the dynamic state table and the
	specified action, <literal>skipto rule 1000</literal>, is
	executed.  Next, the packet undergoes <acronym>NAT</acronym>
	and is sent out to the Internet.  This packet makes its way to
	the destination web server, where a response packet is
	generated and sent back.  This new packet enters the top of
	the ruleset.  It matches rule <literal>100</literal> and has
	its destination <acronym>IP</acronym> address mapped back to
	the original internal address.  It then is processed by the
	<literal>check-state</literal> rule, is found in the table as
	an existing session, and is released to the
	<acronym>LAN</acronym>.</para>

      <para xml:lang="en">On the inbound side, the ruleset has to deny bad packets
	and allow only authorized services.  A packet which matches an
	inbound rule is posted to the dynamic state table and the
	packet is released to the <acronym>LAN</acronym>.  The packet
	generated as a response is recognized by the
	<literal>check-state</literal> rule as belonging to an
	existing session.  It is then sent to rule
	<literal>1000</literal> to undergo
	<acronym>NAT</acronym> before being released to the outbound
	interface.</para>

      <note>
	<para xml:lang="en">Transition from userland <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry> to in-kernel
	  <acronym>NAT</acronym> might seem seamless at first but
	  there is small catch.  When using the GENERIC kernel,
	  <application>IPFW</application> will load the
	  <filename>libalias.ko</filename>
	  kernel module, when <literal>firewall_nat_enable</literal>
	  is enabled in <filename>rc.conf</filename>.  Although, the
	  loaded module only provides basic <acronym>NAT</acronym>
	  functionality, whereas the userland implementation
	  <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry> has all functionality available without any
	  extra configuration from its userland library.  All
	  functionality refers to the following kernel modules that
	  can additionally be loaded when needed besides the standard
	  <filename>libalias.ko</filename> kernel module:
	  <filename>alias_cuseeme.ko</filename>,
	  <filename>alias_ftp.ko</filename>,
	  <filename>alias_bbt.ko</filename>,
	  <filename>skinny.ko</filename>, <filename>irc.ko</filename>,
	  <filename>alias_pptp.ko</filename> and
	  <filename>alias_smedia.ko</filename> using the
	  <literal>kld_list</literal> directive in
	  <filename>rc.conf</filename> to mimic the full functionality
	  of the userland implementation.  If a custom kernel is used,
	  the full functionality of the userland library can be
	  compiled in, in the kernel, using the <option>option
	  LIBALIAS</option>.</para></note>

      <sect3>
	<title>Port 重新導向</title>

	<para xml:lang="en">The drawback with <acronym>NAT</acronym> in general is
	  that the <acronym>LAN</acronym> clients are not accessible
	  from the Internet.  Clients on the <acronym>LAN</acronym>
	  can make outgoing connections to the world but cannot
	  receive incoming ones.  This presents a problem if trying to
	  run Internet services on one of the <acronym>LAN</acronym>
	  client machines.  A simple way around this is to redirect
	  selected Internet ports on the <acronym>NAT</acronym>
	  providing machine to a <acronym>LAN</acronym> client.</para>

	<para xml:lang="en">For example, an <acronym>IRC</acronym> server runs on
	  client <systemitem>A</systemitem> and a web server runs on
	  client <systemitem>B</systemitem>.  For this to work
	  properly, connections received on ports 6667
	  (<acronym>IRC</acronym>) and 80 (<acronym>HTTP</acronym>)
	  must be redirected to the respective machines.</para>

	<para xml:lang="en">With in-kernel <acronym>NAT</acronym> all configuration
	  is done in the <acronym>NAT</acronym> instance
	  configuration.  For a full list of options that an in-kernel
	  <acronym>NAT</acronym> instance can use, consult
	  <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  The <application>IPFW</application> syntax
	  follows the syntax of <application>natd</application>.  The
	  syntax for <option>redirect_port</option> is as
	  follows:</para>

	<programlisting xml:lang="en">redirect_port proto targetIP:targetPORT[-targetPORT]
  [aliasIP:]aliasPORT[-aliasPORT]
  [remoteIP[:remotePORT[-remotePORT]]]</programlisting>

	<para xml:lang="en">To configure the above example setup, the arguments
	should be:</para>

	<programlisting xml:lang="en">redirect_port tcp 192.168.0.2:6667 6667
redirect_port tcp 192.168.0.3:80 80</programlisting>

	<para xml:lang="en">After adding these arguments to the configuration of
	  <acronym>NAT</acronym> instance 1 in the above ruleset, the
	  <acronym>TCP</acronym> ports will be port forwarded to the
	  <acronym>LAN</acronym> client machines running the
	  <acronym>IRC</acronym> and <acronym>HTTP</acronym>
	  services.</para>

	<programlisting xml:lang="en">ipfw -q nat 1 config if $pif same_ports unreg_only reset \
  redirect_port tcp 192.168.0.2:6667 6667 \
  redirect_port tcp 192.1683.0.3:80 80</programlisting>

	<para xml:lang="en">Port ranges over individual ports can be indicated with
	  <option>redirect_port</option>.  For example,
	  <replaceable>tcp 192.168.0.2:2000-3000
	  2000-3000</replaceable> would redirect all connections
	  received on ports 2000 to 3000 to ports 2000 to 3000 on
	  client <systemitem>A</systemitem>.</para>
      </sect3>

      <sect3>
	<title>位址重新導向</title>

	<para xml:lang="en">Address redirection is useful if more than one
	  <acronym>IP</acronym> address is available.  Each
	  <acronym>LAN</acronym> client can be assigned its own
	  external <acronym>IP</acronym> address by <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
	  which will then rewrite outgoing packets from the
	  <acronym>LAN</acronym> clients with the proper external
	  <acronym>IP</acronym> address and redirects all traffic
	  incoming on that particular <acronym>IP</acronym> address
	  back to the specific <acronym>LAN</acronym> client.  This is
	  also known as static <acronym>NAT</acronym>.  For example,
	  if <acronym>IP</acronym> addresses <systemitem class="ipaddress">128.1.1.1</systemitem>, <systemitem class="ipaddress">128.1.1.2</systemitem>, and <systemitem class="ipaddress">128.1.1.3</systemitem> are available,
	  <systemitem class="ipaddress">128.1.1.1</systemitem> can be
	  used as the <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry> machine's external
	  <acronym>IP</acronym> address, while <systemitem class="ipaddress">128.1.1.2</systemitem> and <systemitem class="ipaddress">128.1.1.3</systemitem> are forwarded
	  back to <acronym>LAN</acronym> clients
	  <systemitem>A</systemitem> and
	  <systemitem>B</systemitem>.</para>

	<para xml:lang="en">The <option>redirect_address</option> syntax is as
	  below, where <literal>localIP</literal> is the internal
	  <acronym>IP</acronym> address of the <acronym>LAN</acronym>
	  client, and <literal>publicIP</literal> the external
	  <acronym>IP</acronym> address corresponding to the
	  <acronym>LAN</acronym> client.</para>

	<programlisting xml:lang="en">redirect_address localIP publicIP</programlisting>

	<para xml:lang="en">In the example, the arguments would read:</para>

	<programlisting xml:lang="en">redirect_address 192.168.0.2 128.1.1.2
redirect_address 192.168.0.3 128.1.1.3</programlisting>

	<para xml:lang="en">Like <option>redirect_port</option>, these arguments
	  are placed in a <acronym>NAT</acronym> instance
	  configuration.  With address redirection, there is no
	  need for port redirection, as all data received on a
	  particular <acronym>IP</acronym> address is
	  redirected.</para>

	<para xml:lang="en">The external <acronym>IP</acronym> addresses on the
	  <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry> machine must be active and aliased to the
	  external interface.  Refer to <citerefentry><refentrytitle>rc.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for
	  details.</para>
      </sect3>

      <sect3>
	<title xml:lang="en">Userspace <acronym>NAT</acronym></title>

	<para xml:lang="en">Let us start with a statement: the userspace
	  <acronym>NAT</acronym> implementation: <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, has
	  more overhead than in-kernel <acronym>NAT</acronym>. For
	  <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry> to translate packets, the packets have to be
	  copied from the kernel to userspace and back which brings in
	  extra overhead that is not present with in-kernel
	  <acronym>NAT</acronym>.</para>

	<para>要在開機時啟動 Userspace 的 <acronym>NAT</acronym> daemon <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 需在 <filename>/etc/rc.conf</filename> 中做以下最小設定，其中 <option>natd_interface</option> 要設成連接到網際網路的 <acronym>NIC</acronym> 名稱，<citerefentry><refentrytitle>rc</refentrytitle><manvolnum>8</manvolnum></citerefentry> script of <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry> 會自動檢查是否有使用動態 <acronym>IP</acronym> 位址，並且自行設定並處理。</para>

	<programlisting xml:lang="en">gateway_enable="YES"
natd_enable="YES"
natd_interface="rl0"</programlisting>

	<para xml:lang="en">In general, the above ruleset as explained for in-kernel
	  <acronym>NAT</acronym> can also be used together with
	  <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  The only exceptions are the configuration of
	  the in-kernel <acronym>NAT</acronym> instance <literal>(ipfw
	  -q nat 1 config ...)</literal> not being applicable any
	  more, rule number 100 and 1000 will have to change sligthly
	  as below, and reassemble rule 99 is not needed anymore
	  as the <option>divert</option> action is used which covers
	  fragmentation.</para>

	<programlisting xml:lang="en">$cmd 100 divert natd ip from any to any in via $pif
$cmd 1000 divert natd ip from any to any out via $pif</programlisting>

	<para xml:lang="en">To configure port or address redirection, a similar
	  syntax as with in-kernel <acronym>NAT</acronym> is used.
	  Although, now, instead of specifying the configuration in
	  our ruleset script like with in-kernel
	  <acronym>NAT</acronym>, configuration of <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry> is
	  best done in a configuration file.  To do this, an extra
	  flag must be passed via <filename>/etc/rc.conf</filename>
	  which specifies the path of the configuration file.</para>

	<programlisting xml:lang="en">natd_flags="-f /etc/natd.conf"</programlisting>

	<note>
	  <para xml:lang="en">The specified file must contain a list of
	    configuration options, one per line.  For more information
	    about the configuration file and possible variables,
	    consult <citerefentry><refentrytitle>natd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  Below are two example
	    entries, one per line:</para>

	  <programlisting xml:lang="en">redirect_port tcp 192.168.0.2:6667 6667
redirect_address 192.168.0.3 128.1.1.3</programlisting></note>
      </sect3>
    </sect2>

    <sect2 xml:id="firewalls-ipfw-cmd">
      <title><application>IPFW</application> 指令</title>

      <indexterm xml:lang="en"><primary><command>ipfw</command></primary></indexterm>

      <para xml:lang="en"><command>ipfw</command> can be used to make manual,
	single rule additions or deletions to the active firewall
	while it is running.  The problem with using this method is
	that all the changes are lost when the system reboots.  It is
	recommended to instead write all the rules in a file and to
	use that file to load the rules at boot time and to replace
	the currently running firewall rules whenever that file
	changes.</para>

      <para xml:lang="en"><command>ipfw</command> is a useful way to display the
	running firewall rules to the console screen.  The
	<application>IPFW</application> accounting facility
	dynamically creates a counter for each rule that counts each
	packet that matches the rule.  During the process of testing a
	rule, listing the rule with its counter is one way to
	determine if the rule is functioning as expected.</para>

      <para xml:lang="en">To list all the running rules in sequence:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipfw list</userinput></screen>

      <para xml:lang="en">To list all the running rules with a time stamp of when
	the last time the rule was matched:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipfw -t list</userinput></screen>

      <para xml:lang="en">The next example lists accounting information and the
	packet count for matched rules along with the rules
	themselves.  The first column is the rule number, followed by
	the number of matched packets and bytes, followed by the rule
	itself.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipfw -a list</userinput></screen>

      <para xml:lang="en">To list dynamic rules in addition to static rules:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipfw -d list</userinput></screen>

      <para xml:lang="en">To also show the expired dynamic rules:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipfw -d -e list</userinput></screen>

      <para xml:lang="en">To zero the counters:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipfw zero</userinput></screen>

      <para xml:lang="en">To zero the counters for just the rule with number
	<replaceable>NUM</replaceable>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipfw zero <replaceable>NUM</replaceable></userinput></screen>

      <sect3>
	<title>記錄防火牆訊息</title>

	<indexterm xml:lang="en">
	  <primary><application>IPFW</application></primary>

	  <secondary>logging</secondary>
	</indexterm>

	<para xml:lang="en">Even with the logging facility enabled,
	  <application>IPFW</application> will not generate any rule
	  logging on its own.  The firewall administrator decides
	  which rules in the ruleset will be logged, and adds the
	  <literal>log</literal> keyword to those rules.  Normally
	  only deny rules are logged.  It is customary to duplicate
	  the <quote>ipfw default deny everything</quote> rule with
	  the <literal>log</literal> keyword included as the last rule
	  in the ruleset.  This way, it is possible to see all the
	  packets that did not match any of the rules in the
	  ruleset.</para>

	<para xml:lang="en">Logging is a two edged sword.  If one is not careful,
	  an over abundance of log data or a DoS attack can fill the
	  disk with log files.  Log messages are not only written to
	  <application>syslogd</application>, but also are displayed
	  on the root console screen and soon become annoying.</para>

	<para xml:lang="en">The <literal>IPFIREWALL_VERBOSE_LIMIT=5</literal>
	  kernel option limits the number of consecutive messages
	  sent to <citerefentry><refentrytitle>syslogd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, concerning the packet matching of a
	  given rule.  When this option is enabled in the kernel, the
	  number of consecutive messages concerning a particular rule
	  is capped at the number specified.  There is nothing to be
	  gained from 200 identical log messages.  With this option
	  set to five,
	  five consecutive messages concerning a particular rule
	  would be logged to <application>syslogd</application> and
	  the remainder identical consecutive messages would be
	  counted and posted to <application>syslogd</application>
	  with a phrase like the following:</para>

	<programlisting xml:lang="en">last message repeated 45 times</programlisting>

	<para xml:lang="en">All logged packets messages are written by default to
	  <filename>/var/log/security</filename>, which is
	  defined in <filename>/etc/syslog.conf</filename>.</para>
      </sect3>

      <sect3 xml:id="firewalls-ipfw-rules-script">
	<title>建立規則 Script</title>

	<para xml:lang="en">Most experienced <application>IPFW</application> users
	  create a file containing the rules and code them in a manner
	  compatible with running them as a script.  The major benefit
	  of doing this is the firewall rules can be refreshed in mass
	  without the need of rebooting the system to activate them.
	  This method is convenient in testing new rules as the
	  procedure can be executed as many times as needed.  Being a
	  script, symbolic substitution can be used for frequently
	  used values to be substituted into multiple rules.</para>

	<para xml:lang="en">This example script is compatible with the syntax used
	  by the <citerefentry><refentrytitle>sh</refentrytitle><manvolnum>1</manvolnum></citerefentry>,  <citerefentry><refentrytitle>csh</refentrytitle><manvolnum>1</manvolnum></citerefentry>, and <citerefentry><refentrytitle>tcsh</refentrytitle><manvolnum>1</manvolnum></citerefentry> shells.
	  Symbolic substitution fields are prefixed with a dollar sign
	  ($).  Symbolic fields do not have the $
	  prefix.  The value to populate the symbolic field must be
	  enclosed in double quotes ("").</para>

	<para xml:lang="en">Start the rules file like this:</para>

	<programlisting xml:lang="en">############### start of example ipfw rules script #############
#
ipfw -q -f flush       # Delete all rules
# Set defaults
oif="tun0"             # out interface
odns="192.0.2.11"      # ISP's DNS server IP address
cmd="ipfw -q add "     # build rule prefix
ks="keep-state"        # just too lazy to key this each time
$cmd 00500 check-state
$cmd 00502 deny all from any to any frag
$cmd 00501 deny tcp from any to any established
$cmd 00600 allow tcp from any to any 80 out via $oif setup $ks
$cmd 00610 allow tcp from any to $odns 53 out via $oif setup $ks
$cmd 00611 allow udp from any to $odns 53 out via $oif $ks
################### End of example ipfw rules script ############</programlisting>

	<para xml:lang="en">The rules are not important as the focus of this example
	  is how the symbolic substitution fields are
	  populated.</para>

	<para xml:lang="en">If the above example was in
	  <filename>/etc/ipfw.rules</filename>, the rules could be
	  reloaded by the following command:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sh /etc/ipfw.rules</userinput></screen>

	<para xml:lang="en"><filename>/etc/ipfw.rules</filename> can be located
	  anywhere and the file can have any name.</para>

	<para xml:lang="en">The same thing could be accomplished by running these
	  commands by hand:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ipfw -q -f flush</userinput>
<prompt>#</prompt> <userinput>ipfw -q add check-state</userinput>
<prompt>#</prompt> <userinput>ipfw -q add deny all from any to any frag</userinput>
<prompt>#</prompt> <userinput>ipfw -q add deny tcp from any to any established</userinput>
<prompt>#</prompt> <userinput>ipfw -q add allow tcp from any to any 80 out via tun0 setup keep-state</userinput>
<prompt>#</prompt> <userinput>ipfw -q add allow tcp from any to 192.0.2.11 53 out via tun0 setup keep-state</userinput>
<prompt>#</prompt> <userinput>ipfw -q add 00611 allow udp from any to 192.0.2.11 53 out via tun0 keep-state</userinput></screen>
      </sect3>
    </sect2>

    <sect2 xml:id="firewalls-ipfw-kernelconfig">
      <title><application>IPFW</application> 核心選項</title>

      <indexterm><primary>核心選項</primary> <secondary>IPFIREWALL</secondary></indexterm>

      <indexterm><primary>核心選項</primary> <secondary>IPFIREWALL_VERBOSE</secondary></indexterm>

      <indexterm><primary>核心選項</primary> <secondary>IPFIREWALL_VERBOSE_LIMIT</secondary></indexterm>

      <indexterm xml:lang="en">
	<primary><application>IPFW</application></primary>

	<secondary>kernel options</secondary>
      </indexterm>
      <para xml:lang="en">In order to statically compile
	<application>IPFW</application> support into a custom kernel,
	refer to the instructions in <xref linkend="kernelconfig"/>.
	The following options are available for the
	custom kernel configuration file:</para>

      <programlisting xml:lang="en">options    IPFIREWALL			# enables IPFW
options    IPFIREWALL_VERBOSE		# enables logging for rules with log keyword to syslogd(8)
options    IPFIREWALL_VERBOSE_LIMIT=5	# limits number of logged packets per-entry
options    IPFIREWALL_DEFAULT_TO_ACCEPT # sets default policy to pass what is not explicitly denied
options    IPFIREWALL_NAT		# enables in-kernel NAT support
options    IPFIREWALL_NAT64		# enables in-kernel NAT64 support
options    IPFIREWALL_NPTV6		# enables in-kernel IPv6 NPT support
options    IPFIREWALL_PMOD		# enables protocols modification module support
options    IPDIVERT			# enables NAT through natd(8)</programlisting>

      <note>
	<para xml:lang="en"><application>IPFW</application> can be loaded as
	  a kernel module: options above are built by default
	  as modules or can be set at runtime using tunables.</para>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="firewalls-ipf">
    <title xml:lang="en">IPFILTER (IPF)</title>

    <indexterm xml:lang="en">
      <primary>firewall</primary>

      <secondary><application>IPFILTER</application></secondary>
    </indexterm>

    <para><application>IPFILTER</application> 即為 <application>IPF</application>，是一套跨平台、開放源碼的防火牆，已被移植到各種作業系統，包含 FreeBSD, NetBSD, OpenBSD 與 <trademark>Solaris</trademark>。</para>

    <para><application>IPFILTER</application> 是核心端 (Kernel-side) 的防火牆且 <acronym>NAT</acronym> 機制可由 Userland 的程式控制與監控，防火牆規則可以使用 <application>ipf</application> 設定或刪除，<acronym>NAT</acronym> 規則可以使用 <application>ipnat</application> 設定或刪除，可使用 <application>ipfstat</application> 來列出 <application>IPFILTER</application> 在核心部份的執行期統計資訊，可使用 <application>ipmon</application> 來記錄 <application>IPFILTER</application> 動作到系統記錄檔。</para>

    <para><application>IPF</application> 原來是以 <quote>最後一個符合的條件優先</quote> 的規則處理邏輯所撰寫並只能使用無狀態 (Stateless) 的規則，之後 <application>IPF</application> 才被加強支援快速 (<literal>quick</literal>) 與保留狀態 (<literal>keep state</literal>) 的選項。</para>

    <para><application>IPF</application> FAQ 位於 <uri xlink:href="http://www.phildev.net/ipf/index.html">http://www.phildev.net/ipf/index.html</uri>，可搜尋的 IPFilter 郵遞論壇封存資料可至 <uri xlink:href="http://marc.info/?l=ipfilter">http://marc.info/?l=ipfilter</uri> 取得。</para>

    <para>由於 FreeBSD 也支援 <application>IPF</application> 因此操作手冊特別在此章節對此介紹，本節提供幾個有使用快速 (<literal>quick</literal>) 與保留狀態 (<literal>keep state</literal>) 選項的規則範例。</para>

    <sect2>
      <title>開啟 <application>IPF</application></title>

      <indexterm xml:lang="en">
	<primary><application>IPFILTER</application></primary>

	<secondary>enabling</secondary>
      </indexterm>

      <para xml:lang="en"><application>IPF</application> is included in the basic
	FreeBSD install as a kernel loadable module, meaning that a
	custom kernel is not needed in order to enable
	<application>IPF</application>.</para>

      <indexterm><primary>核心選項</primary> <secondary><application>IPFILTER</application></secondary></indexterm>

      <indexterm><primary>核心選項</primary> <secondary>IPFILTER_LOG</secondary></indexterm>

      <indexterm><primary>核心選項</primary> <secondary>IPFILTER_DEFAULT_BLOCK</secondary></indexterm>

      <indexterm xml:lang="en">
	<primary><application>IPFILTER</application></primary>

	<secondary>kernel options</secondary>
      </indexterm>

      <para xml:lang="en">For users who prefer to statically compile
	<application>IPF</application> support into a custom kernel,
	refer to the instructions in <xref linkend="kernelconfig"/>.
	The following kernel options are available:</para>

      <programlisting xml:lang="en">options IPFILTER
options IPFILTER_LOG
options IPFILTER_LOOKUP
options IPFILTER_DEFAULT_BLOCK</programlisting>

      <para xml:lang="en">where <literal>options IPFILTER</literal> enables support
	for <application>IPFILTER</application>,
	<literal>options IPFILTER_LOG</literal> enables
	<application>IPF</application> logging using the
	<filename>ipl</filename> packet logging pseudo-device for
	every rule that has the <literal>log</literal> keyword,
	<literal>IPFILTER_LOOKUP</literal> enables
	<acronym>IP</acronym> pools in order to speed up
	<acronym>IP</acronym> lookups, and <literal>options
	  IPFILTER_DEFAULT_BLOCK</literal> changes the default
	behavior so that any packet not matching a firewall
	<literal>pass</literal> rule gets blocked.</para>

      <para xml:lang="en">To configure the system to enable
	<application>IPF</application> at boot time, add the following
	entries to <filename>/etc/rc.conf</filename>.  These entries
	will also enable logging and <literal>default pass
	  all</literal>.  To change the default policy to
	<literal>block all</literal> without  compiling a custom
	kernel, remember to add a <literal>block all</literal> rule at
	the end of the ruleset.</para>

      <programlisting xml:lang="en">ipfilter_enable="YES"             # Start ipf firewall
ipfilter_rules="/etc/ipf.rules"   # loads rules definition text file
ipmon_enable="YES"                # Start IP monitor log
ipmon_flags="-Ds"                 # D = start as daemon
                                  # s = log to syslog
                                  # v = log tcp window, ack, seq
                                  # n = map IP &amp; port to names</programlisting>

      <para xml:lang="en">If <acronym>NAT</acronym> functionality is needed, also
	add these lines:</para>

      <programlisting xml:lang="en">gateway_enable="YES"              # Enable as LAN gateway
ipnat_enable="YES"                # Start ipnat function
ipnat_rules="/etc/ipnat.rules"    # rules definition file for ipnat</programlisting>

      <para xml:lang="en">Then, to start <application>IPF</application> now:</para>

      <programlisting xml:lang="en"><prompt>#</prompt> <userinput>service ipfilter start</userinput></programlisting>

      <para xml:lang="en">To load the firewall rules, specify the name of the
	ruleset file using <command>ipf</command>.  The following
	command can be used to replace the currently running firewall
	rules:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipf -Fa -f /etc/ipf.rules</userinput></screen>

      <para xml:lang="en">where <option>-Fa</option> flushes all the internal rules
	tables and <option>-f</option> specifies the file containing
	the rules to load.</para>

      <para xml:lang="en">This provides the ability to make changes to a custom
	ruleset and update the running firewall with a fresh copy of
	the rules without having to reboot the system.  This method is
	convenient for testing new rules as the procedure can be
	executed as many times as needed.</para>

      <para xml:lang="en">Refer to <citerefentry><refentrytitle>ipf</refentrytitle><manvolnum>8</manvolnum></citerefentry> for details on the other flags
	available with this command.</para>
    </sect2>

    <sect2>
      <title><application>IPF</application> 規則語法</title>

      <indexterm xml:lang="en">
	<primary><application>IPFILTER</application></primary>

	<secondary>rule syntax</secondary>
      </indexterm>

      <para xml:lang="en">This section describes the <application>IPF</application>
	rule syntax used to create stateful rules.  When creating
	rules, keep in mind that unless the <literal>quick</literal>
	keyword appears in a rule, every rule is read in order, with
	the <emphasis>last  matching rule</emphasis> being the one
	that is applied.  This means that even if the first rule to
	match a packet is a <literal>pass</literal>, if there is a
	later matching rule that is a <literal>block</literal>, the
	packet will be dropped.  Sample rulesets can be found in
	<filename>/usr/share/examples/ipfilter</filename>.</para>

      <para xml:lang="en">When creating rules, a <literal>#</literal> character is
	used to mark the start of a comment and may appear at the end
	of a rule, to explain that rule's function, or on its own
	line.  Any blank lines are ignored.</para>

      <para xml:lang="en">The keywords which are used in rules must be written in a
	specific order, from left to right.  Some keywords are
	mandatory while others are optional.  Some keywords have
	sub-options which may be keywords themselves and also include
	more sub-options.  The keyword order is as follows, where the
	words shown in uppercase represent a variable and the words
	shown in lowercase must precede the variable that follows
	it:</para>

      <para xml:lang="en"><replaceable>ACTION DIRECTION OPTIONS proto PROTO_TYPE
	  from SRC_ADDR SRC_PORT to DST_ADDR DST_PORT
	  TCP_FLAG|ICMP_TYPE keep state STATE</replaceable></para>

      <para xml:lang="en">This section describes each of these keywords and their
	options.  It is not an exhaustive list of every possible
	option.  Refer to <citerefentry><refentrytitle>ipf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for a complete description of
	the rule syntax that can be used when creating
	<application>IPF</application> rules and examples for using
	each keyword.</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">ACTION</term>
	  <listitem>
	    <para xml:lang="en">The action keyword indicates what to do with the
	      packet if it matches that rule.  Every rule
	      <emphasis>must</emphasis> have an action.  The
	      following actions are recognized:</para>

	    <para xml:lang="en"><literal>block</literal>: drops the packet.</para>

	    <para xml:lang="en"><literal>pass</literal>: allows the packet.</para>

	    <para xml:lang="en"><literal>log</literal>: generates a log
	      record.</para>

	    <para xml:lang="en"><literal>count</literal>: counts the number of
	      packets and bytes which can provide an indication of
	      how often a rule is used.</para>

	    <para xml:lang="en"><literal>auth</literal>: queues the packet for
	      further processing by another program.</para>

	    <para xml:lang="en"><literal>call</literal>: provides access to
	      functions built into <application>IPF</application> that
	      allow more complex actions.</para>

	    <para xml:lang="en"><literal>decapsulate</literal>: removes any headers
	      in order to process the contents of the packet.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">DIRECTION</term>
	  <listitem>
	    <para xml:lang="en">Next, each rule must explicitly state the direction
	      of traffic using one of these keywords:</para>

	    <para xml:lang="en"><literal>in</literal>: the rule is applied against
	      an inbound packet.</para>

	    <para xml:lang="en"><literal>out</literal>: the rule is applied against
	      an outbound packet.</para>

	    <para xml:lang="en"><literal>all</literal>: the rule applies to either
	      direction.</para>

	    <para xml:lang="en">If the system has multiple interfaces, the interface
	      can be specified along with the direction.  An example
	      would be <literal>in on fxp0</literal>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">OPTIONS</term>
	  <listitem>
	    <para xml:lang="en">Options are optional.  However, if multiple options
	      are specified, they must be used in the order shown
	      here.</para>

	    <para xml:lang="en"><literal>log</literal>: when performing the
	      specified ACTION, the contents of the packet's headers
	      will be written to the <citerefentry><refentrytitle>ipl</refentrytitle><manvolnum>4</manvolnum></citerefentry> packet log
	      pseudo-device.</para>

	    <para xml:lang="en"><literal>quick</literal>: if a packet matches this
	      rule, the ACTION specified by the rule occurs and no
	      further processing of any following rules will occur for
	      this packet.</para>

	    <para xml:lang="en"><literal>on</literal>: must be followed by the
	      interface name as displayed by <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  The
	      rule will only match if the packet is going through the
	      specified interface in the specified direction.</para>

	    <para xml:lang="en">When using the
	      <literal>log</literal> keyword, the following qualifiers
	      may be used in this order:</para>

	    <para xml:lang="en"><literal>body</literal>: indicates that the first
	      128 bytes of the packet contents will be logged after
	      the headers.</para>

	    <para xml:lang="en"><literal>first</literal>:  if the
	      <literal>log</literal> keyword is being used in
	      conjunction with a <literal>keep state</literal> option,
	      this option is recommended so that only the triggering
	      packet is logged and not every packet which matches the
	      stateful connection.</para>

	    <para xml:lang="en">Additional options are available to specify error
	      return messages.  Refer to  <citerefentry><refentrytitle>ipf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for more
	      details.</para>

	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">PROTO_TYPE</term>
	  <listitem>
	    <para xml:lang="en">The protocol type is optional.  However, it is
	      mandatory if the rule needs to specify a SRC_PORT or
	      a DST_PORT as it defines the type of protocol.  When
	      specifying the type of protocol, use the
	      <literal>proto</literal> keyword followed by either a
	      protocol number or name from
	      <filename>/etc/protocols</filename>.
	      Example protocol names include <literal>tcp</literal>,
	      <literal>udp</literal>, or <literal>icmp</literal>.  If
	      PROTO_TYPE is specified but no SRC_PORT or DST_PORT is
	      specified, all port numbers for that protocol will match
	      that rule.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">SRC_ADDR</term>
	  <listitem>
	    <para xml:lang="en">The <literal>from</literal> keyword is mandatory and
	      is followed by a keyword which represents the source of
	      the packet.  The source can be a hostname, an
	      <acronym>IP</acronym> address followed by the
	      <acronym>CIDR</acronym> mask, an address pool, or the
	      keyword <literal>all</literal>.  Refer to <citerefentry><refentrytitle>ipf</refentrytitle><manvolnum>5</manvolnum></citerefentry>
	      for examples.</para>

	    <para xml:lang="en">There is no way to match ranges of
	      <acronym>IP</acronym> addresses which do not express
	      themselves easily using the dotted numeric form /
	      mask-length notation.  The
	      <package>net-mgmt/ipcalc</package> package or port may
	      be used to ease the calculation of the
	      <acronym>CIDR</acronym> mask.  Additional information is
	      available at the utility's web page: <uri xlink:href="http://jodies.de/ipcalc">http://jodies.de/ipcalc</uri>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">SRC_PORT</term>
	  <listitem>
	    <para xml:lang="en">The port number of the source is optional.  However,
	      if it is used, it requires PROTO_TYPE to be first
	      defined in the rule.  The port number must also be
	      preceded by the <literal>proto</literal> keyword.</para>

	    <para xml:lang="en">A number of different comparison operators are
	      supported: <literal>=</literal> (equal to),
	      <literal>!=</literal> (not equal to),
	      <literal>&lt;</literal> (less than),
	      <literal>&gt;</literal> (greater than),
	      <literal>&lt;=</literal> (less than or equal to), and
	      <literal>&gt;=</literal> (greater than or equal
	      to).</para>

	    <para xml:lang="en">To specify port ranges, place the two port numbers
	      between <literal>&lt;&gt;</literal> (less than and
	      greater than ), <literal>&gt;&lt;</literal> (greater
	      than and less than ), or <literal>:</literal> (greater
	      than or equal to and less than or equal to).</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">DST_ADDR</term>
	  <listitem>
	    <para xml:lang="en">The <literal>to</literal> keyword is mandatory and
	      is followed by a keyword which represents the
	      destination of the packet.  Similar to SRC_ADDR, it can
	      be a hostname, an  <acronym>IP</acronym> address
	      followed by the <acronym>CIDR</acronym> mask, an address
	      pool, or the keyword <literal>all</literal>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">DST_PORT</term>
	  <listitem>
	    <para xml:lang="en">Similar to SRC_PORT, the port number of the
	      destination is optional.  However, if it is used, it
	      requires PROTO_TYPE to be first defined in the rule.
	      The port number must also be preceded by the
	      <literal>proto</literal> keyword.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">TCP_FLAG|ICMP_TYPE</term>
	  <listitem>
	    <para xml:lang="en">If <literal>tcp</literal> is specified as the
	      PROTO_TYPE, flags can be specified as letters, where
	      each letter represents one of the possible
	      <acronym>TCP</acronym> flags used to determine the state
	      of a connection.  Possible values are:
	      <literal>S</literal> (SYN),
	      <literal>A</literal> (ACK),
	      <literal>P</literal> (PSH),
	      <literal>F</literal> (FIN),
	      <literal>U</literal> (URG),
	      <literal>R</literal> (RST),
	      <literal>C</literal> (CWN), and
	      <literal>E</literal> (ECN).</para>

	    <para xml:lang="en">If <literal>icmp</literal> is specified as the
	      PROTO_TYPE, the <acronym>ICMP</acronym> type to match
	      can be specified.  Refer to <citerefentry><refentrytitle>ipf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for the
	      allowable types.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">STATE</term>
	  <listitem>
	    <para xml:lang="en">If a <literal>pass</literal> rule contains
	      <literal>keep state</literal>,
	      <application>IPF</application> will add an entry to its
	      dynamic state table and allow subsequent packets that
	      match the connection.
	      <application>IPF</application> can track state for
	      <acronym>TCP</acronym>, <acronym>UDP</acronym>, and
	      <acronym>ICMP</acronym> sessions.  Any packet that
	      <application>IPF</application> can be certain is part of
	      an active session, even if it is a different protocol,
	      will be allowed.</para>

	    <para xml:lang="en">In <application>IPF</application>, packets destined
	      to go out through the interface connected to the public
	      Internet are first checked against the dynamic state
	      table.  If the packet matches the next expected packet
	      comprising an active session conversation, it exits the
	      firewall and the state of the session conversation flow
	      is updated in the dynamic state table.  Packets that do
	      not belong to an already active session are checked
	      against the outbound ruleset.  Packets coming in from
	      the interface connected to the public Internet are first
	      checked against the dynamic state table.  If the packet
	      matches the next expected packet comprising an active
	      session, it exits the firewall and the state of the
	      session conversation flow is updated in the dynamic
	      state table.  Packets that do not belong to an already
	      active session are checked against the inbound
	      ruleset.</para>

	    <para xml:lang="en">Several keywords can be added after
	      <literal>keep state</literal>.  If used, these keywords
	      set various options that control stateful filtering,
	      such as setting connection limits or connection age.
	      Refer to <citerefentry><refentrytitle>ipf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for the list of available options
	      and their descriptions.</para>
	  </listitem>
	</varlistentry>
      </variablelist>
    </sect2>

    <sect2>
      <title>範例規則集</title>

      <para xml:lang="en">This section demonstrates how to create an example ruleset
	which only allows services matching
	<literal>pass</literal> rules and blocks all others.</para>

      <para xml:lang="en">FreeBSD uses the loopback interface
	(<filename>lo0</filename>) and the <acronym>IP</acronym>
	address <systemitem class="ipaddress">127.0.0.1</systemitem>
	for internal communication.  The firewall ruleset must contain
	rules to allow free movement of these internally used
	packets:</para>

      <programlisting xml:lang="en"># no restrictions on loopback interface
pass in quick on lo0 all
pass out quick on lo0 all</programlisting>

      <para xml:lang="en">The public interface connected to the Internet is used to
	authorize and control access of all outbound and inbound
	connections.  If one or more interfaces are cabled to private
	networks, those internal interfaces may require rules to allow
	packets originating from the <acronym>LAN</acronym> to flow
	between the internal networks or to the interface attached to
	the Internet.  The ruleset should be organized into three
	major sections: any trusted internal interfaces, outbound
	connections through the public interface, and inbound
	connections through the public interface.</para>

      <para xml:lang="en">These two rules allow all traffic to pass through a
	trusted <acronym>LAN</acronym> interface named
	<filename>xl0</filename>:</para>

      <programlisting xml:lang="en"># no restrictions on inside LAN interface for private network
pass out quick on xl0 all
pass in quick on xl0 all</programlisting>

      <para xml:lang="en">The rules for the public interface's outbound and inbound
	sections should have the most frequently matched rules placed
	before less commonly matched rules, with the last rule in the
	section blocking and logging all packets for that interface
	and direction.</para>

      <para xml:lang="en">This set of rules defines the outbound section of the
	public interface named <filename>dc0</filename>.  These rules
	keep state and identify the specific services that internal
	systems are authorized for public Internet access.  All the
	rules use <literal>quick</literal> and specify the
	appropriate port numbers and, where applicable, destination
	addresses.</para>

      <programlisting xml:lang="en"># interface facing Internet (outbound)
# Matches session start requests originating from or behind the
# firewall, destined for the Internet.

# Allow outbound access to public DNS servers.
# Replace x.x.x. with address listed in /etc/resolv.conf.
# Repeat for each DNS server.
pass out quick on dc0 proto tcp from any to x.x.x. port = 53 flags S keep state
pass out quick on dc0 proto udp from any to xxx port = 53 keep state

# Allow access to ISP's specified DHCP server for cable or DSL networks.
# Use the first rule, then check log for the IP address of DHCP server.
# Then, uncomment the second rule, replace z.z.z.z with the IP address,
# and comment out the first rule
pass out log quick on dc0 proto udp from any to any port = 67 keep state
#pass out quick on dc0 proto udp from any to z.z.z.z port = 67 keep state

# Allow HTTP and HTTPS
pass out quick on dc0 proto tcp from any to any port = 80 flags S keep state
pass out quick on dc0 proto tcp from any to any port = 443 flags S keep state

# Allow email
pass out quick on dc0 proto tcp from any to any port = 110 flags S keep state
pass out quick on dc0 proto tcp from any to any port = 25 flags S keep state

# Allow NTP
pass out quick on dc0 proto tcp from any to any port = 37 flags S keep state

# Allow FTP
pass out quick on dc0 proto tcp from any to any port = 21 flags S keep state

# Allow SSH
pass out quick on dc0 proto tcp from any to any port = 22 flags S keep state

# Allow ping
pass out quick on dc0 proto icmp from any to any icmp-type 8 keep state

# Block and log everything else
block out log first quick on dc0 all</programlisting>

      <para xml:lang="en">This example of the rules in the inbound section of the
	public interface blocks all undesirable packets first.  This
	reduces the number of packets that are logged by the last
	rule.</para>

      <programlisting xml:lang="en"># interface facing Internet (inbound)
# Block all inbound traffic from non-routable or reserved address spaces
block in quick on dc0 from 192.168.0.0/16 to any    #RFC 1918 private IP
block in quick on dc0 from 172.16.0.0/12 to any     #RFC 1918 private IP
block in quick on dc0 from 10.0.0.0/8 to any        #RFC 1918 private IP
block in quick on dc0 from 127.0.0.0/8 to any       #loopback
block in quick on dc0 from 0.0.0.0/8 to any         #loopback
block in quick on dc0 from 169.254.0.0/16 to any    #DHCP auto-config
block in quick on dc0 from 192.0.2.0/24 to any      #reserved for docs
block in quick on dc0 from 204.152.64.0/23 to any   #Sun cluster interconnect
block in quick on dc0 from 224.0.0.0/3 to any       #Class D &amp; E multicast

# Block fragments and too short tcp packets
block in quick on dc0 all with frags
block in quick on dc0 proto tcp all with short

# block source routed packets
block in quick on dc0 all with opt lsrr
block in quick on dc0 all with opt ssrr

# Block OS fingerprint attempts and log first occurrence
block in log first quick on dc0 proto tcp from any to any flags FUP

# Block anything with special options
block in quick on dc0 all with ipopts

# Block public pings and ident
block in quick on dc0 proto icmp all icmp-type 8
block in quick on dc0 proto tcp from any to any port = 113

# Block incoming Netbios services
block in log first quick on dc0 proto tcp/udp from any to any port = 137
block in log first quick on dc0 proto tcp/udp from any to any port = 138
block in log first quick on dc0 proto tcp/udp from any to any port = 139
block in log first quick on dc0 proto tcp/udp from any to any port = 81</programlisting>

      <para xml:lang="en">Any time there are logged messages on a rule with
	the <literal>log first</literal> option, run
	<command>ipfstat -hio</command> to evaluate how many times the
	rule has been matched.  A large number of matches may indicate
	that the system is under attack.</para>

      <para xml:lang="en">The rest of the rules in the inbound section define which
	connections are allowed to be initiated from the Internet.
	The last rule denies all connections which were not explicitly
	allowed by previous rules in this section.</para>

      <programlisting xml:lang="en"># Allow traffic in from ISP's DHCP server. Replace z.z.z.z with
# the same IP address used in the outbound section.
pass in quick on dc0 proto udp from z.z.z.z to any port = 68 keep state

# Allow public connections to specified internal web server
pass in quick on dc0 proto tcp from any to x.x.x.x port = 80 flags S keep state

# Block and log only first occurrence of all remaining traffic.
block in log first quick on dc0 all</programlisting>
    </sect2>

    <sect2>
      <title>設定 <acronym>NAT</acronym></title>

      <indexterm xml:lang="en"><primary>NAT</primary></indexterm>

      <indexterm xml:lang="en">
	<primary>IP masquerading</primary>

	<see>NAT</see>
      </indexterm>

      <indexterm xml:lang="en">
	<primary>network address translation</primary>

	<see>NAT</see>
      </indexterm>

      <indexterm xml:lang="en"><primary><command>ipnat</command></primary></indexterm>

      <para xml:lang="en">To enable <acronym>NAT</acronym>, add these statements
	to <filename>/etc/rc.conf</filename> and specify the name of
	the file containing the <acronym>NAT</acronym> rules:</para>

      <programlisting xml:lang="en">gateway_enable="YES"
ipnat_enable="YES"
ipnat_rules="/etc/ipnat.rules"</programlisting>

      <para xml:lang="en"><acronym>NAT</acronym> rules are flexible and can
	accomplish many different things to fit the needs of both
	commercial and home users.  The rule syntax presented here has
	been simplified to demonstrate common usage.  For a complete
	rule syntax description, refer to <citerefentry><refentrytitle>ipnat</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

      <para xml:lang="en">The basic syntax for a <acronym>NAT</acronym> rule is as
	follows, where <literal>map</literal> starts the rule and
	<replaceable>IF</replaceable> should be replaced with the
	name of the external interface:</para>

      <programlisting xml:lang="en">map <replaceable>IF</replaceable> <replaceable>LAN_IP_RANGE</replaceable> -&gt; <replaceable>PUBLIC_ADDRESS</replaceable></programlisting>

      <para xml:lang="en">The <replaceable>LAN_IP_RANGE</replaceable> is the range
	of <acronym>IP</acronym> addresses used by internal clients.
	Usually, it is a private address range such as <systemitem class="ipaddress">192.168.1.0/24</systemitem>.  The
	<replaceable>PUBLIC_ADDRESS</replaceable> can either be the
	static external <acronym>IP</acronym> address or the keyword
	<literal>0/32</literal> which represents the
	<acronym>IP</acronym> address assigned to
	<replaceable>IF</replaceable>.</para>

      <para xml:lang="en">In <application>IPF</application>, when a packet arrives
	at the firewall from the <acronym>LAN</acronym> with a public
	destination, it first passes through the outbound rules of the
	firewall ruleset.  Then, the packet is passed to the
	<acronym>NAT</acronym> ruleset which is read from the top
	down, where the first matching rule wins.
	<application>IPF</application> tests each
	<acronym>NAT</acronym> rule against the packet's interface
	name and source <acronym>IP</acronym> address.  When a
	packet's interface name matches a <acronym>NAT</acronym> rule,
	the packet's source <acronym>IP</acronym> address in the
	private <acronym>LAN</acronym> is checked to see if it falls
	within the <acronym>IP</acronym> address range specified in
	<replaceable>LAN_IP_RANGE</replaceable>.  On a match, the
	packet has its source <acronym>IP</acronym> address rewritten
	with the public <acronym>IP</acronym> address specified by
	<replaceable>PUBLIC_ADDRESS</replaceable>.
	<application>IPF</application> posts an entry in its internal
	<acronym>NAT</acronym> table so that when the packet returns
	from the Internet, it can be mapped back to its original
	private <acronym>IP</acronym> address before being passed to
	the firewall rules for further processing.</para>

      <para xml:lang="en">For networks that have large numbers of internal systems
	or multiple subnets, the process of funneling every private
	<acronym>IP</acronym> address into a single public
	<acronym>IP</acronym> address becomes a resource problem.
	Two methods are available to relieve this issue.</para>

      <para xml:lang="en">The first method is to assign a range of ports to use as
	source ports.  By adding the <literal>portmap</literal>
	keyword, <acronym>NAT</acronym> can be directed to only use
	source ports in the specified range:</para>

      <programlisting xml:lang="en">map dc0 192.168.1.0/24 -&gt; 0/32 portmap tcp/udp 20000:60000</programlisting>

      <para xml:lang="en">Alternately, use the <literal>auto</literal> keyword
	which tells <acronym>NAT</acronym> to determine the ports
	that are available for use:</para>

      <programlisting xml:lang="en">map dc0 192.168.1.0/24 -&gt; 0/32 portmap tcp/udp auto</programlisting>

      <para xml:lang="en">The second method is to use a pool of public addresses.
	This is useful when there are too many
	<acronym>LAN</acronym> addresses to fit into a single public
	address and a block of public <acronym>IP</acronym> addresses
	is available.  These public addresses can be used as a pool
	from which <acronym>NAT</acronym> selects an
	<acronym>IP</acronym> address as a packet's address is
	mapped on its way out.</para>

      <para xml:lang="en">The range of public <acronym>IP</acronym> addresses can
	be specified using a netmask or <acronym>CIDR</acronym>
	notation.  These two rules are equivalent:</para>

      <programlisting xml:lang="en">map dc0 192.168.1.0/24 -&gt; 204.134.75.0/255.255.255.0
map dc0 192.168.1.0/24 -&gt; 204.134.75.0/24</programlisting>

      <para xml:lang="en">A common practice is to have a publically accessible web
	server or mail server segregated to an internal network
	segment.  The traffic from these servers still has to undergo
	<acronym>NAT</acronym>, but port redirection is needed to
	direct inbound traffic to the correct server.  For example, to
	map a web server using the internal address <systemitem class="ipaddress">10.0.10.25</systemitem> to its public
	<acronym>IP</acronym> address of <systemitem class="ipaddress">20.20.20.5</systemitem>, use this
	rule:</para>

      <programlisting xml:lang="en">rdr dc0 20.20.20.5/32 port 80 -&gt; 10.0.10.25 port 80</programlisting>

      <para xml:lang="en">If it is the only web server, this rule would also work as
	it redirects all external <acronym>HTTP</acronym> requests to
	<literal>10.0.10.25</literal>:</para>

      <programlisting xml:lang="en">rdr dc0 0.0.0.0/0 port 80 -&gt; 10.0.10.25 port 80</programlisting>

      <para xml:lang="en"><application>IPF</application> has a built in
	<acronym>FTP</acronym> proxy which can be used with
	<acronym>NAT</acronym>.  It monitors all outbound traffic for
	active or passive <acronym>FTP</acronym> connection requests
	and dynamically creates temporary filter rules containing the
	port number used by the <acronym>FTP</acronym> data channel.
	This eliminates the need to open large ranges of high order
	ports for <acronym>FTP</acronym> connections.</para>

      <para xml:lang="en">In this example, the first rule calls the proxy for
	outbound <acronym>FTP</acronym> traffic from the internal
	<acronym>LAN</acronym>.  The second rule passes the
	<acronym>FTP</acronym> traffic from the firewall to the
	Internet, and the third rule handles all
	non-<acronym>FTP</acronym> traffic from the internal
	<acronym>LAN</acronym>:</para>

      <programlisting xml:lang="en">map dc0 10.0.10.0/29 -&gt; 0/32 proxy port 21 ftp/tcp
map dc0 0.0.0.0/0 -&gt; 0/32 proxy port 21 ftp/tcp
map dc0 10.0.10.0/29 -&gt; 0/32</programlisting>

      <para xml:lang="en">The <acronym>FTP</acronym> <literal>map</literal> rules go
	before the <acronym>NAT</acronym> rule so that when a packet
	matches an <acronym>FTP</acronym> rule, the
	<acronym>FTP</acronym> proxy creates temporary filter rules to
	let the <acronym>FTP</acronym> session packets pass and
	undergo <acronym>NAT</acronym>.  All LAN packets that are not
	<acronym>FTP</acronym> will not match the
	<acronym>FTP</acronym> rules but will undergo
	<acronym>NAT</acronym> if they match the third rule.</para>

      <para xml:lang="en">Without the <acronym>FTP</acronym> proxy, the following
	firewall rules would instead be needed.  Note that without the
	proxy, all ports above <literal>1024</literal> need to be
	allowed:</para>

      <programlisting xml:lang="en"># Allow out LAN PC client FTP to public Internet
# Active and passive modes
pass out quick on rl0 proto tcp from any to any port = 21 flags S keep state

# Allow out passive mode data channel high order port numbers
pass out quick on rl0 proto tcp from any to any port &gt; 1024 flags S keep state

# Active mode let data channel in from FTP server
pass in quick on rl0 proto tcp from any to any port = 20 flags S keep state</programlisting>

      <para xml:lang="en">Whenever the file containing the <acronym>NAT</acronym>
	rules is edited, run <command>ipnat</command> with
	<option>-CF</option> to delete the current
	<acronym>NAT</acronym> rules and flush the contents of the
	dynamic translation table.  Include <option>-f</option> and
	specify the name of the <acronym>NAT</acronym> ruleset to
	load:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipnat -CF -f /etc/ipnat.rules</userinput></screen>

      <para xml:lang="en">To display the <acronym>NAT</acronym> statistics:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipnat -s</userinput></screen>

      <para xml:lang="en">To list the <acronym>NAT</acronym> table's current
	mappings:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipnat -l</userinput></screen>

      <para xml:lang="en">To turn verbose mode on and display information relating
	to rule processing and active rules and table entries:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ipnat -v</userinput></screen>
    </sect2>
<!--
This section is confusing and may no longer be needed with new syntax.
    <sect2 xml:id="firewalls-ipf-rules-script">
      <title>Building the Rule Script with Symbolic
	Substitution</title>

      <para>Some experienced IPF users create a file containing the
	rules and code them in a manner compatible with running them
	as a script with symbolic substitution.  The major benefit
	of doing this is that only the value associated with the
	symbolic name needs to be changed, and when the script is
	run all the rules containing the symbolic name will have the
	value substituted in the rules.  Being a script, symbolic
	substitution can be used to code frequently used values and
	substitute them in multiple rules.  This can be seen in the
	following example.</para>

      <para>The script syntax used here is compatible with the
	&man.sh.1;, &man.csh.1;, and &man.tcsh.1; shells.</para>

      <para>Symbolic substitution fields are prefixed with a
	<literal>&dollar;</literal>.</para>

      <para>Symbolic fields do not have the &dollar; prefix.</para>

      <para>The value to populate the symbolic field must be enclosed
	between double quotes (<literal>"</literal>).</para>

      <para>Start the rule file with something like this:</para>

      <programlisting>############# Start of IPF rules script ########################

oif="dc0"            # name of the outbound interface
odns="192.0.2.11"    # ISP's DNS server IP address
myip="192.0.2.7"     # my static IP address from ISP
ks="keep state"
fks="flags S keep state"

# You can choose between building /etc/ipf.rules file
# from this script or running this script "as is".
#
# Uncomment only one line and comment out another.
#
# 1) This can be used for building /etc/ipf.rules:
#cat &gt; /etc/ipf.rules &lt;&lt; EOF
#
# 2) This can be used to run script "as is":
/sbin/ipf -Fa -f - &lt;&lt; EOF

# Allow out access to my ISP's Domain name server.
pass out quick on &dollar;oif proto tcp from any to &dollar;odns port = 53 &dollar;fks
pass out quick on &dollar;oif proto udp from any to &dollar;odns port = 53 &dollar;ks

# Allow out non-secure standard www function
pass out quick on &dollar;oif proto tcp from &dollar;myip to any port = 80 &dollar;fks

# Allow out secure www function https over TLS SSL
pass out quick on &dollar;oif proto tcp from &dollar;myip to any port = 443 &dollar;fks
EOF
################## End of IPF rules script ########################</programlisting>

      <para>The rules are not important in this example as it instead
	focuses on how the symbolic substitution fields are populated.
	If this example was in a file named
	<filename>/etc/ipf.rules.script</filename>, these rules could
	be reloaded by running:</para>

      <screen>&prompt.root; <userinput>sh /etc/ipf.rules.script</userinput></screen>

      <para>There is one problem with using a rules file with embedded
	symbolics: IPF does not understand symbolic substitution, and
	cannot read such scripts directly.</para>

      <para>This script can be used in one of two ways:</para>

      <itemizedlist>
	<listitem>
	  <para>Uncomment the line that begins with
	    <literal>cat</literal>, and comment out the line that
	    begins with <literal>/sbin/ipf</literal>.  Place
	    <literal>ipfilter_enable="YES"</literal> into
	    <filename>/etc/rc.conf</filename>, and run the script
	    once after each modification to create or update
	    <filename>/etc/ipf.rules</filename>.</para>
	</listitem>

	<listitem>
	  <para>Disable <application>IPFILTER</application> in the
	    system startup scripts by adding
	    <literal>ipfilter_enable="NO"</literal>to
	    <filename>/etc/rc.conf</filename>.</para>

	  <para>Then, add a script like the following to
	    <filename>/usr/local/etc/rc.d/</filename>.  The script
	    should have an obvious name like
	    <filename>ipf.loadrules.sh</filename>, where the
	    <filename>.sh</filename> extension is mandatory.</para>

	  <programlisting>#!/bin/sh
sh /etc/ipf.rules.script</programlisting>

	  <para>The permissions on this script file must be read,
	    write, execute for owner
	    <systemitem class="username">root</systemitem>:</para>

	  <screen>&prompt.root; <userinput>chmod 700 /usr/local/etc/rc.d/ipf.loadrules.sh</userinput></screen>
	</listitem>
      </itemizedlist>

      <para>Now, when the system boots, the IPF rules will be
	loaded.</para>
    </sect2>
    -->
    <sect2>
      <title>檢視 <application>IPF</application> 統計資訊</title>

      <indexterm xml:lang="en"><primary><command>ipfstat</command></primary></indexterm>

      <indexterm xml:lang="en">
	<primary><application>IPFILTER</application></primary>

	<secondary>statistics</secondary>
      </indexterm>

      <para xml:lang="en"><application>IPF</application> includes <citerefentry><refentrytitle>ipfstat</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	which can be used to retrieve
	and display statistics which are gathered
	as packets match rules as they go through the
	firewall.  Statistics are accumulated since the firewall was
	last started or since the last time they
	were reset to zero using <command>ipf
	  -Z</command>.</para>

      <para xml:lang="en">The default <command>ipfstat</command> output looks
	like this:</para>

      <screen xml:lang="en">input packets: blocked 99286 passed 1255609 nomatch 14686 counted 0
 output packets: blocked 4200 passed 1284345 nomatch 14687 counted 0
 input packets logged: blocked 99286 passed 0
 output packets logged: blocked 0 passed 0
 packets logged: input 0 output 0
 log failures: input 3898 output 0
 fragment state(in): kept 0 lost 0
 fragment state(out): kept 0 lost 0
 packet state(in): kept 169364 lost 0
 packet state(out): kept 431395 lost 0
 ICMP replies: 0 TCP RSTs sent: 0
 Result cache hits(in): 1215208 (out): 1098963
 IN Pullups succeeded: 2 failed: 0
 OUT Pullups succeeded: 0 failed: 0
 Fastroute successes: 0 failures: 0
 TCP cksum fails(in): 0 (out): 0
 Packet log flags set: (0)</screen>

      <para xml:lang="en">Several options are available.  When supplied with either
	<option>-i</option> for inbound or <option>-o</option> for
	outbound, the command will retrieve and display the
	appropriate list of filter rules currently installed and in
	use by the kernel.  To also see the rule numbers, include
	<option>-n</option>.  For example, <command>ipfstat
	  -on</command> displays the outbound rules table with rule
	numbers:</para>

      <screen xml:lang="en">@1 pass out on xl0 from any to any
@2 block out on dc0 from any to any
@3 pass out quick on dc0 proto tcp/udp from any to any keep state</screen>

      <para xml:lang="en">Include <option>-h</option> to prefix each rule with a
	count of how many times the rule was matched.  For example,
	<command>ipfstat -oh</command> displays the outbound internal
	rules table, prefixing each rule with its usage count:</para>

      <screen xml:lang="en">2451423 pass out on xl0 from any to any
354727 block out on dc0 from any to any
430918 pass out quick on dc0 proto tcp/udp from any to any keep state</screen>

      <para xml:lang="en">To display the state table in a format similar to
	<citerefentry><refentrytitle>top</refentrytitle><manvolnum>1</manvolnum></citerefentry>, use <command>ipfstat -t</command>.  When the
	firewall is under attack, this option provides the ability to
	identify and see the attacking packets.  The optional
	sub-flags give the ability to select the destination or source
	<acronym>IP</acronym>, port, or protocol to be monitored in
	real time.  Refer to <citerefentry><refentrytitle>ipfstat</refentrytitle><manvolnum>8</manvolnum></citerefentry> for details.</para>
    </sect2>

    <sect2>
      <title><application>IPF</application> 日誌</title>

      <indexterm xml:lang="en"><primary><command>ipmon</command></primary></indexterm>

      <indexterm xml:lang="en">
	<primary><application>IPFILTER</application></primary>

	<secondary>logging</secondary>
      </indexterm>

      <para xml:lang="en"><application>IPF</application> provides
	<command>ipmon</command>, which can be used to write the
	firewall's logging information in a human readable format.  It
	requires that <literal>options IPFILTER_LOG</literal> be first
	added to a custom kernel using the instructions in <xref linkend="kernelconfig"/>.</para>

      <para xml:lang="en">This command is typically run in daemon mode in order to
	provide a continuous system log file so that logging of past
	events may be reviewed.  Since FreeBSD has a built in
	<citerefentry><refentrytitle>syslogd</refentrytitle><manvolnum>8</manvolnum></citerefentry> facility to automatically rotate system logs,
	the default <filename>rc.conf</filename>
	<literal>ipmon_flags</literal> statement uses
	<option>-Ds</option>:</para>

      <programlisting xml:lang="en">ipmon_flags="-Ds" # D = start as daemon
                  # s = log to syslog
                  # v = log tcp window, ack, seq
                  # n = map IP &amp; port to names</programlisting>

      <para xml:lang="en">Logging provides the ability to review, after the fact,
	information such as which packets were dropped, what addresses
	they came from, and where they were going.  This information
	is useful in tracking down attackers.</para>

      <para xml:lang="en">Once the logging facility is enabled in
	<filename>rc.conf</filename> and started with <command>service
	  ipmon start</command>, <application>IPF</application> will
	only log the rules which contain the <literal>log</literal>
	keyword.  The firewall administrator decides which rules in
	the ruleset should be logged and normally only deny rules are
	logged.  It is customary to include the
	<literal>log</literal> keyword in the last rule in the
	ruleset.  This makes it possible to see all the packets that
	did not match any of the rules in the ruleset.</para>

      <para xml:lang="en">By default, <command>ipmon -Ds</command> mode uses
	<literal>local0</literal> as the logging facility.  The
	following logging levels can be used to further segregate the
	logged data:</para>

      <screen xml:lang="en">LOG_INFO - packets logged using the "log" keyword as the action rather than pass or block.
LOG_NOTICE - packets logged which are also passed
LOG_WARNING - packets logged which are also blocked
LOG_ERR - packets which have been logged and which can be considered short due to an incomplete header</screen>

      <para xml:lang="en">In order to setup <application>IPF</application> to
	log all data to <filename>/var/log/ipfilter.log</filename>,
	first create the empty file:</para>

       <screen xml:lang="en"><prompt>#</prompt> <userinput>touch /var/log/ipfilter.log</userinput></screen>

      <para xml:lang="en">Then, to write all logged messages to the specified file,
	add the following statement to
	<filename>/etc/syslog.conf</filename>:</para>

      <programlisting xml:lang="en">local0.* /var/log/ipfilter.log</programlisting>

      <para xml:lang="en">To activate the changes and instruct <citerefentry><refentrytitle>syslogd</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	to read the modified <filename>/etc/syslog.conf</filename>,
	run <command>service syslogd reload</command>.</para>

      <para xml:lang="en">Do not forget to edit
	<filename>/etc/newsyslog.conf</filename> to rotate the new
	log file.</para>

      <para xml:lang="en">Messages generated by <command>ipmon</command> consist
	of data fields separated by white space.  Fields common to
	all messages are:</para>

      <orderedlist>
	<listitem>
	  <para xml:lang="en">The date of packet receipt.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The time of packet receipt.  This is in the form
	    HH:MM:SS.F, for hours, minutes, seconds, and fractions
	    of a second.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The name of the interface that processed the
	    packet.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The group and rule number of the rule in the format
	    <literal>@0:17</literal>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The action: <literal>p</literal> for passed,
	    <literal>b</literal> for blocked, <literal>S</literal> for
	    a short packet, <literal>n</literal> did not match any
	    rules, and <literal>L</literal> for a log rule.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">The addresses written as three fields: the source
	    address and port separated by a comma, the -&gt; symbol,
	    and the destination address and port.  For example:
	    <literal>209.53.17.22,80 -&gt;
	      198.73.220.17,1722</literal>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><literal>PR</literal> followed by the protocol name
	    or number: for example, <literal>PR tcp</literal>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><literal>len</literal> followed by the header length
	    and total length of the packet: for example,
	    <literal>len 20 40</literal>.</para>
	</listitem>
      </orderedlist>

      <para xml:lang="en">If the packet is a <acronym>TCP</acronym> packet, there
	will be an additional field starting with a hyphen followed by
	letters corresponding to any flags that were set.  Refer to
	<citerefentry><refentrytitle>ipf</refentrytitle><manvolnum>5</manvolnum></citerefentry> for a list of letters and their flags.</para>

      <para xml:lang="en">If the packet is an <acronym>ICMP</acronym> packet, there
	will be two fields at the end:  the first always being
	<quote>icmp</quote> and the next being the
	<acronym>ICMP</acronym> message and sub-message type,
	separated by a slash.  For example:
	<literal>icmp 3/3</literal> for a port unreachable
	message.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="firewalls-blacklistd">
    <title xml:lang="en">Blacklistd</title>

    <para xml:lang="en">Blacklistd is a daemon listening to sockets to receive
      notifications from other daemons about connection attempts
      that failed or were successful.  It is most widely used in
      blocking too many connection attempts on open ports.  A
      prime example is <application>SSH</application> running on
      the internet getting a lot of requests from bots or scripts
      trying to guess passwords and gain access.  Using
      <application>blacklistd</application>, the daemon can notify
      the firewall to create a filter rule to block excessive
      connection attempts from a single source after a number of
      tries.  Blacklistd was first developed on
      NetBSD and appeared there in version 7.  FreeBSD 11
      imported blacklistd from NetBSD.</para>

    <para xml:lang="en">This chapter describes how to set up blacklistd,
      configure it, and provides examples on how to use it.
      Readers should be familiar with basic firewall concepts like
      rules.  For details, refer to the firewall chapter.  PF is
      used in the examples, but other firewalls available on
      FreeBSD should be able to work with blacklistd, too.</para>

    <sect2>
      <title>開啟 Blacklistd</title>

      <para xml:lang="en">The main configuration for blacklistd is stored in
	<citerefentry><refentrytitle>blacklistd.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.  Various command line options are
	also available to change blacklistd's run-time behavior.
	Persistent configuration across reboots should be stored
	in <filename>/etc/blacklistd.conf</filename>.  To enable
	the daemon during system boot, add a
	<literal>blacklistd_enable</literal> line to
	<filename>/etc/rc.conf</filename> like this:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc blacklistd_enable=yes</userinput></screen>

	<para xml:lang="en">To start the service manually, run this command:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service blacklistd start</userinput></screen>
    </sect2>

    <sect2>
      <title>建立 Blacklistd 規則集</title>

      <para xml:lang="en">Rules for blacklistd are configured in
	<citerefentry><refentrytitle>blacklistd.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry> with one entry per line.  Each
	rule contains a tuple separated by spaces or tabs.  Rules
	either belong to a <literal>local</literal> or a
	<literal>remote</literal>, which applies to the machine
	where blacklistd is running or an outside source,
	respectively.</para>

      <sect3>
	<title>本地規則</title>

	<para xml:lang="en">An example blacklistd.conf entry for a local rule
	  looks like this:</para>

	<programlisting xml:lang="en">[local]
ssh             stream  *       *               *       3       24h</programlisting>

	<para xml:lang="en">All rules that follow the <literal>[local]</literal>
	  section are treated as local rules (which is the
	  default), applying to the local machine.  When a
	  <literal>[remote]</literal> section is encountered, all
	  rules that follow it are handled as remote machine
	  rules.</para>

	<para xml:lang="en">Seven fields define a rule separated by either tabs
	  or spaces.  The first four fields identify the traffic
	  that should be blacklisted.  The three fields that
	  follow define backlistd's behavior.  Wildcards are
	  denoted as asterisks (<literal>*</literal>), matching
	  anything in this field.  The first field defines the
	  location.  In local rules, these are the network ports.
	  The syntax for the location field is as follows:</para>

	  <programlisting xml:lang="en">[<replaceable>address</replaceable>|<replaceable>interface</replaceable>][/<replaceable>mask</replaceable>][:<replaceable>port</replaceable>]</programlisting>

	  <para xml:lang="en">Adressses can be specified as IPv4 in numeric format
	    or IPv6 in square brackets.  An interface name like
	    <literal><replaceable>em0</replaceable></literal> can also
	    be used.</para>

	  <para xml:lang="en">The socket type is defined by the second field.  TCP
	    sockets are of type <literal>stream</literal>, whereas UDP
	    is denoted as <literal>dgram</literal>.  The example above
	    uses TCP, since SSH is using that protocol.</para>

	  <para xml:lang="en">A protocol can be used in the third field of a
	    blacklistd rule.  The following protocols can be used:
	    <literal>tcp</literal>, <literal>udp</literal>,
	    <literal>tcp6</literal>, <literal>udp6</literal>, or
	    numeric.  A wildcard, like in the example, is typically
	    used to match all protocols unless there is a reason to
	    distinguish traffic by a certain protocol.</para>

	  <para xml:lang="en">In the fourth field, the effective user or owner of
	    the daemon process that is reporting the event is defined.
	    The username or <acronym>UID</acronym> can be used here,
	    as well as a wildcard (see example rule above).</para>

	  <para xml:lang="en">The packet filter rule name is declared by the fifth
	    field, which starts the behavior part of the rule.  By
	    default, blacklistd puts all blocks under a pf anchor
	    called <literal>blacklistd</literal> in
	    <filename>pf.conf</filename> like this:</para>

	  <programlisting xml:lang="en">anchor "blacklistd/*" in on $ext_if
block in
pass out</programlisting>

	  <para xml:lang="en">For separate blacklists, an anchor name can be used in
	    this field.  In other cases, the wildcard will suffice.
	    When a name starts with a hyphen (<literal>-</literal>) it
	    means that an anchor with the default rule name prepended
	    should be used.  A modified example from the above using
	    the hyphen would look like this:</para>

	  <programlisting xml:lang="en">ssh             stream  *       *               -ssh       3       24h</programlisting>

	  <para xml:lang="en">With such a rule, any new blacklist rules are added to
	    an anchor called <literal>blacklistd-ssh</literal>.</para>

	  <para xml:lang="en">To block whole subnets for a single rule violation, a
	    <literal>/</literal> in the rule name can be used.  This
	    causes the remaining portion of the name to be interpreted
	    as the mask to be applied to the address specified in
	    the rule.  For example, this rule would block every
	    address adjoining <literal>/24</literal>.</para>

	  <programlisting xml:lang="en">22              stream  tcp       *               */24    3       24h</programlisting>

	  <note>
	    <para xml:lang="en">It is important to specify the proper
	      protocol here.  IPv4 and IPv6 treat /24 differently,
	      that is the reason why <literal>*</literal> cannot be
	      used in the third field for this rule.</para>
	  </note>

	  <para xml:lang="en">This rule defines that if any one host in that network
	    is misbehaving, everything else on that network will be
	    blocked, too.</para>

	  <para xml:lang="en">The sixth field, called <literal>nfail</literal>, sets
	    the number of login failures required to blacklist the
	    remote IP in question.  When a wildcard is used at this
	    position, it means that blocks will never happen.  In the
	    example rule above, a limit of three is defined meaning
	    that after three attempts to log into
	    <application>SSH</application> on one connection, the IP
	    is blocked.</para>

	  <para xml:lang="en">The last field in a blacklistd rule definition
	    specifies how long a host is blacklisted.  The default
	    unit is seconds, but suffixes like <literal>m</literal>,
	    <literal>h</literal>, and <literal>d</literal> can also be
	    specified for minutes, hours, and days,
	    respectively.</para>

	  <para xml:lang="en">The example rule in its entirety means that after
	    three times authenticating to
	    <application>SSH</application> will result in a new PF
	    block rule for that host.  Rule matches are performed by
	    first checking local rules one after another, from most
	    specific to least specific.  When a match occurs, the
	    <literal>remote</literal> rules are applied and the name,
	    <literal>nfail</literal>, and disable fields are changed
	    by the <literal>remote</literal> rule that matched.</para>
	</sect3>

	<sect3>
	  <title>遠端規則</title>

	  <para xml:lang="en">Remote rules are used to specify how blacklistd
	    changes its behavior depending on the remote host
	    currently being evaluated.  Each field in a remote rule
	    is the same as in a local rule.  The only difference is
	    in the way blacklistd is using them.  To explain it,
	    this example rule is used:</para>

	  <programlisting xml:lang="en">[remote]
203.0.113.128/25 *      *       *               =/25    =       48h</programlisting>

	  <para xml:lang="en">The address field can be an IP address (either v4 or
	    v6), a port or both.  This allows setting special rules
	    for a specific remote address range like in this example.
	    The fields for type, protocol and owner are identically
	    interpreted as in the local rule.</para>

	  <para xml:lang="en">The name fields is different though: the equal sign
	    (<literal>=</literal>) in a remote rule tells blacklistd
	    to use the value from the matching local rule.  It means
	    that the firewall rule entry is taken and the
	    <systemitem class="netmask">/25</systemitem> prefix (a
	    netmask of <systemitem class="netmask">255.255.255.128</systemitem>) is added.
	    When a connection from that address range is blacklisted,
	    the entire subnet is affected.  A PF anchor name can also
	    be used here, in which case blacklistd will add rules for
	    this address block to the anchor of that name.  The
	    default table is used when a wildcard is specified.</para>

	  <para xml:lang="en">A custom number of failures in the
	    <literal>nfail</literal> column can be defined for an
	    address.  This is useful for exceptions to a specific
	    rule, to maybe allow someone a less strict application
	    of rules or a bit more leniency in login tries.
	    Blocking is disabled when an asterisk is used in this
	    sixth field.</para>

	  <para xml:lang="en">Remote rules allow a stricter enforcement of limits
	    on attempts to log in compared to attempts coming from a
	    local network like an office.</para>
	</sect3>
      </sect2>

      <sect2>
	<title>Blacklistd 客戶端設定</title>

	<para xml:lang="en">There are a few software packages in FreeBSD that can
	  utilize blacklistd's functionality.  The two most
	  prominent ones are <citerefentry><refentrytitle>ftpd</refentrytitle><manvolnum>8</manvolnum></citerefentry> and <citerefentry><refentrytitle>sshd</refentrytitle><manvolnum>8</manvolnum></citerefentry> to block
	  excessive connection attempts.  To activate blacklistd in
	  the SSH daemon, add the following line to
	  <filename>/etc/ssh/sshd_config</filename>:</para>

	<programlisting xml:lang="en">UseBlacklist yes</programlisting>

	<para>接著重新啟動 sshd 來使變更生效。</para>

	<para xml:lang="en">Blacklisting for <citerefentry><refentrytitle>ftpd</refentrytitle><manvolnum>8</manvolnum></citerefentry> is enabled using
	  <literal>-B</literal>, either in
	  <filename>/etc/inetd.conf</filename> or as a
	  flag in <filename>/etc/rc.conf</filename> like
	  this:</para>

	<programlisting xml:lang="en">ftpd_flags="-B"</programlisting>

	<para xml:lang="en">That is all that is needed to make these programs
	  talk to blacklistd.</para>
      </sect2>

      <sect2>
	<title>Blacklistd 管理</title>

	<para xml:lang="en">Blacklistd provides the user with a management utility
	  called <citerefentry><refentrytitle>blacklistctl</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  It displays blocked
	  addresses and networks that are blacklisted by the rules
	  defined in <citerefentry><refentrytitle>blacklistd.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.  To see the
	  list of currently blocked hosts, use
	  <command>dump</command> combined with <option>-b</option>
	  like this.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>blacklistctl dump -b</userinput>
      address/ma:port id      nfail   last access
213.0.123.128/25:22   OK      6/3     2019/06/08 14:30:19</screen>

	<para xml:lang="en">This example shows that there were 6 out of three
	  permitted attempts on port 22 coming from the address
	  range <systemitem class="netmask">213.0.123.128/25</systemitem>.  There
	  are more attempts listed than are allowed because SSH
	  allows a client to try multiple logins on a single TCP
	  connection.  A connection that is currently going on is
	  not stopped by blacklistd.  The last connection attempt is
	  listed in the <literal>last access</literal> column of the
	  output.</para>

	<para xml:lang="en">To see the remaining time that this host will be on
	  the blacklist, add <option>-r</option> to the previous
	  command.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>blacklistctl dump -br</userinput>
      address/ma:port id      nfail   remaining time
213.0.123.128/25:22   OK      6/3     36s</screen>

	<para xml:lang="en">In this example, there are 36s seconds left until this
	  host will not be blocked any more.</para>
      </sect2>

      <sect2>
	<title>從封鎖清單移除主機</title>

	<para xml:lang="en">Sometimes it is necessary to remove a host from the
	  block list before the remaining time expires.
	  Unfortunately, there is no functionality in blacklistd to
	  do that.  However, it is possible to remove the address
	  from the PF table using pfctl.  For each blocked port,
	  there is a child anchor inside the blacklistd anchor
	  defined in <filename>/etc/pf.conf</filename>.  For
	  example, if there is a child anchor for blocking port 22
	  it is called <literal>blacklistd/22</literal>.  There is a
	  table inside that child anchor that contains the blocked
	  addresses.  This table is called port followed by the port
	  number.  In this example, it would be called
	  <literal>port22</literal>.  With that information at hand,
	  it is now possible to use <citerefentry><refentrytitle>pfctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> to display all
	  addresses listed like this:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pfctl -a <replaceable>blacklistd/22</replaceable> -t <replaceable>port22</replaceable> -T show</userinput>
...
213.0.123.128/25
...</screen>

	<para xml:lang="en">After identifying the address to be unblocked from the
	  list, the following command removes it from the list:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>pfctl -a <replaceable>blacklistd/22</replaceable> -T delete <replaceable>213.0.123.128/25</replaceable></userinput></screen>

	<para xml:lang="en">The address is now removed from PF, but will still
	  show up in the blacklistctl list, since it does not know
	  about any changes made in PF.  The entry in blacklistd's
	  database will eventually expire and be removed from its
	  output eventually.  The entry will be added again if the
	  host is matching one of the block rules in blacklistd
	  again.</para>
      </sect2>
    </sect1>
</chapter>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<chapter version="5.0" xml:id="advanced-networking">
  <title>進階網路設定</title>

  <sect1 xml:id="advanced-networking-synopsis">
    <title>概述</title>

    <para xml:lang="en">This chapter covers a number of advanced networking
      topics.</para>

    <para>讀完這章，您將了解：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">The basics of gateways and routes.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to set up USB tethering.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to set up <trademark class="registered">IEEE</trademark> 802.11 and <trademark class="registered">Bluetooth</trademark>
	  devices.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to make FreeBSD act as a bridge.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to set up network <acronym>PXE</acronym>
	  booting.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to set up <acronym>IPv6</acronym> on a FreeBSD
	  machine.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">How to enable and utilize the features of the Common
	  Address Redundancy Protocol (<acronym>CARP</acronym>) in
	  FreeBSD.</para>
      </listitem>

      <listitem>
	<para>如何在 FreeBSD 上設定多個 <acronym>VLAN</acronym>。</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Configure bluetooth headset.</para>
      </listitem>
    </itemizedlist>

    <para>在開始閱讀這章之前，您需要：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Understand the basics of the
	  <filename>/etc/rc</filename> scripts.</para>
      </listitem>

      <listitem>
	<para>熟悉基本網路術語。</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Know how to configure and install a new FreeBSD kernel
	  (<xref linkend="kernelconfig"/>).</para>
      </listitem>

      <listitem>
	<para>了解如何安裝其他第三方軟體 (<xref linkend="ports"/>)。</para>
      </listitem>

    </itemizedlist>
  </sect1>

  <sect1 xml:id="network-routing">
    <info>
      <title>通訊閘與路由</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Coranth</firstname>
	    <surname>Gryphon</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>routing</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>gateway</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>subnet</primary>
    </indexterm>

    <para xml:lang="en"><firstterm>Routing</firstterm> is the mechanism that allows
      a system to find the network path to another system.  A
      <firstterm>route</firstterm> is a defined pair of addresses
      which represent the <quote>destination</quote> and a
      <quote>gateway</quote>.  The route indicates that when trying
      to get to the specified destination, send the packets through
      the specified gateway.  There are three types of destinations:
      individual hosts, subnets, and <quote>default</quote>.  The
      <quote>default route</quote> is used if no other routes apply.
      There are also three types of gateways: individual hosts,
      interfaces, also called links, and Ethernet hardware
      (<acronym>MAC</acronym>) addresses.  Known routes are stored in
      a routing table.</para>

    <para xml:lang="en">This section provides an overview of routing basics.  It
      then demonstrates how to configure a FreeBSD system as a router and
      offers some troubleshooting tips.</para>

    <sect2 xml:id="network-routing-default">
      <title>路由基礎概念</title>

      <para xml:lang="en">To view the routing table of a FreeBSD system, use
	<citerefentry><refentrytitle>netstat</refentrytitle><manvolnum>1</manvolnum></citerefentry>:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>netstat -r</userinput>
Routing tables

Internet:
Destination      Gateway            Flags     Refs     Use     Netif Expire
default          outside-gw         UGS        37      418       em0
localhost        localhost          UH          0      181       lo0
test0            0:e0:b5:36:cf:4f   UHLW        5    63288       re0     77
10.20.30.255     link#1             UHLW        1     2421
example.com      link#1             UC          0        0
host1            0:e0:a8:37:8:1e    UHLW        3     4601       lo0
host2            0:e0:a8:37:8:1e    UHLW        0        5       lo0 =&gt;
host2.example.com link#1            UC          0        0
224              link#1             UC          0        0</screen>

      <para xml:lang="en">The entries in this example are as follows:</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">default</term>
	  <listitem>
	    <para xml:lang="en">The first route in this table specifies the
	      <literal>default</literal> route.  When the local system
	      needs to make a connection to a remote host, it checks
	      the routing table to determine if a known path exists.
	      If the remote host matches an entry in the table, the
	      system checks to see if it can connect using the
	      interface specified in that entry.</para>

	    <para xml:lang="en">If the destination does not match an entry, or if
	      all known paths fail, the system uses the entry for the
	      default route.  For hosts on a local area network, the
	      <literal>Gateway</literal> field in the default route is
	      set to the system which has a direct connection to the
	      Internet.  When reading this entry, verify that the
	      <literal>Flags</literal> column indicates that the
	      gateway is usable (<literal>UG</literal>).</para>

	    <para xml:lang="en">The default route for a machine which itself is
	      functioning as the gateway to the outside world will be
	      the gateway machine at the Internet Service Provider
	      (<acronym>ISP</acronym>).</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">localhost</term>
	  <listitem>
	    <para xml:lang="en">The second route is the <literal>localhost</literal>
	      route.  The interface specified in the
	      <literal>Netif</literal> column for
	      <literal>localhost</literal> is
	      <filename>lo0</filename>, also known as the loopback
	      device.  This indicates that all traffic for this
	      destination should be internal, rather than sending it
	      out over the network.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">MAC address</term>
	  <listitem>
	    <para xml:lang="en">The addresses beginning with <systemitem class="etheraddress">0:e0:</systemitem> are
	      <acronym>MAC</acronym> addresses.  FreeBSD will
	      automatically identify any hosts,
	      <systemitem>test0</systemitem> in the example, on the
	      local Ethernet and add a route for that host over the
	      Ethernet interface, <filename>re0</filename>.  This type
	      of route has a timeout, seen in the
	      <literal>Expire</literal> column, which is used if the
	      host does not respond in a specific amount of time.
	      When this happens, the route to this host will be
	      automatically deleted.  These hosts are identified using
	      the Routing Information Protocol
	      (<acronym>RIP</acronym>), which calculates routes to
	      local hosts based upon a shortest path
	      determination.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">subnet</term>
	  <listitem>
	    <para xml:lang="en">FreeBSD will automatically add subnet routes for the
	      local subnet.  In this example, <systemitem class="ipaddress">10.20.30.255</systemitem> is the
	      broadcast address for the subnet <systemitem class="ipaddress">10.20.30</systemitem> and
	      <systemitem class="fqdomainname">example.com</systemitem> is the
	      domain name associated with that subnet.  The
	      designation <literal>link#1</literal> refers to the
	      first Ethernet card in the machine.</para>

	    <para xml:lang="en">Local network hosts and local subnets have their
	      routes automatically configured by a daemon called
	      <citerefentry><refentrytitle>routed</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  If it is not running, only routes which
	      are statically defined by the administrator will
	      exist.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">host</term>
	  <listitem>
	    <para xml:lang="en">The <literal>host1</literal> line refers to the host
	      by its Ethernet address.  Since it is the sending host,
	      FreeBSD knows to use the loopback interface
	      (<filename>lo0</filename>) rather than the Ethernet
	      interface.</para>

	    <para xml:lang="en">The two <literal>host2</literal> lines represent
	      aliases which were created using <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  The
	      <literal>=&gt;</literal> symbol after the
	      <filename>lo0</filename> interface says that an alias
	      has been set in addition to the loopback address.  Such
	      routes only show up on the host that supports the alias
	      and all other hosts on the local network will have a
	      <literal>link#1</literal> line for such routes.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">224</term>
	  <listitem>
	    <para xml:lang="en">The final line (destination subnet <systemitem class="ipaddress">224</systemitem>) deals with
	      multicasting.</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para xml:lang="en">Various attributes of each route can be seen in the
	<literal>Flags</literal> column.  <xref linkend="routeflags"/>
	summarizes some of these flags and their meanings:</para>

      <table xml:id="routeflags" frame="none" pgwide="1">
	<title>常見路由表標記</title>

	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry>指令</entry>
	      <entry>用途</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en">U</entry>
	      <entry xml:lang="en">The route is active (up).</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">H</entry>
	      <entry xml:lang="en">The route destination is a single host.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">G</entry>
	      <entry xml:lang="en">Send anything for this destination on to this
		gateway, which will figure out from there where to
		send it.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">S</entry>
	      <entry xml:lang="en">This route was statically configured.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">C</entry>
	      <entry xml:lang="en">Clones a new route based upon this route for
		machines to connect to.  This type of route is
		normally used for local networks.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">W</entry>
	      <entry xml:lang="en">The route was auto-configured based upon a local
		area network (clone) route.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en">L</entry>
	      <entry xml:lang="en">Route involves references to Ethernet (link)
		hardware.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para xml:lang="en">On a FreeBSD system, the default route can defined in
	<filename>/etc/rc.conf</filename> by specifying the
	<acronym>IP</acronym> address of the default gateway:</para>

      <programlisting xml:lang="en">defaultrouter="10.20.30.1"</programlisting>

      <para xml:lang="en">It is also possible to manually add the route using
	<command>route</command>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>route add default 10.20.30.1</userinput></screen>

      <para xml:lang="en">Note that manually added routes will not survive a reboot.
	For more information on manual manipulation of network
	routing tables, refer to <citerefentry><refentrytitle>route</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
    </sect2>

    <sect2 xml:id="network-static-routes">
      <info>
	<title>設定路由器使用靜態路由</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Al</firstname>
	      <surname>Hoang</surname>
	    </personname>
	    <contrib>Contributed by </contrib>
	  </author>
	</authorgroup>
      </info>
      <!-- Feb 2004 -->

      <indexterm xml:lang="en">
	<primary>dual homed hosts</primary>
      </indexterm>

      <para xml:lang="en">A FreeBSD system can be configured as the default gateway, or
	router, for a network if it is a dual-homed system.  A
	dual-homed system is a host which resides on at least two
	different networks.  Typically, each network is connected to a
	separate network interface, though <acronym>IP</acronym>
	aliasing can be used to bind multiple addresses, each on a
	different subnet, to one physical interface.</para>

      <indexterm><primary>路由器</primary></indexterm>

      <para xml:lang="en">In order for the system to forward packets between
	interfaces, FreeBSD must be configured as a router.  Internet
	standards and good engineering practice prevent the FreeBSD
	Project from enabling this feature by default, but it can be
	configured to start at boot by adding this line to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">gateway_enable="YES"          # Set to YES if this host will be a gateway</programlisting>

      <para xml:lang="en">To enable routing now, set the <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> variable
	<varname>net.inet.ip.forwarding</varname> to
	<literal>1</literal>.  To stop routing, reset this variable to
	<literal>0</literal>.</para>

      <indexterm xml:lang="en">
	<primary>BGP</primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>RIP</primary>
      </indexterm>
      <indexterm xml:lang="en">
	<primary>OSPF</primary>
      </indexterm>

      <para xml:lang="en">The routing table of a router needs additional routes so
	it knows how to reach other networks.  Routes can be either
	added manually using static routes or routes can be
	automatically learned using a routing protocol.  Static routes
	are appropriate for small networks and this section describes
	how to add a static routing entry for a small network.</para>

      <note>
	<para xml:lang="en">For large networks, static routes quickly become
	  unscalable.  FreeBSD comes with the standard
	  <acronym>BSD</acronym> routing daemon <citerefentry><refentrytitle>routed</refentrytitle><manvolnum>8</manvolnum></citerefentry>, which
	  provides the routing protocols <acronym>RIP</acronym>,
	  versions 1 and 2, and <acronym>IRDP</acronym>.  Support for
	  the <acronym>BGP</acronym> and <acronym>OSPF</acronym>
	  routing protocols can be installed using the
	  <package>net/zebra</package> package or port.</para>
      </note>

      <para xml:lang="en">Consider the following network:</para>

      <mediaobject>
	<imageobject>
	  <imagedata fileref="advanced-networking/static-routes"/>
	</imageobject>

	<textobject>
	<literallayout class="monospaced" xml:lang="en">
    INTERNET
      | (10.0.0.1/24) Default Router to Internet
      |
      |Interface xl0
      |10.0.0.10/24
   +------+
   |      | RouterA
   |      | (FreeBSD gateway)
   +------+
      | Interface xl1
      | 192.168.1.1/24
      |
  +--------------------------------+
   Internal Net 1      | 192.168.1.2/24
                       |
                   +------+
                   |      | RouterB
                   |      |
                   +------+
                       | 192.168.2.1/24
                       |
                     Internal Net 2</literallayout>
	</textobject>
      </mediaobject>

      <para xml:lang="en">In this scenario, <systemitem>RouterA</systemitem> is a
	FreeBSD machine that is acting as a router to the rest of the
	Internet.  It has a default route set to <systemitem class="ipaddress">10.0.0.1</systemitem> which allows it to
	connect with the outside world.
	<systemitem>RouterB</systemitem> is already configured to use
	<systemitem class="ipaddress">192.168.1.1</systemitem> as its
	default gateway.</para>

      <para xml:lang="en">Before adding any static routes, the routing table on
	<systemitem>RouterA</systemitem> looks like this:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>netstat -nr</userinput>
Routing tables

Internet:
Destination        Gateway            Flags    Refs      Use  Netif  Expire
default            10.0.0.1           UGS         0    49378    xl0
127.0.0.1          127.0.0.1          UH          0        6    lo0
10.0.0.0/24        link#1             UC          0        0    xl0
192.168.1.0/24     link#2             UC          0        0    xl1</screen>

      <para xml:lang="en">With the current routing table,
	<systemitem>RouterA</systemitem> does not have a route to the
	<systemitem class="ipaddress">192.168.2.0/24</systemitem>
	network.  The following command adds the <literal>Internal Net
	  2</literal> network to <systemitem>RouterA</systemitem>'s
	routing table using <systemitem class="ipaddress">192.168.1.2</systemitem> as the next
	hop:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>route add -net 192.168.2.0/24 192.168.1.2</userinput></screen>

      <para xml:lang="en">Now, <systemitem>RouterA</systemitem> can reach any host
	on the <systemitem class="ipaddress">192.168.2.0/24</systemitem> network.
	However, the routing information will not persist if the FreeBSD
	system reboots.  If a static route needs to be persistent, add
	it to <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en"># Add Internal Net 2 as a persistent static route
static_routes="internalnet2"
route_internalnet2="-net 192.168.2.0/24 192.168.1.2"</programlisting>

      <para xml:lang="en">The <literal>static_routes</literal> configuration
	variable is a list of strings separated by a space, where each
	string references a route name.  The variable
	<literal>route_<replaceable>internalnet2</replaceable></literal>
	contains the static route for that route name.</para>

      <para xml:lang="en">Using more than one string in
	<literal>static_routes</literal> creates multiple static
	routes.  The following shows an example of adding static
	routes for the <systemitem class="ipaddress">192.168.0.0/24</systemitem> and
	<systemitem class="ipaddress">192.168.1.0/24</systemitem>
	networks:</para>

      <programlisting xml:lang="en">static_routes="net1 net2"
route_net1="-net 192.168.0.0/24 192.168.0.1"
route_net2="-net 192.168.1.0/24 192.168.1.1"</programlisting>
    </sect2>

    <sect2 xml:id="network-routing-troubleshooting">
      <title>疑難排解</title>

      <para xml:lang="en">When an address space is assigned to a network, the
	service provider configures their routing tables so that all
	traffic for the network will be sent to the link for the site.
	But how do external sites know to send their packets to the
	network's <acronym>ISP</acronym>?</para>

      <para xml:lang="en">There is a system that keeps track of all assigned
	address spaces and defines their point of connection to the
	Internet backbone, or the main trunk lines that carry Internet
	traffic across the country and around the world.  Each
	backbone machine has a copy of a master set of tables, which
	direct traffic for a particular network to a specific
	backbone carrier, and from there down the chain of service
	providers until it reaches a particular network.</para>

      <para xml:lang="en">It is the task of the service provider to advertise to
	the backbone sites that they are the point of connection, and
	thus the path inward, for a site.  This is known as route
	propagation.</para>

      <indexterm xml:lang="en">
	<primary><citerefentry><refentrytitle>traceroute</refentrytitle><manvolnum>8</manvolnum></citerefentry></primary>
      </indexterm>

      <para xml:lang="en">Sometimes, there is a problem with route propagation and
	some sites are unable to connect.  Perhaps the most useful
	command for trying to figure out where routing is breaking
	down is <command>traceroute</command>.  It is useful when
	<command>ping</command> fails.</para>

      <para xml:lang="en">When using <command>traceroute</command>, include the
	address of the remote host to connect to.  The output will
	show the gateway hosts along the path of the attempt,
	eventually either reaching the target host, or terminating
	because of a lack of connection.  For more information, refer
	to <citerefentry><refentrytitle>traceroute</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
    </sect2>

    <sect2 xml:id="network-routing-multicast">
      <title>群播 (Multicast) 注意事項</title>

      <indexterm xml:lang="en">
	<primary>multicast routing</primary>
      </indexterm>
      <indexterm><primary>核心選項</primary> <secondary>MROUTING</secondary></indexterm>

      <para xml:lang="en">FreeBSD natively supports both multicast applications and
	multicast routing.  Multicast applications do not require any
	special configuration in order to run on FreeBSD.  Support for
	multicast routing requires that the following option be
	compiled into a custom kernel:</para>

      <programlisting xml:lang="en">options MROUTING</programlisting>

      <para xml:lang="en">The multicast routing daemon,
	<application>mrouted</application> can be installed using the
	<package>net/mrouted</package> package or port.  This daemon
	implements the <acronym>DVMRP</acronym> multicast routing
	protocol and is configured by editing
	<filename>/usr/local/etc/mrouted.conf</filename> in order to
	set up the tunnels and <acronym>DVMRP</acronym>.  The
	installation of <application>mrouted</application> also
	installs <application>map-mbone</application> and
	<application>mrinfo</application>, as well as their associated
	man pages.  Refer to these for configuration examples.</para>

      <note>
	<para xml:lang="en"><acronym>DVMRP</acronym> has largely been replaced by
	  the <acronym>PIM</acronym> protocol in many multicast
	  installations.  Refer to <citerefentry><refentrytitle>pim</refentrytitle><manvolnum>4</manvolnum></citerefentry> for more
	  information.</para>
      </note>
    </sect2>
  </sect1>

  <sect1 xml:id="network-wireless">
    <info>
      <title>無線網路</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <othername>Loader</othername>
	  </personname>
	</author>
	<author xml:lang="en">
	  <personname>
	    <firstname>Marc</firstname>
	    <surname>Fonvieille</surname>
	  </personname>
	</author>
	<author xml:lang="en">
	  <personname>
	    <firstname>Murray</firstname>
	    <surname>Stokely</surname>
	  </personname>
	</author>
      </authorgroup>
    </info>

    <indexterm><primary>無線網路</primary></indexterm>
    <indexterm><primary>802.11</primary> <see>無線網路</see></indexterm>

    <sect2>
      <title>無線網路基礎</title>

      <para xml:lang="en">Most wireless networks are based on the <trademark class="registered">IEEE</trademark> 802.11
	standards.  A basic wireless network consists of multiple
	stations communicating with radios that broadcast in either
	the 2.4GHz or 5GHz band, though this varies according to the
	locale and is also changing to enable communication in the
	2.3GHz and 4.9GHz ranges.</para>

      <para xml:lang="en">802.11 networks are organized in two ways.  In
	<emphasis>infrastructure mode</emphasis>, one station acts as
	a
	master with all the other stations associating to it, the
	network is known as a <acronym>BSS</acronym>, and the master
	station is termed an access point (<acronym>AP</acronym>).
	In a <acronym>BSS</acronym>, all communication passes through
	the <acronym>AP</acronym>; even when one station wants to
	communicate with another wireless station, messages must go
	through the <acronym>AP</acronym>.  In the second form of
	network, there is no master and stations communicate directly.
	This form of network is termed an <acronym>IBSS</acronym>
	and is commonly known as an <emphasis>ad-hoc
	  network</emphasis>.</para>

      <para xml:lang="en">802.11 networks were first deployed in the 2.4GHz band
	using protocols defined by the <trademark class="registered">IEEE</trademark> 802.11 and 802.11b
	standard.  These specifications include the operating
	frequencies and the <acronym>MAC</acronym> layer
	characteristics, including framing and transmission rates,
	as communication can occur at various rates.  Later, the
	802.11a standard defined operation in the 5GHz band, including
	different signaling mechanisms and higher transmission rates.
	Still later, the 802.11g standard defined the use of 802.11a
	signaling and transmission mechanisms in the 2.4GHz band in
	such a way as to be backwards compatible with 802.11b
	networks.</para>

      <para xml:lang="en">Separate from the underlying transmission techniques,
	802.11 networks have a variety of security mechanisms.  The
	original 802.11 specifications defined a simple security
	protocol called <acronym>WEP</acronym>.  This protocol uses a
	fixed pre-shared key and the RC4 cryptographic cipher to
	encode data transmitted on a network.  Stations must all
	agree on the fixed key in order to communicate.  This scheme
	was shown to be easily broken and is now rarely used except
	to discourage transient users from joining networks.  Current
	security practice is given by the <trademark class="registered">IEEE</trademark> 802.11i specification
	that defines new cryptographic ciphers and an additional
	protocol to authenticate stations to an access point and
	exchange keys for data communication.  Cryptographic keys
	are periodically refreshed and there are mechanisms for
	detecting and countering intrusion attempts.  Another
	security protocol specification commonly used in wireless
	networks is termed <acronym>WPA</acronym>, which was a
	precursor to 802.11i.  <acronym>WPA</acronym> specifies a
	subset of the requirements found in 802.11i and is designed
	for implementation on legacy hardware.  Specifically,
	<acronym>WPA</acronym> requires only the
	<acronym>TKIP</acronym> cipher that is derived from the
	original <acronym>WEP</acronym> cipher.  802.11i permits use
	of <acronym>TKIP</acronym> but also requires support for a
	stronger cipher, AES-CCM, for encrypting data.  The
	<acronym>AES</acronym> cipher was not required in
	<acronym>WPA</acronym> because it was deemed too
	computationally costly to be implemented on legacy
	hardware.</para>

      <para xml:lang="en">The other standard to be aware of is 802.11e.  It defines
	protocols for deploying multimedia applications, such as
	streaming video and voice over IP (<acronym>VoIP</acronym>),
	in an 802.11 network.  Like 802.11i, 802.11e also has a
	precursor specification termed <acronym>WME</acronym> (later
	renamed <acronym>WMM</acronym>) that has been defined by an
	industry group as a subset of 802.11e that can be deployed now
	to enable multimedia applications while waiting for the final
	ratification of 802.11e.  The most important thing to know
	about 802.11e and
	<acronym>WME</acronym>/<acronym>WMM</acronym> is that it
	enables prioritized traffic over a wireless network through
	Quality of Service (<acronym>QoS</acronym>) protocols and
	enhanced media access protocols.  Proper implementation of
	these protocols enables high speed bursting of data and
	prioritized traffic flow.</para>

      <para xml:lang="en">FreeBSD supports networks that operate using 802.11a,
	802.11b, and 802.11g.  The <acronym>WPA</acronym> and 802.11i
	security protocols are likewise supported (in conjunction with
	any of 11a, 11b, and 11g) and <acronym>QoS</acronym> and
	traffic prioritization required by the
	<acronym>WME</acronym>/<acronym>WMM</acronym> protocols are
	supported for a limited set of wireless devices.</para>
    </sect2>

    <sect2 xml:id="network-wireless-quick-start">
      <title>快速開始</title>

      <para xml:lang="en">Connecting a computer to an existing wireless network is
	a very common situation.  This procedure shows the steps
	required.</para>

      <procedure>
	<step>
	  <para xml:lang="en">Obtain the <acronym>SSID</acronym> (Service Set
	    Identifier) and <acronym>PSK</acronym> (Pre-Shared Key)
	    for the wireless network from the network
	    administrator.</para>
	</step>

	<step>
	  <para xml:lang="en">Identify the wireless adapter.  The FreeBSD
	    <filename>GENERIC</filename> kernel includes drivers for
	    many common wireless adapters.  If the wireless adapter is
	    one of those models, it will be shown in the output from
	    <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>ifconfig | grep -B3 -i wireless</userinput></screen>

	  <para xml:lang="en">On FreeBSD 11 or higher, use this command
	    instead:</para>

	  <screen xml:lang="en"><prompt>%</prompt> <userinput>sysctl net.wlan.devices</userinput></screen>

	  <para xml:lang="en">If a wireless adapter is not listed, an additional
	    kernel module might be required, or it might be a model
	    not supported by FreeBSD.</para>
	  <!-- WB: refer to section that shows how to identify a
	  wireless adapter and load the kernel modules for it. -->

	  <para xml:lang="en">This example shows the Atheros <literal>ath0</literal>
	    wireless adapter.</para>
	</step>

	<step>
	  <para xml:lang="en">Add an entry for this network to
	    <filename>/etc/wpa_supplicant.conf</filename>.  If the
	    file does not exist, create it.  Replace
	    <replaceable>myssid</replaceable> and
	    <replaceable>mypsk</replaceable> with the
	    <acronym>SSID</acronym> and <acronym>PSK</acronym>
	    provided by the network administrator.</para>

	  <programlisting xml:lang="en">network={
	ssid="<replaceable>myssid</replaceable>"
	psk="<replaceable>mypsk</replaceable>"
}</programlisting>
	</step>

	<step>
	  <para xml:lang="en">Add entries to <filename>/etc/rc.conf</filename> to
	    configure the network on startup:</para>

	  <programlisting xml:lang="en">wlans_<replaceable>ath0</replaceable>="wlan0"
ifconfig_wlan0="WPA SYNCDHCP"</programlisting>
	</step>

	<step>
	  <para xml:lang="en">Restart the computer, or restart the network service
	    to connect to the network:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>service netif restart</userinput></screen>
	</step>
      </procedure>
    </sect2>

    <sect2 xml:id="network-wireless-basic">
      <title>基礎設定</title>

      <sect3>
	<title>核心設定</title>

	<para xml:lang="en">To use wireless networking, a wireless networking card
	  is needed and the kernel needs to be configured with the
	  appropriate wireless networking support.  The kernel is
	  separated into multiple modules so that only the required
	  support needs to be configured.</para>

	<para xml:lang="en">The most
	  commonly used wireless devices are those that use parts made
	  by Atheros.  These devices are supported by <citerefentry><refentrytitle>ath</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	  and require the following line to be added to
	  <filename>/boot/loader.conf</filename>:</para>

	<programlisting xml:lang="en">if_ath_load="YES"</programlisting>

	<para xml:lang="en">The Atheros driver is split up into three separate
	  pieces: the driver (<citerefentry><refentrytitle>ath</refentrytitle><manvolnum>4</manvolnum></citerefentry>), the hardware support
	  layer that handles chip-specific functions
	  (<citerefentry><refentrytitle>ath_hal</refentrytitle><manvolnum>4</manvolnum></citerefentry>), and an algorithm for selecting the
	  rate for transmitting frames.  When this support is loaded
	  as kernel modules, any dependencies are automatically
	  handled.  To load support for a different type of wireless
	  device, specify the module for that device.  This example
	  is for devices based on the Intersil Prism parts
	  (<citerefentry><refentrytitle>wi</refentrytitle><manvolnum>4</manvolnum></citerefentry>) driver:</para>

	<programlisting xml:lang="en">if_wi_load="YES"</programlisting>

	<note>
	  <para xml:lang="en">The examples in this section use an <citerefentry><refentrytitle>ath</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	    device and the device name in the examples must be
	    changed according to the configuration.  A list of
	    available wireless drivers and supported adapters can be
	    found in the FreeBSD Hardware Notes, available on
	    the <link xlink:href="https://www.FreeBSD.org/releases/index.html">Release
	      Information</link> page of the FreeBSD website.  If a
	    native FreeBSD driver for the wireless device does not
	    exist, it may be possible to use the <trademark class="registered">Windows</trademark> driver
	    with the help of the <link linkend="config-network-ndis">NDIS</link> driver
	    wrapper.</para>
	</note>

	<para xml:lang="en">In addition, the modules that implement cryptographic
	  support for the security protocols to use must be loaded.
	  These are intended to be dynamically loaded on demand by
	  the <citerefentry><refentrytitle>wlan</refentrytitle><manvolnum>4</manvolnum></citerefentry> module, but for now they must be manually
	  configured.  The following modules are available:
	  <citerefentry><refentrytitle>wlan_wep</refentrytitle><manvolnum>4</manvolnum></citerefentry>, <citerefentry><refentrytitle>wlan_ccmp</refentrytitle><manvolnum>4</manvolnum></citerefentry>, and <citerefentry><refentrytitle>wlan_tkip</refentrytitle><manvolnum>4</manvolnum></citerefentry>.
	  The <citerefentry><refentrytitle>wlan_ccmp</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>wlan_tkip</refentrytitle><manvolnum>4</manvolnum></citerefentry> drivers are
	  only needed when using the <acronym>WPA</acronym> or
	  802.11i security protocols.  If the network does not use
	  encryption, <citerefentry><refentrytitle>wlan_wep</refentrytitle><manvolnum>4</manvolnum></citerefentry> support is not needed.  To
	  load these modules at boot time, add the following lines to
	  <filename>/boot/loader.conf</filename>:</para>

	<programlisting xml:lang="en">wlan_wep_load="YES"
wlan_ccmp_load="YES"
wlan_tkip_load="YES"</programlisting>

	<para xml:lang="en">Once this information has been added to
	  <filename>/boot/loader.conf</filename>, reboot the FreeBSD
	  box.  Alternately, load the modules by hand using
	  <citerefentry><refentrytitle>kldload</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

	<note>
	  <para xml:lang="en">For users who do not want to use modules, it is
	    possible to compile these drivers into the kernel by
	    adding the following lines to a custom kernel
	    configuration file:</para>

	  <programlisting xml:lang="en">device wlan              # 802.11 support
device wlan_wep          # 802.11 WEP support
device wlan_ccmp         # 802.11 CCMP support
device wlan_tkip         # 802.11 TKIP support
device wlan_amrr         # AMRR transmit rate control algorithm
device ath               # Atheros pci/cardbus NIC's
device ath_hal           # pci/cardbus chip support
options AH_SUPPORT_AR5416 # enable AR5416 tx/rx descriptors
device ath_rate_sample   # SampleRate tx rate control for ath</programlisting>

	  <para xml:lang="en">With this information in the kernel configuration
	    file, recompile the kernel and reboot the FreeBSD
	    machine.</para>
	</note>

	<para xml:lang="en">Information about the wireless device should appear
	  in the boot messages, like this:</para>

	<screen xml:lang="en">ath0: &lt;Atheros 5212&gt; mem 0x88000000-0x8800ffff irq 11 at device 0.0 on cardbus1
ath0: [ITHREAD]
ath0: AR2413 mac 7.9 RF2413 phy 4.5</screen>
      </sect3>

      <sect3>
	<title>設定正確的區域</title>

	<para xml:lang="en">Since the regulatory situation is different
	  in various parts of the world, it is necessary to
	  correctly set the domains that apply to your location to
	  have the correct information about what channels can be
	  used.</para>

	<para xml:lang="en">The available region definitions can be found in
	  <filename>/etc/regdomain.xml</filename>.  To set the data at
	  runtime, use <command>ifconfig</command>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> regdomain <replaceable>ETSI</replaceable> country <replaceable>AT</replaceable></userinput></screen>

	<para xml:lang="en">To persist the settings, add it to
	  <filename>/etc/rc.conf</filename>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>sysrc create_args_wlan0="country <replaceable>AT</replaceable> regdomain <replaceable>ETSI</replaceable>"</userinput></screen>
      </sect3>
    </sect2>

    <sect2>
      <title>主從式 (Infrastructure)</title>

      <para xml:lang="en">Infrastructure (<acronym>BSS</acronym>) mode is the
	mode that is typically used.  In this mode, a number of
	wireless access points are connected to a wired network.
	Each wireless network has its own name, called the
	<acronym>SSID</acronym>.  Wireless clients connect to the
	wireless access points.</para>

      <sect3>
	<title>FreeBSD 客戶端</title>

	<sect4>
	  <title>如何尋找存取點</title>

	  <para xml:lang="en">To scan for available networks, use <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>.
	    This request may take a few moments to complete as it
	    requires the system to switch to each available wireless
	    frequency and probe for available access points.  Only
	    the superuser can initiate a scan:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> create wlandev <replaceable>ath0</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> up scan</userinput>
SSID/MESH ID    BSSID              CHAN RATE   S:N     INT CAPS
dlinkap         00:13:46:49:41:76   11   54M -90:96   100 EPS  WPA WME
freebsdap       00:11:95:c3:0d:ac    1   54M -83:96   100 EPS  WPA</screen>

	  <note>
	    <para xml:lang="en">The interface must be <option>up</option> before
	      it can scan.  Subsequent scan requests do not require
	      the interface to be marked as up again.</para>
	  </note>

	  <para xml:lang="en">The output of a scan request lists each
	    <acronym>BSS</acronym>/<acronym>IBSS</acronym> network
	    found.  Besides listing the name of the network, the
	    <literal>SSID</literal>, the output also shows the
	    <literal>BSSID</literal>, which is the
	    <acronym>MAC</acronym> address of the access point.  The
	    <literal>CAPS</literal> field identifies the type of
	    each network and the capabilities of the stations
	    operating there:</para>

	  <table frame="none" pgwide="0">
	    <title>站台功能代號</title>

	    <tgroup cols="2">
	      <thead>
		<row>
		  <entry>功能代號</entry>
		  <entry>意義</entry>
		</row>
	      </thead>

	      <tbody>
		<row>
		  <entry xml:lang="en"><literal>E</literal></entry>
		  <entry xml:lang="en">Extended Service Set
		    (<acronym>ESS</acronym>).  Indicates that
		    the station is part of an infrastructure network
		    rather than an <acronym>IBSS</acronym>/ad-hoc
		    network.</entry>
		</row>

		<row>
		  <entry xml:lang="en"><literal>I</literal></entry>
		  <entry xml:lang="en"><acronym>IBSS</acronym>/ad-hoc network.
		    Indicates that the station is part of an ad-hoc
		    network rather than an <acronym>ESS</acronym>
		    network.</entry>
		</row>

		<row>
		  <entry xml:lang="en"><literal>P</literal></entry>
		  <entry xml:lang="en">Privacy.  Encryption is required for all
		    data frames exchanged within the
		    <acronym>BSS</acronym> using cryptographic means
		    such as <acronym>WEP</acronym>,
		    <acronym>TKIP</acronym> or
		    <acronym>AES</acronym>-<acronym>CCMP</acronym>.</entry>
		</row>

		<row>
		  <entry xml:lang="en"><literal>S</literal></entry>
		  <entry xml:lang="en">Short Preamble.  Indicates that the network
		    is using short preambles, defined in 802.11b High
		    Rate/DSSS PHY, and utilizes a 56 bit sync field
		    rather than the 128 bit field used in long
		    preamble mode.</entry>
		</row>

		<row>
		  <entry xml:lang="en"><literal>s</literal></entry>
		  <entry xml:lang="en">Short slot time.  Indicates that the 802.11g
		    network is using a short slot time because there
		    are no legacy (802.11b) stations present.</entry>
		</row>
	      </tbody>
	    </tgroup>
	  </table>

	  <para xml:lang="en">One can also display the current list of known
	    networks with:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> list scan</userinput></screen>

	  <para xml:lang="en">This information may be updated automatically by the
	    adapter or manually with a <option>scan</option> request.
	    Old data is automatically removed from the cache, so over
	    time this list may shrink unless more scans are
	    done.</para>
	</sect4>

	<sect4>
	  <title>基礎設定</title>

	  <para xml:lang="en">This section provides a simple example of how to make
	    the wireless network adapter work in FreeBSD without
	    encryption.  Once familiar with these concepts, it is
	    strongly recommend to use <link linkend="network-wireless-wpa">WPA</link> to set up
	    the wireless network.</para>

	  <para xml:lang="en">There are three basic steps to configure a wireless
	    network: select an access point, authenticate the
	    station, and configure an <acronym>IP</acronym> address.
	    The following sections discuss each step.</para>

	  <sect5>
	    <title>選擇存取點</title>

	    <para xml:lang="en">Most of the time, it is sufficient to let the system
	      choose an access point using the builtin heuristics.
	      This is the default behavior when an interface is
	      marked as up or it is listed in
	      <filename>/etc/rc.conf</filename>:</para>

	    <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="DHCP"</programlisting>

	    <para xml:lang="en">If there are multiple access points, a specific
	      one can be selected by its
	      <acronym>SSID</acronym>:</para>

	    <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="ssid <replaceable>your_ssid_here</replaceable> DHCP"</programlisting>

	    <para xml:lang="en">In an environment where there are multiple access
	      points with the same <acronym>SSID</acronym>, which
	      is often done to simplify roaming, it may be necessary
	      to associate to one specific device.  In this case, the
	      <acronym>BSSID</acronym> of the access point can be
	      specified, with or without the
	      <acronym>SSID</acronym>:</para>

	    <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="ssid <replaceable>your_ssid_here</replaceable> bssid <replaceable>xx:xx:xx:xx:xx:xx</replaceable> DHCP"</programlisting>

	    <para xml:lang="en">There are other ways to constrain the choice of an
	      access point, such as limiting the set of frequencies
	      the system will scan on.  This may be useful for a
	      multi-band wireless card as scanning all the possible
	      channels can be time-consuming.  To limit operation to a
	      specific band, use the <option>mode</option>
	      parameter:</para>

	    <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="mode <replaceable>11g</replaceable> ssid <replaceable>your_ssid_here</replaceable> DHCP"</programlisting>

	    <para xml:lang="en">This example will force the card to operate in
	      802.11g, which is defined only for 2.4GHz frequencies
	      so any 5GHz channels will not be considered.  This can
	      also be achieved with the
	      <option>channel</option> parameter, which locks
	      operation to one specific frequency, and the
	      <option>chanlist</option> parameter, to specify a list
	      of channels for scanning.  More information about these
	      parameters can be found in <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	  </sect5>

	  <sect5>
	    <title>認證</title>

	    <para xml:lang="en">Once an access point is selected, the station
	      needs to authenticate before it can pass data.
	      Authentication can happen in several ways.  The most
	      common scheme, open authentication, allows any station
	      to join the network and communicate.  This is the
	      authentication to use for test purposes the first time
	      a wireless network is setup.  Other schemes require
	      cryptographic handshakes to be completed before data
	      traffic can flow, either using pre-shared keys or
	      secrets, or more complex schemes that involve backend
	      services such as <acronym>RADIUS</acronym>.  Open
	      authentication is the default setting.  The next most
	      common setup is <acronym>WPA-PSK</acronym>, also
	      known as <acronym>WPA</acronym> Personal, which is
	      described in <xref linkend="network-wireless-wpa-wpa-psk"/>.</para>

	    <note>
	      <para xml:lang="en">If using an <trademark class="registered">Apple</trademark> <trademark class="registered">AirPort</trademark> Extreme base
		station for an access point, shared-key authentication
		together with a <acronym>WEP</acronym> key needs to
		be configured.  This can be configured in
		<filename>/etc/rc.conf</filename> or by using
		<citerefentry><refentrytitle>wpa_supplicant</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  For a single <trademark class="registered">AirPort</trademark> base
		station, access can be configured with:</para>

	      <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="authmode shared wepmode on weptxkey <replaceable>1</replaceable> wepkey <replaceable>01234567</replaceable> DHCP"</programlisting>

	      <para xml:lang="en">In general, shared key authentication should be
		avoided because it uses the <acronym>WEP</acronym> key
		material in a highly-constrained manner, making it
		even easier to crack the key.  If
		<acronym>WEP</acronym> must be used for compatibility
		with legacy devices, it is better to use
		<acronym>WEP</acronym> with <literal>open</literal>
		authentication.  More information regarding
		<acronym>WEP</acronym> can be found in <xref linkend="network-wireless-wep"/>.</para>
	    </note>
	  </sect5>

	  <sect5>
	    <title>使用 <acronym>DHCP</acronym> 取得 <acronym>IP</acronym> 位址</title>

	    <para xml:lang="en">Once an access point is selected and the
	      authentication parameters are set, an
	      <acronym>IP</acronym> address must be obtained in
	      order to communicate.  Most of the time, the
	      <acronym>IP</acronym> address is obtained via
	      <acronym>DHCP</acronym>.  To achieve that, edit
	      <filename>/etc/rc.conf</filename> and add
	      <literal>DHCP</literal> to the configuration for the
	      device:</para>

	    <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="DHCP"</programlisting>

	    <para xml:lang="en">The
	      wireless interface is now ready to bring up:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>service netif start</userinput></screen>

	    <para xml:lang="en">Once the interface is running, use <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	      to see the status of the interface
	      <filename>ath0</filename>:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable></userinput>
wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
        ether 00:11:95:d5:43:62
        inet 192.168.1.100 netmask 0xffffff00 broadcast 192.168.1.255
        media: IEEE 802.11 Wireless Ethernet OFDM/54Mbps mode 11g
        status: associated
        ssid dlinkap channel 11 (2462 Mhz 11g) bssid 00:13:46:49:41:76
        country US ecm authmode OPEN privacy OFF txpower 21.5 bmiss 7
        scanvalid 60 bgscan bgscanintvl 300 bgscanidle 250 roam:rssi 7
        roam:rate 5 protmode CTS wme burst</screen>

	    <para xml:lang="en">The <literal>status: associated</literal> line means
	      that it is connected to the wireless network.  The
	      <literal>bssid 00:13:46:49:41:76</literal> is the
	      <acronym>MAC</acronym> address of the access point and
	      <literal>authmode OPEN</literal> indicates that the
	      communication is not encrypted.</para>
	  </sect5>

	  <sect5>
	    <title>靜態 <acronym>IP</acronym> 位址</title>

	    <para xml:lang="en">If an <acronym>IP</acronym> address cannot be
	      obtained from a <acronym>DHCP</acronym> server, set a
	      fixed <acronym>IP</acronym> address.  Replace the
	      <literal>DHCP</literal> keyword shown above with the
	      address information.  Be sure to retain any other
	      parameters for selecting the access point:</para>

	    <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="inet <replaceable>192.168.1.100</replaceable> netmask <replaceable>255.255.255.0</replaceable> ssid <replaceable>your_ssid_here</replaceable>"</programlisting>
	  </sect5>
	</sect4>

	<sect4 xml:id="network-wireless-wpa">
	  <title xml:lang="en"><acronym>WPA</acronym></title>

	  <para xml:lang="en">Wi-Fi Protected Access (<acronym>WPA</acronym>) is a
	    security protocol used together with 802.11 networks to
	    address the lack of proper authentication and the weakness
	    of <acronym>WEP</acronym>.  WPA leverages the 802.1X
	    authentication protocol and uses one of several ciphers
	    instead of <acronym>WEP</acronym> for data integrity.
	    The only cipher required by <acronym>WPA</acronym> is the
	    Temporary Key Integrity Protocol
	    (<acronym>TKIP</acronym>).  <acronym>TKIP</acronym> is a
	    cipher that extends the basic RC4 cipher used by
	    <acronym>WEP</acronym> by adding integrity checking,
	    tamper detection, and measures for responding to detected
	    intrusions.  <acronym>TKIP</acronym> is designed to work
	    on legacy hardware with only software modification.  It
	    represents a compromise that improves security but is
	    still not entirely immune to attack.
	    <acronym>WPA</acronym> also specifies the
	    <acronym>AES-CCMP</acronym> cipher as an alternative to
	    <acronym>TKIP</acronym>, and that is preferred when
	    possible.  For this specification, the term
	    <acronym>WPA2</acronym> or <acronym>RSN</acronym> is
	    commonly used.</para>

	  <para xml:lang="en"><acronym>WPA</acronym> defines authentication and
	    encryption protocols.  Authentication is most commonly
	    done using one of two techniques: by 802.1X and a backend
	    authentication service such as <acronym>RADIUS</acronym>,
	    or by a minimal handshake between the station and the
	    access point using a pre-shared secret.  The former is
	    commonly termed <acronym>WPA</acronym> Enterprise and the
	    latter is known as <acronym>WPA</acronym> Personal.  Since
	    most people will not set up a <acronym>RADIUS</acronym>
	    backend server for their wireless network,
	    <acronym>WPA-PSK</acronym> is by far the most commonly
	    encountered configuration for
	    <acronym>WPA</acronym>.</para>

	  <para xml:lang="en">The control of the wireless connection and the key
	    negotiation or authentication with a server is done using
	    <citerefentry><refentrytitle>wpa_supplicant</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  This program requires a
	    configuration file,
	    <filename>/etc/wpa_supplicant.conf</filename>, to run.
	    More information regarding this file can be found in
	    <citerefentry><refentrytitle>wpa_supplicant.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

	  <sect5 xml:id="network-wireless-wpa-wpa-psk">
	    <title xml:lang="en"><acronym>WPA-PSK</acronym></title>

	    <para xml:lang="en"><acronym>WPA-PSK</acronym>, also known as
	      <acronym>WPA</acronym> Personal, is based on a
	      pre-shared key (<acronym>PSK</acronym>) which is
	      generated from a given password and used as the master
	      key in the wireless network.  This means every wireless
	      user will share the same key.
	      <acronym>WPA-PSK</acronym> is intended for small
	      networks where the use of an authentication server is
	      not possible or desired.</para>

	    <warning>
	      <para xml:lang="en">Always use strong passwords that are sufficiently
		long and made from a rich alphabet so that they will
		not be easily guessed or attacked.</para>
	    </warning>

	    <para xml:lang="en">The first step is the configuration of
	      <filename>/etc/wpa_supplicant.conf</filename> with
	      the <acronym>SSID</acronym> and the pre-shared key of
	      the network:</para>

	    <programlisting xml:lang="en">network={
  ssid="freebsdap"
  psk="freebsdmall"
}</programlisting>

	    <para xml:lang="en">Then, in <filename>/etc/rc.conf</filename>,
	      indicate that the wireless device configuration will be
	      done with <acronym>WPA</acronym> and the
	      <acronym>IP</acronym> address will be obtained with
	      <acronym>DHCP</acronym>:</para>

	    <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="WPA DHCP"</programlisting>

	    <para xml:lang="en">Then, bring up the interface:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>service netif start</userinput>
Starting wpa_supplicant.
DHCPDISCOVER on wlan0 to 255.255.255.255 port 67 interval 5
DHCPDISCOVER on wlan0 to 255.255.255.255 port 67 interval 6
DHCPOFFER from 192.168.0.1
DHCPREQUEST on wlan0 to 255.255.255.255 port 67
DHCPACK from 192.168.0.1
bound to 192.168.0.254 -- renewal in 300 seconds.
wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
      ether 00:11:95:d5:43:62
      inet 192.168.0.254 netmask 0xffffff00 broadcast 192.168.0.255
      media: IEEE 802.11 Wireless Ethernet OFDM/36Mbps mode 11g
      status: associated
      ssid freebsdap channel 1 (2412 Mhz 11g) bssid 00:11:95:c3:0d:ac
      country US ecm authmode WPA2/802.11i privacy ON deftxkey UNDEF
      AES-CCM 3:128-bit txpower 21.5 bmiss 7 scanvalid 450 bgscan
      bgscanintvl 300 bgscanidle 250 roam:rssi 7 roam:rate 5 protmode CTS
      wme burst roaming MANUAL</screen>

	    <para xml:lang="en">Or, try to configure the interface manually using
	      the information in
	      <filename>/etc/wpa_supplicant.conf</filename>:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>wpa_supplicant -i <replaceable>wlan0</replaceable> -c /etc/wpa_supplicant.conf</userinput>
Trying to associate with 00:11:95:c3:0d:ac (SSID='freebsdap' freq=2412 MHz)
Associated with 00:11:95:c3:0d:ac
WPA: Key negotiation completed with 00:11:95:c3:0d:ac [PTK=CCMP GTK=CCMP]
CTRL-EVENT-CONNECTED - Connection to 00:11:95:c3:0d:ac completed (auth) [id=0 id_str=]</screen>

	    <para xml:lang="en">The next operation is to launch <citerefentry><refentrytitle>dhclient</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	      to get the <acronym>IP</acronym> address from the
	      <acronym>DHCP</acronym> server:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>dhclient <replaceable>wlan0</replaceable></userinput>
DHCPREQUEST on wlan0 to 255.255.255.255 port 67
DHCPACK from 192.168.0.1
bound to 192.168.0.254 -- renewal in 300 seconds.
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable></userinput>
wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
      ether 00:11:95:d5:43:62
      inet 192.168.0.254 netmask 0xffffff00 broadcast 192.168.0.255
      media: IEEE 802.11 Wireless Ethernet OFDM/36Mbps mode 11g
      status: associated
      ssid freebsdap channel 1 (2412 Mhz 11g) bssid 00:11:95:c3:0d:ac
      country US ecm authmode WPA2/802.11i privacy ON deftxkey UNDEF
      AES-CCM 3:128-bit txpower 21.5 bmiss 7 scanvalid 450 bgscan
      bgscanintvl 300 bgscanidle 250 roam:rssi 7 roam:rate 5 protmode CTS
      wme burst roaming MANUAL</screen>

	    <note>
	      <para xml:lang="en">If <filename>/etc/rc.conf</filename> has an
		<literal>ifconfig_wlan0="DHCP"</literal> entry,
		<citerefentry><refentrytitle>dhclient</refentrytitle><manvolnum>8</manvolnum></citerefentry> will be launched automatically after
		<citerefentry><refentrytitle>wpa_supplicant</refentrytitle><manvolnum>8</manvolnum></citerefentry> associates with the access
		point.</para>
	    </note>

	    <para xml:lang="en">If <acronym>DHCP</acronym> is not possible or
	      desired, set a static <acronym>IP</acronym> address
	      after <citerefentry><refentrytitle>wpa_supplicant</refentrytitle><manvolnum>8</manvolnum></citerefentry> has authenticated the
	      station:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> inet <replaceable>192.168.0.100</replaceable> netmask <replaceable>255.255.255.0</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable></userinput>
wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
      ether 00:11:95:d5:43:62
      inet 192.168.0.100 netmask 0xffffff00 broadcast 192.168.0.255
      media: IEEE 802.11 Wireless Ethernet OFDM/36Mbps mode 11g
      status: associated
      ssid freebsdap channel 1 (2412 Mhz 11g) bssid 00:11:95:c3:0d:ac
      country US ecm authmode WPA2/802.11i privacy ON deftxkey UNDEF
      AES-CCM 3:128-bit txpower 21.5 bmiss 7 scanvalid 450 bgscan
      bgscanintvl 300 bgscanidle 250 roam:rssi 7 roam:rate 5 protmode CTS
      wme burst roaming MANUAL</screen>

	    <para xml:lang="en">When <acronym>DHCP</acronym> is not used, the
	      default gateway and the nameserver also have to be
	      manually set:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>route add default <replaceable>your_default_router</replaceable></userinput>
<prompt>#</prompt> <userinput>echo "nameserver <replaceable>your_DNS_server</replaceable>" &gt;&gt; /etc/resolv.conf</userinput></screen>
	  </sect5>

	  <sect5 xml:id="network-wireless-wpa-eap-tls">
	    <title><acronym>WPA</acronym> 加上 <acronym>EAP-TLS</acronym></title>

	    <para xml:lang="en">The second way to use <acronym>WPA</acronym> is with
	      an 802.1X backend authentication server.  In this case,
	      <acronym>WPA</acronym> is called
	      <acronym>WPA</acronym> Enterprise to differentiate it
	      from the less secure <acronym>WPA</acronym> Personal.
	      Authentication in <acronym>WPA</acronym> Enterprise is
	      based on the Extensible Authentication Protocol
	      (<acronym>EAP</acronym>).</para>

	    <para xml:lang="en"><acronym>EAP</acronym> does not come with an
	      encryption method.  Instead, <acronym>EAP</acronym> is
	      embedded inside an encrypted tunnel.  There are many
	      <acronym>EAP</acronym> authentication methods, but
	      <acronym>EAP-TLS</acronym>, <acronym>EAP-TTLS</acronym>,
	      and <acronym>EAP-PEAP</acronym> are the most
	      common.</para>

	    <para xml:lang="en">EAP with Transport Layer Security
	      (<acronym>EAP-TLS</acronym>) is a well-supported
	      wireless authentication protocol since it was the
	      first <acronym>EAP</acronym> method to be certified
	      by the <link xlink:href="http://www.wi-fi.org/">Wi-Fi
		Alliance</link>.  <acronym>EAP-TLS</acronym> requires
	      three certificates to run: the certificate of the
	      Certificate Authority (<acronym>CA</acronym>) installed
	      on all machines, the server certificate for the
	      authentication server, and one client certificate for
	      each wireless client.  In this <acronym>EAP</acronym>
	      method, both the authentication server and wireless
	      client authenticate each other by presenting their
	      respective certificates, and then verify that these
	      certificates were signed by the organization's
	      <acronym>CA</acronym>.</para>

	    <para xml:lang="en">As previously, the configuration is done via
	      <filename>/etc/wpa_supplicant.conf</filename>:</para>

	    <programlisting xml:lang="en">network={
  ssid="freebsdap" <co xml:id="co-tls-ssid"/>
  proto=RSN  <co xml:id="co-tls-proto"/>
  key_mgmt=WPA-EAP <co xml:id="co-tls-kmgmt"/>
  eap=TLS <co xml:id="co-tls-eap"/>
  identity="loader" <co xml:id="co-tls-id"/>
  ca_cert="/etc/certs/cacert.pem" <co xml:id="co-tls-cacert"/>
  client_cert="/etc/certs/clientcert.pem" <co xml:id="co-tls-clientcert"/>
  private_key="/etc/certs/clientkey.pem" <co xml:id="co-tls-pkey"/>
  private_key_passwd="freebsdmallclient" <co xml:id="co-tls-pwd"/>
}</programlisting>

	    <calloutlist>
	      <callout arearefs="co-tls-ssid">
		<para xml:lang="en">This field indicates the network name
		  (<acronym>SSID</acronym>).</para>
	      </callout>

	      <callout arearefs="co-tls-proto">
		<para xml:lang="en">This example uses the <acronym>RSN</acronym>
		  <trademark class="registered">IEEE</trademark> 802.11i protocol, also known as
		  <acronym>WPA2</acronym>.</para>
	      </callout>

	      <callout arearefs="co-tls-kmgmt">
		<para xml:lang="en">The <literal>key_mgmt</literal> line refers to
		  the key management protocol to use.  In this
		  example, it is <acronym>WPA</acronym> using
		  <acronym>EAP</acronym> authentication.</para>
	      </callout>

	      <callout arearefs="co-tls-eap">
		<para xml:lang="en">This field indicates the <acronym>EAP</acronym>
		  method for the connection.</para>
	      </callout>

	      <callout arearefs="co-tls-id">
		<para xml:lang="en">The <literal>identity</literal> field contains
		  the identity string for
		  <acronym>EAP</acronym>.</para>
	      </callout>

	      <callout arearefs="co-tls-cacert">
		<para xml:lang="en">The <literal>ca_cert</literal> field indicates
		  the pathname of the <acronym>CA</acronym>
		  certificate file.  This file is needed to verify
		  the server certificate.</para>
	      </callout>

	      <callout arearefs="co-tls-clientcert">
		<para xml:lang="en">The <literal>client_cert</literal> line gives
		  the pathname to the client certificate file.  This
		  certificate is unique to each wireless client of the
		  network.</para>
	      </callout>

	      <callout arearefs="co-tls-pkey">
		<para xml:lang="en">The <literal>private_key</literal> field is the
		  pathname to the client certificate private key
		  file.</para>
	      </callout>

	      <callout arearefs="co-tls-pwd">
		<para xml:lang="en">The <literal>private_key_passwd</literal> field
		  contains the passphrase for the private key.</para>
	      </callout>
	    </calloutlist>

	    <para xml:lang="en">Then, add the following lines to
	      <filename>/etc/rc.conf</filename>:</para>

	    <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="WPA DHCP"</programlisting>

	    <para xml:lang="en">The next step is to bring up the interface:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>service netif start</userinput>
Starting wpa_supplicant.
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 7
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 15
DHCPACK from 192.168.0.20
bound to 192.168.0.254 -- renewal in 300 seconds.
wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
      ether 00:11:95:d5:43:62
      inet 192.168.0.254 netmask 0xffffff00 broadcast 192.168.0.255
      media: IEEE 802.11 Wireless Ethernet DS/11Mbps mode 11g
      status: associated
      ssid freebsdap channel 1 (2412 Mhz 11g) bssid 00:11:95:c3:0d:ac
      country US ecm authmode WPA2/802.11i privacy ON deftxkey UNDEF
      AES-CCM 3:128-bit txpower 21.5 bmiss 7 scanvalid 450 bgscan
      bgscanintvl 300 bgscanidle 250 roam:rssi 7 roam:rate 5 protmode CTS
      wme burst roaming MANUAL</screen>

	    <para xml:lang="en">It is also possible to bring up the interface
	      manually using <citerefentry><refentrytitle>wpa_supplicant</refentrytitle><manvolnum>8</manvolnum></citerefentry> and
	      <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	  </sect5>

	  <sect5 xml:id="network-wireless-wpa-eap-ttls">
	    <title><acronym>WPA</acronym> 加上 <acronym>EAP-TTLS</acronym></title>

	    <para xml:lang="en">With <acronym>EAP-TLS</acronym>, both the
	      authentication server and the client need a certificate.
	      With <acronym>EAP-TTLS</acronym>, a client certificate
	      is optional.  This method is similar to a web server
	      which creates a secure <acronym>SSL</acronym> tunnel
	      even if visitors do not have client-side certificates.
	      <acronym>EAP-TTLS</acronym> uses an encrypted
	      <acronym>TLS</acronym> tunnel for safe transport of
	      the authentication data.</para>

	    <para xml:lang="en">The required configuration can be added to
	      <filename>/etc/wpa_supplicant.conf</filename>:</para>

	    <programlisting xml:lang="en">network={
  ssid="freebsdap"
  proto=RSN
  key_mgmt=WPA-EAP
  eap=TTLS <co xml:id="co-ttls-eap"/>
  identity="test" <co xml:id="co-ttls-id"/>
  password="test" <co xml:id="co-ttls-passwd"/>
  ca_cert="/etc/certs/cacert.pem" <co xml:id="co-ttls-cacert"/>
  phase2="auth=MD5" <co xml:id="co-ttls-pha2"/>
}</programlisting>

	    <calloutlist>
	      <callout arearefs="co-ttls-eap">
		<para xml:lang="en">This field specifies the <acronym>EAP</acronym>
		  method for the connection.</para>
	      </callout>

	      <callout arearefs="co-ttls-id">
		<para xml:lang="en">The <literal>identity</literal> field contains
		  the identity string for <acronym>EAP</acronym>
		  authentication inside the encrypted
		  <acronym>TLS</acronym> tunnel.</para>
	      </callout>

	      <callout arearefs="co-ttls-passwd">
		<para xml:lang="en">The <literal>password</literal> field contains
		  the passphrase for the <acronym>EAP</acronym>
		  authentication.</para>
	      </callout>

	      <callout arearefs="co-ttls-cacert">
		<para xml:lang="en">The <literal>ca_cert</literal> field indicates
		  the pathname of the <acronym>CA</acronym>
		  certificate file.  This file is needed to verify
		  the server certificate.</para>
	      </callout>

	      <callout arearefs="co-ttls-pha2">
		<para xml:lang="en">This field specifies the authentication
		  method used in the encrypted <acronym>TLS</acronym>
		  tunnel.  In this example,
		  <acronym>EAP</acronym> with MD5-Challenge is used.
		  The <quote>inner authentication</quote> phase is
		  often called <quote>phase2</quote>.</para>
	      </callout>
	    </calloutlist>

	    <para xml:lang="en">Next, add the following lines to
	      <filename>/etc/rc.conf</filename>:</para>

	    <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="WPA DHCP"</programlisting>

	    <para xml:lang="en">The next step is to bring up the interface:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>service netif start</userinput>
Starting wpa_supplicant.
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 7
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 15
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 21
DHCPACK from 192.168.0.20
bound to 192.168.0.254 -- renewal in 300 seconds.
wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
      ether 00:11:95:d5:43:62
      inet 192.168.0.254 netmask 0xffffff00 broadcast 192.168.0.255
      media: IEEE 802.11 Wireless Ethernet DS/11Mbps mode 11g
      status: associated
      ssid freebsdap channel 1 (2412 Mhz 11g) bssid 00:11:95:c3:0d:ac
      country US ecm authmode WPA2/802.11i privacy ON deftxkey UNDEF
      AES-CCM 3:128-bit txpower 21.5 bmiss 7 scanvalid 450 bgscan
      bgscanintvl 300 bgscanidle 250 roam:rssi 7 roam:rate 5 protmode CTS
      wme burst roaming MANUAL</screen>
	  </sect5>

	  <sect5 xml:id="network-wireless-wpa-eap-peap">
	    <title><acronym>WPA</acronym> 加上 <acronym>EAP-PEAP</acronym></title>

	    <note>
	      <para xml:lang="en"><acronym>PEAPv0/EAP-MSCHAPv2</acronym> is the most
		common <acronym>PEAP</acronym> method.  In this
		chapter, the term <acronym>PEAP</acronym> is used to
		refer to that method.</para>
	    </note>

	    <para xml:lang="en">Protected EAP (<acronym>PEAP</acronym>) is designed
	      as an alternative to <acronym>EAP-TTLS</acronym> and
	      is the most used <acronym>EAP</acronym> standard after
	      <acronym>EAP-TLS</acronym>.  In a network with mixed
	      operating systems, <acronym>PEAP</acronym> should be
	      the most supported standard after
	      <acronym>EAP-TLS</acronym>.</para>

	    <para xml:lang="en"><acronym>PEAP</acronym> is similar to
	      <acronym>EAP-TTLS</acronym> as it uses a server-side
	      certificate to authenticate clients by creating an
	      encrypted <acronym>TLS</acronym> tunnel between the
	      client and the authentication server, which protects
	      the ensuing exchange of authentication information.
	      <acronym>PEAP</acronym> authentication differs from
	      <acronym>EAP-TTLS</acronym> as it broadcasts the
	      username in the clear and only the password is sent
	      in the encrypted <acronym>TLS</acronym> tunnel.
	      <acronym>EAP-TTLS</acronym> will use the
	      <acronym>TLS</acronym> tunnel for both the username
	      and password.</para>

	    <para xml:lang="en">Add the following lines to
	      <filename>/etc/wpa_supplicant.conf</filename> to
	      configure the <acronym>EAP-PEAP</acronym> related
	      settings:</para>

	    <programlisting xml:lang="en">network={
  ssid="freebsdap"
  proto=RSN
  key_mgmt=WPA-EAP
  eap=PEAP <co xml:id="co-peap-eap"/>
  identity="test" <co xml:id="co-peap-id"/>
  password="test" <co xml:id="co-peap-passwd"/>
  ca_cert="/etc/certs/cacert.pem" <co xml:id="co-peap-cacert"/>
  phase1="peaplabel=0" <co xml:id="co-peap-pha1"/>
  phase2="auth=MSCHAPV2" <co xml:id="co-peap-pha2"/>
}</programlisting>

	    <calloutlist>
	      <callout arearefs="co-peap-eap">
		<para xml:lang="en">This field specifies the <acronym>EAP</acronym>
		  method for the connection.</para>
	      </callout>

	      <callout arearefs="co-peap-id">
		<para xml:lang="en">The <literal>identity</literal> field contains
		  the identity string for <acronym>EAP</acronym>
		  authentication inside the encrypted
		  <acronym>TLS</acronym> tunnel.</para>
	      </callout>

	      <callout arearefs="co-peap-passwd">
		<para xml:lang="en">The <literal>password</literal> field contains
		  the passphrase for the <acronym>EAP</acronym>
		  authentication.</para>
	      </callout>

	      <callout arearefs="co-peap-cacert">
		<para xml:lang="en">The <literal>ca_cert</literal> field indicates
		  the pathname of the <acronym>CA</acronym>
		  certificate file.  This file is needed to verify
		  the server certificate.</para>
	      </callout>

	      <callout arearefs="co-peap-pha1">
		<para xml:lang="en">This field contains the parameters for the
		  first phase of authentication, the
		  <acronym>TLS</acronym> tunnel.  According to the
		  authentication server used, specify a specific
		  label for authentication.  Most of the time, the
		  label will be <quote>client <acronym>EAP</acronym>
		    encryption</quote> which is set by using
		  <literal>peaplabel=0</literal>.  More information
		  can be found in  <citerefentry><refentrytitle>wpa_supplicant.conf</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>
	      </callout>

	      <callout arearefs="co-peap-pha2">
		<para xml:lang="en">This field specifies the authentication
		  protocol used in the encrypted
		  <acronym>TLS</acronym> tunnel.  In the
		  case of <acronym>PEAP</acronym>, it is
		  <literal>auth=MSCHAPV2</literal>.</para>
	      </callout>
	    </calloutlist>

	    <para>將以下參數加到 <filename>/etc/rc.conf</filename>：</para>

	    <programlisting xml:lang="en">wlans_ath0="wlan0"
ifconfig_wlan0="WPA DHCP"</programlisting>

	    <para xml:lang="en">Then, bring up the interface:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>service netif start</userinput>
Starting wpa_supplicant.
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 7
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 15
DHCPREQUEST on wlan0 to 255.255.255.255 port 67 interval 21
DHCPACK from 192.168.0.20
bound to 192.168.0.254 -- renewal in 300 seconds.
wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
      ether 00:11:95:d5:43:62
      inet 192.168.0.254 netmask 0xffffff00 broadcast 192.168.0.255
      media: IEEE 802.11 Wireless Ethernet DS/11Mbps mode 11g
      status: associated
      ssid freebsdap channel 1 (2412 Mhz 11g) bssid 00:11:95:c3:0d:ac
      country US ecm authmode WPA2/802.11i privacy ON deftxkey UNDEF
      AES-CCM 3:128-bit txpower 21.5 bmiss 7 scanvalid 450 bgscan
      bgscanintvl 300 bgscanidle 250 roam:rssi 7 roam:rate 5 protmode CTS
      wme burst roaming MANUAL</screen>
	  </sect5>
	</sect4>

	<sect4 xml:id="network-wireless-wep">
	  <title xml:lang="en"><acronym>WEP</acronym></title>

	  <para xml:lang="en">Wired Equivalent Privacy (<acronym>WEP</acronym>) is
	    part of the original 802.11 standard.  There is no
	    authentication mechanism, only a weak form of access
	    control which is easily cracked.</para>

	  <para xml:lang="en"><acronym>WEP</acronym> can be set up using
	    <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> create wlandev <replaceable>ath0</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> inet <replaceable>192.168.1.100</replaceable> netmask <replaceable>255.255.255.0</replaceable> \
	    ssid <replaceable>my_net</replaceable> wepmode on weptxkey <replaceable>3</replaceable> wepkey <replaceable>3:0x3456789012</replaceable></userinput></screen>

	  <itemizedlist>
	    <listitem>

	      <para xml:lang="en">The <literal>weptxkey</literal> specifies which
		<acronym>WEP</acronym> key will be used in the
		transmission.  This example uses the third key.
		This must match the setting on the access point.
		When unsure which key is used by the access point,
		try <literal>1</literal> (the first key) for this
		value.</para>
	    </listitem>

	    <listitem>
	      <para xml:lang="en">The <literal>wepkey</literal> selects one of the
		<acronym>WEP</acronym> keys.  It should be in the
		format <replaceable>index:key</replaceable>.  Key
		<literal>1</literal> is used by default; the index
		only needs to be set when using a key other than the
		first key.</para>

	      <note>
		<para xml:lang="en">Replace the <literal>0x3456789012</literal>
		  with the key configured for use on the access
		  point.</para>
	      </note>
	    </listitem>
	  </itemizedlist>

	  <para xml:lang="en">Refer to <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> for further
	    information.</para>

	  <para xml:lang="en">The <citerefentry><refentrytitle>wpa_supplicant</refentrytitle><manvolnum>8</manvolnum></citerefentry> facility can be used to
	    configure a wireless interface with
	    <acronym>WEP</acronym>.  The example above can be set up
	    by adding the following lines to
	    <filename>/etc/wpa_supplicant.conf</filename>:</para>

	  <programlisting xml:lang="en">network={
  ssid="my_net"
  key_mgmt=NONE
  wep_key3=3456789012
  wep_tx_keyidx=3
}</programlisting>

	  <para xml:lang="en">Then:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>wpa_supplicant -i <replaceable>wlan0</replaceable> -c /etc/wpa_supplicant.conf</userinput>
Trying to associate with 00:13:46:49:41:76 (SSID='dlinkap' freq=2437 MHz)
Associated with 00:13:46:49:41:76</screen>
	</sect4>
      </sect3>
    </sect2>

    <sect2>
      <title>對等式 (Ad-hoc)</title>

      <para xml:lang="en"><acronym>IBSS</acronym> mode, also called ad-hoc mode, is
	designed for point to point connections.  For example, to
	establish an ad-hoc network between the machines
	<systemitem>A</systemitem> and <systemitem>B</systemitem>,
	choose two <acronym>IP</acronym> addresses and a
	<acronym>SSID</acronym>.</para>

      <para xml:lang="en">On <systemitem>A</systemitem>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> create wlandev <replaceable>ath0</replaceable> wlanmode adhoc</userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> inet <replaceable>192.168.0.1</replaceable> netmask <replaceable>255.255.255.0</replaceable> ssid <replaceable>freebsdap</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable></userinput>
  wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	  ether 00:11:95:c3:0d:ac
	  inet 192.168.0.1 netmask 0xffffff00 broadcast 192.168.0.255
	  media: IEEE 802.11 Wireless Ethernet autoselect mode 11g &lt;adhoc&gt;
	  status: running
	  ssid freebsdap channel 2 (2417 Mhz 11g) bssid 02:11:95:c3:0d:ac
	  country US ecm authmode OPEN privacy OFF txpower 21.5 scanvalid 60
	  protmode CTS wme burst</screen>

      <para xml:lang="en">The <literal>adhoc</literal> parameter indicates that the
	interface is running in <acronym>IBSS</acronym> mode.</para>

      <para xml:lang="en"><systemitem>B</systemitem> should now be able to detect
	<systemitem>A</systemitem>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> create wlandev <replaceable>ath0</replaceable> wlanmode adhoc</userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> up scan</userinput>
  SSID/MESH ID    BSSID              CHAN RATE   S:N     INT CAPS
  freebsdap       02:11:95:c3:0d:ac    2   54M -64:-96  100 IS   WME</screen>

      <para xml:lang="en">The <literal>I</literal> in the output confirms that
	<systemitem>A</systemitem> is in ad-hoc mode.  Now, configure
	<systemitem>B</systemitem> with a different
	<acronym>IP</acronym> address:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> inet <replaceable>192.168.0.2</replaceable> netmask <replaceable>255.255.255.0</replaceable> ssid <replaceable>freebsdap</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable></userinput>
  wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	  ether 00:11:95:d5:43:62
	  inet 192.168.0.2 netmask 0xffffff00 broadcast 192.168.0.255
	  media: IEEE 802.11 Wireless Ethernet autoselect mode 11g &lt;adhoc&gt;
	  status: running
	  ssid freebsdap channel 2 (2417 Mhz 11g) bssid 02:11:95:c3:0d:ac
	  country US ecm authmode OPEN privacy OFF txpower 21.5 scanvalid 60
	  protmode CTS wme burst</screen>

      <para xml:lang="en">Both <systemitem>A</systemitem> and
	<systemitem>B</systemitem> are now ready to exchange
	information.</para>
    </sect2>

    <sect2 xml:id="network-wireless-ap">
      <title>FreeBSD 主機存取點</title>

      <para xml:lang="en">FreeBSD can act as an Access Point (<acronym>AP</acronym>)
	which eliminates the need to buy a hardware
	<acronym>AP</acronym> or run an ad-hoc network.  This can
	be particularly useful when a FreeBSD machine is acting as a
	gateway to another network such as the Internet.</para>

      <sect3 xml:id="network-wireless-ap-basic">
	<title>基礎設定</title>

	<para xml:lang="en">Before configuring a FreeBSD machine as an
	  <acronym>AP</acronym>, the kernel must be configured with
	  the appropriate networking support for the wireless card
	  as well as the security protocols being used.  For more
	  details, see <xref linkend="network-wireless-basic"/>.</para>

	<note>
	  <para xml:lang="en">The <acronym>NDIS</acronym> driver wrapper for
	    <trademark class="registered">Windows</trademark> drivers does not currently support
	    <acronym>AP</acronym> operation.  Only native FreeBSD
	    wireless drivers support <acronym>AP</acronym>
	    mode.</para>
	</note>

	<para xml:lang="en">Once wireless networking support is loaded, check if
	  the wireless device supports the host-based access point
	  mode, also known as hostap mode:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> create wlandev <replaceable>ath0</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> list caps</userinput>
drivercaps=6f85edc1&lt;STA,FF,TURBOP,IBSS,HOSTAP,AHDEMO,TXPMGT,SHSLOT,SHPREAMBLE,MONITOR,MBSS,WPA1,WPA2,BURST,WME,WDS,BGSCAN,TXFRAG&gt;
cryptocaps=1f&lt;WEP,TKIP,AES,AES_CCM,TKIPMIC&gt;</screen>

	<para xml:lang="en">This output displays the card's capabilities.  The
	  <literal>HOSTAP</literal> word confirms that this wireless
	  card can act as an <acronym>AP</acronym>.  Various supported
	  ciphers are also listed: <acronym>WEP</acronym>,
	  <acronym>TKIP</acronym>, and <acronym>AES</acronym>.  This
	  information indicates which security protocols can be used
	  on the <acronym>AP</acronym>.</para>

	<para xml:lang="en">The wireless device can only be put into hostap mode
	  during the creation of the network pseudo-device, so a
	  previously created device must be destroyed first:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> destroy</userinput></screen>

	<para xml:lang="en">then regenerated with the correct option before setting
	  the other parameters:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> create wlandev <replaceable>ath0</replaceable> wlanmode hostap</userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> inet <replaceable>192.168.0.1</replaceable> netmask <replaceable>255.255.255.0</replaceable> ssid <replaceable>freebsdap</replaceable> mode 11g channel 1</userinput></screen>

	<para xml:lang="en">Use <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> again to see the status of the
	  <filename>wlan0</filename> interface:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable></userinput>
  wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	  ether 00:11:95:c3:0d:ac
	  inet 192.168.0.1 netmask 0xffffff00 broadcast 192.168.0.255
	  media: IEEE 802.11 Wireless Ethernet autoselect mode 11g &lt;hostap&gt;
	  status: running
	  ssid freebsdap channel 1 (2412 Mhz 11g) bssid 00:11:95:c3:0d:ac
	  country US ecm authmode OPEN privacy OFF txpower 21.5 scanvalid 60
	  protmode CTS wme burst dtimperiod 1 -dfs</screen>

	<para xml:lang="en">The <literal>hostap</literal> parameter indicates the
	  interface is running in the host-based access point
	  mode.</para>

	<para xml:lang="en">The interface configuration can be done automatically at
	  boot time by adding the following lines to
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">wlans_ath0="wlan0"
create_args_wlan0="wlanmode hostap"
ifconfig_wlan0="inet <replaceable>192.168.0.1</replaceable> netmask <replaceable>255.255.255.0</replaceable> ssid <replaceable>freebsdap</replaceable> mode 11g channel <replaceable>1</replaceable>"</programlisting>
      </sect3>

      <sect3>
	<title>無認證或加密的 Host-based 存取點</title>

	<para xml:lang="en">Although it is not recommended to run an
	  <acronym>AP</acronym> without any authentication or
	  encryption, this is a simple way to check if the
	  <acronym>AP</acronym> is working.  This configuration is
	  also important for debugging client issues.</para>

	<para xml:lang="en">Once the <acronym>AP</acronym> is configured, initiate
	  a scan from another wireless machine to find the
	  <acronym>AP</acronym>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> create wlandev <replaceable>ath0</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> up scan</userinput>
SSID/MESH ID    BSSID              CHAN RATE   S:N     INT CAPS
freebsdap       00:11:95:c3:0d:ac    1   54M -66:-96  100 ES   WME</screen>

	<para xml:lang="en">The client machine found the <acronym>AP</acronym> and
	  can be associated with it:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> inet <replaceable>192.168.0.2</replaceable> netmask <replaceable>255.255.255.0</replaceable> ssid <replaceable>freebsdap</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable></userinput>
  wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	  ether 00:11:95:d5:43:62
	  inet 192.168.0.2 netmask 0xffffff00 broadcast 192.168.0.255
	  media: IEEE 802.11 Wireless Ethernet OFDM/54Mbps mode 11g
	  status: associated
	  ssid freebsdap channel 1 (2412 Mhz 11g) bssid 00:11:95:c3:0d:ac
	  country US ecm authmode OPEN privacy OFF txpower 21.5 bmiss 7
	  scanvalid 60 bgscan bgscanintvl 300 bgscanidle 250 roam:rssi 7
	  roam:rate 5 protmode CTS wme burst</screen>
      </sect3>

      <sect3 xml:id="network-wireless-ap-wpa">
	<title><acronym>WPA2</acronym> Host-based 存取點</title>

	<para xml:lang="en">This section focuses on setting up a FreeBSD
	  access point using the <acronym>WPA2</acronym>
	  security protocol.  More details regarding
	  <acronym>WPA</acronym> and the configuration of
	  <acronym>WPA</acronym>-based wireless clients can be found
	  in <xref linkend="network-wireless-wpa"/>.</para>

	<para xml:lang="en">The <citerefentry><refentrytitle>hostapd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon is used to deal with client
	  authentication and key management on the
	  <acronym>WPA2</acronym>-enabled
	  <acronym>AP</acronym>.</para>

	<para xml:lang="en">The following configuration operations are performed
	  on the FreeBSD machine acting as the <acronym>AP</acronym>.
	  Once the <acronym>AP</acronym> is correctly working,
	  <citerefentry><refentrytitle>hostapd</refentrytitle><manvolnum>8</manvolnum></citerefentry> can be automatically started at boot
	  with this line in
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">hostapd_enable="YES"</programlisting>

	<para xml:lang="en">Before trying to configure <citerefentry><refentrytitle>hostapd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, first
	  configure the basic settings introduced in <xref linkend="network-wireless-ap-basic"/>.</para>

	<sect4>
	  <title xml:lang="en"><acronym>WPA2-PSK</acronym></title>

	  <para xml:lang="en"><acronym>WPA2-PSK</acronym> is intended for small
	    networks where the use of a backend authentication server
	    is not possible or desired.</para>

	  <para xml:lang="en">The configuration is done in
	    <filename>/etc/hostapd.conf</filename>:</para>

	  <programlisting xml:lang="en">interface=wlan0                  <co xml:id="co-ap-wpapsk-iface"/>
debug=1                          <co xml:id="co-ap-wpapsk-dbug"/>
ctrl_interface=/var/run/hostapd  <co xml:id="co-ap-wpapsk-ciface"/>
ctrl_interface_group=wheel       <co xml:id="co-ap-wpapsk-cifacegrp"/>
ssid=freebsdap                   <co xml:id="co-ap-wpapsk-ssid"/>
wpa=2                            <co xml:id="co-ap-wpapsk-wpa"/>
wpa_passphrase=freebsdmall       <co xml:id="co-ap-wpapsk-pass"/>
wpa_key_mgmt=WPA-PSK             <co xml:id="co-ap-wpapsk-kmgmt"/>
wpa_pairwise=CCMP                <co xml:id="co-ap-wpapsk-pwise"/></programlisting>

	  <calloutlist>
	    <callout arearefs="co-ap-wpapsk-iface">
	      <para xml:lang="en">Wireless interface used
		for the access point.</para>
	    </callout>

	    <callout arearefs="co-ap-wpapsk-dbug">
	      <para xml:lang="en">Level of verbosity used during the
		execution of <citerefentry><refentrytitle>hostapd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  A value of
		<literal>1</literal> represents the minimal
		level.</para>
	    </callout>

	    <callout arearefs="co-ap-wpapsk-ciface">
	      <para xml:lang="en">Pathname of the directory used by <citerefentry><refentrytitle>hostapd</refentrytitle><manvolnum>8</manvolnum></citerefentry>
		to store domain socket files for communication
		with external programs such as <citerefentry><refentrytitle>hostapd_cli</refentrytitle><manvolnum>8</manvolnum></citerefentry>.
		The default value is used in this example.</para>
	    </callout>

	    <callout arearefs="co-ap-wpapsk-cifacegrp">
	      <para xml:lang="en">The group allowed to access the control
		interface files.</para>
	    </callout>

	    <callout arearefs="co-ap-wpapsk-ssid">
	      <para xml:lang="en">The wireless network name, or
		<acronym>SSID</acronym>, that will appear in wireless
		scans.</para>
	    </callout>

	    <callout arearefs="co-ap-wpapsk-wpa">
	      <para xml:lang="en">Enable
		<acronym>WPA</acronym> and specify which
		<acronym>WPA</acronym> authentication protocol will
		be required.  A value of <literal>2</literal>
		configures the <acronym>AP</acronym> for
		<acronym>WPA2</acronym> and is recommended.
		Set to <literal>1</literal> only if the obsolete
		<acronym>WPA</acronym> is required.</para>
	    </callout>

	    <callout arearefs="co-ap-wpapsk-pass">
	      <para xml:lang="en">ASCII passphrase for
		<acronym>WPA</acronym> authentication.</para>

	      <warning>
		<para xml:lang="en">Always use strong passwords that are at least
		  8 characters long and made from a rich alphabet so
		  that they will not be easily guessed or
		  attacked.</para>
	      </warning>
	    </callout>

	    <callout arearefs="co-ap-wpapsk-kmgmt">
	      <para xml:lang="en">The
		key management protocol to use.  This example
		sets <acronym>WPA-PSK</acronym>.</para>
	    </callout>

	    <callout arearefs="co-ap-wpapsk-pwise">
	      <para xml:lang="en">Encryption algorithms accepted by
		the access point.  In this example, only
		the
		<acronym>CCMP</acronym> (<acronym>AES</acronym>)
		cipher is accepted.  <acronym>CCMP</acronym>
		is an alternative to <acronym>TKIP</acronym>
		and is strongly preferred when possible.
		<acronym>TKIP</acronym> should be allowed only when
		there are stations incapable of using
		<acronym>CCMP</acronym>.</para>
	    </callout>
	  </calloutlist>

	  <para xml:lang="en">The next step is to start <citerefentry><refentrytitle>hostapd</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>service hostapd forcestart</userinput></screen>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable></userinput>
wlan0: flags=8943&lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	ether 04:f0:21:16:8e:10
	inet6 fe80::6f0:21ff:fe16:8e10%wlan0 prefixlen 64 scopeid 0x9
	nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;
	media: IEEE 802.11 Wireless Ethernet autoselect mode 11na &lt;hostap&gt;
	status: running
	ssid No5ignal channel 36 (5180 MHz 11a ht/40+) bssid 04:f0:21:16:8e:10
	country US ecm authmode WPA2/802.11i privacy MIXED deftxkey 2
	AES-CCM 2:128-bit AES-CCM 3:128-bit txpower 17 mcastrate 6 mgmtrate 6
	scanvalid 60 ampdulimit 64k ampdudensity 8 shortgi wme burst
	dtimperiod 1 -dfs
	groups: wlan</screen>

	  <para xml:lang="en">Once the <acronym>AP</acronym> is running, the
	    clients can associate with it.  See <xref linkend="network-wireless-wpa"/> for more details.  It
	    is possible to see the stations associated with the
	    <acronym>AP</acronym> using <command>ifconfig
	      <replaceable>wlan0</replaceable> list
	      sta</command>.</para>
	</sect4>
      </sect3>

      <sect3>
	<title><acronym>WEP</acronym> Host-based 存取點</title>

	<para xml:lang="en">It is not recommended to use <acronym>WEP</acronym> for
	  setting up an <acronym>AP</acronym> since there is no
	  authentication mechanism and the encryption is easily
	  cracked.  Some legacy wireless cards only support
	  <acronym>WEP</acronym> and these cards will only support
	  an <acronym>AP</acronym> without authentication or
	  encryption.</para>

	<para xml:lang="en">The wireless device can now be put into hostap mode and
	  configured with the correct <acronym>SSID</acronym> and
	  <acronym>IP</acronym> address:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> create wlandev <replaceable>ath0</replaceable> wlanmode hostap</userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> inet <replaceable>192.168.0.1</replaceable> netmask <replaceable>255.255.255.0</replaceable> \
	ssid <replaceable>freebsdap</replaceable> wepmode on weptxkey <replaceable>3</replaceable> wepkey <replaceable>3:0x3456789012</replaceable> mode 11g</userinput></screen>

	<itemizedlist>
	  <listitem>
	    <para xml:lang="en">The <literal>weptxkey</literal> indicates which
	      <acronym>WEP</acronym> key will be used in the
	      transmission.  This example uses the third key as key
	      numbering starts with <literal>1</literal>.  This
	      parameter must be specified in order to encrypt the
	      data.</para>
	  </listitem>

	  <listitem>
	    <para xml:lang="en">The <literal>wepkey</literal> sets the selected
	      <acronym>WEP</acronym> key.  It should be in the format
	      <replaceable>index:key</replaceable>.  If the index is
	      not given, key <literal>1</literal> is set.  The index
	      needs to be set when using keys other than the first
	      key.</para>
	  </listitem>
	</itemizedlist>

	<para xml:lang="en">Use <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> to see the status of the
	  <filename>wlan0</filename> interface:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable></userinput>
  wlan0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	  ether 00:11:95:c3:0d:ac
	  inet 192.168.0.1 netmask 0xffffff00 broadcast 192.168.0.255
	  media: IEEE 802.11 Wireless Ethernet autoselect mode 11g &lt;hostap&gt;
	  status: running
	  ssid freebsdap channel 4 (2427 Mhz 11g) bssid 00:11:95:c3:0d:ac
	  country US ecm authmode OPEN privacy ON deftxkey 3 wepkey 3:40-bit
	  txpower 21.5 scanvalid 60 protmode CTS wme burst dtimperiod 1 -dfs</screen>

	<para xml:lang="en">From another wireless machine, it is now possible to
	  initiate a scan to find the <acronym>AP</acronym>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> create wlandev <replaceable>ath0</replaceable></userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> up scan</userinput>
SSID            BSSID              CHAN RATE  S:N   INT CAPS
freebsdap       00:11:95:c3:0d:ac    1   54M 22:1   100 EPS</screen>

	<para xml:lang="en">In this example, the client machine found the
	  <acronym>AP</acronym> and can associate with it using the
	  correct parameters.  See <xref linkend="network-wireless-wep"/> for more details.</para>
      </sect3>
    </sect2>

    <sect2>
      <title>同時使用有線及無線連線</title>

      <para xml:lang="en">A wired connection provides better performance and
	reliability, while a wireless connection provides flexibility
	and mobility.  Laptop users typically want to roam seamlessly
	between the two types of connections.</para>

      <para xml:lang="en">On FreeBSD, it is possible to combine two or even more
	network interfaces together in a <quote>failover</quote>
	fashion.  This type of configuration uses the most preferred
	and available connection from a group of network interfaces,
	and the operating system switches automatically when the link
	state changes.</para>

      <para xml:lang="en">Link aggregation and failover is covered in <xref linkend="network-aggregation"/> and an example for using
	both wired and wireless connections is provided at <xref linkend="networking-lagg-wired-and-wireless"/>.</para>
    </sect2>

    <sect2>
      <title>疑難排解</title>

      <para xml:lang="en">This section describes
	a number of steps to help troubleshoot common wireless
	networking problems.</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">If the access point is not listed when scanning,
	    check that the configuration has not limited the wireless
	    device to a limited set of channels.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">If the device cannot associate with an access point,
	    verify that the configuration matches the settings on the
	    access point.  This includes the authentication scheme and
	    any security protocols.  Simplify the configuration as
	    much as possible.  If using a security protocol such as
	    <acronym>WPA</acronym> or <acronym>WEP</acronym>,
	    configure the access point for open authentication and
	    no security to see if traffic will pass.</para>

	  <para xml:lang="en">Debugging support is provided by
	    <citerefentry><refentrytitle>wpa_supplicant</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  Try running this utility manually
	    with <option>-dd</option> and look at the
	    system logs.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Once the system can associate with the access point,
	    diagnose the network configuration using tools like
	    <citerefentry><refentrytitle>ping</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">There are many lower-level debugging tools.
	    Debugging messages can be enabled in the 802.11 protocol
	    support layer using <citerefentry><refentrytitle>wlandebug</refentrytitle><manvolnum>8</manvolnum></citerefentry>.
	    For example, to enable console messages related to
	    scanning for access points and the 802.11 protocol
	    handshakes required to arrange communication:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>wlandebug -i <replaceable>wlan0</replaceable> +scan+auth+debug+assoc</userinput>
  net.wlan.0.debug: 0 =&gt; 0xc80000&lt;assoc,auth,scan&gt;</screen>

	  <para xml:lang="en">Many useful statistics are maintained by the 802.11
	    layer and <command>wlanstats</command>, found in <filename>/usr/src/tools/tools/net80211</filename>,
	    will dump this information.  These statistics should
	    display all errors identified by the 802.11 layer.
	    However, some errors are identified in the device drivers
	    that lie below the 802.11 layer so they may not show up.
	    To diagnose device-specific problems, refer to the
	    drivers' documentation.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en">If the above information does not help to clarify the
	problem, submit a problem report and include output from the
	above tools.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="network-usb-tethering">
    <info>
      <title>USB 網路共享</title>
    </info>

    <indexterm xml:lang="en">
      <primary>tether</primary>
    </indexterm>

    <para xml:lang="en">Many cellphones provide the option to share their data
      connection over USB (often called "tethering").  This feature
      uses either the <acronym>RNDIS</acronym>, <acronym>CDC</acronym>
      or a custom <trademark class="registered">Apple</trademark> <trademark class="registered">iPhone</trademark>/<trademark class="registered">iPad</trademark>
      protocol.</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en"><trademark>Android</trademark> devices generally use the <citerefentry><refentrytitle>urndis</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	  driver.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><trademark class="registered">Apple</trademark> devices use the <citerefentry><refentrytitle>ipheth</refentrytitle><manvolnum>4</manvolnum></citerefentry> driver.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Older devices will often use the <citerefentry><refentrytitle>cdce</refentrytitle><manvolnum>4</manvolnum></citerefentry>
	  driver.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">Before attaching a device, load the appropriate driver
      into the kernel:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload if_urndis
<prompt>#</prompt> kldload if_cdce
<prompt>#</prompt> kldload if_ipheth</userinput></screen>

    <para xml:lang="en">Once the device is attached
      <literal>ue</literal><replaceable>0</replaceable> will be
      available for use like a normal network device.  Be sure that
      the <quote>USB tethering</quote> option is enabled on the
      device.</para>
  </sect1>

  <sect1 xml:id="network-bluetooth">
    <info>
      <title>藍牙</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Pav</firstname>
	    <surname>Lucistnik</surname>
	  </personname>
	  <contrib>Written by </contrib>
	  <email>pav@FreeBSD.org</email>
	</author>
      </authorgroup>
    </info>

    <indexterm><primary>藍牙</primary></indexterm>

    <para xml:lang="en">Bluetooth is a wireless technology for creating personal
      networks operating in the 2.4 GHz unlicensed band, with a
      range of 10 meters.  Networks are usually formed ad-hoc from
      portable devices such as cellular phones, handhelds, and
      laptops.  Unlike Wi-Fi wireless technology, Bluetooth offers
      higher level service profiles, such as
      <acronym>FTP</acronym>-like file servers, file pushing, voice
      transport, serial line emulation, and more.</para>

    <para xml:lang="en">This section describes the use of a <acronym>USB</acronym>
      Bluetooth dongle on a FreeBSD system.  It then describes the
      various Bluetooth protocols and utilities.</para>

    <sect2>
      <title>載入藍牙支援</title>

      <para xml:lang="en">The Bluetooth stack in FreeBSD is implemented using the
	<citerefentry><refentrytitle>netgraph</refentrytitle><manvolnum>4</manvolnum></citerefentry> framework.  A broad variety of Bluetooth
	<acronym>USB</acronym> dongles is supported by <citerefentry><refentrytitle>ng_ubt</refentrytitle><manvolnum>4</manvolnum></citerefentry>.
	Broadcom BCM2033 based Bluetooth devices are supported by the
	<citerefentry><refentrytitle>ubtbcmfw</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>ng_ubt</refentrytitle><manvolnum>4</manvolnum></citerefentry> drivers.  The 3Com
	Bluetooth PC Card 3CRWB60-A is supported by the
	<citerefentry><refentrytitle>ng_bt3c</refentrytitle><manvolnum>4</manvolnum></citerefentry> driver.  Serial and UART based Bluetooth
	devices are supported by <citerefentry><refentrytitle>sio</refentrytitle><manvolnum>4</manvolnum></citerefentry>, <citerefentry><refentrytitle>ng_h4</refentrytitle><manvolnum>4</manvolnum></citerefentry>, and
	<citerefentry><refentrytitle>hcseriald</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

      <para xml:lang="en">Before attaching a device, determine which of the above
	drivers it uses, then load the driver.  For example, if the
	device uses the <citerefentry><refentrytitle>ng_ubt</refentrytitle><manvolnum>4</manvolnum></citerefentry> driver:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload ng_ubt</userinput></screen>

      <para xml:lang="en">If the Bluetooth device will be attached to the system
	during system startup, the system can be configured to load
	the module at boot time by adding the driver to
	<filename>/boot/loader.conf</filename>:</para>

      <programlisting xml:lang="en">ng_ubt_load="YES"</programlisting>

      <para xml:lang="en">Once the driver is loaded, plug in the
	<acronym>USB</acronym> dongle.  If the driver load was
	successful, output similar to the following should appear on
	the console and in
	<filename>/var/log/messages</filename>:</para>

      <screen xml:lang="en">ubt0: vendor 0x0a12 product 0x0001, rev 1.10/5.25, addr 2
ubt0: Interface 0 endpoints: interrupt=0x81, bulk-in=0x82, bulk-out=0x2
ubt0: Interface 1 (alt.config 5) endpoints: isoc-in=0x83, isoc-out=0x3,
      wMaxPacketSize=49, nframes=6, buffer size=294</screen>

      <para xml:lang="en">To start and stop the Bluetooth stack, use its startup
	script.  It is a good idea to stop the stack before unplugging
	the device.  Starting the bluetooth stack might require
	<citerefentry><refentrytitle>hcsecd</refentrytitle><manvolnum>8</manvolnum></citerefentry> to be started.  When starting the stack, the
	output should be similar to the following:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service bluetooth start ubt0</userinput>
BD_ADDR: 00:02:72:00:d4:1a
Features: 0xff 0xff 0xf 00 00 00 00 00
&lt;3-Slot&gt; &lt;5-Slot&gt; &lt;Encryption&gt; &lt;Slot offset&gt;
&lt;Timing accuracy&gt; &lt;Switch&gt; &lt;Hold mode&gt; &lt;Sniff mode&gt;
&lt;Park mode&gt; &lt;RSSI&gt; &lt;Channel quality&gt; &lt;SCO link&gt;
&lt;HV2 packets&gt; &lt;HV3 packets&gt; &lt;u-law log&gt; &lt;A-law log&gt; &lt;CVSD&gt;
&lt;Paging scheme&gt; &lt;Power control&gt; &lt;Transparent SCO data&gt;
Max. ACL packet size: 192 bytes
Number of ACL packets: 8
Max. SCO packet size: 64 bytes
Number of SCO packets: 8</screen>
    </sect2>

    <sect2>
      <title>尋找其他藍牙裝置</title>

      <indexterm xml:lang="en">
	<primary>HCI</primary>
      </indexterm>

      <para xml:lang="en">The Host Controller Interface (<acronym>HCI</acronym>)
	provides a uniform method for accessing Bluetooth baseband
	capabilities.  In FreeBSD, a netgraph <acronym>HCI</acronym> node
	is created for each Bluetooth device.  For more details, refer
	to <citerefentry><refentrytitle>ng_hci</refentrytitle><manvolnum>4</manvolnum></citerefentry>.</para>

      <para xml:lang="en">One of the most common tasks is discovery of Bluetooth
	devices within <acronym>RF</acronym> proximity.  This
	operation is called <emphasis>inquiry</emphasis>.  Inquiry and
	other <acronym>HCI</acronym> related operations are done using
	<citerefentry><refentrytitle>hccontrol</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  The example below shows how to find out
	which Bluetooth devices are in range.  The list of devices
	should be displayed in a few seconds.  Note that a remote
	device will only answer the inquiry if it is set to
	<emphasis>discoverable</emphasis> mode.</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>hccontrol -n ubt0hci inquiry</userinput>
Inquiry result, num_responses=1
Inquiry result #0
       BD_ADDR: 00:80:37:29:19:a4
       Page Scan Rep. Mode: 0x1
       Page Scan Period Mode: 00
       Page Scan Mode: 00
       Class: 52:02:04
       Clock offset: 0x78ef
Inquiry complete. Status: No error [00]</screen>

      <para xml:lang="en">The <literal>BD_ADDR</literal> is the unique address of a
	Bluetooth device, similar to the <acronym>MAC</acronym>
	address of a network card.  This address is needed for further
	communication with a device and it is possible to assign a
	human readable name to a <literal>BD_ADDR</literal>.
	Information regarding the known Bluetooth hosts is contained
	in <filename>/etc/bluetooth/hosts</filename>.  The following
	example shows how to obtain the human readable name that was
	assigned to the remote device:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>hccontrol -n ubt0hci remote_name_request 00:80:37:29:19:a4</userinput>
BD_ADDR: 00:80:37:29:19:a4
Name: Pav's T39</screen>

      <para xml:lang="en">If an inquiry is performed on a remote Bluetooth device,
	it will find the computer as
	<quote>your.host.name (ubt0)</quote>.  The name assigned to
	the local device can be changed at any time.</para>

      <para xml:lang="en">Remote devices can be assigned aliases in
	<filename>/etc/bluetooth/hosts</filename>.  More information
	about <filename>/etc/bluetooth/hosts</filename> file might be
	found in <citerefentry><refentrytitle>bluetooth.hosts</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>

      <para xml:lang="en">The Bluetooth system provides a point-to-point connection
	between two Bluetooth units, or a point-to-multipoint
	connection which is shared among several Bluetooth devices.
	The following example shows how to create a connection to a
	remote device:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>hccontrol -n ubt0hci create_connection <replaceable>BT_ADDR</replaceable></userinput></screen>

      <para xml:lang="en"><literal>create_connection</literal> accepts
	<literal>BT_ADDR</literal> as well as host aliases in
	<filename>/etc/bluetooth/hosts</filename>.</para>

      <para xml:lang="en">The following example shows how to obtain the list of
	active baseband connections for the local device:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>hccontrol -n ubt0hci read_connection_list</userinput>
Remote BD_ADDR    Handle Type Mode Role Encrypt Pending Queue State
00:80:37:29:19:a4     41  ACL    0 MAST    NONE       0     0 OPEN</screen>

      <para xml:lang="en">A <emphasis>connection handle</emphasis> is useful when
	termination of the baseband connection is required, though
	it is normally not required to do this by hand.  The stack
	will automatically terminate inactive baseband
	connections.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>hccontrol -n ubt0hci disconnect 41</userinput>
Connection handle: 41
Reason: Connection terminated by local host [0x16]</screen>

      <para xml:lang="en">Type <command>hccontrol help</command> for a complete
	listing of available <acronym>HCI</acronym> commands.  Most
	of the <acronym>HCI</acronym> commands do not require
	superuser privileges.</para>
    </sect2>

    <sect2>
      <title>裝置配對</title>

      <para xml:lang="en">By default, Bluetooth communication is not authenticated,
	and any device can talk to any other device.  A Bluetooth
	device, such as a cellular phone, may choose to require
	authentication to provide a particular service.  Bluetooth
	authentication is normally done with a
	<emphasis><acronym>PIN</acronym> code</emphasis>, an ASCII
	string up to 16 characters in length.  The user is required
	to enter the same <acronym>PIN</acronym> code on both devices.
	Once the user has entered the <acronym>PIN</acronym> code,
	both devices will generate a <emphasis>link key</emphasis>.
	After that, the link key can be stored either in the devices
	or in a persistent storage.  Next time, both devices will
	use the previously generated link key.  This procedure is
	called <emphasis>pairing</emphasis>.  Note that if the link
	key is lost by either device, the pairing must be
	repeated.</para>

      <para xml:lang="en">The <citerefentry><refentrytitle>hcsecd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon is responsible for handling
	Bluetooth authentication requests.  The default configuration
	file is <filename>/etc/bluetooth/hcsecd.conf</filename>.  An
	example section for a cellular phone with the
	<acronym>PIN</acronym> code set to <literal>1234</literal> is
	shown below:</para>

      <programlisting xml:lang="en">device {
        bdaddr  00:80:37:29:19:a4;
        name    "Pav's T39";
        key     nokey;
        pin     "1234";
      }</programlisting>

      <para xml:lang="en">The only limitation on <acronym>PIN</acronym> codes is
	length.  Some devices, such as Bluetooth headsets, may have
	a fixed <acronym>PIN</acronym> code built in.  The
	<option>-d</option> switch forces <citerefentry><refentrytitle>hcsecd</refentrytitle><manvolnum>8</manvolnum></citerefentry> to stay in
	the foreground, so it is easy to see what is happening.  Set
	the remote device to receive pairing and initiate the
	Bluetooth connection to the remote device.  The remote device
	should indicate that pairing was accepted and request the
	<acronym>PIN</acronym> code.  Enter the same
	<acronym>PIN</acronym> code listed in
	<filename>hcsecd.conf</filename>.  Now the computer and the
	remote device are paired.  Alternatively, pairing can be
	initiated on the remote device.</para>

      <para xml:lang="en">The following line can be added to
	<filename>/etc/rc.conf</filename> to configure <citerefentry><refentrytitle>hcsecd</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	to start automatically on system start:</para>

      <programlisting xml:lang="en">hcsecd_enable="YES"</programlisting>

      <para xml:lang="en">The following is a sample of the <citerefentry><refentrytitle>hcsecd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon
	output:</para>

      <programlisting xml:lang="en">hcsecd[16484]: Got Link_Key_Request event from 'ubt0hci', remote bdaddr 0:80:37:29:19:a4
hcsecd[16484]: Found matching entry, remote bdaddr 0:80:37:29:19:a4, name 'Pav's T39', link key doesn't exist
hcsecd[16484]: Sending Link_Key_Negative_Reply to 'ubt0hci' for remote bdaddr 0:80:37:29:19:a4
hcsecd[16484]: Got PIN_Code_Request event from 'ubt0hci', remote bdaddr 0:80:37:29:19:a4
hcsecd[16484]: Found matching entry, remote bdaddr 0:80:37:29:19:a4, name 'Pav's T39', PIN code exists
hcsecd[16484]: Sending PIN_Code_Reply to 'ubt0hci' for remote bdaddr 0:80:37:29:19:a4</programlisting>
    </sect2>

    <sect2>
      <title>使用 <acronym>PPP</acronym> Profile 存取網路</title>

      <para xml:lang="en">A Dial-Up Networking (<acronym>DUN</acronym>) profile can
	be used to configure a cellular phone as a wireless modem for
	connecting to a dial-up Internet access server.  It can also
	be used to configure a computer to receive data calls from a
	cellular phone.</para>

      <para xml:lang="en">Network access with a <acronym>PPP</acronym> profile can
	be used to provide <acronym>LAN</acronym> access for a single
	Bluetooth device or multiple Bluetooth devices.  It can also
	provide <acronym>PC</acronym> to <acronym>PC</acronym>
	connection using <acronym>PPP</acronym> networking over serial
	cable emulation.</para>

      <para xml:lang="en">In FreeBSD, these profiles are implemented with <citerefentry><refentrytitle>ppp</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	and the <citerefentry><refentrytitle>rfcomm_pppd</refentrytitle><manvolnum>8</manvolnum></citerefentry> wrapper which converts a
	Bluetooth connection into something
	<acronym>PPP</acronym> can use.  Before a profile can be used,
	a new <acronym>PPP</acronym> label must be created in
	<filename>/etc/ppp/ppp.conf</filename>.  Consult
	<citerefentry><refentrytitle>rfcomm_pppd</refentrytitle><manvolnum>8</manvolnum></citerefentry> for examples.</para>

      <para xml:lang="en">In this example, <citerefentry><refentrytitle>rfcomm_pppd</refentrytitle><manvolnum>8</manvolnum></citerefentry> is used to open a
	connection to a remote device with a
	<literal>BD_ADDR</literal> of
	<literal>00:80:37:29:19:a4</literal> on a
	<acronym>DUN</acronym> <acronym>RFCOMM</acronym>
	channel:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>rfcomm_pppd -a 00:80:37:29:19:a4 -c -C dun -l rfcomm-dialup</userinput></screen>

      <para xml:lang="en">The actual channel number will be obtained from the remote
	device using the <acronym>SDP</acronym> protocol.  It is
	possible to specify the <acronym>RFCOMM</acronym> channel by
	hand, and in this case <citerefentry><refentrytitle>rfcomm_pppd</refentrytitle><manvolnum>8</manvolnum></citerefentry> will not perform
	the <acronym>SDP</acronym> query.  Use <citerefentry><refentrytitle>sdpcontrol</refentrytitle><manvolnum>8</manvolnum></citerefentry> to
	find out the <acronym>RFCOMM</acronym> channel on the remote
	device.</para>

      <para xml:lang="en">In order to provide network access with the
	<acronym>PPP</acronym> <acronym>LAN</acronym> service,
	<citerefentry><refentrytitle>sdpd</refentrytitle><manvolnum>8</manvolnum></citerefentry> must be running and a new entry for
	<acronym>LAN</acronym> clients must be created in
	<filename>/etc/ppp/ppp.conf</filename>.  Consult
	<citerefentry><refentrytitle>rfcomm_pppd</refentrytitle><manvolnum>8</manvolnum></citerefentry> for examples.  Finally, start the
	<acronym>RFCOMM</acronym> <acronym>PPP</acronym> server on a
	valid <acronym>RFCOMM</acronym> channel number.  The
	<acronym>RFCOMM</acronym> <acronym>PPP</acronym> server will
	automatically register the Bluetooth <acronym>LAN</acronym>
	service with the local <acronym>SDP</acronym> daemon.  The
	example below shows how to start the <acronym>RFCOMM</acronym>
	<acronym>PPP</acronym> server.</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>rfcomm_pppd -s -C 7 -l rfcomm-server</userinput></screen>
    </sect2>

    <sect2>
      <title>藍牙通訊協定</title>

      <para xml:lang="en">This section provides an overview of the various Bluetooth
	protocols, their function, and associated utilities.</para>

      <sect3>
	<title xml:lang="en">Logical Link Control and Adaptation Protocol
	  (<acronym>L2CAP</acronym>)</title>

	<indexterm xml:lang="en">
	  <primary>L2CAP</primary>
	</indexterm>

	<para xml:lang="en">The Logical Link Control and Adaptation Protocol
	  (<acronym>L2CAP</acronym>) provides connection-oriented and
	  connectionless data services to upper layer protocols.
	  <acronym>L2CAP</acronym> permits higher level protocols and
	  applications to transmit and receive
	  <acronym>L2CAP</acronym> data packets up to 64 kilobytes in
	  length.</para>

	<para xml:lang="en"><acronym>L2CAP</acronym> is based around the concept of
	  <emphasis>channels</emphasis>.  A channel is a logical
	  connection on top of a baseband connection, where each
	  channel is bound to a single protocol in a many-to-one
	  fashion.  Multiple channels can be bound to the same
	  protocol, but a channel cannot be bound to multiple
	  protocols.  Each <acronym>L2CAP</acronym> packet received on
	  a channel is directed to the appropriate higher level
	  protocol.  Multiple channels can share the same baseband
	  connection.</para>

	<para xml:lang="en">In FreeBSD, a netgraph <acronym>L2CAP</acronym> node is
	  created for each Bluetooth device.  This node is normally
	  connected to the downstream Bluetooth <acronym>HCI</acronym>
	  node and upstream Bluetooth socket nodes.  The default name
	  for the <acronym>L2CAP</acronym> node is
	  <quote>devicel2cap</quote>.  For more details refer to
	  <citerefentry><refentrytitle>ng_l2cap</refentrytitle><manvolnum>4</manvolnum></citerefentry>.</para>

	<para xml:lang="en">A useful command is <citerefentry><refentrytitle>l2ping</refentrytitle><manvolnum>8</manvolnum></citerefentry>, which can be used to
	  ping other devices.  Some Bluetooth implementations might
	  not return all of the data sent to them, so <literal>0
	    bytes</literal> in the following example is normal.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>l2ping -a 00:80:37:29:19:a4</userinput>
0 bytes from 0:80:37:29:19:a4 seq_no=0 time=48.633 ms result=0
0 bytes from 0:80:37:29:19:a4 seq_no=1 time=37.551 ms result=0
0 bytes from 0:80:37:29:19:a4 seq_no=2 time=28.324 ms result=0
0 bytes from 0:80:37:29:19:a4 seq_no=3 time=46.150 ms result=0</screen>

	<para xml:lang="en">The <citerefentry><refentrytitle>l2control</refentrytitle><manvolnum>8</manvolnum></citerefentry> utility is used to perform various
	  operations on <acronym>L2CAP</acronym> nodes.  This example
	  shows how to obtain the list of logical connections
	  (channels) and the list of baseband connections for the
	  local device:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>l2control -a 00:02:72:00:d4:1a read_channel_list</userinput>
L2CAP channels:
Remote BD_ADDR     SCID/ DCID   PSM  IMTU/ OMTU State
00:07:e0:00:0b:ca    66/   64     3   132/  672 OPEN
<prompt>%</prompt> <userinput>l2control -a 00:02:72:00:d4:1a read_connection_list</userinput>
L2CAP connections:
Remote BD_ADDR    Handle Flags Pending State
00:07:e0:00:0b:ca     41 O           0 OPEN</screen>

	<para xml:lang="en">Another diagnostic tool is <citerefentry><refentrytitle>btsockstat</refentrytitle><manvolnum>1</manvolnum></citerefentry>.  It is
	  similar to <citerefentry><refentrytitle>netstat</refentrytitle><manvolnum>1</manvolnum></citerefentry>, but for Bluetooth
	  network-related data structures.  The example below shows
	  the same logical connection as <citerefentry><refentrytitle>l2control</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	  above.</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>btsockstat</userinput>
Active L2CAP sockets
PCB      Recv-Q Send-Q Local address/PSM       Foreign address   CID   State
c2afe900      0      0 00:02:72:00:d4:1a/3     00:07:e0:00:0b:ca 66    OPEN
Active RFCOMM sessions
L2PCB    PCB      Flag MTU   Out-Q DLCs State
c2afe900 c2b53380 1    127   0     Yes  OPEN
Active RFCOMM sockets
PCB      Recv-Q Send-Q Local address     Foreign address   Chan DLCI State
c2e8bc80      0    250 00:02:72:00:d4:1a 00:07:e0:00:0b:ca 3    6    OPEN</screen>
      </sect3>

      <sect3>
	<title xml:lang="en">Radio Frequency Communication
	  (<acronym>RFCOMM</acronym>)</title>

	<para xml:lang="en">The <acronym>RFCOMM</acronym> protocol provides
	  emulation of serial ports over the <acronym>L2CAP</acronym>
	  protocol.  <acronym>RFCOMM</acronym> is a simple transport
	  protocol, with additional provisions for emulating the 9
	  circuits of RS-232 (EIATIA-232-E) serial ports.  It
	  supports up to 60 simultaneous connections
	  (<acronym>RFCOMM</acronym> channels) between two Bluetooth
	  devices.</para>

	<para xml:lang="en">For the purposes of <acronym>RFCOMM</acronym>, a
	  complete communication path involves two applications
	  running on the communication endpoints with a communication
	  segment between them.  <acronym>RFCOMM</acronym> is intended
	  to cover applications that make use of the serial ports of
	  the devices in which they reside.  The communication segment
	  is a direct connect Bluetooth link from one device to
	  another.</para>

	<para xml:lang="en"><acronym>RFCOMM</acronym> is only concerned with the
	  connection between the devices in the direct connect case,
	  or between the device and a modem in the network case.
	  <acronym>RFCOMM</acronym> can support other configurations,
	  such as modules that communicate via Bluetooth wireless
	  technology on one side and provide a wired interface on the
	  other side.</para>

	<para xml:lang="en">In FreeBSD, <acronym>RFCOMM</acronym> is implemented at the
	  Bluetooth sockets layer.</para>
      </sect3>

      <sect3>
	<title xml:lang="en">Service Discovery Protocol
	  (<acronym>SDP</acronym>)</title>

	<indexterm xml:lang="en">
	  <primary>SDP</primary>
	</indexterm>

	<para xml:lang="en">The Service Discovery Protocol (<acronym>SDP</acronym>)
	  provides the means for client applications to discover the
	  existence of services provided by server applications as
	  well as the attributes of those services.  The attributes of
	  a service include the type or class of service offered and
	  the mechanism or protocol information needed to utilize the
	  service.</para>

	<para xml:lang="en"><acronym>SDP</acronym> involves communication between a
	  <acronym>SDP</acronym> server and a <acronym>SDP</acronym>
	  client.  The server maintains a list of service records that
	  describe the characteristics of services associated with the
	  server.  Each service record contains information about a
	  single service.  A client may retrieve information from a
	  service record maintained by the <acronym>SDP</acronym>
	  server by issuing a <acronym>SDP</acronym> request.  If the
	  client, or an application associated with the client,
	  decides to use a service, it must open a separate connection
	  to the service provider in order to utilize the service.
	  <acronym>SDP</acronym> provides a mechanism for discovering
	  services and their attributes, but it does not provide a
	  mechanism for utilizing those services.</para>

	<para xml:lang="en">Normally, a <acronym>SDP</acronym> client searches for
	  services based on some desired characteristics of the
	  services.  However, there are times when it is desirable to
	  discover which types of services are described by an
	  <acronym>SDP</acronym> server's service records without any
	  prior information about the services.  This process of
	  looking for any offered services is called
	  <emphasis>browsing</emphasis>.</para>

	<para xml:lang="en">The Bluetooth <acronym>SDP</acronym> server,
	  <citerefentry><refentrytitle>sdpd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, and command line client, <citerefentry><refentrytitle>sdpcontrol</refentrytitle><manvolnum>8</manvolnum></citerefentry>,
	  are included in the standard FreeBSD installation.  The
	  following example shows how to perform a
	  <acronym>SDP</acronym> browse query.</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>sdpcontrol -a 00:01:03:fc:6e:ec browse</userinput>
Record Handle: 00000000
Service Class ID List:
        Service Discovery Server (0x1000)
Protocol Descriptor List:
        L2CAP (0x0100)
                Protocol specific parameter #1: u/int/uuid16 1
                Protocol specific parameter #2: u/int/uuid16 1

Record Handle: 0x00000001
Service Class ID List:
        Browse Group Descriptor (0x1001)

Record Handle: 0x00000002
Service Class ID List:
        LAN Access Using PPP (0x1102)
Protocol Descriptor List:
        L2CAP (0x0100)
        RFCOMM (0x0003)
                Protocol specific parameter #1: u/int8/bool 1
Bluetooth Profile Descriptor List:
        LAN Access Using PPP (0x1102) ver. 1.0</screen>

	<para xml:lang="en">Note that each service has a list of attributes, such
	  as the <acronym>RFCOMM</acronym> channel.  Depending on the
	  service, the user might need to make note of some of the
	  attributes.  Some Bluetooth implementations do not support
	  service browsing and may return an empty list.  In this
	  case, it is possible to search for the specific service.
	  The example below shows how to search for the
	  <acronym>OBEX</acronym> Object Push
	  (<acronym>OPUSH</acronym>) service:</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>sdpcontrol -a 00:01:03:fc:6e:ec search OPUSH</userinput></screen>

	<para xml:lang="en">Offering services on FreeBSD to Bluetooth clients is done
	  with the <citerefentry><refentrytitle>sdpd</refentrytitle><manvolnum>8</manvolnum></citerefentry> server.  The following line can be
	  added to <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">sdpd_enable="YES"</programlisting>

	<para xml:lang="en">Then the <citerefentry><refentrytitle>sdpd</refentrytitle><manvolnum>8</manvolnum></citerefentry> daemon can be started with:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>service sdpd start</userinput></screen>

	<para xml:lang="en">The local server application that wants to provide a
	  Bluetooth service to remote clients will register the
	  service with the local <acronym>SDP</acronym> daemon.  An
	  example of such an application is <citerefentry><refentrytitle>rfcomm_pppd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  Once
	  started, it will register the Bluetooth LAN service with the
	  local <acronym>SDP</acronym> daemon.</para>

	<para xml:lang="en">The list of services registered with the local
	  <acronym>SDP</acronym> server can be obtained by issuing a
	  <acronym>SDP</acronym> browse query via the local control
	  channel:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>sdpcontrol -l browse</userinput></screen>
      </sect3>

      <sect3>
	<title xml:lang="en"><acronym>OBEX</acronym> Object Push
	  (<acronym>OPUSH</acronym>)</title>

	<indexterm xml:lang="en">
	  <primary>OBEX</primary>
	</indexterm>

	<para xml:lang="en">Object Exchange (<acronym>OBEX</acronym>) is a widely
	  used protocol for simple file transfers between mobile
	  devices.  Its main use is in infrared communication, where
	  it is used for generic file transfers between notebooks or
	  <acronym>PDA</acronym>s, and for sending business cards or
	  calendar entries between cellular phones and other devices
	  with Personal Information Manager (<acronym>PIM</acronym>)
	  applications.</para>

	<para xml:lang="en">The <acronym>OBEX</acronym> server and client are
	  implemented by <application>obexapp</application>, which can
	  be installed using the <package>comms/obexapp</package>
	  package or port.</para>

	<para xml:lang="en">The <acronym>OBEX</acronym> client is used to push
	  and/or pull objects from the <acronym>OBEX</acronym> server.
	  An example object is a business card or an appointment.
	  The <acronym>OBEX</acronym> client can obtain the
	  <acronym>RFCOMM</acronym> channel number from the remote
	  device via <acronym>SDP</acronym>.  This can be done by
	  specifying the service name instead of the
	  <acronym>RFCOMM</acronym> channel number.  Supported service
	  names are: <literal>IrMC</literal>, <literal>FTRN</literal>,
	  and <literal>OPUSH</literal>.  It is also possible to
	  specify the <acronym>RFCOMM</acronym> channel as a number.
	  Below is an example of an <acronym>OBEX</acronym> session
	  where the device information object is pulled from the
	  cellular phone, and a new object, the business card, is
	  pushed into the phone's directory.</para>

	<screen xml:lang="en"><prompt>%</prompt> <userinput>obexapp -a 00:80:37:29:19:a4 -C IrMC</userinput>
obex&gt; get telecom/devinfo.txt devinfo-t39.txt
Success, response: OK, Success (0x20)
obex&gt; put new.vcf
Success, response: OK, Success (0x20)
obex&gt; di
Success, response: OK, Success (0x20)</screen>

	<para xml:lang="en">In order to provide the <acronym>OPUSH</acronym>
	  service, <citerefentry><refentrytitle>sdpd</refentrytitle><manvolnum>8</manvolnum></citerefentry> must be running and a root folder,
	  where all incoming objects will be stored, must be created.
	  The default path to the root folder is
	  <filename>/var/spool/obex</filename>.  Finally, start the
	  <acronym>OBEX</acronym> server on a valid
	  <acronym>RFCOMM</acronym> channel number.  The
	  <acronym>OBEX</acronym> server will automatically register
	  the <acronym>OPUSH</acronym> service with the local
	  <acronym>SDP</acronym> daemon.  The example below shows how
	  to start the <acronym>OBEX</acronym> server.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>obexapp -s -C 10</userinput></screen>
      </sect3>

      <sect3>
	<title xml:lang="en">Serial Port Profile (<acronym>SPP</acronym>)</title>

	<para xml:lang="en">The Serial Port Profile (<acronym>SPP</acronym>) allows
	  Bluetooth devices to perform serial cable emulation.  This
	  profile allows legacy applications to use Bluetooth as a
	  cable replacement, through a virtual serial port
	  abstraction.</para>

	<para xml:lang="en">In FreeBSD, <citerefentry><refentrytitle>rfcomm_sppd</refentrytitle><manvolnum>1</manvolnum></citerefentry> implements
	  <acronym>SPP</acronym> and a pseudo tty is used as a virtual
	  serial port abstraction.  The example below shows how to
	  connect to a remote device's serial port service.  A
	  <acronym>RFCOMM</acronym> channel does not have to be
	  specified as <citerefentry><refentrytitle>rfcomm_sppd</refentrytitle><manvolnum>1</manvolnum></citerefentry> can obtain it from the
	  remote device via <acronym>SDP</acronym>.  To override this,
	  specify a <acronym>RFCOMM</acronym> channel on the command
	  line.</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>rfcomm_sppd -a 00:07:E0:00:0B:CA -t</userinput>
rfcomm_sppd[94692]: Starting on /dev/pts/6...
/dev/pts/6</screen>

	<para xml:lang="en">Once connected, the pseudo tty can be used as serial
	  port:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>cu -l /dev/pts/6</userinput></screen>

	<para xml:lang="en">The pseudo tty is printed on stdout and can be read by
	  wrapper scripts:</para>

	<programlisting xml:lang="en">PTS=`rfcomm_sppd -a 00:07:E0:00:0B:CA -t`
cu -l $PTS</programlisting>
      </sect3>
    </sect2>

    <sect2>
      <title>疑難排解</title>

      <para xml:lang="en">By default, when FreeBSD is accepting a new connection, it
	tries to perform a role switch and become master.  Some older
	Bluetooth devices which do not support role switching will not
	be able to connect.  Since role switching is performed when a
	new connection is being established, it is not possible to ask
	the remote device if it supports role switching.  However,
	there is a <acronym>HCI</acronym> option to disable role
	switching on the local side:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>hccontrol -n ubt0hci write_node_role_switch 0</userinput></screen>

      <para xml:lang="en">To display Bluetooth packets, use the third-party package
	<application>hcidump</application>, which can be installed
	using the <package>comms/hcidump</package> package or port.
	This utility is similar to <citerefentry><refentrytitle>tcpdump</refentrytitle><manvolnum>1</manvolnum></citerefentry> and can be used to
	display the contents of Bluetooth packets on the terminal and
	to dump the Bluetooth packets to a file.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="network-bridging">
    <info>
      <title>橋接</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Andrew</firstname>
	    <surname>Thompson</surname>
	  </personname>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm><primary><acronym>IP</acronym> 子網段</primary></indexterm>
    <indexterm><primary>橋接</primary></indexterm>

    <para xml:lang="en">It is sometimes useful to divide a network, such as an
      Ethernet segment, into network segments without having to
      create <acronym>IP</acronym> subnets and use a router to connect
      the segments together.  A device that connects two networks
      together in this fashion is called a
      <quote>bridge</quote>.</para>

    <para xml:lang="en">A bridge works by learning the <acronym>MAC</acronym>
      addresses of the devices on each of its network interfaces.  It
      forwards traffic between networks only when the source and
      destination <acronym>MAC</acronym> addresses are on different
      networks.  In many respects, a bridge is like an Ethernet switch
      with very few ports.    A FreeBSD system with multiple network
      interfaces can be configured to act as a bridge.</para>

    <para xml:lang="en">Bridging can be useful in the following situations:</para>

    <variablelist>
      <varlistentry>
	<term xml:lang="en">Connecting Networks</term>
	<listitem>
	  <para xml:lang="en">The basic operation of a bridge is to join two or more
	    network segments.  There are many reasons to use a
	    host-based bridge instead of networking equipment, such as
	    cabling constraints or firewalling.  A bridge can also
	    connect a wireless interface running in hostap mode to a
	    wired network and act as an access point.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">Filtering/Traffic Shaping Firewall</term>
	<listitem>
	  <para xml:lang="en">A bridge can be used when firewall functionality is
	    needed without routing or Network Address Translation
	    (<acronym>NAT</acronym>).</para>

	  <para xml:lang="en">An example is a small company that is connected via
	    <acronym>DSL</acronym> or <acronym>ISDN</acronym> to an
	    <acronym>ISP</acronym>.  There are thirteen public
	    <acronym>IP</acronym> addresses from the
	    <acronym>ISP</acronym> and ten computers on the network.
	    In this situation, using a router-based firewall is
	    difficult because of subnetting issues.  A bridge-based
	    firewall can be configured without any
	    <acronym>IP</acronym> addressing issues.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">Network Tap</term>
	<listitem>
	  <para xml:lang="en">A bridge can join two network segments in order to
	    inspect all Ethernet frames that pass between them using
	    <citerefentry><refentrytitle>bpf</refentrytitle><manvolnum>4</manvolnum></citerefentry> and <citerefentry><refentrytitle>tcpdump</refentrytitle><manvolnum>1</manvolnum></citerefentry> on the bridge interface or
	    by sending a copy of all frames out an additional
	    interface known as a span port.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">Layer 2 <acronym>VPN</acronym></term>
	<listitem>
	  <para xml:lang="en">Two Ethernet networks can be joined across an
	    <acronym>IP</acronym> link by bridging the networks to an
	    EtherIP tunnel or a <citerefentry><refentrytitle>tap</refentrytitle><manvolnum>4</manvolnum></citerefentry> based solution such as
	    <application>OpenVPN</application>.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">Layer 2 Redundancy</term>
	<listitem>
	  <para xml:lang="en">A network can be connected together with multiple
	    links and use the Spanning Tree Protocol
	    (<acronym>STP</acronym>) to block redundant paths.</para>
	</listitem>
      </varlistentry>
    </variablelist>

    <para xml:lang="en">This section describes how to configure a FreeBSD system as a
      bridge using <citerefentry><refentrytitle>if_bridge</refentrytitle><manvolnum>4</manvolnum></citerefentry>.  A netgraph bridging driver is
      also available, and is described in <citerefentry><refentrytitle>ng_bridge</refentrytitle><manvolnum>4</manvolnum></citerefentry>.</para>

    <note>
      <para xml:lang="en">Packet filtering can be used with any firewall package
	that hooks into the <citerefentry><refentrytitle>pfil</refentrytitle><manvolnum>9</manvolnum></citerefentry> framework.  The bridge can be
	used as a traffic shaper with <citerefentry><refentrytitle>altq</refentrytitle><manvolnum>4</manvolnum></citerefentry> or
	<citerefentry><refentrytitle>dummynet</refentrytitle><manvolnum>4</manvolnum></citerefentry>.</para>
    </note>

    <sect2>
      <title>開啟橋接</title>

      <para xml:lang="en">In FreeBSD, <citerefentry><refentrytitle>if_bridge</refentrytitle><manvolnum>4</manvolnum></citerefentry> is a kernel module which is
	automatically loaded by <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry> when creating a
	bridge interface.  It is also possible to compile bridge
	support into a custom kernel by adding
	<literal>device if_bridge</literal> to the custom kernel
	configuration file.</para>

      <para xml:lang="en">The bridge is created using interface cloning.  To create
	the bridge interface:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig bridge create</userinput>
bridge0
<prompt>#</prompt> <userinput>ifconfig bridge0</userinput>
bridge0: flags=8802&lt;BROADCAST,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        ether 96:3d:4b:f1:79:7a
        id 00:00:00:00:00:00 priority 32768 hellotime 2 fwddelay 15
        maxage 20 holdcnt 6 proto rstp maxaddr 100 timeout 1200
        root id 00:00:00:00:00:00 priority 0 ifcost 0 port 0</screen>

      <para xml:lang="en">When a bridge interface is created, it is automatically
	assigned a randomly generated Ethernet address.  The
	<literal>maxaddr</literal> and <literal>timeout</literal>
	parameters control how many <acronym>MAC</acronym> addresses
	the bridge will keep in its forwarding table and how many
	seconds before each entry is removed after it is last seen.
	The other parameters control how <acronym>STP</acronym>
	operates.</para>

      <para xml:lang="en">Next, specify which network interfaces to add as members
	of the bridge.  For the bridge to forward packets, all member
	interfaces and the bridge need to be up:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig bridge0 addm fxp0 addm fxp1 up</userinput>
<prompt>#</prompt> <userinput>ifconfig fxp0 up</userinput>
<prompt>#</prompt> <userinput>ifconfig fxp1 up</userinput></screen>

      <para xml:lang="en">The bridge can now forward Ethernet frames between
	<filename>fxp0</filename> and <filename>fxp1</filename>.  Add
	the following lines to <filename>/etc/rc.conf</filename> so
	the bridge is created at startup:</para>

      <programlisting xml:lang="en">cloned_interfaces="bridge0"
ifconfig_bridge0="addm fxp0 addm fxp1 up"
ifconfig_fxp0="up"
ifconfig_fxp1="up"</programlisting>

      <para xml:lang="en">If the bridge host needs an <acronym>IP</acronym>
	address, set it on the bridge interface, not on the member
	interfaces.  The address can be set statically or via
	<acronym>DHCP</acronym>.  This example sets a static
	<acronym>IP</acronym> address:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig bridge0 inet 192.168.0.1/24</userinput></screen>

      <para xml:lang="en">It is also possible to assign an <acronym>IPv6</acronym>
	address to a bridge interface.  To make the changes permanent,
	add the addressing information to
	<filename>/etc/rc.conf</filename>.</para>

      <note>
	<para xml:lang="en">When packet filtering is enabled, bridged packets will
	  pass through the filter inbound on the originating interface
	  on the bridge interface, and outbound on the appropriate
	  interfaces.  Either stage can be disabled.  When direction
	  of the packet flow is important, it is best to firewall on
	  the member interfaces rather than the bridge itself.</para>

	<para xml:lang="en">The bridge has several configurable settings for passing
	  non-<acronym>IP</acronym> and <acronym>IP</acronym> packets,
	  and layer2 firewalling with <citerefentry><refentrytitle>ipfw</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  See
	  <citerefentry><refentrytitle>if_bridge</refentrytitle><manvolnum>4</manvolnum></citerefentry> for more information.</para>
      </note>
    </sect2>

    <sect2>
      <title>開啟 Spanning Tree</title>

      <para xml:lang="en">For an Ethernet network to function properly, only one
	active path can exist between two devices.  The
	<acronym>STP</acronym> protocol detects loops and puts
	redundant links into a blocked state.  Should one of the
	active links fail, <acronym>STP</acronym> calculates a
	different tree and enables one of the blocked paths to restore
	connectivity to all points in the network.</para>

      <para xml:lang="en">The Rapid Spanning Tree Protocol (<acronym>RSTP</acronym>
	or 802.1w) provides backwards compatibility with legacy
	<acronym>STP</acronym>.  <acronym>RSTP</acronym> provides
	faster convergence and exchanges information with neighboring
	switches to quickly transition to forwarding mode without
	creating loops.  FreeBSD supports <acronym>RSTP</acronym> and
	<acronym>STP</acronym> as operating modes, with
	<acronym>RSTP</acronym> being the default mode.</para>

      <para xml:lang="en"><acronym>STP</acronym> can be enabled on member interfaces
	using <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>.  For a bridge with
	<filename>fxp0</filename> and <filename>fxp1</filename> as the
	current interfaces, enable <acronym>STP</acronym> with:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig bridge0 stp fxp0 stp fxp1</userinput>
bridge0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        ether d6:cf:d5:a0:94:6d
        id 00:01:02:4b:d4:50 priority 32768 hellotime 2 fwddelay 15
        maxage 20 holdcnt 6 proto rstp maxaddr 100 timeout 1200
        root id 00:01:02:4b:d4:50 priority 32768 ifcost 0 port 0
        member: fxp0 flags=1c7&lt;LEARNING,DISCOVER,STP,AUTOEDGE,PTP,AUTOPTP&gt;
                port 3 priority 128 path cost 200000 proto rstp
                role designated state forwarding
        member: fxp1 flags=1c7&lt;LEARNING,DISCOVER,STP,AUTOEDGE,PTP,AUTOPTP&gt;
                port 4 priority 128 path cost 200000 proto rstp
                role designated state forwarding</screen>

      <para xml:lang="en">This bridge has a spanning tree ID of
	<literal>00:01:02:4b:d4:50</literal> and a priority of
	<literal>32768</literal>.  As the <literal>root id</literal>
	is the same, it indicates that this is the root bridge for the
	tree.</para>

      <para xml:lang="en">Another bridge on the network also has
	<acronym>STP</acronym> enabled:</para>

      <screen xml:lang="en">bridge0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        ether 96:3d:4b:f1:79:7a
        id 00:13:d4:9a:06:7a priority 32768 hellotime 2 fwddelay 15
        maxage 20 holdcnt 6 proto rstp maxaddr 100 timeout 1200
        root id 00:01:02:4b:d4:50 priority 32768 ifcost 400000 port 4
        member: fxp0 flags=1c7&lt;LEARNING,DISCOVER,STP,AUTOEDGE,PTP,AUTOPTP&gt;
                port 4 priority 128 path cost 200000 proto rstp
                role root state forwarding
        member: fxp1 flags=1c7&lt;LEARNING,DISCOVER,STP,AUTOEDGE,PTP,AUTOPTP&gt;
                port 5 priority 128 path cost 200000 proto rstp
                role designated state forwarding</screen>

      <para xml:lang="en">The line <literal>root id 00:01:02:4b:d4:50 priority 32768
	  ifcost 400000 port 4</literal> shows that the root bridge is
	<literal>00:01:02:4b:d4:50</literal> and has a path cost of
	<literal>400000</literal> from this bridge.  The path to the
	root bridge is via <literal>port 4</literal> which is
	<filename>fxp0</filename>.</para>
    </sect2>

    <sect2>
      <title>橋接介面參數</title>

      <para xml:lang="en">Several <command>ifconfig</command> parameters are unique
	to bridge interfaces.  This section summarizes some common
	uses for these parameters.  The complete list of available
	parameters is described in <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">private</term>
	  <listitem>
	    <para xml:lang="en">A private interface does not forward any traffic to
	      any other port that is also designated as a private
	      interface.  The traffic is blocked unconditionally so no
	      Ethernet frames will be forwarded, including
	      <acronym>ARP</acronym> packets.  If traffic needs to be
	      selectively blocked, a firewall should be used
	      instead.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">span</term>
	  <listitem>
	    <para xml:lang="en">A span port transmits a copy of every Ethernet frame
	      received by the bridge.  The number of span ports
	      configured on a bridge is unlimited, but if an
	      interface is designated as a span port, it cannot also
	      be used as a regular bridge port.  This is most useful
	      for snooping a bridged network passively on another host
	      connected to one of the span ports of the bridge.  For
	      example, to send a copy of all frames out the interface
	      named <filename>fxp4</filename>:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig bridge0 span fxp4</userinput></screen>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">sticky</term>
	  <listitem>
	    <para xml:lang="en">If a bridge member interface is marked as sticky,
	      dynamically learned address entries are treated as
	      static entries in the forwarding cache.  Sticky entries
	      are never aged out of the cache or replaced, even if the
	      address is seen on a different interface.  This gives
	      the benefit of static address entries without the need
	      to pre-populate the forwarding table.  Clients learned
	      on a particular segment of the bridge cannot roam to
	      another segment.</para>

	    <para xml:lang="en">An example of using sticky addresses is to combine
	      the bridge with <acronym>VLAN</acronym>s in order to
	      isolate customer networks without wasting
	      <acronym>IP</acronym> address space.  Consider that
	      <systemitem class="fqdomainname">CustomerA</systemitem>
	      is on <literal>vlan100</literal>, <systemitem class="fqdomainname">CustomerB</systemitem> is on
	      <literal>vlan101</literal>, and the bridge has the
	      address <systemitem class="ipaddress">192.168.0.1</systemitem>:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig bridge0 addm vlan100 sticky vlan100 addm vlan101 sticky vlan101</userinput>
<prompt>#</prompt> <userinput>ifconfig bridge0 inet 192.168.0.1/24</userinput></screen>

	    <para xml:lang="en">In this example, both clients see <systemitem class="ipaddress">192.168.0.1</systemitem> as their
	      default gateway.  Since the bridge cache is sticky, one
	      host cannot spoof the <acronym>MAC</acronym> address of
	      the other customer in order to intercept their
	      traffic.</para>

	    <para xml:lang="en">Any communication between the
	      <acronym>VLAN</acronym>s can be blocked using a firewall
	      or, as seen in this example, private interfaces:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig bridge0 private vlan100 private vlan101</userinput></screen>

	    <para xml:lang="en">The customers are completely isolated from each
	      other and the full <systemitem class="netmask">/24</systemitem> address range can be
	      allocated without subnetting.</para>

	    <para xml:lang="en">The number of unique source <acronym>MAC</acronym>
	      addresses behind an interface can be limited.  Once the
	      limit is reached, packets with unknown source addresses
	      are dropped until an existing host cache entry expires
	      or is removed.</para>

	    <para xml:lang="en">The following example sets the maximum number of
	      Ethernet devices for <systemitem class="fqdomainname">CustomerA</systemitem> on
	      <literal>vlan100</literal> to 10:</para>

	    <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig bridge0 ifmaxaddr vlan100 10</userinput></screen>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para xml:lang="en">Bridge interfaces also support monitor mode, where the
	packets are discarded after <citerefentry><refentrytitle>bpf</refentrytitle><manvolnum>4</manvolnum></citerefentry> processing and are not
	processed or forwarded further.  This can be used to
	multiplex the input of two or more interfaces into a single
	<citerefentry><refentrytitle>bpf</refentrytitle><manvolnum>4</manvolnum></citerefentry> stream.  This is useful for reconstructing the
	traffic for network taps that transmit the RX/TX signals out
	through two separate interfaces.  For example, to read the
	input from four network interfaces as one stream:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig bridge0 addm fxp0 addm fxp1 addm fxp2 addm fxp3 monitor up</userinput>
<prompt>#</prompt> <userinput>tcpdump -i bridge0</userinput></screen>
    </sect2>

    <sect2>
      <title><acronym>SNMP</acronym> 監視</title>

      <para xml:lang="en">The bridge interface and <acronym>STP</acronym>
	parameters can be monitored via <citerefentry><refentrytitle>bsnmpd</refentrytitle><manvolnum>1</manvolnum></citerefentry> which is
	included in the FreeBSD base system.  The exported bridge
	<acronym>MIB</acronym>s conform to <acronym>IETF</acronym>
	standards so any <acronym>SNMP</acronym> client or monitoring
	package can be used to retrieve the data.</para>

      <para xml:lang="en">To enable monitoring on the bridge, uncomment this line in
	<filename>/etc/snmpd.config</filename> by removing the
	beginning <literal>#</literal> symbol:</para>

      <programlisting xml:lang="en">begemotSnmpdModulePath."bridge" = "/usr/lib/snmp_bridge.so"</programlisting>

      <para xml:lang="en">Other configuration settings, such as community names and
	access lists, may need to be modified in this file.  See
	<citerefentry><refentrytitle>bsnmpd</refentrytitle><manvolnum>1</manvolnum></citerefentry> and <citerefentry><refentrytitle>snmp_bridge</refentrytitle><manvolnum>3</manvolnum></citerefentry> for more information.
	Once these edits are saved, add this line to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">bsnmpd_enable="YES"</programlisting>

      <para xml:lang="en">Then, start  <citerefentry><refentrytitle>bsnmpd</refentrytitle><manvolnum>1</manvolnum></citerefentry>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service bsnmpd start</userinput></screen>

      <para xml:lang="en">The following examples use the
	<application>Net-SNMP</application> software
	(<package>net-mgmt/net-snmp</package>) to query a bridge
	from a client system.  The
	<package>net-mgmt/bsnmptools</package> port can also be used.
	From the <acronym>SNMP</acronym> client which is running
	<application>Net-SNMP</application>, add the following lines
	to <filename>$HOME/.snmp/snmp.conf</filename> in order to
	import the bridge <acronym>MIB</acronym> definitions:</para>

      <programlisting xml:lang="en">mibdirs +/usr/share/snmp/mibs
mibs +BRIDGE-MIB:RSTP-MIB:BEGEMOT-MIB:BEGEMOT-BRIDGE-MIB</programlisting>

      <para xml:lang="en">To monitor a single bridge using the IETF BRIDGE-MIB
	(RFC4188):</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>snmpwalk -v 2c -c public bridge1.example.com mib-2.dot1dBridge</userinput>
BRIDGE-MIB::dot1dBaseBridgeAddress.0 = STRING: 66:fb:9b:6e:5c:44
BRIDGE-MIB::dot1dBaseNumPorts.0 = INTEGER: 1 ports
BRIDGE-MIB::dot1dStpTimeSinceTopologyChange.0 = Timeticks: (189959) 0:31:39.59 centi-seconds
BRIDGE-MIB::dot1dStpTopChanges.0 = Counter32: 2
BRIDGE-MIB::dot1dStpDesignatedRoot.0 = Hex-STRING: 80 00 00 01 02 4B D4 50
...
BRIDGE-MIB::dot1dStpPortState.3 = INTEGER: forwarding(5)
BRIDGE-MIB::dot1dStpPortEnable.3 = INTEGER: enabled(1)
BRIDGE-MIB::dot1dStpPortPathCost.3 = INTEGER: 200000
BRIDGE-MIB::dot1dStpPortDesignatedRoot.3 = Hex-STRING: 80 00 00 01 02 4B D4 50
BRIDGE-MIB::dot1dStpPortDesignatedCost.3 = INTEGER: 0
BRIDGE-MIB::dot1dStpPortDesignatedBridge.3 = Hex-STRING: 80 00 00 01 02 4B D4 50
BRIDGE-MIB::dot1dStpPortDesignatedPort.3 = Hex-STRING: 03 80
BRIDGE-MIB::dot1dStpPortForwardTransitions.3 = Counter32: 1
RSTP-MIB::dot1dStpVersion.0 = INTEGER: rstp(2)</screen>

      <para xml:lang="en">The <literal>dot1dStpTopChanges.0</literal> value is two,
	indicating that the <acronym>STP</acronym> bridge topology has
	changed twice.  A topology change means that one or more links
	in the network have changed or failed and a new tree has been
	calculated.  The
	<literal>dot1dStpTimeSinceTopologyChange.0</literal> value
	will show when this happened.</para>

      <para xml:lang="en">To monitor multiple bridge interfaces, the private
	BEGEMOT-BRIDGE-MIB can be used:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>snmpwalk -v 2c -c public bridge1.example.com</userinput>
enterprises.fokus.begemot.begemotBridge
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseName."bridge0" = STRING: bridge0
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseName."bridge2" = STRING: bridge2
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseAddress."bridge0" = STRING: e:ce:3b:5a:9e:13
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseAddress."bridge2" = STRING: 12:5e:4d:74:d:fc
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseNumPorts."bridge0" = INTEGER: 1
BEGEMOT-BRIDGE-MIB::begemotBridgeBaseNumPorts."bridge2" = INTEGER: 1
...
BEGEMOT-BRIDGE-MIB::begemotBridgeStpTimeSinceTopologyChange."bridge0" = Timeticks: (116927) 0:19:29.27 centi-seconds
BEGEMOT-BRIDGE-MIB::begemotBridgeStpTimeSinceTopologyChange."bridge2" = Timeticks: (82773) 0:13:47.73 centi-seconds
BEGEMOT-BRIDGE-MIB::begemotBridgeStpTopChanges."bridge0" = Counter32: 1
BEGEMOT-BRIDGE-MIB::begemotBridgeStpTopChanges."bridge2" = Counter32: 1
BEGEMOT-BRIDGE-MIB::begemotBridgeStpDesignatedRoot."bridge0" = Hex-STRING: 80 00 00 40 95 30 5E 31
BEGEMOT-BRIDGE-MIB::begemotBridgeStpDesignatedRoot."bridge2" = Hex-STRING: 80 00 00 50 8B B8 C6 A9</screen>

      <para xml:lang="en">To change the bridge interface being monitored via the
	<literal>mib-2.dot1dBridge</literal> subtree:</para>

      <screen xml:lang="en"><prompt>%</prompt> <userinput>snmpset -v 2c -c private bridge1.example.com</userinput>
BEGEMOT-BRIDGE-MIB::begemotBridgeDefaultBridgeIf.0 s bridge2</screen>
    </sect2>
  </sect1>

  <sect1 xml:id="network-aggregation">
    <info>
      <title>Link Aggregation 與容錯移轉</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Andrew</firstname>
	    <surname>Thompson</surname>
	  </personname>
	  <contrib>Written by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary>lagg</primary>
    </indexterm>
    <indexterm><primary>容錯移轉</primary></indexterm>
    <indexterm xml:lang="en">
      <primary><acronym>FEC</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary><acronym>LACP</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>loadbalance</primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>roundrobin</primary>
    </indexterm>

    <para xml:lang="en">FreeBSD provides the <citerefentry><refentrytitle>lagg</refentrytitle><manvolnum>4</manvolnum></citerefentry> interface which can be used
      to aggregate multiple network interfaces into one virtual
      interface in order to provide failover and link aggregation.
      Failover allows traffic to continue to flow as long as at least
      one aggregated network interface has an established link.  Link
      aggregation works best on switches which support
      <acronym>LACP</acronym>, as this protocol distributes traffic
      bi-directionally while responding to the failure of individual
      links.</para>

    <para xml:lang="en">The aggregation protocols supported by the lagg interface
      determine which ports are used for outgoing traffic and whether
      or not a specific port accepts incoming traffic.  The following
      protocols are supported by <citerefentry><refentrytitle>lagg</refentrytitle><manvolnum>4</manvolnum></citerefentry>:</para>

    <variablelist>
      <varlistentry>
	<term xml:lang="en">failover</term>
	<listitem>
	  <para xml:lang="en">This mode sends and receives traffic only through
	    the master port.  If the master port becomes
	    unavailable, the next active port is used.  The first
	    interface added to the virtual interface is the master
	    port and all subsequently added interfaces are used as
	    failover devices.  If failover to a non-master port
	    occurs, the original port becomes master once it
	    becomes available again.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">fec / loadbalance</term>
	<listitem>
	  <para xml:lang="en"><trademark class="registered">Cisco</trademark> Fast <trademark class="registered">EtherChannel</trademark> (<acronym>FEC</acronym>)
	    is found on older <trademark class="registered">Cisco</trademark> switches.  It provides a
	    static setup and does not negotiate aggregation with the
	    peer or exchange frames to monitor the link.  If the
	    switch supports <acronym>LACP</acronym>, that should be
	    used instead.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en"><acronym>lacp</acronym></term>
	<listitem>
	  <para xml:lang="en">The <trademark class="registered">IEEE</trademark> 802.3ad Link Aggregation Control Protocol
	    (<acronym>LACP</acronym>) negotiates a set of
	    aggregable links with the peer into one or more Link
	    Aggregated Groups (<acronym>LAG</acronym>s).  Each
	    <acronym>LAG</acronym> is composed of ports of the same
	    speed, set to full-duplex operation, and traffic is
	    balanced across the ports in the
	    <acronym>LAG</acronym> with the greatest total speed.
	    Typically, there is only one <acronym>LAG</acronym>
	    which contains all the ports.  In the event of changes
	    in physical connectivity,
	    <acronym>LACP</acronym> will quickly converge to a new
	    configuration.</para>

	  <para xml:lang="en"><acronym>LACP</acronym> balances outgoing traffic
	    across the active ports based on hashed protocol header
	    information and accepts incoming traffic from any active
	    port.  The hash includes the Ethernet source and
	    destination address and, if available, the
	    <acronym>VLAN</acronym> tag, and the
	    <acronym>IPv4</acronym> or <acronym>IPv6</acronym>
	    source and destination address.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term xml:lang="en">roundrobin</term>
	<listitem>
	  <para xml:lang="en">This mode distributes outgoing traffic using a
	    round-robin scheduler through all active ports and
	    accepts incoming traffic from any active port.  Since
	    this mode violates Ethernet frame ordering, it should be
	    used with caution.</para>
	</listitem>
      </varlistentry>
    </variablelist>

    <sect2>
      <title>設定範例</title>

      <para xml:lang="en">This section demonstrates how to configure a <trademark class="registered">Cisco</trademark>
	switch and a FreeBSD system for <acronym>LACP</acronym> load
	balancing.  It then shows how to configure two Ethernet
	interfaces in failover mode as well as how to configure
	failover mode between an Ethernet and a wireless
	interface.</para>

      <example xml:id="networking-lacp-aggregation-cisco">
	<title><trademark class="registered">Cisco</trademark> 交換器上設定 <acronym>LACP</acronym> Aggregation</title>

	<para xml:lang="en">This example connects two <citerefentry><refentrytitle>fxp</refentrytitle><manvolnum>4</manvolnum></citerefentry> Ethernet
	  interfaces on a FreeBSD machine to the first two Ethernet ports
	  on a <trademark class="registered">Cisco</trademark> switch as a single load balanced and fault
	  tolerant link.  More interfaces can be added to increase
	  throughput and fault tolerance.  Replace the names of the
	  <trademark class="registered">Cisco</trademark> ports, Ethernet devices, channel group number, and
	  <acronym>IP</acronym> address shown in the example to match
	  the local configuration.</para>

	<para xml:lang="en">Frame ordering is mandatory on Ethernet links and any
	  traffic between two stations always flows over the same
	  physical link, limiting the maximum speed to that of one
	  interface.  The transmit algorithm attempts to use as much
	  information as it can to distinguish different traffic flows
	  and balance the flows across the available
	  interfaces.</para>

	<para xml:lang="en">On the <trademark class="registered">Cisco</trademark> switch, add the
	  <replaceable>FastEthernet0/1</replaceable> and
	  <replaceable>FastEthernet0/2</replaceable> interfaces to
	  channel group <replaceable>1</replaceable>:</para>

	<screen xml:lang="en"><userinput>interface <replaceable>FastEthernet0/1</replaceable>
 channel-group <replaceable>1</replaceable> mode active
 channel-protocol lacp</userinput>
!
<userinput>interface <replaceable>FastEthernet0/2</replaceable>
 channel-group <replaceable>1</replaceable> mode active
 channel-protocol lacp</userinput></screen>

	<para xml:lang="en">On the FreeBSD system, create the <citerefentry><refentrytitle>lagg</refentrytitle><manvolnum>4</manvolnum></citerefentry> interface
	  using the physical interfaces
	  <replaceable>fxp0</replaceable> and
	  <replaceable>fxp1</replaceable> and bring the interfaces up
	  with an <acronym>IP</acronym> address of
	  <replaceable>10.0.0.3/24</replaceable>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>fxp0</replaceable> up</userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>fxp1</replaceable> up</userinput>
<prompt>#</prompt> <userinput>ifconfig <literal>lagg<replaceable>0</replaceable></literal> create </userinput>
<prompt>#</prompt> <userinput>ifconfig <literal>lagg<replaceable>0</replaceable></literal> up laggproto lacp laggport <replaceable>fxp0</replaceable> laggport <replaceable>fxp1</replaceable> <replaceable>10.0.0.3/24</replaceable></userinput></screen>

	<para xml:lang="en">Next, verify the status of the virtual interface:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <literal>lagg<replaceable>0</replaceable></literal></userinput>
lagg0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=8&lt;VLAN_MTU&gt;
        ether 00:05:5d:71:8d:b8
        inet 10.0.0.3 netmask 0xffffff00 broadcast 10.0.0.255
        media: Ethernet autoselect
        status: active
        laggproto lacp
        laggport: fxp1 flags=1c&lt;ACTIVE,COLLECTING,DISTRIBUTING&gt;
        laggport: fxp0 flags=1c&lt;ACTIVE,COLLECTING,DISTRIBUTING&gt;</screen>

	<para xml:lang="en">Ports
	  marked as <literal>ACTIVE</literal> are part of the
	  <acronym>LAG</acronym> that has been negotiated with the
	  remote switch.  Traffic will be transmitted and received
	  through these active ports.  Add <option>-v</option> to the
	  above command to view the <acronym>LAG</acronym>
	  identifiers.</para>

	<para xml:lang="en">To see the port status on the <trademark class="registered">Cisco</trademark> switch:</para>

	<screen xml:lang="en">switch# <userinput>show lacp neighbor</userinput>
Flags:  S - Device is requesting Slow LACPDUs
        F - Device is requesting Fast LACPDUs
        A - Device is in Active mode       P - Device is in Passive mode

Channel group 1 neighbors

Partner's information:

                  LACP port                        Oper    Port     Port
Port      Flags   Priority  Dev ID         Age     Key     Number   State
Fa0/1     SA      32768     0005.5d71.8db8  29s    0x146   0x3      0x3D
Fa0/2     SA      32768     0005.5d71.8db8  29s    0x146   0x4      0x3D</screen>

	<para xml:lang="en">For more detail, type <userinput>show lacp neighbor
	  detail</userinput>.</para>

	<para xml:lang="en">To retain this configuration across reboots, add the
	  following entries to
	  <filename>/etc/rc.conf</filename> on the FreeBSD system:</para>

	<programlisting xml:lang="en">ifconfig_<replaceable>fxp0</replaceable>="up"
ifconfig_<replaceable>fxp1</replaceable>="up"
cloned_interfaces="<literal>lagg<replaceable>0</replaceable></literal>"
ifconfig_<literal>lagg<replaceable>0</replaceable></literal>="laggproto lacp laggport <replaceable>fxp0</replaceable> laggport <replaceable>fxp1</replaceable> <replaceable>10.0.0.3/24</replaceable>"</programlisting>
      </example>

      <example xml:id="networking-lagg-failover">
	<title>容錯移轉模式</title>

	<para xml:lang="en">Failover mode can be used to switch over to a secondary
	  interface if the link is lost on the master interface.  To
	  configure failover, make sure that the underlying physical
	  interfaces are up, then create the <citerefentry><refentrytitle>lagg</refentrytitle><manvolnum>4</manvolnum></citerefentry> interface.
	  In this example, <replaceable>fxp0</replaceable> is the
	  master interface, <replaceable>fxp1</replaceable> is the
	  secondary interface, and the virtual interface is assigned
	  an <acronym>IP</acronym> address of
	  <replaceable>10.0.0.15/24</replaceable>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>fxp0</replaceable> up</userinput>
<prompt>#</prompt> <userinput>ifconfig <replaceable>fxp1</replaceable> up</userinput>
<prompt>#</prompt> <userinput>ifconfig <literal>lagg<replaceable>0</replaceable></literal> create</userinput>
<prompt>#</prompt> <userinput>ifconfig <literal>lagg<replaceable>0</replaceable></literal> up laggproto failover laggport <replaceable>fxp0</replaceable> laggport <replaceable>fxp1</replaceable> <replaceable>10.0.0.15/24</replaceable></userinput></screen>

	<para xml:lang="en">The virtual interface should look something like
	  this:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <literal>lagg<replaceable>0</replaceable></literal></userinput>
lagg0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=8&lt;VLAN_MTU&gt;
        ether 00:05:5d:71:8d:b8
        inet 10.0.0.15 netmask 0xffffff00 broadcast 10.0.0.255
        media: Ethernet autoselect
        status: active
        laggproto failover
        laggport: fxp1 flags=0&lt;&gt;
        laggport: fxp0 flags=5&lt;MASTER,ACTIVE&gt;</screen>

	<para xml:lang="en">Traffic will be transmitted and received on
	  <replaceable>fxp0</replaceable>.  If the link is lost on
	  <replaceable>fxp0</replaceable>,
	  <replaceable>fxp1</replaceable> will become the active link.
	  If the link is restored on the master interface, it will
	  once again become the active link.</para>

	<para xml:lang="en">To retain this configuration across reboots, add the
	  following entries to
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">ifconfig_<replaceable>fxp0</replaceable>="up"
ifconfig_<replaceable>fxp1</replaceable>="up"
cloned_interfaces="<literal>lagg<replaceable>0</replaceable></literal>"
ifconfig_<literal>lagg<replaceable>0</replaceable></literal>="laggproto failover laggport <replaceable>fxp0</replaceable> laggport <replaceable>fxp1</replaceable> <replaceable>10.0.0.15/24</replaceable>"</programlisting>
      </example>

      <example xml:id="networking-lagg-wired-and-wireless">
	<title>乙太網路與無線介面間的容錯移轉模式</title>

	<para xml:lang="en">For laptop users, it is usually desirable to configure
	  the wireless device as a secondary which is only used when
	  the Ethernet connection is not available.  With
	  <citerefentry><refentrytitle>lagg</refentrytitle><manvolnum>4</manvolnum></citerefentry>, it is possible to configure a failover which
	  prefers the Ethernet connection for both performance and
	  security reasons, while maintaining the ability to transfer
	  data over the wireless connection.</para>

	<para xml:lang="en">This is achieved by overriding the physical wireless
	  interface's <acronym>MAC</acronym> address with that of the
	  Ethernet interface.</para>

	<para xml:lang="en">In this example, the Ethernet interface,
	  <replaceable>bge0</replaceable>, is the master and the
	  wireless interface, <replaceable>wlan0</replaceable>, is
	  the failover.  The <replaceable>wlan0</replaceable> device
	  was created from <replaceable>iwn0</replaceable> wireless
	  interface, which will be configured with the
	  <acronym>MAC</acronym> address of the Ethernet interface.
	  First, determine the <acronym>MAC</acronym> address of the
	  Ethernet interface:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>bge0</replaceable></userinput>
bge0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
	options=19b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,TSO4&gt;
	ether 00:21:70:da:ae:37
	inet6 fe80::221:70ff:feda:ae37%bge0 prefixlen 64 scopeid 0x2
	nd6 options=29&lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&gt;
	media: Ethernet autoselect (1000baseT &lt;full-duplex&gt;)
	status: active</screen>

	<para xml:lang="en">Replace <replaceable>bge0</replaceable> to match the
	  system's Ethernet interface name.  The
	  <literal>ether</literal> line will contain the
	  <acronym>MAC</acronym> address of the specified interface.
	  Now, change the <acronym>MAC</acronym> address of the
	  underlying wireless interface:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>iwn0</replaceable> ether <replaceable>00:21:70:da:ae:37</replaceable></userinput></screen>

	<para xml:lang="en">Bring the wireless interface up, but do not set an
	  <acronym>IP</acronym> address:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>wlan0</replaceable> create wlandev <replaceable>iwn0</replaceable> ssid <replaceable>my_router</replaceable> up</userinput></screen>

	<para xml:lang="en">Make sure the <replaceable>bge0</replaceable> interface
	  is up, then create the <citerefentry><refentrytitle>lagg</refentrytitle><manvolnum>4</manvolnum></citerefentry> interface with
	  <replaceable>bge0</replaceable> as master with failover to
	  <replaceable>wlan0</replaceable>:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>bge0</replaceable> up</userinput>
<prompt>#</prompt> <userinput>ifconfig <literal>lagg<replaceable>0</replaceable></literal> create</userinput>
<prompt>#</prompt> <userinput>ifconfig <literal>lagg<replaceable>0</replaceable></literal> up laggproto failover laggport <replaceable>bge0</replaceable> laggport <replaceable>wlan0</replaceable></userinput></screen>

	<para xml:lang="en">The virtual interface should look something like
	  this:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <literal>lagg<replaceable>0</replaceable></literal></userinput>
lagg0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric 0 mtu 1500
        options=8&lt;VLAN_MTU&gt;
        ether 00:21:70:da:ae:37
        media: Ethernet autoselect
        status: active
        laggproto failover
        laggport: wlan0 flags=0&lt;&gt;
        laggport: bge0 flags=5&lt;MASTER,ACTIVE&gt;</screen>

	<para xml:lang="en">Then, start the <acronym>DHCP</acronym> client to
	  obtain an <acronym>IP</acronym> address:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>dhclient <literal>lagg<replaceable>0</replaceable></literal></userinput></screen>

	<para xml:lang="en">To retain this configuration across reboots, add the
	  following entries to
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting xml:lang="en">ifconfig_bge0="up"
wlans_<replaceable>iwn0</replaceable>="wlan0"
ifconfig_wlan0="WPA"
create_args_wlan0="<replaceable>wlanaddr 00:21:70:da:ae:37</replaceable>"
cloned_interfaces="<literal>lagg<replaceable>0</replaceable></literal>"
ifconfig_<literal>lagg<replaceable>0</replaceable></literal>="up laggproto failover laggport bge0 laggport wlan0 DHCP"</programlisting>
      </example>
    </sect2>
  </sect1>

  <sect1 xml:id="network-diskless">
    <info>
      <title><acronym>PXE</acronym> 無磁碟作業</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Jean-François</firstname>
	    <surname>Dockès</surname>
	  </personname>
	  <contrib>Updated by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Alex</firstname>
	    <surname>Dupre</surname>
	  </personname>
	  <contrib>Reorganized and enhanced by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm><primary>無磁碟工作站</primary></indexterm>
    <indexterm><primary>無磁碟作業</primary></indexterm>

    <para xml:lang="en">The <trademark class="registered">Intel</trademark> Preboot eXecution Environment
      (<acronym>PXE</acronym>) allows an operating system to boot over
      the network.  For example, a FreeBSD system can boot over the
      network and operate without a local disk, using file systems
      mounted from an <acronym>NFS</acronym> server.
      <acronym>PXE</acronym> support is usually available in the
      <acronym>BIOS</acronym>.  To use <acronym>PXE</acronym> when the
      machine starts, select the <literal>Boot from network</literal>
      option in the <acronym>BIOS</acronym> setup or type a function
      key during system initialization.</para>

    <para xml:lang="en">In order to provide the files needed for an operating system
      to boot over the network, a <acronym>PXE</acronym> setup also
      requires properly configured <acronym>DHCP</acronym>,
      <acronym>TFTP</acronym>, and <acronym>NFS</acronym> servers,
      where:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Initial parameters, such as an <acronym>IP</acronym>
	  address, executable boot filename and location, server name,
	  and root path are obtained from the
	  <acronym>DHCP</acronym> server.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The operating system loader file is booted using
	  <acronym>TFTP</acronym>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The file systems are loaded using
	  <acronym>NFS</acronym>.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">When a computer <acronym>PXE</acronym> boots, it receives
      information over <acronym>DHCP</acronym> about where to obtain
      the initial boot loader file.  After the host computer receives
      this information, it downloads the boot loader via
      <acronym>TFTP</acronym> and then executes the boot loader.  In
      FreeBSD, the boot loader file is
      <filename>/boot/pxeboot</filename>.  After
      <filename>/boot/pxeboot</filename> executes, the FreeBSD kernel is
      loaded and the rest of the FreeBSD bootup sequence proceeds, as
      described in <xref linkend="boot"/>.</para>

    <para xml:lang="en">This section describes how to configure these services on a
      FreeBSD system so that other systems can <acronym>PXE</acronym>
      boot into FreeBSD.  Refer to <citerefentry><refentrytitle>diskless</refentrytitle><manvolnum>8</manvolnum></citerefentry> for more
      information.</para>

    <caution>
      <para xml:lang="en">As described, the system providing these services is
	insecure.  It should live in a protected area of a network and
	be untrusted by other hosts.</para>
    </caution>

    <sect2 xml:id="network-pxe-nfs">
      <info>
	<title>設定 <acronym>PXE</acronym> 環境</title>

	<authorgroup>
	  <author xml:lang="en">
	    <personname>
	      <firstname>Craig</firstname>
	      <surname>Rodrigues</surname>
	    </personname>
	    <affiliation>
	      <address xml:lang="en">rodrigc@FreeBSD.org</address>
	    </affiliation>
	    <contrib>Written by </contrib>
	  </author>
	</authorgroup>
      </info>

      <para xml:lang="en">The steps shown in this section configure the built-in
	<acronym>NFS</acronym> and <acronym>TFTP</acronym> servers.
	The next section demonstrates how to install and configure the
	<acronym>DHCP</acronym> server.  In this example, the
	directory which will contain the files used by
	<acronym>PXE</acronym> users is
	<filename>/b/tftpboot/FreeBSD/install</filename>.  It is
	important that this directory exists and that the same
	directory name is set in both
	<filename>/etc/inetd.conf</filename> and
	<filename>/usr/local/etc/dhcpd.conf</filename>.</para>

      <procedure>
	<step>
	  <para xml:lang="en">Create the root directory which will contain a FreeBSD
	    installation to be <acronym>NFS</acronym> mounted:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>export NFSROOTDIR=/b/tftpboot/FreeBSD/install</userinput>
<prompt>#</prompt> <userinput>mkdir -p ${NFSROOTDIR}</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Enable the <acronym>NFS</acronym> server by adding
	    this line to <filename>/etc/rc.conf</filename>:</para>

	  <programlisting xml:lang="en">nfs_server_enable="YES"</programlisting>
	</step>

	<step>
	  <para xml:lang="en">Export the diskless root directory via
	    <acronym>NFS</acronym> by adding the following to
	    <filename>/etc/exports</filename>:</para>

	  <programlisting xml:lang="en">/b -ro -alldirs -maproot=root</programlisting>
	</step>

	<step>
	  <para xml:lang="en">Start the <acronym>NFS</acronym> server:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>service nfsd start</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Enable <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry> by adding the following line to
	    <filename>/etc/rc.conf</filename>:</para>

	  <programlisting xml:lang="en">inetd_enable="YES"</programlisting>
	</step>

	<step>
	  <para xml:lang="en">Uncomment the following line in
	    <filename>/etc/inetd.conf</filename> by making sure it
	    does not start with a <literal>#</literal> symbol:</para>

	  <programlisting xml:lang="en">tftp dgram udp wait root /usr/libexec/tftpd tftpd -l -s /b/tftpboot</programlisting>

	  <note>
	    <para xml:lang="en">Some <acronym>PXE</acronym> versions require the
	      <acronym>TCP</acronym> version of
	      <acronym>TFTP</acronym>.  In this case, uncomment the
	      second <literal>tftp</literal> line which contains
	      <literal>stream tcp</literal>.</para>
	  </note>
	</step>

	<step>
	  <para xml:lang="en">Start <citerefentry><refentrytitle>inetd</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>service inetd start</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">Install the base system into
		<filename>${NFSROOTDIR}</filename>, either by
		decompressing the official archives or by rebuilding
		the FreeBSD kernel and userland (refer to
		<xref linkend="makeworld"/> for more detailed
		instructions, but do not forget to add
		<option>DESTDIR=<replaceable>${NFSROOTDIR}</replaceable></option>
		when running the
		<command>make installkernel</command> and
		<command>make installworld</command> commands.</para>
	</step>

	<step>
	  <para xml:lang="en">Test that the <acronym>TFTP</acronym> server works and
	    can download the boot loader which will be obtained via
	    <acronym>PXE</acronym>:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>tftp localhost</userinput>
tftp&gt; <userinput>get FreeBSD/install/boot/pxeboot</userinput>
Received 264951 bytes in 0.1 seconds</screen>
	</step>

	<step>
	  <para xml:lang="en">Edit <filename>${NFSROOTDIR}/etc/fstab</filename> and
	    create an entry to mount the root file system over
	    <acronym>NFS</acronym>:</para>

	  <programlisting xml:lang="en"># Device                                         Mountpoint    FSType   Options  Dump Pass
<replaceable>myhost.example.com</replaceable>:/b/tftpboot/FreeBSD/install       /         nfs      ro        0    0</programlisting>

	  <para xml:lang="en">Replace <replaceable>myhost.example.com</replaceable>
	    with the hostname or <acronym>IP</acronym> address of the
	    <acronym>NFS</acronym> server.  In this example, the root
	    file system is mounted read-only in order to prevent
	    <acronym>NFS</acronym> clients from potentially deleting
	    the contents of the root file system.</para>
	</step>

	<step>
	  <para xml:lang="en">Set the root password in the <acronym>PXE</acronym>
	    environment for client machines which are
	    <acronym>PXE</acronym> booting :</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>chroot ${NFSROOTDIR}</userinput>
<prompt>#</prompt> <userinput>passwd</userinput></screen>
	</step>

	<step>
	  <para xml:lang="en">If needed, enable <citerefentry><refentrytitle>ssh</refentrytitle><manvolnum>1</manvolnum></citerefentry> root logins for client
	    machines which are <acronym>PXE</acronym> booting by
	    editing
	    <filename>${NFSROOTDIR}/etc/ssh/sshd_config</filename> and
	    enabling <literal>PermitRootLogin</literal>.  This option
	    is documented in <citerefentry><refentrytitle>sshd_config</refentrytitle><manvolnum>5</manvolnum></citerefentry>.</para>
	</step>

	<step>
	  <para xml:lang="en">Perform any other needed customizations of the
	    <acronym>PXE</acronym> environment in
	    <filename>${NFSROOTDIR}</filename>.  These customizations
	    could include things like installing packages or editing
	    the password file with <citerefentry><refentrytitle>vipw</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
	</step>
      </procedure>

      <para xml:lang="en">When booting from an <acronym>NFS</acronym> root volume,
	<filename>/etc/rc</filename> detects the
	<acronym>NFS</acronym> boot and runs
	<filename>/etc/rc.initdiskless</filename>.  In this case,
	<filename>/etc</filename> and <filename>/var</filename> need
	to be memory backed file systems so that these directories are
	writable but the <acronym>NFS</acronym> root directory is
	read-only:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>chroot ${NFSROOTDIR}</userinput>
<prompt>#</prompt> <userinput>mkdir -p conf/base</userinput>
<prompt>#</prompt> <userinput>tar -c -v -f conf/base/etc.cpio.gz --format cpio --gzip etc</userinput>
<prompt>#</prompt> <userinput>tar -c -v -f conf/base/var.cpio.gz --format cpio --gzip var</userinput></screen>

      <para xml:lang="en">When the system boots, memory file systems for
	<filename>/etc</filename> and <filename>/var</filename> will
	be created and mounted and the contents of the
	<filename>cpio.gz</filename> files will be copied into
	them.  By default, these file systems have a maximum capacity
	of 5 megabytes.  If your archives do not fit, which is
	usually the case for <filename>/var</filename> when binary
	packages have been installed, request a larger size by putting
	the number of 512 byte sectors needed (e.g., 5 megabytes
	is 10240 sectors) in
	<filename>${NFSROOTDIR}/conf/base/etc/md_size</filename> and
	<filename>${NFSROOTDIR}/conf/base/var/md_size</filename>
	files for <filename>/etc</filename> and
	<filename>/var</filename> file systems respectively.</para>
    </sect2>

    <sect2 xml:id="network-pxe-setting-up-dhcp">
      <title>設定 <acronym>DHCP</acronym> 伺服器</title>

      <indexterm xml:lang="en">
	<primary>DHCP</primary>
	<secondary>diskless operation</secondary>
      </indexterm>

      <para xml:lang="en">The <acronym>DHCP</acronym> server does not need to be the
	same machine as the <acronym>TFTP</acronym> and
	<acronym>NFS</acronym> server, but it needs to be accessible
	in the network.</para>

      <para xml:lang="en"><acronym>DHCP</acronym> is not part of the FreeBSD base
	system but can be installed using the
	<package>net/isc-dhcp43-server</package> port or
	package.</para>

      <para xml:lang="en">Once installed, edit the configuration file,
	<filename>/usr/local/etc/dhcpd.conf</filename>.  Configure
	the <literal>next-server</literal>,
	<literal>filename</literal>, and
	<literal>root-path</literal> settings as seen in this
	example:</para>

      <programlisting xml:lang="en">subnet 192.168.0.0 netmask 255.255.255.0 {
   range 192.168.0.2 192.168.0.3 ;
   option subnet-mask 255.255.255.0 ;
   option routers 192.168.0.1 ;
   option broadcast-address 192.168.0.255 ;
   option domain-name-servers 192.168.35.35, 192.168.35.36 ;
   option domain-name "example.com";

   # IP address of TFTP server
   next-server <replaceable>192.168.0.1</replaceable> ;

   # path of boot loader obtained via tftp
   filename "<replaceable>FreeBSD/install/boot/pxeboot</replaceable>" ;

   # pxeboot boot loader will try to NFS mount this directory for root FS
   option root-path "<replaceable>192.168.0.1:/b/tftpboot/FreeBSD/install/</replaceable>" ;

}</programlisting>

<!--
 This option still needed?
 host corbieres {
      <para>This option tells <application>dhcpd</application>
	to send the value in the <literal>host</literal>
	declarations as the hostname for the diskless host.
	An alternate way would be to add an <literal>option
	host-name <replaceable>corbieres</replaceable></literal>
	inside the <literal>host</literal> declarations.</para>
-->

      <para xml:lang="en">The <literal>next-server</literal> directive is used to
	specify the <acronym>IP</acronym> address of the
	<acronym>TFTP</acronym> server.</para>

      <para xml:lang="en">The <literal>filename</literal> directive defines the path
	to <filename>/boot/pxeboot</filename>.  A relative filename is
	used, meaning that <filename>/b/tftpboot</filename> is not
	included in the path.</para>

      <para xml:lang="en">The <literal>root-path</literal> option defines the path
	to the <acronym>NFS</acronym> root file system.</para>

      <para xml:lang="en">Once the edits are saved, enable <acronym>DHCP</acronym>
	at boot time by adding the following line to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">dhcpd_enable="YES"</programlisting>

      <para xml:lang="en">Then start the <acronym>DHCP</acronym> service:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>service isc-dhcpd start</userinput></screen>
    </sect2>
<!--
Are these sections still needed?
    <sect2>
      <title>Preparing the Root File System</title>

      <indexterm>
	<primary>diskless operation</primary>
	<secondary>kernel configuration</secondary>
      </indexterm>

      <para>When using <acronym>PXE</acronym>, building a custom
	kernel with the following options is not strictly necessary.
	These options cause more <acronym>DHCP</acronym> requests
	to be issued during kernel startup, with a small risk of
	inconsistency between the new values and those retrieved
	by &man.pxeboot.8; in some special cases.  The advantage
	is that the host name will be set.  Otherwise, set the
	host name in a client-specific
	<filename>/etc/rc.conf</filename>.</para>

      <programlisting>options     BOOTP          # Use BOOTP to obtain IP address/hostname
options     BOOTP_NFSROOT  # NFS mount root file system using BOOTP info</programlisting>

      <para>The custom kernel can also include
	<literal>BOOTP_NFSV3</literal>,
	<literal>BOOT_COMPAT</literal> and
	<literal>BOOTP_WIRED_TO</literal>.  Refer to
	<filename>NOTES</filename> for descriptions of these
	options.</para>

      <para>These option names are historical and slightly
	misleading as they actually enable indifferent use of
	<acronym>DHCP</acronym> and <acronym>BOOTP</acronym>
	inside the kernel.</para>

      <para>Build the custom kernel, using the instructions in
	<xref linkend="kernelconfig"/>, and copy it to the place
	specified in
	<filename>/usr/local/etc/dhcpd.conf</filename>.</para>

      <indexterm>
	<primary>root file system</primary>
	<secondary>diskless operation</secondary>
      </indexterm>

      <para>Create a root file system for the diskless
	workstations in the location listed as
	<literal>root-path</literal> in
	<filename>/usr/local/etc/dhcpd.conf</filename>.</para>

      <para>Using <command>make world</command> to populate root is
	quick and will install a complete virgin system, not just
	the root file system, into <envar>DESTDIR</envar>.  Execute
	the following script:</para>

      <programlisting>#!/bin/sh
export DESTDIR=/data/misc/diskless
mkdir -p ${DESTDIR}
cd /usr/src; make buildworld &amp;&amp; make buildkernel
make installworld &amp;&amp; make installkernel
cd /usr/src/etc; make distribution</programlisting>

      <para>Once done, customize
	<filename>/etc/rc.conf</filename> and
	<filename>/etc/fstab</filename> placed into
	<envar>DESTDIR</envar> according to the system's
	requirements.</para>
    </sect2>

    <sect2>
      <title>Configuring Swap</title>

      <para>If needed, a swap file located on the server can be
	accessed via <acronym>NFS</acronym>.</para>

      <para>The kernel does not support enabling
	<acronym>NFS</acronym> swap at boot time.  Swap must be
	enabled by the startup scripts, by mounting a writable
	file system and creating and enabling a swap file.  To
	create a swap file:</para>

      <screen>&prompt.root; <userinput>dd if=/dev/zero of=<replaceable>/path/to/swapfile</replaceable> bs=1k count=1 oseek=<replaceable>100000</replaceable></userinput></screen>

      <para>To enable the swap file, add the following line to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting>swapfile=<replaceable>/path/to/swapfile</replaceable></programlisting>
    </sect2>

    <sect2>
      <title>Miscellaneous Issues</title>

      <indexterm>
	<primary>diskless operation</primary>
	<secondary>/usr read-only</secondary>
      </indexterm>

      <para>If the diskless workstation is configured to run
	<application>&xorg;</application> and is running with a
	read-only <filename>/usr</filename>, adjust the
	<application>XDM</application> configuration file as it puts
	the error log on <filename>/usr</filename> by
	default.</para>

      <para>When the server for the root file system is not
	running &os;, create the root file system on a &os;
	machine, then copy it to its destination, using
	&man.tar.1; or &man.cpio.1;.</para>

      <para>In this situation, there are sometimes problems with
	the special files in <filename>/dev</filename>, due to
	differing major/minor integer sizes.  A solution to this
	problem is to export a directory from the non-&os; server,
	mount this directory onto a &os; machine, and use
	&man.devfs.5; to allocate device nodes transparently for
	the user.</para>
    </sect2>
-->

    <sect2>
      <title><acronym>PXE</acronym> 問題除錯</title>

      <para xml:lang="en">Once all of the services are configured and started,
	<acronym>PXE</acronym> clients should be able to
	automatically load FreeBSD over the network.  If a particular
	client is unable to connect, when that client machine boots
	up, enter the <acronym>BIOS</acronym> configuration menu and
	confirm that it is set to boot from the network.</para>

      <para xml:lang="en">This section describes some troubleshooting tips for
	isolating the source of the configuration problem should no
	clients be able to <acronym>PXE</acronym> boot.</para>

      <procedure>
	<step>
	  <para xml:lang="en">Use the <package>net/wireshark</package> package or
	    port to debug the network traffic involved during the
	    <acronym>PXE</acronym> booting process, which is
	    illustrated in the diagram below.</para>

	  <figure>
	    <title>使用 <acronym>NFS</acronym> Root Mount 進行 <acronym>PXE</acronym> 開機程序</title>

	    <mediaobject>
	      <imageobjectco>
		<areaspec units="calspair">
		  <area xml:id="co-pxenfs1" coords="2873,8133 3313,7266"/>
		  <area xml:id="co-pxenfs2" coords="3519,6333 3885,5500"/>
		  <area xml:id="co-pxenfs3" coords="4780,5866 5102,5200"/>
		  <area xml:id="co-pxenfs4" coords="4794,4333 5102,3600"/>
		  <area xml:id="co-pxenfs5" coords="3108,2666 3519,1800"/>
		</areaspec>
		<imageobject>
		  <imagedata fileref="advanced-networking/pxe-nfs"/>
		</imageobject>
		<calloutlist>
		  <callout arearefs="co-pxenfs1">
		    <para xml:lang="en">Client broadcasts a
		      <literal>DHCPDISCOVER</literal> message.</para>
		  </callout>
		  <callout arearefs="co-pxenfs2">
		    <para xml:lang="en">The <acronym>DHCP</acronym> server responds
		      with the <acronym>IP</acronym> address,
		      <literal>next-server</literal>,
		      <literal>filename</literal>, and
		      <literal>root-path</literal> values.</para>
		  </callout>
		  <callout arearefs="co-pxenfs3">
		    <para xml:lang="en">The client sends a <acronym>TFTP</acronym>
		      request to <literal>next-server</literal>,
		      asking to retrieve
		      <literal>filename</literal>.</para>
		  </callout>
		  <callout arearefs="co-pxenfs4">
		    <para xml:lang="en">The <acronym>TFTP</acronym> server responds
		      and sends <literal>filename</literal> to
		      client.</para>
		  </callout>
		  <callout arearefs="co-pxenfs5">
		    <para xml:lang="en">The client executes
		      <literal>filename</literal>, which is
		      <citerefentry><refentrytitle>pxeboot</refentrytitle><manvolnum>8</manvolnum></citerefentry>, which then loads the kernel.
		      When the kernel executes, the root file system
		      specified by <literal>root-path</literal> is
		      mounted over <acronym>NFS</acronym>.</para>
		  </callout>
		</calloutlist>
	      </imageobjectco>
	    </mediaobject>
	  </figure>
	</step>

	<step>
	  <para xml:lang="en">On the
	    <acronym>TFTP</acronym> server, read
	    <filename>/var/log/xferlog</filename> to ensure that
	    <filename>pxeboot</filename> is being retrieved from
	    the correct location.  To test this example
	    configuration:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>tftp 192.168.0.1</userinput>
tftp&gt; <userinput>get FreeBSD/install/boot/pxeboot</userinput>
Received 264951 bytes in 0.1 seconds</screen>

	  <para xml:lang="en">The <literal>BUGS</literal> sections in <citerefentry><refentrytitle>tftpd</refentrytitle><manvolnum>8</manvolnum></citerefentry>
	    and <citerefentry><refentrytitle>tftp</refentrytitle><manvolnum>1</manvolnum></citerefentry> document some limitations with
	    <acronym>TFTP</acronym>.</para>
	</step>

	<step>
	  <para xml:lang="en">Make sure that the root file system can be mounted
	    via <acronym>NFS</acronym>.  To test this example
	    configuration:</para>

	  <screen xml:lang="en"><prompt>#</prompt> <userinput>mount -t nfs 192.168.0.1:/b/tftpboot/FreeBSD/install /mnt</userinput></screen>
	</step>
      </procedure>
    </sect2>
  </sect1>

  <sect1 xml:id="network-ipv6">
    <info>
      <title xml:lang="en"><acronym>IPv6</acronym></title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Aaron</firstname>
	    <surname>Kaplan</surname>
	  </personname>
	  <contrib>Originally Written by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Restructured and Added by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Brad</firstname>
	    <surname>Davis</surname>
	  </personname>
	  <contrib>Extended by </contrib>
	</author>
      </authorgroup>
    </info>

    <para xml:lang="en"><acronym>IPv6</acronym> is the new version of the well known
      <acronym>IP</acronym> protocol, also known as
      <acronym>IPv4</acronym>.  <acronym>IPv6</acronym> provides
      several advantages over <acronym>IPv4</acronym> as well as many
      new features:</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Its 128-bit address space allows for
	  340,282,366,920,938,463,463,374,607,431,768,211,456
	  addresses.  This addresses the <acronym>IPv4</acronym>
	  address shortage and eventual <acronym>IPv4</acronym>
	  address exhaustion.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Routers only store network aggregation addresses in
	  their routing tables, thus reducing the average space of a
	  routing table to 8192 entries.  This addresses the
	  scalability issues associated with <acronym>IPv4</acronym>,
	  which required every allocated block of
	  <acronym>IPv4</acronym> addresses to be exchanged between
	  Internet routers, causing their routing tables to become too
	  large to allow efficient routing.</para>
      </listitem>
    </itemizedlist>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Address autoconfiguration (<link xlink:href="http://www.ietf.org/rfc/rfc2462.txt">RFC2462</link>).</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Mandatory multicast addresses.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Built-in <acronym>IPsec</acronym> (<acronym>IP</acronym>
	  security).</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Simplified header structure.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Support for mobile <acronym>IP</acronym>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><acronym>IPv6</acronym>-to-<acronym>IPv4</acronym>
	  transition mechanisms.</para>
      </listitem>
    </itemizedlist>

    <para xml:lang="en">FreeBSD includes the <link xlink:href="http://www.kame.net/">http://www.kame.net/</link>
      <acronym>IPv6</acronym> reference implementation and comes
      with everything needed to use <acronym>IPv6</acronym>.  This
      section focuses on getting <acronym>IPv6</acronym> configured
      and running.</para>

    <sect2>
      <title><acronym>IPv6</acronym> 位址的背景知識</title>

      <para xml:lang="en">There are three different types of <acronym>IPv6</acronym>
	addresses:</para>

      <variablelist>
	<varlistentry>
	  <term xml:lang="en">Unicast</term>
	  <listitem>
	    <para xml:lang="en">A packet sent to a unicast address arrives at the
	      interface belonging to the address.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">Anycast</term>
	  <listitem>
	    <para xml:lang="en">These addresses are syntactically indistinguishable
	      from unicast addresses but they address a group of
	      interfaces.  The packet destined for an anycast address
	      will arrive at the nearest router interface.  Anycast
	      addresses are only used by routers.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">Multicast</term>
	  <listitem>
	    <para xml:lang="en">These addresses identify a group of interfaces.  A
	      packet destined for a multicast address will arrive at
	      all interfaces belonging to the multicast group.  The
	      <acronym>IPv4</acronym> broadcast address, usually
	      <systemitem class="ipaddress">xxx.xxx.xxx.255</systemitem>, is
	      expressed by multicast addresses in
	      <acronym>IPv6</acronym>.</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para xml:lang="en">When reading an <acronym>IPv6</acronym> address, the
	canonical form is represented as
	<systemitem>x:x:x:x:x:x:x:x</systemitem>, where each
	<literal>x</literal> represents a 16 bit hex value.  An
	example is
	<systemitem>FEBC:A574:382B:23C1:AA49:4592:4EFE:9982</systemitem>.</para>

      <para xml:lang="en">Often, an address will have long substrings of all zeros.
	A <literal>::</literal> (double colon) can be used to replace
	one substring per address.  Also, up to three leading
	<literal>0</literal>s per hex value can be omitted.  For
	example, <systemitem>fe80::1</systemitem> corresponds to the
	canonical form
	<systemitem>fe80:0000:0000:0000:0000:0000:0000:0001</systemitem>.</para>

      <para xml:lang="en">A third form is to write the last 32 bits using the well
	known <acronym>IPv4</acronym> notation.  For example,
	<systemitem>2002::10.0.0.1</systemitem> corresponds to the
	hexadecimal canonical representation
	<systemitem>2002:0000:0000:0000:0000:0000:0a00:0001</systemitem>,
	which in turn is equivalent to
	<systemitem>2002::a00:1</systemitem>.</para>

      <para xml:lang="en">To view a FreeBSD system's <acronym>IPv6 </acronym> address,
	use <citerefentry><refentrytitle>ifconfig</refentrytitle><manvolnum>8</manvolnum></citerefentry>:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig</userinput></screen>

      <programlisting xml:lang="en">rl0: flags=8943&lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&gt; mtu 1500
         inet 10.0.0.10 netmask 0xffffff00 broadcast 10.0.0.255
         inet6 fe80::200:21ff:fe03:8e1%rl0 prefixlen 64 scopeid 0x1
         ether 00:00:21:03:08:e1
         media: Ethernet autoselect (100baseTX )
         status: active</programlisting>

      <para xml:lang="en">In this example, the <filename>rl0</filename> interface is
	using <systemitem>fe80::200:21ff:fe03:8e1%rl0</systemitem>, an
	auto-configured link-local address which was automatically
	generated from the <acronym>MAC</acronym> address.</para>

      <para xml:lang="en">Some <acronym>IPv6</acronym> addresses are reserved.  A
	summary of these reserved addresses is seen in <xref linkend="reservedip6"/>:</para>

      <table xml:id="reservedip6" frame="none">
	<title>已保留的 <acronym>IPv6</acronym> 位址</title>

	<tgroup cols="4">
	  <thead>
	    <row>
	      <entry xml:lang="en"><acronym>IPv6</acronym> address</entry>
	      <entry xml:lang="en">Prefixlength (Bits)</entry>
	      <entry>說明</entry>
	      <entry>說明</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><systemitem>::</systemitem></entry>
	      <entry xml:lang="en">128 bits</entry>
	      <entry xml:lang="en">unspecified</entry>
	      <entry xml:lang="en">Equivalent to <systemitem class="ipaddress">0.0.0.0</systemitem> in
		<acronym>IPv4</acronym>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>::1</systemitem></entry>
	      <entry xml:lang="en">128 bits</entry>
	      <entry xml:lang="en">loopback address</entry>
	      <entry xml:lang="en">Equivalent to <systemitem class="ipaddress">127.0.0.1</systemitem> in
		<acronym>IPv4</acronym>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>::00:xx:xx:xx:xx</systemitem></entry>
	      <entry xml:lang="en">96 bits</entry>
	      <entry xml:lang="en">embedded <acronym>IPv4</acronym></entry>
	      <entry xml:lang="en">The lower 32 bits are the compatible
		<acronym>IPv4</acronym> address.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>::ff:xx:xx:xx:xx</systemitem></entry>
	      <entry xml:lang="en">96 bits</entry>
	      <entry xml:lang="en"><acronym>IPv4</acronym> mapped
		<acronym>IPv6</acronym> address</entry>
	      <entry xml:lang="en">The lower 32 bits are the <acronym>IPv4</acronym>
		address for hosts which do not support
		<acronym>IPv6</acronym>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>fe80::/10</systemitem></entry>
	      <entry xml:lang="en">10 bits</entry>
	      <entry xml:lang="en">link-local</entry>
	      <entry xml:lang="en">Equivalent to 169.254.0.0/16 in
		<acronym>IPv4</acronym>.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>fc00::/7</systemitem></entry>
	      <entry xml:lang="en">7 bits</entry>
	      <entry xml:lang="en">unique-local</entry>
	      <entry xml:lang="en">Unique local addresses are intended for local
		communication and are only routable within a set of
		cooperating sites.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>ff00::</systemitem></entry>
	      <entry xml:lang="en">8 bits</entry>
	      <entry xml:lang="en">multicast</entry>
	      <entry> </entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><systemitem>2000::-3fff:: </systemitem></entry>
	      <entry xml:lang="en">3 bits</entry>
	      <entry xml:lang="en">global unicast</entry>
	      <entry xml:lang="en">All global unicast addresses are assigned from
		this pool.  The first 3 bits are
		<literal>001</literal>.</entry>
	    </row>
	  </tbody>
	</tgroup>
      </table>

      <para xml:lang="en">For further information on the structure of
	<acronym>IPv6</acronym> addresses, refer to <link xlink:href="http://www.ietf.org/rfc/rfc3513.txt">RFC3513</link>.</para>
    </sect2>

    <sect2>
      <title>設定 <acronym>IPv6</acronym></title>

      <para xml:lang="en">To configure a FreeBSD system as an <acronym>IPv6</acronym>
	client, add these two lines to
	<filename>rc.conf</filename>:</para>

      <programlisting xml:lang="en">ifconfig_<replaceable>rl0</replaceable>_ipv6="inet6 accept_rtadv"
rtsold_enable="YES"</programlisting>

      <para xml:lang="en">The first line enables the specified interface to receive
	router advertisement messages.  The second line enables the
	router solicitation daemon, <citerefentry><refentrytitle>rtsol</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>

      <para xml:lang="en">If the interface needs a statically assigned
	<acronym>IPv6</acronym> address, add an entry to specify the
	static address and associated prefix length:</para>

      <programlisting xml:lang="en">ifconfig_<replaceable>rl0</replaceable>_ipv6="inet6 <replaceable>2001:db8:4672:6565:2026:5043:2d42:5344</replaceable> prefixlen <replaceable>64</replaceable>"</programlisting>

      <para xml:lang="en">To assign a default router, specify its address:</para>

      <programlisting xml:lang="en">ipv6_defaultrouter="<replaceable>2001:db8:4672:6565::1</replaceable>"</programlisting>
    </sect2>

    <sect2>
      <title>連線到 Provider</title>

      <para xml:lang="en">In order to connect to other <acronym>IPv6</acronym>
	networks, one must have a provider or a tunnel that supports
	<acronym>IPv6</acronym>:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">Contact an Internet Service Provider to see if they
	    offer <acronym>IPv6</acronym>.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="http://www.tunnelbroker.net">Hurricane
	      Electric</link> offers tunnels with end-points all
	    around the globe.</para>
	</listitem>
      </itemizedlist>

      <note>
	<para xml:lang="en">Install the <package>net/freenet6</package> package or
	  port for a dial-up connection.</para>
      </note>

      <para xml:lang="en">This section demonstrates how to take the directions from
	a tunnel provider and convert them into
	<filename>/etc/rc.conf</filename> settings that will persist
	through reboots.</para>

      <para xml:lang="en">The first <filename>/etc/rc.conf</filename> entry creates
	the generic tunneling interface
	<filename><replaceable>gif0</replaceable></filename>:</para>

      <programlisting xml:lang="en">cloned_interfaces="gif<replaceable>0</replaceable>"</programlisting>

      <para xml:lang="en">Next, configure that interface with the
	<acronym>IPv4</acronym> addresses of the local and remote
	endpoints.  Replace <replaceable>MY_IPv4_ADDR</replaceable>
	and <replaceable>REMOTE_IPv4_ADDR</replaceable> with the
	actual <acronym>IPv4</acronym> addresses:</para>

      <programlisting xml:lang="en">create_args_gif0="tunnel <replaceable>MY_IPv4_ADDR REMOTE_IPv4_ADDR</replaceable>"</programlisting>

      <para xml:lang="en">To apply the <acronym>IPv6</acronym> address that has been
	assigned for use as the <acronym>IPv6</acronym> tunnel
	endpoint, add this line, replacing
	<replaceable>MY_ASSIGNED_IPv6_TUNNEL_ENDPOINT_ADDR</replaceable>
	with the assigned address:</para>

      <programlisting xml:lang="en">ifconfig_gif0_ipv6="inet6 <replaceable>MY_ASSIGNED_IPv6_TUNNEL_ENDPOINT_ADDR</replaceable>"</programlisting>

      <para xml:lang="en">Then, set the default route for the other side of the
	<acronym>IPv6</acronym> tunnel.  Replace
	<replaceable>MY_IPv6_REMOTE_TUNNEL_ENDPOINT_ADDR</replaceable>
	with the default gateway address assigned by the
	provider:</para>

      <programlisting xml:lang="en">ipv6_defaultrouter="<replaceable>MY_IPv6_REMOTE_TUNNEL_ENDPOINT_ADDR</replaceable>"</programlisting>

      <para xml:lang="en">If the FreeBSD system will route <acronym>IPv6</acronym>
	packets between the rest of the network and the world, enable
	the gateway using this line:</para>

      <programlisting xml:lang="en">ipv6_gateway_enable="YES"</programlisting>
    </sect2>

    <sect2>
      <title>Router Advertisement 與 Host Auto Configuration</title>

      <para xml:lang="en">This section demonstrates how to setup <citerefentry><refentrytitle>rtadvd</refentrytitle><manvolnum>8</manvolnum></citerefentry> to
	advertise the <acronym>IPv6</acronym> default route.</para>

      <para xml:lang="en">To enable <citerefentry><refentrytitle>rtadvd</refentrytitle><manvolnum>8</manvolnum></citerefentry>, add the following to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">rtadvd_enable="YES"</programlisting>

      <para xml:lang="en">It is important to specify the interface on which to
	do <acronym>IPv6</acronym> router advertisement.  For example,
	to tell <citerefentry><refentrytitle>rtadvd</refentrytitle><manvolnum>8</manvolnum></citerefentry> to use
	<filename>rl0</filename>:</para>

      <programlisting xml:lang="en">rtadvd_interfaces="rl0"</programlisting>

      <para xml:lang="en">Next, create the configuration file,
	<filename>/etc/rtadvd.conf</filename> as seen in this
	example:</para>

      <programlisting xml:lang="en">rl0:\
	:addrs#1:addr="2001:db8:1f11:246::":prefixlen#64:tc=ether:</programlisting>

      <para xml:lang="en">Replace <filename>rl0</filename> with the interface
	to be used and <systemitem>2001:db8:1f11:246::</systemitem>
	with the prefix of the allocation.</para>

      <para xml:lang="en">For a dedicated <systemitem class="netmask">/64</systemitem> subnet, nothing else needs
	to be changed.  Otherwise, change the
	<literal>prefixlen#</literal> to the correct value.</para>
    </sect2>

    <sect2>
      <title><acronym>IPv6</acronym> 與 <acronym>IPv6</acronym> 位址對應表</title>

      <para xml:lang="en">When <acronym>IPv6</acronym> is enabled on a server, there
	may be a need to enable <acronym>IPv4</acronym> mapped
	<acronym>IPv6</acronym> address communication.  This
	compatibility option allows for <acronym>IPv4</acronym>
	addresses to be represented as <acronym>IPv6</acronym>
	addresses.  Permitting <acronym>IPv6</acronym> applications
	to communicate with <acronym>IPv4</acronym> and vice versa
	may be a security issue.</para>

      <para xml:lang="en">This option may not be required in most cases and is
	available only for compatibility.  This option will allow
	<acronym>IPv6</acronym>-only applications to work with
	<acronym>IPv4</acronym> in a dual stack environment.  This
	is most useful for third party applications which may not
	support an <acronym>IPv6</acronym>-only environment.  To
	enable this feature,
	add the following to <filename>/etc/rc.conf</filename>:</para>

      <programlisting xml:lang="en">ipv6_ipv4mapping="YES"</programlisting>

      <para xml:lang="en">Reviewing the information in <acronym>RFC</acronym> 3493,
	section 3.6 and 3.7 as well as <acronym>RFC</acronym> 4038
	section 4.2 may be useful to some administrators.</para>
    </sect2>
  </sect1>
<!--
  <sect1 xml:id="network-atm">
    <info><title>Asynchronous Transfer Mode (<acronym>ATM</acronym>)</title>
      <authorgroup>
	<author>
	  <personname>
	    <firstname>Harti</firstname>
	    <surname>Brandt</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
    </info>
    <sect2>
      <title>Configuring Classical <acronym>IP</acronym> over
	<acronym>ATM</acronym></title>

      <para>Classical <acronym>IP</acronym> over
	<acronym>ATM</acronym> (<acronym>CLIP</acronym>) is the
	simplest method to use Asynchronous Transfer Mode
	(<acronym>ATM</acronym>) with <acronym>IP</acronym>.  It can
	be used with Switched Virtual Circuits
	(<acronym>SVC</acronym>s) and with Permanent Virtual Circuits
	(<acronym>PVC</acronym>s).  This section describes how to
	set up a network based on <acronym>PVC</acronym>s.</para>

      <sect3>
	<title>Fully Meshed Configurations</title>

	<para>The first method to set up a <acronym>CLIP</acronym>
	  with <acronym>PVC</acronym>s is to connect each machine
	  to each other machine in the network via a dedicated
	  <acronym>PVC</acronym>.  While this is simple to
	  configure, it becomes impractical for a large number of
	  machines.  The following example supposes four machines in
	  the network, each connected to the <acronym role="Asynchronous Transfer Mode">ATM</acronym> network
	  with an <acronym role="Asynchronous Transfer Mode">ATM</acronym> adapter
	  card.  The first step is the planning of the
	  <acronym>IP</acronym> addresses and the <acronym role="Asynchronous Transfer Mode">ATM</acronym>
	  connections between the machines.  This example uses the
	  following:</para>

	<informaltable frame="none" pgwide="1">
	  <tgroup cols="2">
	    <colspec colwidth="1*"/>
	    <colspec colwidth="1*"/>
	    <thead>
	      <row>
		<entry>Host</entry>
		<entry><acronym>IP</acronym> Address</entry>
	      </row>
	    </thead>

	    <tbody>
	      <row>
		<entry><systemitem>hostA</systemitem></entry>
		<entry><systemitem class="ipaddress">192.168.173.1</systemitem></entry>
	      </row>

	      <row>
		<entry><systemitem>hostB</systemitem></entry>
		<entry><systemitem class="ipaddress">192.168.173.2</systemitem></entry>
	      </row>

	      <row>
		<entry><systemitem>hostC</systemitem></entry>
		<entry><systemitem class="ipaddress">192.168.173.3</systemitem></entry>
	      </row>

	      <row>
		<entry><systemitem>hostD</systemitem></entry>
		<entry><systemitem class="ipaddress">192.168.173.4</systemitem></entry>
	      </row>
	    </tbody>
	  </tgroup>
	</informaltable>

	<para>To build a fully meshed net, one <acronym>ATM</acronym>
	  connection is needed between each pair of machines:</para>

	<informaltable frame="none" pgwide="1">
	  <tgroup cols="2">
	    <colspec colwidth="1*"/>
	    <colspec colwidth="1*"/>
	    <thead>
	      <row>
		<entry>Machines</entry>
		<entry>VPI.VCI couple</entry>
	      </row>
	    </thead>

	    <tbody>
	      <row>
		<entry><systemitem>hostA</systemitem> -
		  <systemitem>hostB</systemitem></entry>
		<entry>0.100</entry>
	      </row>

	      <row>
		<entry><systemitem>hostA</systemitem> -
		  <systemitem>hostC</systemitem></entry>
		<entry>0.101</entry>
	      </row>

	      <row>
		<entry><systemitem>hostA</systemitem> -
		  <systemitem>hostD</systemitem></entry>
		<entry>0.102</entry>
	      </row>

	      <row>
		<entry><systemitem>hostB</systemitem> -
		  <systemitem>hostC</systemitem></entry>
		<entry>0.103</entry>
	      </row>

	      <row>
		<entry><systemitem>hostB</systemitem> -
		  <systemitem>hostD</systemitem></entry>
		<entry>0.104</entry>
	      </row>

	      <row>
		<entry><systemitem>hostC</systemitem> -
		  <systemitem>hostD</systemitem></entry>
		<entry>0.105</entry>
	      </row>
	    </tbody>
	  </tgroup>
	</informaltable>

	<para>The Virtual Path Identifier <acronym>VPI</acronym> and
	  Virtual Channel Identifier <acronym>VCI</acronym> values
	  at each end of the connection may differ, but for
	  simplicity, this example assumes they are the same.  Next,
	  configure the <acronym>ATM</acronym> interfaces on each
	  host:</para>

	<screen>hostA&prompt.root; <userinput>ifconfig hatm0 192.168.173.1 up</userinput>
hostB&prompt.root; <userinput>ifconfig hatm0 192.168.173.2 up</userinput>
hostC&prompt.root; <userinput>ifconfig hatm0 192.168.173.3 up</userinput>
hostD&prompt.root; <userinput>ifconfig hatm0 192.168.173.4 up</userinput></screen>

	<para>This example assumes that the <acronym>ATM</acronym>
	  interface is <filename>hatm0</filename> on all hosts.
	  Next, the <acronym>PVC</acronym>s need to be configured on
	  <systemitem>hostA</systemitem>.  This should already be
	  configured on the <acronym>ATM</acronym> switch; consult the
	  manual for the switch on how to do this.</para>

	<screen>hostA&prompt.root; <userinput>atmconfig natm add 192.168.173.2 hatm0 0 100 llc/snap ubr</userinput>
hostA&prompt.root; <userinput>atmconfig natm add 192.168.173.3 hatm0 0 101 llc/snap ubr</userinput>
hostA&prompt.root; <userinput>atmconfig natm add 192.168.173.4 hatm0 0 102 llc/snap ubr</userinput>

hostB&prompt.root; <userinput>atmconfig natm add 192.168.173.1 hatm0 0 100 llc/snap ubr</userinput>
hostB&prompt.root; <userinput>atmconfig natm add 192.168.173.3 hatm0 0 103 llc/snap ubr</userinput>
hostB&prompt.root; <userinput>atmconfig natm add 192.168.173.4 hatm0 0 104 llc/snap ubr</userinput>

hostC&prompt.root; <userinput>atmconfig natm add 192.168.173.1 hatm0 0 101 llc/snap ubr</userinput>
hostC&prompt.root; <userinput>atmconfig natm add 192.168.173.2 hatm0 0 103 llc/snap ubr</userinput>
hostC&prompt.root; <userinput>atmconfig natm add 192.168.173.4 hatm0 0 105 llc/snap ubr</userinput>

hostD&prompt.root; <userinput>atmconfig natm add 192.168.173.1 hatm0 0 102 llc/snap ubr</userinput>
hostD&prompt.root; <userinput>atmconfig natm add 192.168.173.2 hatm0 0 104 llc/snap ubr</userinput>
hostD&prompt.root; <userinput>atmconfig natm add 192.168.173.3 hatm0 0 105 llc/snap ubr</userinput></screen>

	<para>Other traffic contracts besides <literal>ubr</literal>
	  can be used if the <acronym>ATM</acronym> adapter supports
	  it.  In this case, the name of the traffic contract is
	  followed by the parameters of the traffic.  Help for the
	  &man.atmconfig.8; tool can be obtained with:</para>

	<screen>&prompt.root; <userinput>atmconfig help natm add</userinput></screen>

	<para>Refer to &man.atmconfig.8; for more information.</para>

	<para>The same configuration can also be done via
	  <filename>/etc/rc.conf</filename>.  These lines configure
	  <systemitem>hostA</systemitem>:</para>

	<programlisting>network_interfaces="lo0 hatm0"
ifconfig_hatm0="inet 192.168.173.1 up"
natm_static_routes="hostB hostC hostD"
route_hostB="192.168.173.2 hatm0 0 100 llc/snap ubr"
route_hostC="192.168.173.3 hatm0 0 101 llc/snap ubr"
route_hostD="192.168.173.4 hatm0 0 102 llc/snap ubr"</programlisting>

	<para>The current state of all <acronym>CLIP</acronym> routes
	  can be obtained with:</para>

	<screen>hostA&prompt.root; <userinput>atmconfig natm show</userinput></screen>
      </sect3>
    </sect2>
  </sect1>
  -->
  <sect1 xml:id="carp">
    <info>
      <title>共用位址備援協定 (<acronym>CARP</acronym>)</title>

      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Tom</firstname>
	    <surname>Rhodes</surname>
	  </personname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author xml:lang="en">
	  <personname>
	    <firstname>Allan</firstname>
	    <surname>Jude</surname>
	  </personname>
	  <contrib>Updated by </contrib>
	</author>
      </authorgroup>
    </info>

    <indexterm xml:lang="en">
      <primary><acronym>CARP</acronym></primary>
    </indexterm>
    <indexterm xml:lang="en">
      <primary>Common Address Redundancy Protocol</primary>
    </indexterm>

    <para xml:lang="en">The Common Address Redundancy Protocol
      (<acronym>CARP</acronym>) allows multiple hosts to share the
      same <acronym>IP</acronym> address and Virtual Host ID
      (<acronym>VHID</acronym>) in order to provide <firstterm>high
      availability</firstterm> for one or more services.  This means
      that one or more hosts can fail, and the other hosts will
      transparently take over so that users do not see a service
      failure.</para>

    <para xml:lang="en">In addition to the shared <acronym>IP</acronym> address,
      each host has its own <acronym>IP</acronym> address for
      management and configuration.  All of the machines that share an
      <acronym>IP</acronym> address have the same
      <acronym>VHID</acronym>.  The <acronym>VHID</acronym> for each
      virtual <acronym>IP</acronym> address must be unique across the
      broadcast domain of the network interface.</para>

    <para xml:lang="en">High availability using <acronym>CARP</acronym> is built
      into FreeBSD, though the steps to configure it vary slightly
      depending upon the FreeBSD version.  This section provides the same
      example configuration for versions before and equal to or after
      FreeBSD 10.</para>

    <para xml:lang="en">This example configures failover support with three hosts,
      all with unique <acronym>IP</acronym> addresses, but providing
      the same web content.  It has two different masters named
      <systemitem>hosta.example.org</systemitem> and
      <systemitem>hostb.example.org</systemitem>, with a shared backup
      named <systemitem>hostc.example.org</systemitem>.</para>

    <para xml:lang="en">These machines are load balanced with a Round Robin
      <acronym>DNS</acronym> configuration.  The master and backup
      machines are configured identically except for their hostnames
      and management <acronym>IP</acronym> addresses.  These servers
      must have the same configuration and run the same services.
      When the failover occurs, requests to the service on the shared
      <acronym>IP</acronym> address can only be answered correctly if
      the backup server has access to the same content.  The backup
      machine has two additional <acronym>CARP</acronym> interfaces,
      one for each of the master content server's
      <acronym>IP</acronym> addresses.  When a failure occurs, the
      backup server will pick up the failed master machine's
      <acronym>IP</acronym> address.</para>

    <sect2 xml:id="carp-10x">
      <title>使用 <acronym>CARP</acronym> 於 FreeBSD 10 及之後版本</title>

      <para xml:lang="en">Enable boot-time support for <acronym>CARP</acronym> by
	adding an entry for the <filename>carp.ko</filename> kernel
	module in <filename>/boot/loader.conf</filename>:</para>

      <programlisting xml:lang="en">carp_load="YES"</programlisting>

      <para xml:lang="en">To load the module now without rebooting:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload carp</userinput></screen>

      <para xml:lang="en">For users who prefer to use a custom kernel, include the
	following line in the custom kernel configuration file and
	compile the kernel as described in <xref linkend="kernelconfig"/>:</para>

      <programlisting xml:lang="en">device	carp</programlisting>

      <para xml:lang="en">The hostname, management <acronym>IP</acronym> address and
	subnet mask, shared <acronym>IP</acronym> address, and
	<acronym>VHID</acronym> are all set by adding entries to
	<filename>/etc/rc.conf</filename>.  This example is for
	<systemitem>hosta.example.org</systemitem>:</para>

      <programlisting xml:lang="en">hostname="<replaceable>hosta.example.org</replaceable>"
ifconfig_<replaceable>em0</replaceable>="inet <replaceable>192.168.1.3</replaceable> netmask <replaceable>255.255.255.0</replaceable>"
ifconfig_<replaceable>em0</replaceable>_alias0="inet vhid <replaceable>1</replaceable> pass <replaceable>testpass</replaceable> alias <replaceable>192.168.1.50</replaceable>/32"</programlisting>

      <para xml:lang="en">The next set of entries are for
	<systemitem>hostb.example.org</systemitem>.  Since it
	represents a second master, it uses a different shared
	<acronym>IP</acronym> address and <acronym>VHID</acronym>.
	However, the passwords specified with <option>pass</option>
	must be identical as <acronym>CARP</acronym> will only listen
	to and accept advertisements from machines with the correct
	password.</para>

      <programlisting xml:lang="en">hostname="<replaceable>hostb.example.org</replaceable>"
ifconfig_<replaceable>em0</replaceable>="inet <replaceable>192.168.1.4</replaceable> netmask <replaceable>255.255.255.0</replaceable>"
ifconfig_<replaceable>em0</replaceable>_alias0="inet vhid <replaceable>2</replaceable> pass <replaceable>testpass</replaceable> alias <replaceable>192.168.1.51</replaceable>/32"</programlisting>

      <para xml:lang="en">The third machine,
	<systemitem>hostc.example.org</systemitem>, is configured to
	handle failover from either master.  This machine is
	configured with two <acronym>CARP</acronym>
	<acronym>VHID</acronym>s, one to handle the virtual
	<acronym>IP</acronym> address for each of the master hosts.
	The <acronym>CARP</acronym> advertising skew,
	<option>advskew</option>, is set to ensure that the backup
	host advertises later than the master, since
	<option>advskew</option> controls the order of precedence when
	there are multiple backup servers.</para>

      <programlisting xml:lang="en">hostname="hostc.example.org"
ifconfig_<replaceable>em0</replaceable>="inet <replaceable>192.168.1.5</replaceable> netmask <replaceable>255.255.255.0</replaceable>"
ifconfig_<replaceable>em0</replaceable>_alias0="inet vhid <replaceable>1</replaceable> advskew <replaceable>100</replaceable> pass <replaceable>testpass</replaceable> alias <replaceable>192.168.1.50</replaceable>/32"
ifconfig_<replaceable>em0</replaceable>_alias1="inet vhid <replaceable>2</replaceable> advskew <replaceable>100</replaceable> pass <replaceable>testpass</replaceable> alias <replaceable>192.168.1.51</replaceable>/32"</programlisting>

      <para xml:lang="en">Having two <acronym>CARP</acronym>
	<acronym>VHID</acronym>s configured means that
	<systemitem>hostc.example.org</systemitem> will notice if
	either of the master servers becomes unavailable.  If a master
	fails to advertise before the backup server, the backup server
	will pick up the shared <acronym>IP</acronym> address until
	the master becomes available again.</para>

      <note>
	<para xml:lang="en">If the original master server becomes available again,
	  <systemitem>hostc.example.org</systemitem>  will not release
	  the virtual <acronym>IP</acronym> address back to it
	  automatically.  For this to happen, preemption has to be
	  enabled.  The feature is disabled by default,
	  it is controlled via the <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> variable
	  <varname>net.inet.carp.preempt</varname>.  The administrator
	  can force the backup server to return the
	  <acronym>IP</acronym> address to the master:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig em0 vhid 1 state backup</userinput></screen>
      </note>

      <para xml:lang="en">Once the configuration is complete, either restart
	networking or reboot each system.  High availability is now
	enabled.</para>

      <para xml:lang="en"><acronym>CARP</acronym> functionality can be controlled
	via several <citerefentry><refentrytitle>sysctl</refentrytitle><manvolnum>8</manvolnum></citerefentry> variables documented in the
	<citerefentry><refentrytitle>carp</refentrytitle><manvolnum>4</manvolnum></citerefentry> manual pages.  Other actions can be triggered
	from <acronym>CARP</acronym> events by using
	<citerefentry><refentrytitle>devd</refentrytitle><manvolnum>8</manvolnum></citerefentry>.</para>
    </sect2>

    <sect2 xml:id="carp-9x">
      <title>使用 <acronym>CARP</acronym> 於 FreeBSD 9 及先前版本</title>

      <para xml:lang="en">The configuration for these versions of FreeBSD is similar to
	the one described in the previous section, except that a
	<acronym>CARP</acronym> device must first be created and
	referred to in the configuration.</para>

      <para xml:lang="en">Enable boot-time support for <acronym>CARP</acronym> by
	loading the <filename>if_carp.ko</filename> kernel module in
	<filename>/boot/loader.conf</filename>:</para>

      <programlisting xml:lang="en">if_carp_load="YES"</programlisting>

     <para xml:lang="en">To load the module now without rebooting:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>kldload carp</userinput></screen>

      <para xml:lang="en">For users who prefer to use a custom kernel, include the
	following line in the custom kernel configuration file and
	compile the kernel as described in <xref linkend="kernelconfig"/>:</para>

      <programlisting xml:lang="en">device	carp</programlisting>

      <para xml:lang="en">Next, on each host, create a <acronym>CARP</acronym>
	device:</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig carp0 create</userinput></screen>

      <para xml:lang="en">Set the hostname, management <acronym>IP</acronym>
	address, the shared <acronym>IP</acronym> address, and
	<acronym>VHID</acronym> by adding the required lines to
	<filename>/etc/rc.conf</filename>.  Since a virtual
	<acronym>CARP</acronym> device is used instead of an alias,
	the actual subnet mask of <literal>/24</literal> is used
	instead of <literal>/32</literal>.  Here are the entries for
	<systemitem>hosta.example.org</systemitem>:</para>

      <programlisting xml:lang="en">hostname="<replaceable>hosta.example.org</replaceable>"
ifconfig_<replaceable>fxp0</replaceable>="inet <replaceable>192.168.1.3</replaceable> netmask <replaceable>255.255.255.0</replaceable>"
cloned_interfaces="carp0"
ifconfig_carp0="vhid <replaceable>1</replaceable> pass <replaceable>testpass</replaceable> <replaceable>192.168.1.50/24</replaceable>"</programlisting>

      <para xml:lang="en">On <systemitem>hostb.example.org</systemitem>:</para>

      <programlisting xml:lang="en">hostname="<replaceable>hostb.example.org</replaceable>"
ifconfig_<replaceable>fxp0</replaceable>="inet <replaceable>192.168.1.4</replaceable> netmask <replaceable>255.255.255.0</replaceable>"
cloned_interfaces="carp0"
ifconfig_carp0="vhid <replaceable>2</replaceable> pass <replaceable>testpass</replaceable> <replaceable>192.168.1.51/24</replaceable>"</programlisting>

      <para xml:lang="en">The third machine,
	<systemitem>hostc.example.org</systemitem>, is configured to
	handle failover from either of the master hosts:</para>

      <programlisting xml:lang="en">hostname="<replaceable>hostc.example.org</replaceable>"
ifconfig_<replaceable>fxp0</replaceable>="inet <replaceable>192.168.1.5</replaceable> netmask <replaceable>255.255.255.0</replaceable>"
cloned_interfaces="carp0 carp1"
ifconfig_carp0="vhid <replaceable>1</replaceable> advskew <replaceable>100</replaceable> pass <replaceable>testpass</replaceable> <replaceable>192.168.1.50/24</replaceable>"
ifconfig_carp1="vhid <replaceable>2</replaceable> advskew <replaceable>100</replaceable> pass <replaceable>testpass</replaceable> <replaceable>192.168.1.51/24</replaceable>"</programlisting>

      <note>
	<para xml:lang="en">Preemption is disabled in the
	  <filename>GENERIC</filename> FreeBSD kernel.  If
	  preemption has been enabled with a custom kernel,
	  <systemitem>hostc.example.org</systemitem> may not release
	  the <acronym>IP</acronym> address back to the original
	  content server.  The administrator can force the backup
	  server to return the <acronym>IP</acronym> address to the
	  master with the command:</para>

	<screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig carp0 down &amp;&amp; ifconfig carp0 up</userinput></screen>

	<para xml:lang="en">This should be done on the <filename>carp</filename>
	  interface which corresponds to the correct host.</para>
      </note>

      <para xml:lang="en">Once the configuration is complete, either restart
	networking or reboot each system.  High availability is now
	enabled.</para>
    </sect2>
  </sect1>
  <sect1 xml:id="network-vlan">
    <info>
      <title xml:lang="en">VLANs</title>
    </info>

    <indexterm xml:lang="en">
      <primary><acronym>VLANs</acronym></primary>
    </indexterm>
    <indexterm><primary>虛擬 LAN</primary></indexterm>

    <para xml:lang="en"><acronym>VLANs</acronym> are a way of virtually dividing up
      a network into many different subnetworks, also referred
      to as segmenting.  Each segment will have its
      own broadcast domain and be isolated from other
      <acronym>VLANs</acronym>.</para>

    <para>在 FreeBSD 上，要使用 <acronym>VLANs</acronym> 必須有網路卡驅動程式的支援，要查看那些驅動程式支援 vlan，請參考 <citerefentry><refentrytitle>vlan</refentrytitle><manvolnum>4</manvolnum></citerefentry> 操作手冊。</para>

    <para xml:lang="en">When configuring a <acronym>VLAN</acronym>, a couple pieces
      of information must be known.  First, which network interface?
      Second, what is the <acronym>VLAN</acronym> tag?</para>

    <para xml:lang="en">To configure <acronym>VLANs</acronym> at run time, with a
      <acronym>NIC</acronym> of <literal>em0</literal> and a
      <acronym>VLAN</acronym> tag of <systemitem>5</systemitem> the
      command would look like this:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>em0.5</replaceable> create vlan <replaceable>5</replaceable> vlandev <replaceable>em0</replaceable> inet 192.168.20.20/24</userinput></screen>

    <note>
      <para xml:lang="en">See how the interface name includes the
	<acronym>NIC</acronym> driver name and the
	<acronym>VLAN</acronym> tag, separated by a period?  This is a
	best practice to make maintaining the <acronym>VLAN</acronym>
	configuration easy when many <acronym>VLANs</acronym> are
	present on a machine.</para>
    </note>

    <para xml:lang="en">To configure <acronym>VLANs</acronym> at boot time,
      <filename>/etc/rc.conf</filename> must be updated.  To duplicate
      the configuration above, the following will need to be
      added:</para>

    <programlisting xml:lang="en">vlans_<replaceable>em0</replaceable>="<replaceable>5</replaceable>"
ifconfig_<replaceable>em0</replaceable>_<replaceable>5</replaceable>="inet 192.168.20.20/24"</programlisting>

    <para xml:lang="en">Additional <acronym>VLANs</acronym> may be added, by simply
      adding the tag to the
      <literal>vlans_<replaceable>em0</replaceable></literal>
      field and adding an additional line configuring the network on
      that <acronym>VLAN</acronym> tag's interface.</para>

    <para xml:lang="en">It is useful to assign a symbolic name to an interface so
      that when the associated hardware is changed, only a few
      configuration variables need to be updated.  For example,
      security cameras need to be run over VLAN 1 on
      <literal>em0</literal>.  Later, if the <literal>em0</literal>
      card is replaced with a card that uses the <citerefentry><refentrytitle>ixgb</refentrytitle><manvolnum>4</manvolnum></citerefentry> driver,
      all references to <literal>em0.1</literal> will not have to
      change to <literal>ixgb0.1</literal>.</para>

    <para xml:lang="en">To configure <acronym>VLAN</acronym>
      <systemitem>5</systemitem>, on the
      <acronym>NIC</acronym> <literal>em0</literal>, assign the
      interface name <literal>cameras</literal>, and assign the
      interface an IP address of <systemitem class="ipaddress"><replaceable>192.168.20.20</replaceable></systemitem>
      with a <systemitem class="netmask">24</systemitem>-bit prefix,
      use this command:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>em0.5</replaceable> create vlan <replaceable>5</replaceable> vlandev <replaceable>em0</replaceable> name <replaceable>cameras</replaceable> inet <replaceable>192.168.20.20/24</replaceable></userinput></screen>

    <para xml:lang="en">For an interface named <literal>video</literal>, use the
    following:</para>

    <screen xml:lang="en"><prompt>#</prompt> <userinput>ifconfig <replaceable>video.5</replaceable> create vlan <replaceable>5</replaceable> vlandev <replaceable>video</replaceable> name <replaceable>cameras inet 192.168.20.20/24</replaceable></userinput></screen>

  <para xml:lang="en">To apply the changes at boot time, add the following lines to
  <filename>/etc/rc.conf</filename>:</para>

  <programlisting xml:lang="en">vlans_<replaceable>video</replaceable>="<replaceable>camera</replaceable>"
create_args_<replaceable>camera</replaceable>="vlan <replaceable>5</replaceable>"
ifconfig_<replaceable>camera</replaceable>="inet <replaceable>192.168.20.20/24</replaceable>"</programlisting>

  </sect1>
</chapter>

  </part>

  <part xml:id="appendices">
    <title>附錄</title>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<appendix version="5.0" xml:id="mirrors">
  <title>取得 FreeBSD</title>

  <sect1 xml:id="mirrors-cdrom">
    <title><acronym>CD</acronym> 與 <acronym>DVD</acronym> 合集</title>

    <para>FreeBSD <acronym>CD</acronym> 以及 <acronym>DVD</acronym> 組可從以下幾個線上零售商取得：</para>

    <itemizedlist>
      <listitem>
	<address xml:lang="en">FreeBSD Mall, Inc.
	  <street>2420 Sand Creek Rd C-1 #347</street>
	  <city>Brentwood</city>, <state>CA</state>
	  <postcode>94513</postcode>
	  <country>USA</country>
	  Phone: <phone>+1 925 240-6652</phone>
	  Fax: <fax>+1 925 674-0821</fax>
	  Email: <email>info@freebsdmall.com</email>
	  WWW: <otheraddr xlink:href="https://www.freebsdmall.com">https://www.freebsdmall.com</otheraddr>
	</address>
      </listitem>

      <listitem>
	<address xml:lang="en">Getlinux
	  <street>78 Rue de la Croix Rochopt</street>
	  <city>Épinay-sous-Sénart</city>
	  <postcode>91860</postcode>
	  <country>France</country>
	  Email: <email>contact@getlinux.fr</email>
	  WWW: <otheraddr xlink:href="http://www.getlinux.fr">http://www.getlinux.fr/</otheraddr>
	</address>
      </listitem>

      <listitem>
	<address xml:lang="en">Dr. Hinner EDV
	  <street>Kochelseestr. 11</street>
	  <postcode>D-81371</postcode> <city>München</city>
	  <country>Germany</country>
	  Phone: <phone>(0177) 428 419 0</phone>
	  Email: <email>infow@hinner.de</email>
	  WWW: <otheraddr xlink:href="http://www.hinner.de/linux/freebsd.html">http://www.hinner.de/linux/freebsd.html</otheraddr>
	</address>
      </listitem>

      <listitem>
	<address xml:lang="en">Linux Center
	  <street>Galernaya Street, 55</street>
	  <city>Saint-Petersburg</city>
	  <postcode>190000</postcode>
	  <country>Russia</country>
	  Phone: <phone>+7-812-309-06-86</phone>
	  Email: <email>info@linuxcenter.ru</email>
	  WWW: <otheraddr xlink:href="http://linuxcenter.ru/shop/freebsd">http://linuxcenter.ru/shop/freebsd</otheraddr>
	</address>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="mirrors-ftp">
    <title><acronym>FTP</acronym> 站</title>

    <para>FreeBSD 的官方原始碼可從全球任一鏡像站透過匿名 <acronym>FTP</acronym> 取得。其中 <uri xlink:href="ftp://ftp.FreeBSD.org/pub/FreeBSD/">ftp://ftp.FreeBSD.org/pub/FreeBSD/</uri> 站可使用 <acronym>HTTP</acronym> 及 <acronym>FTP</acronym>，該站是由多台由計畫叢集管理員所維護的主機所組成，且在 GeoDNS 之後，可導向使用者到最近可用的鏡像站。</para>

    <para>除此之外，FreeBSD 也可透過匿名 <acronym>FTP</acronym> 從下列鏡像站取得。要透過匿名 <acronym>FTP</acronym> 取得 FreeBSD 時，請先嘗試使用臨近的站台。列在 <quote>主要鏡像站</quote> 中的鏡像站通常會有完整的 FreeBSD 封存檔 (每一個架構目前所有可用的版本)，但若要考慮下載速度，可能要使用您所在國家或區域的站台。區域的站台會有熱門架構最近期的版本，但不會有完整的 FreeBSD 封存檔。所有站台皆提供匿名 <acronym>FTP</acronym> 存取只有部份站台會以其他方式提供存取。每個站台可用的存取方式會列在主機名稱後的括號當中。</para>

    
<para><link linkend="central-ftp">中央伺服器</link>、<link linkend="mirrors-primary-ftp">主要鏡像站</link>、<link linkend="mirrors-am-ftp">亞美尼亞 (Armenia)</link>、<link linkend="mirrors-au-ftp">澳洲 (Australia)</link>、<link linkend="mirrors-at-ftp">奧地利 (Austria)</link>、<link linkend="mirrors-br-ftp">巴西 (Brazil)</link>、<link linkend="mirrors-cz-ftp">捷克 (Czech Republic)</link>、<link linkend="mirrors-dk-ftp">丹麥 (Denmark)</link>、<link linkend="mirrors-ee-ftp">愛沙尼亞 (Estonia)</link>、<link linkend="mirrors-fi-ftp">芬蘭 (Finland)</link>、<link linkend="mirrors-fr-ftp">法國 (France)</link>、<link linkend="mirrors-de-ftp">德國 (Germany)</link>、<link linkend="mirrors-gr-ftp">希臘 (Greece)</link>、<link linkend="mirrors-hk-ftp">香港 (Hong Kong)</link>、<link linkend="mirrors-ie-ftp">愛爾蘭 (Ireland)</link>、<link linkend="mirrors-jp-ftp">日本 (Japan)</link>、<link linkend="mirrors-kr-ftp">韓國 (Korea)</link>、<link linkend="mirrors-lv-ftp">拉脫維亞 (Latvia)</link>、<link linkend="mirrors-lt-ftp">立陶宛 (Lithuania)</link>、<link linkend="mirrors-nl-ftp">荷蘭 (Netherlands)</link>、<link linkend="mirrors-nz-ftp">紐西蘭 (New Zealand)</link>、<link linkend="mirrors-no-ftp">挪威 (Norway)</link>、<link linkend="mirrors-pl-ftp">波蘭 (Poland)</link>、<link linkend="mirrors-ru-ftp">俄羅斯 (Russia)</link>、<link linkend="mirrors-sa-ftp">沙烏地阿拉伯 (Saudi Arabia)</link>、<link linkend="mirrors-si-ftp">斯洛維尼亞 (Slovenia)</link>、<link linkend="mirrors-za-ftp">南非 (South Africa)</link>、<link linkend="mirrors-es-ftp">西班牙 (Spain)</link>、<link linkend="mirrors-se-ftp">瑞典 (Sweden)</link>、<link linkend="mirrors-ch-ftp">瑞士 (Switzerland)</link>、<link linkend="mirrors-tw-ftp">台灣 (Taiwan)</link>、<link linkend="mirrors-ua-ftp">烏克蘭 (Ukraine)</link>、<link linkend="mirrors-uk-ftp">英國 (United Kingdom)</link>、<link linkend="mirrors-us-ftp">美國 (USA)</link>。</para>


    
<para xml:lang="en">(as of   UTC)</para>


    
<variablelist>
  <varlistentry>
    <term><anchor xml:id="central-ftp"/>中央伺服器</term>
    <listitem>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.FreeBSD.org/pub/FreeBSD/">ftp://ftp.FreeBSD.org/pub/FreeBSD/</link> (ftp / ftpv6 / <link xlink:href="http://ftp.FreeBSD.org/pub/FreeBSD/">http://ftp.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp.FreeBSD.org/pub/FreeBSD/">http://ftp.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-primary-ftp"/>主要鏡像站</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>mirror-admin@FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp1.FreeBSD.org/pub/FreeBSD/">ftp://ftp1.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp3.FreeBSD.org/pub/FreeBSD/">ftp://ftp3.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp4.FreeBSD.org/pub/FreeBSD/">ftp://ftp4.FreeBSD.org/pub/FreeBSD/</link> (ftp / ftpv6 / <link xlink:href="http://ftp4.FreeBSD.org/pub/FreeBSD/">http://ftp4.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp4.FreeBSD.org/pub/FreeBSD/">http://ftp4.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp5.FreeBSD.org/pub/FreeBSD/">ftp://ftp5.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp6.FreeBSD.org/pub/FreeBSD/">ftp://ftp6.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp7.FreeBSD.org/pub/FreeBSD/">ftp://ftp7.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp10.FreeBSD.org/pub/FreeBSD/">ftp://ftp10.FreeBSD.org/pub/FreeBSD/</link> (ftp / ftpv6 / <link xlink:href="http://ftp10.FreeBSD.org/pub/FreeBSD/">http://ftp10.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp10.FreeBSD.org/pub/FreeBSD/">http://ftp10.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp11.FreeBSD.org/pub/FreeBSD/">ftp://ftp11.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp13.FreeBSD.org/pub/FreeBSD/">ftp://ftp13.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp14.FreeBSD.org/pub/FreeBSD/">ftp://ftp14.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp14.FreeBSD.org/pub/FreeBSD/">http://ftp14.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-am-ftp"/>亞美尼亞 (Armenia)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@am.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp1.am.FreeBSD.org/pub/FreeBSD/">ftp://ftp1.am.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp1.am.FreeBSD.org/pub/FreeBSD/">http://ftp1.am.FreeBSD.org/pub/FreeBSD/</link> / rsync) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-au-ftp"/>澳洲 (Australia)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@au.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.au.FreeBSD.org/pub/FreeBSD/">ftp://ftp.au.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.au.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.au.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp3.au.FreeBSD.org/pub/FreeBSD/">ftp://ftp3.au.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-at-ftp"/>奧地利 (Austria)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@at.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.at.FreeBSD.org/pub/FreeBSD/">ftp://ftp.at.FreeBSD.org/pub/FreeBSD/</link> (ftp / ftpv6 / <link xlink:href="http://ftp.at.FreeBSD.org/pub/FreeBSD/">http://ftp.at.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp.at.FreeBSD.org/pub/FreeBSD/">http://ftp.at.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-br-ftp"/>巴西 (Brazil)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@br.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.br.FreeBSD.org/FreeBSD/">ftp://ftp2.br.FreeBSD.org/FreeBSD/</link> (ftp / <link xlink:href="http://ftp2.br.FreeBSD.org/">http://ftp2.br.FreeBSD.org/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp3.br.FreeBSD.org/pub/FreeBSD/">ftp://ftp3.br.FreeBSD.org/pub/FreeBSD/</link> (ftp / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp4.br.FreeBSD.org/pub/FreeBSD/">ftp://ftp4.br.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-cz-ftp"/>捷克 (Czech Republic)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@cz.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.cz.FreeBSD.org/pub/FreeBSD/">ftp://ftp.cz.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="ftp://ftp.cz.FreeBSD.org/pub/FreeBSD/">ftp://ftp.cz.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp.cz.FreeBSD.org/pub/FreeBSD/">http://ftp.cz.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp.cz.FreeBSD.org/pub/FreeBSD/">http://ftp.cz.FreeBSD.org/pub/FreeBSD/</link> / rsync / rsyncv6) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.cz.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.cz.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp2.cz.FreeBSD.org/pub/FreeBSD/">http://ftp2.cz.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-dk-ftp"/>丹麥 (Denmark)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@dk.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.dk.FreeBSD.org/pub/FreeBSD/">ftp://ftp.dk.FreeBSD.org/pub/FreeBSD/</link> (ftp / ftpv6 / <link xlink:href="http://ftp.dk.FreeBSD.org/pub/FreeBSD/">http://ftp.dk.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp.dk.FreeBSD.org/pub/FreeBSD/">http://ftp.dk.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-ee-ftp"/>愛沙尼亞 (Estonia)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@ee.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.ee.FreeBSD.org/pub/FreeBSD/">ftp://ftp.ee.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-fi-ftp"/>芬蘭 (Finland)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@fi.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.fi.FreeBSD.org/pub/FreeBSD/">ftp://ftp.fi.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-fr-ftp"/>法國 (France)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@fr.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.fr.FreeBSD.org/pub/FreeBSD/">ftp://ftp.fr.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp1.fr.FreeBSD.org/pub/FreeBSD/">ftp://ftp1.fr.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp1.fr.FreeBSD.org/pub/FreeBSD/">http://ftp1.fr.FreeBSD.org/pub/FreeBSD/</link> / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp3.fr.FreeBSD.org/pub/FreeBSD/">ftp://ftp3.fr.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp5.fr.FreeBSD.org/pub/FreeBSD/">ftp://ftp5.fr.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp6.fr.FreeBSD.org/pub/FreeBSD/">ftp://ftp6.fr.FreeBSD.org/pub/FreeBSD/</link> (ftp / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp7.fr.FreeBSD.org/pub/FreeBSD/">ftp://ftp7.fr.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp8.fr.FreeBSD.org/pub/FreeBSD/">ftp://ftp8.fr.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-de-ftp"/>德國 (Germany)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@de.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.de.FreeBSD.org/pub/FreeBSD/">ftp://ftp.de.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp1.de.FreeBSD.org/freebsd/">ftp://ftp1.de.FreeBSD.org/freebsd/</link> (ftp / <link xlink:href="http://www1.de.FreeBSD.org/freebsd/">http://www1.de.FreeBSD.org/freebsd/</link> / <link xlink:href="rsync://rsync3.de.FreeBSD.org/freebsd/">rsync://rsync3.de.FreeBSD.org/freebsd/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.de.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.de.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp2.de.FreeBSD.org/pub/FreeBSD/">http://ftp2.de.FreeBSD.org/pub/FreeBSD/</link> / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp4.de.FreeBSD.org/FreeBSD/">ftp://ftp4.de.FreeBSD.org/FreeBSD/</link> (ftp / <link xlink:href="http://ftp4.de.FreeBSD.org/pub/FreeBSD/">http://ftp4.de.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp5.de.FreeBSD.org/pub/FreeBSD/">ftp://ftp5.de.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp7.de.FreeBSD.org/pub/FreeBSD/">ftp://ftp7.de.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp7.de.FreeBSD.org/pub/FreeBSD/">http://ftp7.de.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp8.de.FreeBSD.org/pub/FreeBSD/">ftp://ftp8.de.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-gr-ftp"/>希臘 (Greece)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@gr.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.gr.FreeBSD.org/pub/FreeBSD/">ftp://ftp.gr.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.gr.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.gr.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-hk-ftp"/>香港 (Hong Kong)</term>
    <listitem>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.hk.FreeBSD.org/pub/FreeBSD/">ftp://ftp.hk.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-ie-ftp"/>愛爾蘭 (Ireland)</term>
    <listitem>
      <para xml:lang="en">In case of problems, please contact the hostmaster
      <email>hostmaster@ie.FreeBSD.org</email> for this domain.</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp3.ie.FreeBSD.org/pub/FreeBSD/">ftp://ftp3.ie.FreeBSD.org/pub/FreeBSD/</link> (ftp / rsync) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-jp-ftp"/>日本 (Japan)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@jp.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.jp.FreeBSD.org/pub/FreeBSD/">ftp://ftp.jp.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.jp.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.jp.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp3.jp.FreeBSD.org/pub/FreeBSD/">ftp://ftp3.jp.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp4.jp.FreeBSD.org/pub/FreeBSD/">ftp://ftp4.jp.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp5.jp.FreeBSD.org/pub/FreeBSD/">ftp://ftp5.jp.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp6.jp.FreeBSD.org/pub/FreeBSD/">ftp://ftp6.jp.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp7.jp.FreeBSD.org/pub/FreeBSD/">ftp://ftp7.jp.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp8.jp.FreeBSD.org/pub/FreeBSD/">ftp://ftp8.jp.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp9.jp.FreeBSD.org/pub/FreeBSD/">ftp://ftp9.jp.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-kr-ftp"/>韓國 (Korea)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@kr.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.kr.FreeBSD.org/pub/FreeBSD/">ftp://ftp.kr.FreeBSD.org/pub/FreeBSD/</link> (ftp / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.kr.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.kr.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp2.kr.FreeBSD.org/pub/FreeBSD/">http://ftp2.kr.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-lv-ftp"/>拉脫維亞 (Latvia)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@lv.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.lv.FreeBSD.org/pub/FreeBSD/">ftp://ftp.lv.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp.lv.FreeBSD.org/pub/FreeBSD/">http://ftp.lv.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-lt-ftp"/>立陶宛 (Lithuania)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@lt.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.lt.FreeBSD.org/pub/FreeBSD/">ftp://ftp.lt.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp.lt.FreeBSD.org/pub/FreeBSD/">http://ftp.lt.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-nl-ftp"/>荷蘭 (Netherlands)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@nl.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.nl.FreeBSD.org/pub/FreeBSD/">ftp://ftp.nl.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp.nl.FreeBSD.org/os/FreeBSD/">http://ftp.nl.FreeBSD.org/os/FreeBSD/</link> / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.nl.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.nl.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-nz-ftp"/>紐西蘭 (New Zealand)</term>
    <listitem>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.nz.FreeBSD.org/pub/FreeBSD/">ftp://ftp.nz.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp.nz.FreeBSD.org/pub/FreeBSD/">http://ftp.nz.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-no-ftp"/>挪威 (Norway)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@no.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.no.FreeBSD.org/pub/FreeBSD/">ftp://ftp.no.FreeBSD.org/pub/FreeBSD/</link> (ftp / rsync) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-pl-ftp"/>波蘭 (Poland)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@pl.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.pl.FreeBSD.org/pub/FreeBSD/">ftp://ftp.pl.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en">ftp2.pl.FreeBSD.org</para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-ru-ftp"/>俄羅斯 (Russia)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@ru.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.ru.FreeBSD.org/pub/FreeBSD/">ftp://ftp.ru.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp.ru.FreeBSD.org/FreeBSD/">http://ftp.ru.FreeBSD.org/FreeBSD/</link> / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.ru.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.ru.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp2.ru.FreeBSD.org/pub/FreeBSD/">http://ftp2.ru.FreeBSD.org/pub/FreeBSD/</link> / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp4.ru.FreeBSD.org/pub/FreeBSD/">ftp://ftp4.ru.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp5.ru.FreeBSD.org/pub/FreeBSD/">ftp://ftp5.ru.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp5.ru.FreeBSD.org/pub/FreeBSD/">http://ftp5.ru.FreeBSD.org/pub/FreeBSD/</link> / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp6.ru.FreeBSD.org/pub/FreeBSD/">ftp://ftp6.ru.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-sa-ftp"/>沙烏地阿拉伯 (Saudi Arabia)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>ftpadmin@isu.net.sa</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.isu.net.sa/pub/ftp.freebsd.org/">ftp://ftp.isu.net.sa/pub/ftp.freebsd.org/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-si-ftp"/>斯洛維尼亞 (Slovenia)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@si.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.si.FreeBSD.org/pub/FreeBSD/">ftp://ftp.si.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-za-ftp"/>南非 (South Africa)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@za.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.za.FreeBSD.org/pub/FreeBSD/">ftp://ftp.za.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.za.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.za.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp4.za.FreeBSD.org/pub/FreeBSD/">ftp://ftp4.za.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-es-ftp"/>西班牙 (Spain)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@es.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.es.FreeBSD.org/pub/FreeBSD/">ftp://ftp.es.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp.es.FreeBSD.org/pub/FreeBSD/">http://ftp.es.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp3.es.FreeBSD.org/pub/FreeBSD/">ftp://ftp3.es.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-se-ftp"/>瑞典 (Sweden)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@se.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.se.FreeBSD.org/pub/FreeBSD/">ftp://ftp.se.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.se.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.se.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="rsync://ftp2.se.FreeBSD.org/">rsync://ftp2.se.FreeBSD.org/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp3.se.FreeBSD.org/pub/FreeBSD/">ftp://ftp3.se.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp4.se.FreeBSD.org/pub/FreeBSD/">ftp://ftp4.se.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="ftp://ftp4.se.FreeBSD.org/pub/FreeBSD/">ftp://ftp4.se.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp4.se.FreeBSD.org/pub/FreeBSD/">http://ftp4.se.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp4.se.FreeBSD.org/pub/FreeBSD/">http://ftp4.se.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="rsync://ftp4.se.FreeBSD.org/pub/FreeBSD/">rsync://ftp4.se.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="rsync://ftp4.se.FreeBSD.org/pub/FreeBSD/">rsync://ftp4.se.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp6.se.FreeBSD.org/pub/FreeBSD/">ftp://ftp6.se.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp6.se.FreeBSD.org/pub/FreeBSD/">http://ftp6.se.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-ch-ftp"/>瑞士 (Switzerland)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@ch.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.ch.FreeBSD.org/pub/FreeBSD/">ftp://ftp.ch.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp.ch.FreeBSD.org/pub/FreeBSD/">http://ftp.ch.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-tw-ftp"/>台灣 (Taiwan)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@tw.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="ftp://ftp.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp.tw.FreeBSD.org/pub/FreeBSD/</link> / rsync / rsyncv6) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="ftp://ftp2.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.tw.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp2.tw.FreeBSD.org/pub/FreeBSD/">http://ftp2.tw.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp2.tw.FreeBSD.org/pub/FreeBSD/">http://ftp2.tw.FreeBSD.org/pub/FreeBSD/</link> / rsync / rsyncv6) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp4.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp4.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp5.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp5.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp6.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp6.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp6.tw.FreeBSD.org/">http://ftp6.tw.FreeBSD.org/</link> / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp7.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp7.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp8.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp8.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp11.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp11.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp11.tw.FreeBSD.org/FreeBSD/">http://ftp11.tw.FreeBSD.org/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp12.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp12.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp13.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp13.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp14.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp14.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp15.tw.FreeBSD.org/pub/FreeBSD/">ftp://ftp15.tw.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-ua-ftp"/>烏克蘭 (Ukraine)</term>
    <listitem>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.ua.FreeBSD.org/pub/FreeBSD/">ftp://ftp.ua.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp.ua.FreeBSD.org/pub/FreeBSD/">http://ftp.ua.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp6.ua.FreeBSD.org/pub/FreeBSD/">ftp://ftp6.ua.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp6.ua.FreeBSD.org/pub/FreeBSD">http://ftp6.ua.FreeBSD.org/pub/FreeBSD</link> / <link xlink:href="rsync://ftp6.ua.FreeBSD.org/FreeBSD/">rsync://ftp6.ua.FreeBSD.org/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp7.ua.FreeBSD.org/pub/FreeBSD/">ftp://ftp7.ua.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-uk-ftp"/>英國 (United Kingdom)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@uk.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp.uk.FreeBSD.org/pub/FreeBSD/">ftp://ftp.uk.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.uk.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.uk.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="rsync://ftp2.uk.FreeBSD.org/ftp.freebsd.org/pub/FreeBSD/">rsync://ftp2.uk.FreeBSD.org/ftp.freebsd.org/pub/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp3.uk.FreeBSD.org/pub/FreeBSD/">ftp://ftp3.uk.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp4.uk.FreeBSD.org/pub/FreeBSD/">ftp://ftp4.uk.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp5.uk.FreeBSD.org/pub/FreeBSD/">ftp://ftp5.uk.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
  <varlistentry>
    <term><anchor xml:id="mirrors-us-ftp"/>美國 (USA)</term>
    <listitem>
      <para>若有任何問題，請聯絡此區域的主機管理者 <email>hostmaster@us.FreeBSD.org</email>。</para>
      <itemizedlist>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp1.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp1.us.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp2.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp2.us.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp3.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp3.us.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp4.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp4.us.FreeBSD.org/pub/FreeBSD/</link> (ftp / ftpv6 / <link xlink:href="http://ftp4.us.FreeBSD.org/pub/FreeBSD/">http://ftp4.us.FreeBSD.org/pub/FreeBSD/</link> / <link xlink:href="http://ftp4.us.FreeBSD.org/pub/FreeBSD/">http://ftp4.us.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp5.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp5.us.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp6.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp6.us.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp8.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp8.us.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp10.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp10.us.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp11.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp11.us.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp13.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp13.us.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp13.us.FreeBSD.org/pub/FreeBSD/">http://ftp13.us.FreeBSD.org/pub/FreeBSD/</link> / rsync) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp14.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp14.us.FreeBSD.org/pub/FreeBSD/</link> (ftp / <link xlink:href="http://ftp14.us.FreeBSD.org/pub/FreeBSD/">http://ftp14.us.FreeBSD.org/pub/FreeBSD/</link>) </para>
        </listitem>
        <listitem>
          <para xml:lang="en"><link xlink:href="ftp://ftp15.us.FreeBSD.org/pub/FreeBSD/">ftp://ftp15.us.FreeBSD.org/pub/FreeBSD/</link> (ftp) </para>
        </listitem>
      </itemizedlist>
    </listitem>
  </varlistentry>
</variablelist>

  </sect1>

  <sect1 xml:id="svn">
    <title>使用 <application>Subversion</application></title>

    <indexterm xml:lang="en">
      <primary>Subversion</primary>
    </indexterm>

    <sect2 xml:id="svn-intro">
      <title>簡介</title>

      <para>自 2012 年 7 月起，FreeBSD 儲存所有 FreeBSD 的原始碼、文件與 Port 套件集均使用 <application>Subversion</application> 作為其唯一的版本控制系統。</para>

      <note>
	<para><application>Subversion</application> 只是一套開發人員工具。一般使用者可能會較喜歡使用 <command>freebsd-update</command> (<xref linkend="updating-upgrading-freebsdupdate"/>) 來更新 FreeBSD 基礎系統及 <command>portsnap</command> (<xref linkend="ports-using"/>) 來更新 FreeBSD Port 套件集。</para>
      </note>

      <para>本節將示範如何在 FreeBSD 系統安裝 <application>Subversion</application> 以及使用它建立一個本地的 FreeBSD 檔案庫複本，也包含使用 <application>Subversion</application> 的其他資訊。</para>
    </sect2>

    <sect2 xml:id="svn-ssl-certificates">
      <title>根 <acronym>SSL</acronym> 憑證</title>

      <para>安裝 <package role="port">security/ca_root_nss</package> 可讓 <application>Subversion</application> 能夠驗証 <acronym>HTTPS</acronym> 檔案庫伺服器的身份。root <acronym>SSL</acronym> 憑証可從 Port 安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/security/ca_root_nss</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para>或從套件：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install ca_root_nss</userinput></screen>
    </sect2>

    <sect2 xml:id="svn-svnlite">
      <title xml:lang="en"><application>Svnlite</application></title>

      <para>輕量化版的 <application>Subversion</application> <command>svnlite</command> 已會隨 FreeBSD 安裝。Port 或套件版的 <application>Subversion</application> 僅在要使用其 Python 或 Perl <acronym>API</acronym> 時需要，或是新想要使用最新版本 Subversion 時才需要。</para>

      <para>與正常 <application>Subversion</application> 唯一的差別只是指令名稱改為 <literal>svnlite</literal>。</para>
    </sect2>

    <sect2 xml:id="svn-install">
      <title>安裝</title>

      <para>若無法使用 <command>svnlite</command> 或需要完整版本的 <application>Subversion</application> 就必須安裝。</para>

      <para><application>Subversion</application> 可從 Port 套件集安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/ports/devel/subversion</userinput>
<prompt>#</prompt> <userinput>make install clean</userinput></screen>

      <para><application>Subversion</application> 也可以以套件安裝：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>pkg install subversion</userinput></screen>
    </sect2>

    <sect2 xml:id="svn-usage">
      <title>執行 <application>Subversion</application></title>

      <para>要下載原始碼乾淨的複本到本地目錄可使用 <command>svn</command>。在此目錄中的檔案稱作 <emphasis>本地工作複本 (Local working copy)</emphasis>。</para>

      <warning>
	<para>在第一次使用 <command>checkout</command> 前請先移動或刪除目地現有的目錄。</para>

	<para>在現有非 <command>svn</command> 目錄存在的情況下做取出 (Checkout) 的動作會導致現有檔案與檔案庫中的檔案發生衝突。</para>
      </warning>

      <para><application>Subversion</application> 使用 <acronym>URL</acronym> 來指定檔案庫，使用的格式為 <replaceable>protocol://hostname/path</replaceable>。路徑的第一個部份為要存取的 FreeBSD 檔案庫，目前有三個檔案庫，<literal>base</literal> 為 FreeBSD 基礎系統原始碼、<literal>ports</literal> 為 Port 套件集以及 <literal>doc</literal> 為說明文件。舉例來說，URL <literal>https://svn.FreeBSD.org/ports/head/</literal> 代表 Port 檔案庫的主要分支，使用 <literal>https</literal> 通訊協定。</para>

      <para>使用指令從指定的檔案庫取出 (Checkout) 原始碼如下：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>svn checkout https://svn.FreeBSD.org/<replaceable>repository</replaceable>/<replaceable>branch</replaceable> <replaceable>lwcdir</replaceable></userinput></screen>

      <para xml:lang="en">where:</para>

      <itemizedlist>
	<listitem>
	  <para><replaceable>repository</replaceable> 要是下列專案檔案庫其中之一：<literal>base</literal>, <literal>ports</literal> 或 <literal>doc</literal>。</para>
	</listitem>

	<listitem>
	  <para><replaceable>branch</replaceable> 則依據使用的檔案庫來決定。<literal>ports</literal> 與 <literal>doc</literal> 大部份的更新皆在 <literal>head</literal> 分支，而 <literal>base</literal> 則會將 -CURRENT 的最新版本存放在 <literal>head</literal> 下，-STABLE 分支各自最新的版本則會放在 <literal>stable/9</literal> (9.<replaceable>x</replaceable>) 與 <literal>stable/10</literal> (10.<replaceable>x</replaceable>) 下。</para>
	</listitem>

	<listitem>
	  <para><replaceable>lwcdir</replaceable> 則是要存放指定分支內容的目標目錄，通常 <literal>ports</literal> 會置於 <filename>/usr/ports</filename>，<literal>base</literal> 會置於 <filename>/usr/src</filename> 以及 <literal>doc</literal> 會置於 <filename>/usr/doc</filename>。</para>
	</listitem>
      </itemizedlist>

      <para>以下範例會使用 <acronym>HTTPS</acronym> 協定從 FreeBSD 的檔案庫取出 Port 套件集，並將本地工作複本放置於 <filename>/usr/ports</filename>。若 <filename>/usr/ports</filename> 已存在，且不是由 <command>svn</command> 所建立的，記得要在取出之前重新命名或刪除。</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>svn checkout https://svn.FreeBSD.org/ports/head /usr/ports</userinput></screen>

      <para>由於首次取出的動作必須下載遠端檔案庫中完整的分支，會需要花費一段時間，請耐心等候。</para>

      <para>首次取出之後，往後要更新本地工作複本可以執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>svn update <replaceable>lwcdir</replaceable></userinput></screen>

      <para>要更新上述範例所建立的 <filename>/usr/ports</filename> 可執行：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>svn update /usr/ports</userinput></screen>

      <para>因為只會傳輸有更新過的檔案，更新的動作會比取出還要快速。</para>

      <para>另一種在取出之後更新本地工作複本的方式是透過 <filename>/usr/ports</filename>, <filename>/usr/src</filename> 以及 <filename>/usr/doc</filename> 目錄所提供的 <filename>Makefile</filename>。設定 <varname>SVN_UPDATE</varname> 並使用 <buildtarget>update</buildtarget> 目標。例如要更新 <filename>/usr/src</filename>：</para>

      <screen xml:lang="en"><prompt>#</prompt> <userinput>cd /usr/src</userinput>
<prompt>#</prompt> <userinput>make update SVN_UPDATE=yes</userinput></screen>
    </sect2>

    <sect2 xml:id="svn-mirrors">
      <title><application>Subversion</application> 鏡像站</title>

      <indexterm xml:lang="en">
	<primary>Subversion Repository</primary>
	<secondary>Mirror Sites</secondary>
      </indexterm>

      <para>FreeBSD <application>Subversion</application> 的檔案庫為：</para>

      <programlisting xml:lang="en">svn.FreeBSD.org</programlisting>

      <para>這是可公開存取的鏡像站，使用了 GeoDNS 會自動選擇適合的後端伺服器。若要由瀏覽器檢視 <application>Subversion</application> 檔案庫可以使用 <link xlink:href="https://svnweb.FreeBSD.org/">https://svnweb.FreeBSD.org/</link>。</para>

      <para xml:lang="en">HTTPS is the preferred protocol, but the
	<filename role="package">security/ca_root_nss</filename>
	package will need to be installed in order to automatically
	validate certificates.</para>
    </sect2>

    <sect2>
      <title>取得更多資訊</title>

      <para>要取得其他有關使用 <application>Subversion</application> 的資訊請參考 <quote>Subversion Book</quote>，其書名為 <link xlink:href="http://svnbook.red-bean.com/">Version Control with Subversion</link> 或是 <link xlink:href="http://subversion.apache.org/docs/">Subversion Documentation</link>。</para>
    </sect2>
  </sect1>

  <sect1 xml:id="mirrors-rsync">
    <title>使用 <application>rsync</application></title>

    <para>這些站台讓 FreeBSD 可透過 rsync 通訊協定取得。<application>rsync</application> 工具只會傳輸兩個檔案集之間的差異，所以能夠大大的加快在網路上同步的速度，這對大多數 FreeBSD <acronym>FTP</acronym> 伺服器的鏡像站非常有用。<application>rsync</application> 在許多作業系統上也可以使用，在 FreeBSD 上請參考 <package>net/rsync</package> Port 或使用套件。</para>

    <variablelist>
      <varlistentry>
	<term>捷克 (Czech Republic)</term>

	<listitem>
	  <para xml:lang="en">rsync://ftp.cz.FreeBSD.org/</para>

	  <para>可用的檔案集：</para>
	  <itemizedlist>
	    <listitem>
	      <para>ftp: FreeBSD <acronym>FTP</acronym> 伺服器的部份鏡像。</para>
	    </listitem>

	    <listitem>
	      <para>FreeBSD: FreeBSD <acronym>FTP</acronym> 伺服器的完整鏡像。</para>
	    </listitem>
	  </itemizedlist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>荷蘭 (Netherlands)</term>

	<listitem>
	  <para xml:lang="en">rsync://ftp.nl.FreeBSD.org/</para>

	  <para>可用的檔案集：</para>
	  <itemizedlist>
	    <listitem>
	      <para>FreeBSD: FreeBSD <acronym>FTP</acronym> 伺服器的完整鏡像。</para>
	    </listitem>
	  </itemizedlist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>俄羅斯 (Russia)</term>

	<listitem>
	  <para xml:lang="en">rsync://ftp.mtu.ru/</para>

	  <para>可用的檔案集：</para>

	  <itemizedlist>
	    <listitem>
	      <para>FreeBSD: FreeBSD <acronym>FTP</acronym> 伺服器的完整鏡像。</para>
	    </listitem>

	    <listitem>
	      <para>FreeBSD-Archive: FreeBSD 封存 <acronym>FTP</acronym> 伺服器的鏡像。</para>
	    </listitem>
	  </itemizedlist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>瑞典 (Sweden)</term>

	<listitem>
	  <para xml:lang="en">rsync://ftp4.se.freebsd.org/</para>

	  <para>可用的檔案集：</para>
	  <itemizedlist>
	    <listitem>
	      <para>FreeBSD: FreeBSD <acronym>FTP</acronym> 伺服器的完整鏡像。</para>
	    </listitem>
	  </itemizedlist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>台灣 (Taiwan)</term>

	<listitem>
	  <para xml:lang="en">rsync://ftp.tw.FreeBSD.org/</para>

	  <para xml:lang="en">rsync://ftp2.tw.FreeBSD.org/</para>

	  <para xml:lang="en">rsync://ftp6.tw.FreeBSD.org/</para>

	  <para>可用的檔案集：</para>
	  <itemizedlist>
	    <listitem>
	      <para>FreeBSD: FreeBSD <acronym>FTP</acronym> 伺服器的完整鏡像。</para>
	    </listitem>
	  </itemizedlist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>英國 (United Kingdom)</term>

	<listitem>
	  <para xml:lang="en">rsync://rsync.mirrorservice.org/</para>

	  <para>可用的檔案集：</para>
	  <itemizedlist>
	    <listitem>
	      <para>ftp.freebsd.org: FreeBSD <acronym>FTP</acronym> 伺服器的完整鏡像。</para>
	    </listitem>
	  </itemizedlist>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term>美國 (USA)</term>

	<listitem>
	  <para xml:lang="en">rsync://ftp-master.FreeBSD.org/</para>

	  <para>此伺服器僅供 FreeBSD 主要鏡像站使用。</para>

	  <para>可用的檔案集：</para>

	  <itemizedlist>
	    <listitem>
	      <para>FreeBSD: FreeBSD <acronym>FTP</acronym> 伺服器的主要封存。</para>
	    </listitem>

	    <listitem>
	      <para>acl: FreeBSD 主要 ACL 清單。</para>
	    </listitem>
	  </itemizedlist>

	  <para xml:lang="en">rsync://ftp13.FreeBSD.org/</para>

	  <para>可用的檔案集：</para>

	  <itemizedlist>
	    <listitem>
	      <para>FreeBSD: FreeBSD <acronym>FTP</acronym> 伺服器的完整鏡像。</para>
	    </listitem>
	  </itemizedlist>
	</listitem>
      </varlistentry>
    </variablelist>
  </sect1>
</appendix>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<appendix version="5.0" xml:id="bibliography">

  <title>參考書目</title>

  <para>雖然操作手冊提供 FreeBSD 作業系統各個部分完整的說明，卻難免有「小學而大遺」之憾，像是如何讓整個作業系統運作順暢。因此，身邊有 <trademark class="registered">UNIX</trademark> 系統管理的好書以及好的使用手冊是不可或缺的。</para>

  <sect1 xml:id="bibliography-freebsd">
    <title>FreeBSD 相關書籍</title>

    <para>國際書籍：</para>

    <itemizedlist>
      <listitem>
	<para><link xlink:href="http://jdli.tw.FreeBSD.org/publication/book/freebsd2/index.htm">FreeBSD 入門與應用 (光碟豪華版)</link> (繁體中文), <link xlink:href="http://www.drmaster.com.tw/">博碩文化</link>出版, 1997. ISBN 9-578-39435-7。</para>
      </listitem>

      <listitem>

	<para>FreeBSD 技術內幕 (FreeBSD Unleashed 簡體中譯版), <link xlink:href="http://www.hzbook.com/">機械工業出版社</link>出版. ISBN 7-111-10201-0。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 使用大全第二版 (簡體中文), 機械工業出版社出版. ISBN 7-111-10286-X。</para>
      </listitem>

      <listitem>
	<para>FreeBSD Handbook 第二版 (簡體中譯版), <link xlink:href="http://www.ptpress.com.cn/">人民郵電出版社</link>出版. ISBN 7-115-10541-3。</para>
      </listitem>

      <listitem>
	<para>FreeBSD &amp; Windows 集成組網實務 (簡體中文), <link xlink:href="http://www.tdpress.com/">中國鐵道出版社</link>出版. ISBN 7-113-03845-X。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 網站架設實務 (簡體中文), 中國鐵道出版社出版. ISBN 7-113-03423-3。</para>
      </listitem>

      <listitem>
	<para>FreeBSD (日文), CUTT 出版. ISBN 4-906391-22-2 C3055 P2400E。</para>
      </listitem>

      <listitem>
	<para><link xlink:href="http://www.shoeisha.com/book/Detail.asp?bid=650">Complete Introduction to FreeBSD</link> (日文), <link xlink:href="http://www.shoeisha.co.jp/">Shoeisha Co., Ltd</link> 出版. ISBN 4-88135-473-6 P3600E。</para>
      </listitem>

      <listitem>
	<para><link xlink:href="http://www.ascii.co.jp/pb/book1/shinkan/detail/1322785.html">Personal UNIX Starter Kit FreeBSD</link> (日文), <link xlink:href="http://www.ascii.co.jp/">ASCII</link> 出版. ISBN 4-7561-1733-3 P3000E。</para>
      </listitem>

      <listitem>
	<para>FreeBSD Handbook (日譯版), <link xlink:href="http://www.ascii.co.jp/">ASCII</link> 出版. ISBN 4-7561-1580-2 P3800E。</para>
      </listitem>

      <listitem>
	<para>FreeBSD mit Methode (德文), <link xlink:href="http://www.cul.de">Computer und Literatur Verlag</link>/Vertrieb Hanser 出版, 1998. ISBN 3-932311-31-0。</para>
      </listitem>

      <listitem>
	<para><link xlink:href="http://www.mitp.de/vmi/mitp/detail/pWert/1343/"> FreeBSD de Luxe</link> (德文), <link xlink:href="http://www.mitp.de">Verlag Modere Industrie</link> 出版, 2003. ISBN 3-8266-1343-0。</para>
      </listitem>

      <listitem>
	<para><link xlink:href="http://www.pc.mycom.co.jp/FreeBSD/install-manual.html">FreeBSD Install and Utilization Manual</link> (日文), <link xlink:href="http://www.pc.mycom.co.jp/">Mainichi Communications Inc.</link> 出版, 1998. ISBN 4-8399-0112-0。</para>
      </listitem>

      <listitem>
	<para>Onno W Purbo, Dodi Maryanto, Syahrial Hubbany, Widjil Widodo <emphasis><link xlink:href="http://maxwell.itb.ac.id/">Building Internet Server with FreeBSD</link></emphasis> (印尼文), <link xlink:href="http://www.elexmedia.co.id/">Elex Media Komputindo</link> 出版。</para>
      </listitem>

      <listitem>
	<para>FreeBSD 完全探索 (Absolute BSD: The Ultimate Guide to FreeBSD 繁體中譯版), <link xlink:href="http://www.grandtech.com.tw/">GrandTech Press</link> 出版, 2003. ISBN 986-7944-92-5。</para>
      </listitem>

      <listitem>
	<para><link xlink:href="http://www.twbsd.org/cht/book/">FreeBSD 6.0 架設管理與應用</link> (繁體中文), 博碩出版, 2006. ISBN 9-575-27878-X。</para>
      </listitem>
    </itemizedlist>

    <para>英文書籍：</para>

    <itemizedlist>
      <listitem>
	<para xml:lang="en"><link xlink:href="http://www.absoluteFreeBSD.com/">Absolute
	    FreeBSD, 2nd Edition: The Complete Guide to
	    FreeBSD</link>, published by
	  <link xlink:href="http://www.nostarch.com/">No Starch
	    Press</link>, 2007.  ISBN: 978-1-59327-151-0</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="http://www.freebsdmall.com/cgi-bin/fm/bsdcomp">
	    The Complete FreeBSD</link>, published by
	  <link xlink:href="http://www.oreilly.com/">O'Reilly</link>,
	  2003. ISBN: 0596005164</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="http://www.freebsd-corp-net-guide.com/">The
	    FreeBSD Corporate Networker's Guide</link>, published by
	  <link xlink:href="http://www.awl.com/aw/">Addison-Wesley</link>,
	  2000.  ISBN: 0201704811</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="http://andrsn.stanford.edu/FreeBSD/introbook/">
	    FreeBSD: An Open-Source Operating System for Your Personal
	    Computer</link>, published by The Bit Tree Press, 2001.
	  ISBN: 0971204500</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Teach Yourself FreeBSD in 24 Hours, published by <link xlink:href="http://www.samspublishing.com/">Sams</link>,
	  2002.  ISBN: 0672324245</para>
      </listitem>

      <listitem>
	<para xml:lang="en">FreeBSD 6 Unleashed, published by <link xlink:href="http://www.samspublishing.com/">Sams</link>,
	  2006.  ISBN: 0672328755</para>
      </listitem>

      <listitem>
	<para xml:lang="en">FreeBSD: The Complete Reference, published by <link xlink:href="http://books.mcgraw-hill.com">McGrawHill</link>,
	  2003.  ISBN: 0072224096</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="bibliography-userguides">
    <title>使用指南</title>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Ohio State University has written a <link xlink:href="http://www.cs.duke.edu/csl/docs/unix_course/">UNIX
	    Introductory Course</link> which is available online in
	  HTML and PostScript format.</para>

	<para xml:lang="en">An Italian <link xlink:href="@@URL_RELPREFIX@@/doc/it_IT.ISO8859-15/books/unix-introduction/index.html">translation</link>
	  of this document is available as part of the FreeBSD Italian
	  Documentation Project.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="http://www.ed.ac.uk/">Edinburgh
	    University</link> has written an <link xlink:href="http://www.ed.ac.uk/information-services/help-consultancy/is-skills/catalogue/program-op-sys-catalogue/unix1">Online
	    Guide</link> for newcomers to the UNIX environment.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="bibliography-adminguides">
    <title>管理指南</title>

    <itemizedlist>
      <listitem>
	<para xml:lang="en"><link xlink:href="http://www.jp.FreeBSD.org/">Jpman
	    Project, Japan FreeBSD Users Group</link>.  <link xlink:href="http://www.pc.mycom.co.jp/FreeBSD/sam.html">FreeBSD
	    System Administrator's Manual</link> (Japanese
	  translation).
	  <link xlink:href="http://www.pc.mycom.co.jp/">Mainichi
	    Communications Inc.</link>, 1998.  ISBN4-8399-0109-0
	  P3300E.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Dreyfus, Emmanuel.  <link xlink:href="http://www.eyrolles.com/Informatique/Livre/9782212114638/">Cahiers
	    de l'Admin: BSD</link> 2nd Ed. (in French), Eyrolles,
	  2004.  ISBN 2-212-11463-X</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="bibliography-programmers">
    <title>開發指南</title>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Computer Systems Research Group, UC Berkeley.
	  <emphasis>4.4BSD Programmer's Reference Manual</emphasis>.
	  O'Reilly &amp; Associates, Inc., 1994.  ISBN
	  1-56592-078-3</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Computer Systems Research Group, UC Berkeley.
	  <emphasis>4.4BSD Programmer's Supplementary
	    Documents</emphasis>.  O'Reilly &amp; Associates, Inc.,
	  1994.  ISBN 1-56592-079-1</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Harbison, Samuel P. and Steele, Guy L. Jr.  <emphasis>C:
	    A Reference Manual</emphasis>.  4th Ed. Prentice Hall,
	  1995.  ISBN 0-13-326224-3</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Kernighan, Brian and Dennis M. Ritchie.  <emphasis>The C
	    Programming Language</emphasis>.  2nd Ed. PTR Prentice
	  Hall, 1988.  ISBN 0-13-110362-8</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Lehey, Greg.  <emphasis>Porting UNIX
	    Software</emphasis>.  O'Reilly &amp; Associates, Inc.,
	  1995.  ISBN 1-56592-126-7</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Plauger, P. J. <emphasis>The Standard C
	    Library</emphasis>.  Prentice Hall, 1992.  ISBN
	  0-13-131509-9</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Spinellis, Diomidis.  <link xlink:href="http://www.spinellis.gr/codereading/"><emphasis>Code
	      Reading: The Open Source Perspective</emphasis></link>.
	  Addison-Wesley, 2003.  ISBN 0-201-79940-5</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Spinellis, Diomidis.  <link xlink:href="http://www.spinellis.gr/codequality/"><emphasis>Code
	      Quality: The Open Source Perspective</emphasis></link>.
	  Addison-Wesley, 2006.  ISBN 0-321-16607-8</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Stevens, W. Richard and Stephen A. Rago.
	  <emphasis>Advanced Programming in the UNIX
	    Environment</emphasis>.  2nd Ed. Reading, Mass. :
	  Addison-Wesley, 2005.  ISBN 0-201-43307-9</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Stevens, W. Richard.  <emphasis>UNIX Network
	    Programming</emphasis>.  2nd Ed, PTR Prentice Hall, 1998.
	  ISBN 0-13-490012-X</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="bibliography-osinternals">
    <title>深入作業系統</title>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Andleigh, Prabhat K.  <emphasis>UNIX System
	    Architecture</emphasis>.  Prentice-Hall, Inc., 1990.  ISBN
	  0-13-949843-5</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Jolitz, William.  <quote>Porting UNIX to the
	    386</quote>.  <emphasis>Dr. Dobb's Journal</emphasis>.
	  January 1991-July 1992.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Leffler, Samuel J., Marshall Kirk McKusick, Michael J
	  Karels and John Quarterman <emphasis>The Design and
	    Implementation of the 4.3BSD UNIX Operating
	    System</emphasis>.  Reading, Mass. : Addison-Wesley, 1989.
	  ISBN 0-201-06196-1</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Leffler, Samuel J., Marshall Kirk McKusick,
	  <emphasis>The Design and Implementation of the 4.3BSD UNIX
	    Operating System: Answer Book</emphasis>.  Reading, Mass.
	  : Addison-Wesley, 1991.  ISBN 0-201-54629-9</para>
      </listitem>

      <listitem>
	<para xml:lang="en">McKusick, Marshall Kirk, Keith Bostic, Michael J Karels,
	  and John Quarterman.  <emphasis>The Design and
	    Implementation of the 4.4BSD Operating System</emphasis>.
	  Reading, Mass. : Addison-Wesley, 1996.  ISBN
	  0-201-54979-4</para>

	<para xml:lang="en">(Chapter 2 of this book is available <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/books/design-44bsd/book.html">online</link>
	  as part of the FreeBSD Documentation Project.)</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Marshall Kirk McKusick, George V. Neville-Neil
	  <emphasis>The Design and Implementation of the FreeBSD
	    Operating System</emphasis>.  Boston, Mass. :
	  Addison-Wesley, 2004.  ISBN 0-201-70245-2</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Marshall Kirk McKusick, George V. Neville-Neil,
	  Robert N. M. Watson <emphasis>The Design and Implementation
	    of the FreeBSD Operating System, 2nd Ed.</emphasis>.
	  Westford, Mass. : Pearson Education, Inc., 2014.
	  ISBN 0-321-96897-2</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Stevens, W. Richard.  <emphasis>TCP/IP Illustrated,
	    Volume 1: The Protocols</emphasis>.  Reading, Mass. :
	  Addison-Wesley, 1996.  ISBN 0-201-63346-9</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Schimmel, Curt.  <emphasis>Unix Systems for Modern
	    Architectures</emphasis>.  Reading, Mass. :
	  Addison-Wesley, 1994.  ISBN 0-201-63338-8</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Stevens, W. Richard.  <emphasis>TCP/IP Illustrated,
	    Volume 3: TCP for Transactions, HTTP, NNTP and the UNIX
	    Domain Protocols</emphasis>.  Reading, Mass. :
	  Addison-Wesley, 1996.  ISBN 0-201-63495-3</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Vahalia, Uresh.  <emphasis>UNIX Internals -- The New
	    Frontiers</emphasis>.  Prentice Hall, 1996.  ISBN
	  0-13-101908-2</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Wright, Gary R. and W. Richard Stevens.
	  <emphasis>TCP/IP Illustrated, Volume 2: The
	    Implementation</emphasis>.  Reading, Mass. :
	  Addison-Wesley, 1995.  ISBN 0-201-63354-X</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="bibliography-security">
    <title>安全性參考文獻</title>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Cheswick, William R. and Steven M. Bellovin.
	  <emphasis>Firewalls and Internet Security: Repelling the
	    Wily Hacker</emphasis>.  Reading, Mass. : Addison-Wesley,
	  1995.  ISBN 0-201-63357-4</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Garfinkel, Simson.  <emphasis>PGP Pretty Good
	    Privacy</emphasis> O'Reilly &amp; Associates, Inc., 1995.
	  ISBN 1-56592-098-8</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="bibliography-hardware">
    <title>硬體參考文獻</title>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Anderson, Don and Tom Shanley.  <emphasis>Pentium
	    Processor System Architecture</emphasis>.  2nd Ed.
	  Reading, Mass. : Addison-Wesley, 1995.  ISBN
	  0-201-40992-5</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Ferraro, Richard F.  <emphasis>Programmer's Guide to the
	    EGA, VGA, and Super VGA Cards</emphasis>.  3rd ed.
	  Reading, Mass. : Addison-Wesley, 1995.  ISBN
	  0-201-62490-7</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Intel Corporation publishes documentation on their CPUs,
	  chipsets and standards on their
	  <link xlink:href="http://developer.intel.com/">developer web
	    site</link>, usually as PDF files.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Shanley, Tom.  <emphasis>80486 System
	    Architecture</emphasis>.  3rd Ed. Reading, Mass. :
	  Addison-Wesley, 1995.  ISBN 0-201-40994-1</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Shanley, Tom.  <emphasis>ISA System
	    Architecture</emphasis>.  3rd Ed. Reading, Mass. :
	  Addison-Wesley, 1995.  ISBN 0-201-40996-8</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Shanley, Tom.  <emphasis>PCI System
	    Architecture</emphasis>.  4th Ed. Reading, Mass. :
	  Addison-Wesley, 1999.  ISBN 0-201-30974-2</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Van Gilluwe, Frank.  <emphasis>The Undocumented
	    PC</emphasis>, 2nd Ed.  Reading, Mass: Addison-Wesley Pub.
	  Co., 1996.  ISBN 0-201-47950-8</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Messmer, Hans-Peter.  <emphasis>The Indispensable PC
	    Hardware Book</emphasis>, 4th Ed. Reading, Mass :
	  Addison-Wesley Pub. Co., 2002.  ISBN 0-201-59616-4</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="bibliography-history">
    <title><trademark class="registered">UNIX</trademark> 歷史</title>

    <itemizedlist>
      <listitem>
	<para xml:lang="en">Lion, John <emphasis>Lion's Commentary on UNIX, 6th Ed.
	    With Source Code</emphasis>.  ITP Media Group, 1996.  ISBN
	  1573980137</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Raymond, Eric S.  <emphasis>The New Hacker's Dictionary,
	    3rd edition</emphasis>.  MIT Press, 1996.  ISBN
	  0-262-68092-0.  Also known as the <link xlink:href="http://www.catb.org/~esr/jargon/html/index.html">Jargon
	    File</link></para>
      </listitem>

      <listitem>
	<para xml:lang="en">Salus, Peter H.  <emphasis>A quarter century of
	    UNIX</emphasis>.  Addison-Wesley Publishing Company, Inc.,
	  1994.  ISBN 0-201-54777-5</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Simon Garfinkel, Daniel Weise, Steven Strassmann.
	  <emphasis>The UNIX-HATERS Handbook</emphasis>.  IDG Books
	  Worldwide, Inc., 1994.  ISBN 1-56884-203-1.  Out of print,
	  but available <link xlink:href="http://www.simson.net/ref/ugh.pdf">online</link>.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">Don Libes, Sandy Ressler <emphasis>Life with
	    UNIX</emphasis> — special edition.  Prentice-Hall,
	  Inc., 1989.  ISBN 0-13-536657-7</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>The BSD family tree</emphasis>.
	  <uri xlink:href="https://svnweb.freebsd.org/base/head/share/misc/bsd-family-tree?view=co">https://svnweb.freebsd.org/base/head/share/misc/bsd-family-tree?view=co</uri>
	  or <link xlink:href="file://localhost/usr/share/misc/bsd-family-tree"><filename>/usr/share/misc/bsd-family-tree</filename></link>
	  on a FreeBSD machine.</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>Networked Computer Science Technical Reports
	    Library</emphasis>.  <uri xlink:href="http://www.ncstrl.org/">http://www.ncstrl.org/</uri></para>
      </listitem>

      <listitem>
	<para xml:lang="en"><emphasis>Old BSD releases from the Computer Systems
	    Research group (CSRG)</emphasis>.  <uri xlink:href="http://www.mckusick.com/csrg/">http://www.mckusick.com/csrg/</uri>:
	  The 4CD set covers all BSD versions from 1BSD to 4.4BSD and
	  4.4BSD-Lite2 (but not 2.11BSD, unfortunately).  The last
	  disk also holds the final sources plus the SCCS
	  files.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="bibliography-journals">
    <title>期刊與雜誌</title>

    <itemizedlist>
      <listitem>
	<para xml:lang="en"><link xlink:href="http://www.admin-magazin.de/">Admin
	    Magazin</link> (in German), published by
	  Medialinx AG. ISSN: 2190-1066</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="http://www.bsdmag.org/">BSD
	    Magazine</link>, published by Software Press Sp. z o.o.
	  SK. ISSN: 1898-9144</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="http://www.bsdnow.tv/">BSD Now
	    — Video Podcast</link>, published by
	  Jupiter Broadcasting LLC</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="http://bsdtalk.blogspot.com/">BSD
	    Talk Podcast</link>, by Will Backman</para>
      </listitem>

      <listitem>
	<para xml:lang="en"><link xlink:href="http://freebsdjournal.com/">FreeBSD
	    Journal</link>, published by S&amp;W
	  Publishing, sponsored by The FreeBSD Foundation.
	  ISBN: 978-0-615-88479-0</para>
      </listitem>
    </itemizedlist>
  </sect1>
</appendix>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<appendix version="5.0" xml:id="eresources">

  <title>網路資源</title>

  <para xml:lang="en">The rapid pace of FreeBSD progress makes print media
    impractical as a means of following the latest developments.
    Electronic resources are the best, if not often the only, way to
    stay informed of the latest advances.  Since FreeBSD is a volunteer
    effort, the user community itself also generally serves as a
    <quote>technical support department</quote> of sorts, with
    electronic mail, web forums, and USENET news being the most
    effective way of reaching that community.</para>

  <para xml:lang="en">The most important points of contact with the FreeBSD user
    community are outlined below.  Please send other resources not
    mentioned here to the <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-doc">FreeBSD documentation project mailing list</link> so that they may also be
    included.</para>

  <sect1 xml:id="eresources-www">
    <title>網站</title>

    <itemizedlist>
      <listitem>
	<para xml:lang="en"><link xlink:href="https://forums.FreeBSD.org/">The
	    FreeBSD Forums</link> provide a web based discussion forum
	  for FreeBSD questions and technical
	  discussion.</para>
      </listitem>

      <listitem>
	<para xml:lang="en">The <link xlink:href="http://www.youtube.com/bsdconferences">BSDConferences
	    YouTube Channel</link> provides a collection of high
	  quality videos from BSD conferences around the world.
	  This is a great way to watch key developers give
	  presentations about new work in FreeBSD.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="eresources-mail">
    <title>郵遞論壇 (Mailing List)</title>

    <para xml:lang="en">The mailing lists are the most direct way of addressing
      questions or opening a technical discussion to a concentrated
      FreeBSD audience.  There are a wide variety of lists on a number of
      different FreeBSD topics.  Sending questions to the most
      appropriate mailing list will invariably assure a faster and
      more accurate response.</para>

    <para xml:lang="en">The charters for the various lists are given at the bottom
      of this document.  <emphasis>Please read the charter before
      joining or sending mail to any list</emphasis>.  Most list
      subscribers receive many hundreds of FreeBSD related messages every
      day, and the charters and rules for use are meant to keep the
      signal-to-noise ratio of the lists high.  To do less would see
      the mailing lists ultimately fail as an effective communications
      medium for the Project.</para>

    <note>
      <para xml:lang="en"><emphasis>To test the ability to send email to FreeBSD lists,
	  send a test message to <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-test">freebsd-test</link>.</emphasis>  Please do
	not send test messages to any other list.</para>
    </note>

    <para xml:lang="en">When in doubt about what list to post a question to, see
      <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/freebsd-questions">How to get
	best results from the FreeBSD-questions mailing
	list</link>.</para>

    <para xml:lang="en">Before posting to any list, please learn about how to best
      use the mailing lists, such as how to help avoid
      frequently-repeated discussions, by reading the
      <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/mailing-list-faq">Mailing List
	Frequently Asked Questions</link> (FAQ) document.</para>

    <para xml:lang="en">Archives are kept for all of the mailing lists and can be
      searched using the
      <link xlink:href="@@URL_RELPREFIX@@/search/index.html">FreeBSD World Wide
	Web server</link>.  The keyword searchable archive offers an
      excellent way of finding answers to frequently asked questions
      and should be consulted before posting a question.  Note that
      this also means that messages sent to FreeBSD mailing lists are
      archived in perpetuity.  When protecting privacy is a concern,
      consider using a disposable secondary email address and posting
      only public information.</para>

    <sect2 xml:id="eresources-summary">
      <title>論壇摘要</title>

      <para xml:lang="en"><emphasis>General lists:</emphasis> The following are
	general lists which anyone is free (and encouraged) to
	join:</para>

      <informaltable frame="none" pgwide="1">
	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry xml:lang="en">List</entry>
	      <entry>用途</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-advocacy">freebsd-advocacy</link></entry>
	      <entry xml:lang="en">FreeBSD Evangelism</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-announce">freebsd-announce</link></entry>
	      <entry xml:lang="en">Important events and Project milestones
		(moderated)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-arch">freebsd-arch</link></entry>
	      <entry xml:lang="en">Architecture and design discussions</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-bugbusters">freebsd-bugbusters</link></entry>
	      <entry xml:lang="en">Discussions pertaining to the maintenance of
		the FreeBSD problem report database and related
		tools</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-bugs">freebsd-bugs</link></entry>
	      <entry xml:lang="en">Bug reports</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-chat">freebsd-chat</link></entry>
	      <entry xml:lang="en">Non-technical items related to the FreeBSD
		community</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-chromium">freebsd-chromium</link></entry>
	      <entry xml:lang="en">FreeBSD-specific Chromium issues</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-current">freebsd-current</link></entry>
	      <entry xml:lang="en">Discussion concerning the use of
		FreeBSD-CURRENT</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-isp">freebsd-isp</link></entry>
	      <entry xml:lang="en">Issues for Internet Service Providers using
		FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-jobs">freebsd-jobs</link></entry>
	      <entry xml:lang="en">FreeBSD employment and consulting
		opportunities</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-questions">freebsd-questions</link></entry>
	      <entry xml:lang="en">User questions and technical support</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-security-notifications">freebsd-security-notifications</link></entry>
	      <entry xml:lang="en">Security notifications (moderated)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-stable">freebsd-stable</link></entry>
	      <entry xml:lang="en">Discussion concerning the use of
		FreeBSD-STABLE</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-test">freebsd-test</link></entry>
	      <entry xml:lang="en">Where to send test messages instead of to
		one of the actual lists</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-women">freebsd-women</link></entry>
	      <entry xml:lang="en">FreeBSD advocacy for women</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable>

      <para xml:lang="en"><emphasis>Technical lists:</emphasis> The following lists
	are for technical discussion.  Read the charter for each list
	carefully before joining or sending mail to one as there are
	firm guidelines for their use and content.</para>

      <informaltable frame="none" pgwide="1">
	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry xml:lang="en">List</entry>
	      <entry>用途</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-acpi">freebsd-acpi</link></entry>
	      <entry xml:lang="en">ACPI and power management development</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-afs">freebsd-afs</link></entry>
	      <entry xml:lang="en">Porting AFS to FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-amd64">freebsd-amd64</link></entry>
	      <entry xml:lang="en">Porting FreeBSD to AMD64 systems (moderated)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-apache">freebsd-apache</link></entry>
	      <entry xml:lang="en">Discussion about
		<application>Apache</application> related
		ports</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-arm">freebsd-arm</link></entry>
	      <entry xml:lang="en">Porting FreeBSD to <trademark class="registered">ARM</trademark> processors</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-atm">freebsd-atm</link></entry>
	      <entry xml:lang="en">Using ATM networking with FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-bluetooth">freebsd-bluetooth</link></entry>
	      <entry xml:lang="en">Using <trademark class="registered">Bluetooth</trademark> technology in FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-cloud">freebsd-cloud</link></entry>
	      <entry xml:lang="en">FreeBSD on cloud platforms (EC2, GCE, Azure,
		etc.)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-cluster">freebsd-cluster</link></entry>
	      <entry xml:lang="en">Using FreeBSD in a clustered environment</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-database">freebsd-database</link></entry>
	      <entry xml:lang="en">Discussing database use and development under
		FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-desktop">freebsd-desktop</link></entry>
	      <entry xml:lang="en">Using and improving FreeBSD on the desktop</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/dev-ci">dev-ci</link></entry>
	      <entry xml:lang="en">Build and test reports from the Continuous
		Integration servers</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/dev-reviews">dev-reviews</link></entry>
	      <entry xml:lang="en">Notifications of the FreeBSD review
		system</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-doc">freebsd-doc</link></entry>
	      <entry xml:lang="en">Creating FreeBSD related documents</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-drivers">freebsd-drivers</link></entry>
	      <entry xml:lang="en">Writing device drivers for FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-dtrace">freebsd-dtrace</link></entry>
	      <entry xml:lang="en">Using and working on DTrace in FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-eclipse">freebsd-eclipse</link></entry>
	      <entry xml:lang="en">FreeBSD users of Eclipse IDE, tools, rich client
		applications and ports.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-elastic">freebsd-elastic</link></entry>
	      <entry xml:lang="en">FreeBSD-specific ElasticSearch discussions</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-embedded">freebsd-embedded</link></entry>
	      <entry xml:lang="en">Using FreeBSD in embedded applications</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-eol">freebsd-eol</link></entry>
	      <entry xml:lang="en">Peer support of FreeBSD-related software that
		is no longer supported by the FreeBSD Project.</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-emulation">freebsd-emulation</link></entry>
	      <entry xml:lang="en">Emulation of other systems such as
		Linux/<trademark class="registered">MS-DOS</trademark>/<trademark class="registered">Windows</trademark></entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-enlightenment">freebsd-enlightenment</link></entry>
	      <entry xml:lang="en">Porting <application>Enlightenment</application>
		and <application>Enlightenment</application>
		applications</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-erlang">freebsd-erlang</link></entry>
	      <entry xml:lang="en">FreeBSD-specific Erlang discussions</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-firewire">freebsd-firewire</link></entry>
	      <entry xml:lang="en">FreeBSD <trademark class="registered">FireWire</trademark> (iLink, IEEE 1394) technical
		discussion</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-fortran">freebsd-fortran</link></entry>
	      <entry xml:lang="en">Fortran on FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-fs">freebsd-fs</link></entry>
	      <entry xml:lang="en">File systems</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-games">freebsd-games</link></entry>
	      <entry xml:lang="en">Support for Games on FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-gecko">freebsd-gecko</link></entry>
	      <entry xml:lang="en"><application>Gecko Rendering
		  Engine</application> issues</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-geom">freebsd-geom</link></entry>
	      <entry xml:lang="en">GEOM-specific discussions and
		implementations</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-git">freebsd-git</link></entry>
	      <entry xml:lang="en">Discussion of git use in the FreeBSD project</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-gnome">freebsd-gnome</link></entry>
	      <entry xml:lang="en">Porting <application>GNOME</application> and
		<application>GNOME</application> applications</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-hackers">freebsd-hackers</link></entry>
	      <entry xml:lang="en">General technical discussion</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-haskell">freebsd-haskell</link></entry>
	      <entry xml:lang="en">FreeBSD-specific Haskell issues and
		discussions</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-hardware">freebsd-hardware</link></entry>
	      <entry xml:lang="en">General discussion of hardware for running
		FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-i18n">freebsd-i18n</link></entry>
	      <entry xml:lang="en">FreeBSD Internationalization</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ia32">freebsd-ia32</link></entry>
	      <entry xml:lang="en">FreeBSD on the IA-32 (<trademark class="registered">Intel</trademark> x86)
		platform</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ia64">freebsd-ia64</link></entry>
	      <entry xml:lang="en">Porting FreeBSD to <trademark class="registered">Intel</trademark>'s upcoming IA64
		systems</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-infiniband">freebsd-infiniband</link></entry>
	      <entry xml:lang="en">Infiniband on FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ipfw">freebsd-ipfw</link></entry>
	      <entry xml:lang="en">Technical discussion concerning the redesign
		of the IP firewall code</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-isdn">freebsd-isdn</link></entry>
	      <entry xml:lang="en">ISDN developers</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-jail">freebsd-jail</link></entry>
	      <entry xml:lang="en">Discussion about the <citerefentry><refentrytitle>jail</refentrytitle><manvolnum>8</manvolnum></citerefentry>
		facility</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-java">freebsd-java</link></entry>
	      <entry xml:lang="en"><trademark>Java</trademark> developers and people porting <trademark>JDK</trademark>s to
		FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="https://mail.kde.org/mailman/listinfo/kde-freebsd">freebsd-kde</link></entry>
	      <entry xml:lang="en">Porting <application>KDE</application> and
		<application>KDE</application> applications</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-lfs">freebsd-lfs</link></entry>
	      <entry xml:lang="en">Porting LFS to FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-mips">freebsd-mips</link></entry>
	      <entry xml:lang="en">Porting FreeBSD to <trademark class="registered">MIPS</trademark></entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-mobile">freebsd-mobile</link></entry>
	      <entry xml:lang="en">Discussions about mobile computing</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-mono">freebsd-mono</link></entry>
	      <entry xml:lang="en">Mono and C# applications on FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-multimedia">freebsd-multimedia</link></entry>
	      <entry xml:lang="en">Multimedia applications</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-new-bus">freebsd-new-bus</link></entry>
	      <entry xml:lang="en">Technical discussions about bus
		architecture</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-net">freebsd-net</link></entry>
	      <entry xml:lang="en">Networking discussion and TCP/IP source
		code</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-numerics">freebsd-numerics</link></entry>
	      <entry xml:lang="en">Discussions of high quality implementation of
		libm functions</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ocaml">freebsd-ocaml</link></entry>
	      <entry xml:lang="en">FreeBSD-specific OCaml discussions</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-office">freebsd-office</link></entry>
	      <entry xml:lang="en">Office applications on FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-performance">freebsd-performance</link></entry>
	      <entry xml:lang="en">Performance tuning questions for high
		performance/load installations</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-perl">freebsd-perl</link></entry>
	      <entry xml:lang="en">Maintenance of a number of
		Perl-related ports</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pf">freebsd-pf</link></entry>
	      <entry xml:lang="en">Discussion and questions about the packet filter
		firewall system</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pkg">freebsd-pkg</link></entry>
	      <entry xml:lang="en">Binary package management and package
		tools discussion</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pkg-fallout">freebsd-pkg-fallout</link></entry>
	      <entry xml:lang="en">Fallout logs from package building</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pkgbase">freebsd-pkgbase</link></entry>
	      <entry xml:lang="en">Packaging the FreeBSD base system</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-platforms">freebsd-platforms</link></entry>
	      <entry xml:lang="en">Concerning ports to non <trademark class="registered">Intel</trademark> architecture
		platforms</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ports">freebsd-ports</link></entry>
	      <entry xml:lang="en">Discussion of the Ports Collection</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ports-announce">freebsd-ports-announce</link></entry>
	      <entry xml:lang="en">Important news and instructions about the Ports
		Collection (moderated)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ports-bugs">freebsd-ports-bugs</link></entry>
	      <entry xml:lang="en">Discussion of the ports bugs/PRs</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ppc">freebsd-ppc</link></entry>
	      <entry xml:lang="en">Porting FreeBSD to the <trademark class="registered">PowerPC</trademark></entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-proliant">freebsd-proliant</link></entry>
	      <entry xml:lang="en">Technical discussion of FreeBSD on HP ProLiant
		server platforms</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-python">freebsd-python</link></entry>
	      <entry xml:lang="en">FreeBSD-specific Python issues</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-rc">freebsd-rc</link></entry>
	      <entry xml:lang="en">Discussion related to the
		<filename>rc.d</filename> system and its
		development</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-realtime">freebsd-realtime</link></entry>
	      <entry xml:lang="en">Development of realtime extensions to
		FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ruby">freebsd-ruby</link></entry>
	      <entry xml:lang="en">FreeBSD-specific Ruby discussions</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-scsi">freebsd-scsi</link></entry>
	      <entry xml:lang="en">The SCSI subsystem</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-security">freebsd-security</link></entry>
	      <entry xml:lang="en">Security issues affecting FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-small">freebsd-small</link></entry>
	      <entry xml:lang="en">Using FreeBSD in embedded applications
		(obsolete; use <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-embedded">freebsd-embedded</link> instead)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-snapshots">freebsd-snapshots</link></entry>
	      <entry xml:lang="en">FreeBSD Development Snapshot Announcements</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-sparc64">freebsd-sparc64</link></entry>
	      <entry xml:lang="en">Porting FreeBSD to <trademark class="registered">SPARC</trademark> based systems</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-standards">freebsd-standards</link></entry>
	      <entry xml:lang="en">FreeBSD's conformance to the C99 and the <trademark class="registered">POSIX</trademark>
		standards</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-sysinstall">freebsd-sysinstall</link></entry>
	      <entry xml:lang="en"><citerefentry><refentrytitle>sysinstall</refentrytitle><manvolnum>8</manvolnum></citerefentry> development</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-tcltk">freebsd-tcltk</link></entry>
	      <entry xml:lang="en">FreeBSD-specific Tcl/Tk discussions</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-testing">freebsd-testing</link></entry>
	      <entry xml:lang="en">Testing on FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-tex">freebsd-tex</link></entry>

	      <entry xml:lang="en">Porting <application>TeX</application> and its
		applications to FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-threads">freebsd-threads</link></entry>
	      <entry xml:lang="en">Threading in FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-tilera">freebsd-tilera</link></entry>
	      <entry xml:lang="en">Porting FreeBSD to the Tilera family of
		CPUs</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-tokenring">freebsd-tokenring</link></entry>
	      <entry xml:lang="en">Support Token Ring in FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-toolchain">freebsd-toolchain</link></entry>
	      <entry xml:lang="en">Maintenance of FreeBSD's integrated
		toolchain</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-translators">freebsd-translators</link></entry>
	      <entry xml:lang="en">Translating FreeBSD documents and programs</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-transport">freebsd-transport</link></entry>
	      <entry xml:lang="en">Discussions of transport level network protocols
		in FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-usb">freebsd-usb</link></entry>
	      <entry xml:lang="en">Discussing FreeBSD support for USB</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-virtualization">freebsd-virtualization</link></entry>
	      <entry xml:lang="en">Discussion of various virtualization techniques
		supported by FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-vuxml">freebsd-vuxml</link></entry>
	      <entry xml:lang="en">Discussion on VuXML infrastructure</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-x11">freebsd-x11</link></entry>
	      <entry xml:lang="en">Maintenance and support of X11 on FreeBSD</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-xen">freebsd-xen</link></entry>
	      <entry xml:lang="en">Discussion of the FreeBSD port to <trademark>Xen</trademark> —
		implementation and usage</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-xfce">freebsd-xfce</link></entry>
	      <entry xml:lang="en"><application>XFCE</application> for FreeBSD —
		porting and maintaining</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-zope">freebsd-zope</link></entry>
	      <entry xml:lang="en"><application>Zope</application> for FreeBSD —
		porting and maintaining</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable>

      <para xml:lang="en"><emphasis>Limited lists:</emphasis>  The following lists
	are for more specialized (and demanding) audiences and are
	probably not of interest to the general public.  It is also a
	good idea to establish a presence in the technical lists
	before joining one of these limited lists in order to
	understand the communications etiquette involved.</para>

      <informaltable frame="none" pgwide="1">
	<tgroup cols="2">
	  <thead>
	    <row>
	      <entry xml:lang="en">List</entry>
	      <entry>用途</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-hubs">freebsd-hubs</link></entry>
	      <entry xml:lang="en">People running mirror sites (infrastructural
		support)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-user-groups">freebsd-user-groups</link></entry>
	      <entry xml:lang="en">User group coordination</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-wip-status">freebsd-wip-status</link></entry>
	      <entry xml:lang="en">FreeBSD Work-In-Progress Status</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-wireless">freebsd-wireless</link></entry>
	      <entry xml:lang="en">Discussions of 802.11 stack, tools, device driver
		development</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable>

      <para xml:lang="en"><emphasis>Digest lists:</emphasis>  All of the above lists
	are available in a digest format.  Once subscribed to a list,
	the digest options can be changed in the account options
	section.</para>

      <para xml:lang="en"><emphasis>SVN lists:</emphasis> The following lists are
	for people interested in seeing the log messages for changes
	to various areas of the source tree.  They are
	<emphasis>Read-Only</emphasis> lists and should not have mail
	sent to them.</para>

      <informaltable frame="none" pgwide="1">
	<tgroup cols="3">
	  <thead>
	    <row>
	      <entry xml:lang="en">List</entry>
	      <entry xml:lang="en">Source area</entry>
	      <entry xml:lang="en">Area Description (source for)</entry>
	    </row>
	  </thead>

	  <tbody>
	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-doc-all">svn-doc-all</link></entry>
	      <entry xml:lang="en"><filename>/usr/doc</filename></entry>
	      <entry xml:lang="en">All changes to the doc Subversion repository
		(except for <filename>user</filename>,
		<filename>projects</filename> and
		<filename>translations</filename>)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-doc-head">svn-doc-head</link></entry>
	      <entry xml:lang="en"><filename>/usr/doc</filename></entry>
	      <entry xml:lang="en">All changes to the <quote>head</quote> branch of
		the doc Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-doc-projects">svn-doc-projects</link></entry>
	      <entry xml:lang="en"><filename>/usr/doc/projects</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>projects</filename>
		area of the doc Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-doc-svnadmin">svn-doc-svnadmin</link></entry>
	      <entry xml:lang="en"><filename>/usr/doc</filename></entry>
	      <entry xml:lang="en">All changes to the administrative scripts, hooks,
		and other configuration data of the doc Subversion
		repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-ports-all">svn-ports-all</link></entry>
	      <entry xml:lang="en"><filename>/usr/ports</filename></entry>
	      <entry xml:lang="en">All changes to the ports Subversion
		repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-ports-head">svn-ports-head</link></entry>
	      <entry xml:lang="en"><filename>/usr/ports</filename></entry>
	      <entry xml:lang="en">All changes to the <quote>head</quote> branch
		of the ports Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-ports-svnadmin">svn-ports-svnadmin</link></entry>
	      <entry xml:lang="en"><filename>/usr/ports</filename></entry>
	      <entry xml:lang="en">All changes to the administrative scripts, hooks,
		and other configuration data of the ports Subversion
		repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-all">svn-src-all</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the src Subversion repository
		(except for <filename>user</filename>
		and <filename>projects</filename>)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-head">svn-src-head</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the <quote>head</quote> branch
		of the src Subversion repository (the FreeBSD-CURRENT
		branch)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-projects">svn-src-projects</link></entry>
	      <entry xml:lang="en"><filename>/usr/projects</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>projects</filename>
		area of the src Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-release">svn-src-release</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>releases</filename>
		area of the src Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-releng">svn-src-releng</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>releng</filename>
		branches of the src Subversion repository (the
		security / release engineering branches)</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-stable">svn-src-stable</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the all stable branches of the src
		Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-stable-6">svn-src-stable-6</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>stable/6</filename>
		branch of the src Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-stable-7">svn-src-stable-7</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>stable/7</filename>
		branch of the src Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-stable-8">svn-src-stable-8</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>stable/8</filename>
		branch of the src Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-stable-9">svn-src-stable-9</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>stable/9</filename>
		branch of the src Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-stable-10">svn-src-stable-10</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>stable/10</filename>
		branch of the src Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-stable-11">svn-src-stable-11</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>stable/11</filename>
		branch of the src Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-stable-12">svn-src-stable-12</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the <filename>stable/12</filename>
		branch of the src Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-stable-other">svn-src-stable-other</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the
		older <filename>stable</filename> branches of the src
		Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-svnadmin">svn-src-svnadmin</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the administrative scripts, hooks,
		and other configuration data of the src Subversion
		repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-user">svn-src-user</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the
		experimental <filename>user</filename> area of the src
		Subversion repository</entry>
	    </row>

	    <row>
	      <entry xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/svn-src-vendor">svn-src-vendor</link></entry>
	      <entry xml:lang="en"><filename>/usr/src</filename></entry>
	      <entry xml:lang="en">All changes to the vendor work area of the src
		Subversion repository</entry>
	    </row>
	  </tbody>
	</tgroup>
      </informaltable>
    </sect2>

    <sect2 xml:id="eresources-subscribe">
      <title>如何訂閱</title>

      <para xml:lang="en">To subscribe to a list, click the list name at
	<link xlink:href="http://lists.FreeBSD.org/mailman/listinfo">http://lists.FreeBSD.org/mailman/listinfo</link>.  The page that is displayed should
	contain all of the necessary subscription instructions for
	that list.</para>

      <para xml:lang="en">To actually post to a given list, send mail to
	<email><replaceable>listname</replaceable>@FreeBSD.org</email>.
	It will then be redistributed to mailing list members
	world-wide.</para>

      <para xml:lang="en">To unsubscribe from a list, click on the URL found at the
	bottom of every email received from the list.  It is also
	possible to send an email to
	<email><replaceable>listname</replaceable>-unsubscribe@FreeBSD.org</email>
	to unsubscribe.</para>

      <para xml:lang="en">It is important to keep discussion in the technical
	mailing lists on a technical track.  To only receive important
	announcements, instead join the <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-announce">FreeBSD announcements mailing list</link>, which is
	intended for infrequent traffic.</para>
    </sect2>

    <sect2 xml:id="eresources-charters">
      <title>論壇章程</title>

      <para xml:lang="en"><emphasis>All</emphasis> FreeBSD mailing lists have certain
	basic rules which must be adhered to by anyone using them.
	Failure to comply with these guidelines will result in two (2)
	written warnings from the FreeBSD Postmaster
	<email>postmaster@FreeBSD.org</email>, after which, on a third
	offense, the poster will removed from all FreeBSD mailing lists
	and filtered from further posting to them.  We regret that
	such rules and measures are necessary at all, but today's
	Internet is a pretty harsh environment, it would seem, and
	many fail to appreciate just how fragile some of its
	mechanisms are.</para>

      <para xml:lang="en">Rules of the road:</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">The topic of any posting should adhere to the basic
	    charter of the list it is posted to.  If the list is about
	    technical issues, the posting should contain technical
	    discussion.  Ongoing irrelevant chatter or flaming only
	    detracts from the value of the mailing list for everyone
	    on it and will not be tolerated.  For free-form discussion
	    on no particular topic, the <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-chat">FreeBSD chat mailing list</link> is freely available
	    and should be used instead.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">No posting should be made to more than 2 mailing
	    lists, and only to 2 when a clear and obvious need to post
	    to both lists exists.  For most lists, there is already a
	    great deal of subscriber overlap and except for the most
	    esoteric mixes (say <quote>-stable &amp; -scsi</quote>),
	    there really is no reason to post to more than one list at
	    a time.  If a message is received with multiple mailing
	    lists on the <literal>Cc</literal> line, trim the
	    <literal>Cc</literal> line before replying.  <emphasis>The
	      person who replies is still responsible for
	      cross-posting, no matter who the originator might have
	      been.</emphasis></para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Personal attacks and profanity (in the context of an
	    argument) are not allowed, and that includes users and
	    developers alike.  Gross breaches of netiquette, like
	    excerpting or reposting private mail when permission to do
	    so was not and would not be forthcoming, are frowned upon
	    but not specifically enforced.
	    <emphasis>However</emphasis>, there are also very few
	    cases where such content would fit within the charter of a
	    list and it would therefore probably rate a warning (or
	    ban) on that basis alone.</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">Advertising of non-FreeBSD related products or services
	    is strictly prohibited and will result in an immediate ban
	    if it is clear that the offender is advertising by
	    spam.</para>
	</listitem>
      </itemizedlist>

      <para xml:lang="en"><emphasis>Individual list charters:</emphasis></para>

      <variablelist>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-acpi">freebsd-acpi</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>ACPI and power management
		development</emphasis></para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-afs">freebsd-afs</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Andrew File System</emphasis></para>

	    <para xml:lang="en">This list is for discussion on porting and using
	      AFS from CMU/Transarc</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-announce">freebsd-announce</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Important events /
		milestones</emphasis></para>

	    <para xml:lang="en">This is the mailing list for people interested only
	      in occasional announcements of significant FreeBSD events.
	      This includes announcements about snapshots and other
	      releases.  It contains announcements of new FreeBSD
	      capabilities.  It may contain calls for volunteers etc.
	      This is a low volume, strictly moderated mailing
	      list.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-arch">freebsd-arch</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Architecture and design
		discussions</emphasis></para>

	    <para xml:lang="en">This list is for discussion of the FreeBSD
	      architecture.  Messages will mostly be kept strictly
	      technical in nature.  Examples of suitable topics
	      are:</para>

	    <itemizedlist>
	      <listitem>
		<para xml:lang="en">How to re-vamp the build system to have several
		  customized builds running at the same time.</para>
	      </listitem>

	      <listitem>
		<para xml:lang="en">What needs to be fixed with VFS to make
		  Heidemann layers work.</para>
	      </listitem>

	      <listitem>
		<para xml:lang="en">How do we change the device driver interface
		  to be able to use the same drivers cleanly on many
		  buses and architectures.</para>
	      </listitem>

	      <listitem>
		<para xml:lang="en">How to write a network driver.</para>
	      </listitem>
	    </itemizedlist>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-bluetooth">freebsd-bluetooth</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis><trademark class="registered">Bluetooth</trademark> in FreeBSD</emphasis></para>

	    <para xml:lang="en">This is the forum where FreeBSD's <trademark class="registered">Bluetooth</trademark> users
	      congregate.  Design issues, implementation details,
	      patches, bug reports, status reports, feature requests,
	      and all matters related to <trademark class="registered">Bluetooth</trademark> are fair
	      game.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-bugbusters">freebsd-bugbusters</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Coordination of the Problem Report
		handling effort</emphasis></para>

	    <para xml:lang="en">The purpose of this list is to serve as a
	      coordination and discussion forum for the Bugmeister,
	      his Bugbusters, and any other parties who have a genuine
	      interest in the PR database.  This list is not for
	      discussions about specific bugs, patches or PRs.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-bugs">freebsd-bugs</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Bug reports</emphasis></para>

	    <para xml:lang="en">This is the mailing list for reporting bugs in FreeBSD.
	      Whenever possible, bugs should be submitted using the
	      <link xlink:href="https://bugs.freebsd.org/bugzilla/enter_bug.cgi">web
		interface</link> to it.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-chat">freebsd-chat</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Non technical items related to the FreeBSD
		community</emphasis></para>

	    <para xml:lang="en">This list contains the overflow from the other lists
	      about non-technical, social information.  It includes
	      discussion about whether Jordan looks like a toon ferret
	      or not, whether or not to type in capitals, who is
	      drinking too much coffee, where the best beer is brewed,
	      who is brewing beer in their basement, and so on.
	      Occasional announcements of important events (such as
	      upcoming parties, weddings, births, new jobs, etc) can
	      be made to the technical lists, but the follow ups
	      should be directed to this -chat list.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-chromium">freebsd-chromium</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>FreeBSD-specific Chromium
		issues</emphasis></para>

	    <para xml:lang="en">This is a list for the discussion of Chromium
	      support for FreeBSD.  This is a technical list to
	      discuss development and installation of Chromium.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-cloud">freebsd-cloud</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Running FreeBSD on various cloud
		platforms</emphasis></para>

	    <para xml:lang="en">This list discusses running FreeBSD on Amazon EC2,
	      Google Compute Engine, Microsoft Azure, and other cloud
	      computing platforms.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en">freebsd-core</term>

	  <listitem>
	    <para xml:lang="en"><emphasis>FreeBSD core team</emphasis></para>

	    <para xml:lang="en">This is an internal mailing list for use by the core
	      members.  Messages can be sent to it when a serious
	      FreeBSD-related matter requires arbitration or
	      high-level scrutiny.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-current">freebsd-current</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussions about the use of
		FreeBSD-CURRENT</emphasis></para>

	    <para xml:lang="en">This is the mailing list for users of FreeBSD-CURRENT.
	      It includes warnings about new features coming out in
	      -CURRENT that will affect the users, and instructions
	      on steps that must be taken to remain -CURRENT.  Anyone
	      running <quote>CURRENT</quote> must subscribe to this
	      list.  This is a technical mailing list for which
	      strictly technical content is expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-desktop">freebsd-desktop</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Using and improving FreeBSD on the
		desktop</emphasis></para>

	    <para xml:lang="en">This is a forum for discussion of FreeBSD on the
	      desktop.  It is primarily a place for desktop porters
	      and users to discuss issues and improve FreeBSD's desktop
	      support.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/dev-ci">dev-ci</link></term>
	  <listitem>
	    <para xml:lang="en"><emphasis>Continuous Integration reports of build
		and test results</emphasis></para>

	    <para xml:lang="en">All Continuous Integration reports of build and test
	      results</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/dev-reviews">dev-reviews</link></term>
	  <listitem>
	    <para xml:lang="en"><emphasis>Notifications of work in progress in
		FreeBSD's review tool</emphasis></para>

	    <para xml:lang="en">Automated notifications of work in progress for
	      review in FreeBSD's review tools, including
	      patches.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-doc">freebsd-doc</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Documentation Project</emphasis></para>

	    <para xml:lang="en">This mailing list is for the discussion of issues
	      and projects related to the creation of documentation
	      for FreeBSD.  The members of this mailing list are
	      collectively referred to as <quote>The FreeBSD
	      Documentation Project</quote>.  It is an open list; feel
	      free to join and contribute!</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-drivers">freebsd-drivers</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Writing device drivers for
		FreeBSD</emphasis></para>

	    <para xml:lang="en">This is a forum for technical discussions related to
	      device drivers on FreeBSD.  It is primarily a place for
	      device driver writers to ask questions about how to
	      write device drivers using the APIs in the FreeBSD
	      kernel.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-dtrace">freebsd-dtrace</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Using and working on DTrace in
		FreeBSD</emphasis></para>

	    <para xml:lang="en">DTrace is an integrated component of FreeBSD that
	      provides a framework for understanding the kernel as
	      well as user space programs at run time.  The mailing
	      list is an archived discussion for developers of the
	      code as well as those using it.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-eclipse">freebsd-eclipse</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>FreeBSD users of Eclipse IDE, tools, rich
		client applications and ports.</emphasis></para>

	    <para xml:lang="en">The intention of this list is to provide mutual
	      support for everything to do with choosing, installing,
	      using, developing and maintaining the Eclipse IDE,
	      tools, rich client applications on the FreeBSD platform and
	      assisting with the porting of Eclipse IDE and plugins to
	      the FreeBSD environment.</para>

	    <para xml:lang="en">The intention is also to facilitate exchange of
	      information between the Eclipse community and the FreeBSD
	      community to the mutual benefit of both.</para>

	    <para xml:lang="en">Although this list is focused primarily on the needs
	      of Eclipse users it will also provide a forum for those
	      who would like to develop FreeBSD specific applications
	      using the Eclipse framework.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-embedded">freebsd-embedded</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Using FreeBSD in embedded
		applications</emphasis></para>

	    <para xml:lang="en">This list discusses topics related to using FreeBSD in
	      embedded systems.  This is a technical mailing list for
	      which strictly technical content is expected.  For the
	      purpose of this list, embedded systems are those
	      computing devices which are not desktops and which
	      usually serve a single purpose as opposed to being
	      general computing environments.  Examples include, but
	      are not limited to, all kinds of phone handsets, network
	      equipment such as routers, switches and PBXs, remote
	      measuring equipment, PDAs, Point Of Sale systems, and so
	      on.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-emulation">freebsd-emulation</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Emulation of other systems such as
		Linux/<trademark class="registered">MS-DOS</trademark>/<trademark class="registered">Windows</trademark></emphasis></para>

	    <para xml:lang="en">This is a forum for technical discussions related
	      to running programs written for other operating systems
	      on FreeBSD.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-enlightenment">freebsd-enlightenment</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Enlightenment</emphasis></para>

	    <para xml:lang="en">Discussions concerning the
	      <application>Enlightenment</application> Desktop
	      Environment for FreeBSD systems.  This is a technical
	      mailing list for which strictly technical content is
	      expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-eol">freebsd-eol</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Peer support of FreeBSD-related software
		that is no longer supported by the FreeBSD
		Project.</emphasis></para>

	    <para xml:lang="en">This list is for those interested in providing or
	      making use of peer support of FreeBSD-related software for
	      which the FreeBSD Project no longer provides official
	      support in the form of security advisories and
	      patches.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-firewire">freebsd-firewire</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis><trademark class="registered">FireWire</trademark> (iLink, IEEE
		1394)</emphasis></para>

	    <para xml:lang="en">This is a mailing list for discussion of the design
	      and implementation of a <trademark class="registered">FireWire</trademark> (aka IEEE 1394 aka
	      iLink) subsystem for FreeBSD.  Relevant topics specifically
	      include the standards, bus devices and their protocols,
	      adapter boards/cards/chips sets, and the architecture
	      and implementation of code for their proper
	      support.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-fortran">freebsd-fortran</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Fortran on FreeBSD</emphasis></para>

	    <para xml:lang="en">This is the mailing list for discussion of Fortran
	      related ports on FreeBSD: compilers, libraries, scientific
	      and engineering applications from laptops to HPC
	      clusters.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-fs">freebsd-fs</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>File systems</emphasis></para>

	    <para xml:lang="en">Discussions concerning FreeBSD filesystems.  This is a
	      technical mailing list for which strictly technical
	      content is expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-games">freebsd-games</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Games on FreeBSD</emphasis></para>

	    <para xml:lang="en">This is a technical list for discussions related to
	      bringing games to FreeBSD.  It is for individuals actively
	      working on porting games to FreeBSD, to bring up problems
	      or discuss alternative solutions.  Individuals
	      interested in following the technical discussion are
	      also welcome.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-gecko">freebsd-gecko</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Gecko Rendering Engine</emphasis></para>

	    <para xml:lang="en">This is a forum about
	      <application>Gecko</application> applications using
	      FreeBSD.</para>

	    <para xml:lang="en">Discussion centers around Gecko Ports applications,
	      their installation, their development and their support
	      within FreeBSD.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-geom">freebsd-geom</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>GEOM</emphasis></para>

	    <para xml:lang="en">Discussions specific to GEOM and related
	      implementations.  This is a technical mailing list for
	      which strictly technical content is expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-git">freebsd-git</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Use of git in the FreeBSD
		project</emphasis></para>

	    <para xml:lang="en">Discussions of how to use git in FreeBSD
	      infrastructure including the github mirror and other
	      uses of git for project collaboration.  Discussion area
	      for people using git against the FreeBSD github mirror.
	      People wanting to get started with the mirror or git
	      in general on FreeBSD can ask here.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-gnome">freebsd-gnome</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>GNOME</emphasis></para>

	    <para xml:lang="en">Discussions concerning The
	      <application>GNOME</application> Desktop Environment
	      for FreeBSD systems.  This is a technical mailing list
	      for which strictly technical content is expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-infiniband">freebsd-infiniband</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Infiniband on FreeBSD</emphasis></para>

	    <para xml:lang="en">Technical mailing list discussing Infiniband, OFED,
	      and OpenSM on FreeBSD.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ipfw">freebsd-ipfw</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>IP Firewall</emphasis></para>

	    <para xml:lang="en">This is the forum for technical discussions
	      concerning the redesign of the IP firewall code in
	      FreeBSD.  This is a technical mailing list for which
	      strictly technical content is expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ia64">freebsd-ia64</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Porting FreeBSD to IA64</emphasis></para>

	    <para xml:lang="en">This is a technical mailing list for individuals
	      actively working on porting FreeBSD to the IA-64 platform
	      from <trademark class="registered">Intel</trademark>, to bring up problems or discuss
	      alternative solutions.  Individuals interested in
	      following the technical discussion are also
	      welcome.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-isdn">freebsd-isdn</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>ISDN Communications</emphasis></para>

	    <para xml:lang="en">This is the mailing list for people discussing the
	      development of ISDN support for FreeBSD.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-java">freebsd-java</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis><trademark>Java</trademark> Development</emphasis></para>

	    <para xml:lang="en">This is the mailing list for people discussing the
	      development of significant <trademark>Java</trademark> applications for FreeBSD
	      and the porting and maintenance of <trademark>JDK</trademark>s.</para>
	  </listitem>
	</varlistentry>

	<varlistentry xml:id="eresources-charters-jobs">
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-jobs">freebsd-jobs</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Jobs offered and sought</emphasis></para>

	    <para xml:lang="en">This is a forum for posting employment notices
	      specifically related to FreeBSD and resumes from those
	      seeking FreeBSD-related employment.  This is
	      <emphasis>not</emphasis> a mailing list for general
	      employment issues since adequate forums for that already
	      exist elsewhere.</para>

	    <para xml:lang="en">Note that this list, like other <systemitem class="fqdomainname">FreeBSD.org</systemitem>
	      mailing lists, is distributed worldwide.  Be clear about
	      the geographic location and the extent to which
	      telecommuting or assistance with relocation is
	      available.</para>

	    <para xml:lang="en">Email should use open formats only —
	      preferably plain text, but basic Portable Document
	      Format (<acronym>PDF</acronym>), HTML, and a few others
	      are acceptable to many readers.  Closed formats such as
	      <trademark class="registered">Microsoft</trademark> Word (<filename>.doc</filename>) will be
	      rejected by the mailing list server.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="https://mail.kde.org/mailman/listinfo/kde-freebsd">freebsd-kde</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>KDE</emphasis></para>

	    <para xml:lang="en">Discussions concerning
	      <application>KDE</application> on FreeBSD systems.
	      This is a technical mailing list for which strictly
	      technical content is expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-hackers">freebsd-hackers</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Technical discussions</emphasis></para>

	    <para xml:lang="en">This is a forum for technical discussions related
	      to FreeBSD.  This is the primary technical mailing list.
	      It is for individuals actively working on FreeBSD, to bring
	      up problems or discuss alternative solutions.
	      Individuals interested in following the technical
	      discussion are also welcome.  This is a technical
	      mailing list for which strictly technical content is
	      expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-hardware">freebsd-hardware</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>General discussion of FreeBSD
		hardware</emphasis></para>

	    <para xml:lang="en">General discussion about the types of hardware that
	      FreeBSD runs on, various problems and suggestions
	      concerning what to buy or avoid.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-hubs">freebsd-hubs</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Mirror sites</emphasis></para>

	    <para xml:lang="en">Announcements and discussion for people who run FreeBSD
	      mirror sites.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-isp">freebsd-isp</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Issues for Internet Service
		Providers</emphasis></para>

	    <para xml:lang="en">This mailing list is for discussing topics relevant
	      to Internet Service Providers (ISPs) using FreeBSD.  This
	      is a technical mailing list for which strictly technical
	      content is expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-mono">freebsd-mono</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Mono and C# applications on
		FreeBSD</emphasis></para>

	    <para xml:lang="en">This is a list for discussions related to the Mono
	      development framework on FreeBSD.  This is a technical
	      mailing list.  It is for individuals actively working on
	      porting Mono or C# applications to FreeBSD, to bring up
	      problems or discuss alternative solutions.  Individuals
	      interested in following the technical discussion are
	      also welcome.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ocaml">freebsd-ocaml</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>FreeBSD-specific OCaml
		discussions</emphasis></para>

	    <para xml:lang="en">This is a list for discussions related to the OCaml
	      support on FreeBSD.  This is a technical mailing list. It
	      is for individuals working on OCaml ports, 3rd party
	      libraries and frameworks.  Individuals interested in the
	      technical discussion are also welcome.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-office">freebsd-office</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Office applications on
		FreeBSD</emphasis></para>

	    <para xml:lang="en">Discussion centers around office applications, their
	      installation, their development and their support within
	      FreeBSD.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ops-announce">freebsd-ops-announce</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Project Infrastructure
		Announcements</emphasis></para>

	    <para xml:lang="en">This is the mailing list for people interested in
	      changes and issues related to the FreeBSD.org Project
	      infrastructure.</para>

	    <para xml:lang="en">This moderated list is strictly for announcements:
	      no replies, requests, discussions, or opinions.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-performance">freebsd-performance</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussions about tuning or speeding up
		FreeBSD</emphasis></para>

	    <para xml:lang="en">This mailing list exists to provide a place for
	      hackers, administrators, and/or concerned parties to
	      discuss performance related topics pertaining to FreeBSD.
	      Acceptable topics includes talking about FreeBSD
	      installations that are either under high load, are
	      experiencing performance problems, or are pushing the
	      limits of FreeBSD.  Concerned parties that are willing to
	      work toward improving the performance of FreeBSD are highly
	      encouraged to subscribe to this list.  This is a highly
	      technical list ideally suited for experienced FreeBSD
	      users, hackers, or administrators interested in keeping
	      FreeBSD fast, robust, and scalable.  This list is not a
	      question-and-answer list that replaces reading through
	      documentation, but it is a place to make contributions
	      or inquire about unanswered performance related
	      topics.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pf">freebsd-pf</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussion and questions about the packet
		filter firewall system</emphasis></para>

	    <para xml:lang="en">Discussion concerning the packet filter (pf)
	      firewall system in terms of FreeBSD.  Technical discussion
	      and user questions are both welcome.  This list is also
	      a place to discuss the ALTQ QoS framework.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pkg">freebsd-pkg</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Binary package management and package
		tools discussion</emphasis></para>

	    <para xml:lang="en">Discussion of all aspects of managing FreeBSD systems
	      by using binary packages to install software, including
	      binary package toolkits and formats, their development
	      and support within FreeBSD, package repository management,
	      and third party packages.</para>

	    <para xml:lang="en">Note that discussion of ports which fail to generate
	      packages correctly should generally be considered as
	      ports problems, and so inappropriate for this
	      list.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pkg-fallout">freebsd-pkg-fallout</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Fallout logs from package
		building</emphasis></para>

	    <para xml:lang="en">All packages building failures logs from the package
	      building clusters</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-pkgbase">freebsd-pkgbase</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Packaging the FreeBSD base
		system.</emphasis></para>

	    <para xml:lang="en">Discussions surrounding implementation and issues
	      regarding packaging the FreeBSD base system.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-platforms">freebsd-platforms</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Porting to Non <trademark class="registered">Intel</trademark>
		platforms</emphasis></para>

	    <para xml:lang="en">Cross-platform FreeBSD issues, general discussion and
	      proposals for non <trademark class="registered">Intel</trademark> FreeBSD ports.  This is a
	      technical mailing list for which strictly technical
	      content is expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ports">freebsd-ports</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussion of
		<quote>ports</quote></emphasis></para>

	    <para xml:lang="en">Discussions concerning FreeBSD's <quote>ports
		collection</quote> (<filename>/usr/ports</filename>),
	      ports infrastructure, and general ports coordination
	      efforts.  This is a technical mailing list for which
	      strictly technical content is expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ports-announce">freebsd-ports-announce</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Important news and instructions about the
		FreeBSD <quote>Ports
		  Collection</quote></emphasis></para>

	    <para xml:lang="en">Important news for developers, porters, and users of
	      the <quote>Ports Collection</quote>
	      (<filename>/usr/ports</filename>), including
	      architecture/infrastructure changes, new capabilities,
	      critical upgrade instructions, and release engineering
	      information.  This is a low-volume mailing list,
	      intended for announcements.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ports-bugs">freebsd-ports-bugs</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussion of
		<quote>ports</quote> bugs</emphasis></para>

	    <para xml:lang="en">Discussions concerning problem reports for FreeBSD's
	      <quote>ports collection</quote>
	      (<filename>/usr/ports</filename>), proposed ports, or
	      modifications to ports.  This is a technical mailing
	      list for which strictly technical content is
	      expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-proliant">freebsd-proliant</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Technical discussion of FreeBSD on HP
		ProLiant server platforms</emphasis></para>

	    <para xml:lang="en">This mailing list is to be used for the technical
	      discussion of the usage of FreeBSD on HP ProLiant servers,
	      including the discussion of ProLiant-specific drivers,
	      management software, configuration tools, and BIOS
	      updates.  As such, this is the primary place to discuss
	      the hpasmd, hpasmcli, and hpacucli modules.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-python">freebsd-python</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Python on FreeBSD</emphasis></para>

	    <para xml:lang="en">This is a list for discussions related to improving
	      Python-support on FreeBSD.  This is a technical mailing
	      list.  It is for individuals working on porting Python,
	      its third party modules and
	      <application>Zope</application> stuff to FreeBSD.
	      Individuals interested in following the technical
	      discussion are also welcome.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-questions">freebsd-questions</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>User questions</emphasis></para>

	    <para xml:lang="en">This is the mailing list for questions about FreeBSD.
	      Do not send <quote>how to</quote> questions to the
	      technical lists unless the question is quite
	      technical.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-ruby">freebsd-ruby</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>FreeBSD-specific Ruby
		discussions</emphasis></para>

	    <para xml:lang="en">This is a list for discussions related to the Ruby
	      support on FreeBSD.  This is a technical mailing list.  It
	      is for individuals working on Ruby ports, third party
	      libraries and frameworks.</para>

	    <para xml:lang="en">Individuals interested in the technical discussion
	      are also welcome.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-scsi">freebsd-scsi</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>SCSI subsystem</emphasis></para>

	    <para xml:lang="en">This is the mailing list for people working on the
	      SCSI subsystem for FreeBSD.  This is a technical mailing
	      list for which strictly technical content is
	      expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-security">freebsd-security</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Security issues</emphasis></para>

	    <para xml:lang="en">FreeBSD computer security issues (DES, Kerberos, known
	      security holes and fixes, etc).  This is a technical
	      mailing list for which strictly technical discussion is
	      expected.  Note that this is not a question-and-answer
	      list, but that contributions (BOTH question AND answer)
	      to the FAQ are welcome.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-security-notifications">freebsd-security-notifications</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Security Notifications</emphasis></para>

	    <para xml:lang="en">Notifications of FreeBSD security problems and fixes.
	      This is not a discussion list.  The discussion list is
	      FreeBSD-security.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-small">freebsd-small</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Using FreeBSD in embedded
		applications</emphasis></para>

	    <para xml:lang="en">This list discusses topics related to unusually
	      small and embedded FreeBSD installations.  This is a
	      technical mailing list for which strictly technical
	      content is expected.</para>

	    <note>
	      <para xml:lang="en">This list has been obsoleted by
		<link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-embedded">freebsd-embedded</link>.</para>
	    </note>

	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-snapshots">freebsd-snapshots</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>FreeBSD Development Snapshot
		Announcements</emphasis></para>

	    <para xml:lang="en">This list provides notifications about the
	      availability of new FreeBSD development snapshots for the
	      head/ and stable/ branches.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-stable">freebsd-stable</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussions about the use of
		FreeBSD-STABLE</emphasis></para>

	    <para xml:lang="en">This is the mailing list for users of FreeBSD-STABLE.
	      <quote>STABLE</quote> is the branch where development
	      continues after a RELEASE, including bug fixes and new
	      features.  The ABI is kept stable for binary
	      compatibility.  It includes warnings about new features
	      coming out in -STABLE that will affect the users, and
	      instructions on steps that must be taken to remain
	      -STABLE.  Anyone running <quote>STABLE</quote> should
	      subscribe to this list.  This is a technical mailing
	      list for which strictly technical content is
	      expected.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-standards">freebsd-standards</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>C99 &amp; POSIX
		Conformance</emphasis></para>

	    <para xml:lang="en">This is a forum for technical discussions related to
	      FreeBSD Conformance to the C99 and the POSIX
	      standards.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-teaching">freebsd-teaching</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Teaching with FreeBSD</emphasis></para>

	    <para xml:lang="en">Non technical mailing list discussing teaching
	      with FreeBSD.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-testing">freebsd-testing</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Testing on FreeBSD</emphasis></para>

	    <para xml:lang="en">Technical mailing list discussing testing on FreeBSD,
	      including ATF/Kyua, test build infrastructure, port
	      tests to FreeBSD from other operating systems (NetBSD,
	      ...), etc.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-tex">freebsd-tex</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Porting <application>TeX</application> and
		its applications to FreeBSD</emphasis></para>

	    <para xml:lang="en">This is a technical mailing list for discussions
	      related to TeX and its applications on FreeBSD.  It is for
	      individuals actively working on porting TeX to FreeBSD,
	      to bring up problems or discuss alternative solutions.
	      Individuals interested in following the technical
	      discussion are also welcome.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-toolchain">freebsd-toolchain</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Maintenance of FreeBSD's integrated
		toolchain</emphasis></para>

	    <para xml:lang="en">This is the mailing list for discussions related to
	      the maintenance of the toolchain shipped with FreeBSD.
	      This could include the state of Clang and GCC, but also
	      pieces of software such as assemblers, linkers and
	      debuggers.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-transport">freebsd-transport</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussions of transport level network
		protocols in FreeBSD</emphasis></para>

	    <para xml:lang="en">The transport mailing list exists for the discussion
	      of issues and designs around the transport level
	      protocols in the FreeBSD network stack, including TCP,
	      SCTP and UDP.  Other networking topics, including
	      driver specific and network protocol issues should be
	      discussed on the <link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-net">FreeBSD networking mailing list</link>.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-translators">freebsd-translators</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Translating FreeBSD documents and
		programs</emphasis></para>

	    <para xml:lang="en">A discussion list where translators of FreeBSD
	      documents from English into other languages can talk
	      about translation methods and tools.  New members are
	      asked to introduce themselves and mention the languages
	      they are interested in translating.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-usb">freebsd-usb</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussing FreeBSD support for
		USB</emphasis></para>

	    <para xml:lang="en">This is a mailing list for technical discussions
	      related to FreeBSD support for USB.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-user-groups">freebsd-user-groups</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>User Group Coordination
		List</emphasis></para>

	    <para xml:lang="en">This is the mailing list for the coordinators from
	      each of the local area Users Groups to discuss matters
	      with each other and a designated individual from the
	      Core Team.  This mail list should be limited to meeting
	      synopsis and coordination of projects that span User
	      Groups.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-virtualization">freebsd-virtualization</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussion of various virtualization
		techniques supported by FreeBSD</emphasis></para>

	    <para xml:lang="en">A list to discuss the various virtualization
	      techniques supported by FreeBSD.  On one hand the focus
	      will be on the implementation of the basic functionality
	      as well as adding new features.  On the other hand users
	      will have a forum to ask for help in case of problems or
	      to discuss their use cases.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-wip-status">freebsd-wip-status</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>FreeBSD Work-In-Progress
		Status</emphasis></para>

	    <para xml:lang="en">This mailing list can be used by developers to
	      announce the creation and progress of FreeBSD related work.
	      Messages will be moderated.  It is suggested to send the
	      message "To:" a more topical FreeBSD list and only "BCC:"
	      this list.  This way the WIP can also be discussed on
	      the topical list, as no discussion is allowed on this
	      list.</para>

	    <para xml:lang="en">Look inside the archives for examples of suitable
	      messages.</para>

	    <para xml:lang="en">An editorial digest of the messages to this list
	      might be posted to the FreeBSD website every few months as
	      part of the Status Reports
	      <footnote><para xml:lang="en"><uri xlink:href="https://www.freebsd.org/news/status/">https://www.freebsd.org/news/status/</uri></para></footnote>.
	      Past reports are archived.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-wireless">freebsd-wireless</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussions of 802.11 stack, tools device
		driver development</emphasis></para>

	    <para xml:lang="en">The FreeBSD-wireless list focuses on 802.11 stack
	      (sys/net80211), device driver and tools development.
	      This includes bugs, new features and maintenance.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-xen">freebsd-xen</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Discussion of the FreeBSD port to <trademark>Xen</trademark>
		— implementation and usage</emphasis></para>

	    <para xml:lang="en">A list that focuses on the FreeBSD <trademark>Xen</trademark> port.  The
	      anticipated traffic level is small enough that it is
	      intended as a forum for both technical discussions of
	      the implementation and design details as well as
	      administrative deployment issues.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-xfce">freebsd-xfce</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>XFCE</emphasis></para>

	    <para xml:lang="en">This is a forum for discussions related to bring the
	      <application>XFCE</application> environment to FreeBSD.
	      This is a technical mailing list.  It is for individuals
	      actively working on porting
	      <application>XFCE</application> to FreeBSD, to bring up
	      problems or discuss alternative solutions.  Individuals
	      interested in following the technical discussion are
	      also welcome.</para>
	  </listitem>
	</varlistentry>

	<varlistentry>
	  <term xml:lang="en"><link xlink:href="http://lists.FreeBSD.org/mailman/listinfo/freebsd-zope">freebsd-zope</link></term>

	  <listitem>
	    <para xml:lang="en"><emphasis>Zope</emphasis></para>

	    <para xml:lang="en">This is a forum for discussions related to bring the
	      <application>Zope</application> environment to FreeBSD.
	      This is a technical mailing list.  It is for individuals
	      actively working on porting
	      <application>Zope</application> to FreeBSD, to bring up
	      problems or discuss alternative solutions.  Individuals
	      interested in following the technical discussion are
	      also welcome.</para>
	  </listitem>
	</varlistentry>
      </variablelist>
    </sect2>

    <sect2 xml:id="eresources-mailfiltering">
      <title>郵遞論壇過濾項目</title>

      <para xml:lang="en">The FreeBSD mailing lists are filtered in multiple ways to
	avoid the distribution of spam, viruses, and other unwanted
	emails.  The filtering actions described in this section do
	not include all those used to protect the mailing
	lists.</para>

      <para xml:lang="en">Only certain types of attachments are allowed on the
	mailing lists.  All attachments with a MIME content type not
	found in the list below will be stripped before an email is
	distributed on the mailing lists.</para>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en">application/octet-stream</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">application/pdf</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">application/pgp-signature</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">application/x-pkcs7-signature</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">message/rfc822</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">multipart/alternative</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">multipart/related</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">multipart/signed</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">text/html</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">text/plain</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">text/x-diff</para>
	</listitem>

	<listitem>
	  <para xml:lang="en">text/x-patch</para>
	</listitem>
      </itemizedlist>

      <note>
	<para xml:lang="en">Some of the mailing lists might allow attachments of
	  other MIME content types, but the above list should be
	  applicable for most of the mailing lists.</para>
      </note>

      <para xml:lang="en">If an email contains both an HTML and a plain text
	version, the HTML version will be removed.  If an email
	contains only an HTML version, it will be converted to plain
	text.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="eresources-news">
    <title>Usenet 新聞群組</title>

    <para xml:lang="en">In addition to two FreeBSD specific newsgroups, there are
      many others in which FreeBSD is discussed or are otherwise
      relevant to FreeBSD users.</para>

    <sect2>
      <title>BSD 專屬新聞群組</title>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><link xlink:href="news:comp.unix.bsd.freebsd.announce">comp.unix.bsd.freebsd.announce</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="news:comp.unix.bsd.freebsd.misc">comp.unix.bsd.freebsd.misc</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="news:de.comp.os.unix.bsd">de.comp.os.unix.bsd</link>
	    (German)</para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="news:fr.comp.os.bsd">fr.comp.os.bsd</link>
	    (French)</para>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2>
      <title>其他相關的 <trademark class="registered">UNIX</trademark> 新聞群組</title>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><link xlink:href="news:comp.unix">comp.unix</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="news:comp.unix.questions">comp.unix.questions</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="news:comp.unix.admin">comp.unix.admin</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="news:comp.unix.programmer">comp.unix.programmer</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="news:comp.unix.shell">comp.unix.shell</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="news:comp.unix.misc">comp.unix.misc</link></para>
	</listitem>

	<listitem>
	  <para xml:lang="en"><link xlink:href="news:comp.unix.bsd">comp.unix.bsd</link></para>
	</listitem>
      </itemizedlist>
    </sect2>

    <sect2>
      <title>X 視窗系統</title>

      <itemizedlist>
	<listitem>
	  <para xml:lang="en"><link xlink:href="news:comp.windows.x">comp.windows.x</link></para>
	</listitem>
      </itemizedlist>
    </sect2>
  </sect1>

  <sect1 xml:id="eresources-web">
    <title>官方鏡像站</title>

    
<para><link linkend="central-www">中央伺服器</link>、<link linkend="mirrors-am-www">亞美尼亞 (Armenia)</link>、<link linkend="mirrors-au-www">澳洲 (Australia)</link>、<link linkend="mirrors-at-www">奧地利 (Austria)</link>、<link linkend="mirrors-cz-www">捷克 (Czech Republic)</link>、<link linkend="mirrors-dk-www">丹麥 (Denmark)</link>、<link linkend="mirrors-fi-www">芬蘭 (Finland)</link>、<link linkend="mirrors-fr-www">法國 (France)</link>、<link linkend="mirrors-de-www">德國 (Germany)</link>、<link linkend="mirrors-hk-www">香港 (Hong Kong)</link>、<link linkend="mirrors-ie-www">愛爾蘭 (Ireland)</link>、<link linkend="mirrors-jp-www">日本 (Japan)</link>、<link linkend="mirrors-lv-www">拉脫維亞 (Latvia)</link>、<link linkend="mirrors-lt-www">立陶宛 (Lithuania)</link>、<link linkend="mirrors-nl-www">荷蘭 (Netherlands)</link>、<link linkend="mirrors-no-www">挪威 (Norway)</link>、<link linkend="mirrors-ru-www">俄羅斯 (Russia)</link>、<link linkend="mirrors-si-www">斯洛維尼亞 (Slovenia)</link>、<link linkend="mirrors-za-www">南非 (South Africa)</link>、<link linkend="mirrors-es-www">西班牙 (Spain)</link>、<link linkend="mirrors-se-www">瑞典 (Sweden)</link>、<link linkend="mirrors-ch-www">瑞士 (Switzerland)</link>、<link linkend="mirrors-tw-www">台灣 (Taiwan)</link>、<link linkend="mirrors-uk-www">英國 (United Kingdom)</link>、<link linkend="mirrors-us-www">美國 (USA)</link>。</para>


    
<para xml:lang="en">(as of   UTC)</para>


    
<itemizedlist>
  <listitem>
    <anchor xml:id="central-www"/>
    <para>中央伺服器</para>
    <itemizedlist>
      <listitem>
        <para><link xlink:href="https://www.FreeBSD.org/">https://www.FreeBSD.org/</link></para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-am-www"/>
    <para>亞美尼亞 (Armenia)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en"><link xlink:href="http://www1.am.FreeBSD.org/">http://www1.am.FreeBSD.org/</link> (IPv6)</para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-au-www"/>
    <para>澳洲 (Australia)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.au.FreeBSD.org/">http://www.au.FreeBSD.org/</link>
        </para>
      </listitem>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www2.au.FreeBSD.org/">http://www2.au.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-at-www"/>
    <para>奧地利 (Austria)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en"><link xlink:href="http://www.at.FreeBSD.org/">http://www.at.FreeBSD.org/</link> (IPv6)</para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-cz-www"/>
    <para>捷克 (Czech Republic)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en"><link xlink:href="http://www.cz.FreeBSD.org/">http://www.cz.FreeBSD.org/</link> (IPv6)</para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-dk-www"/>
    <para>丹麥 (Denmark)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en"><link xlink:href="http://www.dk.FreeBSD.org/">http://www.dk.FreeBSD.org/</link> (IPv6)</para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-fi-www"/>
    <para>芬蘭 (Finland)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.fi.FreeBSD.org/">http://www.fi.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-fr-www"/>
    <para>法國 (France)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www1.fr.FreeBSD.org/">http://www1.fr.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-de-www"/>
    <para>德國 (Germany)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.de.FreeBSD.org/">http://www.de.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-hk-www"/>
    <para>香港 (Hong Kong)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.hk.FreeBSD.org/">http://www.hk.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-ie-www"/>
    <para>愛爾蘭 (Ireland)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.ie.FreeBSD.org/">http://www.ie.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-jp-www"/>
    <para>日本 (Japan)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en"><link xlink:href="http://www.jp.FreeBSD.org/www.FreeBSD.org/">http://www.jp.FreeBSD.org/www.FreeBSD.org/</link> (IPv6)</para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-lv-www"/>
    <para>拉脫維亞 (Latvia)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.lv.FreeBSD.org/">http://www.lv.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-lt-www"/>
    <para>立陶宛 (Lithuania)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.lt.FreeBSD.org/">http://www.lt.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-nl-www"/>
    <para>荷蘭 (Netherlands)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.nl.FreeBSD.org/">http://www.nl.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-no-www"/>
    <para>挪威 (Norway)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.no.FreeBSD.org/">http://www.no.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-ru-www"/>
    <para>俄羅斯 (Russia)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en"><link xlink:href="http://www.ru.FreeBSD.org/">http://www.ru.FreeBSD.org/</link> (IPv6)</para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-si-www"/>
    <para>斯洛維尼亞 (Slovenia)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.si.FreeBSD.org/">http://www.si.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-za-www"/>
    <para>南非 (South Africa)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.za.FreeBSD.org/">http://www.za.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-es-www"/>
    <para>西班牙 (Spain)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.es.FreeBSD.org/">http://www.es.FreeBSD.org/</link>
        </para>
      </listitem>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www2.es.FreeBSD.org/">http://www2.es.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-se-www"/>
    <para>瑞典 (Sweden)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.se.FreeBSD.org/">http://www.se.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-ch-www"/>
    <para>瑞士 (Switzerland)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en"><link xlink:href="http://www.ch.FreeBSD.org/">http://www.ch.FreeBSD.org/</link> (IPv6)</para>
      </listitem>
      <listitem>
        <para xml:lang="en"><link xlink:href="http://www2.ch.FreeBSD.org/">http://www2.ch.FreeBSD.org/</link> (IPv6)</para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-tw-www"/>
    <para>台灣 (Taiwan)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www.tw.FreeBSD.org/">http://www.tw.FreeBSD.org/</link>
        </para>
      </listitem>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www2.tw.FreeBSD.org/">http://www2.tw.FreeBSD.org/</link>
        </para>
      </listitem>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www4.tw.FreeBSD.org/">http://www4.tw.FreeBSD.org/</link>
        </para>
      </listitem>
      <listitem>
        <para xml:lang="en"><link xlink:href="http://www5.tw.FreeBSD.org/">http://www5.tw.FreeBSD.org/</link> (IPv6)</para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-uk-www"/>
    <para>英國 (United Kingdom)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www1.uk.FreeBSD.org/">http://www1.uk.FreeBSD.org/</link>
        </para>
      </listitem>
      <listitem>
        <para xml:lang="en">
          <link xlink:href="http://www3.uk.FreeBSD.org/">http://www3.uk.FreeBSD.org/</link>
        </para>
      </listitem>
    </itemizedlist>
  </listitem>
  <listitem>
    <anchor xml:id="mirrors-us-www"/>
    <para>美國 (USA)</para>
    <itemizedlist>
      <listitem>
        <para xml:lang="en"><link xlink:href="http://www5.us.FreeBSD.org/">http://www5.us.FreeBSD.org/</link> (IPv6)</para>
      </listitem>
    </itemizedlist>
  </listitem>
</itemizedlist>

  </sect1>
</appendix>

    
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<!--

  Do not edit this file except as instructed by the addkey.sh script.

  See the README file in head/share/pgpkeys for instructions.

  Note that only officer keys are shown here now.  All of the keys are
  shown in en_US.ISO8859-1/articles/pgpkeys/article.xml.

-->
<appendix version="5.0" xml:id="pgpkeys">
  <title>Open<acronym>PGP</acronym> 金鑰</title>

  <indexterm xml:lang="en"><primary>pgp keys</primary></indexterm>

  <para xml:lang="en">The Open<acronym>PGP</acronym> keys of the
    <systemitem class="fqdomainname">FreeBSD.org</systemitem> officers
    are shown here.  These keys can be used to verify a signature or
    send encrypted email to one of the officers.  A full list of FreeBSD
    Open<acronym>PGP</acronym> keys is available in the
    <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/pgpkeys"><acronym>PGP</acronym>
      Keys</link> article.  The complete keyring can be downloaded
    at <link xlink:href="https://www.FreeBSD.org/doc/pgpkeyring.txt">https://www.FreeBSD.org/doc/pgpkeyring.txt</link>.</para>

  <sect1 xml:id="pgpkeys-officers">
    <title>人員</title>

    <!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->

    <sect2 xml:id="pgpkey-security-officer">
      <title>Security Officer Team <email>security-officer@FreeBSD.org</email></title>
      <!-- $FreeBSD$ -->
<!--
sh addkey.sh security-officer D39792F49EA7E5C2 ;
-->
<programlisting role="pgpfingerprint"><![CDATA[
pub   rsa4096/D39792F49EA7E5C2 2017-08-16 [SC] [expires: 2023-01-02]
      Key fingerprint = FC0E 878A E5AF E788 028D  6355 D397 92F4 9EA7 E5C2
uid                            FreeBSD Security Officer <security-officer@FreeBSD.org>
sub   rsa4096/6DD0A349F26ADEFD 2017-08-16 [E] [expires: 2023-01-02]

]]></programlisting>
<programlisting role="pgpkey"><![CDATA[
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBFmT2+ABEACrTVJ7Z/MuDeyKFqoTFnm5FrGG55k66RLeKivzQzq/tT/6RKO9
K8DaEvSIqD9b0/xgK02KgLSdp0Bucq8HLDFYUk3McFa6Z3YwjobNCWkxc72ipvVl
uAOGN4H6fuoYOpeg4cLK1H9pktUIrzONTCixaZzc/Bu6X+aX4ywGeCfsuu8g5v03
fLCPBLLgf3Bm5wsyZ6ZaGmsmILrWzd+d/rbr35Mcc5BekdgywUI4R191qo1bdrw9
mEJP1V7Ik3jpExOsNnuhMTvm5OQMeCTfUvVEOtBU15QtbT+1LXF5FIOgML0LwS5v
RHZN+5w/xvzSnEULpj24UuMKLDs/u9rj8U/zET8QaE+oG7m/mr4jJWZEmdX8HKdO
WrpnVj6UAppk72qdBIEfLsOW2xB/NOjJpppbCQH3+sw7DRYA2UnKE9Mptj/KKiE4
cs4c8Cupo2WSu93lEZDC5rCrULpT2lFeEXnRYlC/5oIgY5w9sFide9VI4CzHkkWX
Z2NPW/i1w3mFhoXjvnNLGOYMfAMKPxsRC2/Bn3bY0IhKvuIZ4rAeu7FTmKDDqFKQ
YEcrUOW74ZVng17AB29xzjWr4zNJVvp/CybFiUb8JoKkwtVWRqAVZIEgenAjU40d
G5+W4e+ccL0mfTQfEBbXRjnL2BL2tnaoBR42cTfbZGRucPHz7MrlKBEeZQARAQAB
tDdGcmVlQlNEIFNlY3VyaXR5IE9mZmljZXIgPHNlY3VyaXR5LW9mZmljZXJARnJl
ZUJTRC5vcmc+iQJUBBMBCgA+FiEE/A6HiuWv54gCjWNV05eS9J6n5cIFAlmT2+AC
GwMFCQoek4AFCwkIBwMFFQoJCAsFFgIDAQACHgECF4AACgkQ05eS9J6n5cKd9A/9
Fz3uGjNy28D0ALT1d/JJGzdQ2R3YwspHk9KHBr1LePkog9wf1WRalwCeNtPmA+g5
cn24psuzOeh1tRElImTZ2eE2ENPZ9XzK/J0ok0nK42MvmIwmMCyz+CaWv9GXW+FK
0oXnFmHi4YaQUVN3p+45TGkD9T+O5biVww7P47n/NnWsTfhLx0bzC7LyjPKXINai
/LgPgtlcOgY65/YhW/qhADCkoU7qMp9is41jMjTu1WB3OBPJkUkNpHfu6r15y8FN
Wqsk7K4W6Obr/WQ6VKGGXgh/a5mTcaEoFGMO16uHijAY4nXeb2HGZlBKxgmPH9Ur
aT4A9Pz/n+rIRMrK+rs+msFPemQHHNBYxy+x99uBpRBNyT2Su6GouZIxu5J16aIM
V0ZyOy/dy7m/uJ4sMhJPqKkd8a+MoQs/2L1M1y1EAzsO/QZqIrKrCluaftNN9k/B
qU0XClSDqB6sRMF7HFzYqb+f+M6cwSL/3Cp1Yx4rZ/onEE/MdWp64+3R87dETTXd
5tWXQw04qOhfPri5cBTI7r3t/qMO1iNXCGSG5RJbGkas6N6t6Mj83L4ItjI8doLf
aSIWZjj1XP3/me2hFJ6h2G5y5A+khO4ZwhC0ATFSq1fYbVGHw5AtfthIgNn8FoWu
+Sb8h7/RqTr7F6LgWagAoAh0GtVj02SVABZjcNZz/AKJAjcEEAEKACEWIQQc9/9v
rfXKn74bjLLtZ+zWXc9q5wUCWZPcTAMFAngACgkQ7Wfs1l3PauflkRAAgYcaBX0Y
ic4btxKoP/eOVpgUciOPPKEhDCiloQDyf4XQnZFDoMfjgcHpbLTBZ6kiAz2UzDGr
fJ4yUqrD+xfixUfCd5YpwzsaSpCGzDzSxOBcP/SpuAFhe40awSOIf5MruQar9Mlf
33JyslDLULXXeewAq2pcGk0/WrrOragI6Cs2vPGy9XP96VvLxyhjrWjlKmnO+//w
UF8oIO5hhKoqbtoxxlcqJgsWVyHch0mnPzvr6GWwoPhFXocnh1oPdbLjX1AwmGm9
ltEYMge4QxONIXlXJR0TvuDuJOaLNvTOC3OI8L97fdBcZS7eNJrG5FAYR5Ft3ISf
KJowIsSLGDt/cYApqpyP2pv7FpCvnwHgXHYar7/q4zhngCFRxQ2DPUx1cIJQ3Bgh
HZolKyK1X7XE5ZVDfZ3s3gcHSVKS89pipgHHZNr4sSmOanA8rXHcyHS4o2zSi1ie
r4iBwnOk6cCd6UNzEIiq0y/XhP/sc7xeL0mn3wDuV7jDBP9sp65sexL1qtIAfnzL
pLQevm0z41ifrUH5nNeL6RdbXpaoXc8M4PJJeQKJDu04KzLcQpZdUdCJsbS6QO9w
srWR8enQXPEhz2CO4L77bM9TgYO29222jTqEPcbXcmxF/klxO1rpssTTHUnHHi1Z
LUGYCbZPjt+laTJ2YPHTjUtN1Jw85vSKCEuJATMEEAEKAB0WIQS7KNQLNg7uk2rt
FW/l97zLo73d+AUCWjSYRwAKCRDl97zLo73d+JKyB/9N5Ytao12nD5QzMLvceGh5
otCLN99TUryYiDVDLoNkBivq3jHQA/hOX2rwEueFq0+LF8/2DnglJuUICNtCxIzL
WXXf/Hr5iWBUQ0JxYNPQzzjdMSXGE0WMwYVpAbCGxHpIsetKLdHUCwneYhaywe3I
KzmRJSDJGV1IJB0sAfoFtgybZXHgIR61jQjtnNmmyYXliYCd0wmIhXQDFN91tzzG
+EZdJ3Fao9JsMC+x55jO6EOLVySZgRF5E8vCeKUWemQciKFC7EhKcljILPYAA21u
NmHCAgRHKWU9JMdFK0w9lQuN2HQaNfkahjarTNM/Q6LwxY0dLG0vVYifE085WFAf
uQINBFmT2+ABEACxi39m5nQZexzY3c9sg/w5mUYCD89ZNSkj427gduQMYYGn7YW6
jSPfVJ/V3+PDK824c0a0XasyDapQFY1CPTZYrReRPoyjb8tJjsSVGXXCTFpJZlFU
br6kS9mgcx58Sypke2PMVk73+W1N1Yco+nahfTECRuM2/T2zHHr0AdKuBPF28U+H
TxyLatKoIgQwHDs4E/f4ZTbAoHvu3PixAl7XHVXCgz0cHaLhRljXizbZDXngOdGm
lqdFlAIpL6/l8E3m1Er0m3IfFo6qSzWRHg/KaBGIL4YKetJ6ACjlkCe5qbatDpmk
gWlg3Ux4RBVjyCK834Xh7eZpEcNf2iwpm28glWh7XMHGUplTHkU3PWQ4vGfNxXB8
HBOd9r02/cHL6MiHwhCAfIzZGVtqR0i9Ira57TMdXTpJWNXUcgsCMsi/Bg2a+hsn
aiYLrZc18uNL5nqOqsqKG3c1TcmeN7nbxVgnrNST4AjteulkhmB9p8tNOXA3u979
OO0T5LPwdqIpobdZ0lfw4URnAGw4Wd4Sm9PtRw0RvuAk2M2e5KXNyxPWAuMVkoRR
a7wG6h/R8pki54Gexyc+JkfB4ZcOrzHNLurw6DhxroyfRs8WEgX0wNIGmJvCXSBG
54jb5w9qudYwzIg4YPfvuX8sfeY8MTNhal3rF0tvVloGj3l709wlaWlBYwARAQAB
iQI8BBgBCgAmFiEE/A6HiuWv54gCjWNV05eS9J6n5cIFAlmT2+ACGwwFCQoek4AA
CgkQ05eS9J6n5cKhWw/+PT0R4r2gPAxI8ESEe380BYOmneNAH24MFOgWXqWCj4zX
Uz992BVnW2aL5nH4O5d822LGeCrYUC7SCpQvlifdHZHjobgtizLTwuu40bc3gSOz
cxWlx2jKfx3Ezn6QQz2mhhK6fZ1AO0ObiQxQq25ldURep95L78E/C8XkCe11YlUR
ng3wQKeHM7awZWRw/QBC92haHuVtU3cx7At+zQL7jTBKSZqd34zzs0uoXIhk2h94
O07MMDZ8z8MeU337vdL+RKYtD2bljLwpf7/kqg1D/q44RJ4ZpZcha9G0GvtLaQg2
+MAPlLg1vOWZ8wOTLaQHm+uzYRpkqxkIV8OuVd4UikCd8t3VNjNG5rG/YRNIAX0A
UEzs6oMF5YOFE8LmykesbUHAbC07Vcb0AsT5u3XKixDiIpPdnYSwGlkvoOVVLdeh
q/aXLK9V8BpViG5+a8xP2fdF1eMqdnrKAsiO4GEiq193PN/FA049VeIs3fd0izAa
x7+ag1MGtoF5Pij5iTVJm6phH5SUd1P3FY3OmclxWj/MbL4ba/G/6FWcy5NXxdw9
L1bRqaM2KEHJ67aF6NZz7UMldwExAWzFbUon1LUpKysAukxVf0EnntydBeVOQ+JO
HdqEpirrVLMpxPttUB2xxbo947nMj7/Bnme2gvb0vxaC9xSGVxrpW9cg5iCwSdc=
=8rds
-----END PGP PUBLIC KEY BLOCK-----
]]></programlisting>

    </sect2>

    <sect2 xml:id="pgpkey-secteam-secretary">
      <title>Security Team Secretary <email>secteam-secretary@FreeBSD.org</email></title>
      <!-- $FreeBSD$ -->
<!--
sh addkey.sh secteam-secretary 3CB2EAFCC3D6C666;
-->
<programlisting role="pgpfingerprint"><![CDATA[
pub   4096R/3CB2EAFCC3D6C666 2013-09-24 [expires: 2018-01-01]
      Key fingerprint = FA97 AA04 4DF9 0969 D5EF  4ADA 3CB2 EAFC C3D6 C666
uid                          FreeBSD Security Team Secretary <secteam-secretary@FreeBSD.org>
sub   4096R/509B26612335EB65 2013-09-24 [expires: 2018-01-01]
]]></programlisting>
<programlisting role="pgpkey"><![CDATA[
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBFJBjIIBEADadvvpXSkdnBOGV2xcsFwBBcSwAdryWuLk6v2VxjwsPcY6Lwqz
NAZr2Ox1BaSgX7106Psa6v9si8nxoOtMc5BCM/ps/fmedFU48YtqOTGF+utxvACg
Ou6SKintEMUa1eoPcww1jzDZ3mxx49bQaNAJLjVxeiAZoYHe9loTe1fxsprCONnx
Era1hrI+YA2KjMWDORcwa0sSXRCI3V+b4PUnbMUOQa3fFVUriM4QjjUBU6hW0Ub0
GDPcZq45nd7PoPPtb3/EauaYfk/zdx8Xt0OmuKTi9/vMkvB09AEUyShbyzoebaKH
dKtXlzyAPCZoH9dihFM67rhUg4umckFLc8vc5P2tNblwYrnhgL8ymUaOIjZB/fOi
Z2OZLVCiDeHNjjK3VZ6jLAiPyiYTG1Hrk9E8NaZDeUgIb9X/K06JXVBQIKNSGfX5
LLp/j2wr+Kbg3QtEBkcStlUGBOzfcbhKpE2nySnuIyspfDb/6JbhD/qYqMJerX0T
d5ekkJ1tXtM6aX2iTXgZ8cqv+5gyouEF5akrkLi1ySgZetQfjm+zhy/1x/NjGd0u
35QbUye7sTbfSimwzCXKIIpy06zIO4iNA0P/vgG4v7ydjMvXsW8FRULSecDT19Gq
xOZGfSPVrSRSAhgNxHzwUivxJbr05NNdwhJSbx9m57naXouLfvVPAMeJYwARAQAB
tD9GcmVlQlNEIFNlY3VyaXR5IFRlYW0gU2VjcmV0YXJ5IDxzZWN0ZWFtLXNlY3Jl
dGFyeUBGcmVlQlNELm9yZz6JAj0EEwEKACcFAlJBjIICGwMFCQgH7b8FCwkIBwMF
FQoJCAsFFgIDAQACHgECF4AACgkQPLLq/MPWxmYt8Q/+IfFhPIbqglh4rwFzgR58
8YonMZcq+5Op3qiUBh6tE6yRz6VEqBqTahyCQGIk4xGzrHSIOIj2e6gEk5a4zYtf
0jNJprk3pxu2Og05USJmd8lPSbyBF20FVm5W0dhWMKHagL5dGS8zInlwRYxr6mMi
UuJjj+2Hm3PoUNGAwL1SH2BVOeAeudtzu80vAlbRlujYVmjIDn/dWVjqnWgEBNHT
SD+WpA3yW4mBJyxWil0sAJQbTlt5EM/XPORVZ2tvETxJIrXea/Sda9mFwvJ02pJn
gHi6TGyOYydmbu0ob9Ma9AvUrRlxv8V9eN7eZUtvNa6n+IT8WEJj2+snJlO4SpHL
D3Z+l7zwfYeM8FOdzGZdVFgxeyBU7t3AnPjYfHmoneqgLcCO0nJDKq/98ohz5T9i
FbNR/vtLaEiYFBeX3C9Ee96pP6BU26BXhw+dRSnFeyIhD+4g+/AZ0XJ1CPF19D+5
z0ojanJkh7lZn4JL+V6+mF1eOExiGrydIiiSXDA/p5FhavMMu8Om4S0sn5iaQ2aX
wRUv2SUKhbHDqhIILLeQKlB3X26obx1Vg0nRhy47qNQn/xc9oSWLAQSVOgsShQeC
6DSzrKIBdKB3V8uWOmuM7lWAoCP53bDRW+XIOu9wfpSaXN2VTyqzU7zpTq5BHX1a
+XRw8KNHZGnCSAOCofZWnKyJAhwEEAEKAAYFAlJBjYgACgkQ7Wfs1l3PaudFcQ//
UiM7EXsIHLwHxez32TzA/0uNMPWFHQN4Ezzg4PKB6Cc4amva5qbgbhoeCPuP+XPI
2ELfRviAHbmyZ/zIgqplDC4nmyisMoKlpK0Yo1w4qbix9EVVZr2ztL8F43qN3Xe/
NUSMTBgt/Jio7l5lYyhuVS3JQCfDlYGbq6NPk0xfYoYOMOZASoPhEquCxM5D4D0Z
3J3CBeAjyVzdF37HUw9rVQe2IRlxGn1YAyMb5EpR2Ij612GFad8c/5ikzDh5q6JD
tB9ApdvLkr0czTBucDljChSpFJ7ENPjAgZuH9N5Dmx2rRUj2mdBmi7HKqxAN9Kdm
+pg/6vZ3vM18rBlXmw1poQdc3srAL+6MHmIfHHrq49oksLyHwyeL8T6BO4d4nTZU
xObP7PLAeWrdrd1Sb3EWlZJ9HB/m2UL9w9Om1c6cb6X2DoCzQAStVypAE6SQCMBK
pxkWRj90L41BS62snja+BlZTELuuLTHULRkWqS3fFkUxlDSMUn96QksWlwZLcxCv
hKxJXOX+pHAiUuMIImaPQ0TBDBWWf5d8zOQlNPsyhSGFR5Skwzlg+m9ErQ+jy7Uz
UmNCNztlYgRKeckXuvr73seoKoNXHrn7vWQ6qB1IRURj2bfphsqlmYuITmcBhfFS
Dw0fdYXSDXrmG9wad98g49g4HwCJhPAl0j55f93gHLGIRgQQEQoABgUCUkGO5gAK
CRAV1ogEymzfsol4AKCI7rOnptuoXgwYx2Z9HkUKuugSRwCgkyW9pxa5EovDijEF
j1jG/cdxTOaJAhwEEAEKAAYFAlJBkdUACgkQkshDRW2mpm6aLxAAzpWNHMZVFt7e
wQnCJnf/FMLTjduGTEhVFnVCkEtI+YKarveE6pclqKJfSRFDxruZ6PHGG2CDfMig
J6mdDdmXCkN//TbIlRGowVgsxpIRg4jQVh4S3D0Nz50h+Zb7CHbjp6WAPVoWZz7b
Myp+pN7qx/miJJwEiw22Eet4Hjj1QymKwjWyY146V928BV/wDBS/xiwfg3xIVPZr
RqtiOGN/AGpMGeGQKKplkeITY7AXiAd+mL4H/eNf8b+o0Ce2Z9oSxSsGPF3DzMTL
kIX7sWD3rjy3Xe2BM20stIDrJS2a1fbnIwFvqszS3Z3sF5bLc6W0iyPJdtbQ0pt6
nekRl9nboAdUs0R+n/6QNYBkj4AcSh3jpZKe82NwnD/6WyzHWtC0SDRTVkcQWXPW
EaWLmv8VqfzdBiw6aLcxlmXQSAr0cUA6zo6/bMQZosKwiCfGl3tR4Pbwgvbyjoii
pF+ZXfz7rWWUqZ2C79hy3YTytwIlVMOnp3MyOV+9ubOsFhLuRDxAksIMaRTsO7ii
5J4z1d+jzWMW4g1B50CoQ8W+FyAfVp/8qGwzvGN7wxN8P1iR+DZjtpCt7J+Xb9Pt
L+lRKSO/aOgOfDksyt2fEKY4yEWdzq9A3VkRo1HCdUQY6SJ/qt7IyQHumxvL90F6
vbB3edrR/fVGeJsz4vE10hzy7kI1QT65Ag0EUkGMggEQAMTsvyKEdUsgEehymKz9
MRn9wiwfHEX5CLmpJAvnX9MITgcsTX8MKiPyrTBnyY/QzA0rh+yyhzkY/y55yxMP
INdpL5xgJCS1SHyJK85HOdN77uKDCkwHfphlWYGlBPuaXyxkiWYXJTVUggSjuO4b
jeKwDqFl/4Xc0XeZNgWVjqHtKF91wwgdXXgAzUL1/nwN3IglxiIR31y10GQdOQEG
4T3ufx6gv73+qbFc0RzgZUQiJykQ3tZK1+Gw6aDirgjQYOc90o2Je0RJHjdObyZQ
aQc4PTZ2DC7CElFEt2EHJCXLyP/taeLq+IdpKe6sLPckwakqtbqwunWVoPTbgkxo
Q1eCMzgrkRu23B2TJaY9zbZAFP3cpL65vQAVJVQISqJvDL8K5hvAWJ3vi92qfBcz
jqydAcbhjkzJUI9t44v63cIXTI0+QyqTQhqkvEJhHZkbb8MYoimebDVxFVtQ3I1p
EynOYPfn4IMvaItLFbkgZpR/zjHYau5snErR9NC4AOIfNFpxM+fFFJQ7W88JP3cG
JLl9dcRGERq28PDU/CTDH9rlk1kZ0xzpRDkJijKDnFIxT2ajijVOZx7l2jPL1njx
s4xa1jK0/39kh6XnrCgK49WQsJM5IflVR2JAi8BLi2q/e0NQG2pgn0QL695Sqbbp
NbrrJGRcRJD9sUkQTpMsLlQTABEBAAGJAiUEGAEKAA8FAlJBjIICGwwFCQgH7b8A
CgkQPLLq/MPWxmZAew//et/LToMVR3q6/qP/pf9ob/QwQ3MgejkC0DY3Md7JBRl/
6GWfySYnO0Vm5IoJofcv1hbhc/y3OeZTvK4s+BOQsNokYe34mCxZG4dypNaepkQi
x0mLujeU/n4Y0p0LTLjhGLVdKina2dM9HmllgYr4KumT58g6eGjxs2oZD6z5ty0L
viU5tx3lz3o0c3I9soH2RN2zNHVjXNW0EvWJwFLxFeLJbk/Y3UY1/kXCtcyMzLua
S5L5012eUOEvaZr5iYDKjy+wOxY4SUCNYf0GPmSej8CBbwHOF2XCwXytSzm6hNb3
5TRgCGbOSFTIy9MxfV5lpddQcdzijmuFSl8LySkL2yuJxjlI7uKNDN+NlfODIPMg
rdH0hBSyKci6Uz7Nz/Up3qdE+aISq68k+Hk1fiKJG1UcBRJidheds29FCzj3hoyZ
VDmf6OL60hL0YI1/4GjIkJyetlPzjMp8J7K3GweOUkfHcFihYZlbiMe7z+oIWEc7
0fNScrAGF/+JN3L6mjXKB6Pv+ER5ztzpfuhBJ/j7AV5BaNMmDXAVO4aTphWl7Dje
iecENuGTpkK8Ugv5cMJc4QJaWDkj/9sACc0EFgigPo68KjegvKg5R8jUPwb8E7T6
lIjBtlclVhaUrE2uLx/yTz2Apbm+GAmD8M0dQ7IYsOFlZNBW9zjgLLCtWDW+p1A=
=5gJ7
-----END PGP PUBLIC KEY BLOCK-----
]]></programlisting>

    </sect2>

    <sect2 xml:id="pgpkey-core-secretary">
      <title>Core Team Secretary <email>core-secretary@FreeBSD.org</email></title>
      <!-- $FreeBSD$ -->
<!--
sh addkey.sh core-secretary 0CB403E4E95B96EC ;
-->
<programlisting role="pgpfingerprint"><![CDATA[
pub   rsa2048/0CB403E4E95B96EC 2018-06-30 [SC] [expires: 2020-06-29]
      Key fingerprint = 9F02 836F 50D3 AD5A B75A  C588 0CB4 03E4 E95B 96EC
uid                            FreeBSD Core Team Secretary <core-secretary@freebsd.org>
sub   rsa2048/133C3338A5B95A60 2018-06-30 [E] [expires: 2020-06-29]
      Key fingerprint = FA37 B8AA C667 C3AA D310  751D 133C 3338 A5B9 5A60

]]></programlisting>
<programlisting role="pgpkey"><![CDATA[
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQENBFs3wcYBCAC7nlaUTMqyT7PBSFLtW/LleSz7BNUwqSTo8LfUVJOY5G/pzWt5
Mqjqh4oJcW/MvKFTDeRaJ2mHp+vELxIP7wO3gcP36dXgImw6sXwBTkPlKpmmFRm1
M+QqnCCrrLHtCznWaDg+1fTHmyQpFHpg37XzA1Z5ev6PryEUYJkcBP77oNCTY933
86sXOqRAJRywvN/LEkAoaawqBz0CpkNTOBACoJZRV8i9CIklEOy8J+hNzGtJpHkg
FxUOXWj7z+2y6UOR4GzSpYAWJGbtwEcpGPfhqJk5M5eZ6PJcwzZ6LeLKgGFzNi6r
tlShQh5LT7wAKkTrBsZ9vckyyuTEtqgdGCmhABEBAAG0OEZyZWVCU0QgQ29yZSBU
ZWFtIFNlY3JldGFyeSA8Y29yZS1zZWNyZXRhcnlAZnJlZWJzZC5vcmc+iQFUBBMB
CgA+FiEEnwKDb1DTrVq3WsWIDLQD5OlbluwFAls3wcYCGwMFCQPCZwAFCwkIBwMF
FQoJCAsFFgMCAQACHgECF4AACgkQDLQD5OlbluyRZAf/VG9VWpIsofcoHwDxhYAL
mm+xbuP/eq1/Q8HeO3XVhA/HZF5nvSKZbD8F+ujaHDH/waNStWb3wUK87l9AfB6G
QFMVYjVQWrPwgpwFtGjL9zLMCBS3T+ysuub+xSuPhr1KQHgKB4+t6NLoBlSwP+76
sLLx0SILGwTpsb0r84etaECgp5ymAXijbzIB0Pu44Y+DjZimBEVuw2YRZ4/Ug/3z
pcNQqpjbrHNYjU6AOZEHXftbXwuWfgdjINnrWpvTwkKVnU0FhGXV9UYWP2UAxE5u
OyAvIyYFbX10iSFQGUXle3eg6IuHncT5u6P1IxQM++d/TJIbKrQW+xdr+1I+vUrS
rokCMwQQAQoAHRYhBHLPrCF5vLAktbVFkANvbJ7n856/BQJbOJDdAAoJEANvbJ7n
856/1swQAN2QKGe1riRm9jKVxC8AMy57+Tzu1ITGDDUf6dH2+gxx0K5GoVmtdhLL
2qrmDJEqP7K232T25cU5zStQnaTHpEIUklY8Rn1Fati8+IZBdpemG4BXTzGnNDQ0
FS6PxuxOFvcELOFvuUil3PP7ArMKI9jfjxisEkOWFuwQVyIPeApcQuf8vyqrfTnV
/Qes/XhySrvsEL+ehq2OEorl6YjMB2/lVK2lVWYrWJ91Oq8Vwp0G09whZEMhMabQ
D1OxlmM6kofkTioM8DOmbGTbOXhiiiiCUI41pOAOzF9SrCqCpLV2OyrPFz7J+GU9
6u+DPPZyy7O8NmjdDsyrDg2hhbTwWC4dvW+QMJSWZ8Bo8eMx8b5ti9RX0XPEIwao
KrCKh3aemGgkP8zcVbFWOzOji8aXrpWrRr/oxQmJxE49d2j1oF4LydIfhDxOnfOF
428pVhDXDLjf0xdUIVQqCsOBQvzwVPWTQVOFSakVFNRYP6/SXyF5eUf5E6iSExKn
fn+G4FtrJd6QNwNUquI2LF8CEhJBpLNBqjJW3WEv1tDzU+rqS9QpHzSmLzLqtiE+
5HqynvOPXGRRsAcUOLmV4fMUGRH8tpNoH4iBEc7LmoFTQXIf6oJClaiwRkFKuT9c
2XlkJ4ca6fxU4KyoHtR6pmMNkLIcehfpoL11+TPyyBjNd2TwLpLbiQIzBBABCgAd
FiEEwHv14xCuZL9hILD2NqfAX+Hs+bsFAls4kV0ACgkQNqfAX+Hs+bvRrw//QVea
9diHHbzxq84yp4eOGQoj86usPSV+IOZN27+e6QDYR8ZsxqFE5wQycSAdyqo0n42Q
EDE6tnn+/HhyFogr7kF8CRJMtsSlwKgDrMMYjVPnP2fP5VFxAF36epSRgcGC0Lqh
Ris+xjfSzXM2oNiiebPu2MOe8qOe8LVGJMyuxJZbb/OuEfgLGLKtjcJ1SujKhzLl
TVS8JSSVRbxk62huh/Mo80eCKHMV+/NmbHP4QKZBOVSWn0U/lrm+SyDR78l3EhtN
x/KIfhiPZENYTjSBSxa8F/Vg19bcmUedLapcN9J8q2KVNx7VuiPz+X2ww/dOKFR0
FxwOvCweGFRNRyoytF4ziw0Gwt78RHw4OdhQg8YH38kbrRFvf2YqiddGUA2UWwKi
HRdj9ZGemzL++OE/MZvgODVhZA6V5QU/B9bR3xfnVcBsPyGTrlQ8XZ9aY1wBMTrS
TTbS3sD7HuyS4PO8rt3iZy50UDMc5v55Pr5SIPiaUdyV8Y401oOWnKvKgKtHzBtC
2ADT+iZk/I4a3iDj4hw07Y+O1Voqp72LaACGhqWqkN0zqoKq3TvD/ukEZwgsvDdP
ErzPUanN31gn055PlpWYQBVoLjupH8SXahrdTmo15Xjdr97VHCuABNT4Kh3QDELU
vQtF0IB+S+VQfTVR5wkC1OLj8J1edvoXlsVzREW5AQ0EWzfBxgEIAMZxwaI3hZ2G
je7L8N1TFfPJA62kMGzzFDvFqeH8mDPOXkd4JC4y2EIBySPS36y0c1MJM79oOkKI
6DQLyUb3p4hGZbEVKidAwXvp4t5x1QJ0bpodHc/7xh95EP11Lf8C/DFP5Js3YVPl
MsdeVhx7J8itQuivoLJrZVTgKSgFepatLuXXKUttYAJNcU11ziPwTlzjEuTx4X6V
RimPrp8+/dbkRmPhsDqMXrqJmjeNarYK9F0xKlaWnIhtyZnNXtHrdtQE/VOBjoXN
0NXiuJg02JZGqZuBM80Ig7yBdmUlZdPrxkYw92+kxHIdySM3+WYbGu/e6T/VY6wx
7KW2IV3u3b8AEQEAAYkBPAQYAQoAJhYhBJ8Cg29Q061at1rFiAy0A+TpW5bsBQJb
N8HGAhsMBQkDwmcAAAoJEAy0A+TpW5bsp0AH/Rht32xeJQk59UgDf7BPHiiphgg8
P1qmRVd6OZJ6GoVYWjJ87+gU9sChbZUTCFioiIYLWPbhm9AJKy1KDrcnP0zYjWL2
SKjezMbru9cgFYk6R3LO+mK5DwtGMgyzipKAN8Kh92pX2WERUeMFulkYa4+rdVkP
kBtB49hmDj25GPw/72Vuksg5m7sbpEZzt6JjXQN0ynDjBuizE/HYm2E8VW5tH1aH
wdzVGruNVIOMMF3gHKbJbrxKiq/SPJfph0YGeL6v5bF9mgizGamEUn9YHVkCqZ7z
wDuSIDVTSiQQOJesD58WOADCDINEP3uXFhlI1A0Au7X+XYyjIjHCdyTNhBI=
=5VKx
-----END PGP PUBLIC KEY BLOCK-----
]]></programlisting>

    </sect2>

    <sect2 xml:id="pgpkey-portmgr-secretary">
      <title>Ports Management Team Secretary <email>portmgr-secretary@FreeBSD.org</email></title>
      <!-- $FreeBSD$ -->
<!--
sh addkey.sh portmgr-secretary D8294EC3BBC4D7D5 ;
-->
<programlisting role="pgpfingerprint"><![CDATA[
pub   rsa2048/D8294EC3BBC4D7D5 2012-07-24 [SC]
      Key fingerprint = FB37 45C8 6F15 E8ED AC81  32FC D829 4EC3 BBC4 D7D5
uid                            FreeBSD Ports Management Team Secretary <portmgr-secretary@FreeBSD.org>
sub   rsa2048/5CC117965F65CFE7 2012-07-24 [E]

]]></programlisting>
<programlisting role="pgpkey"><![CDATA[
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQENBFAOzqYBCACYd+KGv0/DduIRpSEKWZG2yfDILStzWfdaQMD+8zdWihB0x7dd
JDBUpV0o0Ixzt9mvu5CHybx+9lOHeFRhZshFXc+bIJOPyi+JrSs100o7Lo6jg6+c
Si2vME0ixG4x9YjCi8DisXIGJ1kZiDXhmVWwCvL+vLInpeXrtJnK8yFkmszCOr4Y
Q3GXuvdU0BF2tL/Wo/eCbSf+3U9syopVS2L2wKcP76bbYU0ioO35Y503rJEK6R5G
TchwYvYjSXuhv4ec7N1/j3thrMC9GNpoqjVninTynOk2kn+YZuMpO3c6b/pfoNcq
MxoizGlTu8VT4OO/SF1y52OkKjpAsENbFaNTABEBAAG0R0ZyZWVCU0QgUG9ydHMg
TWFuYWdlbWVudCBUZWFtIFNlY3JldGFyeSA8cG9ydG1nci1zZWNyZXRhcnlARnJl
ZUJTRC5vcmc+iQE4BBMBAgAiBQJQDs6mAhsDBgsJCAcDAgYVCAIJCgsEFgIDAQIe
AQIXgAAKCRDYKU7Du8TX1QW2B/0coHe8utbTfGKpeM4BY9IyC+PFgkE58Hq50o8d
shoB9gfommcUaK9PNwJPxTEJNlwiKPZy+VoKs/+dO8gahovchbRdSyP1ejn3CFy+
H8pol0hDDU4n7Ldc50q54GLuZijdcJZqlgOloZqWOYtXFklKPZjdUvYN8KHAntgf
u361rwM4DZ40HngYY9fdGc4SbXurGA5m+vLAURLzPv+QRQqHfaI1DZF6gzMgY49x
qS1JBF4kPoicpgvs3o6CuX8MD9ewGFSAMM3EdzV6ZdC8pnpXC8+8Q+p6FjNqmtjk
GpW39Zq/p8SJVg1RortCH6qWLe7dW7TaFYov7gF1V/DYwDN5iEYEEBECAAYFAlN2
WksACgkQtzkaJjSHbFtuMwCg0MXdQTcGMMOma7LC3L5b4MEoZ+wAn0WyUHpHwHnn
pn2oYDlfAbwTloWIiQEcBBABAgAGBQJQDuVrAAoJENk3EJekc8mQ3KwIAImNDMXA
F8ajPwCZFpM6KDi3F/jpwyBPISGY1oWuYPEi1zN94k5jS90aZb3W8Y8x4JTh35Ew
b6XODi3uGLSLCmnlqu2a80yPfXf5IuWmIQdFNQxvosj9UHrg+icZGFmm+f0hPJxM
TsZREv3AvivQfnb/N3xIICxW4SjKSYXQcq4hr4ObhUx7GKnjayq+ofU2cRlujr87
uOH0fO3xhOJG4+cX5mI1HGK38k0Csc1zqYa/66Qe5dnIZz+sNXpEPMLAHIt1a45U
B967igJdZSDFN33bPl1QWmf3aUXU3d1VttiSyHkpm4kb9KgsDkUk1IJ5nUe9OXyd
WtoqNW5afDa5N0aIRgQQEQIABgUCUA7lwwAKCRB59uBxdBRinNh2AJ41+zfsaQSR
HWvSkqOXGcP/fgOduwCfUJDT+M1eXe2udmKof/9yzGYMirKJASIEEAECAAwFAlAa
IT8FAwASdQAACgkQlxC4m8pXrXwCHAf+J7l+L7AvRpqlQcezjnjFS/zG1098qkDf
lThHZlpVnrBMJZaXdvL6LzVgiIYVWZC5CSSazW9EWFjp9VjM7FBHdWFZNMV7GAuU
t0jzx6gGXOWwi+/v/hs1P11RyDZN5hICHdPNmyZVupciDxe+sIEP9aEbVxcaiccq
zM/pFzIVIMMP5tCiA42q6Mz3h0hy6hntUKptS8Uon6sje5cDVcVlKAUj1wO2cphC
qkYlwMQfZV5J9f/hcW5ODriD3cBwK8SocA2Cq5JYF8kYDL1+pXnUutGnvAHUYt87
RWvQdKmfXjzBcMFJ2LlPUB1+IFvwQ13V9R8j9B/EdLmSWQYT9qRA2okCHAQTAQoA
BgUCV1XMpwAKCRCtu/hhCjeJt2CyD/9JLe+Ck23CJkeRSF8oC+4SFOUdSAmejSzn
klPwmEClffABYd/kckO1T6um+2FUcXuJZQE1nKKUNvZ8pBWwsm1RDHsyroKi/XB1
0a1Tdx/rvlU88ytbeLfUCLzoCrf6pkMQWoU6/3qS6elV0WwOlDufk+XjD1sja2wu
sshG8y+1WCA5JjP3rZdD9NVdzo5DgkotTRUfuYN1LJIN4zlDgHj7FVP7wW7+R0cZ
FoOiNsLJCA0FN8SiyU98UysjawLiIY9dTJz6XVA0DgB0TZWO3mWiDjITeKrdGcqf
PNiJhmvUKBkn07YpTPNfkoTT/p/q5ChYmu0ubGeyS1ELKjmklJ+DzynfZLzvnXYX
Ngo5ckeuqEqUNxM0J63v8lmfhDRROFveqHWdp0XMxXVmR5bMunSldg5EZsoLyQbN
+ScIPnDTAEPGrCtf0t84RQxNQeET6/WBbZfzeSeAFmpBFCdicsZ6Mjwtwjr4+o15
n1QMTZco1NaTqf8vXwzl9wM4aYtg1OkF4z8HdHuy50CHCet4mT5eJgwZUfFvXdbM
pHXprEI0Y9OOL4aMinC1egF3dXt/0n57i6CE+E2k3UJPNvMrtp0HaDEnKZ8cfkBU
EBzkUYi5wwqntHV2JRisqoRnHdvJT7ImlHMe7WaJsifBK874PnToaKg8P6K1Tph+
FyLxULaYjYkCHAQSAQgABgUCVBg2zwAKCRDqsDxYv9xHj1klEADXYJdHC3zsdx7w
DsJsttWdykcZoOd/VUKUdN0BAU72nLV0tLn4uFjETA6MhHZVxzwIDTeLB8kqyEpc
fZnoVbqJIUJz1sJXMdOty7CwZzlZlAwmUaIfFiazJY1p398JbyYfSrVKNOpw9wCm
Db7WP9dBritwvjaLzu8HQsiztO0S/5ha/EDfTU3qocBUTjbCtGR9LqAmPE4X8+li
F2EfZMEoJd3rJWsYv2y/k6pSgC/MpQewnyr6f+JQ/781UoZB6PpxCxfu4D6xlOyd
ERBUg+FfDAWYR+KX+DGOalRlUyaSz8Nvxl8/b0Im/AQhx9afqyEZxIDpg52zt8jJ
t3wx23YP8EQGUgwF8pIrj3wFSBSG3a/cskiBNUIhChIR9hQrVPUahN/jx7DGAGxk
/Ka9qsRGYTHfSr9jjTUQ+htfeFBRDR0nkZKMo5+Wk/cAcBKVbPlBpwvnzT3fh+wL
cF3ErBbx5jp+BoFee8D6ATeUvQxMcgVbDPUkgMsy3EtKMVO10jhIoXoVV+Sg9GZ8
zMEy1tORKn0zsd2ZgXC2sRJOm5ttCSdYQ4ddbM1A9jg6tiRx4hES16GDywvkL8P2
M9+qyIfjQxjGU33f/r8zp9DyNT1VlrtwhFxtOoMdmrsbYOCTja4Xg14hK1hRac0k
GB7bj6w97p8uMrQT3PlSMtoyrRyo7bkBDQRQDs6mAQgAzNxJYpf5PrqV8pdRXkn3
6Fe45q671YtbZ2WrT7D0CVZ8Z+AZsxnP/tiY1SrM2MepCeA2xBAhKGsWBWo1aRk5
mfZOksKsiXsi2XeBVhdZlCkrOMKBTVian7I1lH59ZnNIMX0Nl0tlj3L1IjeWWNvf
ej43URV81S9EmSwpjaWboatr2A+1oJku5m7nPD9JIOckE1TzBsyhx7zIUN9w6MKr
7gFw8DCzypwUKyYgKYToVm8QlkT/L3B0fuQHWhT6ROGk4o8SC71ia5tc1TzUzGEZ
1AQO8bbnbmJLBDKveWHCoaeAkRzINzoD9wAn9z4pnilze59QtKC1cOqUksTvBSDh
6wARAQABiQEfBBgBAgAJBQJQDs6mAhsMAAoJENgpTsO7xNfVOHoH/i5VyggVdwpq
PX8YBmN5mXQziYZNQoiON8IhOsxpX4W2nXCj5m6MACV6nJDVV6wyUH8/VvDQC9nH
arCe1oaNsHXJz0HamYt5gHJ0G1bYuBcuJp/FEjLa48XFI7nXQjJHn8rlwZMjK/PW
j1lw2WZiekviuzTEDH8c3YStGJSa+gYe8Eyq3XJVAe2VQOhImoWgGDR3tWfgrya/
IdEFb/jmjHSG5XUfbI0vNwqlf832BqSQKPG/Zix4MmBJgvAz4R71PH8WBmbmNFjD
elxVyfz80+iMgEb9aL91MfeBNC2KB1pFmg91mQTsiq7ajwVLVJK8NplHAkdLmkBC
O8MgMjzGhlE=
=iw7d
-----END PGP PUBLIC KEY BLOCK-----
]]></programlisting>

    </sect2>

    <sect2 xml:id="pgpkey-doceng-secretary">
      <title><email>doceng-secretary@FreeBSD.org</email></title>
      <!-- $FreeBSD$ -->
<!--
sh addkey.sh doceng-secretary E1C03580AEB45E58 ;
-->
<programlisting role="pgpfingerprint"><![CDATA[
pub   rsa2048/E1C03580AEB45E58 2019-10-31 [SC] [expires: 2022-10-30]
      Key fingerprint = F24D 7B32 B864 625E 5541  A0E4 E1C0 3580 AEB4 5E58
uid                            FreeBSD Doceng Team Secretary <doceng-secretary@freebsd.org>
sub   rsa2048/9EA8D713509472FC 2019-10-31 [E] [expires: 2022-10-30]

]]></programlisting>
<programlisting role="pgpkey"><![CDATA[
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQENBF27FFcBCADeoSsIgyQUY8vREwkTikwFFlNg31MVy5s/Nq1cNK1PRfRMnprS
yfB62KqbYuz16bmQKaA9zHN4FGfiTvR6tl66LVHm1s/5HPiLv8sP14GsruLro9zN
v72dO7a9i68bMw+jarPOnu9dGiDFEI0dACOkdCGEYKEUapQeNpmWRrQ46BeXyFwF
JcNx76bJJUkwk6fWC0W63D762e6lCEX6ndoaPjjLBnFvtx13heNGUc8RukBwe2mA
U5pSGHj47J05bdWiRSwZaXa8PcW+20zTWaP755w7zWe4h60GANY7OsT9nuOqsioJ
QonxTrJuZweKRV8fNQ1EfDws3HZr7/7iXvO3ABEBAAG0PEZyZWVCU0QgRG9jZW5n
IFRlYW0gU2VjcmV0YXJ5IDxkb2Nlbmctc2VjcmV0YXJ5QGZyZWVic2Qub3JnPokB
VAQTAQoAPhYhBPJNezK4ZGJeVUGg5OHANYCutF5YBQJduxRXAhsDBQkFo5qABQsJ
CAcDBRUKCQgLBRYDAgEAAh4BAheAAAoJEOHANYCutF5YB2IIALw+EPYmOz9qlqIn
oTFmk/5MrcdzC5iLEfxubbF6TopDWsWPiOh5mAuvfEmROSGf6ctvdYe9UtQV3VNY
KeeyskeFrIBOFo2KG/dFqKPAWef6IfhbW3HWDWo5uOBg01jHzQ/pB1n6SMKiXfsM
idL9wN+UQKxF3Y7S/bVrZTV0isRUolO9+8kQeSYT/NMojVM0H2fWrTP/TaNEW4fY
JBDAl5hsktzdl8sdbNqdC0GiX3xb4GvgVzGGQELagsxjfuXk6PfOyn6Wx2d+yRcI
FrKojmhihBp5VGFQkntBIXQkaW0xhW+WBGxwXdaAl0drQlZ3W+edgdOl705x73kf
Uw3Fh2a5AQ0EXbsUVwEIANEPAsltM4vFj2pi5xEuHEcZIrIX/ZJhoaBtZkqvkB+H
4pu3/eQHK5hg0Dw12ugffPMz8mi57iGNI9TXd8ZYMJxAdvEZSDHCKZTX9G+FcxWa
/AzKNiG25uSISzz7rMB/lV1gofCdGtpHFRFTiNxFcoacugTdlYDiscgJZMJSg/hC
GXBdEKXR5WRAgAGandcL8llCToOt1lZEOkd5vJM861w6evgDhAZ2HGhRuG8/NDxG
r4UtlnYGUCFof/Q4oPNbDJzmZXF+8OQyTNcEpVD3leEOWG1Uv5XWS2XKVHcHZZ++
ISo/B5Q6Oi3SJFCVV9f+g09YF+PgfP/mVMBgif2fT20AEQEAAYkBPAQYAQoAJhYh
BPJNezK4ZGJeVUGg5OHANYCutF5YBQJduxRXAhsMBQkFo5qAAAoJEOHANYCutF5Y
kecIAMTh2VHQqjXHTszQMsy3NjiTVVITI3z+pzY0u2EYmLytXQ2pZMzLHMcklmub
5po0X4EvL6bZiJcLMI2mSrOs0Gp8P3hyMI40IkqoLMp7VA2LFlPgIJ7K5W4oVwf8
khY6lw7qg2l69APm/MM3xAyiL4p6MU8tpvWg5AncZ6lxyy27rxVflzEtCrKQuG/a
oVaOlMjH3uxvOK6IIxlhvWD0nKs/e2h2HIAZ+ILE6ytS5ZEg2GXuigoQZdEnv71L
xyvE9JANwGZLkDxnS5pgN2ikfkQYlFpJEkrNTQleCOHIIIp8vgJngEaP51xOIbQM
CiG/y3cmKQ/ZfH7BBvlZVtZKQsI=
=MQKT
-----END PGP PUBLIC KEY BLOCK-----
]]></programlisting>

    </sect2>

  </sect1>
</appendix>

  </part>
  
<!--
    $FreeBSD$

    FreeBSD Glossary Terms
	Please keep this file sorted alphabetically/ASCIIly by glossterm.

	glossterms that are acronyms should have two entries - one for
	the expanded acronym and another for the acronym itself.  The
	second of these should reference the entry for the expanded acronym
	via a glosssee element.  For example:

	<glossentry>
	  <glossterm>FUBAR</glossterm>
	  <glosssee otherterm="fubar-glossary">
	</glossentry>

	<glossentry id="fubar-glossary">
	  <glossterm>Fuc... Up Beyond All Recognition</glossterm>
	  <acronym>FUBAR</acronym>
	  <glossdef>
	    <para>Broken.</para>
	  </glossdef>
	</glossentry>

	Note that in this instance, the expanded acronym sorts below the
	unexpanded acronym.  That's OK.

	Finally, id attribute values should end in the string
	"-glossary" to avoid conflicting with id attribute values in
	the main text.

-->
<glossary version="5.0" status="draft" xml:id="freebsd-glossary">
  <title>FreeBSD 詞彙表</title>
  <para xml:lang="en">This glossary contains terms and acronyms used within the FreeBSD
    community and documentation.</para>

  <glossdiv>
    <title xml:lang="en">A</title>

    <glossentry>
      <glossterm xml:lang="en">ACL</glossterm>
      <glosssee otherterm="acl-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">ACPI</glossterm>
      <glosssee otherterm="acpi-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">AMD</glossterm>
      <glosssee otherterm="amd-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">AML</glossterm>
      <glosssee otherterm="aml-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">API</glossterm>
      <glosssee otherterm="api-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">APIC</glossterm>
      <glosssee otherterm="apic-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">APM</glossterm>
      <glosssee otherterm="apm-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">APOP</glossterm>
      <glosssee otherterm="apop-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">ASL</glossterm>
      <glosssee otherterm="asl-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">ATA</glossterm>
      <glosssee otherterm="ata-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">ATM</glossterm>
      <glosssee otherterm="atm-glossary"/>
    </glossentry>

    <glossentry xml:id="aml-glossary">
      <glossterm xml:lang="en"><acronym>ACPI</acronym> Machine Language</glossterm>
      <acronym xml:lang="en">AML</acronym>
      <glossdef>
        <para xml:lang="en">Pseudocode, interpreted by a virtual machine within an
	  <acronym>ACPI</acronym>-compliant operating system, providing a
	  layer between the underlying hardware and the documented
	  interface presented to the <acronym>OS</acronym>.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="asl-glossary">
      <glossterm xml:lang="en"><acronym>ACPI</acronym> Source Language</glossterm>
      <acronym xml:lang="en">ASL</acronym>
      <glossdef>
        <para xml:lang="en">The programming language <acronym>AML</acronym> is written in.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="acl-glossary">
      <glossterm xml:lang="en">Access Control List</glossterm>
      <acronym xml:lang="en">ACL</acronym>
      <glossdef>
        <para xml:lang="en">A list of permissions attached to an object, usually either a
	  file or a network device.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="acpi-glossary">
      <glossterm xml:lang="en">Advanced Configuration and Power Interface</glossterm>
      <acronym xml:lang="en">ACPI</acronym>
      <glossdef>
        <para xml:lang="en">A specification which provides an abstraction of the
	  interface the hardware presents to the operating system, so
	  that the operating system should need to know nothing about
	  the underlying hardware to make the most of it.  <acronym>ACPI</acronym>
	  evolves and supersedes the functionality provided previously by
	  <acronym>APM</acronym>, <acronym>PNPBIOS</acronym> and other technologies, and
	  provides facilities for controlling power consumption, machine
	  suspension, device enabling and disabling, etc.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="api-glossary">
      <glossterm xml:lang="en">Application Programming Interface</glossterm>
      <acronym xml:lang="en">API</acronym>
      <glossdef>
        <para xml:lang="en">A set of procedures, protocols and tools that specify the
	  canonical interaction of one or more program parts; how, when
	  and why they do work together, and what data they share or
	  operate on.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="apm-glossary">
      <glossterm xml:lang="en">Advanced Power Management</glossterm>
      <acronym xml:lang="en">APM</acronym>
      <glossdef>
        <para xml:lang="en">An <acronym>API</acronym> enabling the operating system to work
	  in conjunction with the <acronym>BIOS</acronym> in order to achieve
	  power management.  <acronym>APM</acronym> has been superseded by
	  the much more generic and powerful <acronym>ACPI</acronym>
	  specification for most applications.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="apic-glossary">
      <glossterm xml:lang="en">Advanced Programmable Interrupt Controller</glossterm>
      <acronym xml:lang="en">APIC</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ata-glossary">
      <glossterm xml:lang="en">Advanced Technology Attachment</glossterm>
      <acronym xml:lang="en">ATA</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="atm-glossary">
      <glossterm xml:lang="en">Asynchronous Transfer Mode</glossterm>
      <acronym xml:lang="en">ATM</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="apop-glossary">
      <glossterm xml:lang="en">Authenticated Post Office Protocol</glossterm>
      <acronym xml:lang="en">APOP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="amd-glossary">
      <glossterm xml:lang="en">Automatic Mount Daemon</glossterm>
      <acronym xml:lang="en">AMD</acronym>
      <glossdef>
        <para xml:lang="en">A daemon that automatically mounts a filesystem when a file
          or directory within that filesystem is accessed.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">B</title>

    <glossentry>
      <glossterm xml:lang="en">BAR</glossterm>
      <glosssee otherterm="bar-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">BIND</glossterm>
      <glosssee otherterm="bind-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">BIOS</glossterm>
      <glosssee otherterm="bios-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">BSD</glossterm>
      <glosssee otherterm="bsd-glossary"/>
    </glossentry>

    <glossentry xml:id="bar-glossary">
      <glossterm xml:lang="en">Base Address Register</glossterm>
      <acronym xml:lang="en">BAR</acronym>
      <glossdef>
        <para xml:lang="en">The registers that determine which address range a <acronym>PCI</acronym> device
	  will respond to.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="bios-glossary">
      <glossterm xml:lang="en">Basic Input/Output System</glossterm>
      <acronym xml:lang="en">BIOS</acronym>
      <glossdef>
        <para xml:lang="en">The definition of <acronym>BIOS</acronym> depends a bit on
	  the context. Some people refer to it as the <acronym>ROM</acronym>
	  chip with a basic set of routines to provide an interface between
	  software and hardware.  Others refer to it as the set of routines
	  contained in the chip that help in bootstrapping the system.  Some
	  might also refer to it as the screen used to configure the
	  bootstrapping process. The <acronym>BIOS</acronym> is PC-specific
	  but other systems have something similar.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="bind-glossary">
      <glossterm xml:lang="en">Berkeley Internet Name Domain</glossterm>
      <acronym xml:lang="en">BIND</acronym>
      <glossdef>
	<para xml:lang="en">An implementation of the <acronym>DNS</acronym> protocols.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="bsd-glossary">
      <glossterm xml:lang="en">Berkeley Software Distribution</glossterm>
      <acronym xml:lang="en">BSD</acronym>
      <glossdef>
	<para xml:lang="en">This is the name that the Computer Systems Research Group
	  (CSRG) at <link xlink:href="http://www.berkeley.edu">The University
	  of California at Berkeley</link>
	  gave to their improvements and modifications to
	  AT&amp;T's 32V <trademark class="registered">UNIX</trademark>.
	  FreeBSD is a descendant of the CSRG work.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="bikeshed-glossary">
      <glossterm xml:lang="en">Bikeshed Building</glossterm>
      <glossdef subject="FreeBSD">
	<para xml:lang="en">A phenomenon whereby many people will give an opinion on
	  an uncomplicated topic, whilst a complex topic receives little
	  or no discussion.  See the
	  <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/books/faq/misc.html#BIKESHED-PAINTING">FAQ</link> for
	  the origin of the term.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">C</title>

    <glossentry>
      <glossterm xml:lang="en">CD</glossterm>
      <glosssee otherterm="cd-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">CHAP</glossterm>
      <glosssee otherterm="chap-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">CLIP</glossterm>
      <glosssee otherterm="clip-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">COFF</glossterm>
      <glosssee otherterm="coff-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">CPU</glossterm>
      <glosssee otherterm="cpu-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">CTS</glossterm>
      <glosssee otherterm="cts-glossary"/>
    </glossentry>

    <glossentry xml:id="cd-glossary">
      <glossterm xml:lang="en">Carrier Detect</glossterm>
      <acronym xml:lang="en">CD</acronym>
      <glossdef>
	<para xml:lang="en">An <acronym>RS232C</acronym> signal indicating that a carrier
	  has been detected.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="cpu-glossary">
      <glossterm xml:lang="en">Central Processing Unit</glossterm>
      <acronym xml:lang="en">CPU</acronym>
      <glossdef>
        <para xml:lang="en">Also known as the processor.  This is the brain of the
	  computer where all calculations take place.  There are a number of
	  different architectures with different instruction sets.  Among
	  the more well-known are the Intel-x86 and derivatives, Sun SPARC,
	  PowerPC, and Alpha.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="chap-glossary">
      <glossterm xml:lang="en">Challenge Handshake Authentication Protocol</glossterm>
      <acronym xml:lang="en">CHAP</acronym>
      <glossdef>
        <para xml:lang="en">A method of authenticating a user, based on a secret shared
	  between client and server.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="clip-glossary">
      <glossterm xml:lang="en">Classical <acronym>IP</acronym> over <acronym>ATM</acronym></glossterm>
      <acronym xml:lang="en">CLIP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="cts-glossary">
      <glossterm xml:lang="en">Clear To Send</glossterm>
      <acronym xml:lang="en">CTS</acronym>
      <glossdef>
	<para xml:lang="en">An <acronym>RS232C</acronym> signal giving the remote system
          permission to send data.</para>
	<glossseealso otherterm="rts-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="coff-glossary">
      <glossterm xml:lang="en">Common Object File Format</glossterm>
      <acronym xml:lang="en">COFF</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">D</title>

    <glossentry>
      <glossterm xml:lang="en">DAC</glossterm>
      <glosssee otherterm="dac-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">DDB</glossterm>
      <glosssee otherterm="ddb-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">DES</glossterm>
      <glosssee otherterm="des-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">DHCP</glossterm>
      <glosssee otherterm="dhcp-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">DNS</glossterm>
      <glosssee otherterm="dns-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">DSDT</glossterm>
      <glosssee otherterm="dsdt-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">DSR</glossterm>
      <glosssee otherterm="dsr-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">DTR</glossterm>
      <glosssee otherterm="dtr-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">DVMRP</glossterm>
      <glosssee otherterm="dvmrp-glossary"/>
    </glossentry>

    <glossentry xml:id="dac-glossary">
      <glossterm xml:lang="en">Discretionary Access Control</glossterm>
      <acronym xml:lang="en">DAC</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="des-glossary">
      <glossterm xml:lang="en">Data Encryption Standard</glossterm>
      <acronym xml:lang="en">DES</acronym>
      <glossdef>
	<para xml:lang="en">A method of encrypting information, traditionally used as the
	  method of encryption for <trademark class="registered">UNIX</trademark> passwords and the <citerefentry><refentrytitle>crypt</refentrytitle><manvolnum>3</manvolnum></citerefentry>
	  function.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="dsr-glossary">
      <glossterm xml:lang="en">Data Set Ready</glossterm>
      <acronym xml:lang="en">DSR</acronym>
      <glossdef>
	<para xml:lang="en">An <acronym>RS232C</acronym> signal sent from the modem to the
	  computer or terminal indicating a readiness to send and receive
	  data.</para>
	<glossseealso otherterm="dtr-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="dtr-glossary">
      <glossterm xml:lang="en">Data Terminal Ready</glossterm>
      <acronym xml:lang="en">DTR</acronym>
      <glossdef>
	<para xml:lang="en">An <acronym>RS232C</acronym> signal sent from the computer or
	  terminal to the modem indicating a readiness to send and receive
	  data.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ddb-glossary">
      <glossterm xml:lang="en">Debugger</glossterm>
      <acronym xml:lang="en">DDB</acronym>
      <glossdef>
	<para xml:lang="en">An interactive in-kernel facility for examining the status of
	  a system, often used after a system has crashed to establish the
	  events surrounding the failure.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="dsdt-glossary">
      <glossterm xml:lang="en">Differentiated System Description Table</glossterm>
      <acronym xml:lang="en">DSDT</acronym>
      <glossdef>
        <para xml:lang="en">An <acronym>ACPI</acronym> table, supplying basic configuration
	  information about the base system.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="dvmrp-glossary">
      <glossterm xml:lang="en">Distance-Vector Multicast Routing Protocol</glossterm>
      <acronym xml:lang="en">DVMRP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="dns-glossary">
      <glossterm xml:lang="en">Domain Name System</glossterm>
      <acronym xml:lang="en">DNS</acronym>
      <glossdef>
	<para xml:lang="en">The system that converts humanly readable hostnames (i.e.,
	  mail.example.net) to Internet addresses and vice versa.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="dhcp-glossary">
      <glossterm xml:lang="en">Dynamic Host Configuration Protocol</glossterm>
      <acronym xml:lang="en">DHCP</acronym>
      <glossdef>
	<para xml:lang="en">A protocol that dynamically assigns IP addresses to a computer
	  (host) when it requests one from the server.  The address assignment
	  is called a <quote>lease</quote>.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">E</title>

    <glossentry>
      <glossterm xml:lang="en">ECOFF</glossterm>
      <glosssee otherterm="ecoff-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">ELF</glossterm>
      <glosssee otherterm="elf-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">ESP</glossterm>
      <glosssee otherterm="esp-glossary"/>
    </glossentry>

    <glossentry xml:id="esp-glossary">
      <glossterm xml:lang="en">Encapsulated Security Payload</glossterm>
      <acronym xml:lang="en">ESP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="elf-glossary">
      <glossterm xml:lang="en">Executable and Linking Format</glossterm>
      <acronym xml:lang="en">ELF</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ecoff-glossary">
      <glossterm xml:lang="en">Extended <acronym>COFF</acronym></glossterm>
      <acronym xml:lang="en">ECOFF</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">F</title>

    <glossentry>
      <glossterm xml:lang="en">FADT</glossterm>
      <glosssee otherterm="fadt-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">FAT</glossterm>
      <glosssee otherterm="fat-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">FAT16</glossterm>
      <glosssee otherterm="fat16-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">FTP</glossterm>
      <glosssee otherterm="ftp-glossary"/>
    </glossentry>

    <glossentry xml:id="fat-glossary">
      <glossterm xml:lang="en">File Allocation Table</glossterm>
      <acronym xml:lang="en">FAT</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="fat16-glossary">
      <glossterm xml:lang="en">File Allocation Table (16-bit)</glossterm>
      <acronym xml:lang="en">FAT16</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ftp-glossary">
      <glossterm xml:lang="en">File Transfer Protocol</glossterm>
      <acronym xml:lang="en">FTP</acronym>
      <glossdef>
	<para xml:lang="en">A member of the family of high-level protocols implemented
	  on top of <acronym>TCP</acronym> which can be used to transfer
	  files over a <acronym>TCP/IP</acronym> network.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="fadt-glossary">
      <glossterm xml:lang="en">Fixed <acronym>ACPI</acronym> Description Table</glossterm>
      <acronym xml:lang="en">FADT</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">G</title>

    <glossentry>
      <glossterm xml:lang="en">GUI</glossterm>
      <glosssee otherterm="gui-glossary"/>
    </glossentry>

    <glossentry xml:id="giant-glossary">
      <glossterm xml:lang="en">Giant</glossterm>
      <glossdef subject="FreeBSD">
	<para xml:lang="en">The name of a mutual exclusion mechanism
	  (a <literal>sleep mutex</literal>) that protects a large
	  set of kernel resources.  Although a simple locking mechanism
	  was adequate in the days where a machine might have only
	  a few dozen processes, one networking card, and certainly
	  only one processor, in current times it is an unacceptable
	  performance bottleneck.  FreeBSD developers are actively working
	  to replace it with locks that protect individual resources,
	  which will allow a much greater degree of parallelism for
	  both single-processor and multi-processor machines.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="gui-glossary">
      <glossterm xml:lang="en">Graphical User Interface</glossterm>
      <acronym xml:lang="en">GUI</acronym>
      <glossdef>
        <para xml:lang="en">A system where the user and computer interact with
          graphics.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">H</title>

    <glossentry>
      <glossterm xml:lang="en">HTML</glossterm>
      <glosssee otherterm="html-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">HUP</glossterm>
      <glosssee otherterm="hup-glossary"/>
    </glossentry>

    <glossentry xml:id="hup-glossary">
      <glossterm xml:lang="en">HangUp</glossterm>
      <acronym xml:lang="en">HUP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="html-glossary">
      <glossterm xml:lang="en">HyperText Markup Language</glossterm>
      <acronym xml:lang="en">HTML</acronym>
      <glossdef>
        <para xml:lang="en">The markup language used to create web pages.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">I</title>

    <glossentry>
      <glossterm xml:lang="en">I/O</glossterm>
      <glosssee otherterm="io-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">IASL</glossterm>
      <glosssee otherterm="iasl-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">IMAP</glossterm>
      <glosssee otherterm="imap-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">IP</glossterm>
      <glosssee otherterm="ip-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">IPFW</glossterm>
      <glosssee otherterm="ipfw-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">IPP</glossterm>
      <glosssee otherterm="ipp-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">IPv4</glossterm>
      <glosssee otherterm="ipv4-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">IPv6</glossterm>
      <glosssee otherterm="ipv6-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">ISP</glossterm>
      <glosssee otherterm="isp-glossary"/>
    </glossentry>

    <glossentry xml:id="ipfw-glossary">
      <glossterm xml:lang="en"><acronym>IP</acronym> Firewall</glossterm>
      <acronym xml:lang="en">IPFW</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ipv4-glossary">
      <glossterm xml:lang="en"><acronym>IP</acronym> Version 4</glossterm>
      <acronym xml:lang="en">IPv4</acronym>
      <glossdef>
	<para xml:lang="en">The <acronym>IP</acronym> protocol version 4, which uses 32 bits
	  for addressing.  This version is still the most widely used, but it
	  is slowly being replaced with <acronym>IPv6</acronym>.</para>
	<glossseealso otherterm="ipv6-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ipv6-glossary">
      <glossterm xml:lang="en"><acronym>IP</acronym> Version 6</glossterm>
      <acronym xml:lang="en">IPv6</acronym>
      <glossdef>
	<para xml:lang="en">The new <acronym>IP</acronym> protocol. Invented because the
	  address space in <acronym>IPv4</acronym> is running out.  Uses 128
	  bits for addressing.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="io-glossary">
      <glossterm xml:lang="en">Input/Output</glossterm>
      <acronym xml:lang="en">I/O</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="iasl-glossary">
      <glossterm xml:lang="en">Intel’s <acronym>ASL</acronym> compiler</glossterm>
      <acronym xml:lang="en">IASL</acronym>
      <glossdef>
        <para xml:lang="en">Intel’s compiler for converting <acronym>ASL</acronym> into
	  <acronym>AML</acronym>.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="imap-glossary">
      <glossterm xml:lang="en">Internet Message Access Protocol</glossterm>
      <acronym xml:lang="en">IMAP</acronym>
      <glossdef>
	<para xml:lang="en">A protocol for accessing email messages on a mail server,
	  characterised by the messages usually being kept on the server as
	  opposed to being downloaded to the mail reader client.</para>
	<glossseealso otherterm="pop3-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ipp-glossary">
      <glossterm xml:lang="en">Internet Printing Protocol</glossterm>
      <acronym xml:lang="en">IPP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ip-glossary">
      <glossterm xml:lang="en">Internet Protocol</glossterm>
      <acronym xml:lang="en">IP</acronym>
      <glossdef>
	<para xml:lang="en">The packet transmitting protocol that is the basic protocol on
	  the Internet.  Originally developed at the U.S. Department of
	  Defense and an extremely important part of the <acronym>TCP/IP
	  </acronym> stack.  Without the Internet Protocol, the Internet
	  would not have become what it is today.  For more information, see
	  <link xlink:href="ftp://ftp.rfc-editor.org/in-notes/rfc791.txt">
	  RFC 791</link>.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="isp-glossary">
      <glossterm xml:lang="en">Internet Service Provider</glossterm>
      <acronym xml:lang="en">ISP</acronym>
      <glossdef>
	<para xml:lang="en">A company that provides access to the Internet.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">K</title>

    <glossentry xml:id="kame-glossary">
      <glossterm xml:lang="en">KAME</glossterm>
      <glossdef>
        <para xml:lang="en">Japanese for <quote>turtle</quote>, the term KAME is used
	  in computing circles to refer to the <link xlink:href="http://www.kame.net/">KAME Project</link>, who work on
	  an implementation of <acronym>IPv6</acronym>.</para>
      </glossdef>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">KDC</glossterm>
      <glosssee otherterm="kdc-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">KLD</glossterm>
      <glosssee otherterm="kld-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">KSE</glossterm>
      <glosssee otherterm="kse-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">KVA</glossterm>
      <glosssee otherterm="kva-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">Kbps</glossterm>
      <glosssee otherterm="kbps-glossary"/>
    </glossentry>

    <glossentry xml:id="kld-glossary">
      <glossterm xml:lang="en">Kernel <citerefentry><refentrytitle>ld</refentrytitle><manvolnum>1</manvolnum></citerefentry></glossterm>
      <acronym xml:lang="en">KLD</acronym>
      <glossdef>
	<para xml:lang="en">A method of dynamically loading functionality into a FreeBSD kernel
	  without rebooting the system.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="kse-glossary">
      <glossterm xml:lang="en">Kernel Scheduler Entities</glossterm>
      <acronym xml:lang="en">KSE</acronym>
      <glossdef>
	<para xml:lang="en">A kernel-supported threading system.  See the <link xlink:href="http://www.FreeBSD.org/kse">project home page</link>
	  for further details.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="kva-glossary">
      <glossterm xml:lang="en">Kernel Virtual Address</glossterm>
      <acronym xml:lang="en">KVA</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="kdc-glossary">
      <glossterm xml:lang="en">Key Distribution Center</glossterm>
      <acronym xml:lang="en">KDC</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="kbps-glossary">
      <glossterm xml:lang="en">Kilo Bits Per Second</glossterm>
      <acronym xml:lang="en">Kbps</acronym>
      <glossdef>
	<para xml:lang="en">Used to measure bandwidth (how much data can pass a given
	  point at a specified amount of time).  Alternates to the Kilo
	  prefix include Mega, Giga, Tera, and so forth.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">L</title>

    <glossentry>
      <glossterm xml:lang="en">LAN</glossterm>
      <glosssee otherterm="lan-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">LOR</glossterm>
      <glosssee otherterm="lor-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">LPD</glossterm>
      <glosssee otherterm="lpd-glossary"/>
    </glossentry>

    <glossentry xml:id="lpd-glossary">
      <glossterm xml:lang="en">Line Printer Daemon</glossterm>
      <acronym xml:lang="en">LPD</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="lan-glossary">
      <glossterm xml:lang="en">Local Area Network</glossterm>
      <acronym xml:lang="en">LAN</acronym>
      <glossdef>
	<para xml:lang="en">A network used on a local area, e.g. office, home, or so forth.
	  </para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="lor-glossary">
      <glossterm xml:lang="en">Lock Order Reversal</glossterm>
      <acronym xml:lang="en">LOR</acronym>
      <glossdef>
	<para xml:lang="en">The FreeBSD kernel uses a number of resource locks to
	  arbitrate contention for those resources.  A run-time
	  lock diagnostic system found in FreeBSD-CURRENT kernels
	  (but removed for releases), called <citerefentry><refentrytitle>witness</refentrytitle><manvolnum>4</manvolnum></citerefentry>,
	  detects the potential for deadlocks due to locking errors.
	  (<citerefentry><refentrytitle>witness</refentrytitle><manvolnum>4</manvolnum></citerefentry> is actually slightly conservative, so
	  it is possible to get false positives.)  A true positive
	  report indicates that <quote>if you were unlucky, a deadlock would
	  have happened here</quote>.</para>

	<para xml:lang="en">True positive LORs tend to get fixed quickly, so
	  check http://lists.FreeBSD.org/mailman/listinfo/freebsd-current and the
	  <link xlink:href="http://sources.zabbadoz.net/freebsd/lor.html">
	  LORs Seen</link> page before posting to the mailing lists.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">M</title>

    <glossentry>
      <glossterm xml:lang="en">MAC</glossterm>
      <glosssee otherterm="mac-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">MADT</glossterm>
      <glosssee otherterm="madt-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">MFC</glossterm>
      <glosssee otherterm="mfc-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">MFH</glossterm>
      <glosssee otherterm="mfh-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">MFS</glossterm>
      <glosssee otherterm="mfs-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">MIT</glossterm>
      <glosssee otherterm="mit-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">MLS</glossterm>
      <glosssee otherterm="mls-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">MOTD</glossterm>
      <glosssee otherterm="motd-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">MTA</glossterm>
      <glosssee otherterm="mta-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">MUA</glossterm>
      <glosssee otherterm="mua-glossary"/>
    </glossentry>

    <glossentry xml:id="mta-glossary">
      <glossterm xml:lang="en">Mail Transfer Agent</glossterm>
      <acronym xml:lang="en">MTA</acronym>
      <glossdef>
	<para xml:lang="en">An application used to transfer email.  An
	  <acronym>MTA</acronym> has traditionally been part of the BSD
	  base system.  Today Sendmail is included in the base system, but
	  there are many other <acronym>MTA</acronym>s, such as postfix,
	  qmail and Exim.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="mua-glossary">
      <glossterm xml:lang="en">Mail User Agent</glossterm>
      <acronym xml:lang="en">MUA</acronym>
      <glossdef>
	<para xml:lang="en">An application used by users to display and write email.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="mac-glossary">
      <glossterm>強制存取控制 (MAC)</glossterm>
      <acronym xml:lang="en">MAC</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="mit-glossary">
      <glossterm xml:lang="en">Massachusetts Institute of Technology</glossterm>
      <acronym xml:lang="en">MIT</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="mfc-glossary">
      <glossterm xml:lang="en">Merge From Current</glossterm>
      <acronym xml:lang="en">MFC</acronym>
      <glossdef subject="FreeBSD">
	<para xml:lang="en">To merge functionality or a patch from the -CURRENT
	  branch to another, most often -STABLE.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="mfh-glossary">
      <glossterm xml:lang="en">Merge From Head</glossterm>
      <acronym xml:lang="en">MFH</acronym>
      <glossdef subject="FreeBSD">
	<para xml:lang="en">To merge functionality or a patch from a repository HEAD
	  to an earlier branch.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="mfs-glossary">
      <glossterm xml:lang="en">Merge From Stable</glossterm>
      <acronym xml:lang="en">MFS</acronym>
      <glossdef subject="FreeBSD">
	<para xml:lang="en">In the normal course of FreeBSD development, a change will
	  be committed to the -CURRENT branch for testing before being
	  merged to -STABLE.  On rare occasions, a change will go into
	  -STABLE first and then be merged to -CURRENT.</para>

	<para xml:lang="en">This term is also used when a patch is merged from -STABLE
	  to a security branch.</para>
	<glossseealso otherterm="mfc-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="motd-glossary">
      <glossterm xml:lang="en">Message Of The Day</glossterm>
      <acronym xml:lang="en">MOTD</acronym>
      <glossdef>
        <para xml:lang="en">A message, usually shown on login, often used to
	  distribute information to users of the system.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="mls-glossary">
      <glossterm xml:lang="en">Multi-Level Security</glossterm>
      <acronym xml:lang="en">MLS</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="madt-glossary">
      <glossterm xml:lang="en">Multiple <acronym>APIC</acronym> Description Table</glossterm>
      <acronym xml:lang="en">MADT</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">N</title>

    <glossentry>
      <glossterm xml:lang="en">NAT</glossterm>
      <glosssee otherterm="nat-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">NDISulator</glossterm>
      <glosssee otherterm="projectevil-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">NFS</glossterm>
      <glosssee otherterm="nfs-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">NTFS</glossterm>
      <glosssee otherterm="ntfs-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">NTP</glossterm>
      <glosssee otherterm="ntp-glossary"/>
    </glossentry>

    <glossentry xml:id="nat-glossary">
      <glossterm xml:lang="en">Network Address Translation</glossterm>
      <acronym xml:lang="en">NAT</acronym>
      <glossdef>
        <para xml:lang="en">A technique where <acronym>IP</acronym> packets are rewritten
	  on the way through a gateway, enabling many machines behind the
	  gateway to effectively share a single <acronym>IP</acronym> address.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="nfs-glossary">
      <glossterm xml:lang="en">Network File System</glossterm>
      <acronym xml:lang="en">NFS</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ntfs-glossary">
      <glossterm xml:lang="en">New Technology File System</glossterm>
      <acronym xml:lang="en">NTFS</acronym>
      <glossdef>
        <para xml:lang="en">A filesystem developed by Microsoft and available in its
	  <quote>New Technology</quote> operating systems, such as
	  <trademark class="registered">Windows</trademark> 2000, <trademark class="registered">Windows NT</trademark> and <trademark class="registered">Windows</trademark> XP.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ntp-glossary">
      <glossterm xml:lang="en">Network Time Protocol</glossterm>
      <acronym xml:lang="en">NTP</acronym>
      <glossdef>
        <para xml:lang="en">A means of synchronizing clocks over a network.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">O</title>

    <glossentry>
      <glossterm xml:lang="en">OBE</glossterm>
      <glosssee otherterm="obe-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">ODMR</glossterm>
      <glosssee otherterm="odmr-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">OS</glossterm>
      <glosssee otherterm="os-glossary"/>
    </glossentry>

    <glossentry xml:id="odmr-glossary">
      <glossterm xml:lang="en">On-Demand Mail Relay</glossterm>
      <acronym xml:lang="en">ODMR</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="os-glossary">
      <glossterm xml:lang="en">Operating System</glossterm>
      <acronym xml:lang="en">OS</acronym>
      <glossdef>
	<para xml:lang="en">A set of programs, libraries and tools that provide access to
	  the hardware resources of a computer.  Operating systems range
	  today from simplistic designs that support only one program
	  running at a time, accessing only one device to fully
	  multi-user, multi-tasking and multi-process systems that can
	  serve thousands of users simultaneously, each of them running
	  dozens of different applications.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="obe-glossary">
      <glossterm xml:lang="en">Overtaken By Events</glossterm>
      <acronym xml:lang="en">OBE</acronym>
      <glossdef>
	<para xml:lang="en">Indicates a suggested change (such as a Problem Report
	  or a feature request) which is no longer relevant or
	  applicable due to such things as later changes to FreeBSD,
	  changes in networking standards, the affected hardware
	  having since become obsolete, and so forth.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">P</title>

    <glossentry>
      <glossterm xml:lang="en">PAE</glossterm>
      <glosssee otherterm="pae-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PAM</glossterm>
      <glosssee otherterm="pam-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PAP</glossterm>
      <glosssee otherterm="pap-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PC</glossterm>
      <glosssee otherterm="pc-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PCNSFD</glossterm>
      <glosssee otherterm="pcnfsd-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PDF</glossterm>
      <glosssee otherterm="pdf-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PID</glossterm>
      <glosssee otherterm="pid-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">POLA</glossterm>
      <glosssee otherterm="pola-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">POP</glossterm>
      <glosssee otherterm="pop-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">POP3</glossterm>
      <glosssee otherterm="pop3-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PPD</glossterm>
      <glosssee otherterm="ppd-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PPP</glossterm>
      <glosssee otherterm="ppp-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PPPoA</glossterm>
      <glosssee otherterm="pppoa-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PPPoE</glossterm>
      <glosssee otherterm="pppoe-glossary"/>
    </glossentry>

    <glossentry xml:id="pppoa-glossary">
      <glossterm xml:lang="en"><acronym>PPP</acronym> over <acronym>ATM</acronym></glossterm>
      <acronym xml:lang="en">PPPoA</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pppoe-glossary">
      <glossterm xml:lang="en"><acronym>PPP</acronym> over <acronym>Ethernet</acronym></glossterm>
      <acronym xml:lang="en">PPPoE</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PR</glossterm>
      <glosssee otherterm="pr-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">PXE</glossterm>
      <glosssee otherterm="pxe-glossary"/>
    </glossentry>

    <glossentry xml:id="pap-glossary">
      <glossterm xml:lang="en">Password Authentication Protocol</glossterm>
      <acronym xml:lang="en">PAP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pc-glossary">
      <glossterm xml:lang="en">Personal Computer</glossterm>
      <acronym xml:lang="en">PC</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pcnfsd-glossary">
      <glossterm xml:lang="en">Personal Computer Network File System Daemon</glossterm>
      <acronym xml:lang="en">PCNFSD</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pae-glossary">
      <glossterm xml:lang="en">Physical Address Extensions</glossterm>
      <acronym xml:lang="en">PAE</acronym>
      <glossdef>
        <para xml:lang="en">A method of enabling access to up to 64 GB of <acronym>RAM</acronym> on
	  systems which only physically have a 32-bit wide address space
	  (and would therefore be limited to 4 GB without PAE).</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pam-glossary">
      <glossterm xml:lang="en">Pluggable Authentication Modules</glossterm>
      <acronym xml:lang="en">PAM</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ppp-glossary">
      <glossterm xml:lang="en">Point-to-Point Protocol</glossterm>
      <acronym xml:lang="en">PPP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pointyhat">
      <glossterm xml:lang="en">Pointy Hat</glossterm>
      <glossdef subject="FreeBSD">
	<para xml:lang="en">A mythical piece of headgear, much like a
	  <literal>dunce cap</literal>, awarded to any FreeBSD
	  committer who breaks the build, makes revision numbers
	  go backwards, or creates any other kind of havoc in
	  the source base.  Any committer worth his or her salt
	  will soon accumulate a large collection.  The usage is
	  (almost always?) humorous.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pdf-glossary">
      <glossterm xml:lang="en">Portable Document Format</glossterm>
      <acronym xml:lang="en">PDF</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pop-glossary">
      <glossterm xml:lang="en">Post Office Protocol</glossterm>
      <acronym xml:lang="en">POP</acronym>
      <glossdef>
        <para/>
	<glossseealso otherterm="pop3-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pop3-glossary">
      <glossterm xml:lang="en">Post Office Protocol Version 3</glossterm>
      <acronym xml:lang="en">POP3</acronym>
      <glossdef>
	<para xml:lang="en">A protocol for accessing email messages on a mail server,
	  characterised by the messages usually being downloaded from the
	  server to the client, as opposed to remaining on the server.</para>
	<glossseealso otherterm="imap-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ppd-glossary">
      <glossterm xml:lang="en">PostScript Printer Description</glossterm>
      <acronym xml:lang="en">PPD</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pxe-glossary">
      <glossterm xml:lang="en">Preboot eXecution Environment</glossterm>
      <acronym xml:lang="en">PXE</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pola-glossary">
      <glossterm xml:lang="en">Principle Of Least Astonishment</glossterm>
      <acronym xml:lang="en">POLA</acronym>
      <glossdef>
	<para xml:lang="en">As FreeBSD evolves, changes visible to the user should be
	  kept as unsurprising as possible.  For example, arbitrarily
	  rearranging system startup variables in
	  <filename>/etc/defaults/rc.conf</filename> violates
	  <acronym>POLA</acronym>.  Developers consider
	  <acronym>POLA</acronym> when contemplating user-visible
	  system changes.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pr-glossary">
      <glossterm xml:lang="en">Problem Report</glossterm>
      <acronym xml:lang="en">PR</acronym>
      <glossdef>
        <para xml:lang="en">A description of some kind of problem that has been
	  found in either the FreeBSD source or documentation.  See
	  <link xlink:href="@@URL_RELPREFIX@@/doc/en_US.ISO8859-1/articles/problem-reports/index.html">
	  Writing FreeBSD Problem Reports</link>.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="pid-glossary">
      <glossterm xml:lang="en">Process ID</glossterm>
      <acronym xml:lang="en">PID</acronym>
      <glossdef>
        <para xml:lang="en">A number, unique to a particular process on a system,
	  which identifies it and allows actions to be taken against it.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="projectevil-glossary">
      <glossterm xml:lang="en">Project Evil</glossterm>
      <glossdef subject="FreeBSD">
	<para xml:lang="en">The working title for the <acronym>NDISulator</acronym>,
	  written by Bill Paul, who named it referring to how awful
	  it is (from a philosophical standpoint) to need to have
	  something like this in the first place.  The
	  <acronym>NDISulator</acronym> is a special compatibility
	  module to allow Microsoft Windows™ NDIS miniport
	  network drivers to be used with FreeBSD/i386.  This is usually
	  the only way to use cards where the driver is closed-source.
	  See <filename>src/sys/compat/ndis/subr_ndis.c</filename>.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">R</title>

    <glossentry>
      <glossterm xml:lang="en">RA</glossterm>
      <glosssee otherterm="ra-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">RAID</glossterm>
      <glosssee otherterm="raid-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">RAM</glossterm>
      <glosssee otherterm="ram-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">RD</glossterm>
      <glosssee otherterm="rd-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">RFC</glossterm>
      <glosssee otherterm="rfc-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">RISC</glossterm>
      <glosssee otherterm="risc-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">RPC</glossterm>
      <glosssee otherterm="rpc-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">RS232C</glossterm>
      <glosssee otherterm="rs232c-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">RTS</glossterm>
      <glosssee otherterm="rts-glossary"/>
    </glossentry>

    <glossentry xml:id="ram-glossary">
      <glossterm xml:lang="en">Random Access Memory</glossterm>
      <acronym xml:lang="en">RAM</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="rcs-glossary">
      <glossterm xml:lang="en">Revision Control System</glossterm>
      <acronym xml:lang="en">RCS</acronym>
      <glossdef>
        <para xml:lang="en">The <emphasis>Revision Control System</emphasis>
          (<acronym>RCS</acronym>) is one of the oldest software suites
          that implement <quote>revision control</quote> for plain
          files.  It allows the storage, retrieval, archival, logging,
          identification and merging of multiple revisions for each
          file.  RCS consists of many small tools that work together.
          It lacks some of the features found in more modern revision
          control systems, like Git, but it is very simple
          to install, configure, and start using for a small set of
          files.</para>

	<glossseealso otherterm="svn-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="rd-glossary">
      <glossterm xml:lang="en">Received Data</glossterm>
      <acronym xml:lang="en">RD</acronym>
      <glossdef>
	<para xml:lang="en">An <acronym>RS232C</acronym> pin or wire that data is
	  received on.</para>
	<glossseealso otherterm="td-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="rs232c-glossary">
      <glossterm xml:lang="en">Recommended Standard 232C</glossterm>
      <acronym xml:lang="en">RS232C</acronym>
      <glossdef>
        <para xml:lang="en">A standard for communications between serial devices.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="risc-glossary">
      <glossterm xml:lang="en">Reduced Instruction Set Computer</glossterm>
      <acronym xml:lang="en">RISC</acronym>
      <glossdef>
	<para xml:lang="en">An approach to processor design where the operations the hardware
	  can perform are simplified but made as general purpose as possible.
	  This can lead to lower power consumption, fewer transistors and in
	  some cases, better performance and increased code density.  Examples
	  of RISC processors include the Alpha, <trademark class="registered">SPARC</trademark>, <trademark class="registered">ARM</trademark> and
	  <trademark class="registered">PowerPC</trademark>.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="raid-glossary">
      <glossterm xml:lang="en">Redundant Array of Inexpensive Disks</glossterm>
      <acronym xml:lang="en">RAID</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="rpc-glossary">
      <glossterm xml:lang="en">Remote Procedure Call</glossterm>
      <acronym xml:lang="en">RPC</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="rfc-glossary">
      <glossterm xml:lang="en">Request For Comments</glossterm>
      <acronym xml:lang="en">RFC</acronym>
      <glossdef>
	<para xml:lang="en">A set of documents defining Internet standards, protocols, and
	  so forth.  See
	  <link xlink:href="http://www.rfc-editor.org/">www.rfc-editor.org</link>.
	  </para>

	<para xml:lang="en">Also used as a general term when someone has a suggested change
	  and wants feedback.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="rts-glossary">
      <glossterm xml:lang="en">Request To Send</glossterm>
      <acronym xml:lang="en">RTS</acronym>
      <glossdef>
	<para xml:lang="en">An <acronym>RS232C</acronym> signal requesting that the remote
	  system commences transmission of data.</para>
	<glossseealso otherterm="cts-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ra-glossary">
      <glossterm xml:lang="en">Router Advertisement</glossterm>
      <acronym xml:lang="en">RA</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">S</title>

    <glossentry>
      <glossterm xml:lang="en">SCI</glossterm>
      <glosssee otherterm="sci-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">SCSI</glossterm>
      <glosssee otherterm="scsi-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">SG</glossterm>
      <glosssee otherterm="sg-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">SMB</glossterm>
      <glosssee otherterm="smb-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">SMP</glossterm>
      <glosssee otherterm="smp-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">SMTP</glossterm>
      <glosssee otherterm="smtp-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">SMTP AUTH</glossterm>
      <glosssee otherterm="smtpauth-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">SSH</glossterm>
      <glosssee otherterm="ssh-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">STR</glossterm>
      <glosssee otherterm="str-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">SVN</glossterm>
      <glosssee otherterm="svn-glossary"/>
    </glossentry>

    <glossentry xml:id="smtpauth-glossary">
      <glossterm xml:lang="en"><acronym>SMTP</acronym> Authentication</glossterm>
      <acronym xml:lang="en">SMTP AUTH</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="smb-glossary">
      <glossterm xml:lang="en">Server Message Block</glossterm>
      <acronym xml:lang="en">SMB</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="sg-glossary">
      <glossterm xml:lang="en">Signal Ground</glossterm>
      <acronym xml:lang="en">SG</acronym>
      <glossdef>
	<para xml:lang="en">An <acronym>RS232</acronym> pin or wire that is the ground
	  reference for the signal.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="smtp-glossary">
      <glossterm xml:lang="en">Simple Mail Transfer Protocol</glossterm>
      <acronym xml:lang="en">SMTP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ssh-glossary">
      <glossterm xml:lang="en">Secure Shell</glossterm>
      <acronym xml:lang="en">SSH</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="scsi-glossary">
      <glossterm xml:lang="en">Small Computer System Interface</glossterm>
      <acronym xml:lang="en">SCSI</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="svn-glossary">
      <glossterm xml:lang="en">Subversion</glossterm>
      <acronym xml:lang="en">SVN</acronym>
      <glossdef>
	<para xml:lang="en">Subversion is a version control system
          currently used by the FreeBSD project.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="str-glossary">
      <glossterm xml:lang="en">Suspend To <acronym>RAM</acronym></glossterm>
      <acronym xml:lang="en">STR</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="smp-glossary">
      <glossterm xml:lang="en">Symmetric MultiProcessor</glossterm>
      <acronym xml:lang="en">SMP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="sci-glossary">
      <glossterm xml:lang="en">System Control Interrupt</glossterm>
      <acronym xml:lang="en">SCI</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">T</title>

    <glossentry>
      <glossterm xml:lang="en">TCP</glossterm>
      <glosssee otherterm="tcp-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">TCP/IP</glossterm>
      <glosssee otherterm="tcpip-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">TD</glossterm>
      <glosssee otherterm="td-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">TFTP</glossterm>
      <glosssee otherterm="tftp-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">TGT</glossterm>
      <glosssee otherterm="tgt-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">TSC</glossterm>
      <glosssee otherterm="tsc-glossary"/>
    </glossentry>

    <glossentry xml:id="tgt-glossary">
      <glossterm xml:lang="en">Ticket-Granting Ticket</glossterm>
      <acronym xml:lang="en">TGT</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="tsc-glossary">
      <glossterm xml:lang="en">Time Stamp Counter</glossterm>
      <acronym xml:lang="en">TSC</acronym>
      <!-- From dg@, 20040814125503.GF40460@nexus.dglawrence.com -->
      <glossdef>
	<para xml:lang="en">A profiling counter internal to modern <trademark class="registered">Pentium</trademark> processors
	  that counts core frequency clock ticks.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="tcp-glossary">
      <glossterm xml:lang="en">Transmission Control Protocol</glossterm>
      <acronym xml:lang="en">TCP</acronym>
      <glossdef>
        <para xml:lang="en">A protocol that sits on top of (e.g.) the <acronym>IP</acronym>
	  protocol and guarantees that packets are delivered in a reliable,
	  ordered, fashion.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="tcpip-glossary">
      <glossterm xml:lang="en">Transmission Control Protocol/Internet Protocol</glossterm>
      <acronym xml:lang="en">TCP/IP</acronym>
      <glossdef>
        <para xml:lang="en">The term for the combination of the <acronym>TCP</acronym>
	  protocol running over the <acronym>IP</acronym> protocol.  Much of
	  the Internet runs over <acronym>TCP/IP</acronym>.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="td-glossary">
      <glossterm xml:lang="en">Transmitted Data</glossterm>
      <acronym xml:lang="en">TD</acronym>
      <glossdef>
	<para xml:lang="en">An <acronym>RS232C</acronym> pin or wire that data is transmitted
	  on.</para>
	<glossseealso otherterm="rd-glossary"/>
      </glossdef>
    </glossentry>

    <glossentry xml:id="tftp-glossary">
      <glossterm xml:lang="en">Trivial <acronym>FTP</acronym></glossterm>
      <acronym xml:lang="en">TFTP</acronym>
      <glossdef>
        <para/>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">U</title>

    <glossentry>
      <glossterm xml:lang="en">UDP</glossterm>
      <glosssee otherterm="udp-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">UFS1</glossterm>
      <glosssee otherterm="ufs1-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">UFS2</glossterm>
      <glosssee otherterm="ufs2-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">UID</glossterm>
      <glosssee otherterm="uid-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">URL</glossterm>
      <glosssee otherterm="url-glossary"/>
    </glossentry>

    <glossentry>
      <glossterm xml:lang="en">USB</glossterm>
      <glosssee otherterm="usb-glossary"/>
    </glossentry>

    <glossentry xml:id="url-glossary">
      <glossterm xml:lang="en">Uniform Resource Locator</glossterm>
      <acronym xml:lang="en">URL</acronym>
      <glossdef>
	<para xml:lang="en">A method of locating a resource, such as a document on
	  the Internet and a means to identify that resource.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ufs1-glossary">
      <glossterm xml:lang="en">Unix File System Version 1</glossterm>
      <acronym xml:lang="en">UFS1</acronym>
      <glossdef>
	<para xml:lang="en">The original <trademark class="registered">UNIX</trademark> file system, sometimes called the
	  Berkeley Fast File System.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="ufs2-glossary">
      <glossterm xml:lang="en">Unix File System Version 2</glossterm>
      <acronym xml:lang="en">UFS2</acronym>
      <glossdef>
	<para xml:lang="en">An extension to <acronym>UFS1</acronym>, introduced in
	  FreeBSD 5-CURRENT.  <acronym>UFS2</acronym> adds 64 bit block
	  pointers (breaking the 1T barrier), support for extended file
	  storage and other features.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="usb-glossary">
      <glossterm xml:lang="en">Universal Serial Bus</glossterm>
      <acronym xml:lang="en">USB</acronym>
      <glossdef>
	<para xml:lang="en">A hardware standard used to connect a wide variety of
	  computer peripherals to a universal interface.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="uid-glossary">
      <glossterm xml:lang="en">User ID</glossterm>
      <acronym xml:lang="en">UID</acronym>
      <glossdef>
        <para xml:lang="en">A unique number assigned to each user of a computer,
	  by which the resources and permissions assigned to that
	  user can be identified.</para>
      </glossdef>
    </glossentry>

    <glossentry xml:id="udp-glossary">
      <glossterm xml:lang="en">User Datagram Protocol</glossterm>
      <acronym xml:lang="en">UDP</acronym>
      <glossdef>
	<para xml:lang="en">A simple, unreliable datagram protocol which is used
	  for exchanging data on a TCP/IP network.  <acronym>UDP</acronym>
	  does not provide error checking and correction like
	  <acronym>TCP</acronym>.</para>
      </glossdef>
    </glossentry>
  </glossdiv>

  <glossdiv>
    <title xml:lang="en">V</title>

    <glossentry>
      <glossterm xml:lang="en">VPN</glossterm>
      <glosssee otherterm="vpn-glossary"/>
    </glossentry>

    <glossentry xml:id="vpn-glossary">
      <glossterm xml:lang="en">Virtual Private Network</glossterm>
      <acronym xml:lang="en">VPN</acronym>
      <glossdef>
	<para xml:lang="en">A method of using a public telecommunication
	  such as the Internet, to provide remote access to a
	  localized network, such as a corporate
	  <acronym>LAN</acronym>.</para>
      </glossdef>
    </glossentry>
  </glossdiv>
</glossary>

  <index/>
  
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->
<colophon version="5.0" xml:id="colophon">

  <para>本手冊是由數以百計 <quote>FreeBSD 文件計劃</quote> 的志願工作者所合作而成。 這些文字是由依據 DocBook DTD 規範的 XML 所寫， 並由 XSLT 將 XML 轉換成其他不同格式。 要是沒有 Donald Knuth 的 <application>TeX</application> 排版語言， Leslie Lamport 的 <application>LaTeX</application> 或 Sebastian Rahtz 的 <application>JadeTeX</application> 巨集套件的重要貢獻，本文件的印刷版本將無以完成。</para>
</colophon>

</book>
