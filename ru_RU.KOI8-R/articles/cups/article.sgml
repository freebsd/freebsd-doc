<!--
     The FreeBSD Russian Documentation Project

     $FreeBSD$

     Original revision: r36335
-->

<!DOCTYPE article PUBLIC "-//FreeBSD//DTD DocBook V4.1-Based Extension//EN" [
<!ENTITY % articles.ent PUBLIC "-//FreeBSD//ENTITIES DocBook FreeBSD Articles Entity Set//EN">
%articles.ent;
<!ENTITY % not.published "IGNORE">
]>
<!--
Translation:	Taras Korenko,
		Alexander Nedotsukov
 -->

<article lang="ru">
  <articleinfo>
    <title>Универсальная Система Печати Unix на FreeBSD</title>
    <pubdate>$FreeBSD$</pubdate>
    <authorgroup>
      <author>
	<firstname>Chess</firstname>
	<surname>Griffin</surname>
	<affiliation>
	  <address><email>chess@chessgriffin.com</email></address>
	</affiliation>
      </author>
    </authorgroup>

    <legalnotice id="trademarks" role="trademarks">
      &tm-attrib.freebsd;
      &tm-attrib.general;
    </legalnotice>

    <abstract>
      <para>Эта статья посвящена конфигурированию Универсальной Системы Печати
	UNIX (CUPS) на &os;.</para>
    </abstract>
  </articleinfo>

  <sect1 id="printing-cups">
    <title>Знакомимся с Универсальной Системой Печати UNIX (CUPS)</title>

    <indexterm><primary>printing</primary></indexterm>
    <indexterm><primary>CUPS</primary></indexterm>

    <para>Универсальная Система Печати UNIX (Common Unix Printing System, или
      сокращенно <application>CUPS</application>), предоставляет переносимую
      среду печати для &unix; и &unix;-подобных операционных систем.  Она была
      разработана компанией Easy Software Products, чтобы предоставить
      стандартное решение в печати для всех разработчиков и пользователей
      &unix;.</para>

    <para>Универсальная Система Печати UNIX использует протокол межсетевой
      печати (Internet Printing Protocol, <acronym>IPP</acronym>) как
      основу для управления заданиями на печать и очередями.  Также
      частично поддерживаются следующие протоколы: <acronym>LPD</acronym>,
      <acronym>SMB</acronym> и AppSocket (также известный как JetDirect).
      <application>CUPS</application> дает возможность обзора сетевых
      принтеров и использования опций, базирующихся на ПостСкрипт Описании
      Принтеров (PostScript Printer Definition, <acronym>PPD</acronym>),
      чтобы поддерживать в &unix; общепринятые традиции печати.  В результате
      <application>CUPS</application> идеально подходит для совместного
      использования принтеров в смешанной среде из &os;, &linux;,
      &macos;&nbsp;X или &windows;.</para>

    <para>Официальный сайт Универсальной Системы Печати UNIX &mdash;
	<ulink url="http://www.cups.org/"></ulink>.</para>
  </sect1>

  <sect1 id="printing-cups-install">
    <title>Установка сервера печати CUPS</title>

    <para><application>CUPS</application> может быть установлена
      из портов или уже собранных пакетов.  Чтобы установить
      <application>CUPS</application> из коллекции портов, выполните
      с привилегиями пользователя <username>root</username> следующую
      команду:</para>

    <screen>&prompt.root; <userinput>cd /usr/ports/print/cups && make install clean</userinput></screen>

    <para>Для установки <application>CUPS</application> используя пакет,
      запустите на выполнение такую команду:</para>

    <screen>&prompt.root; <userinput>pkg_add -r cups</userinput></screen>

    <para>Другие необязательные, но рекомендуемые к установке порты или
      пакеты это <filename role="package">print/gutenprint-cups</filename>
      и <filename role="package">print/hplip</filename>, каждый из которых
      добавляет драйвера и утилиты для разнообразных принтеров.  После
      установки файлы конфигурации <application>CUPS</application> могут быть
      найдены в директории <filename>/usr/local/etc/cups</filename>.</para>
  </sect1>

  <sect1 id="printing-cups-configuring-server">
    <title>Настройка сервера печати CUPS</title>

    <para>Чтобы настроить сервер <application>CUPS</application> необходимо
      отредактировать несколько конфигурационных файлов.  Для начала создайте
      или исправьте файл <filename>/etc/devfs.rules</filename> и добавьте
      следующую информацию для того, чтобы установить соответствующие права
      на все потенциальные файлы устройств принтеров и связать принтеры
      с группой пользователей <groupname>cups</groupname>:</para>

    <programlisting>[system=10]
add path 'unlpt*' mode 0660 group cups
add path 'ulpt*' mode 0660 group cups
add path 'lpt*' mode 0660 group cups
add path 'usb/<replaceable>X</replaceable>.<replaceable>Y</replaceable>.<replaceable>Z</replaceable>' mode 0660 group cups</programlisting>

    <note>
      <para>Замените <replaceable>X</replaceable>,
	<replaceable>Y</replaceable> и <replaceable>Z</replaceable> номерами
	соответствующего принтеру целевого устройства USB, отображаемого
	в каталоге <filename class="directory">/dev/usb</filename>.  Чтобы
	найти требуемые значения, просмотрите вывод &man.dmesg.8; и найдите
	связанное с вашим принтером имя специального устройства
	<filename>ugen<replaceable>X</replaceable>.<replaceable>Y</replaceable></filename>,
	последнее будет символической ссылкой на искомое устройство в каталоге
	<filename class="directory">/dev/usb</filename>.</para>
    </note>

    <para>Затем, добавьте следующие две записи в
      <filename>/etc/rc.conf</filename>:</para>

    <programlisting>cupsd_enable="YES"
devfs_system_ruleset="system"</programlisting>

    <para>Эти две записи будут запускать сервер печати
      <application>CUPS</application> во время загрузки системы и
      применять локальное правило devfs, созданное выше.</para>

    <para>Для того, чтобы печать <application>CUPS</application> стала
      доступна для некоторых &microsoft.windows; клиентов, необходимо
      раскомментировать следующую запись в
      <filename>/usr/local/etc/cups/mime.types</filename> и
      <filename>/usr/local/etc/cups/mime.convs</filename>:</para>

    <programlisting>application/octet-stream</programlisting>

    <para>По окончанию внесения изменений службы &man.devfs.8; и
      <application>CUPS</application> необходимо перезапустить, для чего
      перезагрузите операционную систему или выполните от пользователя
      <username>root</username> следующие две команды:</para>

    <screen>&prompt.root; <userinput>/etc/rc.d/devfs restart</userinput>
&prompt.root; <userinput>/usr/local/etc/rc.d/cupsd restart</userinput></screen>
  </sect1>

  <sect1 id="printing-cups-configuring-printers">
    <title>Настройка принтеров на сервере печати CUPS</title>

    <para>После того, как система <application>CUPS</application> была
      установлена и сконфигурирована, системный администратор может начать
      конфигурирование локальных принтеров, подключенных к серверу печати
      <application>CUPS</application>.  Эта часть процесса очень похожа,
      если не идентична настройке принтеров <application>CUPS</application>
      в других &unix;-подобных операционных системах, таких как
      дистрибутивы &linux;.</para>

    <para>Основным способом управления и администрирования сервера
      <application>CUPS</application> является веб-интерфейс,
      на который можно попасть запустив веб-браузер и набрав
      <ulink url="http://localhost:631"></ulink> в его адресной строке.
      Если сервер <application>CUPS</application> находится на другой
      машине в сети, замените <hostid>localhost</hostid> на
      <acronym>IP</acronym> адрес сервера.  Веб-интерфейс
      <application>CUPS</application> достаточно очевиден, там есть разделы
      для управления принтерами и заданиями на печать, авторизацией
      пользователей и т.п.  Кроме того, в правой части страницы
      администрирования есть несколько флажков (check-box), дающих
      удобный доступ к часто меняемым установкам, таким как разрешение
      публичного доступа к подключенным к системе принтерам, предоставление
      удаленного управления сервером <application>CUPS</application>,
      изменение уровня доступа пользователей к принтерам и их заданиям
      на печать.</para>

    <para>Добавление принтера в общем такое же простое, как нажатие
      <quote>Add Printer</quote> на странице администрирования
      веб-интерфейса сервера <application>CUPS</application> или как нажатие
      одной из кнопок <quote>New Printers Found</quote> на той же
      странице администрирования.  Когда перед вами предстанет выпадающий
      список <quote>Device</quote>, просто выберите требуемый локально
      подключенный принтер, а дальше следуйте подсказкам интерфейса.
      В случае если были установлены порты или пакеты
      <filename role="package">print/gutenprint-cups</filename> или
      <filename role="package">print/hplip</filename>, как указывалось выше,
      дополнительные драйвера печати будут доступны на последующих
      страницах, что может обеспечить большую надежность и расширенные
      возможности.</para>
  </sect1>

  <sect1 id="printing-cups-clients">
    <title>Конфигурирование клиентов CUPS</title>

    <para>После того, как сервер <application>CUPS</application> был настроен,
      принтеры добавлены и сделаны доступными в сети, следующий шаг &mdash;
      это настройка клиентов или машин, которые будут иметь доступ к серверу
      <application>CUPS</application>.  Если у вас единственный настольный
      компьютер, который работает одновременно и сервером и клиентом,
      то в большинстве этой информации вы не нуждаетесь.</para>

    <sect2 id="printing-cups-clients-unix">
      <title>&unix; клиенты</title>

      <para>На &unix; клиентах также потребуется установить
	<application>CUPS</application>.  После установки системы
	печати на клиенте, <application>CUPS</application>-принтеры,
	присутствующие в сети, чаще всего автоматически находятся
	менеджерами принтеров разных графических оболочек, таких как
	<application>GNOME</application> или <application>KDE</application>.
	В качестве альтернативы, вы можете воспользоваться веб-интерфейсом
	<application>CUPS</application> на клиентской машине по адресу
	<ulink url="http://localhost:631"></ulink> и на странице
	администрирования выбрать <quote>Add Printer</quote>.  Когда
	перед вами предстанет выпадающий список <quote>Device</quote>,
	просто выберите сетевой <application>CUPS</application> принтер, если
	он был обнаружен автоматически, или выберите <literal>ipp</literal>
	или <literal>http</literal> и введите <acronym>IPP</acronym> или
	<acronym>HTTP</acronym> адрес (<acronym>URI</acronym>) сетевого
	<application>CUPS</application> принтера:</para>

	<programlisting>ipp://<replaceable>server-name-or-ip</replaceable>/printers/<replaceable>printername</replaceable></programlisting>

	<programlisting>http://<replaceable>server-name-or-ip</replaceable>:631/printers/<replaceable>printername</replaceable></programlisting>

      <para>Если <application>CUPS</application> клиент не находит в сети
	принтеры, доступные через сервер <application>CUPS</application>,
	то иногда помогает создание или изменение файла
	<filename>/usr/local/etc/cups/client.conf</filename> с добавлением
	единственной записи, подобной следующей:</para>

      <programlisting>ServerName <replaceable>server-ip</replaceable></programlisting>

      <para>В этом случае <replaceable>server-ip</replaceable> необходимо
	заменить на <acronym>IP</acronym> адрес сервера
	<application>CUPS</application> в сети.</para>
    </sect2>

    <sect2 id="printing-cups-clients-windows">
      <title>&windows;-клиенты</title>

      <para>Версии &windows;, предшествующие XP, не имели встроенной
	поддержки протокола <acronym>IPP</acronym>.  Однако &windowsxp;
	и более поздние версии уже обладают такой возможностью.  Следовательно,
	добавить <application>CUPS</application> принтер в этих версиях
	&windows; довольно просто.  В большинстве случаев, администратору
	&windows; потребуется запустить мастера установки принтера
	(<literal>Add Printer</literal>) выбрать сетевой принтер
	(<literal>Network Printer</literal>), а затем ввести
	<acronym>URI</acronym> следующего формата:</para>

      <programlisting>http://<replaceable>server-name-or-ip</replaceable>:631/printers/<replaceable>printername</replaceable></programlisting>

      <para>Если используется версия &windows; без поддержки протокола
	<acronym>IPP</acronym>, то общим случаем подключения к
	<application>CUPS</application>-принтеру будет совместное
	использование <application>CUPS</application> и
	<filename role="package">net/samba3</filename>.  Описание этой
	возможности выходит за рамки данной статьи.</para>
    </sect2>
  </sect1>

  <sect1 id="printing-cups-troubleshooting">
    <title>Устранение неполадок с CUPS</title>

    <para>Проблемы c <application>CUPS</application> часто возникают
      из-за неверных прав доступа.  Сначала дважды проверьте права доступа
      в &man.devfs.8; (сверьтесь с уже описанными выше).  Затем, проверьте
      реальные права устройств, созданных в файловой системе.  Также бывает
      полезным удостовериться, что ваш пользователь входит в группу
      <groupname>cups</groupname>.  Если у вас складывается впечатление,
      что флажки прав доступа на странице администрирования веб-интерфейса
      <application>CUPS</application> не работают, то иным решением
      может быть резервное копирование конфигурационного файла
      <filename>/usr/local/etc/cups/cupsd.conf</filename> и редактирование
      разных опций конфигурации с подбором их комбинаций.
      Ниже приведено содержимое тестового файла конфигурации
      <filename>/usr/local/etc/cups/cupsd.conf</filename>.
      Пожалуйста, обратите внимание на то, что безопасность в этом примере
      <filename>cupsd.conf</filename> была пожертвована в угоду простоте
      настройки; как только администратор успешно подсоединится к серверу
      <application>CUPS</application> и сконфигурирует клиентов,
      рекомендуется пересмотреть данную конфигурацию и добавить разграничение
      доступа.</para>

    <programlisting># Log general information in error_log - change "info" to "debug" for
# troubleshooting...
LogLevel info

# Administrator user group...
SystemGroup wheel

# Listen for connections on Port 631.
Port 631
#Listen localhost:631
Listen /var/run/cups.sock

# Show shared printers on the local network.
Browsing On
BrowseOrder allow,deny
#BrowseAllow @LOCAL
BrowseAllow 192.168.1.* # change to local LAN settings
BrowseAddress 192.168.1.* # change to local LAN settings

# Default authentication type, when authentication is required...
DefaultAuthType Basic
DefaultEncryption Never # comment this line to allow encryption

# Allow access to the server from any machine on the LAN
&lt;Location /&gt;
  Order allow,deny
  #Allow localhost
  Allow 192.168.1.* # change to local LAN settings
&lt;/Location&gt;

# Allow access to the admin pages from any machine on the LAN
&lt;Location /admin&gt;
  #Encryption Required
  Order allow,deny
  #Allow localhost
  Allow 192.168.1.* # change to local LAN settings
&lt;/Location&gt;

# Allow access to configuration files from any machine on the LAN
&lt;Location /admin/conf&gt;
  AuthType Basic
  Require user @SYSTEM
  Order allow,deny
  #Allow localhost
  Allow 192.168.1.* # change to local LAN settings
&lt;/Location&gt;

# Set the default printer/job policies...
&lt;Policy default&gt;
  # Job-related operations must be done by the owner or an adminstrator...
  &lt;Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs \
Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription \
Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job \
CUPS-Move-Job&gt;
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # All administration operations require an adminstrator to authenticate...
  &lt;Limit Pause-Printer Resume-Printer Set-Printer-Attributes Enable-Printer \
Disable-Printer Pause-Printer-After-Current-Job Hold-New-Jobs Release-Held-New-Jobs \
Deactivate-Printer Activate-Printer Restart-Printer Shutdown-Printer Startup-Printer \
Promote-Job Schedule-Job-After CUPS-Add-Printer CUPS-Delete-Printer CUPS-Add-Class \
CUPS-Delete-Class CUPS-Accept-Jobs CUPS-Reject-Jobs CUPS-Set-Default&gt;
    AuthType Basic
    Require user @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  # Only the owner or an administrator can cancel or authenticate a job...
  &lt;Limit Cancel-Job CUPS-Authenticate-Job&gt;
    Require user @OWNER @SYSTEM
    Order deny,allow
  &lt;/Limit&gt;

  &lt;Limit All&gt;
    Order deny,allow
  &lt;/Limit&gt;
&lt;/Policy&gt;</programlisting>
  </sect1>

  <sect1 id="printing-cups-ports-knobs">
    <title>Настройка портов использующих CUPS</title>

    <para>Если <application>CUPS</application> будет служить в качестве
      основной системы печати, то можно по желанию добавить несколько
      записей в <filename>/etc/make.conf</filename>, которые выделят
      <application>CUPS</application> среди других систем.  Вот некоторые
      из них:</para>

    <programlisting>WITH_CUPS=YES
CUPS_OVERWRITE_BASE=YES
WITHOUT_LPR=YES</programlisting>

    <para>Первая переменная, <makevar>WITH_CUPS</makevar>, добавляет поддержку
      <application>CUPS</application> к портам, в которых предусмотрена такая
      возможность.  Вторая запись, <makevar>CUPS_OVERWRITE_BASE</makevar>,
      исправит некоторые символические ссылки и пути, которые иначе
      приводили-бы к системе печати &os; по умолчанию &mdash;
      <application>LPR</application>.  Также она предотвратит откат
      этих изменений во время следующего обновления системы посредством
      <maketarget>buildworld</maketarget>.  Третья переменная,
      <makevar>WITHOUT_LPR</makevar>, предотвратит включение поддержки
      <application>LPR</application> в портах, потенциально ее
      использующих.</para>
  </sect1>
</article>
