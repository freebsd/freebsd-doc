<!--
     The FreeBSD Russian Documentation Project

     $FreeBSDru: frdp/doc/ru_RU.KOI8-R/articles/pxe/article.sgml,v 1.10 2005/10/09 14:52:41 gad Exp $

     Original revision: r24952
-->

<!DOCTYPE article PUBLIC "-//FreeBSD//DTD DocBook V4.1-Based Extension//EN" [
<!ENTITY % articles.ent PUBLIC "-//FreeBSD//ENTITIES DocBook FreeBSD Articles Entity Set//EN">
%articles.ent;
]>

<article lang="ru">
  <articleinfo>
    <title>Руководство по начальному запуску FreeBSD</title>

    <authorgroup>
      <author>
        <firstname>Alfred</firstname>
        <surname>Perlstein</surname>

        <affiliation>
          <address><email>alfred@FreeBSD.org</email></address>
        </affiliation>
      </author>
    </authorgroup>

    <pubdate>$FreeBSD$</pubdate>

    <legalnotice id="trademarks" role="trademarks">
      &tm-attrib.freebsd;
      &tm-attrib.intel;
      &tm-attrib.general;
    </legalnotice>

    <abstract>
      <para>Эта статья подробно описывает подход компании &intel;, позволяющий
        машинам устанавливать FreeBSD при помощи метода PXE загрузки машины по
        сети.</para>
    </abstract>
  </articleinfo>

  <sect1 id="introduction">
    <title>Введение</title>

    <warning>
      <para>Эта процедура делает <quote>Сервер</quote> как незащищённым, так и
        опасным, лучше просто держать <quote>Сервер</quote> на отдельном
        сетевом концентраторе и никаким другим способом не давать доступ к нему
        с машин, не являющихся <quote>Клиентами</quote>.</para>
    </warning>

    <para>Терминология:</para>

    <informaltable frame="none" pgwide="1">
      <tgroup cols="2">
        <tbody>
          <row>
            <entry>Сервер</entry>
            <entry>Машина, предоставляющая услуги по загрузке и установке через
              сеть.</entry>
          </row>

          <row>
            <entry>Клиент</entry>
            <entry>Машина, на которую будет устанавливаться FreeBSD.</entry>
          </row>
        </tbody>
      </tgroup>
    </informaltable>

    <para>Требования: Клиенты, поддерживающие метод &intel; PXE загрузки по
      сети, подключение к Ethernet.</para>

    <para>Пожалуйста, дайте мне знать, если вы решили какие-то проблемы, или
      если у вас есть пожелания к дополнительной документации.</para>

    <para>Если вам нужен кто-то для обучения/реализации конкретной системы
      установки по сети, то, пожалуйста, пошлите письмо, чтобы мы могли
      обговорить условия.</para>

    <para>Я также признателен &a.ps; и &a.jhb; за то, что они сделали основную
      работу по программированию pxeboot, интерфейса к системе сетевой
      загрузки PXE (netboot) от &intel;.</para>
  </sect1>

  <sect1 id="server-config">
    <title>Настройка сервера</title>

    <procedure>
      <step>
        <para>Установите DHCP: Установив <filename
          role="package">net/isc-dhcp3-server</filename>, вы можете использовать
          конфигурационный файл <ulink
          url="dhcpd.conf"><filename>dhcpd.conf</filename></ulink>,
          поместив его в каталог <filename>/usr/local/etc/</filename>.</para>
      </step>

      <step>
        <para>Включите tftp:</para>

        <procedure>
          <step>
            <para>Создайте каталог <filename>/usr/tftpboot</filename></para>
          </step>

          <step>
            <para>Добавьте следующую строку в ваш
              <filename>/etc/inetd.conf</filename>:</para>

<programlisting>tftp    dgram   udp     wait    nobody  /usr/libexec/tftpd    tftpd /usr/tftpboot</programlisting>
          </step>
        </procedure>
      </step>

      <step>
        <para>Включите NFS:</para>

        <procedure>
          <step>
            <para>Добавьте следующее в
              <filename>/etc/rc.conf</filename>:</para>

	    <programlisting>nfs_server_enable="YES"</programlisting>
          </step>

          <step>
            <para>Добавьте такую строку в файл
              <filename>/etc/exports</filename>:</para>

	    <programlisting>/usr -alldirs -ro</programlisting>
          </step>
        </procedure>
      </step>
        
      <step>
        <para>Перезагрузите машину для включения новых сервисов или запустите
          их вручную.</para>
      </step>
    </procedure>
  </sect1>

  <sect1 id="bootstrap-config">
    <title>Настройка начальной загрузки</title>

    <procedure>
      <step>
        <para>Сгрузите загрузочные файлы: Сгрузите образы дисков <ulink
          url="&snapshots.stable;/floppies/kern.flp">kern.flp</ulink> и <ulink
          url="&snapshots.stable;/floppies/mfsroot.flp">
          mfsroot.flp</ulink>.</para>
      </step>

      <step>
        <para>Подготовьте каталог tftp/pxe-boot:</para>

        <procedure>
          <step>
            <para>Поместите pxeboot в загрузочный каталог:</para>

	    <screen>&prompt.root; <userinput>rm -rf /usr/obj/*</userinput>
&prompt.root; <userinput>cd /usr/src/sys/boot</userinput>
&prompt.root; <userinput>make</userinput>
&prompt.root; <userinput>cp /usr/src/sys/boot/i386/pxeldr/pxeboot /usr/tftpboot</userinput></screen>
          </step>
          
          <step>
            <para>Через устройство vndevice смонтируйте файл
              <filename>kern.flp</filename> и скопируйте его содержимое в
              каталог <filename>/usr/tftpboot</filename>:</para>

<screen>&prompt.root; <userinput>mdconfig -a -t vnode -f kern.flp -u 0</userinput> # (vnconfig vn0 kern.flp) associate a vndevice with the file
&prompt.root; <userinput>mount /dev/md0 /mnt</userinput> # (mount /dev/vn0 /mnt) mount it
&prompt.root; <userinput>cp -R /mnt /usr/tftpboot</userinput> # copy the contents to /usr/tftpboot
&prompt.root; <userinput>umount /mnt</userinput>              # unmount it
&prompt.root; <userinput>vnconfig -u vn0</userinput>          # disassociate the vndevice from the file</screen>
          </step>
        </procedure>
      </step>

      <step>
        <para>Создайте собственное ядро для клиентов (в частности, чтобы
          избавиться от экрана настройки устройств при загрузке) и поместите
          его в <filename>/usr/tftpboot</filename>.</para>
      </step>

      <step>
        <para>Напишите специальный скрипт <filename>loader.rc</filename> и
          установите его в <filename>/usr/tftpboot/boot/loader.rc</filename>,
          так, чтобы он не выдавал запроса на второй диск, как сделал я <ulink
          url="loader.rc">в моём файле</ulink>.</para>
      </step>

      <step>
        <para>Выберите утилиту установки и вспомогательные утилиты с диска
          mfsroot и распакуйте их, после чего поместите их также в  каталог
          <filename>/usr/tftpboot</filename>:</para>

	<screen>&prompt.root; <userinput>vnconfig vn0 mfsroot.flp</userinput>         # associate a vndevice with the file
&prompt.root; <userinput>mount /dev/vn0 /mnt</userinput>              # mount it
&prompt.root; <userinput>cp /mnt/mfsroot.gz /usr/tftpboot</userinput> # copy the contents to /usr/tftpboot
&prompt.root; <userinput>umount /mnt</userinput>                      # unmount it
&prompt.root; <userinput>vnconfig -u vn0</userinput>                  # disassociate the vndevice from the file
&prompt.root; <userinput>cd /usr/tftpboot</userinput>                 # get into the pxeboot directory
&prompt.root; <userinput>gunzip mfsroot.gz</userinput>                # uncompress the mfsroot</screen>
      </step>
      
      <step>
        <para>Создайте собственный скрипт <filename>install.cfg</filename> для
          sysinstall, при этом вы можете использовать <ulink
          url="install.cfg">мой</ulink> в качестве образца, но вам придётся
          его отредактировать.</para>
      </step>

      <step> 
        <para>Скопируйте скрипт для sysinstall в распакованный образ
          mfsroot:</para>

	<screen>&prompt.root; <userinput>cd /usr/tftpboot</userinput>
&prompt.root; <userinput>vnconfig vn0 mfsroot</userinput>
&prompt.root; <userinput>mount /dev/vn0 /mnt</userinput>
&prompt.root; <userinput>cp install.cfg /mnt</userinput>
&prompt.root; <userinput>umount /mnt</userinput>
&prompt.root; <userinput>vnconfig -u vn0</userinput></screen>
      </step>
    </procedure>
  </sect1>

  <sect1 id="install-setup">
    <title>Настройка установки</title>

    <procedure>
      <step>
        <para>Поместите установочные файлы на Сервер в место, доступное через
          NFS.  Создайте каталог, соответствующий директиве 'nfs' в файле
	  <filename>install.cfg</filename> и создайте здесь зеркальную
          копию установочных файлов FreeBSD, нужно, чтобы это выглядело
          примерно так:</para>

	<screen>ABOUT.TXT       TROUBLE.TXT     compat20        floppies        ports
ERRATA.TXT      UPGRADE.TXT     compat21        games           proflibs
HARDWARE.TXT    XF86336         compat22        info            src
INSTALL.TXT     bin             compat3x        kern.flp
LAYOUT.TXT      catpages        crypto          manpages
README.TXT      cdrom.inf       dict            mfsroot.flp
RELNOTES.TXT    compat1x        doc             packages</screen>
      </step>

      <step>
        <para>Скопируйте упакованные пакаджи в каталог packages/All под
          <filename>nfs</filename>.</para>
      </step>

      <step>
        <para>В каталоге packages должен находиться приготовленный файл
          <filename>INDEX</filename>.  Вы можете создать собственные записи в
	  файле <filename>INDEX</filename>, которые выглядят так:</para>

	<programlisting>alfred-1.0||/|Alfred install bootstrap||alfred@FreeBSD.org||||</programlisting>

        <para>Затем вы можете установить какие-то другие пакаджи, в частности,
          собственные пакаджи для установки после установки системы.</para>
      </step>
    </procedure>
  </sect1>

  <sect1 id="custom-postinst-package">
    <title>Собственные пакаджи для установки после установки системы</title>

    <para>Для создания собственного пакаджа для установки после инсталляции
      системы вы можете использовать скрипт <ulink
      url="pkgmaker.sh"><filename>pkgmaker.sh</filename></ulink>,
      идея заключается в его установке и настройке каких-то параметров, которую
      нужно выполнить.  <filename>pkgmaker</filename> запускается в каталоге,
      находящемся выше каталога с пакаджем, который вы хотите создать, с
      единственным аргументом, представляющим собой название пакаджа (то есть
      mypkg), и который затем создаст для вас mypkg.tgz для включения в ваш
      пакадж для sysinstall.</para>

    <para>Внутри каталога с вашим пакаджем вам нужен файл с именем
      <filename>PLIST</filename>, который содержит все файлы, которые вам нужно
      установить и включить в ваш пакадж.</para>

    <para>Вам также могут потребоваться файлы <ulink
      url="pre"><filename>pre</filename></ulink> и <ulink
      url="post"><filename>post</filename></ulink> в этом каталоге, являющиеся
      скриптами командного процессора, которые необходимо запускать перед и
      после установки вашего пакаджа.</para>

    <para>Так как этот пакадж находится в вашем файле
      <filename>install.cfg</filename>, то он должен быть запущен и выполнить
      для вас окончательную настройку.</para>
  </sect1>
</article>
