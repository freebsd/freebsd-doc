<!--
     The FreeBSD Russian Documentation Project

     $FreeBSDru: frdp/doc/ru_RU.KOI8-R/books/handbook/audit/chapter.sgml,v 1.10 2007/06/26 08:38:00 den Exp $
     $FreeBSD$

     Original revision: r30208
-->

<!-- Need more documentation on praudit, auditreduce, etc.  Plus more info
on the triggers from the kernel (log rotation, out of space, etc).
And the /dev/audit special file if we choose to support that.  Could use
some coverage of integrating MAC with Event auditing and perhaps discussion
on how some companies or organizations handle auditing and auditing
requirements. -->
<chapter id="audit">
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Tom</firstname>
	<surname>Rhodes</surname>
	<contrib>Автор </contrib>
      </author>
    </authorgroup>
    <authorgroup>
      <author>
	<firstname>Денис</firstname>
	<surname>Баров</surname>
	<contrib>Перевод на русский язык: </contrib>
      </author>
    </authorgroup>
  </chapterinfo>
  <title>Аудит событий безопасности</title>
  <sect1 id="audit-synopsis">
    <title>Краткий обзор</title>
    <indexterm><primary>AUDIT</primary></indexterm>
    <indexterm>
      <primary>Аудит событий безопасности</primary>
      <see>MAC</see>
    </indexterm>
    <para>&os;&nbsp;6.2-RELEASE и более поздние версии &os;
      включают в себя поддержку аудита событий безопасности.
      Аудит событий дает надежный и точный способ для
      протоколирования различных событий, связанных с безопасностью,
      включая входы в систему, изменения конфигурации, доступ к
      файлам и сети.  Эти записи могут быть незаменимы для
      мониторинга функционирующей системы, обнаружения вторжений
      и для анализа событий, приведших к краху системы.
      В &os; реализован опубликованный &sun; <acronym>BSM</acronym>
      API и формат файла, который совместим с реализациями
      аудита в &sun; &solaris; и &apple; &macos; X.</para>

    <para>В этой главе описывается, в основном, процесс установки и
      конфигурирования системы аудита.  В том числе, приводится
      разъяснение политик аудита, а так же даются примеры конфигурационных
      файлов.</para>

    <para>После прочтения этой главы вы будете знать:</para>
    <itemizedlist>
      <listitem>
	<para>Что такое система аудита и как она работает.</para>
      </listitem>

      <listitem>
	<para>Как настроить аудит во &os; для мониторинга
	пользователей и процессов.</para>
      </listitem>

      <listitem>
	<para>Как просматривать журнал аудита, использовать ограничения по
	  размеру и специальные инструменты для его просмотра.</para>
    </itemizedlist>

    <para>Перед прочтением этой главы вы должны:</para>

    <itemizedlist>
      <listitem>
	<para>Понимать основы &unix; и &os;
	  (<xref linkend="basics">).</para>
      </listitem>

      <listitem>
	<para>Уметь конфигурировать и компилировать ядро
	  (<xref linkend="kernelconfig">).</para>
      </listitem>

      <listitem>
	<para>Понимать основные принципы безопасности в применении
	  к операционной системе &os; (<xref linkend="security">).</para>
      </listitem>
    </itemizedlist>

    <warning>
      <para>Реализация аудита в &os; 6.2 - экспериментальная, использование
	ее в реальных задачах должно производиться только после
	внимательного ознакомления со всеми рисками, к которым приводит
	использование экспериментального программного обеспечения.  К
	известным ограничениям относится и тот факт, что не все события
	в настоящий момент протоколируемы.  Например, некоторые механизмы
	входа в систему (X11-основанные оконные менеджеры, многое
	программное обеспечение от сторонних производителей) не
	сконфигурированы для протоколирования событий входа в систему через
	подсистему аудита.</para>
    </warning>

    <warning>
	<para>Использование системы в аудита может привести к генерированию
	  огромных журнальных файлов: их размер на сильно загруженных серверах
	  в некоторых конфигурациях может достигать нескольких гигабайт в неделю.
	  Администраторы должны внимательно следить за дисковым пространством
	  в разделе системы аудита.  Например, рекомендуется выделить
	  отдельный раздел для файловой системы аудита
	  <filename>/var/audit</filename>, чтобы переполнение раздела аудита
	  не влияло на работоспособность всей остальной системы.</para>
    </warning>

  </sect1>

  <sect1 id="audit-inline-glossary">
    <title>Ключевые понятия - краткий словарь.</title>

    <para>Перед чтением этой главы необходимо определить несколько
      ключевых понятий.  Это нужно для того, чтобы предотвратить
      недоразумения, которые могут возникнуть из-за разницы в трактовке
      некоторых терминов.  В русской версии документа приводятся
      близкий по смыслу перевод и в скобках указывается оригинальный
      английский термин.</para>

    <itemizedlist>
      <listitem>
	<para><emphasis>событие</emphasis> (event): Событие, которое
	  может быть занесено в журнал.  Администратор может выбирать,
	  какие именно события будут журналироваться подсистемой
	  аудита.  Список важных для безопасности системы
	  событий включает: создание файла, инициализацию сетевого
	  соединения, вход пользователя в систему.  События
	  разделяются на <quote>приписываемые</quote> (attributable) -
	  те, которые могут быть отнесены к конкретному пользователю -
	  и <quote>не-приписываемые</quote> (non-attributable).  Пример
	  не-приписываемого события - любое событие, произошедшее до
	  авторизации пользователя, такое, как неудачный вход пользователя
	  в систему.</para>
      </listitem>

      <listitem>
	<para><emphasis>Класс</emphasis> (class): События могут быть
	  отнесены к одному или более классам, обычно основываясь
	  на категории события: <quote>создание файла</quote> (fc),
	  <quote>доступ к файлу</quote> (fo),
	  <quote>выполнение файла</quote> (ex), события
	  входа в систему и выхода из нее (lo).
	  Использование классов позволяет администратору создавать
	  высокоуровневые правила аудита без указания конкретных
	  операций, отчет о которых должен добавляться в журнал.</para>
      </listitem>

      <listitem>
	<para><emphasis>Запись</emphasis> (record): <quote>Запись</quote> -
	  это единичная запись в журнале, описывающая то или иное
	  событие.  Запись обычно содержит информацию о типе события,
	  информацию о субъекте события (пользователе), время события,
	  информацию об объектах события (например, файлах) и
	  информацию об успешности выполнения операции, породившей
	  событие.
      </listitem>

      <listitem>
	<para><emphasis>Журнал</emphasis> (trail):
	  <quote>журнал</quote> аудита, или лог-файл -
	  содержит серию <quote>записей</quote> о системных событиях.
	  Как правило, журнал содержит записи в строгом
	  хронологическом порядке по времени завершения
	  события.  Только авторизованные процессы (например,
	  <command>auditd</command>) имеют доступ к журналу.</para>
     </listitem>

      <listitem>
	<para><emphasis>выражение выделения</emphasis> (selection expression):
	  Строка, содержащая список префиксов и имен классов, используемая
	  для выделения группы событий.</para>
      </listitem>

      <listitem>
	<para><emphasis>предварительное выделение</emphasis> (preselection):
	  Процесс, во время которого система определяет, какие события имеют
	  приоритетную важность для администратора.  Это необходимо для того,
	  чтобы избежать протоколирования событий, не имеющих никакой значимости.
	  Предварительное выделение использует ряд
	  <emphasis>выражений выделения</emphasis> для того, чтобы определить,
	  какие именно классы событий для какого пользователя необходимо вносить
	  в журнал, так же, как и для авторизованных и неавторизованных
	  процессов.</para>
      </listitem>

      <listitem>
	<para><emphasis>Фильтрация</emphasis> (reduction):
	  Процесс, в результате которого записи из существующего журнала
	  выделяются для хранения, распечатки или анализа.  Процесс во многом
	  аналогичен <emphasis>предварительному выделению</emphasis>.  Используя
	  <emphasis>фильтрацию</emphasis> администраторы могут реализовывать
	  различные политики хранения журналов аудита.  Например, детализированный
	  журнал может храниться месяц, но после этого он должен быть сокращен
	  чтобы хранить только информацию о входе в систему и выходе из нее
	  более длительный срок.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 id="audit-install">
    <title>Установка системы аудита</title>

    <para>Пользовательская часть подсистемы аудита устанавливается как часть
      базовой системы &os; начиная с версии 6.2-RELEASE.  Тем не менее,
      поддержка аудита должна быть добавлена в ядро.  Этого
      можно добиться, добавив следующую строку в конфигурационный файл
      вашего специального ядра:</para>

    <programlisting>options	AUDIT</programlisting>

    <para>Процесс сборки и установки ядра подробно описан в главе
      <xref linkend="kernelconfig">.</para>

   <para>После этого, необходимо разрешить запуск демона аудита,
      добавив следующую строку в &man.rc.conf.5;:</para>

    <programlisting>auditd_enable="YES"</programlisting>

    <para>Для запуска демона со специфическими параметрами нужно
      указать эти параметры в опции <option>auditd_flags</option>
      файла &man.rc.conf.5;.
  </sect1>

  <sect1 id="audit-config">
    <title>Настройка системы аудита</title>


    <para>Все конфигурационные файлы системы аудита находятся в каталоге
    <filename role="directory">/etc/security</filename>.   Перед запуском
    демона аудита там должны находиться следующие файлы:</para>

    <itemizedlist>
      <listitem>
	<para><filename>audit_class</filename> - Содержит определения
	  классов аудита.</para>
      </listitem>

      <listitem>
	<para><filename>audit_control</filename> - Параметры системы
	  аудита: классы по умолчанию, минимальное дисковое
	  пространство, которое должно оставаться на разделе журнала
	  аудита, и другие.</para>
      </listitem>

      <listitem>
	<para><filename>audit_event</filename> - Определяет основные
	  события аудита.  Это, в основном, системные вызовы.</para>
      </listitem>

      <listitem>
	<para><filename>audit_user</filename> - События аудита для
	  для отдельных пользователей.  Пользователи, не упоминаемые
	  в этом файле, будут рассматриваться как субъекты конфигурации
	  по-умолчанию в файле <filename>audit_control</filename>.</para>
      </listitem>


      <listitem>
	<para><filename>audit_warn</filename> - Скрипт командного
	  интерпретатора Bourne Shell, который используется, чтобы
	  сгенерировать предупреждающие сообщения об исключительных
	  ситуациях, например, когда заканчивается свободное дисковое
	  пространство для записей журналов аудита.</para>
      </listitem>
    </itemizedlist>

    <sect2>
      <title>Формат конфигурационного файла</title>

      <para>Формат конфигурационного файла не очень логичен, но с ним, тем
	не менее, достаточно просто работать.  Однако, администраторам
	следует быть очень внимательными при изменении значений по
	умолчанию, поскольку это создает потенциальную опасность
	неправильного сбора данных системой аудита.</para>

       <para>В конфигурационном файле могут использоваться как полные,
       так и сокращенные параметры.  Соответствия будут приведены
       ниже.</para>

      <para>Следующий список содержит все классы по умолчанию,
	присутствующие в файле <filename>audit_class</filename>:</para>

      <itemizedlist>
	<listitem>
	  <para><option>all</option> - <literal>all</literal> -
	  Соответствует всем классам событий.</para>
	</listitem>

	<listitem>
	  <para><option>ad</option> - <literal>administrative</literal>
	    - Аудит административных действий, произошедших в
	      системе.</para>
	</listitem>

	<listitem>
	  <para><option>ap</option> - <literal>application</literal> -
	    Аудит события, вызванного каким-либо приложением.</para>
	</listitem>

	<listitem>
	  <para><option>cl</option> - <literal>file_close</literal>
	    - Аудит вызовов системной функции
	    <function>close</function>.</para>
	</listitem>

	<listitem>
	  <para><option>ex</option> - <literal>exec</literal> -
	  Аудит запуска приложения.  Аудит аргументов командной строки и
	  переменных окружения контролируется через &man.audit.control.5;
	  используя параметры <literal>argv</literal> и  <literal>envv</literal>
	  в опции <literal>policy</literal>.</para>
	</listitem>

	<listitem>
	  <para><option>fa</option> - <literal>file_attr_acc</literal>
	    - Аудит доступа к атрибутам объектов и их изменению,
	    например через &man.stat.1;, &man.pathconf.2;, а
	    также подобных этим событий.</para>
	</listitem>

	<listitem>
	  <para><option>fc</option> - <literal>file_creation</literal>
	    - Аудит событий, в результате которых создаются
	    файлы.</para>
	</listitem>

	<listitem>
	  <para><option>fd</option> - <literal>file_deletion</literal>
	    - Аудит событий, в результате которых удаляются
	    файлы.</para>
	</listitem>

	<listitem>
	  <para><option>fm</option> - <literal>file_attr_mod</literal>
	    - Аудит событий, в результате которых изменяются
	    атрибуты файлов, например, &man.chown.8;,
	    &man.chflags.1;, &man.flock.2;.</para>
	</listitem>

	<listitem>
	  <para><option>fr</option> - <literal>file_read</literal>
	    - Аудит событий, в результате которых происходит
	    чтение данных, открываются файлы на чтение и т.п.</para>
	</listitem>

	<listitem>
	  <para><option>fw</option> - <literal>file_write</literal> -
	    - Аудит событий, в результате которых происходит
	    запись данных, изменение файлов и так далее.</para>
	</listitem>

	<listitem>
	  <para><option>io</option> - <literal>ioctl</literal> -
	  Аудит вызовов системной функции &man.ioctl.2;.</para>
	</listitem>

	<listitem>
	  <para><option>ip</option> - <literal>ipc</literal> -
	    Аудит различных видов взаимодействия процессов,
	    включая создание не-именованных каналов (pipe) и
	    взаимодействие процессов в стиле System V
	    <acronym>IPC</acronym>.
	</listitem>

	<listitem>
	  <para><option>lo</option> - <literal>login_logout</literal> -
	    Аудит событий  &man.login.1; и  &man.logout.1;.</para>
	</listitem>

	<listitem>
	  <para><option>na</option> - <literal>non_attrib</literal> -
	    Аудит не-приписываемых событий.</para>
	</listitem>

	<listitem>
	  <para><option>no</option> - <literal>no_class</literal> -
	    Пустой класс, используется для отключения
	    аудита.</para>
	</listitem>

	<listitem>
	  <para><option>nt</option> - <literal>network</literal> -
	    Аудит событий, связанных с сетевыми подключениями,
	    например &man.connect.2; и &man.accept.2;.</para>
	</listitem>

	<listitem>
	  <para><option>ot</option> - <literal>other</literal> -
	    Аудит событий, не вошедших в другие классы.</para>
	</listitem>

	<listitem>
	  <para><option>pc</option> - <literal>process</literal> -
	    Аудит действий процессов, таких как  &man.exec.3; и
	    &man.exit.3;.</para>
	</listitem>
      </itemizedlist>

      <para>Эти классы событий могут быть настроены изменением конфигурационных
	 файлов <filename>audit_class</filename> и
	 <filename>audit_event</filename>.</para>

      <para>Каждый класс комбинируется с префиксом, показывающим удачное
	или неудачное завершение операции.</para>

      <itemizedlist>
	<listitem>
	  <para><literal>[пустой префикс]</literal> - Аудит проводится как для
	    успешного, так и для ошибочного события.  Например, просто
	    указание класса без префикса приведет к занесению события
	    в журнал при любом результате операции.</para>
	</listitem>

	<listitem>
	  <para><literal>+</literal> - Аудит только успешных
	  событий.</para>
	</listitem>

	<listitem>
	  <para><literal>-</literal> - Аудит только ошибочных
	  событий.</para>
	</listitem>

	<listitem>
	  <para><literal>^</literal> - Отключение аудита как успешных, так и
	    ошибочных событий.</para>
	</listitem>

	<listitem>
	  <para><literal>^-</literal> - Отключение аудита ошибочных
	    событий.</para>
	</listitem>

	<listitem>
	  <para><literal>^+</literal> - Включение аудита успешных
	    событий.</para>
	</listitem>

      </itemizedlist>

      <para>Следующий пример выбирает успешные и не-успешные события входа в
	систему и выхода из нее, и только успешные события исполнения
	файла:</para>

      <programlisting>lo,+ex</programlisting>
    </sect2>

    <sect2>
      <title>Конфигурационные файлы</title>

      <para>В большинстве случаев администратору придётся вносить
	изменения только в два конфигурационных файла системы аудита:
	<filename>audit_control</filename> и
	<filename>audit_user</filename>.  Первый из них содержит
	общие настройки системы аудита и установки по умолчанию как
	для приписываемых, так и для не-приписываемых событий.  Второй
	используется для настройки аудита пользовательских событий.

      <sect3 id="audit-auditcontrol">
	<title>Файл <filename>audit_control</filename></title>

	<para>Файл <filename>audit_control</filename> содержит
	  настройки по умолчанию, которые, возможно, потребуется
	  изменить.  Содержимое этого файла:</para>

	<programlisting>dir:/var/audit
flags:lo
minfree:20
naflags:lo
policy:cnt
filesz:0</programlisting>

	<para>Параметр <option>dir</option> указывает каталог, в
	  котором будет сохраняться журнал системы аудита.  Как
	  правило, система аудита конфигурируется таким образом, что
	  журнал аудита хранится на отдельном разделе, чтобы
	  предотвратить сбои в работе операционной системы, если
	  свободное месте на разделе системы аудита будет
	  исчерпано.</para>

	<para>Параметр <option>flags</option> используется для
	  установки глобальных опций.  Значение этого параметра
	  <option>lo</option> настраивает аудит для всех событий
	  &man.login.1; и &man.logout.1;.  Более подробный
	  пример:</para>

	  <programlisting>dir:/var/audit
flags:lo,ad,-all,^-fa,^-fc,^-cl
minfree:20
naflags:lo</programlisting>

	  <para>Такое значение параметра <option>flags</option>
	  приведет к аудиту всех событий &man.login.1; и
	  &man.logout.1;, всех административных событий, всех ошибочных
	  системных событий и, наконец, отключает аудит всех ошибочных
	  событий классов <option>fa</option>, <option>fc</option> и
	  <option>cl</option>.  Несмотря на то, что параметр
	  <option>-all</option> указывает на необходимость аудита
	  всех системных событий, префикс <option>^-</option> отменяет
	  это поведение для всех последующих опций.</para>

	<para>Заметьте, что значения считываются слева направо.
	  Поэтому находящиеся справа значения переопределяют значения,
	  находящиеся слева.</para>

	<para>Параметр <option>minfree</option> определяет минимальное
	  значение свободного дискового пространства на разделе, в
	  который сохраняются файлы журналов аудита.  Например, если
	  значение параметра <option>dir</option> установлено в
	  <filename role="directory">/var/audit</filename>, а параметр
	  <option>minfree</option> равен двадцати (20), то предупреждающее
	  сообщение будет выдано, когда раздел <filename
	  role="directory">/var</filename> будет заполнен на
	  восемьдесят (80%) процентов.</para>

	<para>Параметр <option>naflags</option> определяет классы
	  аудита для не-приписываемых событий, то есть событий,
	  для которых не определён конкретный пользователь.</para>

      </sect3>

      <sect3 id="audit-audituser">
	<title>Файл <filename>audit_user</filename></title>

	<para>Файл <filename>audit_user</filename> позволяет
	  администратору определить классы событий, аудит которых будет
	  производиться для каждого пользователя системы.</para>

	<para>По умолчанию файл <filename>audit_user</filename>
	содержит:</para>

	<programlisting>root:lo:no
audit:fc:no</programlisting>

	<para>Обратите внимание: по умолчанию производится аудит всех
	  <command>login</command>/<command>logout</command> событий и
	  отключается аудит всех других событий для пользователя
	  <username>root</username>.  Эта конфигурация также включает
	  аудит всех событий, связанных с созданием файлов и отключает
	  аудит всех других событий для пользователя
	  <username>audit</username>.  Хотя использование системы
	  аудита не требует наличия в системе специального
	  пользователя, в некоторых конфигурациях, особенно
	  использующих <acronym>MAC</acronym> (Mandatory Access
	  Control), это может быть необходимо.</para>

      </sect3>
    </sect2>
  </sect1>

  <sect1 id="audit-administration">
    <title>Администрирование системы аудита</title>

    <sect2>
      <title>Просмотр журнала аудита</title>

      <para>Журнал аудита хранится в бинарном формате BSM, поэтому для
	его изменения и конвертации в текстовый формат понадобятся специальные
	утилиты.  Команда <command>praudit</command> преобразует журнал аудита
	в текстовый формат; команда <command>auditreduce</command> может быть
	использована для ротации и фильтрации журнала в целях анализа,
	архивирования или распечатки.  Команда <command>auditreduce</command>
	поддерживает множество параметров выборки, включая типы событий, классы
	событий, пользовательские события, дату и время  событий и пути файлов,
	к которым относятся события.</para>

      <para>Например, утилита <command>praudit</command> выведет все содержимое
	журнала аудита в текстовом формате:</para>

      <screen>&prompt.root; <userinput>praudit /var/audit/AUDITFILE</userinput></screen>

      <para>В данном примере <replaceable>AUDITFILE</replaceable> -  журнал,
	который будет выведен в текстовом формате.</para>

      <para>Журнал аудита состоит из серии записей, которые, в свою
	 очередь состоят из элементов.  Эти элементы команда
	<command>praudit</command> выводит последовательно - по одному на строку.
	Каждый элемент имеет специфический тип, например
	<literal>заголовок</literal> (header) содержит заголовок pfgbcb, a
	<literal>путь</literal> (path) - путь к файлу, к которому относится запись.
	lookup.  Следующий пример показывает запись для события выполнения
	(execve):</para>

      <programlisting>header,133,10,execve(2),0,Mon Sep 25 15:58:03 2006, + 384 msec
exec arg,finger,doug
path,/usr/bin/finger
attribute,555,root,wheel,90,24918,104944
subject,robert,root,wheel,root,wheel,38439,38032,42086,128.232.9.100
return,success,0
trailer,133</programlisting>

      <para>Эта запись является результатом успешного выполнения системного
	вызова <literal>execve</literal>, который стал результатом выполнения
	команды <literal>finger doug</literal>.  Элемент <literal>exec</literal> содержит и
	команду, которую оболочка передала ядру, и ее аргументы.  Элемент
	<literal>путь</literal> (path) содержит путь к исполняемому файлу в
	представлении ядра.  Элемент <literal>атрибут</literal> (attribute)
	описывает исполняемый файл, и, в частности, права доступа к файлу.
	Элемент <literal>субъект</literal> (subject) описывает процесс, вызвавший
	выполнение и сохраняет его в виде ряда значений, представляющих собой
	UID аудируемого  пользователя, исполняющие (effective) UID и GID,
	реальные (real) UID и GID, идентификатор процесса, идентификатор сессии,
	порт и адрес, с которого был осуществлен вход в систему.
	Обратите внимание - идентификатор аудируемого пользователя и реальный
	идентификатор пользователя отличаются: это значит, что пользователь
	<literal>robert</literal> повысил привилегии до пользователя
	<literal>root</literal> перед выполнением команды, но система аудита
	занесла его действия в журнал используя изначальный идентификатор.
	Наконец, элемент <literal>возврат</literal> (return) описывает успешное
	завершение операции с кодом завершения 0, а элемент
	<literal>trailer</literal> завершает запись.</para>

    </sect2>

    <sect2>
      <title>Фильтрация журналов аудита</title>

      <para>Поскольку логи системы аудита могут иметь огромный размер,
	администратору, зачастую, необходимо выделить только часть записей.
	Например, записи, относящиеся к определенному пользователю:</para>

      <screen>&prompt.root; <userinput>auditreduce -u trhodes /var/audit/AUDITFILE | praudit</userinput></screen>

      <para>Эта команда выделит все записи, относящиеся к пользователю
	<username>trhodes</username>, которые хранятся в файле
	<filename><replaceable>AUDITFILE</replaceable></filename>.</para>
    </sect2>

    <sect2>
      <title>Делегирование прав просмотра журнала</title>

      <para>Члены группы <groupname>audit</groupname> имеют доступ на чтение
	к журналу аудита, находящемуся в <filename>/var/audit</filename>;
	по умолчанию эта группа пуста, и только <username>root</username>
	имеет к ним доступ.  Для того, что бы передать пользователю права на
	чтение журнала, его необходимо добавить в группу <groupname>audit</groupname>.
	Право на чтение журнала аудита позволяет получить множество
	информации о поведении пользователей и процессов, что может привести к
	раскрытию конфиденциальных данных.  Поэтому, рекомендуется делегировать
	права на чтение журнала аудита с большой осторожностью.</para>
    </sect2>

    <sect2>
      <title>Мониторинг системы в реальном времени</title>

      <para>Потоки системы аудита - клонированные псевдо-устройства,
	используя которые, приложения могут получать информацию о системных
	событиях в реальном времени.  В первую очередь, это должно
	заинтересовать авторов программ для мониторинга и определения
	вторжений в систему.  Тем не менее, для администратора потоки
	системы аудита могут стать удобным инструментом для мониторинга
	в реальном времени без того, чтобы вдаваться в детали обеспечения
	безопасности при передачи прав на чтение журнала аудита.  Для того,
	чтобы получить поток событий в реальном времени используйте
	следующую команду:</para>

      <screen>&prompt.root; <userinput>praudit /dev/auditpipe</userinput></screen>

      <para>По умолчанию, потоки доступны только пользователю <username>root</username>.  Чтобы
	сделать их доступными членам группы <groupname>audit</groupname> добавьте
	правило <literal>devfs</literal> в файл
	<filename>devfs.rules</filename>:</para>

      <programlisting>add path 'auditpipe*' mode 0440 group audit</programlisting>

      <para>Смотрите страницу справочника  &man.devfs.rules.5; для более полной
	информации о настройке файловой системы devfs.</para>

      <warning>
	<para>При неосторожном использовании возможно возникновение бесконечных
	  циклов событий.  Например, если аудиту подвергаются все операции
	  сетевого ввода-вывода, и команда <command>praudit</command>
	  запущена во время SSH-сессии, то любое событие породит вывод
	  сообщения, которое в свою очередь тоже будет событием и так до
	  бесконечности.  Разумнее будет не запускать <command>praudit</command>
	  на потоке событий из сессии, которая детально журналируется.</para>
      </warning>
    </sect2>

    <sect2>
      <title>Ротация журнальных файлов аудита</title>

      <para>Журнал аудита пишется только ядром и управляется только демоном
	аудита <application>auditd</application>.  Администраторы не должны пытаться
	использовать &man.newsyslog.conf.5; или другие инструменты для
	прямой ротации логов.  Вместо этого, для прекращения аудита,
	реконфигурации и ротации журнальных файлов должна использоваться
	команда <command>audit</command>.  Следующая команда приведет к
	созданию нового журнального файла и даст команду ядру переключиться
	на запись в этот файл.  Протоколирование в старый файл будет прекращено, а
	сам файл - переименован.  Это рекомендованный способ ротации
	журнальных файлов.</para>

      <screen>&prompt.root; <userinput>audit -n</userinput></screen>

      <warning>
	<para>Если демон <application>auditd</application> не запущен, то эта команда
	  окончится неудачей и будет выведено сообщение об ошибке.</para>
      </warning>

      <para>Добавление следующей строки в файл
	<filename>/etc/crontab</filename> приведет к принудительной ротации
	каждые двенадцать часов через  &man.cron.8;:</para>

      <programlisting>0     */12       *       *       *       root    /usr/sbin/audit -n</programlisting>

      <para>Изменения вступят в силу после сохранения файла
	<filename>/etc/crontab</filename>.</para>

      <para>Автоматическая ротация журнальных файлов возможна при использовании
	опции <option>filesz</option> в файле
	&man.audit.control.5;, и описан в секции
	"Формат конфигурационного файла".</para>
    </sect2>

    <sect2>
      <title>Сжатие журнальных файлов</title>

      <para>Поскольку журнальные файлы могут достигать очень больших размеров,
	может возникнуть необходимость сжимать их в целях хранения сразу же
	после закрытия их демоном <command>auditd</command>.  Для выполнения
	определенных пользователем действий соответствующих разнообразным
	событиям системы аудита, включая нормальное завершение работы системы
	аудита и фильтрацию журнальных файлов, может быть использован скрипт
	<filename>audit_warn</filename>.  Например, добавление следующих строк
	в файл <filename>audit_warn</filename> приведет к сжатию файла
	после его закрытия:</para>

      <programlisting>#
# Compress audit trail files on close.
#
if [ "$1" = closefile ]; then
	gzip -9 $2
fi</programlisting>

      <para>Примерами других действий могут быть, например, копирование файлов в место их
	последующего хранения, удаление старых журнальных файлов, фильтрация
	журнальных файлов для удаления ненужных записей.  Скрипт
	<filename>audit_warn</filename> будет запущен только только при
	корректном закрытии журнала системой аудита и не запустится
	для журнальных файлов, запись в которые была прекращена в
	результате некорректного завершения.</para>
    </sect2>
  </sect1>
</chapter>
