<!--
     The FreeBSD Russian Documentation Project
     $FreeBSD$

     $FreeBSDru: frdp/doc/ru_RU.KOI8-R/books/handbook/geom/chapter.sgml,v 1.11 2007/06/28 06:57:38 den Exp $

     Original revision: r36383
-->

<chapter id="GEOM">
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Tom</firstname>
	<surname>Rhodes</surname>
	<contrib>Написал </contrib>
      </author>
    </authorgroup>
    <authorgroup>
      <author>
	<firstname>Денис</firstname>
	<surname>Баров</surname>
	<contrib>Перевод на русский язык: </contrib>
      </author>
    </authorgroup>
  </chapterinfo>

  <title>GEOM: Модульная инфраструктура преобразования дисковых запросов</title>

  <sect1 id="GEOM-synopsis">
    <title>Краткий обзор</title>

    <indexterm>
      <primary>GEOM</primary>
    </indexterm>
    <indexterm>
      <primary>Инфраструктура GEOM</primary>
      <see>GEOM</see>
    </indexterm>

    <para> Эта глава описывает использование дисков, управляемых
      инфраструктурой GEOM во &os;.  Среди прочего, здесь описывается большая
      часть утилит управления <acronym role="Redundant Array of Inexpensive
      Disks">RAID</acronym>, использующих GEOM для настройки.  В этой главе мы
      не будем вдаваться в подробности взаимодействия GEOM с подсистемой
      ввода/вывода или с программным кодом, эту информацию вы можете получить
      на странице справочника &man.geom.4;.  Эта глава также не является
      подробным руководством по настройке <acronym>RAID</acronym>.  Мы обсудим
      только типы <acronym>RAID</acronym>, поддерживаемые GEOM.</para>

    <para>После прочтения этой главы вы будете знать:</para>

    <itemizedlist>
      <listitem>
	<para>Какие типы <acronym>RAID</acronym> поддерживает GEOM.</para>
      </listitem>

      <listitem>
	<para> Как использовать стандартные утилиты для настройки,
	  обслуживания и управления различными уровнями
	  <acronym>RAID</acronym>.</para>
      </listitem>

      <listitem>
	<para> Как с помощью GEOM создавать зеркальные, последовательные и
	  шифрованные дисковые последовательности, а так же последовательности
	  из дисков, присоединённых удалённо.</para>
      </listitem>

      <listitem>
	<para>Как решать проблемы с дисками, присоединёнными к инфраструктуре
	  GEOM.</para>
      </listitem>
    </itemizedlist>

    <para>Перед чтением этой главы вы должны:</para>

    <itemizedlist>
      <listitem>
	<para>Понимать, как &os; работает с дисками
	  (<xref linkend="disks">).</para>
      </listitem>

      <listitem>
	<para>Уметь сконфигурировать и установить новое ядро &os;
	  (<xref linkend="kernelconfig">).</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 id="GEOM-intro">
    <title>Введение в GEOM</title>

    <para>GEOM позволяет классам &mdash; <acronym role="Master Boot Record">
      MBR</acronym>, <acronym>BSD</acronym> labels, и так далее &mdash;
      получить доступ к устройству и управлять им, используя
      поставщиков GEOM (providers) или специальные файлы устройств,
      расположенные в каталоге <filename class="directory">/dev</filename>.
      GEOM поддерживает различные программные конфигурации
      <acronym>RAID</acronym>, и прозрачно предоставляет доступ
      к дискам системе и системным приложениям.</para>
  </sect1>

  <sect1 id="GEOM-striping">
  <sect1info>
    <authorgroup>
      <author>
	<firstname>Tom</firstname>
	<surname>Rhodes</surname>
	<contrib>Написали </contrib>
      </author>
      <author>
	<firstname>Murray</firstname>
	<surname>Stokely</surname>
      </author>
    </authorgroup>
  </sect1info>

    <title>RAID0 - Создание дисковой последовательности (Striping)</title>

    <indexterm>
      <primary>GEOM</primary>
    </indexterm>
    <indexterm>
      <primary>
	Создание дисковой последовательности&nbsp;(Striping)
      </primary>
    </indexterm>

    <para>Создание дисковой последовательности (Striping)&nbsp;&mdash;
      метод, применяемый, чтобы скомбинировать несколько физических дисков в
      один логический.  Во многих случаях это делается с использованием
      аппаратных контроллеров.  Дисковая подсистема GEOM предоставляет
      программную поддержку <acronym>RAID</acronym>0, иногда называемую
      дисковой последовательностью (Stripe).</para>

    <para>В <acronym>RAID</acronym> уровня 0 данные разбиваются на блоки,
      которые параллельно записываются на все диски массива.  Вместо того,
      чтобы ждать записи 256k на один диск, <acronym>RAID</acronym>0 может
      параллельно записывать по 64k на каждый из четырёх дисков, обеспечивая
      более высокую производительность ввода/вывода.  Производительность также
      может быть увеличена за счет использования большего числа дисков.</para>

    <para>Все диски последовательности <acronym>RAID</acronym>0
      должны быть одного размера, так как запись и считывание с дисков
      происходят параллельно.</para>

    <mediaobject>
      <imageobject>
	<imagedata fileref="geom/striping" align="center">
      </imageobject>

      <textobject>
	<phrase>Иллюстрация дисковой последовательности</phrase>
      </textobject>
    </mediaobject>

    <procedure>
      <title>Создание дисковой последовательности
	 из неформатированных ATA дисков</title>

      <step><para>Загрузите модуль <filename>geom_stripe.ko</filename>:</para>

	<screen>&prompt.root; <userinput>kldload geom_stripe</userinput></screen>
      </step>

      <step><para>Убедитесь, что существует подходящая точка монтирования.
	Если вы планируете сделать логический диск корневым разделом,
	используйте временную точку монтирования, например <filename
	class="directory">/mnt</filename>:</para>

	<screen>&prompt.root; <userinput>mkdir /mnt</userinput></screen>
      </step>

      <step><para>Определите имена устройств, которые будут
	объединены в последовательность, и создайте новое устройство для
	последовательности.  Например, чтобы создать
	дисковую последовательность из двух неиспользуемых и неразмеченных
	<acronym>ATA</acronym> дисков, например <filename>/dev/ad2</filename> и
	<filename>/dev/ad3</filename>:</para>

	<screen>&prompt.root; <userinput>gstripe label -v st0 /dev/ad2 /dev/ad3</userinput>
Metadata value stored on /dev/ad2.
Metadata value stored on /dev/ad3.
Done.</screen>
      </step>

      <step><para>Запишите стандартную метку, также известную как таблица
	разделов, в новый том, и установите стандартный загрузчик:</para>

	<screen>&prompt.root; <userinput>bsdlabel -wB /dev/stripe/st0</userinput></screen>

      </step>

      <step><para>Теперь в <filename class="directory">/dev/stripe</filename>
	кроме <devicename>st0</devicename> появились ещё два устройства &mdash;
	<devicename>st0a</devicename> и <devicename>st0c</devicename>.
	Теперь создайте файловую систему на устройстве <devicename>st0a</devicename>,
	используя утилиту <command>newfs</command>:</para>

      <screen>&prompt.root; <userinput>newfs -U /dev/stripe/st0a</userinput></screen>

      <para>На экране промелькнет множество цифр, и через несколько
	секунд процесс будет завершен.  Логический диск создан и готов
	к монтированию.</para>
    </step>
  </procedure>

  <para>Смонтируйте его вручную:</para>

  <screen>&prompt.root; <userinput>mount /dev/stripe/st0a /mnt</userinput></screen>

  <para>Чтобы монтировать созданную дисковую последовательность
    автоматически во время загрузки, добавьте информацию о ней в
    файл <filename>/etc/fstab</filename>.  Создайте постоянную точку
    монтирования и назовите её, к примеру, <filename
      class="directory">stripe</filename>:</para>

  <screen>&prompt.root; <userinput>mkdir /stripe</userinput>
&prompt.root; <userinput>echo "/dev/stripe/st0a /stripe ufs rw 2 2" \</userinput>
    <userinput>&gt;&gt; /etc/fstab</userinput></screen>

  <para>Чтобы модуль <filename>geom_stripe.ko</filename> автоматически загружался во время инициализации
    системы, добавьте строку в
    <filename>/boot/loader.conf</filename>:</para>

  <screen>&prompt.root; <userinput>echo 'geom_stripe_load="YES"' &gt;&gt; /boot/loader.conf</userinput></screen>

  </sect1>

  <sect1 id="GEOM-mirror">
    <title>RAID1 - Зеркалирование (Mirroring)</title>

    <indexterm>
      <primary>GEOM</primary>
    </indexterm>
    <indexterm>
      <primary>Зеркалирование дисков</primary>
    </indexterm>

    <para>Зеркалирование (Mirroring) &mdash; технология,
      применяемая как в корпоративной среде, так и на домашних компьютерах.
      Она позволяет создавать резервные копии <quote>на лету</quote>.
      Зеркалирование, по сути, означает, что диск A является копией диска B.
      Или, возможно, диск C+D является копией диска A+B.  Вне зависимости от
      конфигурации, основной аспект &mdash; дублирование информации.  Позже,
      эта информация может быть с легкостью восстановлена или сохранена как
      резервная копия без остановки системы, или даже физически помещена в
      хранилище данных.</para>

    <para>Перед началом, убедитесь, что у вас есть два физических диска
      равной емкости.  Далее в этом примере подразумевается, что это диски
      прямого доступа (direct access, &man.da.4;) с интерфейсом
      <acronym>SCSI</acronym>.</para>

    <sect2>
      <title>Зеркалирование первичных дисков</title>

      <para>В статье предполагается, что &os; установлена на первый жесткий
	диск, определяемый системой как <devicename>da0</devicename>.
	Это устройство будет целевым для утилиты &man.gmirror.8;.</para>

      <para>Перед построением зеркала включите дополнительную отладочную
	информацию и откройте доступ к устройству.  Это достигается
	установкой следующего значения переменной &man.sysctl.8;
	<varname>kern.geom.debugflags</varname>:</para>

      <screen>&prompt.root; <userinput>sysctl kern.geom.debugflags=17</userinput></screen>

      <para>Теперь создайте зеркало.  Начните процесс с сохранения метаданных
	на первом диске.  В результате выполнения следующей команды
	будет создано устройство вида <filename
	class="devicefile">/dev/mirror/gm</filename>:</para>

      <warning>
	<para>Создание зеркала на диске, с которого произведена загрузка,
	  может повлечь за собой потерю данных в том случае, если данными
	  занят последний сектор диска.  Риск повреждения данных меньше, если
	  создание зеркала немедленно следует за свежей установкой &os;.</para>
      </warning>

      <screen>&prompt.root; <userinput>gmirror label -vb round-robin gm0 /dev/da0</userinput></screen>

      <para>Система должна выдать следующее сообщение:</para>

      <screen>Metadata value stored on /dev/da0.
Done.</screen>

      <para>Инициализируйте GEOM, это повлечет за собой загрузку модуля ядра
	<filename>/boot/kernel/geom_mirror.ko</filename>:</para>

      <screen>&prompt.root; <userinput>gmirror load</userinput></screen>

      <note>
	<para>После успешного завершения команды будет создано устройство
	  <devicename>gm0</devicename> в каталоге
	  <filename class="directory">/dev/mirror</filename>.</para>
      </note>

      <para>Включите автоматическую загрузку модуля
	<filename>geom_mirror.ko</filename> во время старта операционной
	системы:</para>

      <screen>&prompt.root; <userinput>echo 'geom_mirror_load="YES"' &gt;&gt; /boot/loader.conf</userinput></screen>

      <para>Отредактируйте файл <filename>/etc/fstab</filename>, заменив
	в нём упоминания старого имени устройства <devicename>da0</devicename>
	новым именем устройства зеркала <devicename>gm0</devicename>.</para>

      <note>
	<para>Если &man.vi.1; &mdash; ваш любимый текстовый редактор, то эта
	  задача решается просто:</para>

	<screen>&prompt.root; <userinput>vi /etc/fstab</userinput></screen>

	<para>Сделайте резервную копию файла <filename>fstab</filename>,
	  набрав в &man.vi.1; <userinput>:w /etc/fstab.bak</userinput>.
	  Затем замените все части строк, содержащие имя устройства
	  <devicename>da0</devicename>, на имя <devicename>gm0</devicename>,
	  набрав <userinput>:%s/da/mirror\/gm/g</userinput>.<para>
      </note>

      <para>Независимо от аппаратного интерфейса дисков
	(<acronym>SCSI</acronym> или <acronym>ATA</acronym>), устройство
	<acronym>RAID</acronym> будет именоваться всегда одинаково &mdash;
	<devicename>gm</devicename>.  Содержимое файла
	<filename>fstab</filename> должно выглядеть подобно следующему:</para>

      <programlisting># Device                Mountpoint      FStype  Options         Dump    Pass#
/dev/mirror/gm0s1b      none            swap    sw              0       0
/dev/mirror/gm0s1a      /               ufs     rw              1       1
/dev/mirror/gm0s1d      /usr            ufs     rw              0       0
/dev/mirror/gm0s1f      /home           ufs     rw              2       2
#/dev/mirror/gm0s2d     /store          ufs     rw              2       2
/dev/mirror/gm0s1e      /var            ufs     rw              2       2
/dev/acd0               /cdrom          cd9660  ro,noauto       0       0</programlisting>

      <para>Перезагрузите систему:</para>

      <screen>&prompt.root; <userinput>shutdown -r now</userinput></screen>

      <para>С этого момента во время каждой загрузки система должна
	использовать устройство <devicename>gm0</devicename> вместо устройства
	<devicename>da0</devicename>.  Удостовериться в этом можно так:
	дождитесь загрузки системы, наберите команду <command>mount</command>
	и просмотрите её вывод:</para>

      <screen>&prompt.root; <userinput>mount</userinput>
Filesystem         1K-blocks    Used    Avail Capacity  Mounted on
/dev/mirror/gm0s1a   1012974  224604   707334    24%    /
devfs                      1       1        0   100%    /dev
/dev/mirror/gm0s1f  45970182   28596 42263972     0%    /home
/dev/mirror/gm0s1d   6090094 1348356  4254532    24%    /usr
/dev/mirror/gm0s1e   3045006 2241420   559986    80%    /var
devfs                      1       1        0   100%    /var/named/dev</screen>

      <para>Как и ожидалось, вывод выглядит корректно.  И в заключение, чтобы
	начать синхронизацию данных, включите в зеркало диск
	<devicename>da1</devicename> при помощи следующей команды:</para>

      <screen>&prompt.root; <userinput>gmirror insert gm0 /dev/da1</userinput></screen>

      <para>Во время построения зеркала статус процесса построения может быть
	 проверен следующей командой:</para>

      <screen>&prompt.root; <userinput>gmirror status</userinput></screen>

      <para>Вывод вышеприведённой команды для построенного
	и синхронизированного зеркала выглядит подобно следующему:</para>

      <screen>      Name    Status  Components
mirror/gm0  COMPLETE  da0
                      da1</screen>

      <para>Если есть какие-либо неполадки или зеркало находится в процессе
	построения, в выводе команды будет обозначен статус
	<literal>DEGRADED</literal> вместо статуса
	<literal>COMPLETE</literal>.</para>
    </sect2>

    <sect2>
      <title>Решение проблем</title>

      <sect3>
	<title>Система не загружается</title>

	<para>Если система прекращает загрузку и выдает строку:</para>

	<programlisting>ffs_mountroot: can't find rootvp
Root mount failed: 6
mountroot&gt;</programlisting>

	<para>Перезагрузите компьютер кнопкой питания или кнопкой
	  <quote>Reset</quote>.  В загрузочном меню выберите опцию (6).
	  Это приведет к тому, что система выдаст приглашение &man.loader.8;.
	  Загрузите модуль ядра вручную:</para>

	<screen>OK? <userinput>load geom_mirror</userinput>
OK? <userinput>boot</userinput></screen>

	<para>Если это сработало, модуль ядра по какой-либо причине
	  не загрузился правильно.  Проверьте корректность соответствующей
	  записи в <filename>/boot/loader.conf</filename>.  Если проблема
	  осталась, добавьте строку:</para>

	<programlisting>options	GEOM_MIRROR</programlisting>

	<para>в файл конфигурации ядра, пересоберите и переустановите ядро.
	  Это должно устранить проблему.</para>
      </sect3>
    </sect2>

    <sect2>
      <title>Восстановление после дисковых сбоев</title>

      <para>Примечательной особенностью зеркалирования является то, что если
	диск вышел из строя, то он, пожалуй, может быть заменён вообще без
	ущерба для данных.</para>

      <para>Принимая во внимание предыдущую конфигурацию
	<acronym>RAID</acronym>1, предположим, что устройство
	<devicename>da1</devicename> вышло из строя, и ему требуется замена.
	Перед заменой определите, какой именно диск вышел из строя, а потом
	выключите систему.  Теперь дефектный диск может быть заменён новым,
	после чего необходимо снова загрузить систему.  После загрузки системы
	для замещения диска в зеркале могут быть использованы следующие
	команды:</para>

      <screen>&prompt.root; <userinput>gmirror forget gm0</userinput></screen>

      <screen>&prompt.root; <userinput>gmirror insert gm0 /dev/da1</userinput></screen>

      <para>Для наблюдения за статусом построения используйте команду
	<command>gmirror</command> <option>status</option>.  Вывод этой команды
	достаточно прост и понятен.</para>
    </sect2>
  </sect1>

  <sect1 id="geom-ggate">
    <title>Сетевые устройства GEOM Gate</title>

    <para>GEOM включает в себя поддержку работы с удаленными устройствами по
      сети, например с дисками, CD-ROM и т.д. путем использования
      gate утилит.  Это подобно работе с <acronym>NFS</acronym>.</para>

    <para>Для начала необходимо создать файл экспорта. В этом файле
      указывается, кому разрешен доступ к экспортируемым ресурсам и
      какой уровень доступа предоставляется.
      Например для того, чтобы экспортировать четвертый слайс первого
      <acronym>SCSI</acronym> диска, достаточно следующей записи в
      файле <filename>/etc/gg.exports</filename>:</para>

    <programlisting>192.168.1.0/24 RW /dev/da0s4d</programlisting>

    <para>Это позволит всем компьютерам внутри частной сети получить
      доступ к разделу <devicename>da0s4d</devicename>.</para>

    <para>Чтобы экспортировать устройство, убедитесь, что оно не смонтировано,
      и запустите сервер &man.ggated.8;:</para>

    <screen>&prompt.root; <userinput>ggated</userinput></screen>

    <para>Теперь, чтобы смонтировать устройство на клиентском компьютере
      выполните следующие команды:</para>

    <screen>&prompt.root; <userinput>ggatec create -o rw 192.168.1.1 /dev/da0s4d</userinput>
ggate0
&prompt.root; <userinput>mount /dev/ggate0 /mnt</userinput></screen>

    <para>С этого момента устройство доступно в точке монтирования
      <filename class="directory">/mnt</filename>.</para>

    <note>
      <para>Необходимо заметить, что попытка смонтировать
	устройство, уже смонтированное как сетевой или локальный диск,
	закончится неудачей.</para>
    </note>

    <para>Когда устройство больше не нужно, оно может быть размонтировано
	командой &man.umount.8;, как любое другое дисковое устройство.</para>
  </sect1>

  <sect1 id="geom-glabel">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Денис</firstname>
	  <surname>Пеплин</surname>
	  <contrib>Перевод на русский язык </contrib>
	</author>
      </authorgroup>
    </sect1info>

    <title>Метки дисковых устройств</title>

    <indexterm>
      <primary>GEOM</primary>
    </indexterm>
    <indexterm>
      <primary>Метки дисков</primary>
    </indexterm>

    <para>Во время загрузки системы, ядро &os; создает файлы
      для обнаруженных устройств.  Этот метод обнаружения устройств
      создает некоторые проблемы, например если новое дисковое
      устройство подключается через <acronym>USB</acronym>.  Может
      получиться так, что этому диску будет присвоено имя устройства
      <devicename>da0</devicename>, а устройство с прежним именем
      <devicename>da0</devicename> получит следующее имя,
      <devicename>da1</devicename>.  Это приведет к проблемам
      монтирования файловых систем, записанных в
      <filename>/etc/fstab</filename>.  На самом деле, это может даже
      помешать загрузке системы.</para>

    <para>Одно из решений состоит в расположении <acronym>SCSI</acronym>
      устройств в таком порядке, чтобы новые устройства, добавляемые к
      <acronym>SCSI</acronym> контроллеру, занимали свободные номера
      устройств.  Но что делать с <acronym>USB</acronym> устройствами,
      которые могут занять место основного <acronym>SCSI</acronym> диска?
      Это случается потому, что <acronym>USB</acronym> устройства обычно
      тестируются до <acronym>SCSI</acronym> контроллера.  Решение может
      состоять в подключении этих устройств после загрузки системы.
      Другое решение - использование <acronym>ATA</acronym> диска и
      исключение <acronym>SCSI</acronym> устройств из
      <filename>/etc/fstab</filename>.</para>

    <para>Есть и лучшее решение.  С помощью утилиты
      <command>glabel</command>, администратор или пользователь могут
      пометить дисковые устройства и использовать эти метки в
      <filename>/etc/fstab</filename>.  Поскольку
      <command>glabel</command> сохраняет метки в последнем секторе
      заданного устройства, они сохраняются и после перезагрузки.
      Используя эти метки вместо имени устройств, можно всегда смонтировать
      файловую систему независимо от назначенного имени устройства.</para>

    <note>
      <para>Очевидно, что метки должны быть постоянными.  Утилита
	<command>glabel</command> может использоваться для создания как
	временных, так и постоянных меток.  Только постоянные метки
	сохраняются после перезагрузок.  Прочтите &man.glabel.8;
	для получения более подробной информации о различии между
	метками.</para>
    </note>

    <sect2>
      <title>Типы меток и примеры</title>

      <para>Существует два типа меток, основной (generic) тип и метки файловой
	системы.  Метки могут быть постоянными или временными.
	Постоянные метки создаются командой &man.tunefs.8; или &man.newfs.8;.
	В дальнейшем они будут автоматически создаваться в подкаталоге
	каталога <filename class="directory">/dev</filename>,
	имя которого определяется
	в соответствии с типом файловой системы.  Например, метки
	файловых систем <acronym>UFS</acronym>2 будут расположены в
	каталоге <filename class="directory">/dev/ufs</filename>.
	Постоянные метки также можно создать при помощи команды
	<command>glabel label</command>.  Эти метки не зависят от типа
	файловой системы, поэтому они будут перечисляться в каталоге <filename
	  class="directory">/dev/label</filename>.</para>

      <para>Временные метки не сохраняются после перезагрузки.  Эти метки
	создаются в каталоге <filename class="directory">/dev/label</filename>,
	они хорошо подходят для экспериментов.  Временную метку можно создать
	командой <command>glabel create</command>.  За более детальной
	информацией обратитесь к странице справочника &man.glabel.8;.</para>

<!-- XXXTR: How do you create a file system label without running newfs
            or when there is no newfs (e.g.: cd9660)? -->

      <para>Чтобы создать постоянную метку для файловой системы
	<acronym>UFS</acronym>2 не нарушая самих данных, выполните следующую
	команду:</para>

      <screen>&prompt.root; <userinput>tunefs -L <replaceable>home</replaceable> <replaceable>/dev/da3</replaceable></userinput></screen>

      <warning>
	<para>Если файловая система заполнена, это может привести к
	  повреждению данных; в случае заполненной файловой системы
	  надо или удалить ненужные файлы, или не добавлять
	  метки.</para>
      </warning>

      <para>Метка должна появиться в <filename
	class="directory">/dev/ufs</filename> и может быть добавлена в
	<filename>/etc/fstab</filename>:</para>

      <programlisting>/dev/ufs/home		/home            ufs     rw              2      2</programlisting>

      <note>
	<para>Во время запуска <command>tunefs</command> файловая система
	не должна быть смонтирована.</para>
      </note>

      <para>Теперь файловую систему можно смонтировать как обычно:</para>

      <screen>&prompt.root; <userinput>mount /home</userinput></screen>

      <para>Если модуль ядра <filename>geom_label.ko</filename> указан в
	<filename>/boot/loader.conf</filename> и загружается вместе с
	системой, или в ядре указана опция <literal>GEOM_LABEL</literal>,
	метку устройства можно изменять без какого-либо негативного
	для системы эффекта.</para>

      <para>Файловая система может быть создана с меткой по умолчанию путем
	использования флага <option>-L</option> команды
	<command>newfs</command>.  Обратитесь к странице справочника
	&man.newfs.8; за более подробной информацией.</para>

      <para>Для удаления метки можно использовать следующую команду:</para>

      <screen>&prompt.root; <userinput>glabel destroy home</userinput></screen>

      <para>В следующем примере показано, как устанавливаются метки
	на разделы загрузочного диска.</para>

      <example>
	<title>Установка меток на разделы загрузочного диска</title>

	<para>Установка и задействование постоянных меток на разделах
	  загрузочного диска предоставит возможность операционной системе
	  загружаться нормально в том случае, если диск был переключен на
	  другой контроллер, или даже переставлен на другую машину.  В этом
	  примере был задействован один диск <acronym>ATA</acronym>,
	  определяемый системой как <devicename>ad0</devicename>.  Также
	  в примере подразумевается, что система использует типичную для
	  &os; схему разделения дискового пространства на слайсы и размещения
	  на них файловых систем <filename class="directory">/</filename>,
	  <filename class="directory">/var</filename>,
	  <filename class="directory">/usr</filename>,
	  <filename class="directory">/tmp</filename> и раздела
	  подкачки.</para>

	<para>Перезагрузите систему, дождитесь меню загрузчика.  Нажатием
	  клавиши <keycap>4</keycap> выберите однопользовательский режим.
	  Далее, введите следующие команды:</para>

	<screen>&prompt.root; <userinput>glabel label rootfs /dev/ad0s1a</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1a is label/rootfs
&prompt.root; <userinput>glabel label var /dev/ad0s1d</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1d is label/var
&prompt.root; <userinput>glabel label usr /dev/ad0s1f</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1f is label/usr
&prompt.root; <userinput>glabel label tmp /dev/ad0s1e</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1e is label/tmp
&prompt.root; <userinput>glabel label swap /dev/ad0s1b</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1b is label/swap
&prompt.root; <userinput>exit</userinput></screen>

	<para>Система продолжит загрузку в многопользовательский режим.
	  По завершении загрузки откройте файл <filename>/etc/fstab</filename>
	  и замените в нём традиционные имена файлов устройств
	  на соответствующие устройствам метки.  Результат будет выглядеть
	  подобно следующему:</para>

	<programlisting># Device                Mountpoint      FStype  Options         Dump    Pass#
/dev/label/swap         none            swap    sw              0       0
/dev/label/rootfs       /               ufs     rw              1       1
/dev/label/tmp          /tmp            ufs     rw              2       2
/dev/label/usr          /usr            ufs     rw              2       2
/dev/label/var          /var            ufs     rw              2       2</programlisting>

	<para>Перезагрузите еще раз систему.  Если всё прошло успешно,
	  система загрузится как обычно, а вывод команды
	  <command>mount</command> отобразит следующее:</para>

	<screen>&prompt.root; <userinput>mount</userinput>
/dev/label/rootfs on / (ufs, local)
devfs on /dev (devfs, local)
/dev/label/tmp on /tmp (ufs, local, soft-updates)
/dev/label/usr on /usr (ufs, local, soft-updates)
/dev/label/var on /var (ufs, local, soft-updates)</screen>
      </example>

      <para>Начиная с &os;&nbsp;7.2, GEOM класс &man.glabel.8; поддерживает
	новый тип меток для файловых систем <acronym>UFS</acronym>.  Новый
	тип меток базируется на уникальных идентификаторах файловых систем,
	называемых <literal>ufsid</literal>.  Во время загрузки системы
	они автоматически создаются и помещаются в каталог <filename
	class="directory">/dev/ufsid</filename>.  Перечисление меток должным
	образом в файле <filename class="directory">/etc/fstab</filename>
	делает возможным монтирование разделов по значениям
	<literal>ufsid</literal>.  Чтобы получить перечень файловых систем
	и соответствующих им меток <literal>ufsid</literal>, выполните команду
	<command>glabel status</command>:</para>

      <screen>&prompt.user; <userinput>glabel status</userinput>
                  Name  Status  Components
ufsid/486b6fc38d330916     N/A  ad4s1d
ufsid/486b6fc16926168e     N/A  ad4s1f</screen>

      <para>В данном примере <devicename>ad4s1d</devicename> содержит
	файловую систему <filename class="directory">/var</filename>,
	а <devicename>ad4s1f</devicename> соответствует файловой системе
	<filename class="directory">/usr</filename>.  Эти файловые системы
	можно также монтировать, указав значения их <literal>ufsid</literal>
	в файле <filename>/etc/fstab</filename>:</para>

      <programlisting>/dev/ufsid/486b6fc38d330916        /var        ufs        rw        2      2
/dev/ufsid/486b6fc16926168e        /usr        ufs        rw        2      2</programlisting>

      <para>Таким способом могут быть смонтированы любые разделы с метками
	<literal>ufsid</literal>, что исключает необходимость создания
	постоянных меток вручную и в то же время позволяет воспользоваться
	преимуществами монтирования по меткам.</para>
    </sect2>
  </sect1>

  <sect1 id="geom-gjournal">
    <title>Журналирование UFS средствами GEOM</title>

    <indexterm>
      <primary>GEOM</primary>
    </indexterm>
    <indexterm>
      <primary>Журналирование</primary>
    </indexterm>

    <para>С выходом &os; 7.0 был реализован долгожданный механизм
      ведения журналов для файловых систем.
      Сама реализация этого механизма осуществляется средствами системы
      <acronym>GEOM</acronym>, а конфигурирование выполняется утилитой
      &man.gjournal.8;.</para>

    <para>Что такое журналирование?  Журналирование сохраняет протокол
      транзакций файловой системы, то есть: изменения, составляющие
      логически завершенную операцию записи, сперва вносятся в журнал, а
      модификация метаданных и данных самого файла выполняется позже.
      В дальнейшем журнал может быть задействован для повторного выполнения
      транзакций на файловой системе с целью предотвращения нарушения
      целостности файловой системы.</para>

    <para>Журналирование &mdash; это еще одним механизм предотвращения
      утери данных и нарушения целостности файловой системы.  В отличие от
      механизма Soft Updates, который отслеживает и периодически сохраняет
      обновления метаданных, и механизма снэпшотов, который создает образ
      файловой системы, сам журнал хранится в специально отведенном
      для этой задачи пространстве диска, и, в некоторых случаях, может
      содержаться целиком на отдельном диске.</para>

    <para>В отличие от других реализаций журналирования файловых систем,
      метод <command>gjournal</command> работает на блочном уровне, он
      не встроен в файловую систему; это лишь надстройка над системой
      <acronym>GEOM</acronym>.</para>

    <para>Чтобы включить поддержку <command>gjournal</command>,
      в файле конфигурации ядра &os; должна присутствовать следующая опция
      (включено по умолчанию для &os; 7.0 и более поздних версий
      систем):</para>

    <programlisting>options	UFS_GJOURNAL</programlisting>

    <para>Журналируемым устройствам, монтируемым во время загрузки системы,
      также потребуется модуль ядра <filename>geom_journal.ko</filename>.
      Внесите следующую запись в файл
      <filename>/boot/loader.conf</filename>:</para>

    <programlisting>geom_journal_load="YES"</programlisting>

    <para>В качестве альтернативы, функции вышеупомянутого модуля можно
      встроить в специализированное ядро.  Для этого добавьте следующую опцию
      в файл конфигурации ядра:</para>

    <programlisting>options	GEOM_JOURNAL</programlisting>

    <para>Для создания журнала на новой файловой системе выполните
      следующие шаги (здесь и далее подразумевается, что
      <devicename>da4</devicename> есть новый <acronym>SCSI</acronym>
      диск):</para>

    <screen>&prompt.root; <userinput>gjournal load</userinput>
&prompt.root; <userinput>gjournal label /dev/da4</userinput></screen>

    <para>На этом этапе в каталоге <filename
      class="directory">/dev</filename> должны присутствовать файлы
      устройств <devicename>/dev/da4</devicename> и
      <devicename>/dev/da4.journal</devicename>.  Теперь необходимо
      создать файловую систему:</para>

    <screen>&prompt.root; <userinput>newfs -O 2 -J /dev/da4.journal</userinput></screen>

    <para>Предыдущая команда создаст файловую систему <acronym>UFS</acronym>2
      на журналируемом устройстве.</para>

    <para>Смонтируйте устройство в требуемый каталог файловой системы:</para>

    <screen>&prompt.root; <userinput>mount /dev/da4.journal <replaceable>/mnt</replaceable></userinput></screen>

    <note>
      <para>В случае наличия нескольких слайсов, журнал создается для каждого
	из них.  Например, если есть два слайса, и они называются
	<devicename>ad4s1</devicename> и <devicename>ad4s2</devicename>, то
	утилитой <command>gjournal</command> создаются файлы устройств
	<devicename>ad4s1.journal</devicename> и
	<devicename>ad4s2.journal</devicename>. </para>
    </note>

    <para>Для увеличения производительности может потребоваться хранение
      журнала на отдельном диске.  В таких случаях необходимо указать имя
      поставщика журнала или устройства хранения после имени устройства,
      на котором планируется включение журналирования.  Журналирование также
      может быть активировано утилитой <command>tunefs</command> на действующих
      файловых системах; однако, всегда создавайте резервную копию перед
      попытками изменить настройки файловой системы.  В большинстве случаев,
      выполнение команды <command>gjournal</command> завершится ошибкой, если
      создание журнала невозможно, в то время как некорректное использование
      команды <command>tunefs</command> не защитит против потери данных.</para>

    <para>Также возможно журналирование загрузочного диска системы &os;.
      За детальными инструкциями по этой возможности обратитесь к статье
      <ulink url="&url.articles.gjournal-desktop;">Настройка журналирования
	UFS для настольного компьютера</ulink>.</para>
  </sect1>
</chapter>
<!--
     Local Variables:
     mode: sgml
     sgml-declaration: "../chapter.decl"
     sgml-indent-data: t
     sgml-omittag: nil
     sgml-always-quote-attributes: t
     sgml-parent-document: ("../book.sgml" "part" "chapter")
     End:
-->
