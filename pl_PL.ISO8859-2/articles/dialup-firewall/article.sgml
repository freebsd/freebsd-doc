<!--
     The FreeBSD Polish Documentation Project

     $FreeBSD$
     Original revision: 1.25
-->

<!DOCTYPE article PUBLIC "-//FreeBSD//DTD DocBook V4.1-Based Extension//EN" [
<!ENTITY % man PUBLIC "-//FreeBSD//ENTITIES DocBook Manual Page Entities//EN">
%man;
]>

<article lang="pl">
  <articleinfo>
    <title>Firewall na po³±czeniu modemowym w FreeBSD</title>

    <authorgroup>
      <author>
	<firstname>Marc</firstname>
	<surname>Silver</surname>
	<affiliation>
	  <address><email>marcs@draenor.org</email></address>
	</affiliation>
      </author>
    </authorgroup>

    <releaseinfo>$FreeBSD$</releaseinfo>

    <abstract>
      <para>W niniejszym artykule przedstawiono instrukcjê konfiguracji
        firewalla przy dynamicznie przydzielanym adresie IP, a tak¿e
	przepis na uruchomienie takiego firewalla w FreeBSD, korzystaj±c
	z IPFW.
	Artyku³ nie zawiera instrukcji konfigurowania po³±czenia
	PPP.</para>
    </abstract>
  </articleinfo>

  <sect1 id="preface">
    <title>Wstêp</title>

    <para>Firewall na po³±czeniu modemowym w FreeBSD</para>

     <para>Niniejszy artyku³ opisuje konfiguracjê firewalla w FreeBSD
       w przypadku, gdy adres IP przydzielany jest dynamicznie przez
       dostawcê us³ug internetowych. Do³o¿ono wszelkich starañ, aby
       artyku³ zawiera³ przydatne informacje i by³ wolny od b³êdów,
       jednak¿e wszelkie uwagi i sugestie s± mile widziane, proszê
       kierowaæ je do <email>marcs@draenor.org</email>.</para>
   </sect1>

   <sect1 id="kernel">
    <title>Opcjê j±dra</title>

    <para>Na pocz±tek bêdziemy musieli przekompilowaæ j±dro. Wiecej
      informacji na temat kompilowania j±dra znale¼æ mo¿na w <ulink
      URL="../../books/handbook/kernelconfig.html">czê¶ci Podrêcznika
      po¶wiêconej konfiguracji j±dra</ulink>. Do pliku konfiguracyjnego
      j±dra dopisujemy nastêpuj±ce opcje:</para>

    <variablelist>
      <varlistentry>
	<term><literal>options IPFIREWALL</literal></term>

	<listitem>
	  <para>W³aczenie obs³ugi firewalla w j±drze.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>options IPFIREWALL_VERBOSE</literal></term>

	<listitem>
	  <para>Wysy³anie informacji o pakietach do logów systemowych.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>options
	    IPFIREWALL_VERBOSE_LIMIT=<replaceable>100</replaceable></literal></term>

	<listitem>
	  <para>Ograniczenie liczby pakietów zapisywanych w logach;
	    dziêki temu plik loga nie zostanie zapchany wieloma
	    powtarzaj±cymi siê wpisami. Warto¶æ
	    <replaceable>100</replaceable> jest sensowna, mo¿na jednak
	    wstawiæ inn±, odpowiedni± dla w³asnych potrzeb.</para>
	</listitem>
      </varlistentry>

      <varlistentry>
	<term><literal>options IPDIVERT</literal></term>

	<listitem>
	  <para>W³±czenie gniazd divert.</para>
	</listitem>
      </varlistentry>
    </variablelist>

    <para>Mo¿na dopisaæ jeszcze kilka wierszy
      <emphasis>opcjonalnych</emphasis>, które zwiêkszaj± poziom
      bezpieczeñstwa. Firewall pracuje poprawnie równie¿ bez nich,
      jednak¿e bardziej ostro¿ni u¿ytkownicy mog± zechcieæ z nich
      skorzystaæ.</para>

    <variablelist>
      <varlistentry>
	<term><literal>options TCP_DROP_SYNFIN</literal></term>

	<listitem>
	  <para>Ignorowanie pakietów TCP z ustawionymi flagami
	    SYN i FIN. Zapobiega to mo¿liwo¶ci identyfikacji stosu TCP/IP
	    przy pomocy narzêdzi takich jak nmap, jest to jednak wbrew
	    ustaleniom dokumentu RFC1644. Nie powinno byæ stosowane,
	    je¶li na maszynie ma dzia³aæ serwer WWW.</para>
	</listitem>
      </varlistentry>
     </variablelist>

    <para>Po kompilacji j±dra nie trzeba od razu prze³adowywaæ systemu.
      Je¶li wszystko pójdzie zgodnie z planem, wystarczy jedno
      prze³adowanie po ukoñczeniu konfiguracji firewalla.</para>
  </sect1>

  <sect1 id="rcconf">
    <title>Uruchamianie firewalla w
      <filename>/etc/rc.conf</filename></title>

    <para>Trzeba teraz wprowadziæ pewne zmiany w
      <filename>/etc/rc.conf</filename>, by uwzglêdnia³ on firewalla.
      Dodajemy nastêpuj±ce linijki:</para>

    <programlisting>firewall_enable="YES"
firewall_script="/etc/firewall/fwrules"
natd_enable="YES"
natd_interface="tun0"
natd_flags="-dynamic"</programlisting>

    <para>Informacje na temat dzia³ania powy¿szych poleceñ mo¿na
      znale¼æ w <filename>/etc/defaults/rc.conf</filename> oraz
      &man.rc.conf.5;.</para>
  </sect1>

  <sect1>
    <title>Wy³±czenie t³umaczenia adresów przez PPP</title>

    <para>Je¿eli wykorzystywane jest t³umaczenie adresów
      sieciowych
      wbudowane w PPP, trzeba bêdzie je wy³±czyæ. W naszych przyk³adach
      t³umaczeniem zajmuje siê &man.natd.8;.</para>

    <para>Fragment pliku odpowiedzialny za automatyczne uruchomienie
      PPP wygl±da zapewne tak:</para>

    <programlisting>ppp_enable="YES"
ppp_mode="auto"
ppp_nat="YES"
ppp_profile="<replaceable>profile</replaceable>"</programlisting>

    <para>Je¶li tak w³a¶nie jest, trzeba bêdzie wy³±czyæ
      <literal>ppp_nat</literal> wpisuj±c
      <literal>ppp_nat="NO"</literal> w
      <filename>/etc/rc.conf</filename>. Ponadto nale¿y usun±æ
      wpisy <literal>nat enable yes</literal> lub
      <literal>alias enable yes</literal> w
      <filename>/etc/ppp/ppp.conf</filename>.</para>
  </sect1>

  <sect1 id="rules">
    <title>Regu³y firewalla</title>

    <para>Wiêkszo¶æ pracy mamy ju¿ za sob±. Pozosta³o ju¿ tylko
      ustalenie regu³ firewalla, po czym bêdzie mo¿na dokonaæ
      prze³adowania systemu i powinni¶my otrzymaæ dzia³aj±cego
      firewalla. Zdajê sobie sprawê, ¿e zbiór regu³ zale¿y od
      indywidualnych
      potrzeb, stara³em siê jednak przygotowaæ regu³y odpowiednie
      dla wiêkszo¶ci u¿ytkowników ³±cz komutowanych. Mo¿na je
      oczywi¶cie dostosowaæ samodzielnie, traktuj±c poni¿sze regu³y
      jako punkt wyj¶cia. Zacznijmy od zamkniêtego firewalla: z
      za³o¿enia wszystkie pakiety s± blokowane, przepuszczaæ
      bêdziemy jedynie to, co jest nam rzeczywi¶cie potrzebne.
      Regu³y powinny najpierw okre¶laæ, co jest przepuszczane, potem
      co jest blokowane. Podajemy wiêc wszystkie regu³y
      przepuszczaj±ce, a potem nakazujemy blokowaæ ca³± resztê.
      :)</para>

    <para>Stwórzmy teraz katalog <filename
      class="directory">/etc/firewall</filename>. W nim utwórzmy plik
      <filename>fwrules</filename>, zgodnie z tym, co napisali¶my
      w <filename>rc.conf</filename>. Mo¿emy oczywi¶cie nazwaæ ten
      plik jak nam siê ¿ywnie podoba, proponowana tu nazwa jest
      jedn± z mo¿liwo¶ci.</para>

    <para>Spójrzmy teraz na przyk³adowy plik firewalla, opatrzony
      komentarzami.</para>


    <programlisting>
# Regu³y firewalla
# Autor: Marc Silver (marcs@draenor.org)
# http://draenor.org/ipfw
#

# Definicja komendy firewalla (jak w /etc/rc.firewall) upraszcza
# jej wywo³ywanie i czyni plik bardziej czytelnym.
fwcmd="/sbin/ipfw"

# Wyczyszczenie aktualnie obowi±zuj±cych regu³.
$fwcmd -f flush

# Przekierowanie wszystkich pakietów przez interfejs tun0.
$fwcmd add divert natd all from any to any via tun0

# Przepuszczanie danych przesy³anych przez kartê sieciow± i lokalnie.
# Upewnij siê, ¿e wpisa³e¶ tu w³a¶ciw± kartê (w moim przypadku fxp0)
# zanim prze³adujesz system. :)
$fwcmd add allow ip from any to any via lo0
$fwcmd add allow ip from any to any via fxp0

# Przepuszczanie wszystkich po³±czeñ nawi±zywanych przez nas.
$fwcmd add allow tcp from any to any out xmit tun0 setup

# Pozwalamy, by po³±czenia nawi±zane mog³y pozostaæ otwarte.
$fwcmd add allow tcp from any to any via tun0 established

# Zezwolenie na po³±czenia z zewn±trz z okre¶lonymi us³ugami na
# naszej maszynie. Przyk³adowo dopuszczamy po³±czenia z ssh i apache.
$fwcmd add allow tcp from any to any 80 setup
$fwcmd add allow tcp from any to any 22 setup

# Wysy³amy RESET w odpowiedzi na pakiety ident.
$fwcmd add reset log tcp from any to any 113 in recv tun0

# Pozwalamy na wychodz±ce zapytania DNS do wybranych serwerów.
$fwcmd add allow udp from any to <replaceable>x.x.x.x</replaceable> 53 out xmit tun0

# I oczywi¶cie pozwalamy im odpowiedzieæ... :)
$fwcmd add allow udp from <replaceable>x.x.x.x</replaceable> 53 to any in recv tun0

# Dopuszczenie pakietów ICMP (dziêki którym dzia³aj± ping i traceroute).
# Mo¿na zdecydowaæ siê na ich blokowanie, ja jednak my¶lê, ¿e mi siê
# przydadz±.
$fwcmd add allow icmp from any to any

# Odrzucenie ca³ej reszty.
$fwcmd add deny log ip from any to any
</programlisting>

    <para>Zbudowali¶my w pe³ni sprawny firewall zezwalaj±cy na po³±czenia
      z portami 80 i 22, oraz rejestruj±cy próby po³±czenia z czymkolwiek
      innym. Po prze³adowaniu systemu powinien ju¿ nale¿ycie
      funkcjonowaæ. Je¿eli jakiekolwiek z podanych tu informacji
      oka¿± siê b³êdne, b±d¼ bêd± powodowaæ problemy, proszê o
      zawiadomienie emailem. Mile widziane s± równie¿ pomys³y
      na ulepszenie niniejszej strony.</para>
  </sect1>

  <sect1>
    <title>Pytania</title>

    <qandaset>
      <qandaentry>
	<question>
	  <para>Dlaczego korzystasz z &man.natd.8; i &man.ipfw.8;, a
	    nie z filtrów wbudowanych w &man.ppp.8;?</para>
	</question>
	
	<answer>
	  <para>Mówi±c szczerze, nie ma konkretnego powodu dla którego
	    zdecydowa³em siê na <command>ipfw</command> i
	    <command>natd</command>, a nie filtrowanie wbudowane w
	    <command>ppp</command>. Dyskusje przeprowadzone z
	    ró¿nymi osobami doprowadzi³y do stwierdzenia, i¿
	    <command>ipfw</command> jest z pewno¶ci± bardziej
	    rozbudowany i ma wiêksze mo¿liwo¶ci konfiguracji ni¿
	    filtry <command>ppp</command>, jest jednak trudniejszy
	    w u¿ywaniu. Jednym z powodów mojego wyboru jest
	    to, ¿e wolê, by firewall dzia³a³ na poziomie j±dra systemu,
	    a nie programu u¿ytkownika.</para>
	</answer>
      </qandaentry>

      <qandaentry>
        <question>
	  <para>Otrzymujê komunikat w rodzaju <errorname>limit 100
	    reached on entry 2800</errorname>, po którym w logach
	    nie pojawiaj± siê informacje o zablokowanych pakietach.
	    Czy mój firewall nadal dzia³a?</para>
        </question>

	<answer>
	  <para>Taki komunikat oznacza jedynie, ¿e osi±gniêty zosta³
	    limit rejestrowania regu³y. Sama regu³a wci±¿ obowi±zuje,
	    nie bêdzie ju¿ jednak rejestrowana, dopóki liczniki
	    rejestrowania nie zostan± wyzerowane; mo¿na to zrobiæ
	    poleceniem <command>ipfw resetlog</command>. Innym
	    rozwi±zaniem jest zwiêkszenie limitu w konfiguracji
	    j±dra przy pomocy opcji
	    <option>IPFIREWALL_VERBOSE_LIMIT</option>, tak jak
	    jest to opisane wcze¶niej. Limit mo¿na tak¿e ustawiæ
	    zmieniaj±c warto¶æ net.inet.ip.fw.verbose_limit
	    przy pomocy &man.sysctl.8;.</para>
        </answer>
      </qandaentry>

      <qandaentry>
	<question>
	  <para>W sieci wewnêtrznej korzystam z adresów z puli prywatnej,
	    np. z zakresu 192.168.0.0, czy mogê uzupe³niæ regu³y firewalla
	    wpisem w rodzaju
	    <literal>$fwcmd add deny all from any to
	    192.168.0.0:255.255.0.0 via tun0</literal> aby uniemo¿liwiæ
	    próby po³±czeñ z zewn±trz z lokalnymi maszynami?</para>
	</question>

	<answer>
	  <para>Nie, poniewa¿ <emphasis>wszystko</emphasis> co
	    przechodzi przez <devicename>tun0</devicename> podlega
	    t³umaczeniu adresów realizowanemu przez
	    <command>natd</command>.
	    Pakiety przychodz±ce z zewn±trz trafiaj± wy³±cznie do
	    dynamicznie przydzielonego adresu IP, a
	    <emphasis>nie</emphasis> do sieci wewnêtrznej. Zauwa¿my
	    jednak, ¿e mo¿na dodaæ regu³ê w rodzaju <literal>$fwcmd
	    add deny all from 192.168.0.4:255.255.0.0 to any
	    via tun0</literal>, która zabroni maszynie w sieci
	    wewnêtrznej komunikowania siê ze ¶wiatem przez
	    firewall.</para>
	</answer>
      </qandaentry>

      <qandaentry>
	<question>
	  <para>Co¶ musi byæ nie tak. Postêpowa³em dok³adnie wed³ug
	    wskazówek i jestem w kropce.</para>
        </question>

	<answer>
	  <para>W artykule przyjmujemy, ¿e korzystamy z
	    <emphasis>userland-ppp</emphasis>, regu³y obowi±zuj± wiêc
	    dla interfejsu <devicename>tun0</devicename>, odpowiadaj±cemu
	    pierwszemu po³±czeniu nawi±zanemu przez &man.ppp.8;
	    (zwanemu tak¿e <emphasis>user-ppp</emphasis>). Dodatkowym
	    po³±czeniom odpowiadaæ bêd± interfejsy
	    <devicename>tun1</devicename>, <devicename>tun2</devicename>
	    itd. </para>

	  <para>W przypadku &man.pppd.8; jest
	    z kolei wykorzystywany
	    interfejs <devicename>ppp0</devicename>, je¶li
	    wiêc po³±czenie jest realizowane za po¶rednictwem
	    &man.pppd.8;, w miejscu <devicename>tun0</devicename>
	    trzeba wstawiæ <devicename>ppp0</devicename>. Poni¿ej
	    przedstawiona jest szybka metoda uwzglêdnienia tej zmiany
	    w regu³ach firewalla. Oryginalny plik z regu³ami
	    zachowywany jest pod nazw±
	    <filename>fwrules_tun0</filename>.</para>

	  <screen>	    &prompt.user; <userinput>cd /etc/firewall</userinput>
	    /etc/firewall&prompt.user; <userinput>su</userinput>
	    <prompt>Password:</prompt>
	    /etc/firewall&prompt.root; <userinput>mv fwrules fwrules_tun0</userinput>
	    /etc/firewall&prompt.root; <userinput>cat fwrules_tun0 | sed s/tun0/ppp0/g > fwrules</userinput>
	  </screen>

	  <para>By przekonaæ siê, czy w u¿yciu jest &man.ppp.8;, czy
	    &man.pppd.8;, mo¿na po nawi±zaniu po³±czenia
	    pos³u¿yæ siê &man.ifconfig.8;. W przypadku po³±czenia
	    nawi±zanego przez &man.pppd.8; zobaczyliby¶my co¶
	    w rodzaju (pomijaj±c nieistotne informacje):</para>

	  <screen>	    &prompt.user; <userinput>ifconfig</userinput>
	    <emphasis>(nieistotne...)</emphasis>
	    ppp0: flags=<replaceable>8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1524</replaceable>
                    inet <replaceable>xxx.xxx.xxx.xxx</replaceable> -************-&gt; <replaceable>xxx.xxx.xxx.xxx</replaceable> netmask <replaceable>0xff000000</replaceable>
	    <emphasis>(nieistotne...)</emphasis>
	    </screen>

	  <para>Natomiast gdy nawi±zanie po³±czenia odby³o siê za
	    po¶rednictwem &man.ppp.8; (<emphasis>user-ppp</emphasis>),
	    ujrzymy co¶ takiego:</para>

	  <screen>	    &prompt.user; <userinput>ifconfig</userinput>
	    <emphasis>(nieistotne...)</emphasis>
	    ppp0: flags=<replaceable>8010&lt;POINTOPOINT,MULTICAST&gt; mtu 1500</replaceable>
	    <emphasis>(nieistotne...)</emphasis>
	    tun0: flags=<replaceable>8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1524</replaceable>
	            <emphasis>(nieistotne IPv6...)</emphasis>
                    inet <replaceable>xxx.xxx.xxx.xxx</replaceable> -************-&gt; <replaceable>xxx.xxx.xxx.xxx</replaceable> netmask <replaceable>0xffffff00</replaceable>
                    Opened by PID <replaceable>xxxxx</replaceable>
            <emphasis>(nieistotne...)</emphasis></screen>
	</answer>
      </qandaentry>
    </qandaset>
  </sect1>
</article>
