<!--
     The FreeBSD Documentation Project
     The FreeBSD Japanese Documentation Project

     Original revision: 1.30
     $FreeBSD: doc/ja_JP.eucJP/books/handbook/printing/chapter.sgml,v 1.9 2000/07/20 12:22:35 hrs Exp $
-->

<chapter id="printing">
  <title>プリンタの利用</title>
  
  <para><emphasis>原作: &a.kelly;, 1995 年 9 月 30 日.</emphasis></para>

  <para><emphasis>改訂: &a.jim;, 2000 年 3 月</emphasis></para>

  <para><emphasis>訳: &a.jp.kimura;, 1996 年 9 月 3 日</emphasis></para>

  <sect1>
    <title>この章では</title>

    <para>FreeBSD でプリンタを使用するためには,
      バークレイラインプリンタスプーリングシステム
      (LPD スプーリングシステムとしても知られています)
      が機能するようにプリンタをセットアップする必要があります.
      本章では設定例を通して, LPD スプーリングシステム
      (大抵の場合, 単に LPD と呼ばれる)
      について紹介します.</para>

    <para>もし, LPD
      や他のプリンタスプーリングシステムについてすでに詳しい知識をお持ちの方は,
      <link linkend="printing-intro-setup">スプーリングシステムのセットアップ</link
        >から読み始めても構いません.</para>
  </sect1>

  <sect1 id="printing-intro-spooler">
    <title>はじめに</title>

    <para>LPD はあるホストのプリンタに関する制御の一切を行ないます.
      ここで言う制御としては, 次のことがあげられます.</para>

    <itemizedlist>
      <listitem>
	<para>ホストに接続されたプリンタ,
          あるいはネットワーク上の他ホストに接続されたプリンタに対するアクセス制御を行ないます.</para>
      </listitem>

      <listitem>
	<para>ファイルをプリントする要求に対して許可を与えます.
	  この要求は特に<emphasis>ジョブ</emphasis>と呼ばれています.</para>
      </listitem>

      <listitem>
	<para>各々のプリンタの<emphasis>キュー</emphasis>を管理することにより,
	  複数のユーザがあるプリンタに対して同時にアクセスすることを防ぎます.</para>
      </listitem>

      <listitem>
	<para><emphasis>ヘッダページ</emphasis>
	  (<emphasis>バナー</emphasis>または
	  <emphasis>バースト</emphasis>ページとしても知られています)
	  をプリントすることができます.
          これにより,
	  プリントアウトの山の中から自分がプリントしたジョブを見つけやすくなります.</para>
      </listitem>

      <listitem>
	<para>シリアルポートに接続したプリンタ用に通信パラメータを管理します.</para>
      </listitem>

      <listitem>
	<para>ネットワーク経由で他のホスト上の
          LPD スプーラにジョブを送ることができます.</para>
      </listitem>

      <listitem>
	<para>様々なプリンタ言語やプリンタの能力に応じてジョブの形式を整えるため,
	  特別なフィルタを起動することができます.</para>
      </listitem>

      <listitem>
	<para>プリンタの使用に対して課金を行なうことができます.</para>
      </listitem>
    </itemizedlist>

    <para>設定ファイルを通して, あるいは特別なフィルタプログラムを用いることにより,
      多種多様なプリンタ機器に対して,
      上述の機能の全部または一部を LPD システムに行なわせることができます.</para>

    <sect2 id="printing-intro-why">
      <title>どうしてスプーラを使うべきなのか</title>

      <para>あなたのシステムを利用するのがあなた一人だけだとしたら,
        アクセス制御もヘッダページも
        プリンタ利用に対する課金も必要ないのに,
        なぜわざわざスプーラに煩わされなければならないのか疑問に思うかも知れません.
        プリンタに対する直接アクセスを許可することもできるのですが,
        とにかくスプーラを使用するべきです. その理由は,</para>

      <itemizedlist>
        <listitem>
          <para>LPD はジョブをバックグラウンドで処理します.
            データがプリンタに送信されるまで待つ必要がなくなります.</para>
        </listitem>
        
        <listitem>
          <para>LPD ではジョブをフィルタを通してプリントすることが簡単にできます.
            これにより, 印刷物のヘッダに時刻や日付を入れたり,
            特別なファイル形式 (TeX の DVI ファイルなど)
            をプリンタが処理できる形式に変更することができ,
            これらの作業を手動で行なう必要がなくなります.</para>
        </listitem>

        <listitem>
          <para>プリント処理を行なうフリー,
            または商用のプログラムのほとんどは,
            システムのスプーラとやりとりするように作られています.
            スプーリングシステムをセットアップすることで,
            今後加えるかもしれない, あるいは,
            すでに持っている別のソフトウェアをより簡単にサポートすることができるでしょう.</para>
        </listitem>
      </itemizedlist>
    </sect2>
  </sect1>

  <sect1 id="printing-intro-setup">
    <title>基本的なセットアップ</title>

    <para>LPD スプーリングシステムを用いてプリンタを使用するためには,
      プリンタ機器と LPD 用ソフトウェアの両方を準備する必要があります.
      本文書では次の二段階のレベルに分けて説明をします.</para>

    <itemizedlist>
      <listitem>
	<para>プリンタを接続する方法,
          プリンタにどのように通信するかを LPD に指示する方法や,
          プレインテキストをプリンタで印字する方法については,
          <link linkend="printing-simple">プリンタの簡単な設定</link>をご覧ください.</para>
      </listitem>

      <listitem>
	<para>様々な形式のファイルを印字する方法,
          ヘッダページを印字する方法,
          ネットワーク経由でプリンタに印字する方法,
          プリンタを制御する方法,
          プリンタの使用に対する課金を行なう方法については<link linkend="printing-advanced">プリンタ設定
            上級編</link>をご覧ください.</para>
      </listitem>
    </itemizedlist>

    <sect2 id="printing-simple">
      <title>プリンタ設定導入編</title>
      
      <para>この節では, プリンタ機器やプリンタを使用するための
        LPD 用ソフトウェアを設定する方法について述べます.
        この節の概要は次のとおりです.</para>

      <itemizedlist>
        <listitem>
          <para><link linkend="printing-hardware">プリンタ機器の設定</link>では,
            プリンタをコンピュータに接続するためのヒントがいくつか書かれています.</para>
        </listitem>

      <listitem>
          <para><link linkend="printing-software">ソフトウェアの設定</link>では,
            LPDのスプーラ設定ファイル
            <filename>/etc/printcap</filename>
            の設定方法について書かれています.</para>
        </listitem>
      </itemizedlist>
      
      <para>データをプリンタに送るためにシリアルまたはパラレルインタフェー スではなく,
        ネットワークプロトコルを使用する場合は,
        <link linkend="printing-advanced-network-net-if"
              >ネットワークにおけるデータストリームインタフェースを持つプリンタ</link
          >をご覧ください.</para>

      <para>この節のタイトルは<quote>プリンタ設定導入編</quote>ですが,
        実際の設定はかなり複雑です.
        プリンタをコンピュータに接続し,
        LPD スプーラを 起動させることは一番困難な作業です.
        ヘッダページを出力させたり課金したりするオプションの設定は,
        一度プリンタがうまく動くようになればとても簡単です.</para>

      <sect3 id="printing-hardware">
        <title>プリンタ機器の設定</title>

        <para>この節では, プリンタに PC
          を接続するための様々な方法について説明しています.
          ここでは, ポートやケーブルの種類,
          FreeBSD がプリンタとの通信に必要なカーネルコンフィグレーションについても言及しています.</para>

        <para>もしプリンタが既に接続されていて,
          他のオペレーティングシステム上でプリンタからの印字に成功している場合は,
          <link linkend="printing-software">ソフトウェアの設定</link
            >まで読み飛ばすことが多分できるでしょう.</para>

        <sect4 id="printing-ports">
          <title>ポートとケーブル</title>

          <para>最近の PC
            用のプリンタほとんどには次のインタフェースの一つもしくは両方がついています.</para>

          <itemizedlist>
            <listitem>
              <para><emphasis>シリアル</emphasis>インタフェースでは,
                プリンタにデータを送信するためにコンピュータにあるシリアルポートが使用されます.
                シリアルインタフェースはコンピュータ業界で共通して使用されています.
                そのケーブルは容易に手に入りますし, 簡単に自作することもできます.
                シリアルインタフェースの場合は時々,
                特別なケーブルや何か複雑な通信方式選択の設定が必要になることがあります.</para>
            </listitem>

            <listitem>
              <para><emphasis>パラレル</emphasis>インタフェースではプリンタにデータを送信するために,
                コンピュータにあるパラレルポートを使用します.
                パラレルインタフェースは PC 業界では良く使われます.
                ケーブルの入手は容易ですが,
                自作するのはシリアルよりも困難です.
                パラレルインタフェースには通常, 通信方式の選択はなく,
                設定は極めて単純です.</para>

	    <para>パラレルインタフェースは<quote>セントロニクス</quote>インタフェースとして知られています.
                これは, プリンタ用のコネクタタイプとして採用された後に名付けられました.</para>
            </listitem>
          </itemizedlist>

          <para>シリアルインタフェースはパラレルインタフェースよりも普通はデータの伝送速度が遅くなります.
            パラレルインタフェースで は, 通常,
            (コンピュータからプリンタへの) 単方向通信のみを行なうのに対して,
            シリアルインタフェースは双方向通信を行ないます.
            FreeBSD でも IEEE1284 準拠のケーブルを使えば,
            最近のパラレルポートとプリンタの多くで双方向通信を行なうことができます.</para>

          <para>通常, プリンタで双方向通信が必要となるのは, プリンタが
            PostScript 言語に対応しているときだけです.
            PostScript プリンタは非常に冗長に動作させることができます.
            事実, PostScript によるジョブでは, プログラムを本当にプリンタに送信します.
            このことは, 印字作業を必ずしもする必要がないことを意味しますし,
            そのプログラムの結果はコンピュータに直接返されるかも知れません.
            PostScript プリンタでは双方向通信を使って
            PostScript プログラムのエラーや紙づまりといった問題をコンピュータに報告します.
            ユーザはそれらの情報を知りたいと思うかも知れません.
            また, PostScript プリンタで課金作業をもっとも効率よく行なうためには,
            双方向通信が必要となります.
            この方法ではまず, プリンタの現在のページカウント
            (起動してから今まで何枚の紙を印字したか) の情報を得ます.
            次に, ユーザのジョブを実行し, 終了後, 再びページカウントを得ます.
            この二つの数を差によって,
            課金対象となる紙の枚数を知ることができるのです.</para>
	</sect4>

        <sect4 id="printing-parallel">
          <title>パラレルポート</title>

          <para>プリンタをパラレルインタフェースを使って接続する場合は,
            セントロニクスケーブルでプリンタとコンピュータを接続してください.
            詳しい説明はプリンタやコンピュータに付属する説明書に書かれているはずです.</para>

          <para>その際,
            どのパラレルポートを使用したかを覚えておいてください.
            FreeBSDでは最初のポートは <filename>/dev/lpt0</filename>,
            二番目 <filename>/dev/lpt1</filename> であ り,
            三番目以降も同様に続きます.</para>
        </sect4>

        <sect4 id="printing-serial">
          <title>シリアルポート</title>
          
          <para>シリアルインタフェースを使ってプリンタを使う場合は,
            適切なシリアルケーブルでプリンタとコンピュータを接続してください.
            詳しい説明はプリンタ, コンピュータ, あるいは両方に付属する説
            明書に書かれているはずです.</para>

          <para><quote>適切なシリアルケーブル</quote>が良くわからないときは,
            次のどれかを試してみてください.</para>

          <itemizedlist>
            <listitem>
              <para><emphasis>モデム</emphasis>用ケーブルでは,
                それぞれのピンは他方のコネクタの対応するピンと線でつながっています.
                このタイプのケーブルは <quote>DTE-DCE</quote>
                間ケーブルとしても知られています
                (訳注:
                日本ではストレートケーブルという名前で売られています).
              </para>
            </listitem>

            <listitem>
              <para><emphasis>ヌルモデム</emphasis>用ケーブルでは,
                あるピンは対応するピンとを接続していますが,
                あるピン
                (たとえば, データ送信用とデータ受信用のピン)
                が交差して接続したり,
                いくつかのピンは内部で短絡していたりします.
                このタイプのケーブルは,
                <quote>DTE-DTE</quote> 間ケーブルと呼ばれています
                (訳注:
                日本ではクロスケーブルという名前で売られています).</para>
            </listitem>
            
            <listitem>
              <para>A <emphasis>シリアルプリンタ</emphasis>用ケーブルは,
                ある特定のプリンタで必要とされるものです.
                ヌルモデムケーブルと似ていますが,
                内部で短絡させる代わりに,
                ある信号を他方側に送るために使用しています.</para>
            </listitem>
          </itemizedlist>
          
          <para>この他に,
            プリンタ用の通信パラメータを設定する必要があります.
            通常,
            プリンタのフロントパネルや DIP スイッチによって制御します.
            コンピュータとプリンタの双方で設定できる最高の通信速度
            [bps] (ビット/秒.
            <emphasis>ボーレート</emphasis>と示されているときもある)
            を選んでください. そして, データビット (7 または 8),
            パリティ(偶/奇/なし), ストップビット (1 または 2)
            を選んでください.
            そして, フローコントロールの有無
            (制御なし, または XON/XOFF (<quote>イン・バンド</quote>
            または
            <quote>ソフトウェア</quote>フローコントロールとも呼ばれる))
            を選びます.
            以下に続くソフトウェアの設定のために,
            ここでの設定を覚えておいてください.</para>
        </sect4>
      </sect3>

    <sect3 id="printing-software">
      <title>ソフトウェアの設定</title>

      <para>本節では FreeBSD の LPD
	スプーリングシステムで印字をおこなうために
	必要となるソフトウェアの設定について説明しています.</para>

      <para>本節の概要は次のようになります.</para>

      <procedure>
	<step>
	  <para>プリンタで使用するポートのために, 必要があれば, カー
	    ネルの書き変えをおこないます. 「<link
	      linkend="printing-kernel">カーネルの変更</link>」で,
	    このためにしなくてはなら ないことを説明しています.</para>
	</step>

	<step>
	  <para>パラレルポートを使用している場合は, パラレルポートの
	    ための通信モードの設定します. 詳細は, 「<link
	      linkend="printing-parallel-port-mode">
	      パラレルポートの通信モードを設定する
	    </link>」で説明しています.</para>
	</step>

	<step>
	  <para>オペレーティングシステムからプリンタにデータが送ら
	    れているかをテストします. 「<link
	      linkend="printing-testing">
	      プリンタとの通信状況を調べる</link>」で, どのように
	    テストするかの提案をいくつかおこなっています.</para>
	</step>

	<step>
	  <para>ファイル<filename>/etc/printcap</filename>を変更し,
	    LPDの設定を おこないます. この節で, どのように変更するかを
	    説明しています.</para>
	</step>
      </procedure>

      <sect4 id="printing-kernel">
	<title>カーネルの変更</title>

	<para>オペレーティングシステムのカーネルの
	  コンパイルをおこなうこと によって,
	  指定されたのデバイスが機能するようになります. シリ アル,
	  または, パラレルインタフェースをプリンタで使用する場合,
	  必要なデバイスがこの指定の中に含まれていなくてはなりません.
	  したがって,
	  必要なデバイスがカーネルに組み込まれていない場合, 追
	  加のシリアル, または, パラレルポートをサポートするために,
	  カー ネルの再コンパイルが必要となるかもしれません.</para>

	<para>シリアルポートが現在使用しているカーネルで
	  サポートされている かどうかを調べるためには,
	  次のように入力します.</para>

	<screen>&prompt.root; <userinput>dmesg | grep sio<replaceable>N</replaceable></userinput></screen>

	<para>ここで, <replaceable>N</replaceable>
	  はシリアルポートの番号を示し, この番号は0から 始まります.
	  次のような出力があった場合, カーネルはそのポー
	  トをサポートしています.</para>

	<screen>sio2 at 0x3e8-0x3ef irq 5 on isa
sio2: type 16550A</screen>

	<para>パラレルポートが現在使用しているカーネルで
	  サポートされている かどうかを調べるためには,
	  次のように入力します.</para>

	<screen>&prompt.root; <userinput>dmesg | grep lpt<replaceable>N</replaceable></userinput></screen>

	<para>ここで, <emphasis remap=it>N</emphasis>
	  はパラレルポートの番号を示し, この番号は0から 始まります.
	  次のような出力があった場合, カーネルはそのポー
	  トをサポートしています.</para>

	<screen>lpt0 at 0x378-0x37f on isa</screen>

	<para>上記の出力が得られない場合, プリンタを使うため,
	  オペレーティ ングシステムにパラレル, または,
	  シリアルポートを認識し, 使用 できるようにするためには
	  カーネルを変更する必要があります.</para>

	<para>シリアルポートをサポートさせるには, 「<link
	    linkend="kernelconfig">
	    FreeBSDカーネルのコンフィグレーション</link>」の節をご覧く
	  ださい. パラレルポートをサポートさせる場合も, その節と,
	  <emphasis>あ わせて</emphasis>,
	  この節に続く節もご覧ください.</para>
	</sect4>
      </sect3>

	<sect3 id="printing-dev-ports">
	  <title>ポート用エントリを <filename>/dev</filename>
	    に追加する</title>

	  <para>カーネルがシリアル, または, パラレルポートを通じての通
	    信をサポートしていたとしても, システム上で動いているプログ
	    ラムがデータの送受信をおこなうための
	    ソフトウェアインタフェース がさらに必要になります.
	    そのインタフェースは,  <filename>/dev</filename>
	    ディレクトリにあるエントリに相当します.</para>

	  <para><emphasis><filename>/dev</filename>
	      エントリにポートを加えるために</emphasis></para>

	  <procedure>
	    <step>
	      <para>&man.su.1; コマンドで root になります. suコマンド
		でパスワードを聞かれたら, ルート用のパスワードを入力し
		ます.</para>
	    </step>

	    <step>
	      <para><filename>/dev</filename>
		ディレクトリに移動します. </para>

	      <screen>&prompt.root; cd /dev</screen>
	    </step>

	    <step>
	      <para>次のように入力します. </para>

	      <screen>&prompt.root; <userinput> ./MAKEDEV <replaceable>port</replaceable></userinput></screen>

	      <para>ここで, <replaceable>port</replaceable> は,
		作成するポート名です. 1番目 のパラレルポートのときは
		<literal>lpt0</literal> に, 2番目のときは
		<literal>lpt1</literal> になり, 以降同様になります.
		1番目のシリア ルポートのときは,
		<literal>ttyd0</literal> に, 2番目のときは
		<literal>ttyd1</literal> になり,
		これも以降同様となります.</para>
	    </step>

	    <step>
	      <para>次を入力し, デバイスのエントリができたか確認し
		ます. </para>

	      <screen>&prompt.root; <userinput>ls -l <replaceable>port</replaceable></userinput></screen>
	    </step>
	  </procedure>

	<sect4 id="printing-parallel-port-mode">
	  <title>パラレルポートの通信モードを設定する</title>

	  <para>パラレルインタフェースを使用している場合, FreeBSDでは,
	    割り込み駆動型にするか,
	    プリンタとの通信の状況をカーネルに監
	    視させるかのいずれかを選択できます.</para>

	  <itemizedlist>
	    <listitem>
	      <para>GENERIC
		カーネルでは<emphasis>割り込み駆動</emphasis>方式が,
		デフォルトになっています. この方式では,
		オペレーティングシ
		ステムはプリンタがデータを受け付けられるかどうかを調べ
		るために, IRQ ラインを一つ使用します.</para>
	    </listitem>

	    <listitem>
	      <para><emphasis>監視</emphasis>方式では,
		オペレーティングシステムにプ
		リンタがもっとデータを受け付けられるかどうかを繰り返し
		尋ねるように指示します. そして, 受け付けるという応答を
		受けたとき,
		カーネルはさらなるデータを送信します.</para>
	    </listitem>
	  </itemizedlist>

	  <para>割り込み駆動方式は, いくらか高速になりますが, 貴重な
	    IRQ ラインを一つ消費します.
	    うまく機能するものをお使いください.</para>

	  <para>通信モードを設定するためには2つの方法があります.
	    1つはカー
	    ネルを変更することで, もう一つは
	    &man.lptcontrol.8; プログラムを使用する方法です.</para>

	  <para><emphasis> カーネルを設定することによって,
	      通信モードを変更する. </emphasis></para>

	  <procedure>
	    <step>
	      <para>カーネルコンフィグレーションファイルを変更しま す.
		<literal>lpt0</literal>
		のエントリを探すか追加してください. 2番目
		のパラレルポートを設定するときは, 代わりに
		<literal>lpt1</literal> を使います. 以下,
		3番目のポートは <literal>lpt2</literal> となってい
		きます. </para>

	      <itemizedlist>
		<listitem>
		  <para>イベント駆動方式にする場合は,
		    <literal>irq</literal> 指 定を追加します. </para>

		  <programlisting>
device lpt0 at isa? port? tty irq <replaceable>N</replaceable> vector lptintr</programlisting>

		  <para>ここで, <replaceable>N</replaceable>
		    はパラレルポート用の IRQ 番号で す.</para>
		</listitem>

		<listitem>
		  <para>監視方式を使用する場合は,
		    <literal>irq</literal> を追加 してはいけません.
		  </para>

		  <programlisting>
device lpt0 at isa? port? tty vector lptintr</programlisting>
		</listitem>
	      </itemizedlist>
	    </step>

	    <step>
	      <para>ファイルをセーブし, config プログラムを起動 し,
		カーネルの構築, インストールをおこないます. そして, リ
		ブートしてください. 詳細は, 「<link
		  linkend="kernelconfig">
		  FreeBSDカーネルのコンフィグレーション</link>」を参照
		してください.</para>
	    </step>
	  </procedure>

	  <para>&man.lptcontrol.8; <emphasis>
	      で通信モードを設定する場合 </emphasis></para>

	  <procedure>
	    <step>
	      <para><literal>lpt<replaceable>N</replaceable></literal>
		をイベント駆動方式に設定する場合は,
		次のように入力します. </para>

	      <screen>&prompt.root; <userinput>lptcontrol -i -u <replaceable>N</replaceable></userinput></screen>
	    </step>

	    <step>
	      <para><literal>lpt<replaceable>N</replaceable></literal>
		を監視方式に設定する場合は, 次のように入力します.
	      </para>

	      <screen>&prompt.root; <userinput>lptcontrol -p -u <replaceable>N</replaceable></userinput></screen>
	    </step>
	  </procedure>

	  <para>これらのコマンドを <filename>/etc/rc.local</filename>
	    ファイルに追加
	    しておくと, システムをブートする度に通信モードを設定する
	    ことができます. 詳細については,
	    &man.lptcontrol.8; をご覧ください.</para>
	</sect4>

	<sect4 id="printing-testing">
	  <title>プリンタとの通信状況を調べる</title>

	  <para>スプーリングシステムの設定に進む前に, オペレーティング
	    システムがプリンタにデータを送ることに成功しているかどうか
	    を確かめるべきでしょう. これにより, 印字がうまくいかないと
	    き, プリンタとの通信が問題なのか, スプーリングシステムが問
	    題なのかを分けて調べることがかなり容易になります.</para>

	  <para>プリンタをテストするためには,
	    プリンタに何かのテキストを送
	    信してみます. 送信した文字をすぐに印字してくれるプリンタに
	    は, &man.lptest.1; コマンドを使うと有用です. このコマンドは印
	    字可能な96文字のASCII文字すべてを96行生成します.</para>

	  <para>PostScript (または他の言語に対応した) プリンタの場合
	    は, もっと巧妙なテストが必要になります. 次のような, 簡単な
	    PostScript プログラムを使えば十分でしょう. </para>

	  <programlisting>
%!PS
100 100 moveto 300 300 lineto stroke
310 310 moveto
/Helvetica findfont 12 scalefont setfont
(Is this thing working?) show
showpage</programlisting>

	  <note>
	    <para>このドキュメントでプリンタ用言語を参照するとき は,
	      PostScript のような言語を仮定しており, Hewlett Packard
	      の PCL は考慮していません. PCL は非常に機能的なの
	      ですが,
	      プレインテキストにエスケープシーケンスを混ぜること
	      ができます. PostScript ではプレインテキストを直接印字
	      することはできません.
	      このような種類のプリンタ言語に対して は,
	      特別な対応をおこなわなければなりません.</para>
	  </note>

	  <sect5 id="printing-checking-parallel">
	    <title>パラレルポートのプリンタとの接続を調べる</title>

	    <para>この節では, FreeBSDがパラレルポートに接続されたプリ
	      ンタと通信できているかどうかを調べる方法について説明し
	      ています.</para>

	    <para><emphasis>
		パラレルポートのプリンタをテストするために
	      </emphasis></para>

	    <procedure>
	      <step>
		<para>&man.su.1; コマンドで root になります.</para>
	      </step>

	      <step>
		<para>プリンタにデータを送ります. </para>

		<itemizedlist>
		  <listitem>
		    <para>プリンタがプレインテキストを印字できる場合,
		      &man.lptest.1; コマンドを使います.
		      次のように入力してください. </para>

		    <screen>&prompt.root; <userinput>lptest &gt; /dev/lpt<replaceable>N</replaceable></userinput></screen>

		    <para>ここで, <replaceable>N</replaceable>
		      はパラレルポートの番号で, 番号は
		      0から始まります.</para>
		  </listitem>

		  <listitem>
		    <para>プリンタが PostScript か他のプリンタ
		      言語を使用している場合, そのプリンタに簡単なプロ
		      グラムを送信してください. 次のように入力します.
		    </para>

		    <screen>&prompt.root; <userinput>cat &gt; /dev/lpt<replaceable>N</replaceable></userinput></screen>

		    <para>そして, 一行一行,
		      プログラムを<emphasis>慎重に</emphasis>入力して
		      下さい. RETUREN または ENTER キーを入力してしま
		      うと, その行は編集できなくなります. プログラムの
		      入力が終わったら, CONTROL+Dか, あなたが設定して
		      いるファイル終了のキーを押してください.</para>

		    <para>もしくは, プログラムを入力したファイルがある
		      場合は, 次のように入力してください. </para>

		    <screen>&prompt.root; <userinput>cat <replaceable>file</replaceable> &gt; /dev/lpt<replaceable>N</replaceable></userinput></screen>

		    <para>ここで, <replaceable>file</replaceable>
		      はプログラムが格納されていて,
		      プリンタに送信するファイルの名前です.</para>
		  </listitem>
		</itemizedlist>
	      </step>
	    </procedure>

	    <para>これで何かがプリントされることでしょう.
	      印字されたテキ
	      ストがおかしくても心配しなくても構いません. それについ
	      ては, 後で修正します.</para>
	  </sect5>

	  <sect5 id="printing-checking-serial">
	    <title>シリアルポートのプリンタとの接続を調べる</title>

	    <para>この節では, FreeBSDがシリアルポートに接続されたプリ
	      ンタと通信できているかどうかを調べる方法について述べられ
	      ています.</para>

	    <para><emphasis>
		シリアルポートのプリンタをテストするために
	      </emphasis></para>
	    <!-- kuriyama - remap=bf? -->
	    <!-- si006 - I removed the `remap=bf' -->

	    <procedure>
	      <step>
		<para>&man.su.1; コマンドで root になります.</para>
	      </step>

	      <step>
		<para><filename>/etc/remote</filename>
		  ファイルを編集します. 次の エントリを加えてください.
		</para>

		<programlisting>
printer:dv=/dev/<replaceable>port</replaceable>:br#<replaceable>bps-rate</replaceable>:pa=<replaceable>parity</replaceable></programlisting>

		<para>ここで, <replaceable>port</replaceable>
		  シリアルポート (<literal>ttyd0</literal>,
		  <literal>ttyd1</literal> など) のデバイスエントリで,
		  <replaceable>bps-rate</replaceable>は
		  プリンタとの通信の転送速度[bit/秒],
		  <replaceable>parity</replaceable>はプリ
		  ンタとの通信で必要とされるパリティ
		  (<literal>even</literal>, <literal>odd</literal>,
		  <literal>none</literal>,
		  <literal>zero</literal>のいずれか) を表わしていま
		  す.</para>

		<para>次の例は,
		  プリンタをシリアルケーブルでパリティなし, 転送速度
		  19200bpsで第3番目のシリアルポートに接続した場
		  合です.</para>

		<programlisting>
printer:dv=/dev/ttyd2:br#19200:pa=none</programlisting>
	      </step>

	      <step>
		<para>&man.tip.1; コマンドでプリンタと接続します. 次のよ
		  うに入力してください. </para>

		<screen>&prompt.root; <userinput>tip printer</userinput></screen>

		<para>これがうまくいかなかった場合は,
		  <filename>/etc/remote</filename>を 編集して,
		  <filename>
		    /dev/ttyd<replaceable>N</replaceable></filename>
		  の代わりに <filename>
		    /dev/cuaa<replaceable>N</replaceable></filename>
		  を試してみてください.</para>
	      </step>

	      <step>
		<para>プリンタにデータを送ります. </para>

		<itemizedlist>
		  <listitem>
		    <para>プリンタがプレインテキストを印字できる場合,
		      &man.lptest.1; コマンドを使います.
		      次のように入力してください. </para>

		    <screen><prompt>~</prompt><userinput>$lptest</userinput></screen>
		  </listitem>

		  <listitem>
		    <para>プリンタが PostScript か他のプリンタ
		      言語を使用している場合, そのプリンタに簡単なプロ
		      グラムを入力します. 一行一行,
		      プログラムを<emphasis>慎
			重に</emphasis>入力してください.
		      バックスペースキーや他の編 集用のキーは,
		      プリンタの制御コードに割り当てられ
		      ているかもしれません. プログラムが終了したことを
		      プリンタに伝えるための特別なファイル終了キーを入
		      力する必要があるかもしれません. PostScript
		      プリンタの場合, CONTROL+Dを入力します.</para>

		    <para>もしくは, プログラムを入力したファイルがある
		      場合は, 次のように入力してください.</para>

		    <screen><prompt>~</prompt><userinput>&gt;<replaceable>file</replaceable></userinput></screen>

		    <para>ここで, <replaceable>file</replaceable>
		      はプログラムが格納されている
		      ファイル名です.
		      &man.tip.1; コマンドでファイルを送
		      信した後は, ファイル終了を表わすキーを入力する必要
		      があります.</para>
		  </listitem>
		</itemizedlist>
	      </step>
	    </procedure>

	    <para>これで何かがプリントされることでしょう.
	      印字されたテキ
	      ストがおかしくても心配しなくても構いません. それについ
	      ては, 後で修正します.</para>
	  </sect5>
	</sect4>
      </sect3>

      <sect3 id="printing-printcap">
	<title>スプーラに許可を与える:
	  <filename>/etc/printcap</filename> ファイル</title>

	<para>ここまでで, プリンタはコンピュータに接続され, (必要なら)
	  プリンタと通信できるようにカーネルを変更し, 簡単なデータをプ
	  リンタに送信することができているはずです. これで, LPDにプリ
	  ンタへのアクセスを
	  制御させる設定をおこなう準備が整いました.</para>

	<para>LPDの設定は <filename>/etc/printcap</filename>
	  を編集することでおこないます.
	  LPDスプーリングシステムはスプーラが使われる毎にこのファイル
	  を参照します. そのため, ファイルを更新するとすぐにその変更が
	  反映されます.</para>

	<para>&man.printcap.5; ファイルの書式は簡単です.
	  <filename>/etc/printcap</filename>
	  の編集はお好みのテキストエディタをお
	  使いください. このファイルの書式は,
	  <filename>/usr/share/misc/termcap</filename> や
	  <filename>/etc/remote</filename>
	  といった他のケイパビリティファイルと一致しています.
	  この書式
	  のついての詳細な情報については
	  &man.cgetent.3; をご覧ください.</para>

	<para>スプーラの単純な設定法は,
	  次のステップでおこないます.</para>

	<procedure>
	  <step>
	    <para>プリンタに名前 (と簡単な別名2〜3個) を付け, それを
	      <filename>/etc/printcap</filename> ファイルに記述します.
	      これについ ては, 「<link linkend="printing-naming">
		プリンタに名前を付ける</link>」
	      を参照してください.</para>
	  </step>

	  <step>
	    <para><literal>sh</literal> の項目を追加することで,
	      ヘッダページの出 力を禁止します (デフォルトは許可).
	      これについては, 「<link
		linkend="printing-no-header-pages">
		ヘッダページの印字を禁止する</link>」
	      を参照してください.</para>
	  </step>

	  <step>
	    <para>スプール用のディレクトリを作成し, その位置を
	      <literal>sd</literal> 項目で指定します. これについては,
	      「<link linkend="printing-spooldir">
		スプーリングディレクトリの作成</link>」
	      を参照してください.</para>
	  </step>

	  <step>
	    <para>プリンタを使用するために <filename>/dev</filename>
	      エントリを 設定し, <filename>/etc/printcap</filename> の
	      <literal>lp</literal> 項目でそのエ ントリを指定します.
	      これについては, 「<link linkend="printing-device">
		プリンタデバイスの特定</link>」 を参照してください.
	      プリンタをシリアルポートに接続した場合は,
	      <literal>fs</literal>, <literal>fc</literal>,
	      <literal>xs</literal>, <literal>xc</literal>
	      の項目を設定する必要があります.  こちらについては,
	      「<link linkend="printing-commparam">
		スプーラのための通信パラメータの設定</link>」
	      を参照してください.</para>
	  </step>

	  <step>
	    <para>プレインテキスト用の入力フィルタのインストールを
	      おこないます. 「<link linkend="printing-textfilter">
		テキストフィルタのインストール</link>」
	      を参照してください.</para>
	  </step>

	  <step>
	    <para>&man.lpr.1; コマンドで何かを印字することで設定のテス
	      トをおこないます. <link linkend="printing-trying">
		印字してみよう</link> と
	      <link linkend="printing-troubleshooting">
		トラブルシューティング</link> を参照してください.</para>
	  </step>
	</procedure>

	<note>
	  <para>PostScript プリンタのような, プリンタ言語を
	    使用しているプリンタには, プレインテキストを直接印字させる
	    ことができません. 上にアウトラインを示し, 以下の節で説明す
	    る簡単な設定方法の説明では, そのようなプリンタを設置してい
	    る場合は, プリンタが認識できるファイルだけを印字の対象とし
	    ているという仮定をしています.</para>
	</note>

	<para>多くの場合,
	  利用者はシステムに設置されているプリンタすべてでプ
	  レインテキストが印字できることを期待しています. 印字作業を
	  おこなうためにLPDのインタフェースを利用するプログラムでも,
	  通 常, そのような仮定を置きます.
	  プリンタ言語を使用するプリン タを設置しており,
	  そのプリンタ言語で記述されたジョブと,
	  <emphasis>これに加えて</emphasis>,
	  プレインテキストのジョブも印字できるよ うにしたいならば,
	  上で示した簡単な設定方法に加えて, さら
	  なる設定をおこなうことを強くお勧めします. すなわち,
	  原始的なプ レインテキストから PostScript (もしくは,
	  他のプリンタ 言語)
	  に変換するプログラムをインストールしてください. 「<link
	    linkend="printing-advanced-if-conversion">
	    プレインテキストのジョブを PostScript
	    プリンタで印字する</link>」
	  で, そ れをどのようにおこなえばよいのかが
	  説明されています.</para>

	<note>
	  <para><emphasis>訳注:</emphasis>
	    日本語を印字したい場合は, プリンタ言語を使用し
	    ていない「日本語プリンタ」についても,
	    プリンタ固有のエスケー プシーケンスを送る必要があります.
	    また, 漢字コードをプリン
	    タが設定しているものに変換したりする必要があり, 各プリンタ
	    毎に, 日本語用のフィルタが必要になります.</para>
	</note>

	<sect4 id="printing-naming">
	  <title>プリンタに名前を付ける</title>

	  <para>最初の (簡単な) ステップで, プリンタの名前を考えます.
	    プ リンタには別名をいくつか付けることもできるので,
	    機能的な名前
	    でも風変わりな名前でもどちらを選んでもまったく
	    問題はありません.</para>

	  <para>少なくとも1つのプリンタには,
	    <filename>/etc/printcap</filename> の中 で,
	    <literal>lp</literal> という別名を持たせるべきでしょう.
	    この名前は デフォルトのプリンタ名になっています.
	    ユーザが環境変数 <envar>PRINTER</envar>  を設定しておらず,
	    かつ, LPDコマンドのコマンドラインでプリ
	    ンタの名前が指定されていない場合, <literal>lp</literal>
	    がデフォルトのプリ ンタ名となり,
	    そのプリンタに出力されます.</para>

	  <para>それから, これは共通の慣習ですが,
	    プリンタの最後の別名には,
	    メーカーやモデル名を含むプリンタの完全な名称をつけることに
	    なっています.</para>

	  <para>名前と別名のいくつかを決めたら,
	    <filename>/etc/printcap</filename> ファ イルに設定します.
	    プリンタ名は一番左のカラムから書き始めま す.
	    別名はそれぞれ縦棒によって区切られ, 最後の別名の後ろに
	    コロンを置きます.</para>

	  <para>次の例では, 2台のプリンタ (Diablo 630 ラインプリンタと
	    Panasonic KX-P4455 PostScript レーザライタプリンタ) が定義
	    されている <filename>/etc/printcap</filename>
	    のスケルトンを記しています.</para>

	  <programlisting>
#
#  /etc/printcap for host rose
#
rattan|line|diablo|lp|Diablo 630 Line Printer:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:</programlisting>

	  <para>この例では, 最初のプリンタに <literal>rattan</literal>
	    という名前と別名 として, <literal>line</literal>,
	    <literal>diablo</literal>, <literal>lp</literal> そして
	    <literal>Diablo 630 Line Printer</literal>
	    が付けられています. 別名とし て <literal>lp</literal>
	    があるので, このプリンタはデフォルトのプリンタとなっ
	    ています. 2番目は <literal>bamboo</literal> と名付けられ,
	    別名として,  <literal>ps</literal> と
	    <literal>PS</literal>, <literal>S</literal>,
	    <literal>panasonic</literal>,  <literal>Panasonic KX-P4455
	      PostScript v51.4</literal> が付けられていま す.</para>
	</sect4>

	<sect4 id="printing-no-header-pages">
	  <title>ヘッダページの印字を禁止する</title>

	  <para>LPDスプーリングシステムでは,
	    デフォルトでジョブ毎に<emphasis>ヘッ
	      ダページ</emphasis>を印字します.
	    ヘッダページにはジョブを要求したユー ザ名,
	    ジョブが送られたホスト名, そして, ジョブの名前が素晴
	    らしい大きな文字で印字されています. 残念なことに, この余分
	    なテキストすべてが,
	    簡単なプリンタ設定法のデバッグの際に紛れ
	    込んできてしまいます. このため, ヘッダページの出力を禁止し
	    ておきます.</para>

	  <para>ヘッダページの出力を禁止するには,
	    <filename>/etc/printcap</filename>
	    にあるプリンタのエントリに <literal>sh</literal>
	    の項目を追加します. 次 に, <literal>sh</literal> を加えた
	    <filename>/etc/printcap</filename> の例を示します.</para>

	  <programlisting>
#
#  /etc/printcap for host rose - no header pages anywhere
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:</programlisting>

	  <para>この書式を正しく使うための注意をしておきます.
	    最初の行は左 端のカラムから始まります. それに続く行は TAB
	    ひとつ分だけ 字下げします. 最後の行以外のすべての行は,
	    行末にバックスラッ シュを記述します.</para>
	</sect4>

	<sect4 id="printing-spooldir">
	  <title>スプーリングディレクトリの作成</title>

	  <para>スプーラの簡単な設定の次のステップでは,
	    <emphasis>スプーリン
	      グディレクトリ</emphasis>を作成します.
	    プリンタに送られるジョブ は,
	    その印字が終了するまでこのディレクトリに置かれます.  また,
	    他のたくさんのスプーラもこのディレクトリにファイ
	    ルを置きます.</para>

	  <para>様々な事情によりスプーリングディレクトリは, 通常, 慣例
	    として <filename>/var/spool</filename> の下に置きます.
	    また, スプーリングディレクトリの内容はバックアップをす
	    る必要はありません.
	    &man.mkdir.1; によってディレクトリを
	    作るだけでスプーリングディレクトリの復旧は完了します.
	  </para>

	  <para>スプーリングディレクトリの名前は, これも慣例ですが, 次
	    のようにプリンタの名前と同じにします.</para>

	  <screen>&prompt.root; <userinput>mkdir /var/spool/<replaceable>printer-name</replaceable></userinput></screen>

	  <para>しかしながら, ネットワーク上に使用可能なプリンタがたく
	    さんあるならば, LPDで印字するための専用のディレクトリに
	    スプーリングディレクトリを置きたいと思うかもしれません.
	    例に出てきたプリンタ <literal>rattan</literal> と
	    <literal>bamboo</literal> につい て, この方式を採用すると,
	    次のようになります.</para>

	  <screen>&prompt.root; <userinput>mkdir /var/spool/lpd</userinput>
&prompt.root; <userinput>mkdir /var/spool/lpd/rattan</userinput>
&prompt.root; <userinput>mkdir /var/spool/lpd/bamboo</userinput></screen>

	  <note>
	    <para>各ユーザが印字するジョブのプライバシを守りた
	      いと考えているならば, スプーリングディレクトリを保護し
	      て, これを誰からでもアクセスできないようにしたいと思う
	      かもしれません. スプーリングディレクトリは, deamon ユー
	      ザと daemon グループに所有され, 読み込み, 書き込み, 検
	      索可能であり, 他からはアクセスできないようにするべきで
	      す. 例題のプリンタに対して, 次のようにすることにしましょ
	      う.</para>

	    <screen>&prompt.root; <userinput>chown daemon.daemon /var/spool/lpd/rattan</userinput>
&prompt.root; <userinput>chown daemon.daemon /var/spool/lpd/bamboo</userinput>
&prompt.root; <userinput>chmod 770 /var/spool/lpd/rattan</userinput>
&prompt.root; <userinput>chmod 770 /var/spool/lpd/bamboo</userinput></screen>
	  </note>

	  <para>最後に, <filename>/etc/printcap</filename> ファイルで,
	    これらのディ レクトリの位置を LPD に伝える必要があります.
	    スプーリ ングディレクトリのパス名は <literal>sd</literal>
	    項目で指定します.</para>

	  <programlisting>
#
#  /etc/printcap for host rose - added spooling directories
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:</programlisting>

	  <para>プリンタ名が最初のカラムから始まっており, そのプリンタ
	    に関して記述される他のエントリは TAB で字下げされてい
	    ること, 各行がバックスラッシュで終わっていることに注意
	    してください.</para>

	  <para><literal>sd</literal>
	    によりスプーリングディレクトリが指定されていな い場合,
	    スプーリングシステムは <filename>/var/spool/lpd</filename>
	    デフォルト値として使用します.</para>
	</sect4>

	<sect4 id="printing-device">
	  <title>プリンタデバイスの特定</title>

	  <para>「<link
	      linkend="printing-dev-ports">ポート用エントリを /dev
	      に追加する</link>」では, FreeBSD でプリン
	    タとの通信に使用される <filename>/dev</filename>
	    ディレクトリ内の エントリを特定します. そして, LPD
	    にその情報を伝えま す. 印字するジョブを受け取ると,
	    スプーリングシステムは,
	    (プリンタにデータを渡す義務がある) フィルタプログラムに
	    代わって指定されたデバイスをオープンします.</para>

	  <para><filename>/etc/printcap</filename> ファイルで
	    <literal>lp</literal> 項目を使って
	    <filename>/dev</filename> エントリを記入します.</para>

	  <para>ここでの例では, <hostid>rattan</hostid>
	    は1番目のシリアルポートに,  <hostid>bamboo</hostid>
	    は6番目のシリアルポートに接続されているこ とにしましょう.
	    このとき, <filename>/etc/printcap</filename> には
	    次のようになります.</para>

	  <programlisting>
#
#  /etc/printcap for host rose - identified what devices to use
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:\
        :lp=/dev/ttyd5:</programlisting>

	  <para><filename>/etc/printcap</filename> でプリンタの
	    <literal>lp</literal> 項目が指定 されていない場合は, LPD
	    はデフォルトとして  <filename>/dev/lp</filename>
	    を使用します. <filename>/dev/lp</filename> は,  現在の
	    FreeBSD には存在していません.</para>

	  <para>設置したプリンタがパラレルポートに
	    接続されている場合は,
	    「<link linkend="printing-textfilter">
	      テキストフィルタのインストール</link>」
	    まで読み飛ばしてください.
	    そうでない場合は, 次節の説明に続いてください.</para>
	</sect4>

	<sect4 id="printing-commparam">
	  <title>スプーラのための通信パラメータの設定</title>

	  <para>シリアルポートにプリンタを接続した場合, プリンタにデー
	    タを送信するフィルタプログラムに代わり, 通信速度やパリ
	    ティ, その他のシリアル通信パラメータを設定することがで
	    きます. このことによる利点は,</para>

	  <itemizedlist>
	    <listitem>
	      <para><filename>/etc/printcap</filename>
		を編集するだけで, 様々な
		通信パラメータを試してみることができます. フィルタプロ
		グラムを再コンパイルする必要はありません.</para>
	    </listitem>

	    <listitem>
	      <para>スプーリングシステムで, シリアル通信の設定が異
		なっているかもしれない複数のプリンタに同じフィルタプロ
		グラムを使うことが可能になります.</para>
	    </listitem>
	  </itemizedlist>

	  <para>次の <filename>/etc/printcap</filename> の項目で,
	    <literal>lp</literal> で指定
	    されたデバイスのシリアル通信
	    パラメータを制御できます.</para>

	  <variablelist>
	    <varlistentry><term><literal>
		  br#<replaceable>bps-rate</replaceable></literal></term>
	      <listitem>
		<para>デバイスの通信速度を
		  <replaceable>bps-rate</replaceable> に設定します.
		  ここ で, <replaceable>bps-rate</replaceable> は 50,
		  75, 110, 134, 150, 200, 300, 600, 1200, 1800, 2400,
		  4800, 9600, 19200, 38400[bit/秒]
		  のいずれかです.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry><term><literal>
		  fc#<replaceable>clear-bits</replaceable></literal></term>
	      <listitem>
		<para>デバイスをオープンした後で,
		  <replaceable>sgttyb</replaceable> 構造体の
		  <replaceable>clear-bits</replaceable>
		  フラグビットをクリアします.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry><term><literal>
		  fs#<replaceable>set-bits</replaceable></literal></term>
	      <listitem>
		<para><replaceable>sgttyb</replaceable> 構造体の
		  <replaceable>clear-bits</replaceable>
		  フラグビットをセッ トします.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry><term><literal>
		  xc#<replaceable>clear-bits</replaceable></literal></term>
	      <listitem>
		<para>デバイスをオープンした後で, ローカルモードビット
		  <replaceable>clear-bits</replaceable>
		  をクリアします.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry><term><literal>
		  xs#<replaceable>set-bits</replaceable></literal></term>
	      <listitem>
		<para>ローカルモードビット
		  <replaceable>set-bits</replaceable>
		  をセットします.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>

	  <para><literal>fc</literal>, <literal>fs</literal>,
	    <literal>xc</literal>, そして <literal>xs</literal>
	    のビットに関 する詳しい情報については,
	    <filename>/usr/include/sys/ioctl_compat.h</filename>
	    を参照してく ださい.</para>

	  <para>項目 <literal>lp</literal> で指定されたデバイスを LPD
	    がオープンする とき, LPD は <literal>sgttyb</literal>
	    構造体のフラグビットを読み出 します. そして, 項目
	    <literal>fc</literal> の全ビットをクリアします.  次に,
	    項目 <literal>fs</literal> のビットをセットし,
	    その結果を設定 します.
	    ローカルモードビットに関しても同様におこなわれます.</para>

	  <para>例題のプリンタで6番目のシリアルポートに接続されたプリ
	    ンタの設定を追加してみましょう. 通信速度は38400bpsに設
	    定します. フラグビットとして, TANDEM, ANYP, LITOUT,
	    FLUSHO, PASS8 をセットします. ローカルモードビットでは,
	    LITOUT と PASS8 フラグをセットします.</para>

	  <programlisting>
bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:\
        :lp=/dev/ttyd5:fs#0x82000c1:xs#0x820:</programlisting>
	</sect4>

	<sect4 id="printing-textfilter">
	  <title>テキストフィルタのインストール</title>

	  <para>ここまでで,
	    プリンタにジョブを送るために使うテキストフィ ルタを LPD
	    に設定する準備が整いました. <emphasis>テキストフィ
	      ルタ</emphasis>とは,
	    <emphasis>入力フィルタ</emphasis>としても知られていますが,
	    印字するジョブがあるときに LPD が起動するプログラムで す.
	    LPD がプリンタのためにテキストフィルタを起動する とき, LPD
	    はフィルタの標準入力からプリントするジョブ を入力し,
	    フィルタの標準出力に項目 <literal>lp</literal> で指定され
	    たプリンタデバイスを接続します. フィルタは, 標準入力か
	    らジョブを読み込み, プリンタのための必要な変換をおこなった
	    後, その結果を標準出力に出力する, これにより印字がなさ
	    れることを期待されています. テキストフィルタについての
	    更に詳しい情報については, 「<link
	      linkend="printing-advanced-filters">
	      フィルタはどのように機能しているか</link>」
	    をご覧ください.</para>

	  <para>ここでの簡単なプリンタ設定では,
	    プリンタにジョブを送るため,  <command>/bin/cat</command>
	    を実行するだけの簡単なシェルスクリプ トで間に合います.
	    FreeBSD に標準で付属している  <command>lpf</command>
	    というフィルタでは, バックスペース文字を使っ
	    た下線引きの動作をおこなう文字ストリームをうまく扱うことが
	    できないプリンタのための代替処理をおこなってくれます.
	    もちろん,
	    他のどんなフィルタプログラムを使っても構いません.
	    フィルタ <filename>lpf</filename> については, 「<link
	      linkend="printing-advanced-lpf">テキストフィルタ
	      lpf</link>」で詳しく説明します.</para>

	  <para>最初に, 簡単なテキストフィルタであるシェルスクリプト
	    <filename>/usr/local/libexec/if-simple</filename>
	    を作ってみましょ う.
	    次のテキストをお好みのテキストエディタでファイルに
	    書き込んでください.</para>

	  <programlisting>
#!/bin/sh
#
# if-simple - Simple text input filter for lpd
# Installed in /usr/local/libexec/if-simple
#
# Simply copies stdin to stdout.  Ignores all filter arguments.

/bin/cat &amp;&amp; exit 0
exit 2</programlisting>

	  <para>そして, このファイルを実行可能にします. </para>

	  <screen>&prompt.root; <userinput>chmod 555 /usr/local/libexec/if-simple</userinput></screen>

	  <para>LPD
	    にこのテキストフィルタを使うことを設定するためには,
	    <filename>/etc/printcap</filename> に
	    <literal>if</literal> 項目を使って指定しま す. これまでの
	    <filename>/etc/printcap</filename> の例のプリンタ 2台に,
	    このフィルタを加えてみましょう. </para>

	  <programlisting>
#
#  /etc/printcap for host rose - added text filter
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:\
        :lp=/dev/ttyd5:fs#0x82000e1:xs#0x820:\
        :if=/usr/local/libexec/if-simple:</programlisting>
	</sect4>

	<sect4>
	  <title>LPD を起動します</title>

	  <para>&man.lpd.8; は <literal>lpd_enable</literal> 変数に従って
	    <filename>/etc/rc</filename> から実行されます.  この変数の
	    デフォルト値は <literal>NO</literal> です.  まだ
	    そうしていなかったならば</para>

	  <programlisting>lpd_enable="YES"</programlisting>

	  <para>の行を <filename>/etc/rc.conf</filename> に追加して
	    計算機を再起動するか, そのまま &man.lpd.8; を
	    起動してください.</para>

	  <screen>&prompt.root; <userinput>lpd</userinput></screen>
	</sect4>
	
	<sect4 id="printing-trying">
	  <title>印字してみよう</title>

	  <para>簡単な LPD 設定も終わりにたどり着きました. 残念ながら,
	    設定はこれでおしまいというわけではありません. なぜなら,
	    さらに, 設定をテストし, すべての問題点を解決しなくては
	    ならないからです. 設定をテストするために, 何かを印字し
	    てみましょう. LPD システムで印字をするためには,
	    &man.lpr.1; コマンドを使います. このコマンドは, 印字する
	    ためのジョブを投入する働きをします.</para>

	  <para>&man.lpr.1; コマンドを
	    「<link linkend="printing-testing">
	      プリンタとの通信状況を調べる</link>」で紹介した,
	    あるテスト用のテキストを生成してくれる
	    &man.lptest.1; プログラムと一緒に使うこともできます.</para>

	  <para><emphasis>簡単な LPD
	      設定をテストするために:</emphasis></para>

	  <para>次のように入力してください. </para>

	  <screen>&prompt.root; <userinput>lptest 20 5 | lpr -P<replaceable>printer-name</replaceable></userinput></screen>

	  <para>ここで, <replaceable>printer-name</replaceable>
	    は <filename>/etc/printcap</filename>
	    で指定したプリンタ名 (もしくはその別名) です. デフォルト
	    のプリンタを使用する場合は,
	    <option>-P</option> 引数を付けないで
	    &man.lpr.1; を打ち込んでください. もう一度述べますが, ポス
	    トスクリプトを期待しているプリンタをテストするならば,
	    &man.lptest.1; を使う代わりに PostScript で書かれたプ
	    ログラムをプリンタに送ってください. プログラムを送るた
	    めには, プログラムをファイルに格納して, <command>lpr
	      <replaceable>file</replaceable></command>
	    と打ち込みます.</para>

	  <para>PostScript プリンタの場合, 送信したプログラムによ
	    る結果が得られるでしょう.
	    &man.lptest.1; を使った場合は,
	    以下のような結果が見られるでしょう.</para>

	  <programlisting>
!"#$%&amp;'()*+,-./01234
"#$%&amp;'()*+,-./012345
#$%&amp;'()*+,-./0123456
$%&amp;'()*+,-./01234567
%&amp;'()*+,-./012345678</programlisting>

	  <para>更にプリンタをテストしたい場合は, (言語ベースのプリン
	    タのための) もっと大きなプログラムを送信するか, 引数を
	    変えて
	    &man.lptest.1; を実行します. 例えば, <command>lptest
	      80 60</command> で それぞれ80文字の行を60
	    行生成します.</para>

	  <para>プリンタがうまく動かなかった場合は, 次の節, 「<link
	      linkend="printing-troubleshooting">
	      トラブルシューティング</link>」をご覧ください.</para>
	</sect4>
      </sect3>
    </sect2>
  </sect1>

  <sect1 id="printing-advanced">
    <title>プリンタ設定上級編</title>

    <para>この節では, 特殊な形式のファイルを印字するためのフィルタ,
      ヘッダページ, ネットワーク越しのプリンタへの印字, そして,
      プリンタ 使用の制限や課金について説明しています.</para>

    <sect2 id="printing-advanced-filter-intro">
      <title>フィルタ</title>

      <para>LPD では, ネットワークプロトコル, キュー, アクセス制御, そ
	して, 印字のためのその他の側面について扱いますが,
	<emphasis>実際の</emphasis> 作業のほとんどは
	<emphasis>フィルタ</emphasis> によっておこなわれています.
	フィルタ は, プリンタと通信し,
	プリンタのデバイス依存性や特殊な要求を扱 うプログラムです.
	簡単なプリンタ設定では, プレインテキストのた
	めのフィルタをインストールしました. このプレインテキストフィル
	タは, ほとんどのプリンタで機能する極めて単純なものでした.
	(「<link linkend="printing-textfilter">
	  テキストフィルタのインストール</link>」を参照)</para>

      <para>しかしながら, 形式変換やプリンタ課金, 特定のプリンタの癖,
	など をうまく利用するためには,
	フィルタがどのように機能するかという
	ことを理解しておくべきです. これらの側面を扱うためには, 最終的
	には, フィルタの責任であるからです. そして, これは悪い情報です
	が, ほとんどの場合において,
	<emphasis>あなた自身</emphasis>がフィルタを供給す
	る必要があるということです. また都合のよいことには,
	たくさんのフィルタが 一般的に利用できるということです.
	もしフィルタがなかったとし ても, 普通は,
	フィルタを作るのは簡単です.</para>

      <para>FreeBSD にも, プレインテキストを印字させることができる
	<filename>/usr/libexec/lpr/lpf</filename>
	というフィルタが1つ付いています.
	(このフィルタはファイルに含まれるバックスペースやタブを扱いま
	す. また, 課金をすることもできますが, できることはこれだけしか
	ありません.) いくつかのフィルタとフィルタの構成要素は
        FreeBSD Ports Collection にもあります.</para>

      <para>この節で述べることは次の通りです.</para>

      <itemizedlist>
	<listitem>
	  <para>「<link linkend="printing-advanced-filters">
	      フィルタはどのように機能しているか</link>」では,
	    印字の過程におけ るフィルタの役割を概説します.
	    この節を読むことで, LPD  がフィルタを使うときに,
	    <quote>見えないところで</quote>何が起こっている
	    かが理解できるでしょう. このことを知っておくと, プリン
	    タそれぞれに様々なフィルタをインストールしたときに遭遇
	    するかもしれない問題を予期したり, デバッグするときに役
	    立つでしょう.</para>
	</listitem>

	<listitem>
	  <para>LPD では, すべてのプリンタからデフォルトでプレインテ
	    キストを印字できることを期待しています. このことは, プ
	    レインテキストを直接印字できない PostScript (また
	    は他の言語用の) プリンタでは問題を引き起こします. 「<link
	      linkend="printing-advanced-if-conversion">
	      プレインテキストのジョブを PostScript
	      プリンタで印字する</link>」 で,
	    この問題を克服する方法について述べます. PostScript
	    プリンタをお持ちの方は, この節をお読みになること
	    をお薦めします.</para>
	</listitem>

	<listitem>
	  <para>PostScript は様々なプログラムのための有名な出
	    力形式です. ある人たちは (著者自身を含めて) PostScript
	    のコードさえも直接書いてしまいます. しかし, PostScript
	    プリンタは高価です. 「<link
	      linkend="printing-advanced-ps">非 PostScript プリンタで
	      PostScript をシミュレートする</link>」では, PostScript
	    データを<emphasis>非 PostScript
	      プリンタ</emphasis>に受けつけさせ, 印字させるために,
	    どのようにしてプリンタ用のテキストフィルタをさらに変更
	    すればよいのか, ということについて述べます. PostScript
	    プリンタを持っていない方は, この節をお読みになる
	    ことをお薦めします.</para>
	</listitem>

	<listitem>
	  <para>「<link linkend="printing-advanced-convfilters">
	      変換フィルタ</link>」では, 図形や組版データといっ
	    た特定のファイル形式を, プリンタが理解できる形式へ変換
	    する作業を自動的におこなわせる方法について述べます. この節
	    を読むと, troff のデータを印字するには <command>lpr
	      -t</command>,  または, TeX DVI を印字するには
	    <command>lpr -d</command>, ラスタイ
	    メージデータを印字するには <command>lpr -v</command>,
	    などといったよ
	    うにユーザが入力することができるようにプリンタの設定を
	    おこなうことができます. この節もお読みになることをお薦めし
	    ます.</para>
	</listitem>

	<listitem>
	  <para>「<link
	      linkend="printing-advanced-of">出力フィルタ</link>」
	    では, あまり使われない LPD の機能のすべて,  すなわち,
	    出力フィルタに関することが記述されています.  ヘッダページ
	    (「<link linkend="printing-advanced-header-pages">
	      ヘッダページ</link>」参照) を印字させていない場合は,
	    多分, この節は飛ばしても構わないでしょう.</para>
	</listitem>

	<listitem>
	  <para>「<link
	      linkend="printing-advanced-lpf">テキストフィルタ
	      lpf</link>」では, <command>lpf</command>
	    についての説明が,  ほぼ完全におこなわれています. これは
	    FreeBSD に付属するラ インプリンタ (または,
	    ラインプリンタのように動作するレー ザプリンタ) のための,
	    単純なテキストフィルタです. プレ
	    インテキストを印字したことに対して課金をおこなう方法が至急
	    必要な場合, もしくは, バックスペース文字を印字しようと
	    すると煙を発するプリンタを持っている場合は, 絶対に
	    <command>lpf</command> を検討するべきです.</para>
	</listitem>
      </itemizedlist>

      <sect3 id="printing-advanced-filters">
	<title>フィルタはどのように機能しているか</title>

	<para>既に言及したように, フィルタとは, プリンタにデータを送る
	  際に, デバイスに依存した部分を取り扱うために LPD
	  によって起動 される実行プログラムです.</para>

	<para>LPD がジョブ中のファイルを印字しようとするとき, LPD
	  はフィル タプログラムを起動します. このとき,
	  フィルタの標準入力を印字す るファイルに,
	  標準出力をプリンタに, そして, 標準エラー出力をエ
	  ラーログファイル (<filename>/etc/printcap</filename> 内の
	  <literal>lf</literal> 項目で指 定されたファイル, または,
	  指定されていない場合は, デフォルトと して
	  <filename>/dev/console</filename>) にセットします.</para>

	<para>LPD が起動するフィルタと, その引数が何であるかは,
	  <filename>/etc/printcap</filename>
	  ファイルの内容と, ジョブの起動時に
	  ユーザが指定した
	  &man.lpr.1; コマンドの引数に依存しています. 例え
	  ば, ユーザが <command>lpr -t</command> と入力した場合は,
	  LPD は出力先のプリ
	  ンタ用の <literal>tf</literal> 項目で指定されている troff
	  用のフィルタを起動
	  させるでしょう.
	  ユーザがプレインテキストの印字を指示したときは,
	  <literal>if</literal> で指定されたフィルタが
	  起動されるでしょう (このことはほ
	  とんどの場合にあてはまります.
	  詳細については, 「<link linkend="printing-advanced-of">
	    出力フィルタ</link>」をご覧ください).</para>

	<para><filename>/etc/printcap</filename>
	  で指定可能なフィルタは次の3種類がありま す. </para>

	<itemizedlist>
	  <listitem>
	    <!-- kuriyama - shoule 'para'rize? -->
	    <!-- si006  - also origial document is 'para'rized now -->
	    <para><emphasis>テキストフィルタ</emphasis>
	      (LPD のドキュメントでは紛ら
	      わしいことに
	      <emphasis>入力フィルタ</emphasis>と呼んでいますが) は一般の
	      テキストの印字を扱います. これはデフォルトのフィルタと
	      考えてください. LPD では, すべてのプリンタに対して, デフォ
	      ルトでプレインテキストが印字できることを期待しています.
	      さらに, バックスペースやタブを正しく扱い, また, 他の特
	      殊な文字が入力されてもプリンタに混乱を来さないようにす
	      るのはテキストフィルタの仕事であると考えています.

	      プリンタの使用に対して課金をしなくてはならない環境にあ
	      るときは, テキストフィルタが印字したページ数を数える作
	      業もしなくてはなりません. この作業は, 通常, 印字した行
	      数を数え, これをプリンタが1ページ当たりに印字できる行
	      数と比較することでおこなわれます.

	      テキストフィルタは, 次のような引数を付けて起動されます.

	      <cmdsynopsis>
		<command>filter-name</command>
		<arg>-c</arg>
		<arg choice="plain">-w<replaceable>width</replaceable></arg>
		<arg choice="plain">-l<replaceable>length</replaceable></arg>
		<arg choice="plain">-i<replaceable>indent</replaceable></arg>
		<arg choice="plain">-n <replaceable>login</replaceable></arg>
		<arg choice="plain">-h <replaceable>host</replaceable></arg>
		<arg choice="plain"><replaceable>acct-file</replaceable></arg>
	      </cmdsynopsis>

	      ここで,

	      <variablelist>
		<varlistentry><term><option>-c</option></term>
		  <listitem>
		    <para><command>lpr -l</command>
		      によってジョブが入力されたときに与
		      えられます.</para>
		  </listitem>
		</varlistentry>

		<varlistentry><term><replaceable>width</replaceable></term>
		  <listitem>
		    <para><filename>/etc/printcap</filename>
		      で指定された <literal>pw</literal> (page width)
		      項目の値が与えられます. デフォル トは,
		      132です.</para>
		  </listitem>
		</varlistentry>

		<varlistentry><term><replaceable>length</replaceable></term>
		  <listitem>
		    <para><literal>pl</literal> (page length)
		      項目で指定された値が与え られます.
		      デフォルトは66です.</para>
		  </listitem>
		</varlistentry>

		<varlistentry><term><replaceable>indent</replaceable></term>
		  <listitem>
		    <para><command>lpr -i</command>
		      によって与えられた字下げの量で, デ
		      フォルトは0です.</para>
		  </listitem>
		</varlistentry>

		<varlistentry><term><replaceable>login</replaceable></term>
		  <listitem>
		    <para>ファイルを印字したユーザのアカウント名が
		      与えら れます.</para>
		  </listitem>
		</varlistentry>

		<varlistentry><term><replaceable>host</replaceable></term>
		  <listitem>
		    <para>ジョブが入力されたホスト名が
		      与えられます.</para>
		  </listitem>
		</varlistentry>

		<varlistentry><term><replaceable>acct-file</replaceable></term>
		  <listitem>
		    <para><literal>af</literal>
		      項目で指定されている課金データファイル
		      の名前が与えられます.</para>
		  </listitem>
		</varlistentry>
	      </variablelist>
	    </para>
	  </listitem>

	  <listitem>
	    <para><emphasis>変換フィルタ</emphasis>は,
	      特定のファイル形式をプリンタ
	      が紙に印字できるようなものに変換します. 例えば, プリン
	      タで ditroff 組版データを直接印字することはできません.
	      しかし, ditroff データをプリンタが消化し, 印字するこ
	      とができる形式へ変換するために, ditroff ファイル用フィ
	      ルタをインストールすることができます.
	      「<link linkend="printing-advanced-convfilters">
		変換フィルタ</link>」
	      で, これらに関するすべてについて説明します.
	      プリンタの課金をする必要がある場合は, 変換フィルタでも
	      印字ページを数える作業が必要となります.

	      変換フィルタは次の引数をとって起動されます.

	      <cmdsynopsis>
		<command>filter-name</command>
		<arg choice="plain">-x<replaceable>pixel-width</replaceable></arg>
		<arg choice="plain">-y<replaceable>pixel-height</replaceable></arg>
		<arg choice="plain">-n <replaceable>login</replaceable></arg>
		<arg choice="plain">-h <replaceable>host</replaceable></arg>
		<arg choice="plain"><replaceable>acct-file</replaceable></arg>
	      </cmdsynopsis>

	      ここで, <replaceable>pixel-width</replaceable> は,
	      <literal>px</literal> 項目で指定され
	      た値 (デフォルトは0),
	      <replaceable>pixel-height</replaceable> は,
	      <literal>py</literal> 項
	      目で指定された値 (デフォルトは0) です.</para>
	  </listitem>

	  <listitem>
	    <para><emphasis>出力フィルタ</emphasis>は,
	      テキストフィルタが指定されて
	      おらず, かつ, ヘッダページの出力が許可されている場合に
	      のみ使われます.
	      「<link linkend="printing-advanced-of">
		出力フィルタ</link>」で, これらのことについて説明し
	      ます. アウトプットフィルタに対する引数は次の2つだけです.

	      <cmdsynopsis>
		<command>filter-name</command>
		<arg choice="plain">-w<replaceable>width</replaceable></arg>
		<arg choice="plain">-l<replaceable>length</replaceable></arg>
	      </cmdsynopsis>

	      ここで, <option>-w</option> と <option>-l</option> は,
	      テキストフィルタの場合
	      と同じです.</para>
	  </listitem>
	</itemizedlist>

	<para>フィルタは, 次に示すの終了状態をもってプログラムを
	  <emphasis>exit</emphasis>  するべきです. </para>

	<variablelist>
	  <varlistentry><term>exit 0</term>
	    <listitem>
	      <para>フィルタがファイルを正常に印字した場合.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term>exit 1</term>
	    <listitem>
	      <para>フィルタはファイルの印字に失敗したが, LPD
		に再度ファ イルの印字を試みて欲しい場合.
		この終了状態で終了した場 合, LPD
		はフィルタを再スタートします.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term>exit 2</term>
	    <listitem>
	      <para>フィルタはファイルの印字に失敗し, かつ, LPD
		に再出力 を試みて欲しくない場合. この場合, LPD
		はそのファイル を放棄します.</para>
	    </listitem>
	  </varlistentry>
	</variablelist>

	<para>FreeBSD に付属するテキストフィルタ
	  <filename>/usr/libexec/lpr/lpf</filename> は, FORM FEED
	  文字が送られたと
	  きやプリンタ使用に対する課金をどのようにするかを
	  決定するために,  ページ幅やページ長の引数を利用します. また,
	  課金用のエントリを 作成するため, ログイン名, ホスト名,
	  課金ファイル名の引数を利用 します.</para>

	<para>もし, フィルタの購入を検討しているならば, LPD
	  と互換性がある かどうかを確認してください. もしそうならば,
	  上述の引数リストをサ ポートしていなければなりません.
	  一般向けの使用のためにフィルタ
	  を作成する計画をしている場合は,
	  同じ引数リストと終了コードをサ ポートしてください.</para>
      </sect3>

      <sect3 id="printing-advanced-if-conversion">
	<title>プレインテキストのジョブを PostScript プリン
	  タで印字する</title>

	<para>コンピュータと PostScript (または, 他の言語に対応し た)
	  プリンタをあなたしか使用しない場合は, プリンタにプレ
	  インテキストを絶対に送らない, そして,
	  プリンタにプレインテキス
	  トを送りたがっている様々なプログラムの機能を決して
	  使わないこと にしてください. そうすれば,
	  この節に書かれたことに心を煩わせる必
	  要はまったくなくなります.</para>

	<para>しかし, PostScript
	  とプレインテキストの両方のジョブをプリン
	  タへ送りたいと思っている場合は,
	  プリンタ設定についての要求が増 えるでしょう.
	  両者をプリンタへ送信するためには, 到着
	  したジョブがプレインテキストであるか PostScript であるかを
	  検出するテキストフィルタが必要です. PostScript のジョブは
	  すべて <literal>%!</literal>
	  で始まらなければならないことになっています
	  (他のプリンタ言語に関しては,
	  プリンタのドキュメントをご覧くだ さい).
	  ジョブの最初の2文字がこれならば, PostScript である
	  ことが分かります. したがって,
	  ジョブのそれ以降の部分をプリンタに直 接送ることができます
	  (訳注:PostScript では, <emphasis remap=tt>%</emphasis>
	  以降はコメントとして扱われるので, 最初の <emphasis
	    remap=tt>%!</emphasis> の行を 読み捨てても問題はない).
	  最初の2文字が <emphasis remap=tt>%!</emphasis> でない場
	  合は, フィルタはテキストを PostScript に変換し, その結果を
	  使って印字をおこないます.</para>

	<para>この作業をどうやってやればよいのでしょうか.</para>

	<para>シリアルポートにプリンタを接続した場合は,
	  <command>lprps</command> をインス
	  トールすることをお勧めします. <command>lprps</command> は
	  PostScript 用のフィルタで,
	  プリンタとの双方向通信をおこないます. このフィルタでは,
	  プリンタか らの冗長な情報を得ることで,
	  プリンタの状況を示すファイルが更新 されていきます.
	  したがって, ユーザや管理者は
	  (<errorname>トナー残量少</errorname>や
	  <errorname>紙詰まり</errorname>といった)
	  プリンタの状況を正確に知ることができます.  しかし,
	  もっと重要なことは, <command>psif</command>
	  と呼ばれるプログラムが 含まれているということです.
	  このプログラムは, 入力されたジョブ
	  がプレインテキストかどうかを検出し, これを PostScript に変
	  換するために, <command>textps</command>
	  (<command>lprps</command> に付属する別のプログラ ム)
	  を呼び出します. そして, このジョブをプリンタに送るために,
	  <command>lprps</command> が使われます.</para>

	<para><command>lprps</command> は FreeBSD Ports Collection
	  に含まれています (<link linkend="ports">Ports Collection</link>
          を参照してください).
	  もちろん,自分自身でプログラムを取ってきて, コンパイルし,
	  インストールす ることもできます. <command>lprps</command>
	  をインストールした後は,  <command>lprps</command>
	  の一部である <command>psif</command>
	  プログラムのパス名を指定する だけです. Ports Collection から
	  <command>lprps</command> をインストールしたときは,
	  <filename>/etc/printcap</filename> の中のシリアル接続した
	  PostScript プリンタのエントリに対して, 次を使ってください.
	</para>

	<programlisting>
:if=/usr/local/libexec/psif:</programlisting>

	<para>LPD
	  にプリンタをリード・ライトモードでオープンさせるために,
	  <literal>rw</literal> 項目も指定すべきです.</para>

	<para>パラレルポートに接続したプリンタの場合 (すなわち,
	  <command>lprps</command> が
	  必要としているプリンタとの双方向通信ができない),
	  テキストフィ
	  ルタとして次のシェルスクリプトを使うことができます. </para>

	<programlisting>
#!/bin/sh
#
#  psif - Print PostScript or plain text on a PostScript printer
#  Script version; NOT the version that comes with lprps
#  Installed in /usr/local/libexec/psif
#

read first_line
first_two_chars=`expr "$first_line" : '\(..\)'`

if [ "$first_two_chars" = "%!" ]; then
   #
   #  PostScript job, print it.
   #
   echo "$first_line" &amp;&amp; cat &amp;&amp; printf "\004" &amp;&amp; exit 0
   exit 2
else
   #
   #  Plain text, convert it, then print it.
   #
   ( echo "$first_line"; cat ) | /usr/local/bin/textps &amp;&amp; printf "\004" &amp;&amp; exit 0
   exit 2
fi</programlisting>

	<para>上記のスクリプトにおいて, <command>textps</command>
	  はプレインテキストから PostScript
	  へ変換するために別にインストールしたプログラム です.
	  テキストから PostScript へ変換するのには, お好みのどんなプロ
	  グラムでも使うことができます. FreeBSD Ports Collection
          (<link linkend="ports">Ports Collection</link>
	  を参照してください) には,  <literal>a2ps</literal>
	  と呼ばれるテキストから PostScript に変換するプログラムが
	  入っています.</para>

	<note>
	  <para><emphasis>訳注:</emphasis> 上記スクリプトでは,
	    先頭の行を読み込むために read  を使っていますが,
	    困ったことに, read は読み込んだ文字列の先頭
	    の空白文字を取り除いてしまいます. 従って,
	    これらの空白文字は印 字されないことになり,
	    印字結果がファイルのイメージと異なる場合 が出てきます.
	    この事情は csh を利用した場合でも変わりません. 仮に,
	    先頭の空白文字を除去しない read コマンドを作ったとしても,
	    「echo $first_line」の $first_line
	    変数の内容をシェルが展開す る際に $first_line
	    の先頭の空白文字が失われるため, 問題の解決 にはなりません.
	    残念ながら, 訳者はこの問題をシェルプログラムだ
	    けで解決する方法をしりません. perl か C
	    言語の力を借りないと解 決できないと思います.</para>
	</note>
      </sect3>

      <sect3 id="printing-advanced-ps">
	<title>非 PostScript プリンタで PostScript
	  をシミュレートする</title>

	<para>PostScript
	  は質の高い組版と印字をおこなうための<emphasis>事実
	    上の</emphasis>標準です. しかしながら, PostScript は,
	  <emphasis>高価な</emphasis>標 準です. ありがたいことに,
	  Alladin Enterprises から
	  <application>Ghostscript</application> と呼ばれる,
	  PostScript 互換の動作をするフリー
	  のプログラムが出されていて, FreeBSDで動きます. Ghostscript
	  はほとんどの PostScript ファイルを読むことができ, これらの
	  各ページをたくさんのブランドの非 PostScript プリンタを含む
	  様々なデバイス用に変換することができます. Ghostscript をイン
	  ストールし,
	  プリンタ用の特別なテキストフィルタを使うことによっ て, 非
	  PostScript プリンタをあたかも本物の PostScript
	  プリンタであるかのように動作させることができます.</para>

	<para>Ghostscript は FreeBSD Ports Collection に入っていますので,
	  そこからインストール することができます. また,
	  自分でソースプログラムを持ってきて, コンパイルし, インストー
	  ルすることもできます. この作業はとても簡単にできます.</para>

	<para>PostScript プリンタをシミュレートさせる場合は,
	  テキストフィ ルタに PostScript
	  ファイルを印字しようとしているかどうかを 検出させます.
	  PostScript ファイルでない場合は, フィルタは
	  そのファイルを直接プリンタに送ります
	  (訳注:テキストファイルを直 接印字できない場合は, もちろん,
	  変換フィルタを通す必要がありま す). PostScript の場合は,
	  まず, Ghostscript を使い, ファ
	  イルをそのプリンタが理解できる形式へ変換します.</para>

	<para>次の例のスクリプトは, Hewlett Packard DeskJet 500
	  プリンタ用 のテキストフィルタです.
	  他のプリンタで用いるときは,  <option>-sDEVICE</option>
	  引数を <command>gs</command> (Ghostscript)
	  コマンドに変えてくだ さい. (<command>gs -h</command>
	  と入力すると, 現在インストールされている  Ghostscript
	  でサポートされているデバイスのリストが得られます). </para>

	<programlisting>
#!/bin/sh
#
#  ifhp - Print Ghostscript-simulated PostScript on a DeskJet 500
#  Installed in /usr/local/libexec/hpif

#
#  Treat LF as CR+LF:
#
printf "\033&amp;k2G" || exit 2

#
#  Read first two characters of the file
#
read first_line
first_two_chars=`expr "$first_line" : '\(..\)'`

if [ "$first_two_chars" = "%!" ]; then
    #
    #  It is PostScript; use Ghostscript to scan-convert and print it.
    #
    #  Note that PostScript files are actually interpreted programs,
    #  and those programs are allowed to write to stdout, which will
    #  mess up the printed output.  So, we redirect stdout to stderr
    #  and then make descriptor 3 go to stdout, and have Ghostscript
    #  write its output there.  Exercise for the clever reader:
    #  capture the stderr output from Ghostscript and mail it back to
    #  the user originating the print job.
    #
    exec 3&gt;&amp;1 1&gt;&amp;2
    /usr/local/bin/gs -dSAFER -dNOPAUSE -q -sDEVICE=djet500 \
        -sOutputFile=/dev/fd/3 - &amp;&amp; exit 0

    #
    /usr/local/bin/gs -dSAFER -dNOPAUSE -q -sDEVICE=djet500 -sOutputFile=- - \
        &amp;&amp; exit 0

else
    #
    #  Plain text or HP/PCL, so just print it directly; print a form
    #  at the end to eject the last page.
    #
    echo $first_line &amp;&amp; cat &amp;&amp; printf "\033&amp;l0H" &amp;&amp; exit 0
fi

exit 2</programlisting>

	<para>最後に, <literal>if</literal> 項目を通して, LPD
	  にこのフィルタを教えてやる 必要があります. </para>

	<programlisting>
:if=/usr/local/libexec/hpif:</programlisting>

	<para>これでおしまいです. <command>lpr plain.text</command>
	  とか <filename>lpr whatever.ps</filename>
	  と入力してみましょう. どちらも正常に印字されるは
	  ずです.</para>

	<note>
	  <para><emphasis>訳注:</emphasis> 日本語を印字する場合は,
	    日本語対応の Ghostscript が必要で す. 日本語対応版の
	    Ghostscript も Ports Collection に入っています.</para>
	</note>
      </sect3>

      <sect3 id="printing-advanced-convfilters">
	<title>変換フィルタ</title>

	<para>「<link
	    linkend="printing-simple">プリンタ設定導入編</link>」
	  に書かれた簡単な設定が完了したら, 最初に, やってみたいと思
	  うことは, 多分(プレイン ASCII テキストに加えて)
	  好みのファイル形式
	  のための変換フィルタをインストールすることでしょう.</para>

	<sect4>
	  <title>なぜ, 変換フィルタをインストールするのか?</title>

	  <para>変換フィルタによって, 様々な種類のファイルを印字するこ
	    とが簡単になります. 例えば, TeX
	    組版システムでたくさんの仕事 をしたと仮定しましょう.
	    そして, PostScript プリンタが接続 されているとします.
	    すると, TeX で DVI ファイルを作成する度に,  DVI
	    ファイルを印字するために, これを PostScript ファイルに
	    変換する必要があります.
	    このコマンドは次のようになるでしょう. </para>

	  <screen>&prompt.user; <userinput>dvips seaweed-analysis.dvi</userinput>
&prompt.user; <userinput>lpr seaweed-analysis.ps</userinput></screen>

	  <para>DVI ファイル用の変換フィルタがインストールしてあると,
	    LPD に 変換を肩代わりさせることで毎回毎回
	    おこなわなければならなかった面倒
	    な変換作業を省くことができます. つまり, DVI を生成したら,
	    次のような1回のコマンド入力だけで, これが印字されます.
	  </para>

	  <screen>&prompt.user; <userinput>lpr -d seaweed-analysis.dvi</userinput></screen>

	  <para>LPD に DVI ファイルの変換をさせるためには,
	    <option>-d</option> オプション を指定します.
	    変換オプションのリストは「<link
	      linkend="printing-lpr-options-format">
	      整形と変換に関するオプション</link>」
	    に載せてあります.</para>

	  <para>変化のオプションのそれぞれをプリンタに
	    サポートさせるためには,
	    <emphasis>変換フィルタ</emphasis>をインストールし,
	    そのパス名を  <filename>/etc/printcap</filename>
	    の中で指定しなくてはなりません. 変換フィ ルタは,
	    プレインテキストを印字する代わりに, フィルタはファイル
	    をプリンタが理解できる形式に変換するところを除けば,
	    「プリンタ の簡単な設定」で説明したテキストファイル
	    (「<link linkend="printing-textfilter">
	      テキストフィルタのインストール</link>」 を見て下さい)
	    に似ています.</para>
	</sect4>

	<sect4>
	  <title>どの変換フィルタをインストールすべきか?</title>

	  <para>使いたいと思う変換フィルタをインストールすべきです.
	    DVI のデータを頻繁に印字するならば, DVI 変換フィルタ
	    をインストールするのが適切でしょう. 印字しなくてはなら
	    ない troff を大量に抱えている場合は, 多分, troff フィ
	    ルタが欲しくなるはずです.</para>

	  <para>次の表は, LPD で動作するフィルタと,
	    <filename>/etc/printcap</filename>
	    ファイルでのエントリする項目,  そして,
	    <command>lpr</command>
	    コマンドで呼び出す方法をまとめたもの です. </para>

	  <informaltable frame="none">
	    <tgroup cols="3">
	      <thead>
		<row>
		  <entry>ファイル形式</entry>
		  <entry><filename>/etc/printcap</filename>項目</entry>
		  <entry><command>lpr</command> オプション</entry>
		</row>
	      </thead>

	      <tbody>
		<row>
		  <entry>cifplot</entry>
		  <entry><literal>cf</literal></entry>
		  <entry><option>-c</option></entry>
		</row>
		<row>
		  <entry>DVI</entry>
		  <entry><literal>df</literal></entry>
		  <entry><option>-d</option></entry>
		</row>
		<row>
		  <entry>plot</entry>
		  <entry><literal>gf</literal></entry>
		  <entry><option>-g</option></entry>
		</row>
		<row>
		  <entry>ditroff</entry>
		  <entry><literal>nf</literal></entry>
		  <entry><option>-n</option></entry>
		</row>
		<row>
		  <entry>FORTRAN text</entry>
		  <entry><literal>rf</literal></entry>
		  <entry><option>-f</option></entry>
		</row>
		<row>
		  <entry>troff</entry>
		  <entry><literal>tf</literal></entry>
		  <entry><option>-t</option></entry>
		</row>
		<row>
		  <entry>raster</entry>
		  <entry><literal>vf</literal></entry>
		  <entry><option>-v</option></entry>
		</row>
		<row>
		  <entry>プレインテキスト</entry>
		  <entry><literal>if</literal></entry>
		  <entry>なし, <option>-p</option>, または
		    <option>-l</option></entry>
		</row>
	      </tbody>
	    </tgroup>
	  </informaltable>

	  <para>先の例のように, <command>lpr -d</command>
	    を使うためには, 出力先の プリンタの
	    <filename>/etc/printcap</filename> 内のエントリで,
	    <literal>df</literal>
	    項目が必要であることが分かります.</para>

	  <para>反論はあるかも知れませんが, FORTRAN テキストや plot
	    のような形式は, 多分, 廃れ てていくでしょう.
	    あなたのサイトで, 自前のフィルタをイ ンストールするだけで,
	    プリントオプションのいくつか, あ るいは,
	    全部に新しい意味を与えることができます. 例えば,
	    Prinerleaf ファイル (Interleaf デスクトップパブリッシン
	    グプログラムによるファイル) を直接印字したいとします.
	    そして, Printerleaf 用の変換フィルタを
	    <literal>gf</literal> 項目で
	    指定したパスにインストールすれば, <command>lpr
	      -g</command> の意味 は<quote>Printerleaf
	    ファイルを印字する</quote>意味だとユーザに教
	    えることができます.</para>
	</sect4>

	<sect4>
	  <title>変換フィルタのインストール</title>

	  <para>変換フィルタは FreeBSD
	    の基本システムのインストールとは別
	    にインストールするプログラムなので, 変換フィルタは, 多 分,
	    <filename>/usr/local</filename> ディレクトリの下に置くべ
	    きです. フィルタは LPD だけが実行する特別なプログラム,
	    すなわち, 一般ユーザが実行する必要すらない
	    プログラムなので, <filename>/usr/local/libexec</filename>
	    ディレ クトリに置くのが普通です.</para>

	  <para>変換フィルタを使用可能にするためには,
	    <filename>/etc/printcap</filename>
	    の目的のプリンタの適切な項目に
	    フィルタがあるパス名を指定します.</para>

	  <para>DVI 変換フィルタをプリンタ <literal>bamboo</literal>
	    のエントリに加 えてみましょう. プリンタ
	    <literal>bamboo</literal> の <literal>df</literal> 項目を
	    新たに加えた<filename>/etc/printcap</filename>
	    ファイルの例を以下 に再掲します. </para>

	  <programlisting>
#
#  /etc/printcap for host rose - added df filter for bamboo
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:\
        :lp=/dev/ttyd5:fs#0x82000e1:xs#0x820:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</programlisting>

	  <para>DVI フィルタは
	    <filename>/usr/local/libexec/psdf</filename> という
	    名前のシェルスクリプトです. このスクリプトは次のように
	    なっています. </para>

	  <programlisting>
#!bin/sh
#
#  psdf - DVI to PostScript printer filter
#  Installed in /usr/local/libexec/psdf
#
#  Invoked by lpd when user runs lpr -d
#
exec /usr/local/bin/dvips -f | /usr/local/libexec/lprps "$@"</programlisting>

	  <para>このスクリプトでは, <command>dvips</command>
	    をフィルタモード (引数  <option>-f</option>) で,
	    標準入力上で起動しています. 標準入力は印字 するジョブです.
	    それから, PostScript プリンタ用フィ ルタ
	    <command>lprps</command> (これについては「<link
	      linkend="printing-advanced-if-conversion">
	      プレインテキストのジョブを PostScript
	      プリンタで印字する</link>」 を参照してください) を LPD
	    に与えられた引数を付けて起動 します.
	    <command>lprps</command>
	    はこれらの引数を印字されたページ分
	    の課金をおこなうために使われます.</para>
	</sect4>

	<sect4>
	  <title>変換フィルタのその他の例</title>

	  <para>変換フィルタのインストールには決まったステップがないの
	    で, その代わりに, 例をもっと挙げることにします. これを,
	    自分でフィルタを作る際のガイドにしてください. 適当な例が
	    あったら, それをそのまま使ってください.</para>

	  <para>次のスクリプト例は, Hewlett Packard LaserJet III-Si の
	    ための, raster (ええと・・実は, GIF ファイル) 用の変
	    換フィルタです. </para>

	  <programlisting>
#!/bin/sh
#
#  hpvf - Convert GIF files into HP/PCL, then print
#  Installed in /usr/local/libexec/hpvf

PATH=/usr/X11R6/bin:$PATH; export PATH

giftopnm | ppmtopgm | pgmtopbm | pbmtolj -resolution 300 \
    &amp;&amp; exit 0 \
    || exit 2</programlisting>

	  <para>ここでは, GIF ファイルから PNM (portable anymap) 形式
	    に変換し, 次に PGM (portable graymap) 形式に変換してか ら,
	    LaserJet/PCL-互換データに変換しています.</para>

	  <para>上記のフィルタを使うプリンタのためのエントリを付け加え
	    た <filename>/etc/printcap</filename>
	    ファイルは次のようになります. </para>

	  <programlisting>
#
#  /etc/printcap for host orchid
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sh:sd=/var/spool/lpd/teak:mx#0:\
        :if=/usr/local/libexec/hpif:\
        :vf=/usr/local/libexec/hpvf:</programlisting>

	  <para>次のスクリプトは, PostScript プリンタ
	    <literal>bamboo</literal>  のための groff 組版システムの
	    troff データのための変換 フィルタです. </para>

	  <programlisting>
#!/bin/sh
#
#  pstf - Convert groff's troff data into PS, then print.
#  Installed in /usr/local/libexec/pstf
#
exec grops | /usr/local/libexec/lprps "$@"</programlisting>

	  <para>上記のスクリプトではプリンタとの通信をおこなうため,
	    <command>lprps</command> をまた利用しています.
	    プリンタがパラレルポー トに接続されている場合は, 代わりに,
	    次のスクリプトを使 うかもしれません. </para>

	  <programlisting>
#!/bin/sh
#
#  pstf - Convert groff's troff data into PS, then print.
#  Installed in /usr/local/libexec/pstf
#
exec grops</programlisting>

	  <para>これで完成しました. 次に, フィルタを使用可能にするため
	    に <filename>/etc/printcap</filename>
	    に加える必要があるエントリを 示します. </para>

	  <programlisting>
:tf=/usr/local/libexec/pstf:</programlisting>

	  <para>次の例をみたら, FORTRAN のベテランは赤面するかもしれ
	    ません. この FORTRAN テキストフィルタは, プレインテキ
	    ストを直接印字できるすべてのプリンタで利用できます. この
	    フィルタをプリンタ <literal>teak</literal>
	    にインストールすることに しましょう. </para>

	  <programlisting>
#!/bin/sh
#
# hprf - FORTRAN text filter for LaserJet 3si:
# Installed in /usr/local/libexec/hprf
#

printf "\033&amp;k2G" &amp;&amp; fpr &amp;&amp; printf "\033&amp;l0H" &amp;&amp; exit 0
exit 2</programlisting>

	  <para>そして, このフィルタを使用可能にするため, 以下の行を
	    <filename>/etc/printcap</filename> のプリンタ
	    <literal>teak</literal> のエントリ に加えます. </para>

	  <programlisting>
:rf=/usr/local/libexec/hprf:</programlisting>

	  <para>これが最後の, そして, 若干複雑な例です. 前に紹介した
	    LaserJet プリンタ <literal>teak</literal> に, DVI
	    フィルタを加える ことにしましょう. 最初に,
	    簡単な部分をおこないます. すなわ ち, DVI フィルタの位置を
	    <filename>/etc/printcap</filename> に書 き加えます.
	  </para>

	  <programlisting>
:df=/usr/local/libexec/hpdf:</programlisting>

	  <para>さて, 難しい部分であるフィルタの作成をおこないます.
	    このた めに, DVI から LaserJet/PCL
	    への変換プログラムが必要 です. FreeBSD の Ports Collection
            (<link linkend="ports">Ports Collection</link>
	    を参照してください) には, それがあ ります.
	    <command>dvi2xx</command> というのがそのパッケージの名前で
	    す. これをインストールすると, 必要なプログラム
	    <command>dvilj2p</command> が使えます. このプログラムは
	    DVI を  LaserJet IIp, LaserJet III, そして LaserJet 2000
	    の互 換コードへ変換してくれます.</para>

	  <para><command>dvilj2p</command> はフィルタ
	    <command>hpdf</command> を極めて複雑にしてい ます.
	    なぜなら, <command>dvilj2p</command>
	    は標準入力からデータを読 み込むことができないからです.
	    このプログラムを働かせる ためには, ファイル名が必要です.
	    もっと悪いことに, ファ イル名は <filename>.dvi</filename>
	    で終わっている必要があり, 標準入力 の代わりに,
	    <filename>/dev/fd/0</filename> を使うのは問題がありま す.
	    この問題は, (<filename>.dvi</filename> で終わる)
	    一時的なファイル名 から<filename>/dev/fd/0</filename> に
	    (シンボリックな) リンクを張る
	    ことで回避することができます. これで,
	    <command>dvilj2p</command> に 強制的に標準入力からデータを
	    読み込ませることができます.</para>

	  <para>もう1つの問題は, 一時的なリンクを張るために
	    <filename>/tmp</filename> ディ
	    レクトリを使うことができないという事実です. シンボリッ
	    クリンクはユーザ, グループが <username>bin</username>
	    であるユーザに所 有されています. フィルタはユーザ
	    <username>daemon</username> として起 動します. そして,
	    <filename>/tmp</filename> ディレクトリはスティッ
	    キービットが立っています. フィルタはリンクを作ることが
	    できます. しかし, リンクは別のユーザに所有されているた め,
	    作業が終了したとき, このリンクを削除することができ
	    ません.</para>

	  <para>その代わりに, シンボリックリンクは現在の作業ディレクト
	    リ, すなわち, スプーリングディレクトリ
	    (<filename>/etc/printcap</filename> の
	    <literal>sd</literal> 項目で指定する) に作 ることにします.
	    フィルタが作業するにはここの場所は完璧 な場所で, なぜなら,
	    特に, スプーリングディレクトリのディ スクの空き容量は
	    (ときどき) <filename>/tmp</filename> ディレクトリ
	    よりもたくさんあるからです.</para>

	  <para>以下に示すのが最後のフィルタです. </para>

	  <programlisting>
#!/bin/sh
#
#  hpdf - Print DVI data on HP/PCL printer
#  Installed in /usr/local/libexec/hpdf

PATH=/usr/local/bin:$PATH; export PATH

#
#  Define a function to clean up our temporary files.  These exist
#  in the current directory, which will be the spooling directory
#  for the printer.
#
cleanup() {
   rm -f hpdf$$.dvi
}

#
#  Define a function to handle fatal errors: print the given message
#  and exit 2.  Exiting with 2 tells LPD to do not try to reprint the
#  job.
#
fatal() {
    echo "$@" 1&gt;&amp;2
    cleanup
    exit 2
}

#
#  If user removes the job, LPD will send SIGINT, so trap SIGINT
#  (and a few other signals) to clean up after ourselves.
#
trap cleanup 1 2 15

#
#  Make sure we are not colliding with any existing files.
#
cleanup

#
#  Link the DVI input file to standard input (the file to print).
#
ln -s /dev/fd/0 hpdf$$.dvi || fatal "Cannot symlink /dev/fd/0"

#
#  Make LF = CR+LF
#
printf "\033&amp;k2G" || fatal "Cannot initialize printer"

#
#  Convert and print.  Return value from dvilj2p does not seem to be
#  reliable, so we ignore it.

#
dvilj2p -M1 -q -e- dfhp$$.dvi

#
#  Clean up and exit
#
cleanup
exit 0</programlisting>
	</sect4>

	<sect4 id="printing-advanced-autoconv">
	  <title>自動変換: その他の変換フィルタ</title>

	  <para>ここまでに述べてきたフィルタによって, 印字環境の能率が
	    上がったことと思います. しかし, これはどのフィルタを使
	    うかを ( &man.lpr.1; のコマンドライン上で) ユーザが指定しな
	    くてはならないという代価を支払って実現されています. コ
	    ンピュータの事情にあまり詳しくないユーザにとって, フィ
	    ルタのオプションを指定させられるということはいらいらさ
	    せられるものになるでしょう. 更に悪いことに, 間違ったフィ
	    ルタオプションを指定されると, 間違った形式のファイルが
	    そのフィルタに適用されることになり, その結果, 何百枚も
	    の紙を掃き出すことになるかもしれません.</para>

	  <para>そのような結果になるならば, 変換フィルタをインストール
	    するよりもむしろ, テキストフィルタ (これがデフォルトフィ
	    ルタなので) に印字するよう要求されたファイルの形式を検
	    出させ, 自動的に, 適切な変換フィルタを起動するようにし
	    たいと思うかもしれません. ここでは <command>file</command>
	    コマンド のようなツールを役立たせることができます.
	    もちろん, <emphasis>いくつかの</emphasis>
	    ファイル形式の違いを見分けることは難しい ことでしょう.
	    そして, もちろん, それらのファイルに対し ては,
	    変換フィルタを提供するだけで済ますこともできるの
	    です.</para>

	  <para>FreeBSD Ports Collection には, <command>apsfilter</command>
	    と呼ばれる自 動変換をおこなうテキストフィルタがあります.
	    このフィルタは プレインテキスト, PostScript, DVI
	    ファイルを検 出し, 適当な変換をおこなった後,
	    データを印字することができ ます.</para>
	</sect4>
      </sect3>

      <sect3 id="printing-advanced-of">
	<title>出力フィルタ</title>

	<para>LPD スプーリングシステムでは,
	  ここまでにまだ取り上げていな いフィルタ形式,
	  出力フィルタをサポートしています. 出力 フィルタは,
	  テキストフィルタのように, プレインテキスト
	  のみを印字するために意図されたものですが, 非常に簡単化
	  されています. テキストフィルタを用いずに, 出力フィルタ
	  を使っている場合は, 次のようになります. </para>

	<itemizedlist>
	  <listitem>
	    <para>LPD はジョブ中の各ファイルに一度ではなく, ジョブ
	      全体に対して一度だけ出力フィルタを起動します.</para>
	  </listitem>

	  <listitem>
	    <para>LPD は出力フィルタに対し, ジョブ中のファイルの先
	      頭や末尾を特定するための対策を一切
	      おこなっていません.</para>
	  </listitem>

	  <listitem>
	    <para>LPD はユーザのログイン名やホスト名をフィルタに渡
	      しません. したがって, 課金の処理をおこなうことは考えてい
	      ません. 実際, 出力フィルタには, 以下2つの引数しか与え
	      られません. </para>

	    <cmdsynopsis>
	      <command>filter-name</command>
	      <arg choice="plain">-w<replaceable>width</replaceable></arg>
	      <arg choice="plain">-l<replaceable>length</replaceable></arg>
	    </cmdsynopsis>

	    <para>ここで, <replaceable>width</replaceable>
	      は対象となるプリンタの <literal>pw</literal> 項 目,
	      <replaceable>length</replaceable> は
	      <literal>pl</literal> 項目に指定された数です.</para>
	  </listitem>
	</itemizedlist>

	<para>出力フィルタの簡便さに誘惑されてはいけません. もし, ジョ
	  ブ中のそれぞれのファイルに別のページ番号を付加しようと
	  しても,
	  出力フィルタは<emphasis>うまく動作しないでしょう</emphasis>.
	  そのような動作を期待しているならば, (入力フィルタとし
	  ても知られている) テキストフィルタを使ってください. 詳
	  しくは, 「<link linkend="printing-textfilter">
	    テキストフィルタのインストール</link>」をご覧ください.
	  さらに, 出力 フィルタは, 実のところ,
	  <emphasis>もっと複雑</emphasis>になっています.  まず,
	  特殊なフラグ文字を検出するために, フィルタに送ら
	  れてくるバイトストリームを検査する必要があります. また,  LPD
	  に代わって, 自分自身にシグナルを送らなければなりま
	  せん.</para>

	<para>しかしながら, ヘッダページの印字をおこないたい場合,
	  また,
	  エスケープシーケンスやヘッダページを印字できるようにす
	  るその他の初期化文字列を送信する必要がある場合, 出力ファ
	  イルが<emphasis>必要</emphasis>です.</para>

	<para>1台のプリンタに対し, LPD では出力フィルタとテキスト,
	  または, 他のフィルタを両方使うことができます. このよう
	  な場合, LPD はヘッダページ (「<link
	    linkend="printing-advanced-header-pages">
	    ヘッダページ</link>」 を参照してください)
	  だけを印字させるために, 出 力フィルタを起動させます.
	  それから LPD では, アウトプッ トフィルタに2バイトの文字
	  (ASCII 031 の次に ASCII 001) を送ることで,
	  出力フィルタが<emphasis>自力で停止する</emphasis>ことを
	  期待しています. 2バイト (031, 001) が出力フィルタに送られ
	  たとき, 出力フィルタは自分自身にシグナル SIGSTOP を送
	  ることによって停止するべきです. LPD がその他のフィル
	  タの起動を完了したとき, LPD は出力フィルタにシグナル
	  SIGCONT を送ることで, 出力フィルタを再起動させます.</para>

	<para>出力フィルタがあり,
	  テキストフィルタが<emphasis>ない</emphasis>場合,  LPD
	  はプレインテキストのジョブをおこなう際に, 出力フィル
	  タを使います. 前述したように, 出力フィルタでは, ジョブ
	  中の各ファイルの並びの間に FROM FEED 文字や紙を排出す
	  る他の文字を入れることはしません. この動作は多分, あな
	  たが求めているものとは
	  <emphasis>異なっている</emphasis>でしょう. ほと
	  んどすべての場合において, テキストフィルタが必要とされる
	  はずです.</para>

	<para>プログラム <command>lpf</command> は,
	  テキストフィルタの項で既に紹介 しましたが,
	  出力フィルタとしても動作させることができま す. もし,
	  簡便で極悪な出力フィルタが必要で, かつ, バイ
	  トストリームを検査したりシグナルを送るコードを書きたく
	  ないときには, <command>lpf</command> をお試しください.
	  あるいは, プ リントが要求する初期化コードを送るために,
	  <command>lpf</command> を
	  シェルスクリプトに包んで使うこともできます.</para>
      </sect3>

      <sect3 id="printing-advanced-lpf">
	<title>テキストフィルタ <command>lpf</command></title>

	<para>プログラム <filename>/usr/libexec/lpr/lpf</filename> は,
	  FreeBSD の バイナリ配布に付属しているテキストフィルタ
	  (入力フィル タ) で, 出力を字下げしたり (<command>lpr
	    -i</command> でジョブが入力さ れたとき),
	  文字を未処理のままプリンタに送ったり (<command>lpr
	    -l</command> でジョブが入力されたとき), ジョブ中のバッ
	  クスペースやタブの印字位置を調節したり, 印字したページ
	  に対して課金したりすることができます. また, このフィル
	  タは出力フィルタとしても動作させることができます.</para>

	<para><command>lpf</command>
	  は多くの印字環境において使用することに適して います.
	  このフィルタには, プリンタに初期化文字列を送る
	  機能はありませんが, 必要とされる初期化をおこない, それから
	  <command>lpf</command>
	  を実行させるためのシェルスクリプトを作成する
	  のはたやすいことです.</para>

	<para><command>lpf</command> に対して,
	  印字ページへの課金を正確におこなわせる ためには,
	  <filename>/etc/printcap</filename> ファイルの中の
	  <literal>pw</literal> と <literal>pl</literal>
	  の項目に正確な値を入れておく必要が あります. これらの値は,
	  どのくらいの量のテキストがペー ジにフィットするか, また,
	  ユーザのジョブが何ページある のかを調べるために使われます.
	  プリンタの課金についての 詳しい情報については, 「<link
	    linkend="printing-advanced-acct">
	    プリンタの利用に対する課金</link>」をご覧ください.</para>
      </sect3>
    </sect2>

    <sect2 id="printing-advanced-header-pages">
      <title>ヘッダページ</title>

      <para>あなたが管理するシステムのユーザが
	<emphasis>たくさん</emphasis>おり, ユー
	ザ全員が様々なプリンタを使用する場合, 多分, 必要悪である
	<emphasis>ヘッダページ</emphasis>
	を印字させることを検討したいと思うかもしれま せん.</para>

      <para>ヘッダページは, <emphasis>バナー</emphasis> とか
	<emphasis>バーストページ</emphasis> としても知ら れていますが,
	出力されたジョブが誰によるものなのかを特定させる
	働きがあります. 印字結果の山の中において, ユーザのジョブによっ
	て印字された本物のドキュメント部分よりも際立たせるために, ヘッ
	ダページは, 通常, 多分, 縁が装飾されている大きな太文字で印字さ
	れます. ヘッダページにより, ユーザは自分が出したジョブがどこに
	あるのかをすばやく見つけることができます.
	ヘッダページの欠点は,  明らかに, すべてのジョブに対して,
	紙が1枚余分に印字されるという ことです.
	この紙の有効期間は短く, 2〜3 分も続きません. 最終的に,
	これらの紙は再利用紙入れの中か
	くずの山に入れられることでしょう.
	(ヘッダページはジョブ中の各ファイル毎に印字されるのではなく,
	ジョブ毎に印字されるということに注意してください. したがって,
	紙の 消費はそれほどひどくはないかもしれません).</para>

      <para><emphasis>もし</emphasis>,
	プリンタがプレインテキストを直接印字できるならば,  LPD
	システムは印字物に対して自動的にヘッダページを付けることが
	できます. PostScript プリンタを使っている場合は, ヘッダペー
	ジを生成する外部プログラムが必要になります. これについては,
	「<link linkend="printing-advanced-header-pages-ps">PostScript
	  プリンタでのヘッダページ</link>」をご覧ください.</para>

      <sect3 id="printing-advanced-header-pages-enabling">
	<title>ヘッダページの印字を許可する</title>

	<para>「<link linkend="printing-simple">プリンタ設定導入編
	  </link>」 では, <filename>/etc/printcap</filename>
	  ファイルの <literal>sh</literal> (``suppress header'' :
	  <quote>ヘッダを供給しない</quote>という意味) を指定して,
	  ヘッダペー ジの印字を止めていました.
	  プリンタでのヘッダページの印字を許可 するには,
	  <literal>sh</literal> 項目を取り除くだけよい訳です.</para>

	<para>とても簡単そうに見えるけど, 本当かな?</para>

	<para>それは本当です.
	  プリンタに初期化文字列を送るための出力フィ
	  ルタを用意しなくてはならないかもしれません. 次に, Hewlett
	  Packard PCL 互換プリンタの例を挙げます. </para>

	<programlisting>
#!/bin/sh
#
#  hpof - Output filter for Hewlett Packard PCL-compatible printers
#  Installed in /usr/local/libexec/hpof


printf "\033&amp;k2G" || exit 2
exec /usr/libexec/lpr/lpf</programlisting>

	<para><literal>of</literal>
	  項目に出力フィルタのパス名を指定してください. 詳細につ
	  いては, 「<link
	    linkend="printing-advanced-of">出力フィルタ</link>」
	  をご覧ください.</para>

	<para>次に, 以前紹介したプリンタ <literal>teak</literal>
	  のための  <filename>/etc/printcap</filename>
	  ファイルの例を示します. ここでは, ヘッ
	  ダページの印字を許可し, 上記の出力フィルタを追加しました.
	</para>

	<programlisting>
#
#  /etc/printcap for host orchid
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sd=/var/spool/lpd/teak:mx#0:\
        :if=/usr/local/libexec/hpif:\
        :vf=/usr/local/libexec/hpvf:\
        :of=/usr/local/libexec/hpof:</programlisting>

	<!-- kuriyama - literallayout? -->
	<!-- si006 - now literal -->
	<para>さて, ユーザが <literal>teak</literal>
	  からジョブを印字させたとき, それぞれ
	  のジョブ毎にヘッダページが印字されます.
	  もし, ユーザが印字物を
	  探すのに時間を費やしたいと思うなら,
	  <command>lpr -h</command> によってジョ
	  ブを入力することで,
	  ヘッダページの印字を止めることができます.
	  これ以外の
	  &man.lpr.1; のオプションについては,
	  「<link linkend="printing-lpr-options-misc">
	    ヘッダページ用オプション</link>」
	  をご覧ください.</para>

	<note>
	  <para>LPD では, ヘッダページの最後に, FORM FEED 文字が印
	    字されます. プリンタに紙排出をさせるために, 別な文字,
	    もしくは,  別な文字列が利用されている場合は,
	    <filename>/etc/printcap</filename> 中の
	    <literal>ff</literal> 項目で指定することができます.</para>
	</note>
      </sect3>

      <sect3 id="printing-advanced-header-pages-controlling">
	<title>ヘッダページを制御する</title>

	<para>ヘッダページの印字が許可されていると, LPD は
	  <emphasis>長いヘッ ダ</emphasis>を作ります. これには,
	  紙全面に大きな文字でユーザ名, ホスト 名,
	  ジョブ名が書かれています. 次に, このヘッダページの例を示
	  します (kelly が ジョブ名 outline を rose
	  というホストから印字 された場合). </para>

	<programlisting>
      k                   ll       ll
      k                    l        l
      k                    l        l
      k   k     eeee       l        l     y    y
      k  k     e    e      l        l     y    y
      k k      eeeeee      l        l     y    y
      kk k     e           l        l     y    y
      k   k    e    e      l        l     y   yy
      k    k    eeee      lll      lll     yyy y
                                               y
                                          y    y
                                           yyyy


                                   ll
                          t         l        i
                          t         l
       oooo    u    u   ttttt       l       ii     n nnn     eeee
      o    o   u    u     t         l        i     nn   n   e    e
      o    o   u    u     t         l        i     n    n   eeeeee
      o    o   u    u     t         l        i     n    n   e
      o    o   u   uu     t  t      l        i     n    n   e    e
       oooo     uuu u      tt      lll      iii    n    n    eeee









      r rrr     oooo     ssss     eeee
      rr   r   o    o   s    s   e    e
      r        o    o    ss      eeeeee
      r        o    o      ss    e
      r        o    o   s    s   e    e
      r         oooo     ssss     eeee







                                              Job:  outline
                                              Date: Sun Sep 17 11:04:58 1995</programlisting>

	<para>LPD はこのテキストの終わりに FROM FEED 文字を加えます
	  ので, ジョブは新しいページから開始されます (ただし,
	  <filename>/etc/printcap</filename>
	  で出力先のプリンタのエントリに  <literal>sf</literal>
	  (suppress form feeds) が指定されているときはこ
	  の限りではありません).</para>

	<para>お望みならば, LPD
	  に<emphasis>短いヘッダページ</emphasis>を出力させる
	  こともできます. この場合は,
	  <filename>/etc/printcap</filename> ファ イルの中で
	  <literal>sb</literal> (short banner) を指定してください.
	  ヘッダページは次のようになります. </para>

	<programlisting>
rose:kelly  Job: outline  Date: Sun Sep 17 11:07:51 1995</programlisting>

	<para>デフォルトでは, LPD はヘッダページを最初に印字し, 次
	  にジョブの印字をおこないます. この順番を逆にするときは,
	  <filename>/etc/printcap</filename> で <literal>hl</literal>
	  (header last) を指定 してください.</para>
      </sect3>

      <sect3 id="printing-advanced-header-pages-accounting">
	<title>ヘッダページに対する課金</title>

	<para>LPD に備わっているヘッダページ出力機能を使うと, 入力され
	  たジョブに対して課金をおこなうことができても,
	  ヘッダページは<emphasis>無
	    料</emphasis>で提供しなくてはならない,
	  という特有のやり方を強要されます.</para>

	<para>なぜでしょうか.</para>

	<para>出力フィルタは単なる外部プログラムなので,
	  課金をするための制御 をおこなうとすれば,
	  それはヘッダページを印字するときですが, 出力フィ ルタには,
	  <emphasis>ユーザ名とホスト名</emphasis>
	  の情報や課金情報を格納するファ イルがどれな
	  のかということが知らされません. それゆえ, 出力ファイルには,
	  誰
	  にプリンタ利用の課金をおこなえばよいのかが分からないのです.
	  テキス トフィルタやその他の変換フィルタ
	  (これらのフィルタはユーザやホ ストの情報が知らされます)
	  が出力ページの枚数に<quote>1ページ分水増しする</quote>だけでは十分ではありません.
          なぜなら, ユーザは
	  <command>lpr -h</command> に
	  よってヘッダページの出力を止めることができるからです.
	  やみくも に1ページを水増しすると,
	  印字されてもいないヘッダページに対する
	  料金をとることになります. 基本的に, <command>lpr
	    -h</command> は環境に優し
	  い心を持つユーザに好まれるオプションですが,
	  これを使うように奨 励することもできません.</para>

	<para>各々のフィルタに独自のヘッダページを生成させる
	  (その結果, ヘッ ダページに課金することができる)
	  という方法<emphasis>でも十分であると
	    はいえません</emphasis>. この場合, LPD はフィルタに
	  <option>-h</option> の情報を送 りませんので, <command>lpr
	    -h</command> によってヘッダページを印字しないオ
	  プションを選択したとしても,
	  依然としてヘッダページは印字され,
	  その分の課金がおこなわれてしまいます.</para>

	<para>では, どのような選択肢があるのでしょうか.</para>

	<para>ヘッダページへの課金に関しては,
	  次のことができます.</para>

	<itemizedlist>
	  <listitem>
	    <para>LPD のやり方を受け入れ,
	      ヘッダページは無料とする.</para>
	  </listitem>

	  <listitem>
	    <para>LPRng などの LPD の代替品をインストールする.
              LPD と入れ替えが可能な他のスプーリングソフトウェアに関しては,
              <link linkend="printing-lpd-alternatives"
                    >標準スプーラの代替品</link>をご覧ください.</para>
	  </listitem>

	  <listitem>
	    <!-- kuriyama - more para -->
	    <para><emphasis>スマートな</emphasis>
	      出力フィルタを作成する. 通常, 出力
	      フィルタはプリンタを初期化するか, 単純な文字列変換をす
	      る程度の働きしかしません. (テキスト (入力) フィルタがな
	      い場合) 出力フィルタはヘッダページとプレインテキストの
	      印字をおこなうのに適しています.

	      プレインテキストを印字するためのテキストフィルタがない
	      場合, LPD はヘッダページを印字するためだけの目的で出
	      力フィルタを起動します. そして, LPD が生成するヘッダ
	      ページのテキストを解析することにより, 出力フィルタはヘッ
	      ダページに課金するために必要なユーザ名とホスト名を取得
	      することができます. この方式の唯一の問題点は, 出力フィ
	      ルタは課金情報を格納するデータファイルの名前を知ることが
	      できないということです
	      (<literal>af</literal> 項目で指定されたファイ
	      ル名は出力ファイルに渡されません). しかし, 既知の
	      名前の課金データファイルを使うのならば, その名前を出
	      力フィルタのプログラム中に埋め込むことができます.

	      解析の手順を簡単にするためには,
	      <filename>/etc/printcap</filename>
	      で <literal>sh</literal> 項目 (短いヘッダを指
	      定) を使うとよいでしょう.

	      そしてまた, ここまでの方法は少なからぬトラブルを生じさ
	      せるかもしれません.
	      そうなれば, もちろんユーザはヘッダペー
	      ジを無料で
	      提供してくれる気前のよいシステム管理者に感謝することで
	      しょう.</para>
	  </listitem>
	</itemizedlist>
      </sect3>

      <sect3 id="printing-advanced-header-pages-ps">
	<title>PostScript プリンタでのヘッダページ</title>

	<para>これまでに述べたように, LPD ではプレインテキストのヘッ
	  ダページをたくさんのプリンタに合うように生成することが
	  できます.  残念ながら, PostScript プリンタは,
	  プレインテキストを直接 印字することができません. ですから,
	  LPD のヘッダページ機能は まったく役に立たない,
	  あるいはほとんどの場合で役に立ちません.</para>

	<para>ヘッダページを出力するための自明な方法の1つに,
	  すべての変換フィ
	  ルタとテキストフィルタにヘッダページを生成させる
	  方法があります.  フィルタは,
	  適切なヘッダページを生成するために, ユーザ名とホス
	  ト名の引数を使うべきです. この方法の欠点は, いつでも,
	  <emphasis remap=tt>lpr -h</emphasis>
	  によってジョブが入力された場合でさえも, ヘッダページが印字
	  されるということです.</para>

	<para>この方法で試してみましょう. 次のスクリプトは, 3つの引数
	  (ユーザ のログイン名, ホスト名, ジョブ名) をとり, 簡単な
	  PostScript 用 のヘッダページを生成します.</para>

	<programlisting>
#!/bin/sh
#
#  make-ps-header - make a PostScript header page on stdout
#  Installed in /usr/local/libexec/make-ps-header
#

#
#  These are PostScript units (72 to the inch).  Modify for A4 or
#  whatever size paper you are using:
#
page_width=612
page_height=792
border=72

#
#  Check arguments
#
if [ $# -ne 3 ]; then
    echo "Usage: `basename $0` &lt;user&gt; &lt;host&gt; &lt;job&gt;" 1&gt;&amp;2
    exit 1
fi

#
#  Save these, mostly for readability in the PostScript, below.
#
user=$1
host=$2
job=$3
date=`date`

#
#  Send the PostScript code to stdout.
#
exec cat &lt;&lt;EOF
%!PS

%
%  Make sure we do not interfere with user's job that will follow
%
save

%
%  Make a thick, unpleasant border around the edge of the paper.
%
$border $border moveto
$page_width $border 2 mul sub 0 rlineto
0 $page_height $border 2 mul sub rlineto
currentscreen 3 -1 roll pop 100 3 1 roll setscreen
$border 2 mul $page_width sub 0 rlineto closepath
0.8 setgray 10 setlinewidth stroke 0 setgray

%
%  Display user's login name, nice and large and prominent
%
/Helvetica-Bold findfont 64 scalefont setfont
$page_width ($user) stringwidth pop sub 2 div $page_height 200 sub moveto
($user) show

%
%  Now show the boring particulars
%
/Helvetica findfont 14 scalefont setfont
/y 200 def
[ (Job:) (Host:) (Date:) ] {
200 y moveto show /y y 18 sub def
} forall

/Helvetica-Bold findfont 14 scalefont setfont
/y 200 def
[ ($job) ($host) ($date) ] {
        270 y moveto show /y y 18 sub def
} forall

%
%  That is it
%
restore
showpage
EOF</programlisting>

	<para>そして, 変換フィルタやテキストフィルタがそれぞれ,
	  最初にこのス クリプトを起動することで,
	  ヘッダページが出力され, それから, ユー
	  ザのジョブの印字をおこないます. 次に,
	  このドキュメントの始めのほう で紹介した DVI 変換フィルタを,
	  ヘッダページを印字するように変 更したものを示します. </para>

	<programlisting>
#!/bin/sh
#
#  psdf - DVI to PostScript printer filter
#  Installed in /usr/local/libexec/psdf
#
#  Invoked by lpd when user runs lpr -d
#

orig_args="$@"

fail() {
    echo "$@" 1&gt;&amp;2
    exit 2
}

while getopts "x:y:n:h:" option; do
    case $option in
        x|y)  ;; # Ignore
        n)    login=$OPTARG ;;
        h)    host=$OPTARG ;;
        *)    echo "LPD started `basename $0` wrong." 1&gt;&amp;2
              exit 2
              ;;
    esac
done

[ "$login" ] || fail "No login name"
[ "$host" ] || fail "No host name"

( /usr/local/libexec/make-ps-header $login $host "DVI File"
  /usr/local/bin/dvips -f ) | eval /usr/local/libexec/lprps $orig_args</programlisting>

	<para>このフィルタがユーザ名やホスト名を決定するために
	  引数リストをど
	  のように解析しなくてはならないかという点に注意してください.
	  こ の解析方法は他の変換フィルタに対しても同様です.
	  しかしながら,  テキストフィルタについては,
	  引数の設定が少し異なっています (こ れについては, 「<link
	    linkend="printing-advanced-filters">
	    フィルタはどのように機能しているか</link>」
	  をご覧ください).</para>

	<para>前述の通り, 上記の手法は, 極めて単純なのにも関らず,
	  <literal>lpr</literal>
	  で<quote>ヘッダページを印字しない</quote>オプション
	  (<option>-h</option> オプション) が 使えなくなっています.
	  ユーザが森林資源を (あるいは, ヘッダペー
	  ジが課金されているならば, その僅かな金額を),
	  節約したいと望んでい る場合でも,
	  すべてのフィルタがすべてのジョブ毎にヘッダページを印字
	  することになっているので, 節約することはできません.</para>

	<para>ジョブ毎に印字されるヘッダページを
	  ユーザが抑制できるようにする ためには, 「<link
	    linkend="printing-advanced-header-pages-accounting">
	    ヘッダページに対する課金</link>」で紹介したトリックを
	  使う必要があります. すな わち, LPD
	  が生成するヘッダページの解析をおこない, PostScript
	  版のヘッダページを出力させる出力フィルタを作るのです. この場
	  合, ユーザが <command>lpr -h</command> でジョブを入力すると,
	  LPD はヘッダペー ジを生成しなくなり, また,
	  出力フィルタも起動されません. そうで ないならば,
	  作成した出力フィルタが LPD からのテキストを読み込 み,
	  ヘッダページを印字する適当な PostScript のコードがプリ
	  ンタに送られるでしょう.</para>

	<para>PostScript プリンタがシリアルポートに接続されている場合,
	  出力フィルタとして <command>lprps</command> を,
	  上記の動作をおこなうものとして  <command>psof</command>
	  を使うことができます. ただし, <command>psof</command>
	  はヘッダペー
	  ジに対して課金をおこないませんので注意してください.</para>
      </sect3>
    </sect2>

    <sect2 id="printing-advanced-network-printers">
      <title>リモートプリンタからの出力</title>

      <para>FreeBSD では, ネットワーク越しの印字, すなわち, ジョブをリ
	モートプリンタに送ることをサポートしています. リモートプリンタ
	からの出力をするには, 一般に, 次の2つを参照してください.
      </para>

      <itemizedlist>
	<listitem>
	  <para>リモートホストに接続されたプリンタにアクセスする方 法.
	    プリンタがあるホストのシリアル, または, パラレルイ
	    ンタフェースに接続されている場合, ネットワーク上の他の
	    ホストからこのプリンタにアクセスできるように LPD を設
	    定します. 「<link
	      linkend="printing-advanced-network-rm">リモートホストに
	      接続されたプリンタ</link>」
	    でどのよう にするかを説明します.</para>
	</listitem>

	<listitem>
	  <para>ネットワークに直接接続されているプリンタにアクセ
	    スする方法. プリンタに, 旧来のシリアル, または, パラレ
	    ルインタフェースに加えて (もしくは, これらに代わって) ネッ
	    トワーク用のインタフェースがある場合. そのようなプリン
	    タは次のように動作するでしょう. </para>

	  <itemizedlist>
	    <listitem>
	      <para>そのプリンタが LPD のプロトコルを理解でき, リモー
		トホストからのジョブを
		キューに入れることさえできる場合.  この場合,
		プリンタは, LPD が起動している一般のホスト
		のように振る舞います. そのようなプリンタを設定するため
		に, 「<link linkend="printing-advanced-network-rm">
		  リモートホストに接続されたプリンタ</link>」
		と同様の手 順をおこなってください.</para>
	    </listitem>

	    <listitem>
	      <para>そのプリンタが, データストリームによるネットワー
		ク接続をサポートしている場合. この場合, ネットワーク上
		の1つのホストとしてプリンタを<quote>接続</quote>します.
		このホス トは, ジョブをスプーリングする責任を負い,
		スプーリング されたジョブはプリンタに送られます.
		そのようなプリンタ
		をインストールするためのいくつかの提案が「<link
		  linkend="printing-advanced-network-net-if">
		  ネットワークにおけるデータストリームの
		  インタフェースを持つプリンタ</link>」にあります.</para>
	    </listitem>
	  </itemizedlist>
	</listitem>
      </itemizedlist>

      <sect3 id="printing-advanced-network-rm">
	<title>リモートホストに接続されたプリンタ</title>

	<para>LPD スプーリングシステムでは LPD (または LPD 互換のシス
	  テム)
	  が起動している他のホストへジョブを送る機能が始めからサポー
	  トされています. この機能により,
	  あるホストに接続されたプリンタ へ,
	  他のホストからアクセスできるようになります. また, LPD プ
	  ロトコルを理解するネットワークインタフェースを持った
	  プリンタに 対しても, この機能は働きます.</para>

	<para>リモートプリンタへの出力を許可するためには, 最初に,
	  あるホスト (これを,
	  <emphasis>プリンタホスト</emphasis>と呼びます)
	  にプリンタを接続します.  そして, 「 <link
	    linkend="printing-simple"> プリンタ設定導入編</link>」
	  に書かれた簡単なプリンタの設定をおこなってください.
	  必要ならば,  「<link
	    linkend="printing-advanced">プリンタ設定上級編</link>」
	  にあ る, 更に進んだ設定をおこなってください. そして,
	  そのプリンタをテス トしてうまく動作することを確認し, LPD
	  に許可した機能がうまく働 くかどうかを見てください. さらに
	  <emphasis>ローカルホスト</emphasis> が
	  <emphasis>プリンタホスト</emphasis> の LPD サービスの使用を
	  許可されているか確認して 下さい (「<link
	    linkend="printing-advanced-restricting-remote">
	    リモートホストからのプリンタの利用を制限する
	  </link>」参照).</para>

	<para>LPD
	  互換のネットワークインタフェースを持つプリンタを使用してい
	  る場合は, そのプリンタ自身が以下で説明する
	  <emphasis>プリンタホスト</emphasis> になります. そして,
	  <emphasis>プリンタ名</emphasis>とは, そのプリンタに設定し
	  た名前のことを指します. これについては, プリンタ, および
	  (また は),
	  プリンタのネットワークインタフェースに付属するドキュメン
	  トを参照してください.</para>

	<tip>
	  <para>
            ヒューレット・パッカード社の Laserjet シリーズを使用している場合には,
            プリンタ名を <literal>text</literal> とすると,
            自動的に LF から CRLF への変換が行なわれます.
            そのため, <filename>hpif</filename> スクリプトは必要ありません.
          </para>
	</tip>

	<para>次に,
	  そのプリンタにアクセスしたいと思っている他ホストにおいて,
	  そのホストの <filename>/etc/printcap</filename>
	  ファイルに次にあげるエント リを作ります. </para>

	<orderedlist>
	  <listitem>
	    <para>名前のエントリ. どんな名前でもよいのですが, 簡単
	      のため, 多分, プリンタホストで設定されたプリンタ名や別
	      名と同じものを使いたいと思うでしょう.</para>
	  </listitem>

	  <listitem>
	    <para><literal>lp</literal>
	      項目で指定されるデバイスは明示的に空にす る
	      (<literal>:lp=:</literal> とする).</para>
	  </listitem>

	  <listitem>
	    <para>スプーリングディレクトリを作成し,
	      <literal>sd</literal> 項目で その位置を指定する. LPD
	      では, プリンタホストにジョブ を送信するまでの間,
	      このディレクトリにジョブを格納しま す.</para>
	  </listitem>

	  <listitem>
	    <para><literal>rm</literal>
	      項目でプリンタホストの名前を指定します.</para>
	  </listitem>

	  <listitem>
	    <para><literal>rp</literal> 項目で
	      <emphasis>プリンタホスト</emphasis> に接続したプリン
	      タ名を指定します.</para>
	  </listitem>
	</orderedlist>

	<para>これで終わりです.
	  変換フィルタやページの大きさやその他の事項を
	  <filename>/etc/printcap</filename>
	  に加える必要はありません.</para>

	<para>次に,
	  リモートホストに接続されたプリンタで印字するための設定例
	  を示します. ホスト <hostid>rose</hostid> には2台のプリンタ
	  <literal>bamboo</literal> と  <literal>rattan</literal>
	  が接続されています. これらのプリンタをホスト  <!-- kuriyama
	  - check English version: orchid --> <hostid>orchid</hostid>
	  のユーザが使えるようにしましょう. 最初に
	  <hostid>orchid</hostid> の
	  <filename>/etc/printcap</filename> を示します
	  (このファイルは, 「<link
	    linkend="printing-advanced-header-pages-enabling">
	    ヘッダページの出力を許可する</link>」
	  で参照することができます). このファイルには,  既に, プリンタ
	  <literal>teak</literal> 用のエントリがありました. 以下では,
	  <!-- kuriyama - chech English version: rose --> これに,
	  ホスト <hostid>rose</hostid>
	  にある2台のプリンタ用のエントリが加えられ ています. </para>

	<programlisting>
#
#  /etc/printcap for host orchid - added (remote) printers on rose
#

#
#  teak is local; it is connected directly to orchid:
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sd=/var/spool/lpd/teak:mx#0:\
        :if=/usr/local/libexec/ifhp:\
        :vf=/usr/local/libexec/vfhp:\
        :of=/usr/local/libexec/ofhp:

#
#  rattan is connected to rose; send jobs for rattan to rose:
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :lp=:rm=rose:rp=rattan:sd=/var/spool/lpd/rattan:

#
#  bamboo is connected to rose as well:
#
bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :lp=:rm=rose:rp=bamboo:sd=/var/spool/lpd/bamboo:</programlisting>

	<para><hostid>orchid</hostid>
	  で必要となる作業はスプーリングディレクトリを
	  作ることだけです. </para>

	<screen>&prompt.root; <userinput>mkdir -p /var/spool/lpd/rattan /var/spool/lpd/bamboo</userinput>
&prompt.root; <userinput>chmod 770 /var/spool/lpd/rattan /var/spool/lpd/bamboo</userinput>
&prompt.root; <userinput>chown daemon.daemon /var/spool/lpd/rattan /var/spool/lpd/bamboo</userinput></screen>

	<para>これで, <hostid>orchid</hostid> のユーザが
	  <literal>rattan</literal> と <literal>bamboo</literal> で印字す
	  ることができるようになりました.
	  例えば, orchid のユーザが次の
	  ように入力したとします.

	  <screen>&prompt.user; <userinput>lpr -P bamboo -d sushi-review.dvi</userinput></screen>

	  すると, orchid の LPD システムは, ジョブをスプーリングディレ
	  クトリ <filename>/var/spool/lpd/bamboo</filename>
	  にコピーし, これが DVI
	  ファイルを印字するジョブであることを記録します.
	  ホスト rose の
	  <hostid>bamboo</hostid>
	  用のスプーリングディレクトリに十分な容量が確保でき
	  次第, 両者の LPD は, ジョブのファイルを rose に転送します. こ
	  のファイルは, そのすべてが印字されるまで, rose
	  のキューに留まり
	  ます. (bamboo は PostScript プリンタなので) DVI から PostScript
	  への変換は rose でおこなわれます.</para>
      </sect3>

      <sect3 id="printing-advanced-network-net-if">
	<title>ネットワークにおけるデータストリームのインタ
	  フェースを持つプリンタ</title>

	<para>プリンタのネットワークインタフェースカードは, 2種類に分
	  類することができます. 1つはスプーラをエミュレートするもの
	  (高価) で, もう 1
	  つはシリアルやパラレルポートを使うようにプリンタにデー
	  タを送ることができるだけのもの (安価) です. この節では,
	  後者の使 い方を説明します. 前者のプリンタは, 前節「<link
	    linkend="printing-advanced-network-rm">
	    リモートホストに接続されたプリンタ</link>」
	  の方法が適用できます.</para>

	<para><filename>/etc/printcap</filename> ファイルでは,
	  シリアルかパラレルのイン タフェースのどちらを使うのか,
	  そして, (シリアルインタフェース を使う場合)
	  そのボーレートはいくらであるか, フロー制御は使うのか,
	  タブのための遅延を加えるのか,
	  改行文字を変換するかなどの指定を おこなうことができます.
	  しかし, TCP/IP や他のネットワークポートか
	  らデータを受け取るプリンタを接続するための
	  指定をおこなうことはでき ません.</para>

	<para>ネットワーク接続されたプリンタにデータを送るためには,
	  テキスト フィルタと変換フィルタから呼び出すことができる
	  通信プログラムを 開発する必要があります. 以下に,
	  そのようなプログラムの例を示し ます. スクリプト
	  <command>netprint</command> では, 標準入力から印字データを
	  すべて受け取り,
	  ネットワーク接続されたプリンタにこれを送ります.
	  <command>netprint</command>
	  の最初の引数でプリンタのホスト名を, 2番目の引数
	  で接続するポート番号を指定します.
	  このプログラムでは単方向通信 (FreeBSD からプリンタ)
	  のみをサポートしていることに注意してくだ さい.
	  ネットワークプリンタの多くは双方向通信をサポートしていま
	  すので, その恩恵 (プリンタの状態を得たり,
	  課金をおこなうなど) にあず かりたいと思われるかもしれません.
	</para>

	<programlisting>
#!/usr/bin/perl
#
#  netprint - Text filter for printer attached to network
#  Installed in /usr/local/libexec/netprint
#

$#ARGV eq 1 || die "Usage: $0 &lt;printer-hostname&gt; &lt;port-number&gt;";

$printer_host = $ARGV[0];
$printer_port = $ARGV[1];

require 'sys/socket.ph';

($ignore, $ignore, $protocol) = getprotobyname('tcp');
($ignore, $ignore, $ignore, $ignore, $address)
    = gethostbyname($printer_host);

$sockaddr = pack('S n a4 x8', &amp;AF_INET, $printer_port, $address);

socket(PRINTER, &amp;PF_INET, &amp;SOCK_STREAM, $protocol)
    || die "Can't create TCP/IP stream socket: $!";
connect(PRINTER, $sockaddr) || die "Can't contact $printer_host: $!";
while (&lt;STDIN&gt;) { print PRINTER; }
exit 0;</programlisting>

	<para>このスクリプトは,
	  様々なフィルタが利用することができます. 仮に,  Diablo 750-N
	  ラインプリンタを持っており, これがネットワークに
	  接続されているとしましょう.
	  プリンタはポート番号5100にて印字す るデータを受け取ります.
	  プリンタのホスト名は scrivener としま す. このとき,
	  このプリンタのテキストフィルタは次のようになりま す. </para>

	<programlisting>
#!/bin/sh
#
#  diablo-if-net - Text filter for Diablo printer `scrivener' listening
#  on port 5100.  Installed in /usr/local/libexec/diablo-if-net
#

exec /usr/libexec/lpr/lpf "$@" | /usr/local/libexec/netprint scrivener 5100</programlisting>
      </sect3>
    </sect2>

    <sect2 id="printing-advanced-restricting">
      <title>プリンタの利用に制約を与える</title>

      <para>本節では, プリンタの利用に制約を与えるための情報を記して
	います. LPD システムでは, プリンタ (ローカル, リモートのいずれ
	に接続されていても) にアクセスできる人を制限する機能, 複数部の
	コピーの印字の可否を制御する機能, ジョブのサイズの最大値やプリ
	ンタキューに入るジョブの最大個数を制御する
	機能を提供しています.</para>

      <sect3 id="printing-advanced-restricting-copies">
	<title>複数部のコピーの印字を制限する</title>

	<para>LPD
	  システムではユーザが複数部のコピーの印字を簡単におこなう
	  機能を提供しています. ユーザが, (例えば) <command>lpr
	    -#5</command> コマ ンドを使ってジョブを印字すると,
	  ジョブのそれぞれのファイルのコ ピーを5部得ることができます.
	  これがよい機能であると思うかどう
	  かは人それぞれでしょう.</para>

	<para>複数部のコピーの印字によってプリンタが
	  必要以上に消耗してしまう
	  と感じるならば, <filename>/etc/printcap</filename>
	  ファイルに <literal>sc</literal> 項
	  目を加えてください. これにより,
	  &man.lpr.1; の <option>-#</option> オプションの使用
	  が禁止されます. このオプションが指定されているにも関らず,
	  <option>-#</option> オプションを使うと,
	  次のようなメッセージが表示され,
	  このオプションの利用できない旨を伝えます. </para>

	<screen>lpr: multiple copies are not allowed</screen>

	<para>リモートホストからプリンタをアクセスできる
	  設定にしている場合 (この 設定については, 「<link
	    linkend="printing-advanced-network-rm">
	    リモートホストに接続されたプリンタ</link>」
	  をご覧ください), その リモートホストの
	  <filename>/etc/printcap</filename> にも同じように
	  <literal>sc</literal>
	  項目を追加する必要があることに注意してください.
	  そうしないと, ユーザは別なホストから複数部のコピーの
	  印字することができてしま います.</para>

	<para>例を使って説明しましょう. 次に示す
	  <filename>/etc/printcap</filename> ファ イルは, ホスト
	  <hostid>rose</hostid> のものです. プリンタ
	  <literal>rattan</literal> は極めて 頑丈なので,
	  複数部のコピーの印字は許可されています. しかし, レー
	  ザプリンタの <literal>bamboo</literal>
	  はもう少しデリケートで, このプリンタ
	  から複数部のコピーを印字することを <literal>sc</literal>
	  項目を追加すること で禁止しています. </para>

	<programlisting>
#
#  /etc/printcap for host rose - restrict multiple copies on bamboo
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:\
        :lp=/dev/ttyd5:fs#0x82000e1:xs#0x820:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</programlisting>

	<para>さらに, orchid の <filename>/etc/printcap</filename>
	  にも <literallayout>sc</literallayout> 項目を
	  追加する必要があります (<hostid>orchid</hostid>
	  でこの編集をおこなっているときに, つ いでに, プリンタ
	  <literal>teak</literal> でも複数部のコピーの印字を禁止する
	  ことにしましょう). </para>

	<programlisting>
#
#  /etc/printcap for host orchid - no multiple copies for local
#  printer teak or remote printer bamboo

teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sd=/var/spool/lpd/teak:mx#0:sc:\
        :if=/usr/local/libexec/ifhp:\
        :vf=/usr/local/libexec/vfhp:\
        :of=/usr/local/libexec/ofhp:

rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :lp=:rm=rose:rp=rattan:sd=/var/spool/lpd/rattan:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :lp=:rm=rose:rp=bamboo:sd=/var/spool/lpd/bamboo:sc:</programlisting>

	<para><literal>sc</literal> 項目を指定することにより,
	  <command>lpr -#</command> の使用を防
	  ぐことができます. しかし, この状態では
	  &man.lpr.1; を複数回起動し
	  たり, 1回のジョブで次のように同じファイルを
	  複数個指定すること
	  を防ぐまでには至っていません. </para>

	<screen>&prompt.user; <userinput>lpr forsale.sign forsale.sign forsale.sign forsale.sign forsale.sign</userinput></screen>

	<para>このような悪用を防ぐ方法は
	  (その指示を無視することも含めて) たく さんあります.
	  各自で調べてみてください.</para>
      </sect3>

      <sect3 id="printing-advanced-restricting-access">
	<title>プリンタを使用できる人を限定する</title>

	<para>それぞれのプリンタを使用できる人を限定するには, UNIX の
	  グループ権限のメカニズムを利用し, さらに,
	  <filename>/etc/printcap</filename> で <literal>rg</literal>
	  項目を指定することでおこないます.
	  あるプリンタにアクセスさせてもよいと思うユーザすべてを
	  UNIXのある グループに入れてください. そして,
	  そのグループ名を <literal>rg</literal> で 指定します.</para>

	<para>このとき, そのグループに含まれないユーザ
	  (root も含む) には, 次のようなメッセー
	  ジが表示され, プリンタの使用はできません.

	  <errorname>
	    lpr: Not a member of the restricted group
	  </errorname>
	</para>

	<para><literal>sc</literal> (suppress multiple copies :
	  複数部のコピーの印字を禁止
	  する) を指定するときと同様に, <literal>rg</literal>
	  が指定されたプリンタがリ
	  モートホストからもアクセスでき
	  (この設定については,
	  「<link linkend="printing-advanced-network-rm">
	    リモートホストに接続されたプリンタ</link>」
	  をご覧ください), かつ, そ
	  のホストでもプリンタを使用できる人を限定するのが
	  妥当であると思
	  う場合は, そのホストの
	  <filename>/etc/printcap</filename> にも
	  <emphasis remap=tt>rg</emphasis> 指
	  定をおこなう必要があります.</para>

	<para>例えば, プリンタ <literal>rattan</literal>
	  は誰でも利用できるが,  <literal>bamboo</literal> はグループ
	  <literal>artists</literal> に属している人のみが利用で
	  きるようにしてみましょう. 以下に, もうお馴染みとなったホスト
	  <hostid>rose</hostid> の <filename>/etc/printcap</filename>
	  を示します. </para>

	<programlisting>
#
#  /etc/printcap for host rose - restricted group for bamboo
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:rg=artists:\
        :lp=/dev/ttyd5:fs#0x82000e1:xs#0x820:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</programlisting>

	<para>これ以外の <filename>/etc/printcap</filename> ファイル
	  (ホスト <hostid>orchid</hostid> のもの)
	  はそのままにしておくことにします. もちろん,
	  <hostid>orchid</hostid> のユーザは 全員
	  <literal>bamboo</literal> を利用することができます. これは,
	  <hostid>orchid</hostid> に
	  は特定のユーザのみにしかアクセスさせておらず,
	  そのユーザにはプ
	  リンタを利用させたいと思っているからなのかもしれませんし,
	  そう でないかもしれません.</para>

	<note>
	  <para>1台のプリンタを複数グループのユーザに利用させること
	    はできません.</para>
	</note>
      </sect3>

      <sect3 id="printing-advanced-restricting-sizes">
	<title>入力可能なジョブのサイズを制限する</title>

	<para>たくさんのユーザからプリンタが利用される場合には, 多分,
	  ユーザが印字要求を出すことができるファイルのサイズに
	  上限値を置 く必要が生じるでしょう. 結局のところ,
	  スプーリングディレクトリ
	  が置かれているファイルシステムの空き容量がその
	  上限値になる訳で すが,
	  あるユーザがこれを独占的に使用すること避けるために, 他ユー
	  ザからのジョブ用の空き容量を確保する必要もあります.</para>

	<para>LPD では, <literal>mx</literal>
	  項目を指定することにより, ジョブ中の個々のファ
	  イルのサイズの上限値を制限する機能を提供しています.
	  指定される ファイルサイズの単位は BUFSIZ ブロックで, 1
	  BUFSIZ ブロックは 1024バイトを表わします. この <literal>
	  mx</literal> 項目の値として0が指定されると,
	  ファイルサイズの制限はなくなります.
	  <literal>mx</literal> が指定されない場合は,
	  デフォルトの制限として 1000 ブロックが使われます.
	</para>

	<note>
	  <para>この制限はジョブ中の各
	    <emphasis>ファイル</emphasis>に対して適用されるものであり,
	    ジョブ全体のサイズ
	    を制限するものでは<emphasis>ありません</emphasis>.</para>
	</note>

	<para>ところで,
	  プリンタに設定された上限値を超えるファイルサイズのファ
	  イルが入力された場合でも, LPD はこれを拒否しません. その代わ
	  りに, このファイルは,
	  その先頭から上限値のファイルサイズまでし
	  かキューに入れられません. そして, その部分までが印字され,
	  残り の部分は捨てられます.
	  これが正しい動作といえるのかどうかは議
	  論の余地があるところです.</para>

	<para>それでは, 設定例に登場しているプリンタ
	  <literal>rattan</literal> と  <literal>bamboo</literal>
	  の印字可能なファイルサイズに制限を加えてみましょう.  artists
	  グループの人達が作る PostScript ファイルのサイズは
	  巨大になる傾向があるので, 上限値を5Mバイトとします.
	  それから,
	  プレインテキスト用のラインプリンタは無制限とします. </para>

	<programlisting>
#
#  /etc/printcap for host rose
#

#
#  No limit on job size:
#
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:mx#0:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:

#
#  Limit of five megabytes:
#
bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:rg=artists:mx#5000:\
        :lp=/dev/ttyd5:fs#0x82000e1:xs#0x820:rw:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</programlisting>

	<para>この場合もそうですが, この制限はローカル (ホスト rose)
	  のユーザ のみに適用されます.
	  リモートホストからプリンタを利用できるよう
	  に設定している場合は,
	  そのリモートホストのユーザはこの制限を受 けません.
	  これらのユーザにも制限を加える場合は, リモートホスト の
	  <filename>/etc/printcap</filename> の <literal>mx</literal>
	  を指定する必要があります.
	  リモートホストから印字するための詳しい情報については,
	  「<link
	    linkend="printing-advanced-network-rm">
	    リモートホストに接続されたプリンタ</link>」
	  を参照してください.</para>

	<para>リモートホストに接続されたプリンタへのジョブの
	  サイズを制限する 特別な方法は他にもあります. これについては,
	  「<link linkend="printing-advanced-restricting-remote">
	    リモートホストからのプリンタの利用を制限する</link>」
	  を参照してください.</para>
      </sect3>

      <sect3 id="printing-advanced-restricting-remote">
	<title>リモートホストからのプリンタの利用を制限する</title>

	<para>LPD スプーリングシステムでは, リモートホストから要求され
	  たジョブの印字を制限するための方法がいくつか
	  提供されています.</para>

	<variablelist>
	  <varlistentry><term>ホストの制限</term>
	    <listitem>
	      <para>ローカルの LPD
		が印字要求を受け付けるリモートホストは,  ファイル
		<filename>/etc/hosts.equiv</filename> と
		<filename>/etc/hosts.lpd</filename>
		によって制御することができます.  LPD では,
		あるホストから印字の要求がきたとき, このホス
		トの名前がこれら2つのファイルのどちらかに含まれている
		かどうかを調べます. これが含まれていない場合は, LPD
		はこの要求を拒否します.</para>

	      <para>これらのファイルの形式は単純です.
		各行にホストの名前を
		1つずつ書いていきます. ファイル
		<filename>/etc/hosts.equiv</filename> の方は
		&man.ruserok.3; プロトコル
		でも利用され, &man.rsh.1; や &man.rcp.1;
		といったプログラム
		の動作に影響するので注意が必要です.
		<filename>/etc/hosts.equiv</filename>
		の記述は慎重におこないましょう.</para>

	      <para>例として, 以下にホスト <hostid>rose</hostid> の
		<filename>/etc/hosts.lpd</filename>  を示します.
	      </para>

	      <programlisting>
orchid
violet
madrigal.fishbaum.de</programlisting>

	      <para>この例では, <hostid>rose</hostid> はホスト
		<hostid>orchid</hostid>, <hostid>violet</hostid>,
		そして  <hostid
		  role="fqdn">madrigal.fishbaum.de</hostid>
		からの要求を受け付けることになり ます.
		その他のホストが <hostid>rose</hostid> の LPD
		にアクセスしようと しても,  LPD はそのジョブを拒否します
		(訳注:拒否されるのは,  そのホストが
		<filename>/etc/hosts.equiv</filename> にも含まれてい
		ない場合です).</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term>サイズの制限</term>
	    <listitem>
	      <para>スプーリングディレクトリがある
		ファイルシステムに残して
		おく必要がある空き容量の大きさを制御することが
		できます.
		ローカルプリンタ用のスプーリングディレクトリに
		<filename>minfree</filename>
		という名前のファイルを作成します. そして,
		そのファイルの中にリモートホストからのジョブの要求を受
		け付けるために必要な空き容量のディスクブロックサイズ
		(1 ディスクブロック=512バイト) を記します.</para>

	      <para>これで,
		リモートホストのユーザにファイルシステムを満杯
		にされないことが保証されます. この機能を使うと, ローカ
		ルホストのユーザに対してある種の優先権を与えることもで
		きます. ローカルホストのユーザは,
		<filename>minfree</filename> ファイ
		ルで指定された値よりもディスクの空き容量が下回った後で
		もずっと,
		ジョブをキューに入れることができるのです.</para>

	      <para>例えば, プリンタ <hostid>bamboo</hostid> 用の
		<filename>minfree</filename> を作っ てみましょう.
		このプリンタのスプーリングディレクトリを 調べるために,
		<filename>/etc/printcap</filename> を調べてみましょ
		う. 以下に, <hostid>bamboo</hostid>
		のエントリ部分を示します. </para>

	      <programlisting>
bamboo|ps|PS|S|panasonic|Panasonic KX-P4455 PostScript v51.4:\
        :sh:sd=/var/spool/lpd/bamboo:sc:rg=artists:mx#5000:\
        :lp=/dev/ttyd5:fs#0x82000e1:xs#0x820:rw:mx#5000:\
        :if=/usr/local/libexec/psif:\
        :df=/usr/local/libexec/psdf:</programlisting>

	      <para>スプーリングディレクトリは
		<literallayout>sd</literallayout> で指定されます.  LPD
		がリモートホストからのジョブを受け付けるために必要
		なファイルシステムの空き容量を3Mバイト
		(=6144ディスクブ ロック) にすることにしましょう.
	      </para>

	      <screen>&prompt.root; <userinput>echo 6144 &gt; /var/spool/lpd/bamboo/minfree</userinput></screen>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term>利用ユーザの制限</term>
	    <listitem>
	      <para><filename>/etc/printcap</filename> の
		<literal>rs</literal> 項目を指定することで,
		ローカルプリンタを利用できるリモートホストのユーザを制
		限することができます. ローカルホストに接続されたプリン
		タ用のエントリに <literal>rs</literal>
		項目が指定されている場合,  LPD
		は印字を要求したユーザのアカウントと同じログイン名
		がローカルホストに登録されている<emphasis>場合に限り</emphasis>
		, その
		ジョブが受け付けられます. そうでないユーザからのジョブ
		は LPD は拒否します.</para>

	      <para>この機能は, (例えば)
		複数の部署がネットワークを共有して おり,
		この内のあるユーザが部署の境界を越えて活動してい
		る場合には特に有用です. そのようなユーザに対して, シス
		テムのアカウントを与えるだけで, これらのユーザは自分が
		所属する部署のシステムからそのシステムに接続されている
		プリンタを使用することができます. これらのユーザにはむ
		しろ, プリンタの使用<emphasis>だけ</emphasis>を認め,
		その他のコンピュー タ資源を利用させたくないときは,
		それらのユーザにはホー ムディレクトリを与えず,
		ログインシェルはシェルとしては 何の役にも立たない
		<filename>/usr/bin/false</filename> などを指定 して,
		これらのユーザのアカウントはプリンタ用の<quote>形式的な</quote>ものとします.</para>
	    </listitem>
	  </varlistentry>
	</variablelist>
      </sect3>
    </sect2>

    <sect2 id="printing-advanced-acct">
      <title>プリンタの利用に対する課金</title>

      <para>という訳で, 印字するためには料金をとることが必要です. 取ら
	ない理由などありましょうか. 紙やインクにはお金がかかります. そ
	して, プリンタの維持費もかかります. プリンタには可動部分が搭載
	されており, これらの部分は壊れやすいという傾向があります. プリ
	ンタや, その利用形態, 維持費について調査をし, 1ページ (1フィー
	ト, 1メートルなど) 当たりにかかるコストを調べておいてください.
	これに基づき, プリンタの利用に対する課金を, 実際に, どのように
	始めればよいのでしょうか.</para>

      <para>さて, 残念ながら, この部分に関しては LPD
	スプーリングシステム はほとんど役に立ちません.
	課金は使用しているプリンタの種類, 印
	字するもののファイルの形式,
	プリンタの利用に対する課金での
	<emphasis>あなた自身の</emphasis>要求に大きく左右されます.</para>

      <para>課金システムを実現するためには, プリンタのテキストフィルタ
	(プ レインテキストのジョブに対して課金するため) と変換フィルタ
	(その 他のファイル形式に対して課金するため) を変更して,
	印字したペー ジを数えたり,
	プリンタに印字したページ数を取得するための要求を
	送る必要があります. ただし, 出力フィルタのみを利用している場合
	は, 課金をおこなうことができません. フィルタに関しては,
	「<link
	  linkend="printing-advanced-filter-intro">
	  フィルタ</link>」をご覧く ださい.</para>

      <para>一般に, 課金方式には次の2つがあります. </para>

      <itemizedlist>
	<listitem>
	  <para><emphasis>定期的に課金する方法</emphasis>
	    はよく利用される方法です.  この理由は, 恐らく,
	    比較的簡単に実現できるからです. 誰
	    かがジョブを印字する度に, フィルタはそのユーザ名, ホス
	    ト名, 印字したページ数を課金データファイルに記録します.
	    毎月, 毎学期, 毎年, あるいは, お好みの時期に, 様々なプ
	    リンタの課金用ファイルを集め, それぞれのユーザが印字し
	    たページ数を合計し, その分の課金をおこないます. 次回の課金
	    時期のためのデータを0にして課金を再開するために, この
	    処理をおこなった後, すべてのログファイルを削除し,</para>
	</listitem>

	<listitem>
	  <para><emphasis>利用毎に課金する方法</emphasis>
	    はあまり利用されていません.  これは,
	    実現するのが比較的難しいからです. この方式では,
	    プリンタを使用したらすぐに, フィルタがユーザにその利用
	    に対する課金をおこないます. ディスククオータのように, 課金
	    作業は瞬時におこなわれます. この方式では, ユーザのアカウン
	    トが赤字になる場合に, ユーザが印字をおこなうことを拒否する
	    ことができます. また, ユーザに<quote>プリンタ版 quota</quote>を調べたり,
	    調整したりする方法を提供したいと思うかもしれ ません.
	    これを実現するためには, ユーザとその quota を
	    追跡するために, あるデータベース用のコードが必要となり
	    ます.</para>
	</listitem>
      </itemizedlist>

      <para>LPD スプーリングシステムでは, 両方式を簡単にですがサポー
	トしています. これは, (ほとんどの場合で) 印字作業をフィ
	ルタがおこなっていたように, 課金作業もこのためのコードも用
	意することで実現されています. しかし, 明るい面もありま す.
	それは, 課金方式に関して, 非常に大きな柔軟性が与え
	られたということです. 例えば, 「定期的に課金する方法」 か,
	「利用毎に課金する方法」のどちらかを選びまず, そし て,
	どんな情報 (ユーザ名, ホスト名, ジョブのタイプ, 印
	字された頁数, 使用した紙の大きさ, 印字をするために要した
	時間など) をログに記録するかを決めます. 以上のことをおこな
	うには, 上記の情報を保持するために, フィルタを変更しな
	くてはなりません.</para>

      <sect3>
	<title>手軽なプリンタ課金方法</title>

	<para>FreeBSD には, 「定期的に課金する方法」による課金をすぐに
	  設定できるように, 2個のプログラムを添付しています. そ
	  の内の1つはテキストフィルタ <command>lpf</command> で,
	  これについて
	  は, 「<link linkend="printing-advanced-lpf">
	    テキストフィルタ lpf</link>」をご覧ください. もう1つは,
	  &man.pac.8; で,
	  これはプリンタの課金データファイルからのエントリを集め,
	  これを合計するプログラムです.</para>

	<para>「<link linkend="printing-advanced-filters">
	    フィルタはどのように機能しているか</link>」で述べたように,
	  LPD では テキストフィルタや変換フィルタを起動しますが,
	  そのコマ
	  ンドラインで使用している課金データファイルの名前が指定
	  されます. 両フィルタはこの引数を使って, どの課金データ
	  ファイルのエントリに書き込めばよいのかを知ることができ ます.
	  このファイルの名前は <filename>/etc/printcap</filename> 中の
	  <literal>af</literal> 項目によって指定されます.
	  このファイルが絶対パ スで指定されない場合は,
	  スプーリングディレクトリからの
	  相対パスとして扱われます.</para>

	<para>LPD は, 紙のページの幅と行数 (<literal>pw</literal> と
	  <literal>pl</literal> 項目で 指定される) を引数として
	  <command>lpf</command> を起動します.  <command>lpf</command>
	  では, 何ページ印字したかを決定するためにこれ
	  らの引数を使用します. ファイルをプリンタに送った後, 課
	  金情報を課金データファイルに書き込みます. このファイル
	  は次のようになります. </para>

	<programlisting>
2.00 rose:andy
3.00 rose:kelly
3.00 orchid:mary
5.00 orchid:mary
2.00 orchid:zhang</programlisting>

	<!-- kuriyama - this para is not sync with Eng. ver? -->
	<para>課金データファイルはプリンタ毎に分けて作るべきです. こ
	  れは, <command>lpf</command>
	  にはデータファイルをロックする機構が組
	  み込まれていないためです. したがって, <command>lpf</command>
	  が2つ起動 されたとき,
	  同じファイルに同時に書き込みをおこなった場合,
	  お互いのエントリが破壊されてしまうかもしれません. 課金
	  用ファイルを各プリンタ毎に確実に分けるには,
	  <filename>/etc/printcap</filename> 中の
	  <literal>af=acct</literal> 項目を使いま す.</para>

	<para>プリンタの利用に対してユーザに課金する準備ができたら,
	  スプーリングディレクトリに移動した後,
	  &man.pac.8; と入力
	  してください. 次のような, ドル中心主義の課金リストが表
	  示されます(訳注:ドル中心主義という表現は, 表示がドルで
	  出ることへの著者の皮肉でしょう. セントがあるので小数点
	  以下が表示されますが, この機能も日本では邪魔ですね).</para>

	<screen>  Login               pages/feet   runs    price
orchid:kelly                5.00    1   $  0.10
orchid:mary                31.00    3   $  0.62
orchid:zhang                9.00    1   $  0.18
rose:andy                   2.00    1   $  0.04
rose:kelly                177.00  104   $  3.54
rose:mary                  87.00   32   $  1.74
rose:root                  26.00   12   $  0.52

total                     337.00  154   $  6.74</screen>

	<para>&man.pac.8; が受け付ける引数には
	  次のようなものがあります. </para>

	<variablelist>
	  <varlistentry><term><option>-P<replaceable>printer</replaceable></option></term>
	    <listitem>
	      <para> プリンタ <replaceable>printer</replaceable>
		の利用に対する課金リストを作成し ます.
		このオプションは, <filename>/etc/printcap</filename>
		の  <literal>af</literal>
		が絶対パスで指定されていた場合に限り, 動作しま
		す.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-c</option></term>
	    <listitem>
	      <para>ユーザ名のアルファベット順ではなく,
		課金額の低い順にリ ストを並べます.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-m</option></term>
	    <listitem>
	      <para>課金データファイルにあるホスト名を無視します.
		このオプショ ンを使用すると, ホスト
		<hostid>alpha</hostid> のユーザ
		<username>smith</username> とホスト
		<hostid>gamma</hostid> のユーザ
		<username>smith</username> は同一人物として扱われます.
		この オプションが指定されない場合は,
		両者は別なユーザとして 扱います.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-p<replaceable>price</replaceable></option></term>
	    <listitem>
	      <para><filename>/etc/printcap</filename> の
		<literal>pc</literal> 項目で指定された値,  または,
		デフォルトの値 (2セント) に代わり, 紙1ページ, ま たは,
		1フィート当たりの価格を指定します.
		<replaceable>price</replaceable>  として,
		浮動小数点数を指定することができます.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-r</option></term>
	    <listitem>
	      <para>リストの並べる順番を逆順にします.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-s</option></term>
	    <listitem>
	      <para>課金リストを作成し,
		課金データファイルを削除します.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><replaceable>name</replaceable> <replaceable>&hellip;</replaceable></term>
	    <listitem>
	      <para>ユーザ <replaceable>names</replaceable>
		に対する課金情報のみを表示します.</para>
	    </listitem>
	  </varlistentry>
	</variablelist>

	<para>&man.pac.8; が生成するデフォルトのリストには,
	  各ホストのユーザ別
	  に印字ページ数が表示されます.
	  (ユーザがサイト内のすべてのホスト
	  を使用できるため) ホスト名の情報が意味を持たない場合,
	  <command>pac -m</command>
	  を実行してください. 次のようなリストが得られます.</para>

	<screen>  Login               pages/feet   runs    price
andy                        2.00    1   $  0.04
kelly                     182.00  105   $  3.64
mary                      118.00   35   $  2.36
root                       26.00   12   $  0.52
zhang                       9.00    1   $  0.18

total                     337.00  154   $  6.74</screen>

	<para>課金額を決めるために,
	  &man.pac.8; は <filename>/etc/printcap</filename> ファ
	  イルの <literal>pc</literal>
	  項目で指定された値 (デフォルト値は200, すなわち1
	  ページ当たり2セント)
	  を使います. この項目で, 印字物に課金したい
	  と思う1ページ当たり,
	  または, 1フィート当たりの価格を100分の1セ
	  ント単位で指定します.
	  &man.pac.8; を <option>-p</option> オプション付きで起動
	  すると, この値を置き換えることができます.
	  この <option>-p</option> オプショ
	  ンで指定する額の単位は,
	  100分の1セント単位ではなく, ドル単位で
	  す. 例えば, 次の指定では,
	  1ページ当たりの単価が1ドル50セントに
	  なります.

	  <screen>&prompt.root; <userinput>pac -p1.50</userinput></screen>

	  このオプションを使うと,
	  実際の課金額を集計することができます.</para>

	<para>最後に, <command>pac -s</command>
	  を起動すると, 課金情報は課金データ累計ファ
	  イルに保存されます.
	  このファイルの名前は, プリンタの課金データ
	  ファイルの後ろに
	  <literal>_sum</literal> を付けたものとなります. そして, 課
	  金データファイルは削除されます. 次に
	  &man.pac.8; が起動されると,
	  その時点までの累計金額を得るために,
	  課金データ累計ファイルが読
	  み込まれ, 通常の課金データファイルからの情報に
	  加算されます.</para>
      </sect3>

      <sect3>
	<title>印字されたページ数をどのように数えるか?</title>

	<para>課金を, リモートホストからの印字でさえも,
	  正確におこなうため には,
	  ジョブで使用された紙が何ページであるかを特定でき
	  る必要があります. このことは, プリンタ利用に対する課金
	  をおこなう上の根本的な問題です.</para>

	<para>プレインテキストのジョブの場合, 問題を解決するのはさほ
	  ど難しくはありません. ジョブが何行であったかを数え, プ
	  リンタがサポートしている紙1ページに印字できる最大の行
	  数と比較すればよいのです. 重ね打ちするために利用される
	  ファイル中のバックスペース文字や, 物理的に複数の行に渡
	  る長い論理行に対する取り扱いを
	  忘れずにおこなってください.</para>

	<para>(「<link
	    linkend="printing-advanced-lpf">テキストフィルタ
	    lpf</link>」で紹介した) テキストフィルタ
	  <command>lpf</command> では,  課金をおこなうときに,
	  これらの取り扱いをおこなってくれます. 課
	  金をおこなうために必要なテキストフィルタを作成している方は,
	  <command>lpf</command>
	  のソースコードが参考になるでしょう.</para>

	<para>これに対して, 他のファイル形式の処理はどのようにすれば
	  よいのでしょうか.</para>

	<para>まず, DVI から LaserJet, または, DVI から PostScript
	  への変換の場合, フィルタが <command>dvilj</command> や
	  <command>dvips</command> の 出力メッセージを解析することで,
	  何ページ分の変換がおこなわ れたかを知ることができます.
	  他のファイル形式とその変換 プログラムに関しても,
	  同様のことができるかもしれません.</para>

	<para>しかし, この方式には問題点があります. それは, 変換され
	  たページがすべて印字されるとは限らないということです. 例
	  えば, プリンタが紙詰まりを起こしたり, トナー切れになっ たり,
	  はたまた, 爆発したりするかもしれません. そのよう
	  な状況により印字が途中で中止されたとしても, この方式で は,
	  ユーザは全ページ分の料金を課されてしまうのです.</para>

	<para>それでは, どのような対策をたてることができるのでしょう
	  か.</para>

	<para><emphasis>正確な</emphasis>
	  課金をおこなうための唯一の<emphasis>確実な</emphasis>方法は,
	  何 ページ印字したのかを知らせることができるプリンタを入手
	  し, これをシリアルポートかネットワークに接続することで す.
	  ほとんどすべての PostScript プリンタではこの概念
	  がサポートされています. 他のプリンタも同様です (Imagen
	  レーザプリンタをネットワーク接続するなど). それぞれの
	  プリンタのフィルタを, ジョブを印字した後で印字ページ数
	  を得るように, 変更してください. そして, 課金情報はここ
	  で得られた値<emphasis>のみに</emphasis>
	  基づいて記録してください. 行数 を数えたり,
	  エラーが生じやすいファイルの調査は必要とさ れません.</para>

	<para>もちろん, 気前よく印字料
	  金をすべて無料にすることもできます.</para>
      </sect3>
    </sect2>
  </sect1>

  <sect1 id="printing-using">
    <title>プリンタを使う</title>

    <para>この節では, FreeBSD で設定したプリンタを使う方法について説明
      します. ここでは, ユーザレベルでのコマンドを概説します. </para>

    <variablelist>
      <varlistentry><term>&man.lpr.1;</term>
	<listitem>
	  <para>印字をおこないます.</para>
	</listitem>
      </varlistentry>

      <varlistentry><term>&man.lpq.1;</term>
	<listitem>
	  <para>プリンタキューを調べます.</para>
	</listitem>
      </varlistentry>

      <varlistentry><term>&man.lprm.1;</term>
	<listitem>
	  <para>プリンタキューにあるジョブを削除します.</para>
	</listitem>
      </varlistentry>
    </variablelist>

    <para>管理者用コマンド &man.lpc.8; もありますが,
      これは 「<link linkend="printing-lpc">プリンタを管理する</link>」
      に記
      します. このコマンドは, プリンタやそのキューの制御のために用い
      られます.</para>

    <para>&man.lpr.1;, &man.lprm.1;, そして &man.lpq.1; の 3
      コマンドは, <option>-P<replaceable>printer-name</replaceable></option>
      オプションをとり, これによって,
      <filename>/etc/printcap</filename> のように操作の対象となる
      プリンタやキュー
      を指定します. これによって, 様々なプリンタに対してジョブを送る
      , 取り消す, 調査することができます.
      <option>-P</option> が使われなかった場
      合は, これらのコマンドは
      <envar>PRINTER</envar> 環境変数で指定されたプリンタ
      を使用します.
      そして, <envar>PRINTER</envar> 環境変数がなかった場合は, これ
      らのコマンドはデフォルトのプリンタ
      <literal>lp</literal> を使います.</para>

    <para>以下では, <emphasis>デフォルトプリンタ</emphasis>
      という用語が意味するプリンタ は, <envar>PRINTER</envar>
      環境変数で指定されたプリンタ, もしくは, <envar>PRINTER</envar>
      環境変数がない場合は, <literal>lp</literal>
      という名前のプリンタです.</para>

    <sect2 id="printing-lpr">
      <title>印字する</title>

      <para>ファイルを印字するためには,
	次のように入力してください.</para>

      <screen>&prompt.user; <userinput>lpr <replaceable>filename</replaceable> <replaceable>...</replaceable></userinput></screen>

      <para>これにより,
	入力されたファイルのそれぞれをデフォルトのプリンタ
	から印字します. ファイル名が与えられなかった場合,
	&man.lpr.1;
	は標準入力から印字するデータを読み込みます. 例えば, 次のコマン
	ドにより, ある重要なシステムファイルが印字されます. </para>

      <screen>&prompt.user; <userinput>lpr /etc/host.conf /etc/hosts.equiv</userinput></screen>

      <para>印字させるプリンタを選択するためには,
	次のように入力します. </para>

      <screen>&prompt.user; <userinput>lpr -P <replaceable>printer-name</replaceable> <replaceable>filename</replaceable> <replaceable>...</replaceable></userinput></screen>

      <para>次の例では, プリンタ <literal>rattan</literal> に,
	カレントディレクトリにあ
	るファイルの詳細なリストを印字しています. </para>

      <screen>&prompt.user; <userinput>ls -l | lpr -P rattan</userinput></screen>

      <para>上記の &man.lpr.1; コマンドではファイル名の指定がないので,
	<command>lpr</command> は標準入力から印字するデータ,
	この場合, <command>ls -l</command>
	コマンドの出力, を読み込みます.</para>

      <para>&man.lpr.1; コマンドでは,
	出力の整形を制御したり, ファイル変換を
	適用したり, 複数部数のコピーを作成したり, などといた様々な幅広
	いオプションを受け付けることもできます.
	詳細については,
	「<link linkend="printing-lpr-options">
	  その他の印字オプション</link>」をご
	覧ください.</para>
    </sect2>

    <sect2 id="printing-lpq">
      <title>ジョブの処理状況を調べる</title>

      <para>&man.lpr.1; コマンドを使って印字をする場合, プリントしようと
	するデータは<quote>プリントジョブ</quote>
	と呼ばれる箱に一緒に置かれ, これが LPD スプーリングシステムに送られます.
        プリンタにはそれぞれジョブ用のキューがあり,
	送られてきたジョブはあなたや他のユーザからの別のジョブと一緒にそのキューで並んで,
	処理される順番を待ちます.
	プリンタは到着順にこれらのジョブの印字をおこないます.</para>

      <para>デフォルトプリンタのキューの状態を表示するには,
	&man.lpq.1; と入
	力します. プリンタを指定するときは,
	<option>-P</option> オプションを使い
	ます. 例えば, 次のコマンド</para>

      <screen>&prompt.user; <userinput>lpq -P bamboo</userinput></screen>

      <!-- kuriyama - hostid should literal -->
      <para>は, プリンタ <hostid>bamboo</hostid>
	のキューの状態を表示します. この  <command>lpq</command>
	コマンドの出力結果の例を次に示します. </para>

      <screen>bamboo is ready and printing
Rank   Owner    Job  Files                              Total Size
active kelly    9    /etc/host.conf, /etc/hosts.equiv   88 bytes
2nd    kelly    10   (standard input)                   1635 bytes
3rd    mary     11   ...                                78519 bytes</screen>

      <para>この例では, <literal>bamboo</literal>
	のキューに3つのジョブがあることが分か ります.
	最初のジョブはユーザ kelly からのものであり,
        <quote>ジョブ番号</quote> 9 が割り当てられています.
	プリンタのすべてのジョブには一意
	なジョブ番号が付けられています. ほとんどの場合, このジョブ番号
	は無視することができますが, ジョブをキャンセルするときにはこの
	番号が必要になります. このことの詳細については, 「<link
	  linkend="printing-lprm">ジョブの削除</link>
	」をご覧ください.</para>

      <para>ジョブ番号9のジョブは2つのファイルを処理します. すなわち,
	&man.lpr.1;
	のコマンドラインに複数のファイル名が与えられたときは,
	1つのジョブとして扱われるのです. このジョブは, 現在, アクティ
	ブジョブ (<quote>Rank</quote>
	の欄の <literal>active</literal> という後に注目) になってい
	ます. これは, プリンタからそのジョブが現在印字されているはずで
	あることを意味しています. 2番目のジョブでは,
	&man.lpr.1; コマン
	ドに標準入力からデータが与えられています.
	3番目のジョブはユー
	ザ <username>mary</username> から与えられました.
	このジョブのサイズはとても大きくなっ
	ています. 彼女がプリントしようとしたファイルのパス名はここで表
	示させるには長すぎるため,
	&man.lpq.1; コマンドはドットを3つだけ
	表示しています.</para>

      <para>&man.lpq.1; からの
	出力で一番最初の行もまた有益な情報を与えていま
	す. この行から, プリンタが現在何をしているか (あるいは, 少なく
	とも LPD がプリンタが
	していると思っていること) が分かります.</para>

      <para>&man.lpq.1; コマンドは
	<option>-l</option> オプションもサポートしています. こ
	れにより,
	詳しい情報が表示されます. <command>lpq -l</command> の実行例を次
	に示します. </para>

      <screen>waiting for bamboo to become ready (offline ?)
kelly: 1st				 [job 009rose]
       /etc/host.conf			 73 bytes
       /etc/hosts.equiv		         15 bytes

kelly: 2nd				 [job 010rose]
       (standard input)		         1635 bytes

mary: 3rd				 [job 011rose]
      /home/orchid/mary/research/venus/alpha-regio/mapping 78519 bytes</screen>
    </sect2>

    <sect2 id="printing-lprm">
      <title>ジョブの削除</title>

      <para>印字するようジョブを
	送った後で印字を中断したくなったときは,
	&man.lprm.1; コマンドで,
	キューの中からそのジョブを削除することが
	できます. 大抵の場合, アクティブジョブでさえも
	&man.lprm.1; を使っ
	て削除することができますが,
	そのジョブの一部またはすべてが印字さ
	れてしまうかもしれません.</para>

      <para>デフォルトプリンタへのジョブを削除するためには, 最初に,
	&man.lpq.1; を使ってそのジョブ番号を調べます.
	すなわち, それから,
	次のように入力して, ジョブを削除します. </para>

      <screen>&prompt.user; <userinput>lprm <replaceable>job-number</replaceable></userinput></screen>

      <para>特定のプリンタへのジョブを削除するときは,
	<option>-P</option> オプション
	を使ってそのプリンタを指定します.
	例えば, プリンタ <hostid>bamboo</hostid>
	のキューからジョブ番号
	10のジョブを削除するには次のようにします. </para>

      <screen>&prompt.user; <userinput>lprm -P bamboo 10</userinput></screen>

      <para>&man.lprm.1; コマンドには略記法がいくつかあります. </para>

      <variablelist>
	<varlistentry><term>lprm -</term>
	  <listitem>
	    <para>あなたが (デフォルトプリンタへ)
	      送ったジョブをすべて削除し ます.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term>lprm <replaceable>user</replaceable></term>
	  <listitem>
	    <para>ユーザ <replaceable>user</replaceable> が
	      (デフォルトプリンタへ) 送ったジョブ をすべて削除します.
	      他のユーザのジョブを削除できるのはスー パユーザだけです.
	      あなたは, あなた自身のジョブしか削
	      除することはできません.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term>lprm</term>
	  <listitem>
	    <para>ジョブ番号もユーザ名もシンボル
	      <option>-</option>も指定されない
	      ときは, &man.lprm.1; は現在のアクティブジョブを, そのジョ
	      ブを送ったのがあなた自身であるときに限り, デフォルトプ
	      リンタから削除します. ただし, スーパユーザは任意のア
	      クティブジョブを削除することができます.</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para>上記の略記法をデフォルトプリンタではなく
	特定のプリンタに対して おこなうときは, <option>-P</option>
	オプションでそのプリンタを指定するだけよ いのです. 例えば,
	プリンタ <literal>rattan</literal> のキューへあなたが送っ
	たジョブをすべて削除するためには次のようにします.</para>

      <screen>&prompt.user; <userinput>lprm -P rattan -</userinput></screen>

      <note>
	<para>ネットワーク環境で作業をしている場合, あるホストか
	  ら送られたプリンタジョブは, これを送ったホストで
	  &man.lprm.1; を
	  使った場合に限って,
	  これを削除することができます. 他のホストで
	  同じプリンタを使えたとしても,
	  このジョブを削除することはできま
	  せん.
	  次の例では, 他ホストからジョブを削除することを試みていま
	  す. </para>

	<screen>&prompt.user; <userinput>lpr -P rattan myfile</userinput>
&prompt.user; <userinput>rlogin orchid</userinput>
&prompt.user; <userinput>lpq -P rattan</userinput>
Rank   Owner	  Job  Files                          Total Size
active seeyan	  12	...                           49123 bytes
2nd    kelly      13   myfile                         12 bytes
&prompt.user; <userinput>lprm -P rattan 13</userinput>
rose: Permission denied
&prompt.user; <userinput>logout</userinput>
&prompt.user; <userinput>lprm -P rattan 13</userinput>
dfA013rose dequeued
cfA013rose dequeued
	</screen>
      </note>
    </sect2>

    <sect2 id="printing-lpr-options">
      <title>その他の印字オプション</title>

      <para>&man.lpr.1; コマンドには, テキストの整形や,
	図や他のファイル形
	式の変換, 複数部コピーの生成, ジョブの扱いなどをを制御すること
	ができます.
	この節では, これに関するオプションについて記してい
	ます.</para>

      <sect3 id="printing-lpr-options-format">
	<title>整形と変換に関するオプション</title>

	<para>以下の &man.lpr.1; 用のオプションはジョブにおける
	  ファイルの
	  整形の制御に関するものです.
	  このオプションは, ジョブにプレイン
	  テキストが含まれない場合や
	  &man.pr.1; ユーティリティを使ってプレイ
	  ンテキストを整形する場合に用いてください.</para>

	<para>次の例では, プリンタ
	  <literal>bamboo</literal> に (TeX 組版システムによる)
	  DVI ファイル
	  <filename>fish-report.dvi</filename> を印字しています. </para>

	<screen>&prompt.user; <userinput>lpr -P bamboo -d fish-report.dvi</userinput></screen>

	<para>このオプションは,
	  ジョブに含まれるすべてのファイルに対して適用さ れます.
	  したがって, 1つのジョブに (例えば) DVI ファイルと ditroff
	  ファイルを混在させることはできません. その代わりに,
	  ファイルを 形式毎に別々のジョブに分け,
	  それぞれのジョブでその形式用の変換
	  オプションを使って印字してください.</para>

	<note>
	  <para><option>-p</option> と <option>-T</option>
	    を除くすべてのオプションを使用 するためには,
	    出力先プリンタ用の変換フィルタが必要です. 例えば,
	    <option>-d</option> オプションを使用するには, DVI
	    用の変換フィルタが必要 です. 詳細については, 「<link
	      linkend="printing-advanced-convfilters">
	      変換フィルタ</link>」で説明しています.</para>
	</note>

	<variablelist>
	  <varlistentry><term><option>-c</option></term>
	    <listitem>
	      <para>cifplot ファイルを印字します.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-d</option></term>
	    <listitem>
	      <para>DVI ファイルを印字します.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-f</option></term>
	    <listitem>
	      <para>FORTRAN プログラムを印字します.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-g</option></term>
	    <listitem>
	      <para>plot のデータを印字します.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-i <replaceable>number</replaceable></option></term>
	    <listitem>
	      <para>出力に対して, <replaceable>number</replaceable>
		カラム分の字下げをおこないます.
		<replaceable>number</replaceable> が省略されると,
		8カラム分字下げされます.
		このオプションはある変換フィルタと一緒の指定されたとき
		のみに機能します.</para>

	      <note>
		<para><option>-i</option>
		  と数字の間に空白を入れてはいけません.</para>
	      </note>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-l</option></term>
	    <listitem>
	      <para>制御文字を含む文字通りの
		テキストデータを印字します.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-n</option></term>
	    <listitem>
	      <para>ditroff (device independent troff) データ
		を印字します.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term>-p</term>
	    <listitem>
	      <para>印字する前に &man.pr.1;
		によってプレインテキストを整形し
		ます. 詳細については &man.pr.1; をご覧ください.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-T <replaceable>title</replaceable></option></term>
	    <listitem>
	      <para>&man.pr.1; コマンドにより生成されるヘッダを,
		ファイル名の
		代わりに <replaceable>title</replaceable> とする.
		このオプションは, <option>-p</option>
		と一緒に使ったときのみ機能する.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-t</option></term>
	    <listitem>
	      <para>troff データを印字します.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term><option>-v</option></term>
	    <listitem>
	      <para>ラスタのデータを印字します.</para>
	    </listitem>
	  </varlistentry>
	</variablelist>

	<para>次の例では, &man.ls.1; の
	  マニュアルを美しく整形したものをデフォ
	  ルトプリンタで印字しています. </para>

	<screen>&prompt.user; <userinput>zcat /usr/share/man/man1/ls.1.gz | troff -t -man | lpr -t</userinput></screen>

	<para>&man.zcat.1; コマンドで
	  &man.ls.1; のマニュアルのソースファイルの圧縮を復元し, これを
	  &man.troff.1; コマンドに渡しています.
          これによりソースファイルが整形され
          GNU troff の形式となります.
          その結果は &man.lpr.1; に渡され,
	  LPD スプーラへジョブの要求が発せられます.
          &man.lpr.1; には
	  <option>-t</option> オプションが使われているため,
          スプーラでジョブを印字したときに GNU troff
          の形式から, デフォルトプリンタ解釈できる形式へと変換されます.</para>
      </sect3>

      <sect3 id="printing-lpr-options-job-handling">
	<title>ジョブに関するオプション</title>

	<para>以下のオプションは, &man.lpr.1; によって, そのジョブを特殊
	  な扱いにするよう LPD に指示するためのものである.</para>

	<variablelist>
	  <varlistentry><term>-# <replaceable>copies</replaceable></term>
	    <listitem>
	      <para>ジョブに含まれるファイルのそれぞれを
		1部だけ印字するの ではなく,
		<replaceable>copies</replaceable>
		部のコピーを生成させるものです.  管理者によっては,
		プリンタの消耗を避け, コピー機による
		複製を奨励するためにこのオプションの使用が禁止されてい
		るかもしれません. これに関しては, 「<link
		  linkend="printing-advanced-restricting-copies">
		  複数部のコピーの印字を制限する
		</link>」をご覧ください.</para>

	      <para>次の例では, デフォルトプリンタで
		<filename>parser.c</filename> を3 部コピーし, 次に,
		<filename>parser.h</filename> を3部コピーしています.
	      </para>

	      <screen>&prompt.user; <userinput>lpr -#3 parser.c parser.h</userinput></screen>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term>-m</term>
	    <listitem>
	      <para>印字ジョブが完了した後で, メールを送ります.
		このオプショ ンを付けると, LPD
		システムはジョブの扱いが終了したと きに,
		あなたのアカウントにメールを送ります. メールのメッ
		セージには, ジョブが正常終了したのか, あるいは, 何か異
		常があり, (しばしば)
		その異常が何であったのかが書かれて います.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term>-s</term>
	    <listitem>
	      <para>印字ファイルをスプールディレクトリにコピーせず,
		代わりに,
		シンボリックリンクを作成するよう指示します.</para>

	      <para>印字させるジョブのサイズが大きいとき, このオプショ
		ンを使うと便利かもしれません. このオプションにより,
		スプー ルディレクトリの容量が節約されます (それに,
		巨大なジョ
		ブのお陰でスプールディレクトリのあるファイルシステムの
		空き容量がなくなってしまうかもしれません). さらに,
		LPD
		がいちいちすべてのデータをコピーする必要がなくなりま
		すので, 時間の節約にもなります.</para>

	      <para>ただし, 欠点もあります. LPD
		はオリジナルのファイルを 直接参照するので,
		印字が終了するまでそのファイルを変更
		したり削除することができません.</para>

	      <note>
		<para>リモートのプリンタで印字している場合, LPD  は,
		  結局のところ, ローカルホストからリモートホストにファ
		  イルをコピーする必要があります. したがって,
		  <option>-s</option> オプ
		  ションはローカルのスプーリングディレクトリの
		  空き容量を 節約するだけで,
		  リモート側では節約されません. それに も関わらず,
		  このオプションはそれでも有用です.</para>
	      </note>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term>-r</term>
	    <listitem>
	      <para>ジョブに含まれるファイルを,
		スプーリングディレクトリに
		ファイルをコピーした後に削除します. もしくは,
		<option>-s</option>  オプションと一緒に使われた場合は,
		印字終了後に削除され ます.
		このオプションの使用には十分注意して下さい.</para>
	    </listitem>
	  </varlistentry>
	</variablelist>
      </sect3>

      <sect3 id="printing-lpr-options-misc">
	<title>ヘッダページ用オプション</title>

	<para>以下のオプションにより,
	  ジョブのヘッダページに通常印字さ
	  れるテキストを
	  &man.lpr.1; に調整させることができます. 対象のプリ
	  ンタからヘッダページが出力されない場合は,
	  これらのオプションは
	  何の効力も持ちません.
	  ヘッダページの設定に関する情報については,
	  「<link linkend="printing-advanced-header-pages">
	    ヘッダページ</link>」を参照してください.</para>

	<variablelist>
	  <varlistentry><term>-C <replaceable>text</replaceable></term>
	    <listitem>
	      <para>ヘッダページに印字されるホスト名を
		<replaceable>text</replaceable> に置き換 えます. なお,
		ホスト名の場所には, 通常, ジョブの要求が
		あったホストの名前が印字されます.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term>-J <replaceable>text</replaceable></term>
	    <listitem>
	      <para>ヘッダページに印字されるジョブ名を
		<replaceable>text</replaceable> に置き換 えます.
		ジョブ名の場所には, 通常, ジョブの最初のファイ ル名,
		または, 標準入力からデータが印字されたときは
		<filename>stdin</filename>が印字されます.</para>
	    </listitem>
	  </varlistentry>

	  <varlistentry><term>-h</term>
	    <listitem>
	      <para>ヘッダページを出力を禁止します.</para>

	      <note>
		<para>サイトによっ ては,
		  そのヘッダページの生成方法により, このオプション
		  の効果が現れないかもしれません. 詳細は,  「<link
		    linkend="printing-advanced-header-pages">
		    ヘッダページ</link>」をご覧ください.</para>
	      </note>
	    </listitem>
	  </varlistentry>
	</variablelist>
      </sect3>
    </sect2>

    <sect2 id="printing-lpc">
      <title>プリンタを管理する</title>

      <para>プリンタの管理者として, プリンタの設置, 設定,
	そして, それ
	らのテストをおこなう必要がありました.
	&man.lpc.8; コマンドにより,
	これまでとは別な管理方法がプリンタと対話的におこなわれます.
	&man.lpc.8; により, 次のことが可能となります.</para>

      <itemizedlist>
	<listitem>
	  <para>プリンタの起動, 停止をおこなう.</para>
	</listitem>

	<listitem>
	  <para>キューへの入力の許可, 禁止をおこなう.</para>
	</listitem>

	<listitem>
	  <para>それぞれのキューにあるジョブの順番を変更する.</para>
	</listitem>
      </itemizedlist>

      <para>最初に用語に関する注意をしておきます.
	プリンタが<emphasis>停止してい る</emphasis>とは,
	キューの中にあるどのジョブも印字されることがない状態
	を言います. この状態においても,
	ユーザはまだジョブの要求をおこなう ことができますが,
	これらのジョブはキューの中で,
	プリンタが<emphasis>スタートする</emphasis>状態になるまで,
	あるいは, キューの内容が削除され
	るまで待たされることになります.</para>

      <para>キューが<emphasis>禁止状態にある</emphasis>とは, (root
	以外の) すべてのユーザが
	プリンタにジョブを要求することができない状態のことを言います.
	キューが<emphasis>許可状態にある</emphasis>場合は,
	ジョブの入力が許可されます.
	キューが<emphasis>禁止状態にある</emphasis>場合でも,
	プリンタを<emphasis>スタートす
	  る</emphasis>状態にすることは可能です. この場合は,
	キューが空になるまで,
	キュー内のジョブの印字が続けられます.</para>

      <para>一般的に,
	&man.lpc.8; コマンドを使用するには root の権限を持って
	いる必要があります. 一般のユーザも
	&man.lpc.8; コマンドを使うこと
	はできますが, プリンタの状態を取得することとハングしたプリンタ
	を再スタートすることだけに使用が制限されています.</para>

      <para>以下に,
	&man.lpc.8; コマンドに関する説明の要約を述べます. ほとん
	どのコマンドでは, 操作対象となるプリンタを指定するため
	<replaceable>printer-name</replaceable> 引数を与えます.
	<replaceable>printer-name</replaceable> の代わり
	に <literal>all</literal> が与えられると, 操作は
	<filename>/etc/printcap</filename> 内に
	ある全プリンタに対しておこなわれることになります.</para>

      <variablelist>
	<varlistentry><term><command>
	      abort <replaceable>printer-name</replaceable></command></term>
	  <listitem>
	    <para>現在のジョブをキャンセルし, プリンタを停止させます.
	      キュー が許可状態にある場合は,
	      ユーザはまだジョブを入力する ことができます.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term><command>
	      clean <replaceable>printer-name</replaceable></command></term>
	  <listitem>
	    <para>プリンタのスプーリングディレクトリから,
	      ジョブの古いファ イルを削除します. 状況によって,
	      とりわけ, 印字途中でエ ラーが発生していたり,
	      管理操作が頻発していた場合には,
	      ジョブで作られたファイルを LPDが完全に削除しないことが
	      あります. このコマンドでは, スプーリングディレクトリに
	      入っていないファイルを見つけ出し,
	      それを削除しています.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term><command>
	      disable <replaceable>printer-name</replaceable></command></term>
	  <listitem>
	    <para>キューに新しいジョブを入れることを禁止します.
	      プリンタ がスタート状態にあるときは,
	      キューに残っているジョブの 印字は続けられます. ただし,
	      キューが禁止状態にあったと しても, スーパーユーザ (root)
	      は常にジョブを入力するこ とができます.</para>

	    <para>このコマンドは,
	      新しいプリンタやフィルタを設置している
	      間に使用すると有用です. すなわち, キューを禁止状態にし
	      ておくと, root によるジョブのみが入力されます. そして,
	      その他のユーザは, テストが完了し,
	      <command>enable</command> コマン
	      ドでキューが再度許可状態になるまで, ジョブの入力はでき
	      なくなります.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term><command>
	      down <replaceable>printer-name</replaceable>
	      <replaceable>message</replaceable></command></term>
	  <listitem>
	    <para>プリンタをダウンさせます. これは,
	      <command>disable</command> をおこなっ
	      た後で, <command>stop</command> をおこなった場合と
	      等価になります.
	      <replaceable>message</replaceable> は, ユーザが
	      &man.lpq.1; コマンドでプリンタ
	      のキューの状態を調べたり, <command>lpc status</command>
	      でプリンタの
	      状態を調べたときに, プリンタの状況として表示されるメッ
	      セージです.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term><command>
	      enable <replaceable>printer-name</replaceable></command></term>
	  <listitem>
	    <para>プリンタのキューを許可状態にします.
	      ユーザはジョブの入 力ができるようになりますが,
	      プリンタがスタートの状態に なるまでは,
	      プリンタからは何も印字されません.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term><command>
	      help <replaceable>command-name</replaceable></command></term>
	  <listitem>
	    <para><replaceable>command-name</replaceable>
	      コマンドのヘルプメッセージを表示しま
	      す. <replaceable>command-name</replaceable>
	      が指定されなかった場合は, 利用
	      できるコマンドの要約が表示されます.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term><command>
	      restart <replaceable>printer-name</replaceable></command></term>
	  <listitem>
	    <para>プリンタをスタートさせます. 通常のユーザは, LPD があ
	      る異常な状況でハングしたときに限り, このコマンドを使用
	      することができます. しかし, <command>stop</command>
	      または  <command>down</command> コマンドにより,
	      停止状態にあるプリンタをスター トさせることはできません.
	      <command>restart</command> コマンドは,
	      <command>abort</command> の後に <command>start</command>
	      をおこなったことと同じになり ます.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term><command>
	      start <replaceable>printer-name</replaceable></command></term>
	  <listitem>
	    <para>プリンタをスタートさせます.
	      プリンタのキューにあるジョ
	      ブを印字することでしょう.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term><command>
	      stop <replaceable>printer-name</replaceable></command></term>
	  <listitem>
	    <para>プリンタを停止します. プリンタは,
	      現在のジョブを終了さ せ, そして,
	      キューにあるその他のジョブは印字しません.
	      プリンタが停止状態にあったとしても, まだ, 許可状態にあ
	      るキューに対して, ジョブを送ることができます.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term><command>
	      topq <replaceable>printer-name</replaceable>
	      <replaceable>job-or-username</replaceable></command></term>
	  <listitem>
	    <para><replaceable>printer-name</replaceable>
	      のキューに対して, ジョブ番号
	      <replaceable>job</replaceable> のジョブ, または, ユーザ
	      <replaceable>username</replaceable> から送
	      られたジョブを置き換えて, キューの先頭に持ってきます.
	      このコマンドに関しては,
	      <replaceable>printer-name</replaceable> の代わりに
	      <literal>all</literal>
	      を使用することはできません.</para>
	  </listitem>
	</varlistentry>

	<varlistentry><term><command>
	      up <replaceable>printer-name</replaceable></command></term>
	  <listitem>
	    <para>プリンタをアップ状態にします. これの反対のコマンドが
	      <command>down</command> です. <command>start</command>
	      の次に <command>enable</command> をおこなっ
	      たことと等しくなります.</para>
	  </listitem>
	</varlistentry>
      </variablelist>

      <para>コマンドラインから上記のコマンドを入力すると,
	&man.lpc.8; はこれ
	を受け付けます. コマンドが入力されなかった場合は,
	&man.lpc.8; は
	対話モードに入り,
	<command>exit</command>, <command>quit</command>,
	または, ファイル終端
	文字が入力されるまでコマンドの入力ができます.</para>
    </sect2>
  </sect1>

  <sect1 id="printing-lpd-alternatives">
    <title>標準スプーラの代替品</title>

    <para>このマニュアルを最初から通読されている方ならば, ここまでで,
      FreeBSD 付属の LPD スプーリングシステムに関して知っておくべき
      ことすべてを学ばれたことと思います. 多分, このシステムに
      あるたくさんの欠点について認識できたことでしょう. すると,
      <quote>(FreeBSD 上で動作する)
      スプーリングシステムには他にどのような
      ものがあるのか</quote>という疑問が自然と湧いてきます.</para>

    <variablelist>
      <varlistentry><term>LPRng</term>
	<listitem>
	  <para>LPRng は, その称するところの意味は<quote>次世代の LPR</quote>
            です. これは PLP を完全に書き換えたものになっています.
            Patrick Powell と Justin Mason (PLP の主要な管理者)
            の共同で LPRng が作成されました.
            LPRng の主要サイトは
            <ulink url="ftp://dickory.sdsu.edu/pub/LPRng/"
                   >ftp://dickory.sdsu.edu/pub/LPRng/</ulink>
            です.</para>
	</listitem>
      </varlistentry>
    </variablelist>
  </sect1>


	<sect1 id="printing-troubleshooting">
	  <title>トラブルシューティング</title>

	  <para>&man.lptest.1; を使った簡単なテストをおこなった結果,
	    正しい出
	    力を得られずに, 以下に示すような出力が得られるかもしれ
	    ません. </para>

	  <variablelist>
	    <varlistentry><term>しばらくしたら出力される, または,
		紙の全体が出て こない</term>
	      <listitem>
		<para>プリンタは上で示されたような印字を
		  おこなったのですが, しばら くして止まってしまい,
		  動かなくなってしまいました. 印字
		  された結果をプリンタから取り出すためには,
		  プリンタにある PRINT REMAINING ボタン, また は, FORM
		  FEED ボタンを押す必要があるようです.</para>

		<para>この場合は,
		  おそらくジョブはプリントをする前に更にデー
		  タが送られてこないか待ち続けているのでしょう.
		  この問題を解決するためには, プリンタに FORM FEED
		  文字 (あるいは特定の必要な文字コード) を
		  送るテキストフィルタを使ってください.
		  プリンタ内部に残っ
		  たデータをプリンタにすぐに印字させるには, 普通は,
		  これ で十分です.
		  次のジョブが前のジョブの最終ページの中央の
		  どこかから印字を開始させないためにも,
		  紙の途中で印字の
		  ジョブが終了したかどうかを確認するのは有益です.</para>

		<para>シェルスクリプト
		  <filename>/usr/local/libexec/if-simple</filename>
		  を次のように変更して, プリンタへジョブを送信した後に
		  FORM FEED 文字を印字させるようにします. </para>

		<programlisting>
#!/bin/sh
#
# if-simple - Simple text input filter for lpd
# Installed in /usr/local/libexec/if-simple
#
# Simply copies stdin to stdout.  Ignores all filter arguments.
# Writes a form feed character (\f) after printing job.

/bin/cat &amp;&amp; printf "\f" &amp;&amp; exit 0
exit 2</programlisting>
	      </listitem>
	    </varlistentry>

	    <varlistentry><term><quote>階段効果</quote>が現れた</term>
	      <listitem>
		<para>次のような印字結果が得られた. </para>

		<programlisting>
!"#$%&amp;'()*+,-./01234
                            "#$%&amp;'()*+,-./012345
                                                         #$%&amp;'()*+,-./0123456</programlisting>

		<para>あなたは<emphasis>「階段効果」</emphasis>
		  の新たなる犠牲者になってしま いました. この原因は,
		  改行を表わすべき文字がなんであるか
		  の解釈が混乱していることにあります. UNIX
		  スタイルのオ ペレーティングシステムでは, 改行文字は
		  ASCII コード10 の line feed (LF)
		  の1文字が使われています. MS-DOS や OS/2などは ASCII
		  コード10の LF <emphasis>と</emphasis>,  ASCII コード
		  13の文字 (carriage return または CR)
		  をペアで使います.  (訳注:Machintosh では CR
		  のみで表現されています).  大抵のプリンタでは,
		  改行を表わすために MS-DOS の慣習にしたが
		  います.</para>

		<para>FreeBSD で印字する場合, 印字したテキストは LF
		  文字だけ が使われていました. プリンタでは LF
		  文字を見つけると,  紙を1行分送り出しました. しかし,
		  次の文字を印字するた
		  めの紙の水平方向の位置は維持されました. すなわち, CR
		  文字が意味することは,
		  次の文字を印字する位置を紙の左端
		  に動かすことです.</para>

		<para>FreeBSD
		  がプリンタに動作をして欲しいと思っている動作を
		  以下に示します. </para>

		<informaltable frame="none">
		  <tgroup cols="2">
		    <tbody>
		      <row>
			<entry>プリンタが CR を受け取ったとき</entry>
			<entry>CR 動作 (復帰) をおこなう</entry>
		      </row>

		      <row>
			<entry>プリンタが LF を受け取ったとき</entry>
			<entry>CR + LF 動作 (復帰, 改行) をおこなう</entry>
		      </row>
		    </tbody>
		  </tgroup>
		</informaltable>

		<para>このように動作させるための方法が
		  いくつかあります.</para>

		<itemizedlist>
		  <listitem>
		    <para>これらの文字の解釈を変えるために, プリンタ
		      の設定スイッチかコントロールパネルを操作する方
		      法. どのようにして設定をするかはプリンタのマニュ
		      アルを参照してください.</para>

		    <note>
		      <para>FreeBSD 以外のオペレーティン
			グシステムを切り替えて使う場合, CR と LF 文字
			の解釈をそのオペレーティングシステムで使われて
			いるようにプリンタを
			<emphasis>再設定</emphasis>する必要がある
			かもしれません. 以下に示す解決方法のいずれかを
			選ぶのがよいかもしれませんね.</para>
		    </note>
		  </listitem>

		  <listitem>
		    <para>自動的に LF を CR+LF に変換してくれる
		      FreeBSD 用のシリアルドライバを入手する方法. も
		      ちろん, このドライバはプリンタ専用に接続される
		      シリアルポート
		      <emphasis>のみ</emphasis>で動作します. この機能
		      を許可するためには,
		      <filename>/etc/printcap</filename> ファ
		      イルで対象プリンタの <literal>fs</literal>
		      項目で CRMOD ビッ トをセットします.</para>
		  </listitem>

		  <listitem>
		    <para>LF
		      文字の扱いを一時的に変更するための<emphasis>エ
			スケープコード</emphasis>をプリンタに送る方法.
		      プリンタ
		      がサポートしているかもしれないエスケープコード
		      については, プリンタのマニュアルを参照してくだ
		      さい. 適切なエスケープコードが見つかったら, 最
		      初にそのコードを送り, 次にプリントジョブを送信
		      するようにテキストフィルタを変更してください.
		    </para>

		    <para>次に, Hewlett Packard 社の PCL
		      エスケープコー
		      ドに対応しているプリンタのためのテキストフィル
		      タの例を示します. このフィルタでは, プリンタ に
		      LF 文字を LF と CR の2文字として扱わせます.
		      その後に, プリンタにジョブを送ります. 最後に,
		      ジョブの最終ページの紙を排出するため, FROM FEED
		      文字を送ります. このフィルタは Hewlett Packard
		      社のほとんどすべてのプリンタで機能するは
		      ずです.</para>

		    <programlisting>
#!/bin/sh
#
# hpif - Simple text input filter for lpd for HP-PCL based printers
# Installed in /usr/local/libexec/hpif
#
# Simply copies stdin to stdout.  Ignores all filter arguments.
# Tells printer to treat LF as CR+LF.  Ejects the page when done.

printf "\033&amp;k2G" &amp;&amp; cat &amp;&amp; printf "\f" &amp;&amp; exit 0
exit 2</programlisting>

		    <para>ホスト orchid にある
		      <filename>/etc/printcap</filename> の
		      例を以下に示します. ここには, 一番目のパラレル
		      ポートにプリンタ (Hewlett Packard LaserJet 3Si)
		      が一台接続されており, そのプリンタ名は
		      <hostid>teak</hostid> です. </para>

		    <programlisting>
#
#  /etc/printcap for host orchid
#
teak|hp|laserjet|Hewlett Packard LaserJet 3Si:\
        :lp=/dev/lpt0:sh:sd=/var/spool/lpd/teak:mx#0:\
        :if=/usr/local/libexec/hpif:</programlisting>
		  </listitem>

		  <listitem>
		    <note>
		      <para><emphasis>訳注:</emphasis> LF を CR+LF
			に置き換える cat コマンド
			を作る方法も当然考えられます. そして, このコマ
			ンドと, <emphasis
			  remap=tt>if-simple</emphasis> の cat の部分
			を置き換えればよいわけです. 具体的にどのように
			するかは, 読者への練習問題としましょう.</para>
		    </note>
		  </listitem>
		</itemizedlist>
	      </listitem>
	    </varlistentry>

	    <varlistentry><term>各行が重ね書きされてしまった</term>
	      <listitem>
		<para>プリンタは紙送りをまったくしませんでした.
		  テキストすべての行
		  がある行の上で重ねて印字されてしまいました.</para>

		<para>この問題は,
		  階段現象とは<quote>正反対</quote>な問題で, ほとんどま
		  れにしか起こりません. FreeBSDでは行末として扱われる
		  LF  文字が, 紙の左端に印字位置を復帰しますが,
		  紙送りはしな い CR 文字として扱われています.</para>

		<para>プリンタの設定スイッチかコントロールパネルを
		  使って,  LF と CR
		  の文字を次のような解釈をするようにしてください.
		</para>

		<informaltable frame="none">
		  <tgroup cols="2">
		    <thead>
		      <row>
			<entry>プリンタが受け取ったとき</entry>
			<entry>プリンタがおこなう</entry>
		      </row>
		    </thead>

		    <tbody>
		      <row>
			<entry>CR</entry>
			<entry>CR 動作 (復帰)</entry>
		      </row>

		      <row>
			<entry>LF</entry>
			<entry>CR + LF (復帰, 改行)</entry>
		      </row>
		    </tbody>
		  </tgroup>
		</informaltable>

		<note>
		  <para><emphasis>訳注:</emphasis> LF を CR+LF
		    に置き換える cat コマンドを作る方法
		    も当然考えられます. そして, このコマンドと,
		    <filename>if-simple</filename> の cat
		    の部分を置き換えればよいわけ です.
		    具体的にどのようにするかは, 読者への練習問題とし
		    ましょう.</para>
		</note>
	      </listitem>
	    </varlistentry>

	    <varlistentry><term>プリンタが文字を紛失してしまう</term>
	      <listitem>
		<para>印字しているのですが,
		  各行の2〜3文字が印字されません.
		  プリンタを動かせば動かすほど,
		  もっとたくさんの文字が紛 失されていき,
		  この問題は更に悪くなっていくかもしれませ
		  んでした.</para>

		<para>この問題は,
		  シリアルポートを通してコンピュータから送ら
		  れてくるデータの速度に,
		  プリンタがついていけないことに 起因します
		  (この問題は, パラレルポートに接続されたプリ
		  ンタでは発生することはありません).
		  この問題を克服する 方法が2つあります. </para>

		<itemizedlist>
		  <listitem>
		    <para>プリンタが XON/XOFF のフロー制御をサポート
		      している場合は, 項目 <literal>fs</literal> で
		      TANDEM ビット をセットして, FreeBSD
		      にこの機能を使用させて ください.</para>
		  </listitem>

		  <listitem>
		    <para>プリンタがキャリアフロー制御をサポートして
		      いる場合は, 項目 <literal>fs</literal> で MDMBUF
		      ビットをセッ トして下さい. それから,
		      プリンタとコンピュータ
		      を接続しているシリアルケーブルがキャリアフロー
		      制御用に正しく配線されたものかどうかを確認して
		      ください.</para>
		  </listitem>

		  <listitem>
		    <para>プリンタがフロー制御をまったく
		      サポートしていな い場合は, 項目
		      <literal>fs</literal> の NLDELAY と  TBDELAY,
		      CRDELAY, VTDELAY, BSDELA のいくつかのビッ
		      トを組み合わせて使い, プリンタへ送るデータの流
		      れに適当な遅延を加えてください.</para>
		  </listitem>
		</itemizedlist>
	      </listitem>
	    </varlistentry>


	    <varlistentry><term>プリンタは意味不明な
		文字列を印字した</term>
	      <listitem>
		<para>プリンタはランダムなゴミのように
		  見えるものを印字しまし たが,
		  意図したテキストは印字してくれませんでした.</para>

		<para>この問題は, 通常,
		  シリアルポートに接続したプリンタでの
		  通信パラメータの誤りからくる前項とは別の症状です.
		  <literal>br</literal> 項目の通信速度と
		  <literal>fs</literal> と <literal>fc</literal>
		  項目のパリ ティビットの設定を共に調べてみてください.
		  また, プリン タでの設定が
		  <filename>/etc/printcap</filename>
		  ファイルで設定した
		  内容と一致しているかどうかも確認してください.</para>

		<note>
		  <para><emphasis>訳注:</emphasis> simple-if
		    のような単純なフィルタだけの状態で, 日
		    本語を含むテキストを印字しようとした場合にも,
		    シリアル ポート, パラレルポートの使用に関係なく,
		    このような症状 は見られます. 日本語プリンタの場合,
		    漢字コードそのもの
		    を送信しただけでその漢字を印字してくれるものは,
		    少なく とも訳者は見たことがありません.
		    漢字を印字するための制御
		    コードを別途送信するフィルタが必要となります.
		    また, そ のようなフィルタを使用していても,
		    そのフィルタが想定し
		    てる漢字コードと異なった文書を
		    プリントしようとしたとき もこのような症状は出ます.
		    もちろん, これはプリンタ用の
		    言語を持たないプリンタの話で, PostScript プリンタ
		    などにプレインテキストを送信しても, 日本語対応,
		    非対応 に関らず, 意味不明な文字列が印字される
		    (もしくは, 何も 印字されない) ことでしょう.</para>
		</note>
	      </listitem>
	    </varlistentry>

	    <varlistentry><term>何も起きない</term>
	      <listitem>
		<para>もしプリンタが何の動作もしないのであれば,
		  ハード的な問 題ではなく, 多分 FreeBSD
		  の中に問題があります.
		  <filename>/etc/printcap</filename> ファイルで,
		  デバッグしているプ リンタのエントリに
		  (<literal>lf</literal> 項目で) ログファイルを取るよ
		  うに設定を追加してください. 例えば, プリンタ
		  <literal>rattan</literal>  用のエントリの項目
		  <literal>lf</literal> は次のようになります. </para>

		<programlisting>
rattan|line|diablo|lp|Diablo 630 Line Printer:\
        :sh:sd=/var/spool/lpd/rattan:\
        :lp=/dev/lpt0:\
        :if=/usr/local/libexec/if-simple:\
        :lf=/var/log/rattan.log</programlisting>

		<para>次に, もう一度印字をおこなってみます. そして,
		  発生したと思
		  われるエラーメッセージを見るためにログファイル
		  (上記の 例では,
		  <filename>/var/log/rattan.log</filename>)
		  を調べます. そこ で見られたメッセージを元に,
		  問題を解決してみてください.</para>

		<para>項目 <literal>lf</literal>
		  が指定されていない場合, LPD はデフォルト
		  のログファイルとして
		  <filename>/dev/console</filename> を使います.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</sect1>
</chapter>

<!--
     Local Variables:
     mode: sgml
     sgml-declaration: "../chapter.decl"
     sgml-indent-data: t
     sgml-omittag: nil
     sgml-always-quote-attributes: t
     sgml-parent-document: ("../book.sgml" "part" "chapter")
     End:
-->
