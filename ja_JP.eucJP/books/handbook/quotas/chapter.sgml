<!--
     The FreeBSD Documentation Project
     The FreeBSD Japanese Documentation Project

     Original revision: 1.14
     $FreeBSD: doc/ja_JP.eucJP/books/handbook/quotas/chapter.sgml,v 1.7 2000/02/19 03:11:13 kuriyama Exp $
-->

<chapter id="quotas">
  <title>ディスク クォータ</title>

  <para><emphasis>原作: &a.mpp;, 1996 年 2 月 26 日.</emphasis></para>

  <para><emphasis>訳: &a.jp.mihoko;, 1996 年 9 月 6 日.</emphasis></para>

  <para>クォータシステムは,
    オペレーティングシステムのオプション機能で,
    各ファイルシステム上で ユーザやグループのメンバが使用するディスク
    スペースの総量を規制したり, 作成できるファイルの個数を制限したりす
    ることができます. この機能は, 各ユーザ,
    各グループごとに使用できる資源の総量を制限で
    きるようなタイムシェアリングシステム上で
    もっともよく使用されていま す. これは, 一人のユーザが,
    使用可能な全てのディスクスペースを使い
    きってしまうことを防止できます.</para>

  <sect1>
    <title>ディスククォータを使用するための設定</title>

    <para>ディスククォータを使用しようとする前に,
      あなたが使用しているカー
      ネルで, クォータが組み込まれているかどうかを
      確認する必要があります.
      クォータを使用できるカーネルを構築するためには,
      カーネルコンフィギュ レーションファイルに,
      次の行を追加してください:</para>

    <programlisting>
options QUOTA</programlisting>

    <para>標準の <filename>GENERIC</filename>
      カーネルでは, この機能は有効になっていません.
      したがって, ディスククォータを使用するためには,
      カーネルをコンフィグレーションして構築しなおし, そのカーネ
      ルをインストールしなければいけません. カーネルの構築方法について
      の詳細情報は, <link linkend="kernelconfig">FreeBSD
	カーネルのコンフィグレーション</link>
      を参照してください.</para>

    <para>次に, <filename>/etc/rc.conf</filename> へ
    次の行を追加すれば設定は完了です.
    </para>

      <programlisting>
enable_quotas=YES</programlisting>

    <para>また, 起動時の動作をさらに細かく制御するために,
      もう一つの変数が用意されています.
      quota は通常, 起動時に <command>quotacheck</command> プログラムを使って
      各ファイルシステム全体のチェックをします.
      この <command>quotacheck</command> が行なうチェックによって,
      quota データベース中のデータが, 実際のファイルシステムの状態を
      正確に反映していることを保証するわけです.
      しかし, この作業には長い時間がかかるため, その結果
      起動時間が異常なほど長くなってしまいます.
      もし, このステップを飛ばしたい場合には,
      次の変数を使って設定することが可能です.
      </para>
      
      <programlisting>
check_quotas=NO</programlisting>

    <para>もし FreeBSD 3.2-RELEASE 以前のリリースを使っているなら,
      設定はもっと簡単です. <filename>/etc/rc.conf</filename> にある
      次の部分を変更して下さい.
      </para>

    <programlisting>
check_quotas=YES</programlisting>

    <para>最後に, 各ファイルシステム毎にディスククォータを設定する
      ために, ファイル <filename>/etc/fstab</filename>
      を編集する必要があります.
      全てのファイルシステムに対して,
      ユーザ又はグループのいずれかのクォー タ
      を設定することも,
      ユーザとグループの両方のクォータを設定すること
      もできます.</para>

    <para>ファイルシステム上で, ユーザ毎のクォータを設定するためには,
      <literal>userquota</literal> オプションを, ファイル
      <filename>/etc/fstab</filename> の中 で,
      クォータを設定したいファイルシステムの
      エントリののオプションフィー ルドに追加してください.
      例えば:</para>

    <programlisting>
/dev/da1s2g    /home    ufs rw,userquota 1 2</programlisting>

    <para>同様に, グループのクォータを設定するためには,
      <literal>groupquota</literal> オプションを
      <literal>userquota</literal> の代わりに使用 してください.
      ユーザとグループの両方のクォータを設定するためには,
      次のようにエントリを変更してください:</para>

    <programlisting>
/dev/da1s2g    /home    ufs rw,userquota,groupquota 1 2</programlisting>

    <para>デフォルトでは, クォータファイルは ファイルシステムの root
      ディ レクトリ上に, ユーザとグループのクォータに対して それぞれ
      <filename>quota.user</filename> と
      <filename>quota.group</filename> という名前で置いてあり
      ます. 詳細情報は, <command>man fstab</command> を御覧ください.
      man
      ページには, クォータファイルを別な場所に置くことができると書い
      てありますが, さまざまな
      クォータユーティリティのうち, この機能を
      適切に処理できていないものがあるので,
      クォータファイルをデフォルト
      の場所以外に置くことは勧められません.</para>

    <para>ここまで準備ができたら, 新しいカーネルを使って,
      システムを立ち 上げ直してください. <filename>/etc/rc</filename>
      ファイルが, 自動的に適切なコマンドを起動してくれ, あなたが
      <filename>/etc/fstab</filename>
      ファイルで使用可能にした全てのクォー
      タに対して, 初期クォータファイルを作成してくれます.
      したがって, 手動で サイズ 0
      のクォータファイルを作成する必要はあり ません.</para>

    <para>通常の作業の流れでは, 手動で <command>quotacheck</command>,
      <command>quotaon</command>, または <command>quotaoff</command>
      コマンドを起動すべきで はありません. しかしながら,
      それらの作業について詳しく知りたい場合に は, man
      ページを御覧ください.</para>
  </sect1>

  <sect1>
    <title>クォータ制限の設定</title>

    <para>一旦システムのクォータを有効に設定したら,
      本当にクォータが使用可能になっていることを確かめてください.
      これを簡単に確かめるには,</para>

    <screen>&prompt.root; <userinput>quota -v</userinput></screen>

    <para>コマンドを実行してみて ください. ディスク使用量の総計と,
      クォータが設定されている各ファイ
      ルシステム毎の現在のクォータ制限が表示されます.</para>

    <para>さてこれで, <command>edquota</command>
      コマンドによって, クォータ制限をか ける準備ができました.</para>

    <para>ユーザまたはグループが使用できるディスクスペースの総計や,
      作成 することのできるファイル数に制限をかけるための
      オプションがいくつか あります. ディスクスペース容量規制
      (ブロッククォータ) または ファイ ル数制限 (iノードクォータ)
      またはその両方を行うことができます.
      これらの個々の制限は, 二つのカテゴリ, すなわち ハード制限とソ
      フト制限, でもっと細かく分類できます.</para>

    <para>ハード制限は越えることができません.
      ユーザがハード制限に到達す ると, 該当するファイルシステム上で
      ディスクスペースを確保することが できなくなります.
      例えば, もしユーザがファイルシステム上で 500 ブ
      ロックのハード的制限をされていて, かつ, 現在, 490
      ブロック使用して いたとすると, ユーザはあと 10
      ブロックしか確保できません.
      11 ブロック目を確保しようとすると, 失敗します.</para>

	<para>一方, ソフト制限は,
      定められたある一定の期間以内ならば制限を越
      えることができます. この一定期間は, 猶予期間と呼ばれています.
      猶予期間のデフォルトは
      1週間です. もし, ユーザが猶予期間を過ぎても
      ソフト制限を越えて使用し続けていた場合には,
      ソフト制限はハード制限 に切り替わり, もはやこれ以上は,
      ディスクスペースを確保できなくなり
      ます. ユーザのディスク使用量がソフト制限以下に戻った時に,
      猶予期間 がリセットされます.</para>

    <para>以下は, <command>edquota</command>
      コマンドを実行した時の出力例です. <command>edquota</command>
      コマンドが起動されると, <envar>EDITOR</envar> 環境変数
      で定義されたエディタ, または, <envar>EDITOR</envar>
      環境変数が設定されて いない場合には <command>vi</command>
      エディタが起動され, クォータ制限を編集
      することができます.</para>

    <screen>&prompt.root; <userinput>edquota -u test</userinput></screen>

    <programlisting>
Quotas for user test:
/usr: blocks in use: 65, limits (soft = 50, hard = 75)
        inodes in use: 7, limits (soft = 50, hard = 60)
/usr/var: blocks in use: 0, limits (soft = 50, hard = 75)
        inodes in use: 0, limits (soft = 50, hard = 60)</programlisting>

    <para>通常は,
      クォータが設定されているファイルシステム毎に2行の表示が
      行われます. 1行は, ブロック制限に関する情報で,
      もう1行は, i ノード
      制限に関する情報です.
      クォータ制限の値を変更したい値に書き換えてく
      ださい. 例えば, ユーザのブロック制限を, 50 ブロックまでのソ
      フト制限と 75 ブロックまでのハード制限から,
      500 ブロックまでのソフ
      ト制限と 600 ブロックまでのハード制限にしたい場合は,
      次のように書き換えます:

      <programlisting>
/usr: blocks in use: 65, limits (soft = 50, hard = 75)</programlisting>

      を次のように:</para>

      <programlisting>
/usr: blocks in use: 65, limits (soft = 500, hard = 600)</programlisting>

    <para>新しいクォータ制限は,
      エディタを終了した時に置き換えられます.</para>

    <para>uid の範囲によってクォータを設定する個とも可能です.
      そのためには <command>edquota</command>
      コマンドで, <option>-p</option> オプションを
      使用します. まずはじめに,
      かけたいクォータ制限を, 一人のユーザに対
      して設定します. それから次のコマンドを実行します
      <command>edquota -p protouser startuid-enduid</command>.
      例えば, もし, ユーザ <username>test</username>
      がクォータ制限をかけられていた
      とすると, 次のコマンドは, 同じ制限を, uid 10,000 から 19,999
      まで のユーザにかけることができます:</para>

    <screen>&prompt.root; <userinput>edquota -p test 10000-19999</userinput></screen>

    <para>uid の範囲によって制限をかけることができる機能は, 2.1
      がリリー スされたあとに追加されました. もし, 2.1
      のシステム上で, この機能を 必要とする場合には, 新しい edquota
      を入手する必要があります.</para>

    <para>詳細情報は <command>man edquota</command> を御覧ください.</para>
  </sect1>

  <sect1>
    <title>クォータ制限およびディスク使用状況のチェック</title>

    <para>クォータ制限およびディスク使用状況をチェックするには,
      <command>quota</command> または <command>repquota</command>
      コマンドを使用することがで きます.<command>quota</command>
      コマンドは, 各ユーザ, 各グループ毎のクォー
      タ制限およびディスク使用状況をチェックすることができます.
      スーパーユーザだけが,
      他のユーザまたは自分が所属していないグループに
      関するクォータ制限とディスク使用状況を調べることができます.
      <command>repquota</command>
      コマンドは, クォータが設定されているファイルシス テムに対する,
      全てのクォータ制限およびディスク使用状況の総計を表示
      します.</para>

    <para>以下は, 2つのファイルシステム上で
      クォータ制限がかけられているユー ザに対して <command>quota
	-v</command> コマンドを実行した出力結果の例です.</para>

    <programlisting>
Disk quotas for user test (uid 1002): 
     Filesystem  blocks   quota   limit   grace   files   quota   limit   grace
           /usr      65*     50      75   5days       7      50      60        
       /usr/var       0      50      75               0      50      60</programlisting>

    <para>上の例では, <filename>/usr</filename>
      ファイルシステム上で, このユーザは現在 50
      ブロックまでのソフト制限を 15 ブロック超過して使用しており,
      残り 5 日間の猶予期間を設定されています. アスタリスク
      <literal>*</literal>
      は, ユーザが現在クォータ制限を越えていることを示
      しています.</para>

    <para>通常,
      ユーザがディスクスペースを全く使用していないファイルシス
      テムは, たとえ
      そのファイルシステムにクォータ制限が設定されていた
      としても, <command>quota</command>
      コマンドによる出力では表示されません. <option>-v</option>
      オプションを付けると, 上の例の <filename>/usr/var</filename>
      ファ イルシステムのように,
      これらのファイルシステムも表示します.</para>
  </sect1>

  <sect1>
    <title>NFS ファイルシステム上でのクォータ</title>

    <para>クォータは, NFS サーバ上のクォータサブシステムによって実現されます.
      <command>rpc.rquotad(8)</command> デーモンは,
      NFS クライアント上の
      <command>quota(1)</command> コマンドが利用するクォータ情報を作成し,
      クライアントマシンにログインしているユーザに
      クォータ統計を提供します.
    </para>

    <para><filename>/etc/inetd.conf</filename> 内にある
      <command>rpc.rquotad</command> を, 次のようにして有効化して下さい.</para>

    <programlisting>
rquotad/1      dgram rpc/udp wait root /usr/libexec/rpc.rquotad rpc.rquotad</programlisting>

    <para>そして, <command>inetd</command> を再起動させます.</para>

    <screen>&prompt.root; <userinput>kill -HUP `cat /var/run/inetd.pid`</userinput></screen>
  </sect1>
</chapter>

<!--
     Local Variables:
     mode: sgml
     sgml-declaration: "../chapter.decl"
     sgml-indent-data: t
     sgml-omittag: nil
     sgml-always-quote-attributes: t
     sgml-parent-document: ("../book.sgml" "part" "chapter")
     End:
-->
