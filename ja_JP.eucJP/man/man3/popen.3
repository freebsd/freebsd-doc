.\" Copyright (c) 1991, 1993
.\"	The Regents of the University of California.  All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"	This product includes software developed by the University of
.\"	California, Berkeley and its contributors.
.\" 4. Neither the name of the University nor the names of its contributors
.\"    may be used to endorse or promote products derived from this software
.\"    without specific prior written permission.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\"     @(#)popen.3	8.2 (Berkeley) 5/3/95
.\"
.\" $FreeBSD$
.\"
.Dd May 3, 1995
.Dt POPEN 3
.Os
.Sh 名称
.Nm popen ,
.Nm pclose
.Nd I/O 処理
.Sh 書式
.Fd #include <stdio.h>
.Ft FILE *
.Fn popen "const char *command" "const char *type"
.Ft int
.Fn pclose "FILE *stream"
.Sh 解説
.Fn popen
関数は、双方向パイプフォークを作成し、シェルを起動してプロセスを
.Dq 開き
ます。親プロセスで以前に
.Fn popen
を呼び出して開いたストリームは、
新しい子プロセスで閉じられます。以前の
.Fn popen
は一方向パイプで実現されていたため、
.Fn popen
の多くのシステでは、
.Fa type
引数で読み取りか書込みを指定していました。
両方は指定できませんでした。現在の
.Fn popen
は双方向パイプで実現されているので、
.Fa type
引数で双方向データフローを要求できます。
.Fa type
引数はナル文字で終わる文字列のポインタで、読み取りの場合は
.Ql r
、書込みの場合は
.Ql w
、読み取りと書込みの場合は
.Ql r+
である必要があります。
.Pp
.Fa command
引数は、シェルコマンドラインを含む、
ナル文字で終わる文字列のポインタです。このコマンドは、
.Fl c
フラグで
.Pa /bin/sh
に渡されます。解釈がある場合はシェルで実行されます。
.Pp
.Fn popen
からの戻り値は標準
.Tn I/O
ストリームで、保存するためには
.Fn fclose
ではなく
.Fn pclose
で閉じる必要があります。
このようなストリームに書き込むと、
コマンドの標準入力に書き込まれます。
コマンドの標準出力は、
コマンドで変更しないかぎり、
.Fn popen
を呼び出したプロセスのものと同じです。
.Fn popen
で開いたストリームから読み込むと、
コマンドの標準出力から読み込まれます。
コマンドの標準入力は、
.Fn popen
を呼び出したプロセスのものと
同じです。
.Pp
出力
.Fn popen
ストリームは、デフォルトで完全にバッファに入ります。
.Pp
.Fn pclose
関数は、関連プロセスの終了を待機し、
.Fn wait4
が戻す、コマンドの終了ステータスを戻します。
.Sh 戻り値
.Fn popen
関数は、
.Xr fork 2
か
.Xr pipe 2
でエラーが発生した場合、またはメモリを割り振れない場合は
.Dv ヌル
を戻します。
.Pp
.Fn pclose
関数は、
.Fn popen
で
.Dq 開いた
コマンドに
.Fa stream
が関連していない場合、または
.Fa stream
が
.Fn pclose
ですでに
.Dq 閉じている
場合、あるいは
.Xr wait4 2
でエラーが発生した場合は \-1 を戻します。
.Sh 誤り
.Fn popen
関数は
.Va errno
を設定しません。
.Sh 関連項目
.Xr sh 1 ,
.Xr fork 2 ,
.Xr pipe 2 ,
.Xr wait4 2 ,
.Xr fclose 3 ,
.Xr fflush 3 ,
.Xr fopen 3 ,
.Xr stdio 3 ,
.Xr system 3
.Sh バグ
読み取り用に開いたコマンドの標準入力は、
.Fn popen
を呼び出したプロセスとシークオフセットを共有するので、
オリジナルプロセスがバッファ読み取りを実行すると、
コマンドの入力位置が予想どおりにならないことがあります。
書込み用に開いたコマンドの出力は、
オリジナルプロセスのものと混ざることがあります。後者は、
.Fn popen
の前に
.Xr fflush 3
を呼び出すことで回避できます。
.Pp
シェルを実行する場合のエラーは、
コマンドを実行する場合のシェルのエラー、
またはコマンドの途中終了と区別できません。
終了ステータスの 127 のみがヒントになります。
.Pp
.Fn popen
の引数は常に
.Xr sh 1
を呼び出し、
.Xr csh 1
は呼び出しません。
.Sh 歴史
.Fn popen
関数と
.Fn pclose
関数は、
.At v7
に追加されました。双方向機能は、
.Tn FreeBSD
2.2.6 で追加されました。
