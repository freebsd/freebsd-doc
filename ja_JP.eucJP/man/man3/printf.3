.\" Copyright (c) 1990, 1991, 1993
.\"	The Regents of the University of California.  All rights reserved.
.\"
.\" This code is derived from software contributed to Berkeley by
.\" Chris Torek and the American National Standards Committee X3,
.\" on Information Processing Systems.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"	This product includes software developed by the University of
.\"	California, Berkeley and its contributors.
.\" 4. Neither the name of the University nor the names of its contributors
.\"    may be used to endorse or promote products derived from this software
.\"    without specific prior written permission.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\"     @(#)printf.3	8.1 (Berkeley) 6/4/93
.\"
.\" jpman %Id%
.\"
.Dd June 4, 1993
.Dt PRINTF 3
.Os
.Sh 名称
.Nm printf ,
.Nm fprintf ,
.Nm sprintf ,
.Nm snprintf ,
.Nm asprintf ,
.Nm vprintf ,
.Nm vfprintf,
.Nm vsprintf ,
.Nm vsnprintf ,
.Nm vasprintf
.Nd フォーマット済み出力変換
.Sh 書式
.Fd #include <stdio.h>
.Ft int
.Fn printf "const char *format" ...
.Ft int
.Fn fprintf "FILE *stream" "const char *format" ...
.Ft int
.Fn sprintf "char *str" "const char *format" ...
.Ft int
.Fn snprintf "char *str" "size_t size" "const char *format" ...
.Ft int
.Fn asprintf "char **ret" "const char *format" ...
.Fd #include <stdarg.h>
.Ft int
.Fn vprintf "const char *format" "va_list ap"
.Ft int
.Fn vfprintf "FILE *stream" "const char *format" "va_list ap"
.Ft int
.Fn vsprintf "char *str" "const char *format" "va_list ap"
.Ft int
.Fn vsnprintf "char *str" "size_t size" "const char *format" "va_list ap"
.Ft int
.Fn vasprintf "char **ret" "const char *format" "va_list ap"
.Sh 解説
.Fn printf
ファミリの関数は、以下で説明する
.Fa format
に従って出力を実行します。
.Fn printf
と
.Fn vprintf
は、
.Em stdout
に出力を実行します。
.Fn fprintf
と
.Fn vfprintf
は、指定された出力ストリームに出力を実行します。
.Fn sprintf ,
.Fn snprintf ,
.Fn vsprintf ,
.Fn vsnprintf
は、キャラクタ文字列
.Fa str
に書き込みを行ないます。
.Fn asprintf
と
.Fn vasprintf
は、
.Xr malloc 3
や
.Xr realloc 3
で新しい文字列をダイナミックに割り振ります。
.Pp
この関数は、
.Fa format
文字列の制御に従って出力を実行します。
この文字列は、その後の引数
(または
.Xr stdarg 3
の可変長引数機能でアクセスできる引数)
を出力用に変換する方法を指定します。
.Pp
この関数は、出力された文字数
(文字列への出力を終了する、最後の
.Ql \e0
は含まない) を戻します。
.Pp
.Fn asprintf
と
.Fn vasprintf
は、文字列を収容する十分な大きさのバッファを指すポインタを
.Fa ret
引数で戻します。記憶域が不要になった場合は、このポインタを
.Xr free 3
に渡して、割り振られた記憶域を解放してください。
十分なスペースを割り振れない場合、
.Fn asprintf
と
.Fn vasprintf
は -1 を戻し、
.Fa ret
をヌルポインタに設定します。
.Pp
.Fn snprintf
と
.Fn vsnprintf
は、最大で
.Fa size Ns \-1
の文字を出力文字列に書き込みます
(size 番目の文字は最後の
.Ql \e0
になります)。
戻り値が
.Fa size
引数以上である場合は、文字列が短すぎたため、
出力された文字の一部が破棄されたことになります。
.Pp
.Fn sprintf
と
.Fn vsprintf
は、
.Fa size
が無限であることを仮定します。
.Pp
フォーマット文字列は、0 以上の命令から構成されています。
この命令には、出力ストリームに変更されずにコピーされる
通常文字
.Cm ( % 
以外)、およびゼロ以上の後続引数を取り出す変換指定があります。
それぞれの変換指定は、文字
.Cm %
で導入されます。引数は、
タイププロモーション後に変換指示子に適切に対応する必要があります。
.Cm %
の後には、以下が順番に現れます。
.Bl -bullet
.It
後に
.Cm $
が続く 10 進数文字列から構成され、
次にアクセスする引数を指定する任意のフィールド。
このフィールドを指定しないと、最後にアクセスされた
引数に続く引数が使用されます。引数には
.Cm 1 から始まる番号が付きます。
フォーマット文字列で、
アクセスできない引数がアクセスできる引数に点在する場合、
結果は不定になります。
.It
0 個以上の以下のフラグ
.Bl -hyphen
.It
値を「代替フォーム」に変換することを指定する
.Cm #
文字。
.Cm c ,
.Cm d ,
.Cm i ,
.Cm n ,
.Cm p ,
.Cm s ,
および
.Cm u
変換の場合、このオプションは効果を発揮しません。
.Cm o
変換の場合は、数値の精度が上がり、
出力文字列の最初の文字が 0 になります
(明確な精度の 0 で 0 が出力される場合を除く)。
.Cm x
変換と
.Cm X
変換の場合は、0 以外の結果の前に文字列
.Ql 0x
.Cm ( X
変換の場合は
.Ql 0X )
が付きます。
.Cm e ,
.Cm E ,
.Cm f ,
.Cm g ,
および
.Cm G
変換の場合は、小数点以下がなくても小数点が結果に常に含まれます
(通常の場合、小数点以下がある場合にかぎり、
変換結果に小数点が付きます)。
.Cm g
および
.Cm G
変換の場合は、後続の 0 が通常の場合のように結果から削除されません。
.It
0 のパディングを指定する
.Sq Cm \&0
文字。
.Cm n
変換を除くすべての変換では、
変換値の左にブランクではなく 0 が付きます。数値変換
.Pf ( Cm d ,
.Cm i ,
.Cm o ,
.Cm u ,
.Cm i ,
.Cm x ,
および
.Cm X )
で精度が指定されている場合、
.Sq Cm \&0
フラグは無視されます。
.It
負のフィールド幅を示す
.Sq Cm \-
フラグ。変換値はフィールド境界の左で揃えられます。
.Cm n
変換以外では、変換値の左にブランクか 0 が付くのではなく、
変換値の右にブランクが付きます。
.Sq Cm \-
と
.Sq Cm \&0
を両方とも指定した場合は
.Sq Cm \&0
が無効になります。
.It
スペース。符号付き変換
.Pf ( Cm d ,
.Cm e ,
.Cm E ,
.Cm f ,
.Cm g ,
.Cm G ,
および
.Cm i )
で作成される正の数値の前にブランクが残ります。
.It
.Sq Cm +
文字。符号付き変換で作成される数値の前に常に符号が付きます。
.Sq Cm +
とスペースを両方とも指定した場合はスペースが無効になります。
.El
.It
任意の 10 進数文字列。最低フィールド幅を指定します。
変換値の文字数がフィールドの幅より少ない場合は、左にスペースが付いて
(左揃えフラグを指定した場合は右にスペースが付いて)
フィールドの幅に合わせられます。
.It
ピリオド
.Sq Cm \&.
の次に任意の数字文字列が続く形式の精度。
数字文字列を省略した場合、精度はゼロになります。
.Cm d ,
.Cm i ,
.Cm o ,
.Cm u ,
.Cm x ,
および
.Cm X
変換では、この精度の最低桁数が出力されます。
.Cm e ,
.Cm E ,
および
.Cm f
変換では、小数点以下にこの精度の桁数が出力されます。
.Cm g
および
.Cm G
変換では、この精度の最大有効桁数が出力されます。
.Cm s
変換では、この精度の最大文字数が文字列から出力されます。
.It
オプション文字
.Cm h
。後の
.Cm d ,
.Cm i ,
.Cm o ,
.Cm u ,
.Cm x ,
および
.Cm X
変換が
.Em short int
引数か
.Em unsigned short int
引数に対応すること、または後の
.Cm n
変換が
.Em short int
引数のポインタに対応することを指定します。
.It
オプション文字
.Cm l
。後の
.Cm d ,
.Cm i ,
.Cm o ,
.Cm u ,
.Cm x ,
および
.Cm X
変換が
.Em long int
引数か
.Em unsigned long int
引数のポインタに適用されること、または後の
.Cm n
変換が
.Em long int
引数のポインタに対応することを指定します。
.It
オプション文字
.Cm q
。後の
.Cm d ,
.Cm i ,
.Cm o ,
.Cm u ,
.Cm x ,
および
.Cm X
変換が
.Em quad int
引数か
.Em unsigned quad int
引数に対応すること、または後の
.Cm n
変換が
.Em quad int
引数のポインタに対応することを指定します。
.It
オプション文字
.Cm L
。後の
.Cm e ,
.Cm E ,
.Cm f ,
.Cm g ,
および
.Cm G
変換が
.Em long double
引数に対応することを指定します。
.Em long double
の値が、
.Tn VAX
コンパイラと
.Tn Tahoe
コンパイラではサポートされていないことに注意してください。
.It
適用する変換のタイプを指定する文字。
.El
.Pp
フィールド幅か精度、またはその両方は、アスタリスク
.Ql *
、または数字文字列の代わりに 1 つ以上の 10 進数と
.Ql $
が続くアスタリスクで指定できます。この場合、
.Em int
引数はフィールド幅か精度を提供します。
負のフィールド幅は、
正のフィールド幅が続く左揃えフラグとして扱われます。
負の精度は、欠落しているものとして扱われます。
1 つのフォーマット命令に位置引数 (nn$)
と位置以外の引数が混在している場合、
結果は未定義になります。
.Pp
変換指示子とその意味は次のとおりです。
.Pp
.Bl -tag -width "diouxX"
.It Cm diouxX
.Em int
引数 (または適切な可変引数) が、符号付き 10 進
.Pf ( Cm d
と
.Cm i )
、符号なし 8 進
.Pq Cm o
、符号なし 10 進
.Pq Cm u
、符号なし 16 進
.Pf ( Cm x
と
.Cm X )
に変換されます。
.Cm x
変換には文字
.Cm abcdef
、
.Cm X
変換には文字
.Cm ABCDEF
が使用されます。
精度は、出力する最低桁数を指定します。
変換値で少ない桁しか必要ない場合は、
左に 0 が付きます。
.It Cm DOU
.Em long int
引数が、符号付き 10 進、符号なし 8 進、符号なし 10 進に、
それぞれのフォーマットが
.Cm ld ,
.Cm lo ,
.Cm lu
であるかのように変換されます。
この変換文字には問題があるので、最終的には出力されません。
.It Cm eE
.Em double
引数が丸められ、
.Sm off
.Pf [\-]d Cm \&. No ddd Cm e No \\*(Pmdd
.Sm of
のスタイルに変換されます。
小数点以上は 1 桁で、小数点以下の桁数は精度と等しくなります。
精度が指定されていない場合は 6 が仮定されます。
精度がゼロである場合、小数点は出力されません。
.Cm E
変換では、文字
.Cm E
.Cm ( e
ではない) が使用されて指数が導入されます。
指数には、最低 2 桁が常に含まれます。
値が 0 である場合、指数は 00 になります。
.It Cm f
.Em double
引数が丸められ、
.Sm off
.Pf [-]ddd Cm \&. No ddd
.Sm on
のスタイルで 10 進に変換されます。
小数点以下の桁数は、精度指定に等しくなります。
精度が指定されていない場合は 6 が仮定されます。
精度が 0 である場合、小数点は出力されません。
小数点が出力される場合は、小数点以上に最低 1 桁が出力されます。
.It Cm g
.Em double
引数が、スタイル
.Cm f
か
.Cm e
.Cm ( G
変換の場合は
.Cm E )
で変換されます。精度は有効桁数を指定します。
精度が指定されていない場合は 6 が仮定されます。
精度がゼロである場合は 1 として扱われます。
変換後の指数が -4 より小さいか精度以上である場合は、スタイル
.Cm e
が使用されます。
後続のゼロは、結果の小数部から削除されます。
小数点は、小数点以下に最低でも 1 桁ある場合に出力されます。
.It Cm c
.Em int
引数が
.Em unsigned char
に変換され、変換された文字が出力されます。
.It Cm s
.Dq Em char *
引数が、文字型の配列を指すポインタ
(文字列へのポインタ) とみなされます。
配列の文字は、最後のナル文字まで出力されます
(ナル文字は出力されません)。
精度が指定されている場合、指定された数以上は出力されないので、
ナル文字は必要ありません。
精度が指定されていない場合、
または精度が配列のサイズ以上である場合、
配列の最後にはナル文字が必要です。
.It Cm p
.Dq Em void *
ポインタ引数が、16 進で
.Ql ( %#x
か
.Ql %#lx
でのように) 出力されます。
.It Cm n
これまでに出力された文字数が、
.Dq Em int *
ポインタ引数 (または可変ポインタ引数)
が指定する整数に保存されます。
引数は変換されません。
.It Cm %
.Ql %
が出力されます。引数は変換されません。
完全な変換指定は
.Ql %%
です。
.El
.Pp
フィールド幅が存在しない場合、またはフィールド幅が小さい場合でも、
フィールドは切り捨てられません。変換結果がフィールド幅より大きい場合、
フィールドは変換結果を収容できるようになるまで拡張されます。
.Sh 例
.br
.Em weekday
と
.Em month
が文字列へのポインタである場合に
`Sunday, July 3, 10:02' という形式で日付と時刻を出力する場合:
.Bd -literal -offset indent
#include <stdio.h>
fprintf(stdout, "%s, %s %d, %.2d:%.2d\en",
	weekday, month, day, hour, min);
.Ed
.Pp
\*(Pi を小数第 5 位まで出力する場合:
.Bd -literal -offset indent
#include <math.h>
#include <stdio.h>
fprintf(stdout, "pi = %.5f\en", 4 * atan(1.0));
.Ed
.Pp
128 バイトの文字列を割り振り、そこに出力する場合:
.Bd -literal -offset indent
#include <stdio.h>
#include <stdlib.h>
#include <stdarg.h>
char *newfmt(const char *fmt, ...)
{
		char *p;
		va_list ap;
		if ((p = malloc(128)) == NULL)
			return (NULL);
		va_start(ap, fmt);
		(void) vsnprintf(p, 128, fmt, ap);
		va_end(ap);
		return (p);
}
.Ed
.Sh 関連項目
.Xr printf 1 ,
.Xr scanf 3
.Sh 規格
.Fn fprintf ,
.Fn printf ,
.Fn sprintf ,
.Fn vprintf ,
.Fn vfprintf ,
および
.Fn vsprintf
関数は、
.St -ansiC
に準拠しています。
.Sh 歴史
.Fn asprintf
関数と
.Fn vasprintf
関数は、GNU C ライブラリに追加されました。これは、
.Fx 2.2
で Peter Wemm <peter@FreeBSD.org> によって実現されましたが、
.Ox 2.3
では後に Todd C. Miller <Todd.Miller@courtesan.com>
のシステムで置き換えられました。
.Sh バグ
変換フォーマット
.Cm \&%D ,
.Cm \&%O ,
および
.Cm \&%U
は標準的ではなく、下位互換性を保つために提供されています。
.Cm %p
フォーマットに (
.Sq Cm 0
フラグか精度を指定することで) 0 をパディングすること、
.Cm %n
変換と
.Cm %p
変換で
.Sq Cm #
フラグを指定すること、
.Cm %Ld
のような無意味な組み合わせは標準的でありません。
このような組み合わせは避けてください。
.Pp
.Fn sprintf
と
.Fn vsprintf
では無限に長い文字列が仮定されるので、
呼び出し側では実際のスペースを
オーバフローしないように注意する必要があります。
オーバフローしないことを保証することは困難です。
安全のため、代わりに
.Fn snprintf
インタフェースを使用してください。
残念ながら、このインタフェースは移植できません。
