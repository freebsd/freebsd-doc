.\" Copyright (c) 1983, 1991, 1993
.\"	The Regents of the University of California.  All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"	This product includes software developed by the University of
.\"	California, Berkeley and its contributors.
.\" 4. Neither the name of the University nor the names of its contributors
.\"    may be used to endorse or promote products derived from this software
.\"    without specific prior written permission.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\"     @(#)flock.2	8.2 (Berkeley) 12/11/93
.\"
.Dd December 11, 1993
.Dt FLOCK 2
.Os BSD 4.2
.Sh 名称
.Nm flock
.Nd "開いたファイル上の問合せ型ロックを適用または除去する"
.Sh 書式
.Fd #include <sys/file.h>
.Fd #define	LOCK_SH		0x01		/* 共有ファイルロック */
.Fd #define	LOCK_EX		0x02		/* 排他的ファイルロック */
.Fd #define	LOCK_NB		0x04		/* ロックするときにブロックしない */
.Fd #define	LOCK_UN		0x08		/* ファイルをアンロックする */
.Ft int
.Fn flock "int fd" "int operation"
.Sh 解説
flock()
は、ファイル記述子
.Fa fd
に対応するファイル上の
.Em 問合せ型
ロックを適用または除去します。
ロックはパラメータの
.Fa operation
に
.Dv LOCK_SH
または
.Dv LOCK_EX
のいずれかと、必要であれば
.Dv LOCK_NB
を加えて指定することで適用されます。
既存のロックをアンロックする場合は
.Dv operation
を
.Dv LOCK_UN
にしてください。
.Pp
問合せ型ロックによって共同するプロセス間で
一貫したファイル操作を実現できますが、一貫性が保証される
ものではありません (すなわち、プロセスは問合せ型ロックを使用せずに
ファイルにアクセスできて、その結果、一貫性がなくなる可能性があります)。
.Pp
ロックメカニズムは
.Em 共有
ロックと
.Em 排他的
ロックという 2 つのタイプのロックを提供します。
いつでも複数の共有ロックを 1 つのファイルに適用できますが、
同時に 1 つのファイルに複数の排他的ロック、
または共有ロックと排他的ロックの両方を適用することはできません。
.Pp
適切なロックのタイプを指定するだけで、共有ロックは排他的ロックに
.Em アップグレード
でき、排他的ロックを共有ロックに
.Em ダウングレード
できます。
その結果として前のロックは解放されて
新しいロックが適用されます (他のプロセスがロックを取得し
解放した後かもしれません)。
.Pp
既にロックされているオブジェクトについてロックを要求すると、
ロックが獲得できるまで呼び出し側はブロックされます。ただし
.Dv LOCK_NB
が
.Fa operation
に含まれる場合はブロックされません。代わりに呼び出しが失敗し、
エラー
.Er EWOULDBLOCK
が返されます。
.Sh 注
ロックはファイルにかけられるものであってファイル記述子にではありません。
すなわち、
.Xr dup 2
または
.Xr fork 2
によって複製されたファイル記述子は、
1 つのロックの複数のインスタンスとはならずに、1 つのロックへの複数の
参照になります。あるファイルについてのロックを保持しているプロセスが
フォークし、子プロセスが明示的にその
ファイルをアンロックする場合、親プロセスはそのロックを失います。
.Pp
ロックを待ってブロックしているプロセスはシグナルで起こされるかもしれません。
.Sh システムの注意事項
.Pp
非スレッドライブラリでは、
.Fn flock
は
.Va flock
システムコールとして実装されています。
.Pp
スレッドライブラリでは、
.Va flock
システムコールは
.Fn _thread_sys_flock
にアセンブルされ、
.Fn flock
は、読み書きについて
.Va fd
をロックしてから、
.Fn _thread_sys_flock
を呼び出す関数として
実装されています。戻る前に
.Fn flock
は
.Va fd
をアンロックします。
.Sh 戻り値
操作が正常に完了した場合は 0が返されます。そうでない場合は、
エラー -1 が返され、
エラーコードはグローバル変数
.Va errno
に残されます。
.Sh エラー
.Fn flock
呼び出しは次の場合に失敗します:
.Bl -tag -width EWOULDBLOCKAA
.It Bq Er EWOULDBLOCK
ファイルはロックされており、
.Dv LOCK_NB
オプションが指定されました。
.It Bq Er EBADF
引数
.Fa fd
が無効な記述子を指しています。
.It Bq Er EINVAL
引数
.Fa fd
がファイル以外のオブジェクトを参照しています。
.It Bq Er EOPNOTSUPP
引数
.Fa fd
がファイルのロックをサポートしないオブジェクトを参照しています。
.El
.Sh 関連項目
.Xr close 2 ,
.Xr dup 2 ,
.Xr execve 2 ,
.Xr fork 2 ,
.Xr open 2
.Sh 歴史
.Fn flock
関数は
.Bx 4.2
で登場しました。
