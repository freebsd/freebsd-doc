<!--
     The FreeBSD Dutch Documentation Project

     $FreeBSD$
     $FreeBSDnl: doc/nl_NL.ISO8859-1/books/handbook/geom/chapter.sgml,v 1.12 2005/12/20 21:17:11 siebrand Exp $
     Gebaseerd op: 1.17
-->

<chapter id="GEOM">
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Tom</firstname>
	<surname>Rhodes</surname>
	<contrib>Geschreven door </contrib>
      </author>
    </authorgroup>
    <authorgroup>
      <author>
	<firstname>Siebrand</firstname>
	<surname>Mazeland</surname>
	<contrib>Vertaald door </contrib>
      </author>
    </authorgroup>
  </chapterinfo>

  <title>GEOM: Modulair schijftransformatie framework</title>

  <sect1 id="GEOM-synopsis">
    <title>Overzicht</title>

    <indexterm><primary>GEOM</primary></indexterm>

    <indexterm>
      <primary>GEOM schijf framework</primary>

      <see>GEOM</see>
    </indexterm>

    <para>Dit hoofdstuk beschrijft het gebruik van schijven in het
      GEOM framework in &os;.  Hieronder vallen de belangrijkste
      <acronym
	role="Redundant Array of Inexpensive Disks">RAID</acronym>
      besturingsprogramma's die het framework gebruikt voor
      instellingen.  In dit hoofdstuk wordt niet diepgaand beschreven
      hoe GEOM omgaat met I/O, het onderliggende subsysteem of code.
      Die informatie staat in het hulppagina voor &man.geom.4; en de
      verscheidene <quote>SEE ALSO</quote> referenties.  Dit hoofdstuk
      is ook geen definitief stuk over het instellen van
      <acronym>RAID</acronym>.  Alleen de door GEOM ondersteunde
      <acronym>RAID</acronym>-classificaties worden beschreven.</para>

    <para>Na het lezen van dit hoofdstuk weet de lezer:</para>

    <itemizedlist>
      <listitem>
	<para>Welk type <acronym>RAID</acronym>-ondersteuning via GEOM
	  beschikbaar is;</para>
      </listitem>

      <listitem>
	<para>Hoe de basisgereedschappen te gebruiken om de
	  verschillende <acronym>RAID</acronym>-niveau's in te stellen,
	  te onderhouden en te wijzigen;</para>
      </listitem>

      <listitem>
	<para>Hoe schijfapparaten via GEOM te spiegelen, aaneen te
	  schakelen, te versleutelen en vanaf afstand schijven aan te
	  sluiten;</para>
      </listitem>

      <listitem>
	<para>Hoe problemen op te lossen met schijven die via het GEOM
	  framework zijn aangesloten.</para>
      </listitem>
    </itemizedlist>

    <para>Veronderstelde voorkennis:</para>

    <itemizedlist>
      <listitem>
	<para>Begrijpen hoe &os; omgaat met schijfapparaten (<xref
	    linkend="disks">);</para>
      </listitem>

      <listitem>
	<para>Weten hoe een nieuwe &os; kernel in te stellen en te
	  installeren (<xref linkend="kernelconfig">).</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 id="GEOM-intro">
    <title>GEOM inleiding</title>

    <para>GEOM staat toegang en controle toe op klassen, Master Boot
      Records, <acronym>BSD</acronym> labels, enzovoort, door gebruik
      te maken van diensten of de speciale bestanden in <filename
	role="directory">/dev</filename>.  GEOM ondersteunt
      verschillende software <acronym>RAID</acronym> instellingen en
      biedt transparante toegang tot het besturingssysteem en de
      hulpprogramma's.</para>
  </sect1>

  <sect1 id="GEOM-striping">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Geschreven door </contrib>
	</author>
	<author>
	  <firstname>Murray</firstname>
	  <surname>Stokely</surname>
	</author>
      </authorgroup>
    </sect1info>

    <title>RAID0 - aaneengeschakeld</title>

    <indexterm><primary>GEOM</primary></indexterm>

    <indexterm><primary>aaneengeschakeld</primary></indexterm>

    <para>Aaneenschakelen is een methode die gebruikt wordt
      om meerdere schijven te combineren tot een enkele volume.  In
      veel gevallen wordt dit gedaan met hardware controllers.  Het
      GEOM subsysteem biedt softwareondersteuning voor
      <acronym>RAID</acronym>0, ook wel bekend als aaneenschakelen
      (<quote>disk striping</quote>).</para>

    <para>In een <acronym>RAID</acronym>0-systeem worden gegevens
      opgedeeld in blokken die verdeeld worden over de schijven in een
      reeks.  In plaats van te hoeven wachten tot een systeem 256k naar
      &eacute;&eacute;n schijf heeft geschreven, kan een
      <acronym>RAID</acronym>0-systeem tegelijkertijd 64k naar vier
      verschillende schijven schrijven, waardoor superieure I/O
      prestaties worden bereikt.  Deze prestaties kunnen nog verbeterd
      worden door meerdere schijfcontrollers te gebruiken.</para>

    <para>Iedere schijf in een
      <acronym>RAID</acronym>0-aaneenschakeling moet van dezelfde
      grootte zijn, omdat I/O-verzoeken altijd zijn opgebouwd uit
      precies gelijk over de schijven verdeelde verzoeken tot lezen of
      schrijven.</para>

    <mediaobject>
      <imageobject>
	<imagedata fileref="geom/striping" align="center">
      </imageobject>

      <textobject>
	<phrase>Illustratie aaneengeschakelde schijven</phrase>
      </textobject>
    </mediaobject>

    <procedure>
      <title>Ongeformatteerde ATA-schijven aaneenschakelen</title>

      <step>
	<para>Laad de module <filename>geom_stripe</filename>:</para>

	<screen>&prompt.root; <userinput>kldload geom_stripe.ko</userinput></screen>
      </step>

      <step>
	<para>Zorg ervoor dat er een mountpunt beschikbaar is.  Als dit
	  volume een rootpartitie wordt, gebruikt dan tijdelijk een
	  ander mountpunt zoals <filename
	    role="directory">/mnt</filename>:</para>

	<screen>&prompt.root; <userinput>mkdir /mnt</userinput></screen>
      </step>

      <step>
	<para>Stel de apparaatnamen voor de schijven vast die aaneen
	  worden geschakeld en maak het nieuwe apparaat aan.  Het
	  volgende commando kan bijvoorbeeld gebruikt worden om twee
	  ongebruikte, ongepartitioneerde <acronym>ATA</acronym>
	  schijven aaneen te schakelen (<filename>/dev/ad2</filename>
	  en <filename>/dev/ad3</filename>).</para>

	<screen>&prompt.root; <userinput>gstripe label -v st0 /dev/ad2 /dev/ad3</userinput></screen>

<!--
    <para>A message should be returned explaining that meta data has
      been stored on the devices.
XXX: What message?  Put it inside the screen output above.
-->
      </step>

      <step>
	<para>Als dit volume wordt gebruikt als rootapparaat voor het
	  opstarten van een systeem, dan dient het volgende commando
	  gegeven te worden voordat het bestandssysteem wordt
	  gemaakt:</para>

	<screen>&prompt.root; <userinput>fdisk -vBI /dev/stripe/st0</userinput></screen>
      </step>

      <step>
	<para>Er moet een partitietabel gemaakt worden op het nieuwe
	  volume:</para>

	<screen>&prompt.root; <userinput>bsdlabel -wB /dev/stripe/st0</userinput></screen>
      </step>

      <step>
	<para>Dit proces hoort twee nieuwe apparaten gemaakt te hebben
	  in de map <filename role="directory">/dev/stripe</filename>
	  naast het apparaat <filename>st0</filename>, te weten
	  <filename>st0a</filename> en <filename>st0c</filename>.  Nu
	  kan er een bestandssysteem gemaakt worden op het apparaat
	  <filename>st0a</filename> met
	  <command>newfs</command>:</para>

	<screen>&prompt.root; <userinput>newfs -U /dev/stripe/st0a</userinput></screen>

	<para>Na het uitvoeren van het bovenstaande commando rollen er
	  veel getallen over het scherm en na een aantal seconden is
	  het proces afgerond.  Het volume is gereed en klaar om
	  gemount te worden.</para>
      </step>
    </procedure>

    <para>Mount een nieuw gemaakte aaneengeschakelde schijf handmatig
      met het volgende commando:</para>

    <screen>&prompt.root; <userinput>mount /dev/stripe/st0a /mnt</userinput></screen>

    <para>Om dit aaneengeschakelde bestandssysteem automatisch te
      mounten bij het opstarten kan de volume-informatie in
      <filename>/etc/fstab</filename> gezet worden:</para>

    <screen>&prompt.root; <userinput>echo "/dev/stripe/st0a /mnt ufs rw 2 2" \</userinput>
      <userinput>&gt;&gt; /etc/fstab</userinput></screen>

    <para>Laadt de module <filename>geom</filename> ook automatisch
      bij het initialiseren van een systeem door de volgende regel toe
      te voegen aan <filename>/boot/loader.conf</filename>:</para>

    <screen>&prompt.root; <userinput>echo 'geom_stripe_load="YES"' &gt;&gt; /boot/loader.conf</userinput></screen>
  </sect1>

  <sect1 id="GEOM-mirror">
    <title>RAID1 - spiegelen</title>

    <indexterm><primary>GEOM</primary></indexterm>

    <indexterm><primary>schijf spiegelen</primary></indexterm>

    <para>Spiegelen (<quote>mirroring</quote>) is een technologie die
      door veel bedrijven en thuisgebruikers wordt ingezet om gegevens
      te back-uppen zonder onderbrekingen.  Als er een spiegel bestaat,
      betekent dat eenvoudigweg dat schijfB een kopie is van schijfA,
      of misschien zijn schijvenC+D een kopie van schijvenA+B.  Los van
      de schijfinstellingen is het belangrijkste aspect dat de
      gegevens van de ene schijf of partitie worden gerepliceerd naar
      de andere.  Later kunnen die gegevens eenvoudiger worden hersteld
      of geback-upped zonder dat dit leidt tot onderbrekingen in
      dienstverlening of toegang tot gegevens en schijven kunnen zelfs
      fysiek worden opgeslagen in een kluis.</para>

    <para>Begin met een systeem dat twee schijven heeft van gelijke
      grootte.  Deze oefening stelt dat het directe toegang
      (&man.da.4;) <acronym>SCSI</acronym>-schijven zijn.</para>

    <para>Begin door &os; te installeren op de eerste schijf met twee
      partities.  Een van de twee moet een swap-partitie zijn die twee
      keer de grootte van het RAM-geheugen is en de rest van de ruimte
      moet toegewezen worden aan het root bestandssysteem (<filename
	role="directory">/</filename>).  Er zouden eigen partities
      gemaakt kunnen worden voor andere mountpunten, maar hierdoor
      wordt de moeilijkheidsgraad wel tien keer hoger doordat de
      instellingen voor &man.bsdlabel.8; and &man.fdisk.8; handmatig
      gewijzigd moeten worden.</para>

    <para>Herstart en wacht tot het systeem volledig is
      ge&iuml;nitialiseerd.  Meld daarna aan als gebruiker
      <username>root</username>.</para>

    <para>Maak het apparaat <filename>/dev/mirror/gm</filename> en link
      het aan <filename>/dev/da1</filename>:</para>

    <screen>&prompt.root; <userinput>gmirror label -vnb round-robin gm0 /dev/da1</userinput></screen>

    <para>Het systeem hoort te antwoorden met:</para>

    <screen>Metadata value stored on /dev/da1.
Done.</screen>

    <para>Initialiseer GEOM, waardoor de kernelmodule
      <filename>/boot/kernel/geom_mirror.ko</filename> wordt
      geladen:</para>

    <screen>&prompt.root; <userinput>gmirror load</userinput></screen>

    <note>
      <para>Dit commando hoort de apparaatnodes
	<filename>gm0</filename>, <filename>gm0s1</filename>,
	<filename>gm0s1a</filename> en <filename>gm0s1c</filename>
	gemaakt te hebben onder de map <filename
	  role="directory">/dev/mirror</filename>.</para>
    </note>

    <para>Installeer het algemene <command>fdisk</command> label en de
      bootcode op het nieuw aangemaakte apparaat
      <filename>gm0</filename>:</para>

    <screen>&prompt.root; <userinput>fdisk -vBI /dev/mirror/gm0</userinput></screen>

    <para>Installeer nu de algemene <command>bsdlabel</command>
      informatie:</para>

    <screen>&prompt.root; <userinput>bsdlabel -wB /dev/mirror/gm0s1</userinput></screen>

    <note>
      <para>Als meerdere slices en partities bestaan, dienen de vlaggen
	voor de vorige twee commando's anders te zijn.  Ze moeten
	gelijk zijn aan de groottes van de slice en partitie van de
	andere schijf.</para>
    </note>

    <para>Gebruik &man.newfs.8; om een standaard bestandssysteem te
      maken op de apparaatnode <filename>gm0s1a</filename>:</para>

    <screen>&prompt.root; <userinput>newfs -U /dev/mirror/gm0s1a</userinput></screen>

    <para>Door het bovenstaande commando spuugt een systeem wat
      informatie uit en wat getalletjes.  Dat is goed.  Bekijk de
      uitvoer op het voorkomen van foutmeldingen en mount het apparaat
      op het mountpunt <filename
	role="directory">/mnt</filename>:</para>

    <screen>&prompt.root; <userinput>mount /dev/mirror/gm0s1a /mnt</userinput></screen>

    <para>Verplaats nu alle gegevens van de bootschijf naar dit nieuwe
      bestandssysteem.  In dit voorbeeld worden &man.dump.8; en
      &man.restore.8; gebruikt, maar &man.dd.1; werkt ook in dit
      scenario.  Hier wordt &man.tar.1; òmzeild, omdat &man.tar.1; de
      bootcode niet kan kopi&euml;ren, iets dat een foute afloop
      garandeert.</para>

    <screen>&prompt.root; <userinput>dump -L -0 -f- / |(cd /mnt && restore -r -v -f-)</userinput></screen>

    <para>Dit dient voor ieder bestandssysteem uitgevoerd te worden.
      Plaats eenvoudigweg het juiste bestandssysteem op de juiste
      plaats bij het uitvoeren van het voorgaande commando.</para>

    <para>Wijzig nu het gerepliceerde bestand
      <filename>/mnt/etc/fstab</filename> en verwijder het swapbestand
      of plaats er een commentaarteken voor.
      <footnote>
	<para>Het uitcommentari&euml;ren van de regel voor het
	  swapbestand in <filename>fstab</filename> zorgt er
	  waarschijnlijk voor dat het beschikbaar maken van swapruimte
	  op een andere manier bewerkstelligd moet worden. In <xref
	    linkend="adding-swap-space"> staat daarover meer
	  informatie.</para>
      </footnote>
      Wijzig de informatie voor de andere bestandssystemen zodat ze de
      nieuwe schijf gebruiken.  Zie het volgende voorbeeld:</para>

    <programlisting># Device                Mountpoint      FStype  Options         Dump    Pass#
#/dev/da0s2b             none            swap    sw              0       0
/dev/mirror/gm0s1a       /               ufs     rw              1       1</programlisting>

    <para>Maak nu een bestand <filename>boot.conf</filename> op zowel
      de huidige als de nieuwe rootpartitie.  Dit bestand
      <quote>helpt</quote> het <acronym>BIOS</acronym> van een systeem
      op te starten van de juiste schijf:</para>

    <screen>&prompt.root; <userinput>echo "1:da(1,a)/boot/loader" &gt; /boot.config</userinput>
&prompt.root; <userinput>echo "1:da(1,a)/boot/loader" &gt; /mnt/boot.config</userinput></screen>

    <note>
      <para>Dit bestand dient op beide rootpartities te staan om zeker
	te stellen dat een systeem goed opstart.  Als een systeem om
	welke reden dan ook niet kan lezen van de nieuwe rootpartitie,
	dan is een achtervang beschikbaar.</para>
    </note>

    <para>Voeg de volgende regel toe aan de nieuwe
      <filename>/boot/loader.conf</filename>:</para>

    <screen>&prompt.root; <userinput>echo 'geom_mirror_load="YES"' &gt;&gt; /mnt/boot/loader.conf</userinput></screen>

    <para>Hiermee wordt aan &man.loader.8; aangegeven dat deze
      <filename>geom_mirror.ko</filename> dient te laden tijdens de
      initialisatie van een systeem.</para>

    <para>Herstart het systeem:</para>

    <screen>&prompt.root; <userinput>shutdown -r now</userinput></screen>

    <para>Als alles goed is gegaan, hoort het systeem gestart te zijn
      vanaf het apparaat <filename>gm0s1a</filename> en er moet een
      <command>login</command> prompt staan te wachten.  Als er iets
      mis is gegaan, kijk dan in de volgende sectie voor het oplossen
      van problemen.  Voeg nu de schijf <filename>da0</filename> toe
      aan het apparaat <filename>gm0</filename>:</para>

    <screen>&prompt.root; <userinput>gmirror configure -a gm0</userinput>
&prompt.root; <userinput>gmirror insert gm0 /dev/da0</userinput></screen>

    <para>De vlag <option>-a</option> geeft &man.gmirror.8; aan dat
      automatische synchronisatie gebruikt moet worden, ofwel dat
      schrijfbewerkingen naar schijf automatisch gespiegeld moeten
      worden.  In de hulppagina wordt beschreven hoe schijven herbouwd
      en vervangen kunnen worden, hoewel daar <filename>data</filename>
      wordt gebruikt in plaats van <filename>gm0</filename>.</para>

    <sect2>
      <title>Problemen oplossen</title>

      <sect3>
	<title>Systeem weigert op te starten</title>

	<para>Als een systeem opstart in een prompt dat op het volgende
	  lijkt:</para>

	<programlisting>ffs_mountroot: can't find rootvp
Root mount failed: 6
mountroot></programlisting>

	<para>Herstart te machine met de aan/uit-schakelaar of met de
	  resetknop.  Selecteer in het bootmenu optie zes (6).
	  Hierdoor komt een systeem in een &man.loader.8; prompt.  Laad
	  de kernelmodules handmatig:</para>

	<screen>OK? <userinput>load geom_mirror.ko</userinput>
OK? <userinput>boot</userinput></screen>

	<para>Als dit werkt werd de module om welke reden dan ook niet
	  juist geladen.  Zet de onderstaande regel in het bestand met
	  kernelinstellingen en herbouw en installeer de kernel.</para>

	<programlisting>options	GEOM_MIRROR</programlisting>

	<para>Hiermee moet het probleem opgelost zijn.</para>
      </sect3>
    </sect2>
  </sect1>
</chapter>

<!--
     Local Variables:
     mode: sgml
     sgml-declaration: "../chapter.decl"
     sgml-indent-data: t
     sgml-omittag: nil
     sgml-always-quote-attributes: t
     sgml-parent-document: ("../book.sgml" "part" "chapter")
     End:
-->
